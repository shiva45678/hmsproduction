import{j as e,f as I,t as je}from"./index-CRA8Xzko.js";import{r as o,b as ge,u as fe}from"./react-vendor-Cc0P4_ZX.js";import{X as Q,f as se,ar as ne,aa as ye,e as ae,i as re,v as ve,a7 as be}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const Ne=({patient:j,onClose:l,onSave:k})=>{const[u,g]=o.useState({name:j.name,age:j.age,gender:j.gender,phone:j.phone||""}),[w,m]=o.useState(!1),r=async d=>{d.preventDefault(),m(!0);try{await k({...u,phone:u.phone||void 0}),l()}catch(C){console.error(C),alert("Failed to update patient")}finally{m(!1)}};return e.jsx("div",{className:"modal-overlay",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{className:"modal-content",style:{backgroundColor:"white",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 4px 20px rgba(0,0,0,0.15)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx("h3",{style:{margin:0,fontSize:"1.2rem",color:"#333"},children:"Edit Patient Details"}),e.jsx("button",{onClick:l,style:{border:"none",background:"none",cursor:"pointer",color:"#666"},children:e.jsx(Q,{size:20})})]}),e.jsxs("form",{onSubmit:r,style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"0.9rem",color:"#555"},children:"Name"}),e.jsx("input",{type:"text",value:u.name,onChange:d=>g({...u,name:d.target.value}),className:"dental-search-input",style:{padding:"10px",fontSize:"0.95rem"},required:!0})]}),e.jsxs("div",{style:{display:"flex",gap:"16px"},children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"0.9rem",color:"#555"},children:"Age"}),e.jsx("input",{type:"number",value:u.age||"",onChange:d=>g({...u,age:parseInt(d.target.value)||0}),className:"dental-search-input",style:{padding:"10px",fontSize:"0.95rem"}})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"0.9rem",color:"#555"},children:"Gender"}),e.jsxs("select",{value:u.gender||"",onChange:d=>g({...u,gender:d.target.value}),className:"dental-search-input",style:{padding:"10px",fontSize:"0.95rem",width:"100%"},children:[e.jsx("option",{value:"M",children:"Male"}),e.jsx("option",{value:"F",children:"Female"}),e.jsx("option",{value:"O",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"0.9rem",color:"#555"},children:"Phone"}),e.jsx("input",{type:"tel",value:u.phone,onChange:d=>g({...u,phone:d.target.value}),className:"dental-search-input",style:{padding:"10px",fontSize:"0.95rem"},placeholder:"Optional"})]}),e.jsx("button",{type:"submit",className:"save-btn",style:{marginTop:"8px",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},disabled:w,children:w?"Saving...":e.jsxs(e.Fragment,{children:[e.jsx(se,{size:18})," Save Changes"]})})]})]})})},Ce=j=>[1,2,3,14,15,16,17,18,19,30,31,32].includes(j)?{type:"molar",roots:2}:[4,5,12,13,20,21,28,29].includes(j)?{type:"premolar",roots:1}:[6,11,22,27].includes(j)?{type:"canine",roots:1}:{type:"incisor",roots:1},Se=({toothNumber:j,conditions:l=[],className:k,style:u,isSelected:g,bridgeConnectPrevious:w})=>{const{type:m}=Ce(j),r=j<=16,d="M5,20 Q5,5 18,5 Q31,5 31,20 L29,25 Q18,28 7,25 Z",C="M7,25 Q5,40 10,44 Q14,40 14,26",i="M29,25 Q31,40 26,44 Q22,40 22,26",x="M8,20 Q8,8 18,8 Q28,8 28,20 L26,24 Q18,27 10,24 Z",f="M10,24 Q16,44 18,45 Q20,44 26,24",p="M8,22 Q18,2 28,22 L26,25 Q18,28 10,25 Z",v="M10,25 Q18,48 26,25",z="M10,22 L10,12 Q18,12 26,12 L26,22 L24,25 Q18,27 12,25 Z",P="M12,25 Q18,46 24,25";let b=d,T=[C,i];m==="incisor"?(b=z,T=[P]):m==="canine"?(b=p,T=[v]):m==="premolar"&&(b=x,T=[f]);const n=l.includes("condition-rct"),y=l.includes("condition-filling"),D=l.includes("condition-crown"),A=l.includes("condition-bridge"),O=l.includes("condition-extraction"),F=l.includes("condition-implant"),G=n?"#e9d5ff":"#f3f4f6",$=O?"#fee2e2":"#ffffff",E=O?"#ef4444":A?"#0891b2":F?"#475569":D?"#b45309":g?"#3b82f6":"#6b7280",W=g||A||D||F?2:1.5,B=r?"M20,15 L56,15 L56,22 L20,22 Z":"M16,15 L-20,15 L-20,22 L16,22 Z";return e.jsxs("svg",{viewBox:"0 0 36 50",className:k,style:{width:"100%",height:"100%",overflow:"visible",...u},children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"goldGradient",x1:"0",x2:"1",y1:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:"#fcd34d"}),e.jsx("stop",{offset:"100%",stopColor:"#d97706"})]}),e.jsxs("linearGradient",{id:"bridgeGradient",x1:"0",x2:"1",y1:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:"#22d3ee"}),e.jsx("stop",{offset:"100%",stopColor:"#0891b2"})]}),e.jsxs("linearGradient",{id:"titaniumGradient",x1:"0",x2:"1",y1:"0",y2:"0",children:[e.jsx("stop",{offset:"0%",stopColor:"#475569"}),e.jsx("stop",{offset:"30%",stopColor:"#94a3b8"}),e.jsx("stop",{offset:"50%",stopColor:"#f8fafc"}),e.jsx("stop",{offset:"70%",stopColor:"#94a3b8"}),e.jsx("stop",{offset:"100%",stopColor:"#475569"})]})]}),w&&e.jsx("path",{d:B,fill:"url(#bridgeGradient)",stroke:"#0891b2",strokeWidth:"1.5"}),F?e.jsxs("g",{children:[e.jsx("path",{d:"M13,25 L23,25 L22,28 L23,29 L22,30 L22,33 L23,34 L22,35 L22,38 L23,39 L22,40 L19,46 Q18,48 17,46 L14,40 L13,39 L14,38 L14,35 L13,34 L14,33 L14,30 L13,29 L14,28 Z",fill:"url(#titaniumGradient)",stroke:E,strokeWidth:"1"}),e.jsxs("g",{stroke:"rgba(255,255,255,0.4)",strokeWidth:"0.5",children:[e.jsx("line",{x1:"14",y1:"29",x2:"22",y2:"29"}),e.jsx("line",{x1:"14",y1:"34",x2:"22",y2:"34"}),e.jsx("line",{x1:"14",y1:"39",x2:"22",y2:"39"})]}),e.jsx("rect",{x:"15",y:"22",width:"6",height:"4",fill:"#64748b",stroke:E,strokeWidth:"1",rx:"1"})]}):e.jsx("g",{fill:G,stroke:E,strokeWidth:W,strokeLinejoin:"round",children:T.map((U,Z)=>e.jsx("path",{d:U},Z))}),n&&!F&&e.jsx("g",{fill:"none",stroke:"#9333ea",strokeWidth:"2",strokeLinecap:"round",children:m==="molar"?e.jsxs(e.Fragment,{children:[" ",e.jsx("path",{d:"M11,26 L10,40"})," ",e.jsx("path",{d:"M25,26 L26,40"})," "]}):e.jsx("path",{d:"M18,25 L18,42"})}),e.jsx("path",{d:b,fill:A?"url(#bridgeGradient)":D?"url(#goldGradient)":$,stroke:E,strokeWidth:W,strokeLinejoin:"round"}),y&&!D&&!A&&!F&&e.jsx("path",{d:m==="molar"?"M12,12 Q18,18 24,12 Z":"M14,15 Q18,18 22,15 Z",fill:"#3b82f6",stroke:"none",style:{mixBlendMode:"multiply"}}),O&&e.jsxs("g",{stroke:"#ef4444",strokeWidth:"3",strokeLinecap:"round",children:[e.jsx("line",{x1:"8",y1:"8",x2:"28",y2:"42"}),e.jsx("line",{x1:"28",y1:"8",x2:"8",y2:"42"})]})]})},we=({selectedTeeth:j,toothConditions:l={},toothDetails:k={},onToothClick:u})=>{const g=Array.from({length:16},(i,x)=>x+1),w=Array.from({length:16},(i,x)=>32-x),[m,r]=ge.useState(null),d=i=>{const x=l[i]||[],f=j.includes(i);let p=[],v="#9ca3af",z;const P=x.includes("condition-extraction");return f&&(v="#3b82f6"),x.includes("condition-filling")&&p.push("#60a5fa"),x.includes("condition-rct")&&p.push("#c084fc"),x.includes("condition-crown")&&(p.push("#fcd34d"),v="#d97706"),x.includes("condition-bridge")&&(p.push("#22d3ee"),v="#0891b2"),x.includes("condition-implant")&&(p.push("#94a3b8"),v="#475569"),x.includes("condition-extraction")&&(p.push("#fee2e2"),v="#ef4444"),p.length===0&&f&&p.push("#eff6ff"),p.length===0&&p.push("#ffffff"),{fillColors:p,borderColor:v,overlayColor:z,isSelected:f,hasExtraction:P}},C=i=>{const{isSelected:x}=d(i),f=l[i]||[],p=k[i],v=i<=16,z=f.includes("condition-bridge");let P=!1;if(z){let b=null;v?i>1&&(b=i-1):i<32&&(b=i+1),b!==null&&(l[b]||[]).includes("condition-bridge")&&(P=!0)}return e.jsxs("div",{onClick:()=>u(i),onMouseEnter:()=>r(i),onMouseLeave:()=>r(null),className:`tooth-item-container ${x?"selected":""}`,title:"",children:[e.jsx("div",{className:"tooth-number-label",children:i}),e.jsx("div",{className:"tooth-svg-wrapper",style:{transform:v?"rotate(180deg)":"none"},children:e.jsx(Se,{toothNumber:i,conditions:f,isSelected:x,bridgeConnectPrevious:P})}),m===i&&p&&p.length>0&&e.jsxs("div",{className:"tooth-tooltip-window",children:[e.jsxs("div",{className:"tooltip-header",children:["Tooth ",i]}),e.jsx("ul",{className:"tooltip-list",children:p.map((b,T)=>e.jsx("li",{children:b},T))})]})]},i)};return e.jsxs("div",{className:"chart-container-inner",children:[e.jsx("div",{className:"arch-label",children:"Maxillary (Upper)"}),e.jsxs("div",{className:"arch-row",children:[e.jsx("div",{className:"quadrant",children:g.slice(0,8).map(i=>C(i))}),e.jsx("div",{className:"quadrant",children:g.slice(8).map(i=>C(i))})]}),e.jsxs("div",{className:"midline-divider",children:[e.jsx("div",{className:"divider-line"}),e.jsx("span",{className:"chart-label",children:"Midline"}),e.jsx("div",{className:"divider-line"})]}),e.jsxs("div",{className:"arch-row",children:[e.jsx("div",{className:"quadrant",children:w.slice(0,8).map(i=>C(i))}),e.jsx("div",{className:"quadrant",children:w.slice(8).map(i=>C(i))})]}),e.jsx("div",{className:"arch-label",children:"Mandibular (Lower)"}),e.jsxs("div",{className:"chart-legend",children:[e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-box normal"}),e.jsx("span",{children:"Healthy"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-box filling"}),e.jsx("span",{children:"Filling"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-box rct"}),e.jsx("span",{children:"RCT"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-box crown"}),e.jsx("span",{children:"Crown"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-box bridge"}),e.jsx("span",{children:"Bridge"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-box implant"}),e.jsx("span",{children:"Implant"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-box extraction"}),e.jsx("span",{children:"Extraction"})]})]})]})},ke=({onClose:j,onUpdate:l})=>{const[k,u]=o.useState([]),[g,w]=o.useState(!0),[m,r]=o.useState(null),[d,C]=o.useState({}),[i,x]=o.useState(!1),[f,p]=o.useState({name:"",cost:0,type:"general"});o.useEffect(()=>{v()},[]);const v=async()=>{w(!0);try{const n=await I("/api/dental/procedures");if(n.ok){const y=await n.json();u(y)}}catch(n){console.error(n)}finally{w(!1)}},z=async()=>{if(!(!f.name||!f.cost))try{(await I("/api/dental/procedures",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)})).ok&&(x(!1),p({name:"",cost:0,type:"general"}),v(),l())}catch(n){console.error(n)}},P=async n=>{try{(await I(`/api/dental/procedures/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})).ok&&(r(null),C({}),v(),l())}catch(y){console.error(y)}},b=async n=>{if(window.confirm("Are you sure you want to delete this procedure?"))try{(await I(`/api/dental/procedures/${n}`,{method:"DELETE"})).ok&&(v(),l())}catch(y){console.error(y)}},T=n=>{r(n.id),C({name:n.name,cost:n.cost,type:n.type})};return e.jsx("div",{className:"manage-procedures-modal-overlay",children:e.jsxs("div",{className:"manage-procedures-modal-content",children:[e.jsxs("div",{className:"manage-procedures-modal-header",children:[e.jsx("h2",{className:"manage-procedures-modal-title",children:"Manage Procedures"}),e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[e.jsx("button",{onClick:async()=>{if(window.confirm("Import missing default procedures?"))try{await I("/api/dental/procedures/import-defaults",{method:"POST"}),v(),l()}catch(n){console.error(n)}},className:"btn-secondary",style:{padding:"6px 12px",fontSize:"0.8rem"},children:"Import Defaults"}),e.jsx("button",{onClick:j,className:"manage-procedures-close-btn",children:e.jsx(Q,{size:20})})]})]}),e.jsx("div",{className:"manage-procedures-list-container",children:g?e.jsx("div",{style:{padding:"20px",textAlign:"center"},children:"Loading procedures..."}):e.jsxs("table",{className:"manage-procedures-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"40%"},children:"Name"}),e.jsx("th",{style:{width:"20%"},children:"Type"}),e.jsx("th",{style:{width:"20%"},children:"Cost (₹)"}),e.jsx("th",{style:{width:"20%"},children:"Actions"})]})}),e.jsx("tbody",{children:k.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,style:{textAlign:"center",padding:"20px",color:"#888"},children:"No procedures found. Add one below."})}):k.map(n=>e.jsx("tr",{children:m===n.id?e.jsxs(e.Fragment,{children:[e.jsx("td",{children:e.jsx("input",{type:"text",className:"edit-input",value:d.name||"",onChange:y=>C({...d,name:y.target.value}),placeholder:"Procedure Name"})}),e.jsx("td",{children:e.jsxs("select",{className:"edit-select",value:d.type||"general",onChange:y=>C({...d,type:y.target.value}),children:[e.jsx("option",{value:"general",children:"General"}),e.jsx("option",{value:"filling",children:"Filling"}),e.jsx("option",{value:"rct",children:"RCT"}),e.jsx("option",{value:"extraction",children:"Extraction"}),e.jsx("option",{value:"crown",children:"Crown"}),e.jsx("option",{value:"bridge",children:"Bridge"}),e.jsx("option",{value:"implant",children:"Implant"})]})}),e.jsx("td",{children:e.jsx("input",{type:"number",className:"edit-input",value:d.cost||0,onChange:y=>C({...d,cost:parseFloat(y.target.value)}),placeholder:"Cost"})}),e.jsxs("td",{children:[e.jsx("button",{onClick:()=>P(n.id),className:"action-btn btn-save",title:"Save",children:e.jsx(se,{size:18})}),e.jsx("button",{onClick:()=>r(null),className:"action-btn btn-cancel",title:"Cancel",children:e.jsx(Q,{size:18})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{children:n.name}),e.jsx("td",{children:e.jsx("span",{className:`procedure-badge badge-${n.type}`,children:n.type})}),e.jsxs("td",{style:{fontWeight:500},children:["₹",n.cost]}),e.jsxs("td",{children:[e.jsx("button",{onClick:()=>T(n),className:"action-btn btn-edit",title:"Edit",children:e.jsx(ne,{size:18})}),e.jsx("button",{onClick:()=>b(n.id),className:"action-btn btn-delete",title:"Delete",children:e.jsx(ye,{size:18})})]})]})},n.id))})]})}),e.jsx("div",{className:"add-procedure-section",children:i?e.jsxs("div",{className:"add-procedure-card",children:[e.jsx("h4",{className:"add-procedure-title",children:"Add New Procedure"}),e.jsxs("div",{className:"add-form-grid",children:[e.jsx("input",{type:"text",className:"form-input",placeholder:"Procedure Name",value:f.name||"",onChange:n=>p({...f,name:n.target.value})}),e.jsxs("select",{className:"form-select",value:f.type||"general",onChange:n=>p({...f,type:n.target.value}),children:[e.jsx("option",{value:"general",children:"General"}),e.jsx("option",{value:"filling",children:"Filling"}),e.jsx("option",{value:"rct",children:"RCT"}),e.jsx("option",{value:"extraction",children:"Extraction"}),e.jsx("option",{value:"crown",children:"Crown"}),e.jsx("option",{value:"bridge",children:"Bridge"}),e.jsx("option",{value:"implant",children:"Implant"})]}),e.jsx("input",{type:"number",className:"form-input",placeholder:"Cost",value:f.cost||"",onChange:n=>p({...f,cost:parseFloat(n.target.value)})}),e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{onClick:z,className:"btn-primary",children:"Save"}),e.jsx("button",{onClick:()=>x(!1),className:"btn-secondary",children:"Cancel"})]})]})]}):e.jsxs("button",{onClick:()=>x(!0),className:"add-trigger-btn",children:[e.jsx(ae,{size:18})," Add New Procedure"]})})]})})},Te=({toothNumber:j,procedures:l,onSelect:k,onClose:u})=>{const[g,w]=o.useState(""),m=o.useMemo(()=>l.filter(r=>r.name.toLowerCase().includes(g.toLowerCase())),[l,g]);return e.jsxs("div",{className:"modal-overlay",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,backdropFilter:"blur(2px)"},children:[e.jsxs("div",{className:"modal-content",style:{backgroundColor:"var(--dp-card-bg)",borderRadius:"12px",width:"100%",maxWidth:"400px",boxShadow:"0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",overflow:"hidden",animation:"scaleUp 0.2s ease-out"},children:[e.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid var(--dp-border)",display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"var(--dp-bg)"},children:[e.jsxs("h3",{style:{margin:0,color:"var(--dp-text)",fontSize:"1.1rem"},children:["Tooth ",j," Procedures"]}),e.jsx("button",{onClick:u,style:{background:"none",border:"none",color:"var(--dp-text-sec)",cursor:"pointer",padding:"4px"},children:e.jsx(Q,{size:20})})]}),e.jsx("div",{style:{padding:"12px 16px",borderBottom:"1px solid var(--dp-border)"},children:e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center"},children:[e.jsx(re,{size:16,style:{position:"absolute",left:"12px",color:"var(--dp-text-sec)"}}),e.jsx("input",{type:"text",placeholder:"Search procedures...",value:g,onChange:r=>w(r.target.value),style:{width:"100%",padding:"8px 12px 8px 36px",borderRadius:"8px",border:"1px solid var(--dp-border)",backgroundColor:"var(--dp-bg)",color:"var(--dp-text)",fontSize:"0.9rem",outline:"none"},autoFocus:!0})]})}),e.jsx("div",{style:{maxHeight:"400px",overflowY:"auto"},children:m.length===0?e.jsx("div",{style:{padding:"24px",textAlign:"center",color:"var(--dp-text-sec)",fontSize:"0.9rem"},children:"No procedures found."}):e.jsx("div",{style:{display:"flex",flexDirection:"column"},children:m.map(r=>e.jsxs("button",{onClick:()=>k(r),style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 16px",border:"none",background:"transparent",borderBottom:"1px solid var(--dp-border)",cursor:"pointer",textAlign:"left",transition:"background-color 0.1s"},className:"procedure-modal-item",onMouseOver:d=>d.currentTarget.style.backgroundColor="var(--dp-bg)",onMouseOut:d=>d.currentTarget.style.backgroundColor="transparent",children:[e.jsxs("div",{children:[e.jsx("div",{style:{color:"var(--dp-text)",fontWeight:500,fontSize:"0.95rem"},children:r.name}),e.jsx("div",{style:{color:"var(--dp-text-sec)",fontSize:"0.8rem",textTransform:"capitalize"},children:r.type})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"var(--dp-primary)",fontWeight:600,fontSize:"0.9rem"},children:[e.jsxs("span",{children:["₹",r.cost]}),e.jsx(ae,{size:16})]})]},r.id))})})]}),e.jsx("style",{children:`
                @keyframes scaleUp {
                    from { transform: scale(0.95); opacity: 0; }
                    to { transform: scale(1); opacity: 1; }
                }
            `})]})},te=/^\+?[0-9\s\-().]{7,20}$/,Pe=/^[a-zA-Z\s'-]{2,}$/,De=()=>{const j=fe(),[l,k]=o.useState(""),[u,g]=o.useState([]),[w,m]=o.useState(!1),[r,d]=o.useState(null),[C,i]=o.useState(!1),[x,f]=o.useState(!1),[p,v]=o.useState(!1),[z,P]=o.useState([]),[b,T]=o.useState([]),[n,y]=o.useState({}),[D,A]=o.useState(""),[O,F]=o.useState(!1),[G,$]=o.useState("plan"),[E,W]=o.useState([]),[B,U]=o.useState([]),[Z,J]=o.useState(!1);o.useEffect(()=>{_()},[]);const _=async()=>{try{const t=await I("/api/dental/procedures");if(t.ok){const s=await t.json();U(s)}}catch(t){console.error("Error fetching procedures",t)}};o.useEffect(()=>{(async()=>{if(!r){W([]);return}try{const s=await I(`/api/dental/patient/${r.id}`);if(s.ok){const a=await s.json();W(a)}}catch(s){console.error("Error fetching history",s)}})()},[r]);const V=o.useMemo(()=>je(async t=>{if(!t.trim()||t.length<2){g([]),m(!1);return}m(!0);try{const s=await I(`/api/patients?search=${encodeURIComponent(t)}&limit=10`);if(s.ok){const a=await s.json();g(a.patients||[])}}catch(s){console.error("Search error:",s)}finally{m(!1)}},300),[]);o.useEffect(()=>{V(l)},[l,V]);const ie=t=>{const s=t.target.value;k(s),f(te.test(s)),v(Pe.test(s)&&!te.test(s))},oe=async t=>{if(!(!l||t==="phone"&&!x||t==="name"&&!p)){m(!0);try{const a=await I("/api/patients",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t==="name"?l:"direct dental",phone:t==="phone"?l:null,age:null,gender:null,token:null})});if(a.ok){const c=await a.json();X({id:c.id,name:c.name,token:c.token??null,age:c.age??null,gender:c.gender??null,phone:c.phone})}else alert("Failed to create patient")}catch(s){console.error("Error creating patient:",s),alert("Error creating patient")}finally{m(!1)}}},X=t=>{d(t),k(""),g([])},le=()=>{d(null),P([]),T([]),y({}),A("")},ce=async t=>{if(!r)return;const s=await I(`/api/patients/${r.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(s.ok)await s.json(),d(a=>a?{...a,...t}:null);else throw new Error("Failed to update")},[R,H]=o.useState(null),de=t=>{H(t)},he=t=>{if(!R)return;const s={instanceId:crypto.randomUUID(),procedureId:t.id,name:t.name,price:t.cost,type:t.type};y(a=>{const c=a[R]||[];return{...a,[R]:[...c,s]}}),P(a=>a.includes(R)?a:[...a,R]),H(null)},pe=()=>{const t={},s={},a=(h,S)=>{t[h]||(t[h]=[]);const L=`condition-${S}`;t[h].includes(L)||t[h].push(L)},c=(h,S)=>{s[h]||(s[h]=[]),s[h].push(S)};return[...E].sort((h,S)=>new Date(h.date).getTime()-new Date(S.date).getTime()).forEach(h=>{h.teeth&&Array.isArray(h.teeth)&&h.teeth.forEach(S=>{S.procedures.forEach(L=>{var ee;let M=(ee=h.selected_procedures)==null?void 0:ee.find(q=>q.id===L);M||(M=B.find(q=>q.id===L)),M&&M.type!=="general"?(a(S.toothNumber,M.type),c(S.toothNumber,`${M.name} (${new Date(h.date).toLocaleDateString()})`)):L&&c(S.toothNumber,`Procedure: ${L}`)})})}),Object.keys(n).forEach(h=>{const S=parseInt(h),L=n[S];L&&L.length>0&&L.forEach(M=>{M.type!=="general"&&(a(S,M.type),c(S,`${M.name} (Current)`))})}),{conditions:t,details:s}},{conditions:xe,details:ue}=o.useMemo(()=>pe(),[E,n,B]),Y=(t,s)=>{s?(y(a=>{const c={...a};return c[s]=(a[s]||[]).filter(N=>N.instanceId!==t),c[s].length===0&&delete c[s],c}),P(a=>a)):T(a=>a.filter(c=>c.instanceId!==t))},K=(t,s,a)=>{a?y(c=>({...c,[a]:(c[a]||[]).map(N=>N.instanceId===t?{...N,price:s}:N)})):T(c=>c.map(N=>N.instanceId===t?{...N,price:s}:N))},me=async()=>{if(r){F(!0);try{const s=[...b,...Object.values(n).flat()].map(h=>({id:h.procedureId,name:h.name,cost:h.price,type:h.type})),c=Object.keys(n).map(Number).map(h=>({toothNumber:h,procedures:(n[h]||[]).map(S=>S.procedureId),notes:""})),N=await I("/api/dental",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:r.id,teeth:c,selectedProcedures:s,notes:D})});if(N.ok){const h=await N.json();j(`/dashboard/dental-billing/${h.id}`)}else alert("Failed to save dental record.")}catch(t){console.error(t),alert("Error saving record.")}finally{F(!1)}}};return e.jsxs("div",{className:"dental-page-container",children:[e.jsxs("header",{className:"dental-header",children:[e.jsxs("div",{className:"dental-title-group",children:[e.jsx(ve,{className:"dental-title-icon"}),e.jsxs("div",{children:[e.jsx("h1",{className:"dental-title",children:"Dental Procedure"}),e.jsx("p",{className:"dental-subtitle",children:"Create new dental records and bills"})]})]}),e.jsx("button",{onClick:()=>j(-1),className:"dental-back-btn",children:"Back"})]}),r?e.jsxs("div",{className:"dental-workspace",children:[e.jsxs("div",{className:"patient-header-card",children:[e.jsxs("div",{className:"patient-info-group",children:[e.jsx("div",{className:"patient-avatar",children:r.name.charAt(0).toUpperCase()}),e.jsxs("div",{className:"patient-details",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("h3",{children:r.name}),e.jsx("button",{onClick:()=>i(!0),className:"icon-button text-gray-500 hover:text-blue-600",style:{padding:0,border:"none",background:"transparent",cursor:"pointer"},children:e.jsx(ne,{size:14})})]}),e.jsxs("p",{children:[r.gender," / ",r.age," yrs • ",r.phone]})]})]}),e.jsx("button",{onClick:le,className:"close-patient-btn",title:"Change Patient",children:e.jsx(Q,{size:20})})]}),e.jsxs("div",{className:"dental-grid",children:[e.jsxs("div",{className:"chart-section",children:[e.jsx("div",{className:"dental-card chart-card-scroll",children:e.jsx(we,{selectedTeeth:z,toothConditions:xe,toothDetails:ue,onToothClick:de})}),e.jsxs("div",{className:"dental-card notes-container",children:[e.jsx("h4",{className:"section-title-sm",children:"Clinical Notes"}),e.jsx("textarea",{className:"notes-area",placeholder:"Enter clinical findings...",value:D,onChange:t=>A(t.target.value)})]})]}),e.jsx("div",{className:"dental-card procedures-section",children:e.jsxs("div",{className:"treatment-plan-container",style:{borderTop:"none"},children:[e.jsxs("div",{className:"sidebar-tabs",children:[e.jsx("button",{onClick:()=>$("plan"),className:G==="plan"?"active":"",children:"Treatment Plan"}),e.jsx("button",{onClick:()=>$("history"),className:G==="history"?"active":"",children:"Visit History"})]}),e.jsx("div",{className:"treatment-plan-list custom-scrollbar",children:G==="plan"?e.jsx(e.Fragment,{children:b.length===0&&Object.keys(n).length===0?e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"var(--dp-text-sec)",fontSize:"0.85rem"},children:"Select a tooth to add procedures."}):e.jsxs(e.Fragment,{children:[b.length>0&&e.jsxs("div",{className:"plan-group",children:[e.jsx("h4",{children:"General"}),b.map(t=>e.jsxs("div",{className:"plan-item",children:[e.jsx("span",{className:"plan-item-name",title:t.name,children:t.name}),e.jsxs("div",{style:{display:"flex",gap:"6px",alignItems:"center"},children:[e.jsx("input",{type:"number",value:t.price,onChange:s=>K(t.instanceId,parseFloat(s.target.value)||0),className:"cost-input"}),e.jsx("button",{onClick:()=>Y(t.instanceId),style:{background:"none",border:"none",color:"var(--dp-danger)",cursor:"pointer",padding:0},children:e.jsx(Q,{size:14})})]})]},t.instanceId))]}),Object.entries(n).map(([t,s])=>s.length===0?null:e.jsxs("div",{className:"plan-group",children:[e.jsxs("h4",{children:["Tooth ",t]}),s.map(a=>e.jsxs("div",{className:"plan-item",children:[e.jsx("span",{className:"plan-item-name",title:a.name,children:a.name}),e.jsxs("div",{style:{display:"flex",gap:"6px",alignItems:"center"},children:[e.jsx("input",{type:"number",value:a.price,onChange:c=>K(a.instanceId,parseFloat(c.target.value)||0,parseInt(t)),className:"cost-input"}),e.jsx("button",{onClick:()=>Y(a.instanceId,parseInt(t)),style:{background:"none",border:"none",color:"var(--dp-danger)",cursor:"pointer",padding:0},children:e.jsx(Q,{size:14})})]})]},a.instanceId))]},t))]})}):e.jsx("div",{className:"history-list",children:E.length===0?e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"var(--dp-text-sec)",fontSize:"0.85rem"},children:"No past visits found."}):E.map(t=>e.jsxs("div",{className:"history-record-card",children:[e.jsxs("div",{className:"history-record-header",children:[e.jsx("span",{className:"record-date",children:new Date(t.date).toLocaleDateString()}),e.jsx("span",{className:"record-status",children:t.status})]}),e.jsxs("div",{className:"history-record-body",children:[t.teeth.map(s=>e.jsxs("div",{className:"history-tooth-group",children:[e.jsxs("strong",{children:["Tooth ",s.toothNumber,":"]})," ",s.procedures.map(a=>{const c=t.selected_procedures.find(N=>N.id===a)||B.find(N=>N.id===a);return c?c.name:a}).join(", ")]},s.toothNumber)),t.notes&&e.jsx("p",{className:"history-notes",children:e.jsxs("em",{children:["Notes: ",t.notes]})})]})]},t.id))})}),e.jsx("div",{className:"action-footer",children:e.jsx("button",{onClick:me,className:"save-btn",disabled:O||b.length===0&&Object.keys(n).length===0,children:O?"Saving...":"Save & Bill"})})]})})]})]}):e.jsxs("div",{className:"patient-search-container",children:[e.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:700,marginBottom:"24px",color:"var(--dp-text)"},children:"Who is this for?"}),e.jsxs("div",{className:"search-input-wrapper",children:[e.jsx(re,{className:"search-icon-overlay",size:20}),e.jsx("input",{type:"text",placeholder:"Search by name or phone...",className:"dental-search-input",value:l,onChange:ie,autoFocus:!0}),w&&e.jsx("div",{className:"search-spinner"})]}),u.length>0&&e.jsx("div",{className:"search-results-dropdown",children:u.map(t=>e.jsxs("div",{onClick:()=>X(t),className:"search-result-item",children:[e.jsxs("div",{children:[e.jsx("span",{className:"patient-name-highlight",children:t.name}),e.jsxs("div",{className:"patient-meta",children:[t.age," yrs / ",t.gender," • ",t.phone]})]}),e.jsx(be,{size:18,color:"var(--dp-text-sec)"})]},t.id))}),l.length>=2&&!w&&u.length===0&&e.jsxs("div",{style:{textAlign:"center",marginTop:"20px"},children:[e.jsxs("p",{style:{color:"var(--dp-text-sec)",marginBottom:"15px"},children:['No patients found matching "',l,'".']}),e.jsx("div",{style:{display:"flex",justifyContent:"center",gap:"15px"},children:(x||p)&&e.jsxs("button",{type:"button",onClick:()=>oe(x?"phone":"name"),className:"register-new-btn",style:{backgroundColor:"var(--dp-card-bg)",border:"1px solid var(--dp-primary)",padding:"8px 16px",borderRadius:"8px"},children:['Create "',l,'"']})})]}),e.jsx("div",{style:{marginTop:"32px"},children:e.jsx("button",{onClick:()=>J(!0),className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:"Manage Procedures"})})]}),C&&r&&e.jsx(Ne,{patient:r,onClose:()=>i(!1),onSave:ce}),Z&&e.jsx(ke,{onClose:()=>J(!1),onUpdate:_}),R!==null&&e.jsx(Te,{toothNumber:R,procedures:B,onSelect:he,onClose:()=>H(null)})]})};export{De as default};
