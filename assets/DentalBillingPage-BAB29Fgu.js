import{j as e,S as i,f as u}from"./index-DE8wu5Ou.js";import{u as de,f as ce,r as l}from"./react-vendor-Cc0P4_ZX.js";import{Q as G}from"./index-CZ6CIOFr.js";/* empty css                            */import{a7 as J,af as Q,u as W,W as oe,v as he,aq as xe}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const ve=()=>{var z,$,L,O,q;const H=de(),R=ce(),[n,k]=l.useState(null),[c,w]=l.useState([]),[K,D]=l.useState(!0),[A,j]=l.useState(null),[g,E]=l.useState(!1),[m,X]=l.useState("cash"),[b,M]=l.useState(""),[P,Y]=l.useState(""),[I,Z]=l.useState(""),[S,ee]=l.useState(""),[C,se]=l.useState(""),[N,T]=l.useState(0),F=l.useRef(!1),[f,_]=l.useState(null),[te,U]=l.useState(!1),ie=s=>{const a=Math.max(0,Math.min(100,isNaN(s)?0:s));F.current=!0,T(a);const r=c.map(t=>({...t,discount_percentage:a}));w(r)},ne=(s,a)=>{const r=[...c];r[s].discount_percentage=isNaN(a)?0:a,w(r)};l.useEffect(()=>{if(F.current){F.current=!1;return}const s=c.reduce((t,o)=>t+(o.price??0),0);if(s===0){T(0);return}const r=c.reduce((t,o)=>{const x=(o.price??0)*((o.discount_percentage??0)/100);return t+x},0)/s*100;T(t=>Math.abs(t-r)>.01?r:t)},[c]);const ae=async()=>{if(!n)return j("No record data available to bill."),null;if(c.length===0)return j("Cannot bill an empty procedure list."),null;E(!0),j(null);try{const s=c.map(d=>{const x=d.price,V=x*((d.discount_percentage??0)/100),B=x-V;return{name:d.name,price:d.price,quantity:1,total:B,item_id:d.id||`proc_${Date.now()}`,type:"service",discount_percentage:d.discount_percentage??0}}),a={patientId:n.patientId.id,items:s,amount:h,paymentMode:m,type:"dental",related_id:n.id,status:"paid",discountPercentage:N},r=await u("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),t=await r.json();if(!r.ok||!t.id)throw new Error(t.message||"Failed to create bill.");if((await u(`/api/dental/${n.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",billId:t.id})})).ok||console.error("Failed to update dental record status"),k(d=>d?{...d,status:"billed",billId:t.id}:null),m==="credit")try{await u(`/api/patient-debts/${n.patientId.id}/debts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction_date:new Date().toISOString().split("T")[0],debt_value:h,related_bill_id:t.id,notes:`Dental Bill #${t.id}`})})}catch(d){console.error("Failed to create debt entry:",d)}return alert(`Dental bill created (ID: ${t.id}).`),t.id}catch(s){return console.error("Billing process failed:",s),j(s.message||"Failed to create bill."),null}finally{E(!1)}},le=()=>{window.print()},re=async()=>{await ae()&&setTimeout(()=>window.print(),500)};l.useEffect(()=>{const s=R.pathname.split("/"),a=s[s.length-1];a?(async()=>{D(!0);try{const[t,o]=await Promise.all([u(`/api/dental/${a}`),u("/api/clinics/settings").catch(()=>({ok:!1,json:async()=>({})}))]);if(!t.ok)throw new Error("Failed to fetch dental record");const d=await t.json(),x={...d,patientId:d.Patient||d.patientId};if(k(x),o.ok){const p=await o.json();Y(p.upi_id||""),Z(p.name||""),ee(p.address||""),se(p.notes||"")}const B=(x.selected_procedures||x.selectedProcedures||[]).map(p=>({...p,price:p.cost,discount_percentage:0}));w(B)}catch(t){console.error("Failed to fetch data:",t),j(t.message)}finally{D(!1)}})():(j("No record ID provided."),D(!1))},[R.pathname]);const v=l.useMemo(()=>c.reduce((s,a)=>s+(a.price??0),0),[c]),y=l.useMemo(()=>c.reduce((s,a)=>{const t=(a.price??0)*(a.discount_percentage??0)/100;return s+t},0),[c]),h=l.useMemo(()=>v-y,[v,y]);return l.useEffect(()=>{if(h>0&&P){const s=`upi://pay?pa=${P}&pn=${encodeURIComponent(I)}&am=${h.toFixed(2)}&cu=INR`;M(s)}else M("")},[h,P,I]),l.useEffect(()=>{(async()=>{var a;if(m==="credit"&&((a=n==null?void 0:n.patientId)!=null&&a.id)){U(!0);try{const r=await u(`/api/patient-debts/${n.patientId.id}/balance`);if(r.ok){const t=await r.json();_(t.netDebt||0)}else _(0)}catch{_(0)}finally{U(!1)}}})()},[m,(z=n==null?void 0:n.patientId)==null?void 0:z.id]),K?e.jsx("div",{className:"pharmacy-billing-page",children:e.jsxs("div",{className:"billing-container",children:[e.jsxs("div",{className:"billing-header no-print",children:[e.jsx("div",{className:"back-button",children:e.jsx(i,{width:100,height:40,style:{borderRadius:"8px"}})}),e.jsx(i,{width:300,height:40})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("div",{className:"order-details-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(i,{width:150,height:24})})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsx("div",{className:"info-item",children:e.jsx(i,{width:200,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(i,{width:150,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(i,{width:180,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(i,{width:150,height:20})})]})]}),e.jsxs("div",{className:"medications-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(i,{width:120,height:24})})}),e.jsx("div",{className:"p-4",children:e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx(i,{width:30,height:20})}),e.jsx("th",{children:e.jsx(i,{width:150,height:20})}),e.jsx("th",{children:e.jsx(i,{width:80,height:20})}),e.jsx("th",{children:e.jsx(i,{width:80,height:20})}),e.jsx("th",{children:e.jsx(i,{width:100,height:20})})]})}),e.jsx("tbody",{children:[1,2,3,4].map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(i,{width:20,height:20})}),e.jsx("td",{children:e.jsx(i,{width:180,height:20})}),e.jsx("td",{children:e.jsx(i,{width:70,height:20})}),e.jsx("td",{children:e.jsx(i,{width:70,height:20})}),e.jsx("td",{children:e.jsx(i,{width:90,height:20})})]},s))})]})})]})]}),e.jsx("aside",{className:"billing-sidebar",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(i,{width:160,height:24})})}),e.jsxs("div",{className:"space-y-4 p-5",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(i,{width:100,height:20}),e.jsx(i,{width:80,height:20})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(i,{width:100,height:20}),e.jsx(i,{width:80,height:20})]}),e.jsx("hr",{}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(i,{width:120,height:28}),e.jsx(i,{width:100,height:28})]}),e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:"20px 0"},children:e.jsx(i,{width:150,height:150})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(i,{width:"100%",height:45,style:{borderRadius:"8px"}}),e.jsx(i,{width:"100%",height:45,style:{borderRadius:"8px"}})]})]})]})})]})]})}):A?e.jsxs("div",{className:"error-message-box",children:["Error: ",A]}):n?e.jsxs("div",{className:"pharmacy-billing-page",children:[" ",e.jsxs("div",{className:"billing-container printable-section",children:[e.jsxs("div",{className:"billing-header print-only",children:[e.jsx("div",{className:"clinic-header-left",children:e.jsx("div",{className:"clinic-info-print",children:e.jsxs("div",{className:"clinic-name-and-details-print",children:[e.jsx("h1",{className:"bill-title",children:"DENTAL INVOICE"}),e.jsx("h2",{className:"clinic-name-print",children:I||"Clinic Name"}),(S||C)&&e.jsxs("div",{className:"clinic-details-print",children:[S&&e.jsx("span",{className:"small-text clinic-address",children:S}),C&&e.jsx("span",{className:"small-text clinic-notes",children:C})]})]})})}),e.jsxs("div",{className:"patient-info-grid print-only-patient-details",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(J,{size:16})," Patient Name"]})," ",(($=n.patientId)==null?void 0:$.name)||"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Q,{size:16})," Token"]})," ",((L=n.patientId)==null?void 0:L.patient_token_number)??"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(W,{size:16})," Date"]})," ",new Date(n.date||n.createdAt).toLocaleDateString()]})]})]}),e.jsxs("header",{className:"billing-header no-print",children:[e.jsx("button",{onClick:()=>H(-1),className:"back-button",children:e.jsx(oe,{className:"w-4 h-4"})}),e.jsx("h1",{children:"Dental Bill"})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("section",{className:"order-details-card no-print",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Patient Information"})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(J,{size:16})," Patient Name"]})," ",((O=n.patientId)==null?void 0:O.name)||"N/A"," "]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Q,{size:16})," Token"]})," ",((q=n.patientId)==null?void 0:q.patient_token_number)??"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(he,{size:16})," Record ID"]})," ",n.id.substring(n.id.length-6)]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(W,{size:16})," Date"]})," ",new Date(n.createdAt).toLocaleDateString()]})]})]}),e.jsxs("section",{className:"medications-card",children:[e.jsx("div",{className:"card-header no-print",children:e.jsx("h2",{children:"Procedures"})}),c.length>0?e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"S.No."}),e.jsx("th",{children:"PROCEDURE"}),e.jsx("th",{children:"PRICE"}),e.jsx("th",{children:"DIS %"}),e.jsx("th",{children:"AMT"})]})}),e.jsx("tbody",{children:c.map((s,a)=>{const r=s.price??0,t=r*(s.discount_percentage??0)/100,o=r-t;return e.jsxs("tr",{children:[e.jsx("td",{children:a+1}),e.jsx("td",{children:s.name}),e.jsx("td",{children:s.price.toFixed(2)}),e.jsxs("td",{children:[e.jsx("input",{type:"number",value:s.discount_percentage===0?"":s.discount_percentage,onChange:d=>ne(a,parseFloat(d.target.value)),min:"0",max:"100",className:"discount-input-table"}),"%"]}),e.jsx("td",{children:o.toFixed(2)})]},a)})})]}):e.jsx("p",{className:"p-4 text-gray-500",children:"No procedures selected."})]}),e.jsxs("div",{className:"bill-summary-print print-only",children:[e.jsxs("div",{className:"bill-summary-details",children:[e.jsxs("div",{className:"summary-row-print",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",v.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row-print",children:[e.jsxs("span",{children:["Discount (",N.toFixed(2),"%)"]}),e.jsxs("span",{children:["- ₹",y.toFixed(2)]})]}),e.jsx("div",{className:"print-only-total",children:e.jsxs("strong",{children:["Grand Total: ₹",h.toFixed(2)]})})]}),b&&e.jsxs("div",{className:`qr-code-container qr-code-printable-section ${m!=="upi"?"hide-on-screen":""}`,children:[e.jsx(G,{value:b,size:80}),e.jsx("p",{className:"print-only-upi-text",children:"Scan to pay"})]})]})]}),e.jsx("aside",{className:"billing-sidebar no-print",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Billing Summary"})}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",v.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Total Discount"}),e.jsxs("span",{children:["- ₹",y.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Discount Percentage"}),e.jsxs("div",{className:"discount-input-wrapper",children:[e.jsx("input",{type:"number",value:N===0?"":N,onChange:s=>ie(parseFloat(s.target.value)),min:"0",max:"100",className:"discount-input-total",disabled:g||n.status==="billed"}),"%"]})]}),e.jsxs("div",{className:"summary-row grand-total-row",children:[e.jsx("strong",{children:"Grand Total"}),e.jsxs("strong",{children:["₹",h.toFixed(2)]})]}),e.jsx("div",{className:"qr-code-container",children:b?e.jsxs(e.Fragment,{children:[e.jsx(G,{value:b,size:128}),e.jsx("p",{children:"Scan to pay using UPI"})]}):e.jsx("p",{className:"text-sm text-gray-500",children:"UPI QR code not available."})}),e.jsxs("div",{className:"payment-mode-section",children:[e.jsx("label",{className:"info-item",children:e.jsx("strong",{children:"Payment Mode"})}),e.jsxs("select",{value:m,onChange:s=>X(s.target.value),className:"payment-mode-select",disabled:g||n.status==="billed",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"no_cash_insurance",children:"Insurance"}),e.jsx("option",{value:"credit",children:"Credit (Debt)"})]})]}),m==="credit"&&e.jsxs("div",{className:"debt-info-section",style:{marginTop:"10px",padding:"12px",backgroundColor:"rgba(220, 53, 69, 0.1)",borderRadius:"8px",border:"1px solid rgba(220, 53, 69, 0.3)"},children:[e.jsx("div",{style:{fontWeight:"bold",color:"#dc3545",marginBottom:"8px"},children:"⚠️ Debt to Patient"}),te?e.jsx("div",{style:{fontSize:"0.9em",color:"#666"},children:"Loading debt info..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"Current Debt:"}),e.jsxs("strong",{style:{color:f&&f>0?"#dc3545":"#28a745"},children:["₹",(f||0).toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"This Bill:"}),e.jsxs("strong",{children:["+ ₹",h.toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",borderTop:"1px solid rgba(220, 53, 69, 0.3)",paddingTop:"8px",marginTop:"8px"},children:[e.jsx("span",{children:e.jsx("strong",{children:"New Total Debt:"})}),e.jsxs("strong",{style:{color:"#dc3545"},children:["₹",((f||0)+h).toFixed(2)]})]})]})]}),e.jsx("div",{className:"bill-actions mt-6 flex flex-col gap-3",children:n.status!=="billed"?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:le,className:"secondary-button print-preview-button no-print",disabled:g,children:"Print Preview"}),e.jsx("button",{onClick:re,className:"primary-button",disabled:g,children:g?"Processing...":"Finalise and Bill"})]}):e.jsxs("div",{className:"p-3 bg-green-50 text-green-700 text-center rounded-lg font-medium border border-green-100 flex items-center justify-center gap-2",children:[e.jsx(xe,{size:20})," Bill Generated"]})})]})})]}),e.jsx("footer",{className:"billing-footer print-only",children:e.jsx("p",{children:"Computer generated invoice."})})]})]}):e.jsx("div",{className:"error-message-box",children:"No record found."})};export{ve as default};
