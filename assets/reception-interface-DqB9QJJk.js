var ae=a=>{throw TypeError(a)};var V=(a,s,i)=>s.has(a)||ae("Cannot "+i);var l=(a,s,i)=>(V(a,s,"read from private field"),i?i.call(a):s.get(a)),K=(a,s,i)=>s.has(a)?ae("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(a):s.set(a,i),z=(a,s,i,r)=>(V(a,s,"write to private field"),r?r.call(a,i):s.set(a,i),i),H=(a,s,i)=>(V(a,s,"access private method"),i);import{h as ce,s as le,i as ie,k as de,n as re,d as I,l as ue,m as he,j as e,g as me,e as oe,q as L,f as T,u as pe,S as g}from"./index-D_kqlrGT.js";import{r as u,u as xe,f as ge}from"./react-vendor-Cc0P4_ZX.js";/* empty css                   *//* empty css                   */import je from"./PatientSearchPage-Bu7Jo4Ba.js";import be from"./ManageAdmissionPage-D2g-FSux.js";import fe from"./AllPatientsPage-FhbVoaH_.js";import ve from"./CreateCustomBillPage-BEqgdt6H.js";import ye from"./CreateLabOrderPage-I9LYAyMV.js";import{Y,A as Ne,Z as we,U as Ce,i as X,_ as Pe,$ as Se,J as qe,a0 as Ae}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";import"./useAutoFocusSingleInput-6a_v4dYJ.js";import"./ManageCustomColumnsModal-BnC2uZu3.js";var k,_,f,F,M,J,Z,ne,De=(ne=class extends ce{constructor(s,i){super();K(this,M);K(this,k);K(this,_);K(this,f);K(this,F);z(this,k,s),this.setOptions(i),this.bindMethods(),H(this,M,J).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(s){var r;const i=this.options;this.options=l(this,k).defaultMutationOptions(s),le(this.options,i)||l(this,k).getMutationCache().notify({type:"observerOptionsUpdated",mutation:l(this,f),observer:this}),i!=null&&i.mutationKey&&this.options.mutationKey&&ie(i.mutationKey)!==ie(this.options.mutationKey)?this.reset():((r=l(this,f))==null?void 0:r.state.status)==="pending"&&l(this,f).setOptions(this.options)}onUnsubscribe(){var s;this.hasListeners()||(s=l(this,f))==null||s.removeObserver(this)}onMutationUpdate(s){H(this,M,J).call(this),H(this,M,Z).call(this,s)}getCurrentResult(){return l(this,_)}reset(){var s;(s=l(this,f))==null||s.removeObserver(this),z(this,f,void 0),H(this,M,J).call(this),H(this,M,Z).call(this)}mutate(s,i){var r;return z(this,F,i),(r=l(this,f))==null||r.removeObserver(this),z(this,f,l(this,k).getMutationCache().build(l(this,k),this.options)),l(this,f).addObserver(this),l(this,f).execute(s)}},k=new WeakMap,_=new WeakMap,f=new WeakMap,F=new WeakMap,M=new WeakSet,J=function(){var i;const s=((i=l(this,f))==null?void 0:i.state)??de();z(this,_,{...s,isPending:s.status==="pending",isSuccess:s.status==="success",isError:s.status==="error",isIdle:s.status==="idle",mutate:this.mutate,reset:this.reset})},Z=function(s){re.batch(()=>{var i,r,p,j,b,h,y,q;if(l(this,F)&&this.hasListeners()){const x=l(this,_).variables,A=l(this,_).context,w={client:l(this,k),meta:this.options.meta,mutationKey:this.options.mutationKey};if((s==null?void 0:s.type)==="success"){try{(r=(i=l(this,F)).onSuccess)==null||r.call(i,s.data,x,A,w)}catch(N){Promise.reject(N)}try{(j=(p=l(this,F)).onSettled)==null||j.call(p,s.data,null,x,A,w)}catch(N){Promise.reject(N)}}else if((s==null?void 0:s.type)==="error"){try{(h=(b=l(this,F)).onError)==null||h.call(b,s.error,x,A,w)}catch(N){Promise.reject(N)}try{(q=(y=l(this,F)).onSettled)==null||q.call(y,void 0,s.error,x,A,w)}catch(N){Promise.reject(N)}}}this.listeners.forEach(x=>{x(l(this,_))})})},ne);function Ee(a,s){const i=I(),[r]=u.useState(()=>new De(i,a));u.useEffect(()=>{r.setOptions(a)},[r,a]);const p=u.useSyncExternalStore(u.useCallback(b=>r.subscribe(re.batchCalls(b)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),j=u.useCallback((b,h)=>{r.mutate(b,h).catch(ue)},[r]);if(p.error&&he(r.options.throwOnError,[p.error]))throw p.error;return{...p,mutate:j,mutateAsync:p.mutate}}const $e=()=>{const a=u.useRef(null),s=u.useRef(null),[i,r]=u.useState(!1),[p,j]=u.useState(0),[b,h]=u.useState(!1),[y,q]=u.useState(!1),[x,A]=u.useState(null),w=30,N=100,D=async()=>{try{const C=await navigator.mediaDevices.getUserMedia({video:!0});a.current&&(a.current.srcObject=C,q(!0),A(null))}catch(C){console.error("Error accessing camera:",C),A("Camera access denied. Please allow camera permissions to use motion detection."),q(!1)}},O=()=>{var S;const C=(S=a.current)==null?void 0:S.srcObject;C&&C.getTracks().forEach(E=>E.stop()),q(!1)};u.useEffect(()=>(D(),()=>O()),[]),u.useEffect(()=>{if(!y)return;let C;const S=s.current,E=a.current;if(!S||!E)return;const R=S.getContext("2d",{willReadFrequently:!0});if(!R)return;const B=320,U=240;S.width=B,S.height=U;let Q=null;const t=()=>{if(E.readyState===E.HAVE_ENOUGH_DATA){R.drawImage(E,0,0,B,U);const o=R.getImageData(0,0,B,U).data;if(Q){let m=0;for(let d=0;d<o.length;d+=4*4){const c=Math.abs(o[d]-Q[d]),$=Math.abs(o[d+1]-Q[d+1]),v=Math.abs(o[d+2]-Q[d+2]);c+$+v>w&&m++}if(m>N){const d=Date.now();j(d),r(!0),b||h(!0)}else r(!1)}Q=o}C=requestAnimationFrame(t)};return t(),()=>{cancelAnimationFrame(C)}},[y,b]);const W=()=>{h(!1)};return e.jsxs("div",{className:"motion-detect-container",style:{padding:"20px",height:"100%",display:"flex",flexDirection:"column",gap:"20px"},children:[e.jsxs("div",{className:"status-header bg-white p-4 rounded-lg shadow-sm flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-full ${y?"bg-green-100 text-green-600":"bg-red-100 text-red-600"}`,children:e.jsx(Y,{size:24})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Motion Detection Status"}),e.jsx("p",{className:"text-sm text-gray-500",children:y?"Camera Active - Monitoring":"Camera Inactive"})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:`flex items-center gap-2 px-3 py-1 rounded-full border ${i?"bg-red-50 border-red-200 text-red-600 animate-pulse":"bg-gray-50 border-gray-200 text-gray-500"}`,children:[e.jsx(Ne,{size:16}),e.jsx("span",{className:"font-medium",children:i?"Motion Detected!":"No Motion"})]}),e.jsxs("div",{className:`flex items-center gap-2 px-3 py-1 rounded-full border ${b?"bg-blue-50 border-blue-200 text-blue-600":"bg-gray-50 border-gray-200 text-gray-500"}`,children:[e.jsx(we,{size:16}),e.jsx("span",{className:"font-medium",children:b?"AI Assistant Active":"AI Assistant Idle"})]})]})]}),x&&e.jsx("div",{className:"bg-red-50 text-red-600 p-4 rounded-lg border border-red-200",children:x}),e.jsxs("div",{className:"video-feed-container bg-black rounded-lg overflow-hidden relative shadow-lg",style:{maxWidth:"640px",margin:"0 auto"},children:[e.jsx("video",{ref:a,autoPlay:!0,muted:!0,playsInline:!0,style:{width:"100%",display:y?"block":"none"}}),e.jsx("canvas",{ref:s,style:{display:"none"}}),!y&&!x&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-white",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Y,{size:48,className:"mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Connecting to camera..."})]})})]}),b&&e.jsx(me,{onClose:W,patientData:null,tokenNumber:null,onAiSummaryChange:()=>{},lastMotionTimestamp:p,backgroundMode:!0})]})},ke=async()=>{const a=await T("/api/queue");if(!a.ok)throw new Error("Failed to fetch queue");return a.json()};function Fe(){return oe({queryKey:L.queue.today,queryFn:ke,staleTime:30*1e3,refetchInterval:60*1e3})}function Me(){const a=I();return Ee({mutationFn:async({queueId:s,status:i,doctorId:r})=>{const p=await T(`/api/queue/${s}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:i,doctorId:r})});if(!p.ok)throw new Error("Failed to update queue status");return p.json()},onSuccess:(s,{queueId:i})=>{a.invalidateQueries({queryKey:L.queue.today}),a.invalidateQueries({queryKey:L.queue.entry(i)})}})}const Te=async()=>{const a=await T("/api/staff");if(!a.ok)throw new Error("Failed to fetch staff");const s=await a.json();return s.staff||s||[]};function _e(){return oe({queryKey:[...L.staff.list,"doctors"],queryFn:Te,staleTime:5*60*1e3,select:a=>a.filter(s=>s.role==="doctor")})}const Ie=({currentUser:a})=>{const[s,i]=u.useState("newtons-ai"),[r,p]=u.useState(""),{data:j=[],isLoading:b}=Fe(),{data:h=[],isLoading:y}=_e(),q=Me(),x=I(),[A,w]=u.useState(null),[N,D]=u.useState(null),O=xe(),W=ge(),C=t=>{t&&(x.prefetchQuery({queryKey:L.patients.context(t),queryFn:async()=>{const n=await T(`/api/patients/${t}/context`);if(!n.ok)throw new Error("Failed to fetch patient context");return n.json()},staleTime:5*60*1e3}),x.prefetchQuery({queryKey:L.patientDebts.balance(t),queryFn:async()=>{const n=await T(`/api/patient-debts/${t}/balance`);return n.ok?n.json():{netDebt:0}},staleTime:1*60*1e3}),x.prefetchQuery({queryKey:L.queue.latest(t),queryFn:async()=>{const n=await T(`/api/queue/patient/${t}/latest`);if(!n.ok)throw new Error("Failed to fetch latest queue status");const o=await n.json();return o!=null&&o._id&&x.prefetchQuery({queryKey:L.queue.entry(o._id),queryFn:async()=>{const m=await T(`/api/queue/doctor/complaint/${o._id}`);if(!m.ok)throw new Error("Failed to fetch complaint record");return m.json()},staleTime:1*60*1e3}),o},staleTime:5e3}))};u.useEffect(()=>{const n=new URLSearchParams(W.search).get("tab");n&&R.find(m=>m.id===n)&&i(n)},[W.search]),u.useEffect(()=>{w(null)},[s]);const S=u.useCallback(async(t,n)=>{if(console.log(`Attempting to assign doctor ${n} to queue ${t}`),D(null),w(null),!n){console.log("No doctor ID provided, skipping assignment.");return}const o=j.find(c=>c.id===t);if(!o){console.error(`Queue entry ${t} not found in local state.`),D("Queue entry not found.");return}if(o.doctor_id===n){console.log(`Queue ${t} already assigned to doctor ${n}. Skipping.`);return}const m=async c=>{if(!c||!c.id||!c.name){D("Cannot proceed: Patient ID or Name is missing."),console.error("assignAndNavigate called with invalid patientInfo",c);return}const $=async()=>{try{await q.mutateAsync({queueId:t,status:"waiting",doctorId:n});const v=h.find(G=>G.id===n);return console.log(`Successfully assigned doctor ${v==null?void 0:v.name} to queue ${t}.`),!0}catch(v){return console.error(`Error assigning doctor for queue ${t}:`,v),D(`Failed to assign doctor: ${v.message}`),!1}};c.subscription_status==="active"?(console.log(`Patient ${c.name} (ID: ${c.id}) has active subscription. Assigning doctor directly.`),await $()):(console.log(`Patient ${c.name} (ID: ${c.id}) does not have active subscription. Navigating to billing WITHOUT assigning doctor yet.`),O(`/dashboard/doctor-billing/${t}?doctorId=${n}`))},d=o.Patient;if(d&&d.id&&d.name)console.log("Patient details found in state. Proceeding with assignment."),await m(d);else{console.warn(`Patient details missing for queue entry ${t}. Fetching patient ${o.patient_id}...`);try{const c=await T(`/api/patients/${o.patient_id}`);if(!c.ok){const v=await c.json().catch(()=>({}));throw new Error(v.message||`Failed to fetch patient details (status ${c.status})`)}const $=await c.json();console.log("Successfully fetched patient details:",$),await m($)}catch(c){console.error(`Failed to fetch patient details for patient ID ${o.patient_id}:`,c),D(`Failed to fetch required patient details: ${c.message}`)}}},[h,j,O]),E=async(t,n)=>{var m;D(null);const o=n==="consulting"?"start consultation":"complete visit";try{await q.mutateAsync({queueId:t,status:n,doctorId:n==="consulting"&&((m=j.find(d=>d.id===t))==null?void 0:m.doctor_id)||void 0})}catch(d){console.error(`Error trying to ${o}:`,d),D(`Failed to ${o}: ${d.message}`)}},R=[{id:"queue",label:"Queue",icon:e.jsx(Ce,{size:20})},{id:"newtons-ai",label:"Newtons AI",icon:e.jsx(X,{size:20})},{id:"manage-admission",label:"Manage Admission",icon:e.jsx(Pe,{size:20})},{id:"all-patients",label:"All Patients",icon:e.jsx(Se,{size:20})},{id:"lab",label:"Lab Tests",icon:e.jsx(qe,{size:20})},{id:"custom-bill",label:"Custom Bill",icon:e.jsx(Ae,{size:20})},{id:"motion-detect",label:"Motion Detect",icon:e.jsx(Y,{size:20})}],B=t=>{try{return new Date(t).toLocaleTimeString("en-IN",{hour:"numeric",minute:"2-digit",hour12:!0})}catch{return"Invalid Date"}},U=j.filter(t=>{var n,o;return(o=(n=t.Patient)==null?void 0:n.name)==null?void 0:o.toLowerCase().includes(r.toLowerCase())}),{openCommandBar:Q}=pe();return e.jsxs("div",{className:"admin-panel-container",children:[N&&e.jsxs("div",{className:"error-message-reception",role:"alert",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:N})]}),e.jsx("div",{className:"admin-nav-bar",children:R.map(t=>e.jsxs("button",{className:`admin-nav-button ${s===t.id?"active":""}`,onClick:()=>{t.id==="newtons-ai"?Q():i(t.id)},children:[e.jsx("span",{children:t.icon}),t.label]},t.id))}),e.jsx("div",{className:"admin-content-section",children:e.jsxs("main",{className:"flex-1 overflow-y-auto",style:{padding:"15px"},children:[s==="queue"&&e.jsxs("div",{className:"space-y-6",children:[" ",e.jsxs("div",{className:"queue-header",children:[" ",e.jsxs("div",{className:"queue-actions",children:[" ",e.jsxs("div",{className:"search-bar-container",children:[" ",e.jsx("input",{type:"text",placeholder:"Search patients in queue...",className:"search-input",value:r,onChange:t=>p(t.target.value)}),e.jsx(X,{className:"search-icon",size:18})]})]}),e.jsxs("div",{className:"summary-cards-grid",children:[" ",e.jsxs("div",{className:"summary-card card-waiting",children:[" ",e.jsx("div",{className:"summary-card-title",children:"Waiting"})," ",e.jsx("div",{className:"summary-card-value",children:j.filter(t=>t.status==="waiting").length})," "]}),e.jsxs("div",{className:"summary-card card-consulting",children:[" ",e.jsx("div",{className:"summary-card-title",children:"Consulting"})," ",e.jsx("div",{className:"summary-card-value",children:j.filter(t=>t.status==="consulting").length})," "]}),e.jsxs("div",{className:"summary-card card-completed",children:[" ",e.jsx("div",{className:"summary-card-title",children:"Completed"})," ",e.jsx("div",{className:"summary-card-value",children:j.filter(t=>t.status==="seen").length})," "]})]})]}),b?e.jsx("div",{className:"queue-table-wrapper",children:e.jsxs("table",{className:"queue-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx(g,{width:50,height:20})}),e.jsx("th",{children:e.jsx(g,{width:100,height:20})}),e.jsx("th",{children:e.jsx(g,{width:100,height:20})}),e.jsx("th",{children:e.jsx(g,{width:150,height:20})}),e.jsx("th",{children:e.jsx(g,{width:100,height:20})}),e.jsx("th",{className:"hidden md:table-cell",children:e.jsx(g,{width:80,height:20})}),e.jsx("th",{children:e.jsx(g,{width:120,height:20})})]})}),e.jsx("tbody",{children:[1,2,3,4,5].map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(g,{width:40,height:20})}),e.jsx("td",{children:e.jsx(g,{width:120,height:20})}),e.jsx("td",{children:e.jsx(g,{width:100,height:20})}),e.jsx("td",{children:e.jsx(g,{width:150,height:20})}),e.jsx("td",{children:e.jsx(g,{width:100,height:24,style:{borderRadius:"12px"}})}),e.jsx("td",{className:"hidden md:table-cell",children:e.jsx(g,{width:60,height:20})}),e.jsx("td",{children:e.jsx(g,{width:120,height:32})})]},t))})]})}):U.length===0?e.jsx("div",{className:"empty-queue-message",children:r?"No patients found matching your search.":"Queue is empty."}):e.jsxs("div",{className:"queue-table-wrapper",children:[" ",e.jsxs("table",{className:"queue-table",children:[" ",e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Queue"}),e.jsx("th",{children:"Patient"}),e.jsx("th",{children:"Phone Number"}),e.jsx("th",{children:"Complaint"}),e.jsx("th",{children:"Subscription Status"}),e.jsx("th",{className:"hidden md:table-cell",children:"Time Added"})," ",e.jsx("th",{className:"text-center",children:"Action / Doctor"})," "]})}),e.jsx("tbody",{children:U.map(t=>{var n,o,m,d,c,$,v,G,ee,te,se;return e.jsxs("tr",{onClick:()=>O(`/dashboard/edit-complaint/${t.id}`),onMouseEnter:()=>t.patient_id&&C(t.patient_id),className:"queue-row-clickable",children:[e.jsxs("td",{children:[" ",e.jsxs("span",{className:"queue-token",children:["#",t.token_no]})," "]}),e.jsxs("td",{children:[" ",e.jsx("div",{className:"patient-name",children:((n=t.Patient)==null?void 0:n.name)||"N/A"})," ",e.jsxs("div",{className:"patient-details",children:[(o=t.Patient)!=null&&o.age?`${t.Patient.age} yrs, `:"",((m=t.Patient)==null?void 0:m.gender)||""]})," "]}),e.jsxs("td",{children:[" ",e.jsx("div",{className:"patient-phone",children:((d=t.Patient)==null?void 0:d.phone)||"N/A"})," "]}),e.jsx("td",{className:"complaint-text",children:t.complaint||"-"}),e.jsxs("td",{children:[e.jsx("span",{className:`subscription-status-badge ${((c=t.Patient)==null?void 0:c.subscription_status)==="active"?"status-active":(($=t.Patient)==null?void 0:$.subscription_status)==="cancelled"||((v=t.Patient)==null?void 0:v.subscription_status)==="expired"?"status-inactive":"status-none"}`,children:((G=t.Patient)==null?void 0:G.subscription_status)??"None"}),t.Patient&&t.Patient.id&&t.Patient.subscription_status!=="active"&&e.jsx("button",{onClick:P=>{P.stopPropagation(),t.Patient&&O(`/start-subscription/${t.Patient.id}`)},className:"action-button btn-start-sub-queue mt-2",children:"Start Sub"})]}),e.jsx("td",{className:"hidden md:table-cell time-added",children:B(t.created_at)}),e.jsx("td",{className:"action-doctor-cell",children:A===t.id?e.jsx("div",{className:"relative inline-block text-left w-full",onClick:P=>P.stopPropagation(),children:e.jsxs("select",{value:"",onChange:P=>S(t.id,P.target.value),onBlur:()=>w(null),className:"doctor-select-dropdown",autoFocus:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select Doctor..."}),y?e.jsx("option",{disabled:!0,children:"Loading..."}):h.length>0?h.map(P=>e.jsx("option",{value:P.id,children:P.name},P.id)):e.jsx("option",{disabled:!0,children:"No doctors available"})]})}):e.jsxs("div",{className:"action-doctor-content",onClick:P=>P.stopPropagation(),children:[" ",t.status==="waiting"&&e.jsx(e.Fragment,{children:(ee=t.User)!=null&&ee.name?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"doctor-name-display",children:t.User.name}),e.jsx("button",{onClick:()=>E(t.id,"consulting"),className:"action-button btn-start",children:"Start"})]}):y?e.jsx(g,{width:80,height:20}):h.length===0?e.jsx("span",{className:"status-text-red",children:"No doctors"}):h.length===1?e.jsxs("button",{onClick:()=>S(t.id,h[0].id),className:"action-button btn-assign",children:["Assign ",h[0].name]}):e.jsx("button",{onClick:()=>w(t.id),className:"action-button btn-assign",children:"Assign"})}),t.status==="consulting"&&e.jsxs(e.Fragment,{children:[((te=t.User)==null?void 0:te.name)&&e.jsx("span",{className:"doctor-name-display",children:t.User.name}),e.jsx("button",{onClick:()=>E(t.id,"seen"),className:"action-button btn-complete",children:"Complete"})]}),t.status==="seen"&&e.jsxs(e.Fragment,{children:[((se=t.User)==null?void 0:se.name)&&e.jsx("span",{className:"doctor-name-display",children:t.User.name}),e.jsx("span",{className:"status-text-italic",children:"Completed"})]}),t.status==="cancelled"&&e.jsx("span",{className:"status-text-red",children:"Cancelled"})]})})]},t.id)})})]})]})]}),s==="lab"&&e.jsxs("div",{className:"lab-tab-content",children:[" ",e.jsx(ye,{currentUser:a}),e.jsxs("button",{onClick:()=>O("/lab/search-report"),className:"lab-action-button btn-search-lab-reports",children:[e.jsx(X,{size:16}),"Search Lab Reports"]})]}),s==="newtons-ai"&&e.jsx("div",{className:"newtons-ai-tab-content",children:e.jsx(je,{})}),s==="manage-admission"&&e.jsx("div",{className:"manage-admission-tab-content",children:e.jsx(be,{})}),s==="all-patients"&&e.jsx("div",{className:"all-patients-tab-content",children:e.jsx(fe,{})}),s==="custom-bill"&&e.jsx("div",{className:"custom-bill-tab-content",children:e.jsx(ve,{})}),s==="motion-detect"&&e.jsx("div",{className:"motion-detect-tab-content",style:{height:"100%"},children:e.jsx($e,{})})]})})," "]})};export{Ie as default};
