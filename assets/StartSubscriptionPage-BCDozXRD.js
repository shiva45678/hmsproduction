import{f as j,j as e}from"./index-CRA8Xzko.js";import{j as _,u as C,r as i}from"./react-vendor-Cc0P4_ZX.js";import{i as F}from"./subscriptionApi-DjSB8LNX.js";/* empty css                           */import{W as x,a7 as I}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const Y=()=>{const{patientId:o}=_(),d=C(),[l,w]=i.useState(null),[u,k]=i.useState([]),[c,P]=i.useState(""),[E,h]=i.useState(!0),[g,b]=i.useState(null),[p,y]=i.useState("manual"),[f,S]=i.useState(!1),[N,m]=i.useState(null),v=i.useCallback(async()=>{h(!0),b(null);try{const s=await j(`/api/patients/${o}`);if(!s.ok){const r=await s.json();throw new Error(r.message||"Failed to fetch patient details")}const t=await s.json();w(t);const a=await j("/api/subscriptions");if(!a.ok){const r=await a.json();throw new Error(r.message||"Failed to fetch subscription plans")}const n=await a.json();k(n.filter(r=>r.status==="active"))}catch(s){console.error("Error fetching data:",s),b(`Failed to load data: ${s.message}`)}finally{h(!1)}},[o]);i.useEffect(()=>{o?v():(b("Patient ID is missing."),h(!1))},[o,v]);const D=(s,t)=>{const a=new Date(s),n=t.interval||1;switch(t.period){case"daily":a.setDate(s.getDate()+n);break;case"weekly":a.setDate(s.getDate()+n*7);break;case"monthly":a.setMonth(s.getMonth()+n);break;case"yearly":a.setFullYear(s.getFullYear()+n);break;default:console.warn(`Unknown subscription period: ${t.period}. Defaulting to 1 month.`),a.setMonth(s.getMonth()+1)}return a},z=async()=>{if(!o||!c){m("Please select a subscription plan.");return}const s=u.find(t=>t.id===c);if(!s){m("Selected plan details not found.");return}S(!0),m(null);try{const t=new Date,a=D(t,s);if(p==="manual"){const n={subscription_plan_id:c,subscription_status:"active",subscription_start_date:t.toISOString(),subscription_end_date:a.toISOString(),subscription_payment_method:"manual"},r=await j(`/api/patients/${o}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!r.ok){const M=await r.json();throw new Error(M.message||"Failed to start subscription manually")}alert(`Subscription started successfully for ${l==null?void 0:l.name} (Manual Payment)!`),d("/all-patients")}else if(p==="razorpay"){console.log("Initiating Razorpay subscription for plan:",s);const n=await F(o,c);if(n&&n.short_url)window.location.href=n.short_url;else throw new Error("Failed to get Razorpay subscription link from backend.")}}catch(t){console.error("Error starting subscription:",t),m(`Failed to start subscription: ${t.message}`),S(!1)}};return E?e.jsx("div",{className:"loading-state-subscription",children:"Loading patient and plans..."}):g?e.jsxs("div",{className:"subscription-page-container",children:[e.jsxs("div",{className:"error-alert-subscription",role:"alert",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:g})]}),e.jsx("button",{onClick:()=>d(-1),className:"back-button",children:e.jsx(x,{size:16})})]}):l?e.jsxs("div",{className:"subscription-page-container",children:[e.jsx("button",{onClick:()=>d(-1),className:"back-button",children:e.jsx(x,{size:16})}),e.jsxs("h1",{children:[e.jsx(I,{size:28})," ","Start Subscription for ",l.name]}),N&&e.jsxs("div",{className:"error-alert-subscription",role:"alert",children:[" ",e.jsx("span",{children:N})]}),e.jsxs("div",{className:"subscription-form",children:[" ",e.jsx("h2",{children:"Available Subscription Plans"}),u.length===0?e.jsx("p",{className:"empty-state",children:"No active subscription plans found."}):e.jsx("div",{className:"subscription-plan-list",children:u.map(s=>e.jsxs("div",{className:`subscription-plan-card ${c===s.id?"selected-plan":""}`,onClick:()=>P(s.id),children:[e.jsx("h3",{children:s.name}),e.jsxs("p",{className:"price",children:["â‚¹",s.price]}),e.jsxs("p",{className:"duration",children:["Every ",s.interval," ",s.period,s.interval>1?"s":""]}),s.description&&e.jsx("p",{children:s.description})]},s.id))})]}),e.jsxs("div",{className:"subscription-form mb-6",children:[" ",e.jsx("h2",{children:"Select Payment Method"}),e.jsx("div",{className:"form-group",children:e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"radio",name:"paymentMethod",value:"manual",checked:p==="manual",onChange:()=>y("manual"),className:"mr-2"}),e.jsx("span",{children:"Cash (Manual)"})]})}),e.jsx("div",{className:"form-group",children:e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"radio",name:"paymentMethod",value:"razorpay",checked:p==="razorpay",onChange:()=>y("razorpay"),className:"mr-2"}),e.jsx("span",{children:"Razorpay"})]})})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{onClick:z,disabled:!c||f||u.length===0,className:"subscription-btn",children:[f&&e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white mr-2 inline-block"}),f?"Starting...":"Start Subscription"]})})]}):e.jsxs("div",{className:"subscription-page-container",children:[e.jsxs("div",{className:"error-alert-subscription",role:"alert",children:[e.jsx("strong",{children:"Warning: "}),e.jsx("span",{children:"Patient not found."})]}),e.jsx("button",{onClick:()=>d(-1),className:"back-button",children:e.jsx(x,{size:16})})]})};export{Y as default};
