import{j as e,f as R,S as F,t as Fe}from"./index-D_kqlrGT.js";import{r as n,b as Pe,u as Le}from"./react-vendor-Cc0P4_ZX.js";import{X as te,f as we,ad as Ee,ar as Ce,aa as Me,e as ze,i as be,a7 as ge,af as ke,u as Te,v as Ne,aq as Re}from"./ui-vendor-SmiJk_kJ.js";import{Q as Ie}from"./index-CZ6CIOFr.js";/* empty css                            */import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const Be=({patient:I,onClose:h,onSave:L})=>{const[f,l]=n.useState({name:I.name,age:I.age,gender:I.gender,phone:I.phone||""}),[E,m]=n.useState(!1),c=async g=>{g.preventDefault(),m(!0);try{await L({...f,phone:f.phone||void 0}),h()}catch(M){console.error(M),alert("Failed to update patient")}finally{m(!1)}};return e.jsx("div",{className:"modal-overlay",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{className:"modal-content",style:{backgroundColor:"white",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 4px 20px rgba(0,0,0,0.15)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx("h3",{style:{margin:0,fontSize:"1.2rem",color:"#333"},children:"Edit Patient Details"}),e.jsx("button",{onClick:h,style:{border:"none",background:"none",cursor:"pointer",color:"#666"},children:e.jsx(te,{size:20})})]}),e.jsxs("form",{onSubmit:c,style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"0.9rem",color:"#555"},children:"Name"}),e.jsx("input",{type:"text",value:f.name,onChange:g=>l({...f,name:g.target.value}),className:"dental-search-input",style:{padding:"10px",fontSize:"0.95rem"},required:!0})]}),e.jsxs("div",{style:{display:"flex",gap:"16px"},children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"0.9rem",color:"#555"},children:"Age"}),e.jsx("input",{type:"number",value:f.age||"",onChange:g=>l({...f,age:parseInt(g.target.value)||0}),className:"dental-search-input",style:{padding:"10px",fontSize:"0.95rem"}})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"0.9rem",color:"#555"},children:"Gender"}),e.jsxs("select",{value:f.gender||"",onChange:g=>l({...f,gender:g.target.value}),className:"dental-search-input",style:{padding:"10px",fontSize:"0.95rem",width:"100%"},children:[e.jsx("option",{value:"M",children:"Male"}),e.jsx("option",{value:"F",children:"Female"}),e.jsx("option",{value:"O",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"0.9rem",color:"#555"},children:"Phone"}),e.jsx("input",{type:"tel",value:f.phone,onChange:g=>l({...f,phone:g.target.value}),className:"dental-search-input",style:{padding:"10px",fontSize:"0.95rem"},placeholder:"Optional"})]}),e.jsx("button",{type:"submit",className:"save-btn",style:{marginTop:"8px",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},disabled:E,children:E?"Saving...":e.jsxs(e.Fragment,{children:[e.jsx(we,{size:18})," Save Changes"]})})]})]})})},Ae=I=>[1,2,3,14,15,16,17,18,19,30,31,32].includes(I)?{type:"molar",roots:2}:[4,5,12,13,20,21,28,29].includes(I)?{type:"premolar",roots:1}:[6,11,22,27].includes(I)?{type:"canine",roots:1}:{type:"incisor",roots:1},se=({toothNumber:I,conditions:h=[],className:L,style:f,isSelected:l,bridgeConnectPrevious:E})=>{const{type:m}=Ae(I),c=I<=16,g="M5,20 Q5,5 18,5 Q31,5 31,20 L29,25 Q18,28 7,25 Z",M="M7,25 Q5,40 10,44 Q14,40 14,26",k="M29,25 Q31,40 26,44 Q22,40 22,26",y="M8,20 Q8,8 18,8 Q28,8 28,20 L26,24 Q18,27 10,24 Z",i="M10,24 Q16,44 18,45 Q20,44 26,24",u="M8,22 Q18,2 28,22 L26,25 Q18,28 10,25 Z",N="M10,25 Q18,48 26,25",w="M10,22 L10,12 Q18,12 26,12 L26,22 L24,25 Q18,27 12,25 Z",C="M12,25 Q18,46 24,25";let B=g,D=[M,k];m==="incisor"?(B=w,D=[C]):m==="canine"?(B=u,D=[N]):m==="premolar"&&(B=y,D=[i]);const t=h.includes("condition-rct"),j=h.includes("condition-filling"),W=h.includes("condition-crown"),O=h.includes("condition-bridge"),Y=h.includes("condition-extraction"),G=h.includes("condition-implant"),ne=t?"#e9d5ff":"#f3f4f6",Z=Y?"#fee2e2":"#ffffff",U=Y?"#ef4444":O?"#0891b2":G?"#475569":W?"#b45309":l?"#3b82f6":"#6b7280",V=l||O||W||G?2:1.5,$=c?"M20,15 L56,15 L56,22 L20,22 Z":"M16,15 L-20,15 L-20,22 L16,22 Z";return e.jsxs("svg",{viewBox:"0 0 36 50",className:L,style:{width:"100%",height:"100%",overflow:"visible",...f},children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"goldGradient",x1:"0",x2:"1",y1:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:"#fcd34d"}),e.jsx("stop",{offset:"100%",stopColor:"#d97706"})]}),e.jsxs("linearGradient",{id:"bridgeGradient",x1:"0",x2:"1",y1:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:"#22d3ee"}),e.jsx("stop",{offset:"100%",stopColor:"#0891b2"})]}),e.jsxs("linearGradient",{id:"titaniumGradient",x1:"0",x2:"1",y1:"0",y2:"0",children:[e.jsx("stop",{offset:"0%",stopColor:"#475569"}),e.jsx("stop",{offset:"30%",stopColor:"#94a3b8"}),e.jsx("stop",{offset:"50%",stopColor:"#f8fafc"}),e.jsx("stop",{offset:"70%",stopColor:"#94a3b8"}),e.jsx("stop",{offset:"100%",stopColor:"#475569"})]})]}),E&&e.jsx("path",{d:$,fill:"url(#bridgeGradient)",stroke:"#0891b2",strokeWidth:"1.5"}),G?e.jsxs("g",{children:[e.jsx("path",{d:"M13,25 L23,25 L22,28 L23,29 L22,30 L22,33 L23,34 L22,35 L22,38 L23,39 L22,40 L19,46 Q18,48 17,46 L14,40 L13,39 L14,38 L14,35 L13,34 L14,33 L14,30 L13,29 L14,28 Z",fill:"url(#titaniumGradient)",stroke:U,strokeWidth:"1"}),e.jsxs("g",{stroke:"rgba(255,255,255,0.4)",strokeWidth:"0.5",children:[e.jsx("line",{x1:"14",y1:"29",x2:"22",y2:"29"}),e.jsx("line",{x1:"14",y1:"34",x2:"22",y2:"34"}),e.jsx("line",{x1:"14",y1:"39",x2:"22",y2:"39"})]}),e.jsx("rect",{x:"15",y:"22",width:"6",height:"4",fill:"#64748b",stroke:U,strokeWidth:"1",rx:"1"})]}):e.jsx("g",{fill:ne,stroke:U,strokeWidth:V,strokeLinejoin:"round",children:D.map((ae,he)=>e.jsx("path",{d:ae},he))}),t&&!G&&e.jsx("g",{fill:"none",stroke:"#9333ea",strokeWidth:"2.5",strokeLinecap:"round",children:m==="molar"?e.jsxs(e.Fragment,{children:[e.jsx("path",{d:"M12,28 L11,42"}),e.jsx("path",{d:"M24,28 L25,42"})]}):e.jsx("path",{d:"M18,25 L18,44"})}),e.jsx("path",{d:B,fill:O?"url(#bridgeGradient)":W?"url(#goldGradient)":Z,stroke:U,strokeWidth:V,strokeLinejoin:"round"}),j&&!W&&!O&&!G&&e.jsx("circle",{cx:"18",cy:"16",r:"4",fill:"#3b82f6",stroke:"#1d4ed8",strokeWidth:"1"}),Y&&e.jsxs("g",{stroke:"#ef4444",strokeWidth:"3",strokeLinecap:"round",children:[e.jsx("line",{x1:"8",y1:"8",x2:"28",y2:"42"}),e.jsx("line",{x1:"28",y1:"8",x2:"8",y2:"42"})]})]})},_e=({selectedTeeth:I,toothConditions:h={},toothDetails:L={},onToothClick:f,onEditPastRecord:l,onPrint:E})=>{const m=Array.from({length:16},(i,u)=>u+1),c=Array.from({length:16},(i,u)=>32-u),[g,M]=Pe.useState(null),k=i=>{const u=h[i]||[],N=I.includes(i);let w=[],C="#9ca3af",B;const D=u.includes("condition-extraction");return N&&(C="#3b82f6"),u.includes("condition-filling")&&w.push("#60a5fa"),u.includes("condition-rct")&&w.push("#c084fc"),u.includes("condition-crown")&&(w.push("#fcd34d"),C="#d97706"),u.includes("condition-bridge")&&(w.push("#22d3ee"),C="#0891b2"),u.includes("condition-implant")&&(w.push("#94a3b8"),C="#475569"),u.includes("condition-extraction")&&(w.push("#fee2e2"),C="#ef4444"),w.length===0&&N&&w.push("#eff6ff"),w.length===0&&w.push("#ffffff"),{fillColors:w,borderColor:C,overlayColor:B,isSelected:N,hasExtraction:D}},y=i=>{const{isSelected:u}=k(i),N=h[i]||[],w=L[i],C=i<=16,B=N.includes("condition-bridge");let D=!1;if(B){let t=null;C?i>1&&(t=i-1):i<32&&(t=i+1),t!==null&&(h[t]||[]).includes("condition-bridge")&&(D=!0)}return e.jsxs("div",{onClick:()=>f(i),onMouseEnter:()=>M(i),onMouseLeave:()=>M(null),className:`tooth-item-container ${u?"selected":""}`,title:"",children:[e.jsx("div",{className:"tooth-number-label",children:i}),e.jsx("div",{className:"tooth-svg-wrapper",style:{transform:C?"rotate(180deg)":"none"},children:e.jsx(se,{toothNumber:i,conditions:N,isSelected:u,bridgeConnectPrevious:D})}),g===i&&w&&w.length>0&&e.jsxs("div",{className:"tooth-tooltip-window",children:[e.jsxs("div",{className:"tooltip-header",children:["Tooth ",i]}),e.jsx("ul",{className:"tooltip-list",children:w.map((t,j)=>e.jsxs("li",{className:"tooltip-detail-item",children:[e.jsxs("span",{className:"detail-text",children:[t.name," ",e.jsxs("small",{children:["(",t.date,")"]})]}),t.isPast&&l&&e.jsx("button",{className:"tooltip-edit-btn",onClick:W=>{W.stopPropagation(),l(t.recordId)},title:"Edit this record",children:e.jsx(Ce,{size:12})})]},j))})]})]},i)};return e.jsxs("div",{className:"chart-container-inner",style:{position:"relative"},children:[E&&e.jsxs("button",{onClick:i=>{i.stopPropagation(),E()},className:"chart-print-btn no-print",title:"Print Report",children:[e.jsx(Ee,{size:16}),e.jsx("span",{children:"Print Report"})]}),e.jsx("div",{className:"arch-label",children:"Maxillary (Upper)"}),e.jsxs("div",{className:"arch-row",children:[e.jsx("div",{className:"quadrant",children:m.slice(0,8).map(i=>y(i))}),e.jsx("div",{className:"quadrant",children:m.slice(8).map(i=>y(i))})]}),e.jsxs("div",{className:"midline-divider",children:[e.jsx("div",{className:"divider-line"}),e.jsx("span",{className:"chart-label",children:"Midline"}),e.jsx("div",{className:"divider-line"})]}),e.jsxs("div",{className:"arch-row",children:[e.jsx("div",{className:"quadrant",children:c.slice(0,8).map(i=>y(i))}),e.jsx("div",{className:"quadrant",children:c.slice(8).map(i=>y(i))})]}),e.jsx("div",{className:"arch-label",children:"Mandibular (Lower)"}),e.jsxs("div",{className:"chart-legend",children:[e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(se,{toothNumber:1,conditions:[],style:{width:16,height:22}})}),e.jsx("span",{children:"Healthy"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(se,{toothNumber:1,conditions:["condition-filling"],style:{width:16,height:22}})}),e.jsx("span",{children:"Filling (Dot)"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(se,{toothNumber:1,conditions:["condition-rct"],style:{width:16,height:22}})}),e.jsx("span",{children:"RCT (Root Lines)"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(se,{toothNumber:1,conditions:["condition-crown"],style:{width:16,height:22}})}),e.jsx("span",{children:"Crown"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(se,{toothNumber:1,conditions:["condition-bridge"],style:{width:16,height:22}})}),e.jsx("span",{children:"Bridge"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(se,{toothNumber:1,conditions:["condition-implant"],style:{width:16,height:22}})}),e.jsx("span",{children:"Implant"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(se,{toothNumber:1,conditions:["condition-extraction"],style:{width:16,height:22}})}),e.jsx("span",{children:"Extraction (X)"})]})]}),e.jsxs("div",{className:"print-only-details-summary print-only",children:[e.jsx("h3",{children:"Tooth Procedure Details"}),Object.keys(L).length===0?e.jsx("p",{className:"no-details",children:"No specific tooth procedures recorded."}):e.jsxs("table",{className:"print-details-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Tooth"}),e.jsx("th",{children:"Procedure"}),e.jsx("th",{children:"Date"})]})}),e.jsx("tbody",{children:Object.entries(L).sort(([i],[u])=>parseInt(i)-parseInt(u)).map(([i,u])=>e.jsx(Pe.Fragment,{children:u.map((N,w)=>e.jsxs("tr",{children:[w===0?e.jsxs("td",{rowSpan:u.length,className:"tooth-cell",children:["Tooth ",i]}):null,e.jsx("td",{children:N.name}),e.jsx("td",{children:N.date})]},`${i}-${w}`))},i))})]})]})]})},Oe=({onClose:I,onUpdate:h})=>{const[L,f]=n.useState([]),[l,E]=n.useState(!0),[m,c]=n.useState(null),[g,M]=n.useState({}),[k,y]=n.useState(!1),[i,u]=n.useState({name:"",cost:0,type:"general"});n.useEffect(()=>{N()},[]);const N=async()=>{E(!0);try{const t=await R("/api/dental/procedures");if(t.ok){const j=await t.json();f(j)}}catch(t){console.error(t)}finally{E(!1)}},w=async()=>{if(!(!i.name||!i.cost))try{(await R("/api/dental/procedures",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).ok&&(y(!1),u({name:"",cost:0,type:"general"}),N(),h())}catch(t){console.error(t)}},C=async t=>{try{(await R(`/api/dental/procedures/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)})).ok&&(c(null),M({}),N(),h())}catch(j){console.error(j)}},B=async t=>{if(window.confirm("Are you sure you want to delete this procedure?"))try{(await R(`/api/dental/procedures/${t}`,{method:"DELETE"})).ok&&(N(),h())}catch(j){console.error(j)}},D=t=>{c(t.id),M({name:t.name,cost:t.cost,type:t.type})};return e.jsx("div",{className:"manage-procedures-modal-overlay",children:e.jsxs("div",{className:"manage-procedures-modal-content",children:[e.jsxs("div",{className:"manage-procedures-modal-header",children:[e.jsx("h2",{className:"manage-procedures-modal-title",children:"Manage Procedures"}),e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[e.jsx("button",{onClick:async()=>{if(window.confirm("Import missing default procedures?"))try{await R("/api/dental/procedures/import-defaults",{method:"POST"}),N(),h()}catch(t){console.error(t)}},className:"btn-secondary",style:{padding:"6px 12px",fontSize:"0.8rem"},children:"Import Defaults"}),e.jsx("button",{onClick:I,className:"manage-procedures-close-btn",children:e.jsx(te,{size:20})})]})]}),e.jsx("div",{className:"manage-procedures-list-container",children:l?e.jsx("div",{style:{padding:"20px",textAlign:"center"},children:"Loading procedures..."}):e.jsxs("table",{className:"manage-procedures-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"40%"},children:"Name"}),e.jsx("th",{style:{width:"20%"},children:"Type"}),e.jsx("th",{style:{width:"20%"},children:"Cost (₹)"}),e.jsx("th",{style:{width:"20%"},children:"Actions"})]})}),e.jsx("tbody",{children:L.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,style:{textAlign:"center",padding:"20px",color:"#888"},children:"No procedures found. Add one below."})}):L.map(t=>e.jsx("tr",{children:m===t.id?e.jsxs(e.Fragment,{children:[e.jsx("td",{children:e.jsx("input",{type:"text",className:"edit-input",value:g.name||"",onChange:j=>M({...g,name:j.target.value}),placeholder:"Procedure Name"})}),e.jsx("td",{children:e.jsxs("select",{className:"edit-select",value:g.type||"general",onChange:j=>M({...g,type:j.target.value}),children:[e.jsx("option",{value:"general",children:"General"}),e.jsx("option",{value:"filling",children:"Filling"}),e.jsx("option",{value:"rct",children:"RCT"}),e.jsx("option",{value:"extraction",children:"Extraction"}),e.jsx("option",{value:"crown",children:"Crown"}),e.jsx("option",{value:"bridge",children:"Bridge"}),e.jsx("option",{value:"implant",children:"Implant"})]})}),e.jsx("td",{children:e.jsx("input",{type:"number",className:"edit-input",value:g.cost||0,onChange:j=>M({...g,cost:parseFloat(j.target.value)}),placeholder:"Cost"})}),e.jsxs("td",{children:[e.jsx("button",{onClick:()=>C(t.id),className:"action-btn btn-save",title:"Save",children:e.jsx(we,{size:18})}),e.jsx("button",{onClick:()=>c(null),className:"action-btn btn-cancel",title:"Cancel",children:e.jsx(te,{size:18})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{children:t.name}),e.jsx("td",{children:e.jsx("span",{className:`procedure-badge badge-${t.type}`,children:t.type})}),e.jsxs("td",{style:{fontWeight:500},children:["₹",t.cost]}),e.jsxs("td",{children:[e.jsx("button",{onClick:()=>D(t),className:"action-btn btn-edit",title:"Edit",children:e.jsx(Ce,{size:18})}),e.jsx("button",{onClick:()=>B(t.id),className:"action-btn btn-delete",title:"Delete",children:e.jsx(Me,{size:18})})]})]})},t.id))})]})}),e.jsx("div",{className:"add-procedure-section",children:k?e.jsxs("div",{className:"add-procedure-card",children:[e.jsx("h4",{className:"add-procedure-title",children:"Add New Procedure"}),e.jsxs("div",{className:"add-form-grid",children:[e.jsx("input",{type:"text",className:"form-input",placeholder:"Procedure Name",value:i.name||"",onChange:t=>u({...i,name:t.target.value})}),e.jsxs("select",{className:"form-select",value:i.type||"general",onChange:t=>u({...i,type:t.target.value}),children:[e.jsx("option",{value:"general",children:"General"}),e.jsx("option",{value:"filling",children:"Filling"}),e.jsx("option",{value:"rct",children:"RCT"}),e.jsx("option",{value:"extraction",children:"Extraction"}),e.jsx("option",{value:"crown",children:"Crown"}),e.jsx("option",{value:"bridge",children:"Bridge"}),e.jsx("option",{value:"implant",children:"Implant"})]}),e.jsx("input",{type:"number",className:"form-input",placeholder:"Cost",value:i.cost||"",onChange:t=>u({...i,cost:parseFloat(t.target.value)})}),e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{onClick:w,className:"btn-primary",children:"Save"}),e.jsx("button",{onClick:()=>y(!1),className:"btn-secondary",children:"Cancel"})]})]})]}):e.jsxs("button",{onClick:()=>y(!0),className:"add-trigger-btn",children:[e.jsx(ze,{size:18})," Add New Procedure"]})})]})})},Ue=({toothNumber:I,procedures:h,history:L=[],onSelect:f,onClose:l})=>{const[E,m]=n.useState(""),[c,g]=n.useState(L.length>0?"history":"add"),M=n.useMemo(()=>h.filter(k=>k.name.toLowerCase().includes(E.toLowerCase())),[h,E]);return e.jsxs("div",{className:"modal-overlay",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,backdropFilter:"blur(2px)"},children:[e.jsxs("div",{className:"modal-content",style:{backgroundColor:"var(--dp-card-bg)",borderRadius:"12px",width:"100%",maxWidth:"400px",boxShadow:"0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",overflow:"hidden",animation:"scaleUp 0.2s ease-out"},children:[e.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid var(--dp-border)",display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"var(--dp-bg)"},children:[e.jsxs("h3",{style:{margin:0,color:"var(--dp-text)",fontSize:"1.1rem"},children:["Tooth ",I]}),e.jsx("button",{onClick:l,style:{background:"none",border:"none",color:"var(--dp-text-sec)",cursor:"pointer",padding:"4px"},children:e.jsx(te,{size:20})})]}),L.length>0&&e.jsxs("div",{className:"sidebar-tabs",style:{padding:"0 16px",paddingTop:"8px",background:"var(--dp-bg)"},children:[e.jsx("button",{className:c==="add"?"active":"",onClick:()=>g("add"),style:{padding:"8px 12px",borderBottomWidth:"2px"},children:"Add Procedure"}),e.jsxs("button",{className:c==="history"?"active":"",onClick:()=>g("history"),style:{padding:"8px 12px",borderBottomWidth:"2px"},children:["History (",L.length,")"]})]}),c==="add"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{padding:"12px 16px",borderBottom:"1px solid var(--dp-border)"},children:e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center"},children:[e.jsx(be,{size:16,style:{position:"absolute",left:"12px",color:"var(--dp-text-sec)"}}),e.jsx("input",{type:"text",placeholder:"Search procedures...",value:E,onChange:k=>m(k.target.value),style:{width:"100%",padding:"8px 12px 8px 36px",borderRadius:"8px",border:"1px solid var(--dp-border)",backgroundColor:"var(--dp-bg)",color:"var(--dp-text)",fontSize:"0.9rem",outline:"none"},autoFocus:!0})]})}),e.jsx("div",{style:{maxHeight:"400px",overflowY:"auto"},children:M.length===0?e.jsx("div",{style:{padding:"24px",textAlign:"center",color:"var(--dp-text-sec)",fontSize:"0.9rem"},children:"No procedures found."}):e.jsx("div",{style:{display:"flex",flexDirection:"column"},children:M.map(k=>e.jsxs("button",{onClick:()=>f(k),style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 16px",border:"none",background:"transparent",borderBottom:"1px solid var(--dp-border)",cursor:"pointer",textAlign:"left",transition:"background-color 0.1s"},className:"procedure-modal-item",onMouseOver:y=>y.currentTarget.style.backgroundColor="var(--dp-bg)",onMouseOut:y=>y.currentTarget.style.backgroundColor="transparent",children:[e.jsxs("div",{children:[e.jsx("div",{style:{color:"var(--dp-text)",fontWeight:500,fontSize:"0.95rem"},children:k.name}),e.jsx("div",{style:{color:"var(--dp-text-sec)",fontSize:"0.8rem",textTransform:"capitalize"},children:k.type})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"var(--dp-primary)",fontWeight:600,fontSize:"0.9rem"},children:[e.jsxs("span",{children:["₹",k.cost]}),e.jsx(ze,{size:16})]})]},k.id))})})]}),c==="history"&&e.jsx("div",{style:{maxHeight:"400px",overflowY:"auto",padding:"0"},children:L.map((k,y)=>e.jsxs("div",{style:{padding:"12px 16px",borderBottom:"1px solid var(--dp-border)"},children:[e.jsx("div",{style:{fontWeight:500,fontSize:"0.9rem"},children:k.name}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"var(--dp-text-sec)"},children:[k.date," ",k.isPast?"(Past)":"(Current)"]})]},y))})]}),e.jsx("style",{children:`
                @keyframes scaleUp {
                    from { transform: scale(0.95); opacity: 0; }
                    to { transform: scale(1); opacity: 1; }
                }
            `})]})},$e=({isOpen:I,onClose:h,recordId:L,onBillingComplete:f})=>{var oe,me,je,J,ce;const[l,E]=n.useState(null),[m,c]=n.useState([]),[g,M]=n.useState(!0),[k,y]=n.useState(null),[i,u]=n.useState(!1),[N,w]=n.useState("cash"),[C,B]=n.useState(""),[D,t]=n.useState(""),[j,W]=n.useState(""),[O,Y]=n.useState(""),[G,ne]=n.useState(""),[Z,U]=n.useState(0),V=n.useRef(!1),[$,ae]=n.useState(null),[he,pe]=n.useState(!1),fe=p=>{const v=Math.max(0,Math.min(100,isNaN(p)?0:p));V.current=!0,U(v);const z=m.map(b=>({...b,discount_percentage:v}));c(z)},xe=(p,v)=>{const z=[...m];z[p].discount_percentage=isNaN(v)?0:v,c(z)};n.useEffect(()=>{if(V.current){V.current=!1;return}const p=m.reduce((b,Q)=>b+(Q.price??0),0);if(p===0){U(0);return}const z=m.reduce((b,Q)=>{const K=(Q.price??0)*((Q.discount_percentage??0)/100);return b+K},0)/p*100;U(b=>Math.abs(b-z)>.01?z:b)},[m]);const le=async()=>{if(!l)return y("No record data available to bill."),null;if(m.length===0)return y("Cannot bill an empty procedure list."),null;u(!0),y(null);try{const p=m.map(_=>{const K=_.price,q=K*((_.discount_percentage??0)/100),ye=K-q;return{name:_.name,price:_.price,quantity:1,total:ye,item_id:_.id||`proc_${Date.now()}`,type:"service",discount_percentage:_.discount_percentage??0}}),v={patientId:l.patientId.id,items:p,amount:H,paymentMode:N,type:"dental",related_id:l.id,status:"paid",discountPercentage:Z},z=await R("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)}),b=await z.json();if(!z.ok||!b.id)throw new Error(b.message||"Failed to create bill.");if((await R(`/api/dental/${l.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",billId:b.id})})).ok||console.error("Failed to update dental record status"),E(_=>_?{..._,status:"billed",billId:b.id}:null),N==="credit")try{await R(`/api/patient-debts/${l.patientId.id}/debts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction_date:new Date().toISOString().split("T")[0],debt_value:H,related_bill_id:b.id,notes:`Dental Bill #${b.id}`})})}catch(_){console.error("Failed to create debt entry:",_)}return f&&f(),b.id}catch(p){return console.error("Billing process failed:",p),y(p.message||"Failed to create bill."),null}finally{u(!1)}},ee=()=>{window.print()},ue=async()=>{await le()&&setTimeout(()=>window.print(),800)};n.useEffect(()=>{I&&L&&(async()=>{M(!0);try{const[v,z]=await Promise.all([R(`/api/dental/${L}`),R("/api/clinics/settings").catch(()=>({ok:!1,json:async()=>({})}))]);if(!v.ok)throw new Error("Failed to fetch dental record");const b=await v.json(),Q={...b,patientId:b.Patient||b.patientId};if(E(Q),z.ok){const q=await z.json();t(q.upi_id||""),W(q.name||""),Y(q.address||""),ne(q.notes||"")}const K=(Q.selected_procedures||Q.selectedProcedures||[]).map(q=>({...q,price:q.cost,discount_percentage:0}));c(K)}catch(v){console.error("Failed to fetch data:",v),y(v.message)}finally{M(!1)}})()},[I,L]);const ie=n.useMemo(()=>m.reduce((p,v)=>p+(v.price??0),0),[m]),re=n.useMemo(()=>m.reduce((p,v)=>{const b=(v.price??0)*(v.discount_percentage??0)/100;return p+b},0),[m]),H=n.useMemo(()=>ie-re,[ie,re]);return n.useEffect(()=>{if(H>0&&D){const p=`upi://pay?pa=${D}&pn=${encodeURIComponent(j)}&am=${H.toFixed(2)}&cu=INR`;B(p)}else B("")},[H,D,j]),n.useEffect(()=>{(async()=>{var v;if(N==="credit"&&((v=l==null?void 0:l.patientId)!=null&&v.id)){pe(!0);try{const z=await R(`/api/patient-debts/${l.patientId.id}/balance`);if(z.ok){const b=await z.json();ae(b.netDebt||0)}else ae(0)}catch{ae(0)}finally{pe(!1)}}})()},[N,(oe=l==null?void 0:l.patientId)==null?void 0:oe.id]),I?e.jsx("div",{className:"dental-billing-modal-overlay",children:e.jsxs("div",{className:"dental-billing-modal-content",children:[e.jsxs("header",{className:"dental-billing-modal-header no-print",children:[e.jsx("h2",{children:"Dental Invoice"}),e.jsx("button",{onClick:h,className:"close-modal-btn",children:e.jsx(te,{size:20})})]}),e.jsx("div",{className:"dental-billing-modal-body",children:g?e.jsx("div",{className:"pharmacy-billing-page",children:e.jsx("div",{className:"billing-container",children:e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("div",{className:"order-details-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(F,{width:150,height:24})})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsx("div",{className:"info-item",children:e.jsx(F,{width:200,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(F,{width:150,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(F,{width:180,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(F,{width:150,height:20})})]})]}),e.jsxs("div",{className:"medications-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(F,{width:120,height:24})})}),e.jsx("div",{className:"p-4",children:e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx(F,{width:30,height:20})}),e.jsx("th",{children:e.jsx(F,{width:150,height:20})}),e.jsx("th",{children:e.jsx(F,{width:80,height:20})}),e.jsx("th",{children:e.jsx(F,{width:80,height:20})}),e.jsx("th",{children:e.jsx(F,{width:100,height:20})})]})}),e.jsx("tbody",{children:[1,2,3].map(p=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(F,{width:20,height:20})}),e.jsx("td",{children:e.jsx(F,{width:180,height:20})}),e.jsx("td",{children:e.jsx(F,{width:70,height:20})}),e.jsx("td",{children:e.jsx(F,{width:70,height:20})}),e.jsx("td",{children:e.jsx(F,{width:90,height:20})})]},p))})]})})]})]}),e.jsx("aside",{className:"billing-sidebar",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(F,{width:160,height:24})})}),e.jsxs("div",{className:"space-y-4 p-5",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(F,{width:100,height:20}),e.jsx(F,{width:80,height:20})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(F,{width:100,height:20}),e.jsx(F,{width:80,height:20})]}),e.jsx("hr",{}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(F,{width:120,height:28}),e.jsx(F,{width:100,height:28})]})]})]})})]})})}):k?e.jsxs("div",{className:"error-message-box",children:["Error: ",k]}):l?e.jsx("div",{className:"pharmacy-billing-page",children:e.jsxs("div",{className:"billing-container printable-section",children:[e.jsxs("div",{className:"billing-header print-only",children:[e.jsx("div",{className:"clinic-header-left",children:e.jsx("div",{className:"clinic-info-print",children:e.jsxs("div",{className:"clinic-name-and-details-print",children:[e.jsx("h1",{className:"bill-title",children:"DENTAL INVOICE"}),e.jsx("h2",{className:"clinic-name-print",children:j||"Clinic Name"}),(O||G)&&e.jsxs("div",{className:"clinic-details-print",children:[O&&e.jsx("span",{className:"small-text clinic-address",children:O}),G&&e.jsx("span",{className:"small-text clinic-notes",children:G})]})]})})}),e.jsxs("div",{className:"patient-info-grid print-only-patient-details",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(ge,{size:16})," Patient Name"]})," ",((me=l.patientId)==null?void 0:me.name)||"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(ke,{size:16})," Token"]})," ",((je=l.patientId)==null?void 0:je.patient_token_number)??"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Te,{size:16})," Date"]})," ",new Date(l.date||l.createdAt).toLocaleDateString()]})]})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("section",{className:"order-details-card no-print",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Patient Information"})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(ge,{size:16})," Patient Name"]})," ",((J=l.patientId)==null?void 0:J.name)||"N/A"," "]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(ke,{size:16})," Token"]})," ",((ce=l.patientId)==null?void 0:ce.patient_token_number)??"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Ne,{size:16})," Record ID"]})," ",l.id.substring(l.id.length-6)]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Te,{size:16})," Date"]})," ",new Date(l.createdAt).toLocaleDateString()]})]})]}),e.jsxs("section",{className:"medications-card",children:[e.jsx("div",{className:"card-header no-print",children:e.jsx("h2",{children:"Procedures"})}),m.length>0?e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"S.No."}),e.jsx("th",{children:"PROCEDURE"}),e.jsx("th",{children:"PRICE"}),e.jsx("th",{children:"DIS %"}),e.jsx("th",{children:"AMT"})]})}),e.jsx("tbody",{children:m.map((p,v)=>{const z=p.price??0,b=z*(p.discount_percentage??0)/100,Q=z-b;return e.jsxs("tr",{children:[e.jsx("td",{children:v+1}),e.jsx("td",{children:p.name}),e.jsx("td",{children:p.price.toFixed(2)}),e.jsxs("td",{children:[e.jsx("input",{type:"number",value:p.discount_percentage===0?"":p.discount_percentage,onChange:_=>xe(v,parseFloat(_.target.value)),min:"0",max:"100",className:"discount-input-table"}),"%"]}),e.jsx("td",{children:Q.toFixed(2)})]},v)})})]}):e.jsx("p",{className:"p-4 text-gray-500",children:"No procedures selected."})]}),e.jsxs("div",{className:"bill-summary-print print-only",children:[e.jsxs("div",{className:"bill-summary-details",children:[e.jsxs("div",{className:"summary-row-print",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",ie.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row-print",children:[e.jsxs("span",{children:["Discount (",Z.toFixed(2),"%)"]}),e.jsxs("span",{children:["- ₹",re.toFixed(2)]})]}),e.jsx("div",{className:"print-only-total",children:e.jsxs("strong",{children:["Grand Total: ₹",H.toFixed(2)]})})]}),C&&e.jsxs("div",{className:`qr-code-container qr-code-printable-section ${N!=="upi"?"hide-on-screen":""}`,children:[e.jsx(Ie,{value:C,size:80}),e.jsx("p",{className:"print-only-upi-text",children:"Scan to pay"})]})]})]}),e.jsx("aside",{className:"billing-sidebar no-print",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Billing Summary"})}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",ie.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Total Discount"}),e.jsxs("span",{children:["- ₹",re.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Discount Percentage"}),e.jsxs("div",{className:"discount-input-wrapper",children:[e.jsx("input",{type:"number",value:Z===0?"":Z,onChange:p=>fe(parseFloat(p.target.value)),min:"0",max:"100",className:"discount-input-total",disabled:i||l.status==="billed"}),"%"]})]}),e.jsxs("div",{className:"summary-row grand-total-row",children:[e.jsx("strong",{children:"Grand Total"}),e.jsxs("strong",{children:["₹",H.toFixed(2)]})]}),e.jsx("div",{className:"qr-code-container",children:C?e.jsxs(e.Fragment,{children:[e.jsx(Ie,{value:C,size:128}),e.jsx("p",{children:"Scan to pay using UPI"})]}):e.jsx("p",{className:"text-sm text-gray-500",children:"UPI QR code not available."})}),e.jsxs("div",{className:"payment-mode-section",children:[e.jsx("label",{className:"info-item",children:e.jsx("strong",{children:"Payment Mode"})}),e.jsxs("select",{value:N,onChange:p=>w(p.target.value),className:"payment-mode-select",disabled:i||l.status==="billed",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"no_cash_insurance",children:"Insurance"}),e.jsx("option",{value:"credit",children:"Credit (Debt)"})]})]}),N==="credit"&&e.jsxs("div",{className:"debt-info-section",style:{marginTop:"10px",padding:"12px",backgroundColor:"rgba(220, 53, 69, 0.1)",borderRadius:"8px",border:"1px solid rgba(220, 53, 69, 0.3)"},children:[e.jsx("div",{style:{fontWeight:"bold",color:"#dc3545",marginBottom:"8px"},children:"⚠️ Debt to Patient"}),he?e.jsx("div",{style:{fontSize:"0.9em",color:"#666"},children:"Loading debt info..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"Current Debt:"}),e.jsxs("strong",{style:{color:$&&$>0?"#dc3545":"#28a745"},children:["₹",($||0).toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"This Bill:"}),e.jsxs("strong",{children:["+ ₹",H.toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",borderTop:"1px solid rgba(220, 53, 69, 0.3)",paddingTop:"8px",marginTop:"8px"},children:[e.jsx("span",{children:e.jsx("strong",{children:"New Total Debt:"})}),e.jsxs("strong",{style:{color:"#dc3545"},children:["₹",(($||0)+H).toFixed(2)]})]})]})]}),e.jsx("div",{className:"bill-actions mt-6 flex flex-col gap-3",children:l.status!=="billed"?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:ee,className:"secondary-button print-preview-button no-print",disabled:i,children:"Print Preview"}),e.jsx("button",{onClick:ue,className:"primary-button",disabled:i,children:i?"Processing...":"Finalise and Bill"})]}):e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"p-3 bg-green-50 text-green-700 text-center rounded-lg font-medium border border-green-100 flex items-center justify-center gap-2",children:[e.jsx(Re,{size:20})," Bill Generated"]}),e.jsx("button",{onClick:ee,className:"secondary-button print-preview-button no-print",children:"Print Preview"})]})})]})})]}),e.jsx("footer",{className:"billing-footer print-only",children:e.jsx("p",{children:"Computer generated invoice."})})]})}):e.jsx("div",{className:"error-message-box",children:"No record found."})})]})}):null},De=/^\+?[0-9\s\-().]{7,20}$/,Qe=/^[a-zA-Z\s'-]{2,}$/,Ye=()=>{const I=Le(),[h,L]=n.useState(""),[f,l]=n.useState([]),[E,m]=n.useState(!1),[c,g]=n.useState(null),[M,k]=n.useState(!1),[y,i]=n.useState(!1),[u,N]=n.useState(!1),[w,C]=n.useState([]),[B,D]=n.useState([]),[t,j]=n.useState({}),[W,O]=n.useState(""),[Y,G]=n.useState(!1),[ne,Z]=n.useState("plan"),[U,V]=n.useState([]),[$,ae]=n.useState([]),[he,pe]=n.useState(!1),[fe,xe]=n.useState(!1),[le,ee]=n.useState(null);n.useEffect(()=>{ue()},[]);const ue=async()=>{try{const s=await R("/api/dental/procedures");if(s.ok){const a=await s.json();ae(a)}}catch(s){console.error("Error fetching procedures",s)}};n.useEffect(()=>{(async()=>{if(!c){V([]),ee(null),O(""),D([]),j({}),C([]);return}try{const a=await R(`/api/dental/patient/${c.id}`);if(a.ok){const r=await a.json();V(r);const x=new Date().toDateString(),S=r.find(o=>o.status==="draft"&&new Date(o.date||o.createdAt||Date.now()).toDateString()===x);if(S){ee(S.id),O(S.notes||"");const o=S.selected_procedures.filter(d=>!S.teeth.some(A=>A.procedures.includes(d.id)));D(o.map(d=>({instanceId:crypto.randomUUID(),procedureId:d.id,name:d.name,price:d.cost,type:d.type})));const P={},T=[];S.teeth.forEach(d=>{const A=d.procedures.map(X=>{const de=S.selected_procedures.find(ve=>ve.id===X)||$.find(ve=>ve.id===X);return{instanceId:crypto.randomUUID(),procedureId:X,name:de?de.name:X,price:de?de.cost:0,type:de?de.type:"general"}});A.length>0&&(P[d.toothNumber]=A,T.push(d.toothNumber))}),j(P),C(T)}else ee(null),O(""),D([]),j({}),C([])}}catch(a){console.error("Error fetching history",a)}})()},[c,$]);const ie=n.useMemo(()=>Fe(async s=>{if(!s.trim()||s.length<2){l([]),m(!1);return}m(!0);try{const a=await R(`/api/patients?search=${encodeURIComponent(s)}&limit=10`);if(a.ok){const r=await a.json();l(r.patients||[])}}catch(a){console.error("Search error:",a)}finally{m(!1)}},300),[]);n.useEffect(()=>{ie(h)},[h,ie]);const re=s=>{const a=s.target.value;L(a),i(De.test(a)),N(Qe.test(a)&&!De.test(a))},H=async s=>{if(!(!h||s==="phone"&&!y||s==="name"&&!u)){m(!0);try{const r=await R("/api/patients",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s==="name"?h:"direct dental",phone:s==="phone"?h:null,age:null,gender:null,token:null})});if(r.ok){const x=await r.json();oe({id:x.id,name:x.name,token:x.token??null,age:x.age??null,gender:x.gender??null,phone:x.phone})}else alert("Failed to create patient")}catch(a){console.error("Error creating patient:",a),alert("Error creating patient")}finally{m(!1)}}},oe=s=>{g(s),L(""),l([])},me=()=>{g(null),C([]),D([]),j({}),O("")},je=async s=>{if(!c)return;const a=await R(`/api/patients/${c.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(a.ok)await a.json(),g(r=>r?{...r,...s}:null);else throw new Error("Failed to update")},[J,ce]=n.useState(null),p=s=>{ce(s)},v=s=>{if(!J)return;const a={instanceId:crypto.randomUUID(),procedureId:s.id,name:s.name,price:s.cost,type:s.type};j(r=>{const x=r[J]||[];return{...r,[J]:[...x,a]}}),C(r=>r.includes(J)?r:[...r,J]),ce(null)},z=()=>{const s={},a={},r=(o,P)=>{s[o]||(s[o]=[]);const T=`condition-${P}`;s[o].includes(T)||s[o].push(T)},x=(o,P)=>{a[o]||(a[o]=[]),a[o].push(P)};return[...U].sort((o,P)=>new Date(o.date).getTime()-new Date(P.date).getTime()).forEach(o=>{o.teeth&&Array.isArray(o.teeth)&&o.teeth.forEach(P=>{P.procedures.forEach(T=>{var A;let d=(A=o.selected_procedures)==null?void 0:A.find(X=>X.id===T);d||(d=$.find(X=>X.id===T)),d&&d.type!=="general"?(r(P.toothNumber,d.type),x(P.toothNumber,{name:d.name,date:new Date(o.date||o.createdAt||0).toLocaleDateString(),recordId:o.id,isPast:!0})):T&&x(P.toothNumber,{name:`Procedure: ${T}`,date:new Date(o.date||o.createdAt||0).toLocaleDateString(),recordId:o.id,isPast:!0})})})}),Object.keys(t).forEach(o=>{const P=parseInt(o),T=t[P];T&&T.length>0&&T.forEach(d=>{d.type!=="general"&&(r(P,d.type),x(P,{name:d.name,date:"Current",isPast:!1}))})}),{conditions:s,details:a}},{conditions:b,details:Q}=n.useMemo(()=>z(),[U,t,$]),_=s=>{const a=U.find(o=>o.id===s);if(!a)return;O(a.notes||"");const r=a.selected_procedures.filter(o=>!a.teeth.some(P=>P.procedures.includes(o.id)));D(r.map(o=>({instanceId:crypto.randomUUID(),procedureId:o.id,name:o.name,price:o.cost,type:o.type})));const x={},S=[];a.teeth.forEach(o=>{const P=o.procedures.map(T=>{const d=a.selected_procedures.find(A=>A.id===T)||$.find(A=>A.id===T);return{instanceId:crypto.randomUUID(),procedureId:T,name:d?d.name:T,price:d?d.cost:0,type:d?d.type:"general"}});P.length>0&&(x[o.toothNumber]=P,S.push(o.toothNumber))}),j(x),C(S),Z("plan")},K=(s,a)=>{a?(j(r=>{const x={...r};return x[a]=(r[a]||[]).filter(S=>S.instanceId!==s),x[a].length===0&&delete x[a],x}),C(r=>r)):D(r=>r.filter(x=>x.instanceId!==s))},q=(s,a,r)=>{r?j(x=>({...x,[r]:(x[r]||[]).map(S=>S.instanceId===s?{...S,price:a}:S)})):D(x=>x.map(S=>S.instanceId===s?{...S,price:a}:S))},ye=()=>{window.print()},Se=async(s=!0)=>{var a;if(c){G(!0);try{const x=[...B,...Object.values(t).flat()].map(d=>({id:d.procedureId,name:d.name,cost:d.price,type:d.type})),o=Object.keys(t).map(Number).map(d=>({toothNumber:d,procedures:(t[d]||[]).map(A=>A.procedureId),notes:W})),P={patientId:c.id,teeth:o,selectedProcedures:x,notes:W};let T;if(le?((a=U.find(A=>A.id===le))==null?void 0:a.status)==="draft"?T=await R(`/api/dental/${le}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(P)}):T=await R("/api/dental",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(P)}):T=await R("/api/dental",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(P)}),T.ok){const d=await T.json();ee(d.id);const A=await R(`/api/dental/patient/${c.id}`);if(A.ok){const X=await A.json();V(X)}s?xe(!0):setTimeout(()=>alert("Notes and procedures saved successfully."),100)}else alert("Failed to save dental record.")}catch(r){console.error(r),alert("Error saving record.")}finally{G(!1)}}};return e.jsxs("div",{className:"dental-page-container printable-section",children:[e.jsxs("header",{className:"dental-header",children:[e.jsxs("div",{className:"dental-title-group",children:[e.jsx(Ne,{className:"dental-title-icon"}),e.jsxs("div",{children:[e.jsx("h1",{className:"dental-title",children:"Dental Procedure"}),e.jsx("p",{className:"dental-subtitle",children:"Create new dental records and bills"})]})]}),c&&e.jsxs("div",{className:"selected-patient-header-group",children:[e.jsxs("div",{className:"header-patient-info",children:[e.jsx("div",{className:"patient-avatar small",children:c.name.charAt(0).toUpperCase()}),e.jsxs("div",{className:"header-patient-text",children:[e.jsxs("div",{className:"header-patient-name-row",children:[e.jsx("span",{className:"header-patient-name",children:c.name}),e.jsx("button",{onClick:()=>k(!0),className:"icon-button-sm text-gray-500 hover:text-blue-600",title:"Edit Patient",children:e.jsx(Ce,{size:12})})]}),e.jsxs("span",{className:"header-patient-meta",children:[c.gender," / ",c.age,"y • ",c.phone]})]}),e.jsx("button",{onClick:me,className:"header-close-patient-btn",title:"Change Patient",children:e.jsx(te,{size:16})})]}),e.jsxs("div",{className:"header-search-wrapper",children:[e.jsxs("div",{className:"search-input-wrapper header-variant",children:[e.jsx(be,{className:"search-icon-overlay",size:16}),e.jsx("input",{type:"text",placeholder:"Search patient...",className:"dental-search-input header-input",value:h,onChange:re}),E&&e.jsx("div",{className:"search-spinner small"})]}),f.length>0&&e.jsx("div",{className:"search-results-dropdown header-dropdown",children:f.map(s=>e.jsxs("div",{onClick:()=>oe(s),className:"search-result-item",children:[e.jsxs("div",{children:[e.jsx("span",{className:"patient-name-highlight",children:s.name}),e.jsxs("div",{className:"patient-meta",children:[s.age," yrs / ",s.gender," • ",s.phone]})]}),e.jsx(ge,{size:16,color:"var(--dp-text-sec)"})]},s.id))}),h.length>=2&&!E&&f.length===0&&e.jsxs("div",{className:"search-results-dropdown header-dropdown",style:{padding:"12px",textAlign:"center"},children:[e.jsxs("p",{style:{fontSize:"0.8rem",color:"var(--dp-text-sec)",marginBottom:"8px"},children:['No match for "',h,'"']}),e.jsx("div",{style:{display:"flex",justifyContent:"center",gap:"8px"},children:(y||u)&&e.jsx("button",{type:"button",onClick:()=>H(y?"phone":"name"),className:"register-new-btn-sm",children:"Create"})})]})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx("button",{onClick:()=>I(-1),className:"dental-back-btn no-print",children:"Back"})})]}),!c&&e.jsxs("div",{className:"patient-search-container",children:[!c&&e.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:700,marginBottom:"24px",color:"var(--dp-text)"},children:"Who is this for?"}),e.jsxs("div",{className:"search-input-wrapper",children:[e.jsx(be,{className:"search-icon-overlay",size:20}),e.jsx("input",{type:"text",placeholder:"Search by name or phone...",className:"dental-search-input",value:h,onChange:re,autoFocus:!0}),E&&e.jsx("div",{className:"search-spinner"})]}),f.length>0&&e.jsx("div",{className:"search-results-dropdown",children:f.map(s=>e.jsxs("div",{onClick:()=>oe(s),className:"search-result-item",children:[e.jsxs("div",{children:[e.jsx("span",{className:"patient-name-highlight",children:s.name}),e.jsxs("div",{className:"patient-meta",children:[s.age," yrs / ",s.gender," • ",s.phone]})]}),e.jsx(ge,{size:18,color:"var(--dp-text-sec)"})]},s.id))}),h.length>=2&&!E&&f.length===0&&e.jsxs("div",{style:{textAlign:"center",marginTop:"20px"},children:[e.jsxs("p",{style:{color:"var(--dp-text-sec)",marginBottom:"15px"},children:['No patients found matching "',h,'".']}),e.jsx("div",{style:{display:"flex",justifyContent:"center",gap:"15px"},children:(y||u)&&e.jsxs("button",{type:"button",onClick:()=>H(y?"phone":"name"),className:"register-new-btn",style:{backgroundColor:"var(--dp-card-bg)",border:"1px solid var(--dp-primary)",padding:"8px 16px",borderRadius:"8px"},children:['Create "',h,'"']})})]}),!c&&e.jsx("div",{style:{marginTop:"32px"},children:e.jsx("button",{onClick:()=>pe(!0),className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:"Manage Procedures"})})]}),c&&e.jsx("div",{className:"dental-workspace",children:e.jsxs("div",{className:"dental-grid",children:[e.jsxs("div",{className:"chart-section",children:[e.jsx("div",{className:"dental-card chart-card-scroll",children:e.jsx(_e,{selectedTeeth:w,toothConditions:b,toothDetails:Q,onToothClick:p,onEditPastRecord:_,onPrint:ye})}),e.jsxs("div",{className:"dental-card notes-container",children:[e.jsxs("div",{className:"notes-header",children:[e.jsx("h4",{className:"section-title-sm",children:"Clinical Notes"}),e.jsxs("button",{className:"notes-save-btn",onClick:()=>Se(!1),disabled:Y,title:"Save notes and procedures without billing",children:[e.jsx(we,{size:12})," Save"]})]}),e.jsx("textarea",{className:"notes-area",placeholder:"Enter clinical findings...",value:W,onChange:s=>O(s.target.value)})]})]}),e.jsx("div",{className:"dental-card procedures-section",children:e.jsxs("div",{className:"treatment-plan-container",style:{borderTop:"none"},children:[e.jsxs("div",{className:"sidebar-tabs",children:[e.jsx("button",{onClick:()=>Z("plan"),className:ne==="plan"?"active":"",children:"Treatment Plan"}),e.jsx("button",{onClick:()=>Z("history"),className:ne==="history"?"active":"",children:"Visit History"})]}),e.jsx("div",{className:"treatment-plan-list custom-scrollbar",children:ne==="plan"?e.jsx(e.Fragment,{children:B.length===0&&Object.keys(t).length===0?e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"var(--dp-text-sec)",fontSize:"0.85rem"},children:"Select a tooth to add procedures."}):e.jsxs(e.Fragment,{children:[B.length>0&&e.jsxs("div",{className:"plan-group",children:[e.jsx("h4",{children:"General"}),B.map(s=>e.jsxs("div",{className:"plan-item",children:[e.jsx("span",{className:"plan-item-name",title:s.name,children:s.name}),e.jsxs("div",{style:{display:"flex",gap:"6px",alignItems:"center"},children:[e.jsx("input",{type:"number",value:s.price,onChange:a=>q(s.instanceId,parseFloat(a.target.value)||0),className:"cost-input"}),e.jsx("button",{onClick:()=>K(s.instanceId),style:{background:"none",border:"none",color:"var(--dp-danger)",cursor:"pointer",padding:0},children:e.jsx(te,{size:14})})]})]},s.instanceId))]}),Object.entries(t).map(([s,a])=>a.length===0?null:e.jsxs("div",{className:"plan-group",children:[e.jsxs("h4",{children:["Tooth ",s]}),a.map(r=>e.jsxs("div",{className:"plan-item",children:[e.jsx("span",{className:"plan-item-name",title:r.name,children:r.name}),e.jsxs("div",{style:{display:"flex",gap:"6px",alignItems:"center"},children:[e.jsx("input",{type:"number",value:r.price,onChange:x=>q(r.instanceId,parseFloat(x.target.value)||0,parseInt(s)),className:"cost-input"}),e.jsx("button",{onClick:()=>K(r.instanceId,parseInt(s)),style:{background:"none",border:"none",color:"var(--dp-danger)",cursor:"pointer",padding:0},children:e.jsx(te,{size:14})})]})]},r.instanceId))]},s))]})}):e.jsx("div",{className:"history-list",children:U.length===0?e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"var(--dp-text-sec)",fontSize:"0.85rem"},children:"No past visits found."}):U.map(s=>e.jsxs("div",{className:"history-record-card",children:[e.jsxs("div",{className:"history-record-header",children:[e.jsx("span",{className:"record-date",children:new Date(s.date).toLocaleDateString()}),e.jsx("span",{className:"record-status",children:s.status})]}),e.jsxs("div",{className:"history-record-body",children:[s.teeth.map(a=>e.jsxs("div",{className:"history-tooth-group",children:[e.jsxs("strong",{children:["Tooth ",a.toothNumber,":"]})," ",a.procedures.map(r=>{const x=s.selected_procedures.find(S=>S.id===r)||$.find(S=>S.id===r);return x?x.name:r}).join(", ")]},a.toothNumber)),s.notes&&e.jsx("p",{className:"history-notes",children:e.jsxs("em",{children:["Notes: ",s.notes]})}),s.status==="billed"&&e.jsx("div",{className:"history-record-actions mt-3",children:e.jsxs("button",{onClick:()=>{ee(s.id),xe(!0)},className:"view-bill-btn",children:[e.jsx(Ne,{size:14})," View Bill"]})})]})]},s.id))})}),e.jsx("div",{className:"action-footer",children:e.jsx("button",{onClick:()=>Se(!0),className:"save-btn",disabled:Y||B.length===0&&Object.keys(t).length===0,children:Y?"Saving...":"Save & Bill"})})]})})]})}),M&&c&&e.jsx(Be,{patient:c,onClose:()=>k(!1),onSave:je}),he&&e.jsx(Oe,{onClose:()=>pe(!1),onUpdate:ue}),J!==null&&e.jsx(Ue,{toothNumber:J,procedures:$.map(s=>({id:s.id,name:s.name,cost:s.cost,type:s.type})),history:Q[J]||[],onSelect:v,onClose:()=>ce(null)}),e.jsx($e,{isOpen:fe,recordId:le,onClose:()=>{xe(!1),me()},onBillingComplete:()=>{}})]})};export{Ye as default};
