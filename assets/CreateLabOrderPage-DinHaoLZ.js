import{d as me,f as h,p as pe,t as ue,j as e,S as b,q as W}from"./index-DCOSVs-d.js";import{u as ge,r}from"./react-vendor-Cc0P4_ZX.js";import{W as xe,i as U,E as M,a7 as ee,a8 as be,a9 as je,e as fe,aa as Ne,t as ye}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const Le=({currentUser:F})=>{const $=ge(),E=me(),[f,J]=r.useState("select_patient"),[l,ae]=r.useState({name:"",age:void 0,gender:null,phone:"",address:""}),[i,K]=r.useState(null),[v,Q]=r.useState([]),[m,O]=r.useState([]),[g,w]=r.useState(""),[q,N]=r.useState([]),[c,G]=r.useState(""),[z,S]=r.useState([]),[C,j]=r.useState(!1),[A,x]=r.useState(null),[Y,D]=r.useState(null),[Z,p]=r.useState(null),[P,H]=r.useState(!1),[_,te]=r.useState(!1),[I,se]=r.useState(!1),B=/^\+?[0-9\s\-().]{7,20}$/,V=/^[a-zA-Z\s'-]{2,}$/,T=r.useCallback(async()=>{if(!(v.length>0)){H(!0),p(null);try{const a=await h("/api/lab-tests");if(!a.ok)throw new Error("Failed to fetch lab tests");const t=await a.json();Q(t)}catch(a){console.error("Failed to fetch available lab tests:",a),p("Could not load lab test list: "+a.message),Q([])}finally{H(!1)}}},[v.length]),ne=a=>{a&&(E.prefetchQuery({queryKey:W.patients.context(a),queryFn:async()=>{const t=await h(`/api/patients/${a}/context`);if(!t.ok)throw new Error("Failed to fetch patient context");return t.json()},staleTime:1e3*60*5}),E.prefetchQuery({queryKey:W.patientDebts.balance(a),queryFn:async()=>{const t=await h(`/api/patient-debts/${a}/balance`);if(!t.ok)throw new Error("Failed to fetch patient debt");return t.json()},staleTime:1e3*60}),E.prefetchQuery({queryKey:W.queue.latest(a),queryFn:async()=>{const t=await h(`/api/queue/patient/${a}/latest`);if(!t.ok){if(t.status===404)return null;throw new Error("Failed to fetch queue status")}return t.json()},staleTime:1e3*5}))},X=r.useMemo(()=>new pe(v,{keys:["name","description"],threshold:.3,ignoreLocation:!0}),[v]);r.useEffect(()=>{if(!g){N([]);return}const a=X.search(g).map(t=>t.item);N(a.slice(0,10))},[g,X]);const L=r.useCallback(a=>{const t={id:a.id,name:a.name,token:a.token,age:a.age,gender:a.gender,phone:a.phone};K(t),J("create_order"),O([]),w(""),N([]),p(null),T()},[T]),re=r.useMemo(()=>ue(async a=>{if(a.trim().length<2){S([]),j(!1),x(null);return}j(!0),x(null);try{const t=new URLSearchParams({search:encodeURIComponent(a),page:"1",limit:"10",sortBy:"name",sortOrder:"asc"}),s=await h(`/api/patients?${t.toString()}`);if(!s.ok){const o=await s.text();throw new Error(`API Error (${s.status}): ${o||s.statusText}`)}const n=await s.json();S(n.patients)}catch(t){console.error("Error searching lab patients:",t),x(t.message||"Failed to search lab patients."),S([])}finally{j(!1)}},300),[B,V]),ie=a=>{const t=a.target.value;G(t),te(B.test(t)),se(V.test(t)&&!B.test(t)),j(!0),re(t)},R=r.useCallback(async a=>{if(!c||a==="phone"&&!_||a==="name"&&!I){x(`Invalid ${a} to create a new patient.`);return}j(!0),x(null);try{const s=await h("/api/patients",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a==="name"?c:"direct lab",phone:a==="phone"?c:null,age:null,gender:null,token:null})});if(!s.ok){const o=await s.json();throw new Error(o.message||`Failed to create patient: ${s.statusText}`)}const n=await s.json();alert(`New patient "${n.name}" created with ${a==="phone"?`phone ${n.phone}`:`name ${n.name}`}.`),L({id:n.id,name:n.name,token:n.token??null,age:n.age??null,gender:n.gender??null,phone:n.phone})}catch(t){console.error("Error creating new patient:",t),x(t.message||"Failed to create new patient.")}finally{j(!1)}},[c,_,I,L]),k=()=>{J("select_patient"),K(null),G(""),S([]),x(null)},y=a=>{const{name:t,value:s}=a.target;ae(n=>({...n,[t]:t==="age"?s?parseInt(s,10):void 0:s}))},le=async a=>{if(a.preventDefault(),D(null),!l.name){D("Patient Name is required.");return}const t={name:l.name,age:l.age,gender:l.gender,phone:l.phone,address:l.address};try{const s=await h("/api/patients",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok){const o=await s.json();throw new Error(o.message||`Failed to create patient: ${s.statusText}`)}const n=await s.json();alert(`Patient "${n.name}" created successfully!`),L({id:n.id,name:n.name,token:n.token??null,age:n.age??null,gender:n.gender??null,phone:n.phone})}catch(s){console.error("Failed to create patient:",s),D(s.message||"Failed to create patient. Please try again.")}},oe=a=>{if(m.some(t=>t.id===a.id)){p(`${a.name} is already in the order.`),setTimeout(()=>p(null),3e3),w(""),N([]);return}O(t=>[...t,{...a}]),w(""),N([])},ce=a=>{O(t=>t.filter(s=>s.id!==a))},de=async a=>{if(a.preventDefault(),p(null),!i){p("No patient selected.");return}if(m.length===0){p("No lab tests selected.");return}const t={patient_id:i.id,tests:m.map(s=>({id:s.id,name:s.name,price:s.price}))};console.log("Submitting Lab Order:",t);try{const s=await h("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok){const d=await s.json();throw console.error("API Error Data:",d),new Error(d.message||`Failed to create lab order: ${s.statusText}`)}const n=await s.json();console.log("Lab Order Creation Result:",n);let o=i.queueId;if(!o){const d=await h(`/api/queue/patient/${i.id}/latest`);if(d.ok){const u=await d.json();u!=null&&u._id&&(o=u._id)}}if(!o){const d=await h("/api/queue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:i.id})});if(!d.ok){const he=await d.text();throw new Error(`Failed to create queue entry for redirection: ${he||d.statusText}`)}const u=await d.json();if(u!=null&&u.id)o=u.id;else throw new Error("Failed to get ID from new queue entry for redirection.")}alert(`Lab order created successfully for ${i.name}!`),(F==null?void 0:F.role)==="lab"?$("/dashboard"):$(`/dashboard/edit-complaint/${o}`)}catch(s){console.error("Failed to create lab order:",s),p(s.message||"Failed to create lab order.")}};return r.useEffect(()=>{T()},[T]),e.jsxs("div",{className:"create-lab-order-container",children:[e.jsxs("div",{className:"create-lab-order-header",children:[e.jsx("button",{onClick:()=>$(-1),className:"back-button","aria-label":"Go back",children:e.jsx(xe,{size:20})}),e.jsx("h1",{className:"create-lab-order-title",children:"Create New Lab Order"}),e.jsx("div",{style:{width:"64px"}})," "]}),(f==="select_patient"||f==="create_patient")&&e.jsxs("div",{className:"glass-card",children:[f==="select_patient"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"header-with-action",children:e.jsx("h2",{className:"card-title",style:{borderBottom:"none",marginBottom:0},children:"Select Patient"})}),e.jsxs("div",{className:"search-container",children:[e.jsx(U,{className:"search-icon",size:20}),e.jsx("input",{type:"text",id:"lab-patient-search",placeholder:"Search by Name, Token No, or Phone No...",value:c,onChange:ie,className:"modern-input",autoFocus:!0,autoComplete:"off"}),C&&e.jsx("div",{style:{position:"absolute",right:"15px",top:"50%",transform:"translateY(-50%)"},children:e.jsx(b,{width:80,height:14})})]}),C&&e.jsx("ul",{className:"patient-list",children:[1,2,3].map(a=>e.jsxs("li",{className:"patient-list-item",children:[e.jsxs("div",{className:"patient-info",children:[e.jsx(b,{width:120,height:20}),e.jsx(b,{width:50,height:24,style:{borderRadius:"12px"}})]}),e.jsx("div",{className:"patient-details",children:e.jsx(b,{width:200,height:16})})]},a))}),A&&e.jsxs("div",{className:"error-message",children:[e.jsx(M,{size:18}),A]}),z.length>0&&e.jsx("ul",{className:"patient-list",children:z.map(a=>e.jsxs("li",{onClick:()=>L(a),onMouseEnter:()=>ne(a.id),className:"patient-list-item",children:[e.jsxs("div",{className:"patient-info",children:[e.jsx("strong",{children:a.name}),e.jsxs("span",{className:"token-badge",children:["#",a.token||"N/A"]})]}),e.jsxs("div",{className:"patient-details",children:[a.age?`${a.age} yrs`:"",a.gender?` / ${a.gender}`:"",a.phone?` • ${a.phone}`:""]})]},a.id))}),c.length>=2&&!C&&z.length===0&&!A&&e.jsxs("div",{style:{textAlign:"center",marginTop:"20px"},children:[e.jsxs("p",{className:"no-data-message",style:{background:"none",border:"none",padding:0},children:['No patients found matching "',c,'".']}),e.jsxs("div",{style:{display:"flex",justifyContent:"center",gap:"15px",marginTop:"15px"},children:[_&&e.jsxs("button",{type:"button",onClick:()=>R("phone"),className:"secondary-button",children:['Create "Direct Lab" Patient (Phone: ',c,")"]}),I&&e.jsxs("button",{type:"button",onClick:()=>R("name"),className:"secondary-button",children:["Create Patient (Name: ",c,")"]})]})]}),c.length<2&&!C&&e.jsx("div",{className:"info-message",children:"Start typing to search for a patient..."})]}),f==="create_patient"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"header-with-action",children:[e.jsx("h2",{className:"card-title",style:{borderBottom:"none",marginBottom:0},children:"New Patient Registration"}),e.jsx("button",{onClick:k,className:"text-button",children:" Back to Search "})]}),Y&&e.jsxs("div",{className:"error-message",children:[e.jsx(M,{size:18}),Y]}),e.jsxs("form",{onSubmit:le,children:[e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-group full-width",children:[e.jsx("label",{htmlFor:"lab-patient-name",className:"form-label",children:"Patient Name *"}),e.jsxs("div",{className:"search-container",style:{margin:0},children:[e.jsx(ee,{className:"search-icon",size:18}),e.jsx("input",{type:"text",name:"name",id:"lab-patient-name",required:!0,value:l.name,onChange:y,className:"modern-input",placeholder:"Enter full name"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"lab-patient-age",className:"form-label",children:"Age"}),e.jsx("input",{type:"number",name:"age",id:"lab-patient-age",value:l.age??"",onChange:y,className:"modern-input",style:{paddingLeft:"16px"},placeholder:"e.g. 30"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"lab-patient-gender",className:"form-label",children:"Gender"}),e.jsxs("select",{name:"gender",id:"lab-patient-gender",value:l.gender??"",onChange:y,className:"modern-input",style:{paddingLeft:"16px"},children:[e.jsx("option",{value:"",children:"Select Gender..."}),e.jsx("option",{value:"M",children:"Male"}),e.jsx("option",{value:"F",children:"Female"}),e.jsx("option",{value:"O",children:"Other"})]})]}),e.jsxs("div",{className:"form-group full-width",children:[e.jsx("label",{htmlFor:"lab-patient-phone",className:"form-label",children:"Phone Number"}),e.jsxs("div",{className:"search-container",style:{margin:0},children:[e.jsx(be,{className:"search-icon",size:18}),e.jsx("input",{type:"tel",name:"phone",id:"lab-patient-phone",value:l.phone||"",onChange:y,className:"modern-input",placeholder:"e.g. 9876543210"})]})]}),e.jsxs("div",{className:"form-group full-width",children:[e.jsx("label",{htmlFor:"lab-patient-address",className:"form-label",children:"Address"}),e.jsxs("div",{className:"search-container",style:{margin:0},children:[e.jsx(je,{className:"search-icon",size:18,style:{top:"20px"}}),e.jsx("textarea",{name:"address",id:"lab-patient-address",rows:2,value:l.address||"",onChange:y,className:"modern-input",style:{resize:"none"},placeholder:"Enter address (optional)"})]})]})]}),e.jsxs("div",{className:"flex-end",children:[e.jsx("button",{type:"button",onClick:k,className:"secondary-button",children:" Cancel "}),e.jsxs("button",{type:"submit",className:"primary-button",children:[e.jsx(fe,{size:18}),"Create & Proceed"]})]})]})]})]}),f==="create_order"&&i&&e.jsxs("div",{className:"glass-card",children:[e.jsxs("div",{className:"header-with-action",children:[e.jsx("h2",{className:"card-title",style:{borderBottom:"none",marginBottom:0},children:"Create Lab Order"}),e.jsx("button",{onClick:k,className:"text-button",children:" Change Patient "})]}),e.jsxs("div",{className:"patient-summary",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[e.jsx(ee,{size:20,className:"highlight-primary"}),e.jsx("span",{style:{fontSize:"1.1rem",fontWeight:"600"},children:i.name})]}),e.jsxs("div",{className:"patient-details",style:{marginLeft:"30px",marginTop:"4px"},children:[i.age?`${i.age} yrs`:"Age N/A",i.gender&&` • ${i.gender}`,i.phone&&` • ${i.phone}`]})]}),Z&&e.jsxs("div",{className:"error-message",children:[e.jsx(M,{size:18}),Z]}),e.jsxs("form",{onSubmit:de,children:[e.jsxs("div",{className:"form-group",style:{position:"relative"},children:[e.jsx("label",{htmlFor:"lab-test-search",className:"form-label",children:"Add Lab Test"}),e.jsxs("div",{className:"search-container",style:{margin:0},children:[P?e.jsx("div",{style:{position:"absolute",right:"45px",top:"50%",transform:"translateY(-50%)"},children:e.jsx(b,{width:24,height:24,variant:"circular"})}):e.jsx(U,{className:"search-icon",size:18}),e.jsx("input",{type:"text",id:"lab-test-search",placeholder:"Search tests (e.g. CBC, Lipid Profile)...",value:g,onChange:a=>w(a.target.value),className:"modern-input",disabled:P,autoComplete:"off"})]}),P&&g&&e.jsx("div",{className:"search-results-dropdown",children:[1,2,3].map(a=>e.jsxs("div",{className:"search-result-item",children:[e.jsx(b,{width:"60%",height:20}),e.jsx(b,{width:"20%",height:20})]},a))}),g&&q.length>0&&e.jsx("div",{className:"search-results-dropdown",children:q.map(a=>e.jsxs("div",{onClick:()=>oe(a),className:"search-result-item",children:[e.jsx("span",{style:{fontWeight:500},children:a.name}),e.jsxs("span",{className:"highlight-primary",style:{fontWeight:600},children:["₹",parseFloat(a.price).toFixed(2)]})]},a.id))}),g&&q.length===0&&!P&&e.jsxs("div",{className:"no-data-message",style:{marginTop:"5px",padding:"10px",fontSize:"0.9rem"},children:['No tests found matching "',g,'".']})]}),e.jsxs("div",{style:{marginTop:"30px"},children:[e.jsxs("h4",{className:"card-title",style:{fontSize:"1.1rem"},children:["Selected Tests (",m.length,")"]}),m.length===0?e.jsx("div",{className:"info-message",children:"No tests added yet. Search above to add tests."}):e.jsx("div",{className:"selected-tests-list",children:m.map(a=>e.jsxs("div",{className:"selected-test-item",children:[e.jsx("div",{style:{flex:1},children:e.jsx("div",{style:{fontWeight:500},children:a.name})}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"20px"},children:[e.jsxs("span",{className:"highlight-primary",style:{fontWeight:600},children:["₹",parseFloat(a.price).toFixed(2)]}),e.jsx("button",{type:"button",onClick:()=>ce(a.id),className:"remove-button",title:"Remove Test",children:e.jsx(Ne,{size:18})})]})]},a.id))})]}),m.length>0&&e.jsxs("div",{className:"total-price",children:["Total: ₹",m.reduce((a,t)=>a+parseFloat(t.price),0).toFixed(2)]}),e.jsxs("div",{className:"flex-end",children:[e.jsx("button",{type:"button",onClick:k,className:"secondary-button",children:" Cancel Order "}),e.jsxs("button",{type:"submit",disabled:m.length===0,className:"primary-button",children:[e.jsx(ye,{size:18}),"Create Lab Order"]})]})]})]})]})};export{Le as default};
