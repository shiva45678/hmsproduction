import{c as sc,g as oc,R as Si,r as x,j as i,S as Te,P as ft,d as Ln,T as gt,e as Ys,a as Ks,F as Zs,X as fn,f as Y,G as lc,h as cc,i as It,C as Xs,k as wr,l as fr,m as eo,H as to,Q as no,n as ro,M as Qt,o as kt,p as io,q as mt,s as uc,t as dc,u as pc,v as hc,w as mc,x as oi,D as as,y as ss,E as fc,z as os,B as ls,L as gc,A as yc,I as xc,J as bc,K as wc,N as kc,O as _c,V as Nc,W as vc,Y as jc,Z as Cc,_ as Sc}from"./index-D0NUtA-q.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tc=[["path",{d:"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z",key:"3c2336"}],["path",{d:"M8 8h8",key:"1bis0t"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"m13 17-5-1h1a4 4 0 0 0 0-8",key:"nu2bwa"}]],ao=sc("badge-indian-rupee",Tc),Pc={};function Bi(e,n){const t=Pc,r=typeof t.includeImageAlt=="boolean"?t.includeImageAlt:!0,s=typeof t.includeHtml=="boolean"?t.includeHtml:!0;return so(e,r,s)}function so(e,n,t){if(Ec(e)){if("value"in e)return e.type==="html"&&!t?"":e.value;if(n&&"alt"in e&&e.alt)return e.alt;if("children"in e)return cs(e.children,n,t)}return Array.isArray(e)?cs(e,n,t):""}function cs(e,n,t){const r=[];let s=-1;for(;++s<e.length;)r[s]=so(e[s],n,t);return r.join("")}function Ec(e){return!!(e&&typeof e=="object")}const us=document.createElement("i");function Ui(e){const n="&"+e+";";us.innerHTML=n;const t=us.textContent;return t.charCodeAt(t.length-1)===59&&e!=="semi"||t===n?!1:t}function vt(e,n,t,r){const s=e.length;let a=0,o;if(n<0?n=-n>s?0:s+n:n=n>s?s:n,t=t>0?t:0,r.length<1e4)o=Array.from(r),o.unshift(n,t),e.splice(...o);else for(t&&e.splice(n,t);a<r.length;)o=r.slice(a,a+1e4),o.unshift(n,0),e.splice(...o),a+=1e4,n+=1e4}function dt(e,n){return e.length>0?(vt(e,e.length,0,n),e):n}const ds={}.hasOwnProperty;function Ac(e){const n={};let t=-1;for(;++t<e.length;)Dc(n,e[t]);return n}function Dc(e,n){let t;for(t in n){const s=(ds.call(e,t)?e[t]:void 0)||(e[t]={}),a=n[t];let o;if(a)for(o in a){ds.call(s,o)||(s[o]=[]);const l=a[o];Ic(s[o],Array.isArray(l)?l:l?[l]:[])}}}function Ic(e,n){let t=-1;const r=[];for(;++t<n.length;)(n[t].add==="after"?e:r).push(n[t]);vt(e,0,0,r)}function oo(e,n){const t=Number.parseInt(e,n);return t<9||t===11||t>13&&t<32||t>126&&t<160||t>55295&&t<57344||t>64975&&t<65008||(t&65535)===65535||(t&65535)===65534||t>1114111?"�":String.fromCodePoint(t)}function pn(e){return e.replace(/[\t\n\r ]+/g," ").replace(/^ | $/g,"").toLowerCase().toUpperCase()}const Nt=Ut(/[A-Za-z]/),it=Ut(/[\dA-Za-z]/),Oc=Ut(/[#-'*+\--9=?A-Z^-~]/);function Ti(e){return e!==null&&(e<32||e===127)}const Pi=Ut(/\d/),$c=Ut(/[\dA-Fa-f]/),Lc=Ut(/[!-/:-@[-`{-~]/);function ye(e){return e!==null&&e<-2}function Ke(e){return e!==null&&(e<0||e===32)}function Pe(e){return e===-2||e===-1||e===32}const Rc=Ut(new RegExp("\\p{P}|\\p{S}","u")),Fc=Ut(/\s/);function Ut(e){return n;function n(t){return t!==null&&t>-1&&e.test(String.fromCharCode(t))}}function gn(e){const n=[];let t=-1,r=0,s=0;for(;++t<e.length;){const a=e.charCodeAt(t);let o="";if(a===37&&it(e.charCodeAt(t+1))&&it(e.charCodeAt(t+2)))s=2;else if(a<128)/[!#$&-;=?-Z_a-z~]/.test(String.fromCharCode(a))||(o=String.fromCharCode(a));else if(a>55295&&a<57344){const l=e.charCodeAt(t+1);a<56320&&l>56319&&l<57344?(o=String.fromCharCode(a,l),s=1):o="�"}else o=String.fromCharCode(a);o&&(n.push(e.slice(r,t),encodeURIComponent(o)),r=t+s+1,o=""),s&&(t+=s,s=0)}return n.join("")+e.slice(r)}function Oe(e,n,t,r){const s=r?r-1:Number.POSITIVE_INFINITY;let a=0;return o;function o(c){return Pe(c)?(e.enter(t),l(c)):n(c)}function l(c){return Pe(c)&&a++<s?(e.consume(c),l):(e.exit(t),n(c))}}const zc={tokenize:qc};function qc(e){const n=e.attempt(this.parser.constructs.contentInitial,r,s);let t;return n;function r(l){if(l===null){e.consume(l);return}return e.enter("lineEnding"),e.consume(l),e.exit("lineEnding"),Oe(e,n,"linePrefix")}function s(l){return e.enter("paragraph"),a(l)}function a(l){const c=e.enter("chunkText",{contentType:"text",previous:t});return t&&(t.next=c),t=c,o(l)}function o(l){if(l===null){e.exit("chunkText"),e.exit("paragraph"),e.consume(l);return}return ye(l)?(e.consume(l),e.exit("chunkText"),a):(e.consume(l),o)}}const Bc={tokenize:Uc},ps={tokenize:Mc};function Uc(e){const n=this,t=[];let r=0,s,a,o;return l;function l(I){if(r<t.length){const W=t[r];return n.containerState=W[1],e.attempt(W[0].continuation,c,u)(I)}return u(I)}function c(I){if(r++,n.containerState._closeFlow){n.containerState._closeFlow=void 0,s&&B();const W=n.events.length;let F=W,j;for(;F--;)if(n.events[F][0]==="exit"&&n.events[F][1].type==="chunkFlow"){j=n.events[F][1].end;break}$(r);let X=W;for(;X<n.events.length;)n.events[X][1].end={...j},X++;return vt(n.events,F+1,0,n.events.slice(W)),n.events.length=X,u(I)}return l(I)}function u(I){if(r===t.length){if(!s)return y(I);if(s.currentConstruct&&s.currentConstruct.concrete)return E(I);n.interrupt=!!(s.currentConstruct&&!s._gfmTableDynamicInterruptHack)}return n.containerState={},e.check(ps,m,d)(I)}function m(I){return s&&B(),$(r),y(I)}function d(I){return n.parser.lazy[n.now().line]=r!==t.length,o=n.now().offset,E(I)}function y(I){return n.containerState={},e.attempt(ps,p,E)(I)}function p(I){return r++,t.push([n.currentConstruct,n.containerState]),y(I)}function E(I){if(I===null){s&&B(),$(0),e.consume(I);return}return s=s||n.parser.flow(n.now()),e.enter("chunkFlow",{_tokenizer:s,contentType:"flow",previous:a}),q(I)}function q(I){if(I===null){G(e.exit("chunkFlow"),!0),$(0),e.consume(I);return}return ye(I)?(e.consume(I),G(e.exit("chunkFlow")),r=0,n.interrupt=void 0,l):(e.consume(I),q)}function G(I,W){const F=n.sliceStream(I);if(W&&F.push(null),I.previous=a,a&&(a.next=I),a=I,s.defineSkip(I.start),s.write(F),n.parser.lazy[I.start.line]){let j=s.events.length;for(;j--;)if(s.events[j][1].start.offset<o&&(!s.events[j][1].end||s.events[j][1].end.offset>o))return;const X=n.events.length;let ce=X,ne,le;for(;ce--;)if(n.events[ce][0]==="exit"&&n.events[ce][1].type==="chunkFlow"){if(ne){le=n.events[ce][1].end;break}ne=!0}for($(r),j=X;j<n.events.length;)n.events[j][1].end={...le},j++;vt(n.events,ce+1,0,n.events.slice(X)),n.events.length=j}}function $(I){let W=t.length;for(;W-- >I;){const F=t[W];n.containerState=F[1],F[0].exit.call(n,e)}t.length=I}function B(){s.write([null]),a=void 0,s=void 0,n.containerState._closeFlow=void 0}}function Mc(e,n,t){return Oe(e,e.attempt(this.parser.constructs.document,n,t),"linePrefix",this.parser.constructs.disable.null.includes("codeIndented")?void 0:4)}function yr(e){if(e===null||Ke(e)||Fc(e))return 1;if(Rc(e))return 2}function Mi(e,n,t){const r=[];let s=-1;for(;++s<e.length;){const a=e[s].resolveAll;a&&!r.includes(a)&&(n=a(n,t),r.push(a))}return n}const Ei={name:"attention",resolveAll:Hc,tokenize:Wc};function Hc(e,n){let t=-1,r,s,a,o,l,c,u,m;for(;++t<e.length;)if(e[t][0]==="enter"&&e[t][1].type==="attentionSequence"&&e[t][1]._close){for(r=t;r--;)if(e[r][0]==="exit"&&e[r][1].type==="attentionSequence"&&e[r][1]._open&&n.sliceSerialize(e[r][1]).charCodeAt(0)===n.sliceSerialize(e[t][1]).charCodeAt(0)){if((e[r][1]._close||e[t][1]._open)&&(e[t][1].end.offset-e[t][1].start.offset)%3&&!((e[r][1].end.offset-e[r][1].start.offset+e[t][1].end.offset-e[t][1].start.offset)%3))continue;c=e[r][1].end.offset-e[r][1].start.offset>1&&e[t][1].end.offset-e[t][1].start.offset>1?2:1;const d={...e[r][1].end},y={...e[t][1].start};hs(d,-c),hs(y,c),o={type:c>1?"strongSequence":"emphasisSequence",start:d,end:{...e[r][1].end}},l={type:c>1?"strongSequence":"emphasisSequence",start:{...e[t][1].start},end:y},a={type:c>1?"strongText":"emphasisText",start:{...e[r][1].end},end:{...e[t][1].start}},s={type:c>1?"strong":"emphasis",start:{...o.start},end:{...l.end}},e[r][1].end={...o.start},e[t][1].start={...l.end},u=[],e[r][1].end.offset-e[r][1].start.offset&&(u=dt(u,[["enter",e[r][1],n],["exit",e[r][1],n]])),u=dt(u,[["enter",s,n],["enter",o,n],["exit",o,n],["enter",a,n]]),u=dt(u,Mi(n.parser.constructs.insideSpan.null,e.slice(r+1,t),n)),u=dt(u,[["exit",a,n],["enter",l,n],["exit",l,n],["exit",s,n]]),e[t][1].end.offset-e[t][1].start.offset?(m=2,u=dt(u,[["enter",e[t][1],n],["exit",e[t][1],n]])):m=0,vt(e,r-1,t-r+3,u),t=r+u.length-m-2;break}}for(t=-1;++t<e.length;)e[t][1].type==="attentionSequence"&&(e[t][1].type="data");return e}function Wc(e,n){const t=this.parser.constructs.attentionMarkers.null,r=this.previous,s=yr(r);let a;return o;function o(c){return a=c,e.enter("attentionSequence"),l(c)}function l(c){if(c===a)return e.consume(c),l;const u=e.exit("attentionSequence"),m=yr(c),d=!m||m===2&&s||t.includes(c),y=!s||s===2&&m||t.includes(r);return u._open=!!(a===42?d:d&&(s||!y)),u._close=!!(a===42?y:y&&(m||!d)),n(c)}}function hs(e,n){e.column+=n,e.offset+=n,e._bufferIndex+=n}const Vc={name:"autolink",tokenize:Jc};function Jc(e,n,t){let r=0;return s;function s(p){return e.enter("autolink"),e.enter("autolinkMarker"),e.consume(p),e.exit("autolinkMarker"),e.enter("autolinkProtocol"),a}function a(p){return Nt(p)?(e.consume(p),o):p===64?t(p):u(p)}function o(p){return p===43||p===45||p===46||it(p)?(r=1,l(p)):u(p)}function l(p){return p===58?(e.consume(p),r=0,c):(p===43||p===45||p===46||it(p))&&r++<32?(e.consume(p),l):(r=0,u(p))}function c(p){return p===62?(e.exit("autolinkProtocol"),e.enter("autolinkMarker"),e.consume(p),e.exit("autolinkMarker"),e.exit("autolink"),n):p===null||p===32||p===60||Ti(p)?t(p):(e.consume(p),c)}function u(p){return p===64?(e.consume(p),m):Oc(p)?(e.consume(p),u):t(p)}function m(p){return it(p)?d(p):t(p)}function d(p){return p===46?(e.consume(p),r=0,m):p===62?(e.exit("autolinkProtocol").type="autolinkEmail",e.enter("autolinkMarker"),e.consume(p),e.exit("autolinkMarker"),e.exit("autolink"),n):y(p)}function y(p){if((p===45||it(p))&&r++<63){const E=p===45?y:d;return e.consume(p),E}return t(p)}}const kr={partial:!0,tokenize:Qc};function Qc(e,n,t){return r;function r(a){return Pe(a)?Oe(e,s,"linePrefix")(a):s(a)}function s(a){return a===null||ye(a)?n(a):t(a)}}const lo={continuation:{tokenize:Yc},exit:Kc,name:"blockQuote",tokenize:Gc};function Gc(e,n,t){const r=this;return s;function s(o){if(o===62){const l=r.containerState;return l.open||(e.enter("blockQuote",{_container:!0}),l.open=!0),e.enter("blockQuotePrefix"),e.enter("blockQuoteMarker"),e.consume(o),e.exit("blockQuoteMarker"),a}return t(o)}function a(o){return Pe(o)?(e.enter("blockQuotePrefixWhitespace"),e.consume(o),e.exit("blockQuotePrefixWhitespace"),e.exit("blockQuotePrefix"),n):(e.exit("blockQuotePrefix"),n(o))}}function Yc(e,n,t){const r=this;return s;function s(o){return Pe(o)?Oe(e,a,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(o):a(o)}function a(o){return e.attempt(lo,n,t)(o)}}function Kc(e){e.exit("blockQuote")}const co={name:"characterEscape",tokenize:Zc};function Zc(e,n,t){return r;function r(a){return e.enter("characterEscape"),e.enter("escapeMarker"),e.consume(a),e.exit("escapeMarker"),s}function s(a){return Lc(a)?(e.enter("characterEscapeValue"),e.consume(a),e.exit("characterEscapeValue"),e.exit("characterEscape"),n):t(a)}}const uo={name:"characterReference",tokenize:Xc};function Xc(e,n,t){const r=this;let s=0,a,o;return l;function l(d){return e.enter("characterReference"),e.enter("characterReferenceMarker"),e.consume(d),e.exit("characterReferenceMarker"),c}function c(d){return d===35?(e.enter("characterReferenceMarkerNumeric"),e.consume(d),e.exit("characterReferenceMarkerNumeric"),u):(e.enter("characterReferenceValue"),a=31,o=it,m(d))}function u(d){return d===88||d===120?(e.enter("characterReferenceMarkerHexadecimal"),e.consume(d),e.exit("characterReferenceMarkerHexadecimal"),e.enter("characterReferenceValue"),a=6,o=$c,m):(e.enter("characterReferenceValue"),a=7,o=Pi,m(d))}function m(d){if(d===59&&s){const y=e.exit("characterReferenceValue");return o===it&&!Ui(r.sliceSerialize(y))?t(d):(e.enter("characterReferenceMarker"),e.consume(d),e.exit("characterReferenceMarker"),e.exit("characterReference"),n)}return o(d)&&s++<a?(e.consume(d),m):t(d)}}const ms={partial:!0,tokenize:tu},fs={concrete:!0,name:"codeFenced",tokenize:eu};function eu(e,n,t){const r=this,s={partial:!0,tokenize:F};let a=0,o=0,l;return c;function c(j){return u(j)}function u(j){const X=r.events[r.events.length-1];return a=X&&X[1].type==="linePrefix"?X[2].sliceSerialize(X[1],!0).length:0,l=j,e.enter("codeFenced"),e.enter("codeFencedFence"),e.enter("codeFencedFenceSequence"),m(j)}function m(j){return j===l?(o++,e.consume(j),m):o<3?t(j):(e.exit("codeFencedFenceSequence"),Pe(j)?Oe(e,d,"whitespace")(j):d(j))}function d(j){return j===null||ye(j)?(e.exit("codeFencedFence"),r.interrupt?n(j):e.check(ms,q,W)(j)):(e.enter("codeFencedFenceInfo"),e.enter("chunkString",{contentType:"string"}),y(j))}function y(j){return j===null||ye(j)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),d(j)):Pe(j)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),Oe(e,p,"whitespace")(j)):j===96&&j===l?t(j):(e.consume(j),y)}function p(j){return j===null||ye(j)?d(j):(e.enter("codeFencedFenceMeta"),e.enter("chunkString",{contentType:"string"}),E(j))}function E(j){return j===null||ye(j)?(e.exit("chunkString"),e.exit("codeFencedFenceMeta"),d(j)):j===96&&j===l?t(j):(e.consume(j),E)}function q(j){return e.attempt(s,W,G)(j)}function G(j){return e.enter("lineEnding"),e.consume(j),e.exit("lineEnding"),$}function $(j){return a>0&&Pe(j)?Oe(e,B,"linePrefix",a+1)(j):B(j)}function B(j){return j===null||ye(j)?e.check(ms,q,W)(j):(e.enter("codeFlowValue"),I(j))}function I(j){return j===null||ye(j)?(e.exit("codeFlowValue"),B(j)):(e.consume(j),I)}function W(j){return e.exit("codeFenced"),n(j)}function F(j,X,ce){let ne=0;return le;function le(A){return j.enter("lineEnding"),j.consume(A),j.exit("lineEnding"),V}function V(A){return j.enter("codeFencedFence"),Pe(A)?Oe(j,_,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(A):_(A)}function _(A){return A===l?(j.enter("codeFencedFenceSequence"),C(A)):ce(A)}function C(A){return A===l?(ne++,j.consume(A),C):ne>=o?(j.exit("codeFencedFenceSequence"),Pe(A)?Oe(j,K,"whitespace")(A):K(A)):ce(A)}function K(A){return A===null||ye(A)?(j.exit("codeFencedFence"),X(A)):ce(A)}}}function tu(e,n,t){const r=this;return s;function s(o){return o===null?t(o):(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),a)}function a(o){return r.parser.lazy[r.now().line]?t(o):n(o)}}const li={name:"codeIndented",tokenize:ru},nu={partial:!0,tokenize:iu};function ru(e,n,t){const r=this;return s;function s(u){return e.enter("codeIndented"),Oe(e,a,"linePrefix",5)(u)}function a(u){const m=r.events[r.events.length-1];return m&&m[1].type==="linePrefix"&&m[2].sliceSerialize(m[1],!0).length>=4?o(u):t(u)}function o(u){return u===null?c(u):ye(u)?e.attempt(nu,o,c)(u):(e.enter("codeFlowValue"),l(u))}function l(u){return u===null||ye(u)?(e.exit("codeFlowValue"),o(u)):(e.consume(u),l)}function c(u){return e.exit("codeIndented"),n(u)}}function iu(e,n,t){const r=this;return s;function s(o){return r.parser.lazy[r.now().line]?t(o):ye(o)?(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),s):Oe(e,a,"linePrefix",5)(o)}function a(o){const l=r.events[r.events.length-1];return l&&l[1].type==="linePrefix"&&l[2].sliceSerialize(l[1],!0).length>=4?n(o):ye(o)?s(o):t(o)}}const au={name:"codeText",previous:ou,resolve:su,tokenize:lu};function su(e){let n=e.length-4,t=3,r,s;if((e[t][1].type==="lineEnding"||e[t][1].type==="space")&&(e[n][1].type==="lineEnding"||e[n][1].type==="space")){for(r=t;++r<n;)if(e[r][1].type==="codeTextData"){e[t][1].type="codeTextPadding",e[n][1].type="codeTextPadding",t+=2,n-=2;break}}for(r=t-1,n++;++r<=n;)s===void 0?r!==n&&e[r][1].type!=="lineEnding"&&(s=r):(r===n||e[r][1].type==="lineEnding")&&(e[s][1].type="codeTextData",r!==s+2&&(e[s][1].end=e[r-1][1].end,e.splice(s+2,r-s-2),n-=r-s-2,r=s+2),s=void 0);return e}function ou(e){return e!==96||this.events[this.events.length-1][1].type==="characterEscape"}function lu(e,n,t){let r=0,s,a;return o;function o(d){return e.enter("codeText"),e.enter("codeTextSequence"),l(d)}function l(d){return d===96?(e.consume(d),r++,l):(e.exit("codeTextSequence"),c(d))}function c(d){return d===null?t(d):d===32?(e.enter("space"),e.consume(d),e.exit("space"),c):d===96?(a=e.enter("codeTextSequence"),s=0,m(d)):ye(d)?(e.enter("lineEnding"),e.consume(d),e.exit("lineEnding"),c):(e.enter("codeTextData"),u(d))}function u(d){return d===null||d===32||d===96||ye(d)?(e.exit("codeTextData"),c(d)):(e.consume(d),u)}function m(d){return d===96?(e.consume(d),s++,m):s===r?(e.exit("codeTextSequence"),e.exit("codeText"),n(d)):(a.type="codeTextData",u(d))}}class cu{constructor(n){this.left=n?[...n]:[],this.right=[]}get(n){if(n<0||n>=this.left.length+this.right.length)throw new RangeError("Cannot access index `"+n+"` in a splice buffer of size `"+(this.left.length+this.right.length)+"`");return n<this.left.length?this.left[n]:this.right[this.right.length-n+this.left.length-1]}get length(){return this.left.length+this.right.length}shift(){return this.setCursor(0),this.right.pop()}slice(n,t){const r=t??Number.POSITIVE_INFINITY;return r<this.left.length?this.left.slice(n,r):n>this.left.length?this.right.slice(this.right.length-r+this.left.length,this.right.length-n+this.left.length).reverse():this.left.slice(n).concat(this.right.slice(this.right.length-r+this.left.length).reverse())}splice(n,t,r){const s=t||0;this.setCursor(Math.trunc(n));const a=this.right.splice(this.right.length-s,Number.POSITIVE_INFINITY);return r&&On(this.left,r),a.reverse()}pop(){return this.setCursor(Number.POSITIVE_INFINITY),this.left.pop()}push(n){this.setCursor(Number.POSITIVE_INFINITY),this.left.push(n)}pushMany(n){this.setCursor(Number.POSITIVE_INFINITY),On(this.left,n)}unshift(n){this.setCursor(0),this.right.push(n)}unshiftMany(n){this.setCursor(0),On(this.right,n.reverse())}setCursor(n){if(!(n===this.left.length||n>this.left.length&&this.right.length===0||n<0&&this.left.length===0))if(n<this.left.length){const t=this.left.splice(n,Number.POSITIVE_INFINITY);On(this.right,t.reverse())}else{const t=this.right.splice(this.left.length+this.right.length-n,Number.POSITIVE_INFINITY);On(this.left,t.reverse())}}}function On(e,n){let t=0;if(n.length<1e4)e.push(...n);else for(;t<n.length;)e.push(...n.slice(t,t+1e4)),t+=1e4}function po(e){const n={};let t=-1,r,s,a,o,l,c,u;const m=new cu(e);for(;++t<m.length;){for(;t in n;)t=n[t];if(r=m.get(t),t&&r[1].type==="chunkFlow"&&m.get(t-1)[1].type==="listItemPrefix"&&(c=r[1]._tokenizer.events,a=0,a<c.length&&c[a][1].type==="lineEndingBlank"&&(a+=2),a<c.length&&c[a][1].type==="content"))for(;++a<c.length&&c[a][1].type!=="content";)c[a][1].type==="chunkText"&&(c[a][1]._isInFirstContentOfListItem=!0,a++);if(r[0]==="enter")r[1].contentType&&(Object.assign(n,uu(m,t)),t=n[t],u=!0);else if(r[1]._container){for(a=t,s=void 0;a--;)if(o=m.get(a),o[1].type==="lineEnding"||o[1].type==="lineEndingBlank")o[0]==="enter"&&(s&&(m.get(s)[1].type="lineEndingBlank"),o[1].type="lineEnding",s=a);else if(!(o[1].type==="linePrefix"||o[1].type==="listItemIndent"))break;s&&(r[1].end={...m.get(s)[1].start},l=m.slice(s,t),l.unshift(r),m.splice(s,t-s+1,l))}}return vt(e,0,Number.POSITIVE_INFINITY,m.slice(0)),!u}function uu(e,n){const t=e.get(n)[1],r=e.get(n)[2];let s=n-1;const a=[];let o=t._tokenizer;o||(o=r.parser[t.contentType](t.start),t._contentTypeTextTrailing&&(o._contentTypeTextTrailing=!0));const l=o.events,c=[],u={};let m,d,y=-1,p=t,E=0,q=0;const G=[q];for(;p;){for(;e.get(++s)[1]!==p;);a.push(s),p._tokenizer||(m=r.sliceStream(p),p.next||m.push(null),d&&o.defineSkip(p.start),p._isInFirstContentOfListItem&&(o._gfmTasklistFirstContentOfListItem=!0),o.write(m),p._isInFirstContentOfListItem&&(o._gfmTasklistFirstContentOfListItem=void 0)),d=p,p=p.next}for(p=t;++y<l.length;)l[y][0]==="exit"&&l[y-1][0]==="enter"&&l[y][1].type===l[y-1][1].type&&l[y][1].start.line!==l[y][1].end.line&&(q=y+1,G.push(q),p._tokenizer=void 0,p.previous=void 0,p=p.next);for(o.events=[],p?(p._tokenizer=void 0,p.previous=void 0):G.pop(),y=G.length;y--;){const $=l.slice(G[y],G[y+1]),B=a.pop();c.push([B,B+$.length-1]),e.splice(B,2,$)}for(c.reverse(),y=-1;++y<c.length;)u[E+c[y][0]]=E+c[y][1],E+=c[y][1]-c[y][0]-1;return u}const du={resolve:hu,tokenize:mu},pu={partial:!0,tokenize:fu};function hu(e){return po(e),e}function mu(e,n){let t;return r;function r(l){return e.enter("content"),t=e.enter("chunkContent",{contentType:"content"}),s(l)}function s(l){return l===null?a(l):ye(l)?e.check(pu,o,a)(l):(e.consume(l),s)}function a(l){return e.exit("chunkContent"),e.exit("content"),n(l)}function o(l){return e.consume(l),e.exit("chunkContent"),t.next=e.enter("chunkContent",{contentType:"content",previous:t}),t=t.next,s}}function fu(e,n,t){const r=this;return s;function s(o){return e.exit("chunkContent"),e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),Oe(e,a,"linePrefix")}function a(o){if(o===null||ye(o))return t(o);const l=r.events[r.events.length-1];return!r.parser.constructs.disable.null.includes("codeIndented")&&l&&l[1].type==="linePrefix"&&l[2].sliceSerialize(l[1],!0).length>=4?n(o):e.interrupt(r.parser.constructs.flow,t,n)(o)}}function ho(e,n,t,r,s,a,o,l,c){const u=c||Number.POSITIVE_INFINITY;let m=0;return d;function d($){return $===60?(e.enter(r),e.enter(s),e.enter(a),e.consume($),e.exit(a),y):$===null||$===32||$===41||Ti($)?t($):(e.enter(r),e.enter(o),e.enter(l),e.enter("chunkString",{contentType:"string"}),q($))}function y($){return $===62?(e.enter(a),e.consume($),e.exit(a),e.exit(s),e.exit(r),n):(e.enter(l),e.enter("chunkString",{contentType:"string"}),p($))}function p($){return $===62?(e.exit("chunkString"),e.exit(l),y($)):$===null||$===60||ye($)?t($):(e.consume($),$===92?E:p)}function E($){return $===60||$===62||$===92?(e.consume($),p):p($)}function q($){return!m&&($===null||$===41||Ke($))?(e.exit("chunkString"),e.exit(l),e.exit(o),e.exit(r),n($)):m<u&&$===40?(e.consume($),m++,q):$===41?(e.consume($),m--,q):$===null||$===32||$===40||Ti($)?t($):(e.consume($),$===92?G:q)}function G($){return $===40||$===41||$===92?(e.consume($),q):q($)}}function mo(e,n,t,r,s,a){const o=this;let l=0,c;return u;function u(p){return e.enter(r),e.enter(s),e.consume(p),e.exit(s),e.enter(a),m}function m(p){return l>999||p===null||p===91||p===93&&!c||p===94&&!l&&"_hiddenFootnoteSupport"in o.parser.constructs?t(p):p===93?(e.exit(a),e.enter(s),e.consume(p),e.exit(s),e.exit(r),n):ye(p)?(e.enter("lineEnding"),e.consume(p),e.exit("lineEnding"),m):(e.enter("chunkString",{contentType:"string"}),d(p))}function d(p){return p===null||p===91||p===93||ye(p)||l++>999?(e.exit("chunkString"),m(p)):(e.consume(p),c||(c=!Pe(p)),p===92?y:d)}function y(p){return p===91||p===92||p===93?(e.consume(p),l++,d):d(p)}}function fo(e,n,t,r,s,a){let o;return l;function l(y){return y===34||y===39||y===40?(e.enter(r),e.enter(s),e.consume(y),e.exit(s),o=y===40?41:y,c):t(y)}function c(y){return y===o?(e.enter(s),e.consume(y),e.exit(s),e.exit(r),n):(e.enter(a),u(y))}function u(y){return y===o?(e.exit(a),c(o)):y===null?t(y):ye(y)?(e.enter("lineEnding"),e.consume(y),e.exit("lineEnding"),Oe(e,u,"linePrefix")):(e.enter("chunkString",{contentType:"string"}),m(y))}function m(y){return y===o||y===null||ye(y)?(e.exit("chunkString"),u(y)):(e.consume(y),y===92?d:m)}function d(y){return y===o||y===92?(e.consume(y),m):m(y)}}function Rn(e,n){let t;return r;function r(s){return ye(s)?(e.enter("lineEnding"),e.consume(s),e.exit("lineEnding"),t=!0,r):Pe(s)?Oe(e,r,t?"linePrefix":"lineSuffix")(s):n(s)}}const gu={name:"definition",tokenize:xu},yu={partial:!0,tokenize:bu};function xu(e,n,t){const r=this;let s;return a;function a(p){return e.enter("definition"),o(p)}function o(p){return mo.call(r,e,l,t,"definitionLabel","definitionLabelMarker","definitionLabelString")(p)}function l(p){return s=pn(r.sliceSerialize(r.events[r.events.length-1][1]).slice(1,-1)),p===58?(e.enter("definitionMarker"),e.consume(p),e.exit("definitionMarker"),c):t(p)}function c(p){return Ke(p)?Rn(e,u)(p):u(p)}function u(p){return ho(e,m,t,"definitionDestination","definitionDestinationLiteral","definitionDestinationLiteralMarker","definitionDestinationRaw","definitionDestinationString")(p)}function m(p){return e.attempt(yu,d,d)(p)}function d(p){return Pe(p)?Oe(e,y,"whitespace")(p):y(p)}function y(p){return p===null||ye(p)?(e.exit("definition"),r.parser.defined.push(s),n(p)):t(p)}}function bu(e,n,t){return r;function r(l){return Ke(l)?Rn(e,s)(l):t(l)}function s(l){return fo(e,a,t,"definitionTitle","definitionTitleMarker","definitionTitleString")(l)}function a(l){return Pe(l)?Oe(e,o,"whitespace")(l):o(l)}function o(l){return l===null||ye(l)?n(l):t(l)}}const wu={name:"hardBreakEscape",tokenize:ku};function ku(e,n,t){return r;function r(a){return e.enter("hardBreakEscape"),e.consume(a),s}function s(a){return ye(a)?(e.exit("hardBreakEscape"),n(a)):t(a)}}const _u={name:"headingAtx",resolve:Nu,tokenize:vu};function Nu(e,n){let t=e.length-2,r=3,s,a;return e[r][1].type==="whitespace"&&(r+=2),t-2>r&&e[t][1].type==="whitespace"&&(t-=2),e[t][1].type==="atxHeadingSequence"&&(r===t-1||t-4>r&&e[t-2][1].type==="whitespace")&&(t-=r+1===t?2:4),t>r&&(s={type:"atxHeadingText",start:e[r][1].start,end:e[t][1].end},a={type:"chunkText",start:e[r][1].start,end:e[t][1].end,contentType:"text"},vt(e,r,t-r+1,[["enter",s,n],["enter",a,n],["exit",a,n],["exit",s,n]])),e}function vu(e,n,t){let r=0;return s;function s(m){return e.enter("atxHeading"),a(m)}function a(m){return e.enter("atxHeadingSequence"),o(m)}function o(m){return m===35&&r++<6?(e.consume(m),o):m===null||Ke(m)?(e.exit("atxHeadingSequence"),l(m)):t(m)}function l(m){return m===35?(e.enter("atxHeadingSequence"),c(m)):m===null||ye(m)?(e.exit("atxHeading"),n(m)):Pe(m)?Oe(e,l,"whitespace")(m):(e.enter("atxHeadingText"),u(m))}function c(m){return m===35?(e.consume(m),c):(e.exit("atxHeadingSequence"),l(m))}function u(m){return m===null||m===35||Ke(m)?(e.exit("atxHeadingText"),l(m)):(e.consume(m),u)}}const ju=["address","article","aside","base","basefont","blockquote","body","caption","center","col","colgroup","dd","details","dialog","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hr","html","iframe","legend","li","link","main","menu","menuitem","nav","noframes","ol","optgroup","option","p","param","search","section","summary","table","tbody","td","tfoot","th","thead","title","tr","track","ul"],gs=["pre","script","style","textarea"],Cu={concrete:!0,name:"htmlFlow",resolveTo:Pu,tokenize:Eu},Su={partial:!0,tokenize:Du},Tu={partial:!0,tokenize:Au};function Pu(e){let n=e.length;for(;n--&&!(e[n][0]==="enter"&&e[n][1].type==="htmlFlow"););return n>1&&e[n-2][1].type==="linePrefix"&&(e[n][1].start=e[n-2][1].start,e[n+1][1].start=e[n-2][1].start,e.splice(n-2,2)),e}function Eu(e,n,t){const r=this;let s,a,o,l,c;return u;function u(b){return m(b)}function m(b){return e.enter("htmlFlow"),e.enter("htmlFlowData"),e.consume(b),d}function d(b){return b===33?(e.consume(b),y):b===47?(e.consume(b),a=!0,q):b===63?(e.consume(b),s=3,r.interrupt?n:w):Nt(b)?(e.consume(b),o=String.fromCharCode(b),G):t(b)}function y(b){return b===45?(e.consume(b),s=2,p):b===91?(e.consume(b),s=5,l=0,E):Nt(b)?(e.consume(b),s=4,r.interrupt?n:w):t(b)}function p(b){return b===45?(e.consume(b),r.interrupt?n:w):t(b)}function E(b){const De="CDATA[";return b===De.charCodeAt(l++)?(e.consume(b),l===De.length?r.interrupt?n:_:E):t(b)}function q(b){return Nt(b)?(e.consume(b),o=String.fromCharCode(b),G):t(b)}function G(b){if(b===null||b===47||b===62||Ke(b)){const De=b===47,He=o.toLowerCase();return!De&&!a&&gs.includes(He)?(s=1,r.interrupt?n(b):_(b)):ju.includes(o.toLowerCase())?(s=6,De?(e.consume(b),$):r.interrupt?n(b):_(b)):(s=7,r.interrupt&&!r.parser.lazy[r.now().line]?t(b):a?B(b):I(b))}return b===45||it(b)?(e.consume(b),o+=String.fromCharCode(b),G):t(b)}function $(b){return b===62?(e.consume(b),r.interrupt?n:_):t(b)}function B(b){return Pe(b)?(e.consume(b),B):le(b)}function I(b){return b===47?(e.consume(b),le):b===58||b===95||Nt(b)?(e.consume(b),W):Pe(b)?(e.consume(b),I):le(b)}function W(b){return b===45||b===46||b===58||b===95||it(b)?(e.consume(b),W):F(b)}function F(b){return b===61?(e.consume(b),j):Pe(b)?(e.consume(b),F):I(b)}function j(b){return b===null||b===60||b===61||b===62||b===96?t(b):b===34||b===39?(e.consume(b),c=b,X):Pe(b)?(e.consume(b),j):ce(b)}function X(b){return b===c?(e.consume(b),c=null,ne):b===null||ye(b)?t(b):(e.consume(b),X)}function ce(b){return b===null||b===34||b===39||b===47||b===60||b===61||b===62||b===96||Ke(b)?F(b):(e.consume(b),ce)}function ne(b){return b===47||b===62||Pe(b)?I(b):t(b)}function le(b){return b===62?(e.consume(b),V):t(b)}function V(b){return b===null||ye(b)?_(b):Pe(b)?(e.consume(b),V):t(b)}function _(b){return b===45&&s===2?(e.consume(b),M):b===60&&s===1?(e.consume(b),J):b===62&&s===4?(e.consume(b),Fe):b===63&&s===3?(e.consume(b),w):b===93&&s===5?(e.consume(b),me):ye(b)&&(s===6||s===7)?(e.exit("htmlFlowData"),e.check(Su,_e,C)(b)):b===null||ye(b)?(e.exit("htmlFlowData"),C(b)):(e.consume(b),_)}function C(b){return e.check(Tu,K,_e)(b)}function K(b){return e.enter("lineEnding"),e.consume(b),e.exit("lineEnding"),A}function A(b){return b===null||ye(b)?C(b):(e.enter("htmlFlowData"),_(b))}function M(b){return b===45?(e.consume(b),w):_(b)}function J(b){return b===47?(e.consume(b),o="",Se):_(b)}function Se(b){if(b===62){const De=o.toLowerCase();return gs.includes(De)?(e.consume(b),Fe):_(b)}return Nt(b)&&o.length<8?(e.consume(b),o+=String.fromCharCode(b),Se):_(b)}function me(b){return b===93?(e.consume(b),w):_(b)}function w(b){return b===62?(e.consume(b),Fe):b===45&&s===2?(e.consume(b),w):_(b)}function Fe(b){return b===null||ye(b)?(e.exit("htmlFlowData"),_e(b)):(e.consume(b),Fe)}function _e(b){return e.exit("htmlFlow"),n(b)}}function Au(e,n,t){const r=this;return s;function s(o){return ye(o)?(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),a):t(o)}function a(o){return r.parser.lazy[r.now().line]?t(o):n(o)}}function Du(e,n,t){return r;function r(s){return e.enter("lineEnding"),e.consume(s),e.exit("lineEnding"),e.attempt(kr,n,t)}}const Iu={name:"htmlText",tokenize:Ou};function Ou(e,n,t){const r=this;let s,a,o;return l;function l(w){return e.enter("htmlText"),e.enter("htmlTextData"),e.consume(w),c}function c(w){return w===33?(e.consume(w),u):w===47?(e.consume(w),F):w===63?(e.consume(w),I):Nt(w)?(e.consume(w),ce):t(w)}function u(w){return w===45?(e.consume(w),m):w===91?(e.consume(w),a=0,E):Nt(w)?(e.consume(w),B):t(w)}function m(w){return w===45?(e.consume(w),p):t(w)}function d(w){return w===null?t(w):w===45?(e.consume(w),y):ye(w)?(o=d,J(w)):(e.consume(w),d)}function y(w){return w===45?(e.consume(w),p):d(w)}function p(w){return w===62?M(w):w===45?y(w):d(w)}function E(w){const Fe="CDATA[";return w===Fe.charCodeAt(a++)?(e.consume(w),a===Fe.length?q:E):t(w)}function q(w){return w===null?t(w):w===93?(e.consume(w),G):ye(w)?(o=q,J(w)):(e.consume(w),q)}function G(w){return w===93?(e.consume(w),$):q(w)}function $(w){return w===62?M(w):w===93?(e.consume(w),$):q(w)}function B(w){return w===null||w===62?M(w):ye(w)?(o=B,J(w)):(e.consume(w),B)}function I(w){return w===null?t(w):w===63?(e.consume(w),W):ye(w)?(o=I,J(w)):(e.consume(w),I)}function W(w){return w===62?M(w):I(w)}function F(w){return Nt(w)?(e.consume(w),j):t(w)}function j(w){return w===45||it(w)?(e.consume(w),j):X(w)}function X(w){return ye(w)?(o=X,J(w)):Pe(w)?(e.consume(w),X):M(w)}function ce(w){return w===45||it(w)?(e.consume(w),ce):w===47||w===62||Ke(w)?ne(w):t(w)}function ne(w){return w===47?(e.consume(w),M):w===58||w===95||Nt(w)?(e.consume(w),le):ye(w)?(o=ne,J(w)):Pe(w)?(e.consume(w),ne):M(w)}function le(w){return w===45||w===46||w===58||w===95||it(w)?(e.consume(w),le):V(w)}function V(w){return w===61?(e.consume(w),_):ye(w)?(o=V,J(w)):Pe(w)?(e.consume(w),V):ne(w)}function _(w){return w===null||w===60||w===61||w===62||w===96?t(w):w===34||w===39?(e.consume(w),s=w,C):ye(w)?(o=_,J(w)):Pe(w)?(e.consume(w),_):(e.consume(w),K)}function C(w){return w===s?(e.consume(w),s=void 0,A):w===null?t(w):ye(w)?(o=C,J(w)):(e.consume(w),C)}function K(w){return w===null||w===34||w===39||w===60||w===61||w===96?t(w):w===47||w===62||Ke(w)?ne(w):(e.consume(w),K)}function A(w){return w===47||w===62||Ke(w)?ne(w):t(w)}function M(w){return w===62?(e.consume(w),e.exit("htmlTextData"),e.exit("htmlText"),n):t(w)}function J(w){return e.exit("htmlTextData"),e.enter("lineEnding"),e.consume(w),e.exit("lineEnding"),Se}function Se(w){return Pe(w)?Oe(e,me,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(w):me(w)}function me(w){return e.enter("htmlTextData"),o(w)}}const Hi={name:"labelEnd",resolveAll:Fu,resolveTo:zu,tokenize:qu},$u={tokenize:Bu},Lu={tokenize:Uu},Ru={tokenize:Mu};function Fu(e){let n=-1;const t=[];for(;++n<e.length;){const r=e[n][1];if(t.push(e[n]),r.type==="labelImage"||r.type==="labelLink"||r.type==="labelEnd"){const s=r.type==="labelImage"?4:2;r.type="data",n+=s}}return e.length!==t.length&&vt(e,0,e.length,t),e}function zu(e,n){let t=e.length,r=0,s,a,o,l;for(;t--;)if(s=e[t][1],a){if(s.type==="link"||s.type==="labelLink"&&s._inactive)break;e[t][0]==="enter"&&s.type==="labelLink"&&(s._inactive=!0)}else if(o){if(e[t][0]==="enter"&&(s.type==="labelImage"||s.type==="labelLink")&&!s._balanced&&(a=t,s.type!=="labelLink")){r=2;break}}else s.type==="labelEnd"&&(o=t);const c={type:e[a][1].type==="labelLink"?"link":"image",start:{...e[a][1].start},end:{...e[e.length-1][1].end}},u={type:"label",start:{...e[a][1].start},end:{...e[o][1].end}},m={type:"labelText",start:{...e[a+r+2][1].end},end:{...e[o-2][1].start}};return l=[["enter",c,n],["enter",u,n]],l=dt(l,e.slice(a+1,a+r+3)),l=dt(l,[["enter",m,n]]),l=dt(l,Mi(n.parser.constructs.insideSpan.null,e.slice(a+r+4,o-3),n)),l=dt(l,[["exit",m,n],e[o-2],e[o-1],["exit",u,n]]),l=dt(l,e.slice(o+1)),l=dt(l,[["exit",c,n]]),vt(e,a,e.length,l),e}function qu(e,n,t){const r=this;let s=r.events.length,a,o;for(;s--;)if((r.events[s][1].type==="labelImage"||r.events[s][1].type==="labelLink")&&!r.events[s][1]._balanced){a=r.events[s][1];break}return l;function l(y){return a?a._inactive?d(y):(o=r.parser.defined.includes(pn(r.sliceSerialize({start:a.end,end:r.now()}))),e.enter("labelEnd"),e.enter("labelMarker"),e.consume(y),e.exit("labelMarker"),e.exit("labelEnd"),c):t(y)}function c(y){return y===40?e.attempt($u,m,o?m:d)(y):y===91?e.attempt(Lu,m,o?u:d)(y):o?m(y):d(y)}function u(y){return e.attempt(Ru,m,d)(y)}function m(y){return n(y)}function d(y){return a._balanced=!0,t(y)}}function Bu(e,n,t){return r;function r(d){return e.enter("resource"),e.enter("resourceMarker"),e.consume(d),e.exit("resourceMarker"),s}function s(d){return Ke(d)?Rn(e,a)(d):a(d)}function a(d){return d===41?m(d):ho(e,o,l,"resourceDestination","resourceDestinationLiteral","resourceDestinationLiteralMarker","resourceDestinationRaw","resourceDestinationString",32)(d)}function o(d){return Ke(d)?Rn(e,c)(d):m(d)}function l(d){return t(d)}function c(d){return d===34||d===39||d===40?fo(e,u,t,"resourceTitle","resourceTitleMarker","resourceTitleString")(d):m(d)}function u(d){return Ke(d)?Rn(e,m)(d):m(d)}function m(d){return d===41?(e.enter("resourceMarker"),e.consume(d),e.exit("resourceMarker"),e.exit("resource"),n):t(d)}}function Uu(e,n,t){const r=this;return s;function s(l){return mo.call(r,e,a,o,"reference","referenceMarker","referenceString")(l)}function a(l){return r.parser.defined.includes(pn(r.sliceSerialize(r.events[r.events.length-1][1]).slice(1,-1)))?n(l):t(l)}function o(l){return t(l)}}function Mu(e,n,t){return r;function r(a){return e.enter("reference"),e.enter("referenceMarker"),e.consume(a),e.exit("referenceMarker"),s}function s(a){return a===93?(e.enter("referenceMarker"),e.consume(a),e.exit("referenceMarker"),e.exit("reference"),n):t(a)}}const Hu={name:"labelStartImage",resolveAll:Hi.resolveAll,tokenize:Wu};function Wu(e,n,t){const r=this;return s;function s(l){return e.enter("labelImage"),e.enter("labelImageMarker"),e.consume(l),e.exit("labelImageMarker"),a}function a(l){return l===91?(e.enter("labelMarker"),e.consume(l),e.exit("labelMarker"),e.exit("labelImage"),o):t(l)}function o(l){return l===94&&"_hiddenFootnoteSupport"in r.parser.constructs?t(l):n(l)}}const Vu={name:"labelStartLink",resolveAll:Hi.resolveAll,tokenize:Ju};function Ju(e,n,t){const r=this;return s;function s(o){return e.enter("labelLink"),e.enter("labelMarker"),e.consume(o),e.exit("labelMarker"),e.exit("labelLink"),a}function a(o){return o===94&&"_hiddenFootnoteSupport"in r.parser.constructs?t(o):n(o)}}const ci={name:"lineEnding",tokenize:Qu};function Qu(e,n){return t;function t(r){return e.enter("lineEnding"),e.consume(r),e.exit("lineEnding"),Oe(e,n,"linePrefix")}}const gr={name:"thematicBreak",tokenize:Gu};function Gu(e,n,t){let r=0,s;return a;function a(u){return e.enter("thematicBreak"),o(u)}function o(u){return s=u,l(u)}function l(u){return u===s?(e.enter("thematicBreakSequence"),c(u)):r>=3&&(u===null||ye(u))?(e.exit("thematicBreak"),n(u)):t(u)}function c(u){return u===s?(e.consume(u),r++,c):(e.exit("thematicBreakSequence"),Pe(u)?Oe(e,l,"whitespace")(u):l(u))}}const Ye={continuation:{tokenize:Xu},exit:td,name:"list",tokenize:Zu},Yu={partial:!0,tokenize:nd},Ku={partial:!0,tokenize:ed};function Zu(e,n,t){const r=this,s=r.events[r.events.length-1];let a=s&&s[1].type==="linePrefix"?s[2].sliceSerialize(s[1],!0).length:0,o=0;return l;function l(p){const E=r.containerState.type||(p===42||p===43||p===45?"listUnordered":"listOrdered");if(E==="listUnordered"?!r.containerState.marker||p===r.containerState.marker:Pi(p)){if(r.containerState.type||(r.containerState.type=E,e.enter(E,{_container:!0})),E==="listUnordered")return e.enter("listItemPrefix"),p===42||p===45?e.check(gr,t,u)(p):u(p);if(!r.interrupt||p===49)return e.enter("listItemPrefix"),e.enter("listItemValue"),c(p)}return t(p)}function c(p){return Pi(p)&&++o<10?(e.consume(p),c):(!r.interrupt||o<2)&&(r.containerState.marker?p===r.containerState.marker:p===41||p===46)?(e.exit("listItemValue"),u(p)):t(p)}function u(p){return e.enter("listItemMarker"),e.consume(p),e.exit("listItemMarker"),r.containerState.marker=r.containerState.marker||p,e.check(kr,r.interrupt?t:m,e.attempt(Yu,y,d))}function m(p){return r.containerState.initialBlankLine=!0,a++,y(p)}function d(p){return Pe(p)?(e.enter("listItemPrefixWhitespace"),e.consume(p),e.exit("listItemPrefixWhitespace"),y):t(p)}function y(p){return r.containerState.size=a+r.sliceSerialize(e.exit("listItemPrefix"),!0).length,n(p)}}function Xu(e,n,t){const r=this;return r.containerState._closeFlow=void 0,e.check(kr,s,a);function s(l){return r.containerState.furtherBlankLines=r.containerState.furtherBlankLines||r.containerState.initialBlankLine,Oe(e,n,"listItemIndent",r.containerState.size+1)(l)}function a(l){return r.containerState.furtherBlankLines||!Pe(l)?(r.containerState.furtherBlankLines=void 0,r.containerState.initialBlankLine=void 0,o(l)):(r.containerState.furtherBlankLines=void 0,r.containerState.initialBlankLine=void 0,e.attempt(Ku,n,o)(l))}function o(l){return r.containerState._closeFlow=!0,r.interrupt=void 0,Oe(e,e.attempt(Ye,n,t),"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(l)}}function ed(e,n,t){const r=this;return Oe(e,s,"listItemIndent",r.containerState.size+1);function s(a){const o=r.events[r.events.length-1];return o&&o[1].type==="listItemIndent"&&o[2].sliceSerialize(o[1],!0).length===r.containerState.size?n(a):t(a)}}function td(e){e.exit(this.containerState.type)}function nd(e,n,t){const r=this;return Oe(e,s,"listItemPrefixWhitespace",r.parser.constructs.disable.null.includes("codeIndented")?void 0:5);function s(a){const o=r.events[r.events.length-1];return!Pe(a)&&o&&o[1].type==="listItemPrefixWhitespace"?n(a):t(a)}}const ys={name:"setextUnderline",resolveTo:rd,tokenize:id};function rd(e,n){let t=e.length,r,s,a;for(;t--;)if(e[t][0]==="enter"){if(e[t][1].type==="content"){r=t;break}e[t][1].type==="paragraph"&&(s=t)}else e[t][1].type==="content"&&e.splice(t,1),!a&&e[t][1].type==="definition"&&(a=t);const o={type:"setextHeading",start:{...e[r][1].start},end:{...e[e.length-1][1].end}};return e[s][1].type="setextHeadingText",a?(e.splice(s,0,["enter",o,n]),e.splice(a+1,0,["exit",e[r][1],n]),e[r][1].end={...e[a][1].end}):e[r][1]=o,e.push(["exit",o,n]),e}function id(e,n,t){const r=this;let s;return a;function a(u){let m=r.events.length,d;for(;m--;)if(r.events[m][1].type!=="lineEnding"&&r.events[m][1].type!=="linePrefix"&&r.events[m][1].type!=="content"){d=r.events[m][1].type==="paragraph";break}return!r.parser.lazy[r.now().line]&&(r.interrupt||d)?(e.enter("setextHeadingLine"),s=u,o(u)):t(u)}function o(u){return e.enter("setextHeadingLineSequence"),l(u)}function l(u){return u===s?(e.consume(u),l):(e.exit("setextHeadingLineSequence"),Pe(u)?Oe(e,c,"lineSuffix")(u):c(u))}function c(u){return u===null||ye(u)?(e.exit("setextHeadingLine"),n(u)):t(u)}}const ad={tokenize:sd};function sd(e){const n=this,t=e.attempt(kr,r,e.attempt(this.parser.constructs.flowInitial,s,Oe(e,e.attempt(this.parser.constructs.flow,s,e.attempt(du,s)),"linePrefix")));return t;function r(a){if(a===null){e.consume(a);return}return e.enter("lineEndingBlank"),e.consume(a),e.exit("lineEndingBlank"),n.currentConstruct=void 0,t}function s(a){if(a===null){e.consume(a);return}return e.enter("lineEnding"),e.consume(a),e.exit("lineEnding"),n.currentConstruct=void 0,t}}const od={resolveAll:yo()},ld=go("string"),cd=go("text");function go(e){return{resolveAll:yo(e==="text"?ud:void 0),tokenize:n};function n(t){const r=this,s=this.parser.constructs[e],a=t.attempt(s,o,l);return o;function o(m){return u(m)?a(m):l(m)}function l(m){if(m===null){t.consume(m);return}return t.enter("data"),t.consume(m),c}function c(m){return u(m)?(t.exit("data"),a(m)):(t.consume(m),c)}function u(m){if(m===null)return!0;const d=s[m];let y=-1;if(d)for(;++y<d.length;){const p=d[y];if(!p.previous||p.previous.call(r,r.previous))return!0}return!1}}}function yo(e){return n;function n(t,r){let s=-1,a;for(;++s<=t.length;)a===void 0?t[s]&&t[s][1].type==="data"&&(a=s,s++):(!t[s]||t[s][1].type!=="data")&&(s!==a+2&&(t[a][1].end=t[s-1][1].end,t.splice(a+2,s-a-2),s=a+2),a=void 0);return e?e(t,r):t}}function ud(e,n){let t=0;for(;++t<=e.length;)if((t===e.length||e[t][1].type==="lineEnding")&&e[t-1][1].type==="data"){const r=e[t-1][1],s=n.sliceStream(r);let a=s.length,o=-1,l=0,c;for(;a--;){const u=s[a];if(typeof u=="string"){for(o=u.length;u.charCodeAt(o-1)===32;)l++,o--;if(o)break;o=-1}else if(u===-2)c=!0,l++;else if(u!==-1){a++;break}}if(n._contentTypeTextTrailing&&t===e.length&&(l=0),l){const u={type:t===e.length||c||l<2?"lineSuffix":"hardBreakTrailing",start:{_bufferIndex:a?o:r.start._bufferIndex+o,_index:r.start._index+a,line:r.end.line,column:r.end.column-l,offset:r.end.offset-l},end:{...r.end}};r.end={...u.start},r.start.offset===r.end.offset?Object.assign(r,u):(e.splice(t,0,["enter",u,n],["exit",u,n]),t+=2)}t++}return e}const dd={42:Ye,43:Ye,45:Ye,48:Ye,49:Ye,50:Ye,51:Ye,52:Ye,53:Ye,54:Ye,55:Ye,56:Ye,57:Ye,62:lo},pd={91:gu},hd={[-2]:li,[-1]:li,32:li},md={35:_u,42:gr,45:[ys,gr],60:Cu,61:ys,95:gr,96:fs,126:fs},fd={38:uo,92:co},gd={[-5]:ci,[-4]:ci,[-3]:ci,33:Hu,38:uo,42:Ei,60:[Vc,Iu],91:Vu,92:[wu,co],93:Hi,95:Ei,96:au},yd={null:[Ei,od]},xd={null:[42,95]},bd={null:[]},wd=Object.freeze(Object.defineProperty({__proto__:null,attentionMarkers:xd,contentInitial:pd,disable:bd,document:dd,flow:md,flowInitial:hd,insideSpan:yd,string:fd,text:gd},Symbol.toStringTag,{value:"Module"}));function kd(e,n,t){let r={_bufferIndex:-1,_index:0,line:t&&t.line||1,column:t&&t.column||1,offset:t&&t.offset||0};const s={},a=[];let o=[],l=[];const c={attempt:X(F),check:X(j),consume:B,enter:I,exit:W,interrupt:X(j,{interrupt:!0})},u={code:null,containerState:{},defineSkip:q,events:[],now:E,parser:e,previous:null,sliceSerialize:y,sliceStream:p,write:d};let m=n.tokenize.call(u,c);return n.resolveAll&&a.push(n),u;function d(V){return o=dt(o,V),G(),o[o.length-1]!==null?[]:(ce(n,0),u.events=Mi(a,u.events,u),u.events)}function y(V,_){return Nd(p(V),_)}function p(V){return _d(o,V)}function E(){const{_bufferIndex:V,_index:_,line:C,column:K,offset:A}=r;return{_bufferIndex:V,_index:_,line:C,column:K,offset:A}}function q(V){s[V.line]=V.column,le()}function G(){let V;for(;r._index<o.length;){const _=o[r._index];if(typeof _=="string")for(V=r._index,r._bufferIndex<0&&(r._bufferIndex=0);r._index===V&&r._bufferIndex<_.length;)$(_.charCodeAt(r._bufferIndex));else $(_)}}function $(V){m=m(V)}function B(V){ye(V)?(r.line++,r.column=1,r.offset+=V===-3?2:1,le()):V!==-1&&(r.column++,r.offset++),r._bufferIndex<0?r._index++:(r._bufferIndex++,r._bufferIndex===o[r._index].length&&(r._bufferIndex=-1,r._index++)),u.previous=V}function I(V,_){const C=_||{};return C.type=V,C.start=E(),u.events.push(["enter",C,u]),l.push(C),C}function W(V){const _=l.pop();return _.end=E(),u.events.push(["exit",_,u]),_}function F(V,_){ce(V,_.from)}function j(V,_){_.restore()}function X(V,_){return C;function C(K,A,M){let J,Se,me,w;return Array.isArray(K)?_e(K):"tokenize"in K?_e([K]):Fe(K);function Fe(Ne){return at;function at(Re){const et=Re!==null&&Ne[Re],st=Re!==null&&Ne.null,tt=[...Array.isArray(et)?et:et?[et]:[],...Array.isArray(st)?st:st?[st]:[]];return _e(tt)(Re)}}function _e(Ne){return J=Ne,Se=0,Ne.length===0?M:b(Ne[Se])}function b(Ne){return at;function at(Re){return w=ne(),me=Ne,Ne.partial||(u.currentConstruct=Ne),Ne.name&&u.parser.constructs.disable.null.includes(Ne.name)?He():Ne.tokenize.call(_?Object.assign(Object.create(u),_):u,c,De,He)(Re)}}function De(Ne){return V(me,w),A}function He(Ne){return w.restore(),++Se<J.length?b(J[Se]):M}}}function ce(V,_){V.resolveAll&&!a.includes(V)&&a.push(V),V.resolve&&vt(u.events,_,u.events.length-_,V.resolve(u.events.slice(_),u)),V.resolveTo&&(u.events=V.resolveTo(u.events,u))}function ne(){const V=E(),_=u.previous,C=u.currentConstruct,K=u.events.length,A=Array.from(l);return{from:K,restore:M};function M(){r=V,u.previous=_,u.currentConstruct=C,u.events.length=K,l=A,le()}}function le(){r.line in s&&r.column<2&&(r.column=s[r.line],r.offset+=s[r.line]-1)}}function _d(e,n){const t=n.start._index,r=n.start._bufferIndex,s=n.end._index,a=n.end._bufferIndex;let o;if(t===s)o=[e[t].slice(r,a)];else{if(o=e.slice(t,s),r>-1){const l=o[0];typeof l=="string"?o[0]=l.slice(r):o.shift()}a>0&&o.push(e[s].slice(0,a))}return o}function Nd(e,n){let t=-1;const r=[];let s;for(;++t<e.length;){const a=e[t];let o;if(typeof a=="string")o=a;else switch(a){case-5:{o="\r";break}case-4:{o=`
`;break}case-3:{o=`\r
`;break}case-2:{o=n?" ":"	";break}case-1:{if(!n&&s)continue;o=" ";break}default:o=String.fromCharCode(a)}s=a===-2,r.push(o)}return r.join("")}function vd(e){const r={constructs:Ac([wd,...(e||{}).extensions||[]]),content:s(zc),defined:[],document:s(Bc),flow:s(ad),lazy:{},string:s(ld),text:s(cd)};return r;function s(a){return o;function o(l){return kd(r,a,l)}}}function jd(e){for(;!po(e););return e}const xs=/[\0\t\n\r]/g;function Cd(){let e=1,n="",t=!0,r;return s;function s(a,o,l){const c=[];let u,m,d,y,p;for(a=n+(typeof a=="string"?a.toString():new TextDecoder(o||void 0).decode(a)),d=0,n="",t&&(a.charCodeAt(0)===65279&&d++,t=void 0);d<a.length;){if(xs.lastIndex=d,u=xs.exec(a),y=u&&u.index!==void 0?u.index:a.length,p=a.charCodeAt(y),!u){n=a.slice(d);break}if(p===10&&d===y&&r)c.push(-3),r=void 0;else switch(r&&(c.push(-5),r=void 0),d<y&&(c.push(a.slice(d,y)),e+=y-d),p){case 0:{c.push(65533),e++;break}case 9:{for(m=Math.ceil(e/4)*4,c.push(-2);e++<m;)c.push(-1);break}case 10:{c.push(-4),e=1;break}default:r=!0,e=1}d=y+1}return l&&(r&&c.push(-5),n&&c.push(n),c.push(null)),c}}const Sd=/\\([!-/:-@[-`{-~])|&(#(?:\d{1,7}|x[\da-f]{1,6})|[\da-z]{1,31});/gi;function xo(e){return e.replace(Sd,Td)}function Td(e,n,t){if(n)return n;if(t.charCodeAt(0)===35){const s=t.charCodeAt(1),a=s===120||s===88;return oo(t.slice(a?2:1),a?16:10)}return Ui(t)||e}function Fn(e){return!e||typeof e!="object"?"":"position"in e||"type"in e?bs(e.position):"start"in e||"end"in e?bs(e):"line"in e||"column"in e?Ai(e):""}function Ai(e){return ws(e&&e.line)+":"+ws(e&&e.column)}function bs(e){return Ai(e&&e.start)+"-"+Ai(e&&e.end)}function ws(e){return e&&typeof e=="number"?e:1}const bo={}.hasOwnProperty;function Pd(e,n,t){return typeof n!="string"&&(t=n,n=void 0),Ed(t)(jd(vd(t).document().write(Cd()(e,n,!0))))}function Ed(e){const n={transforms:[],canContainEols:["emphasis","fragment","heading","paragraph","strong"],enter:{autolink:a(Je),autolinkProtocol:ne,autolinkEmail:ne,atxHeading:a(jt),blockQuote:a(st),characterEscape:ne,characterReference:ne,codeFenced:a(tt),codeFencedFenceInfo:o,codeFencedFenceMeta:o,codeIndented:a(tt,o),codeText:a(Yt,o),codeTextData:ne,data:ne,codeFlowValue:ne,definition:a(v),definitionDestinationString:o,definitionLabelString:o,definitionTitleString:o,emphasis:a(Ot),hardBreakEscape:a(Kt),hardBreakTrailing:a(Kt),htmlFlow:a(pt,o),htmlFlowData:ne,htmlText:a(pt,o),htmlTextData:ne,image:a(yt),label:o,link:a(Je),listItem:a(Mt),listItemValue:y,listOrdered:a(Ct,d),listUnordered:a(Ct),paragraph:a(Zt),reference:b,referenceString:o,resourceDestinationString:o,resourceTitleString:o,setextHeading:a(jt),strong:a(We),thematicBreak:a($e)},exit:{atxHeading:c(),atxHeadingSequence:F,autolink:c(),autolinkEmail:et,autolinkProtocol:Re,blockQuote:c(),characterEscapeValue:le,characterReferenceMarkerHexadecimal:He,characterReferenceMarkerNumeric:He,characterReferenceValue:Ne,characterReference:at,codeFenced:c(G),codeFencedFence:q,codeFencedFenceInfo:p,codeFencedFenceMeta:E,codeFlowValue:le,codeIndented:c($),codeText:c(A),codeTextData:le,data:le,definition:c(),definitionDestinationString:W,definitionLabelString:B,definitionTitleString:I,emphasis:c(),hardBreakEscape:c(_),hardBreakTrailing:c(_),htmlFlow:c(C),htmlFlowData:le,htmlText:c(K),htmlTextData:le,image:c(J),label:me,labelText:Se,lineEnding:V,link:c(M),listItem:c(),listOrdered:c(),listUnordered:c(),paragraph:c(),referenceString:De,resourceDestinationString:w,resourceTitleString:Fe,resource:_e,setextHeading:c(ce),setextHeadingLineSequence:X,setextHeadingText:j,strong:c(),thematicBreak:c()}};wo(n,(e||{}).mdastExtensions||[]);const t={};return r;function r(T){let P={type:"root",children:[]};const S={stack:[P],tokenStack:[],config:n,enter:l,exit:u,buffer:o,resume:m,data:t},ee=[];let ue=-1;for(;++ue<T.length;)if(T[ue][1].type==="listOrdered"||T[ue][1].type==="listUnordered")if(T[ue][0]==="enter")ee.push(ue);else{const Le=ee.pop();ue=s(T,Le,ue)}for(ue=-1;++ue<T.length;){const Le=n[T[ue][0]];bo.call(Le,T[ue][1].type)&&Le[T[ue][1].type].call(Object.assign({sliceSerialize:T[ue][2].sliceSerialize},S),T[ue][1])}if(S.tokenStack.length>0){const Le=S.tokenStack[S.tokenStack.length-1];(Le[1]||ks).call(S,void 0,Le[0])}for(P.position={start:zt(T.length>0?T[0][1].start:{line:1,column:1,offset:0}),end:zt(T.length>0?T[T.length-2][1].end:{line:1,column:1,offset:0})},ue=-1;++ue<n.transforms.length;)P=n.transforms[ue](P)||P;return P}function s(T,P,S){let ee=P-1,ue=-1,Le=!1,Me,je,Ve,Qe;for(;++ee<=S;){const ze=T[ee];switch(ze[1].type){case"listUnordered":case"listOrdered":case"blockQuote":{ze[0]==="enter"?ue++:ue--,Qe=void 0;break}case"lineEndingBlank":{ze[0]==="enter"&&(Me&&!Qe&&!ue&&!Ve&&(Ve=ee),Qe=void 0);break}case"linePrefix":case"listItemValue":case"listItemMarker":case"listItemPrefix":case"listItemPrefixWhitespace":break;default:Qe=void 0}if(!ue&&ze[0]==="enter"&&ze[1].type==="listItemPrefix"||ue===-1&&ze[0]==="exit"&&(ze[1].type==="listUnordered"||ze[1].type==="listOrdered")){if(Me){let te=ee;for(je=void 0;te--;){const D=T[te];if(D[1].type==="lineEnding"||D[1].type==="lineEndingBlank"){if(D[0]==="exit")continue;je&&(T[je][1].type="lineEndingBlank",Le=!0),D[1].type="lineEnding",je=te}else if(!(D[1].type==="linePrefix"||D[1].type==="blockQuotePrefix"||D[1].type==="blockQuotePrefixWhitespace"||D[1].type==="blockQuoteMarker"||D[1].type==="listItemIndent"))break}Ve&&(!je||Ve<je)&&(Me._spread=!0),Me.end=Object.assign({},je?T[je][1].start:ze[1].end),T.splice(je||ee,0,["exit",Me,ze[2]]),ee++,S++}if(ze[1].type==="listItemPrefix"){const te={type:"listItem",_spread:!1,start:Object.assign({},ze[1].start),end:void 0};Me=te,T.splice(ee,0,["enter",te,ze[2]]),ee++,S++,Ve=void 0,Qe=!0}}}return T[P][1]._spread=Le,S}function a(T,P){return S;function S(ee){l.call(this,T(ee),ee),P&&P.call(this,ee)}}function o(){this.stack.push({type:"fragment",children:[]})}function l(T,P,S){this.stack[this.stack.length-1].children.push(T),this.stack.push(T),this.tokenStack.push([P,S||void 0]),T.position={start:zt(P.start),end:void 0}}function c(T){return P;function P(S){T&&T.call(this,S),u.call(this,S)}}function u(T,P){const S=this.stack.pop(),ee=this.tokenStack.pop();if(ee)ee[0].type!==T.type&&(P?P.call(this,T,ee[0]):(ee[1]||ks).call(this,T,ee[0]));else throw new Error("Cannot close `"+T.type+"` ("+Fn({start:T.start,end:T.end})+"): it’s not open");S.position.end=zt(T.end)}function m(){return Bi(this.stack.pop())}function d(){this.data.expectingFirstListItemValue=!0}function y(T){if(this.data.expectingFirstListItemValue){const P=this.stack[this.stack.length-2];P.start=Number.parseInt(this.sliceSerialize(T),10),this.data.expectingFirstListItemValue=void 0}}function p(){const T=this.resume(),P=this.stack[this.stack.length-1];P.lang=T}function E(){const T=this.resume(),P=this.stack[this.stack.length-1];P.meta=T}function q(){this.data.flowCodeInside||(this.buffer(),this.data.flowCodeInside=!0)}function G(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T.replace(/^(\r?\n|\r)|(\r?\n|\r)$/g,""),this.data.flowCodeInside=void 0}function $(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T.replace(/(\r?\n|\r)$/g,"")}function B(T){const P=this.resume(),S=this.stack[this.stack.length-1];S.label=P,S.identifier=pn(this.sliceSerialize(T)).toLowerCase()}function I(){const T=this.resume(),P=this.stack[this.stack.length-1];P.title=T}function W(){const T=this.resume(),P=this.stack[this.stack.length-1];P.url=T}function F(T){const P=this.stack[this.stack.length-1];if(!P.depth){const S=this.sliceSerialize(T).length;P.depth=S}}function j(){this.data.setextHeadingSlurpLineEnding=!0}function X(T){const P=this.stack[this.stack.length-1];P.depth=this.sliceSerialize(T).codePointAt(0)===61?1:2}function ce(){this.data.setextHeadingSlurpLineEnding=void 0}function ne(T){const S=this.stack[this.stack.length-1].children;let ee=S[S.length-1];(!ee||ee.type!=="text")&&(ee=St(),ee.position={start:zt(T.start),end:void 0},S.push(ee)),this.stack.push(ee)}function le(T){const P=this.stack.pop();P.value+=this.sliceSerialize(T),P.position.end=zt(T.end)}function V(T){const P=this.stack[this.stack.length-1];if(this.data.atHardBreak){const S=P.children[P.children.length-1];S.position.end=zt(T.end),this.data.atHardBreak=void 0;return}!this.data.setextHeadingSlurpLineEnding&&n.canContainEols.includes(P.type)&&(ne.call(this,T),le.call(this,T))}function _(){this.data.atHardBreak=!0}function C(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T}function K(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T}function A(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T}function M(){const T=this.stack[this.stack.length-1];if(this.data.inReference){const P=this.data.referenceType||"shortcut";T.type+="Reference",T.referenceType=P,delete T.url,delete T.title}else delete T.identifier,delete T.label;this.data.referenceType=void 0}function J(){const T=this.stack[this.stack.length-1];if(this.data.inReference){const P=this.data.referenceType||"shortcut";T.type+="Reference",T.referenceType=P,delete T.url,delete T.title}else delete T.identifier,delete T.label;this.data.referenceType=void 0}function Se(T){const P=this.sliceSerialize(T),S=this.stack[this.stack.length-2];S.label=xo(P),S.identifier=pn(P).toLowerCase()}function me(){const T=this.stack[this.stack.length-1],P=this.resume(),S=this.stack[this.stack.length-1];if(this.data.inReference=!0,S.type==="link"){const ee=T.children;S.children=ee}else S.alt=P}function w(){const T=this.resume(),P=this.stack[this.stack.length-1];P.url=T}function Fe(){const T=this.resume(),P=this.stack[this.stack.length-1];P.title=T}function _e(){this.data.inReference=void 0}function b(){this.data.referenceType="collapsed"}function De(T){const P=this.resume(),S=this.stack[this.stack.length-1];S.label=P,S.identifier=pn(this.sliceSerialize(T)).toLowerCase(),this.data.referenceType="full"}function He(T){this.data.characterReferenceType=T.type}function Ne(T){const P=this.sliceSerialize(T),S=this.data.characterReferenceType;let ee;S?(ee=oo(P,S==="characterReferenceMarkerNumeric"?10:16),this.data.characterReferenceType=void 0):ee=Ui(P);const ue=this.stack[this.stack.length-1];ue.value+=ee}function at(T){const P=this.stack.pop();P.position.end=zt(T.end)}function Re(T){le.call(this,T);const P=this.stack[this.stack.length-1];P.url=this.sliceSerialize(T)}function et(T){le.call(this,T);const P=this.stack[this.stack.length-1];P.url="mailto:"+this.sliceSerialize(T)}function st(){return{type:"blockquote",children:[]}}function tt(){return{type:"code",lang:null,meta:null,value:""}}function Yt(){return{type:"inlineCode",value:""}}function v(){return{type:"definition",identifier:"",label:null,title:null,url:""}}function Ot(){return{type:"emphasis",children:[]}}function jt(){return{type:"heading",depth:0,children:[]}}function Kt(){return{type:"break"}}function pt(){return{type:"html",value:""}}function yt(){return{type:"image",title:null,url:"",alt:null}}function Je(){return{type:"link",title:null,url:"",children:[]}}function Ct(T){return{type:"list",ordered:T.type==="listOrdered",start:null,spread:T._spread,children:[]}}function Mt(T){return{type:"listItem",spread:T._spread,checked:null,children:[]}}function Zt(){return{type:"paragraph",children:[]}}function We(){return{type:"strong",children:[]}}function St(){return{type:"text",value:""}}function $e(){return{type:"thematicBreak"}}}function zt(e){return{line:e.line,column:e.column,offset:e.offset}}function wo(e,n){let t=-1;for(;++t<n.length;){const r=n[t];Array.isArray(r)?wo(e,r):Ad(e,r)}}function Ad(e,n){let t;for(t in n)if(bo.call(n,t))switch(t){case"canContainEols":{const r=n[t];r&&e[t].push(...r);break}case"transforms":{const r=n[t];r&&e[t].push(...r);break}case"enter":case"exit":{const r=n[t];r&&Object.assign(e[t],r);break}}}function ks(e,n){throw e?new Error("Cannot close `"+e.type+"` ("+Fn({start:e.start,end:e.end})+"): a different token (`"+n.type+"`, "+Fn({start:n.start,end:n.end})+") is open"):new Error("Cannot close document, a token (`"+n.type+"`, "+Fn({start:n.start,end:n.end})+") is still open")}function Dd(e){const n=this;n.parser=t;function t(r){return Pd(r,{...n.data("settings"),...e,extensions:n.data("micromarkExtensions")||[],mdastExtensions:n.data("fromMarkdownExtensions")||[]})}}const _s={}.hasOwnProperty;function ko(e,n){const t=n||{};function r(s,...a){let o=r.invalid;const l=r.handlers;if(s&&_s.call(s,e)){const c=String(s[e]);o=_s.call(l,c)?l[c]:r.unknown}if(o)return o.call(this,s,...a)}return r.handlers=t.handlers||{},r.invalid=t.invalid,r.unknown=t.unknown,r}const Id={}.hasOwnProperty;function _o(e,n){let t=-1,r;if(n.extensions)for(;++t<n.extensions.length;)_o(e,n.extensions[t]);for(r in n)if(Id.call(n,r))switch(r){case"extensions":break;case"unsafe":{Ns(e[r],n[r]);break}case"join":{Ns(e[r],n[r]);break}case"handlers":{Od(e[r],n[r]);break}default:e.options[r]=n[r]}return e}function Ns(e,n){n&&e.push(...n)}function Od(e,n){n&&Object.assign(e,n)}function $d(e,n,t,r){const s=t.enter("blockquote"),a=t.createTracker(r);a.move("> "),a.shift(2);const o=t.indentLines(t.containerFlow(e,a.current()),Ld);return s(),o}function Ld(e,n,t){return">"+(t?"":" ")+e}function No(e,n){return vs(e,n.inConstruct,!0)&&!vs(e,n.notInConstruct,!1)}function vs(e,n,t){if(typeof n=="string"&&(n=[n]),!n||n.length===0)return t;let r=-1;for(;++r<n.length;)if(e.includes(n[r]))return!0;return!1}function js(e,n,t,r){let s=-1;for(;++s<t.unsafe.length;)if(t.unsafe[s].character===`
`&&No(t.stack,t.unsafe[s]))return/[ \t]/.test(r.before)?"":" ";return`\\
`}function Rd(e,n){const t=String(e);let r=t.indexOf(n),s=r,a=0,o=0;if(typeof n!="string")throw new TypeError("Expected substring");for(;r!==-1;)r===s?++a>o&&(o=a):a=1,s=r+n.length,r=t.indexOf(n,s);return o}function Di(e,n){return!!(n.options.fences===!1&&e.value&&!e.lang&&/[^ \r\n]/.test(e.value)&&!/^[\t ]*(?:[\r\n]|$)|(?:^|[\r\n])[\t ]*$/.test(e.value))}function Fd(e){const n=e.options.fence||"`";if(n!=="`"&&n!=="~")throw new Error("Cannot serialize code with `"+n+"` for `options.fence`, expected `` ` `` or `~`");return n}function zd(e,n,t,r){const s=Fd(t),a=e.value||"",o=s==="`"?"GraveAccent":"Tilde";if(Di(e,t)){const d=t.enter("codeIndented"),y=t.indentLines(a,qd);return d(),y}const l=t.createTracker(r),c=s.repeat(Math.max(Rd(a,s)+1,3)),u=t.enter("codeFenced");let m=l.move(c);if(e.lang){const d=t.enter(`codeFencedLang${o}`);m+=l.move(t.safe(e.lang,{before:m,after:" ",encode:["`"],...l.current()})),d()}if(e.lang&&e.meta){const d=t.enter(`codeFencedMeta${o}`);m+=l.move(" "),m+=l.move(t.safe(e.meta,{before:m,after:`
`,encode:["`"],...l.current()})),d()}return m+=l.move(`
`),a&&(m+=l.move(a+`
`)),m+=l.move(c),u(),m}function qd(e,n,t){return(t?"":"    ")+e}function Wi(e){const n=e.options.quote||'"';if(n!=='"'&&n!=="'")throw new Error("Cannot serialize title with `"+n+"` for `options.quote`, expected `\"`, or `'`");return n}function Bd(e,n,t,r){const s=Wi(t),a=s==='"'?"Quote":"Apostrophe",o=t.enter("definition");let l=t.enter("label");const c=t.createTracker(r);let u=c.move("[");return u+=c.move(t.safe(t.associationId(e),{before:u,after:"]",...c.current()})),u+=c.move("]: "),l(),!e.url||/[\0- \u007F]/.test(e.url)?(l=t.enter("destinationLiteral"),u+=c.move("<"),u+=c.move(t.safe(e.url,{before:u,after:">",...c.current()})),u+=c.move(">")):(l=t.enter("destinationRaw"),u+=c.move(t.safe(e.url,{before:u,after:e.title?" ":`
`,...c.current()}))),l(),e.title&&(l=t.enter(`title${a}`),u+=c.move(" "+s),u+=c.move(t.safe(e.title,{before:u,after:s,...c.current()})),u+=c.move(s),l()),o(),u}function Ud(e){const n=e.options.emphasis||"*";if(n!=="*"&&n!=="_")throw new Error("Cannot serialize emphasis with `"+n+"` for `options.emphasis`, expected `*`, or `_`");return n}function Bt(e){return"&#x"+e.toString(16).toUpperCase()+";"}function xr(e,n,t){const r=yr(e),s=yr(n);return r===void 0?s===void 0?t==="_"?{inside:!0,outside:!0}:{inside:!1,outside:!1}:s===1?{inside:!0,outside:!0}:{inside:!1,outside:!0}:r===1?s===void 0?{inside:!1,outside:!1}:s===1?{inside:!0,outside:!0}:{inside:!1,outside:!1}:s===void 0?{inside:!1,outside:!1}:s===1?{inside:!0,outside:!1}:{inside:!1,outside:!1}}vo.peek=Md;function vo(e,n,t,r){const s=Ud(t),a=t.enter("emphasis"),o=t.createTracker(r),l=o.move(s);let c=o.move(t.containerPhrasing(e,{after:s,before:l,...o.current()}));const u=c.charCodeAt(0),m=xr(r.before.charCodeAt(r.before.length-1),u,s);m.inside&&(c=Bt(u)+c.slice(1));const d=c.charCodeAt(c.length-1),y=xr(r.after.charCodeAt(0),d,s);y.inside&&(c=c.slice(0,-1)+Bt(d));const p=o.move(s);return a(),t.attentionEncodeSurroundingInfo={after:y.outside,before:m.outside},l+c+p}function Md(e,n,t){return t.options.emphasis||"*"}const Vi=function(e){if(e==null)return Jd;if(typeof e=="function")return _r(e);if(typeof e=="object")return Array.isArray(e)?Hd(e):Wd(e);if(typeof e=="string")return Vd(e);throw new Error("Expected function, string, or object as test")};function Hd(e){const n=[];let t=-1;for(;++t<e.length;)n[t]=Vi(e[t]);return _r(r);function r(...s){let a=-1;for(;++a<n.length;)if(n[a].apply(this,s))return!0;return!1}}function Wd(e){const n=e;return _r(t);function t(r){const s=r;let a;for(a in e)if(s[a]!==n[a])return!1;return!0}}function Vd(e){return _r(n);function n(t){return t&&t.type===e}}function _r(e){return n;function n(t,r,s){return!!(Qd(t)&&e.call(this,t,typeof r=="number"?r:void 0,s||void 0))}}function Jd(){return!0}function Qd(e){return e!==null&&typeof e=="object"&&"type"in e}const jo=[],Gd=!0,Ii=!1,Yd="skip";function Kd(e,n,t,r){let s;typeof n=="function"&&typeof t!="function"?(r=t,t=n):s=n;const a=Vi(s),o=r?-1:1;l(e,void 0,[])();function l(c,u,m){const d=c&&typeof c=="object"?c:{};if(typeof d.type=="string"){const p=typeof d.tagName=="string"?d.tagName:typeof d.name=="string"?d.name:void 0;Object.defineProperty(y,"name",{value:"node ("+(c.type+(p?"<"+p+">":""))+")"})}return y;function y(){let p=jo,E,q,G;if((!n||a(c,u,m[m.length-1]||void 0))&&(p=Zd(t(c,m)),p[0]===Ii))return p;if("children"in c&&c.children){const $=c;if($.children&&p[0]!==Yd)for(q=(r?$.children.length:-1)+o,G=m.concat($);q>-1&&q<$.children.length;){const B=$.children[q];if(E=l(B,q,G)(),E[0]===Ii)return E;q=typeof E[1]=="number"?E[1]:q+o}}return p}}}function Zd(e){return Array.isArray(e)?e:typeof e=="number"?[Gd,e]:e==null?jo:[e]}function Co(e,n,t,r){let s,a,o;typeof n=="function"?(a=void 0,o=n,s=t):(a=n,o=t,s=r),Kd(e,a,l,s);function l(c,u){const m=u[u.length-1],d=m?m.children.indexOf(c):void 0;return o(c,d,m)}}function So(e,n){let t=!1;return Co(e,function(r){if("value"in r&&/\r?\n|\r/.test(r.value)||r.type==="break")return t=!0,Ii}),!!((!e.depth||e.depth<3)&&Bi(e)&&(n.options.setext||t))}function Xd(e,n,t,r){const s=Math.max(Math.min(6,e.depth||1),1),a=t.createTracker(r);if(So(e,t)){const m=t.enter("headingSetext"),d=t.enter("phrasing"),y=t.containerPhrasing(e,{...a.current(),before:`
`,after:`
`});return d(),m(),y+`
`+(s===1?"=":"-").repeat(y.length-(Math.max(y.lastIndexOf("\r"),y.lastIndexOf(`
`))+1))}const o="#".repeat(s),l=t.enter("headingAtx"),c=t.enter("phrasing");a.move(o+" ");let u=t.containerPhrasing(e,{before:"# ",after:`
`,...a.current()});return/^[\t ]/.test(u)&&(u=Bt(u.charCodeAt(0))+u.slice(1)),u=u?o+" "+u:o,t.options.closeAtx&&(u+=" "+o),c(),l(),u}To.peek=ep;function To(e){return e.value||""}function ep(){return"<"}Po.peek=tp;function Po(e,n,t,r){const s=Wi(t),a=s==='"'?"Quote":"Apostrophe",o=t.enter("image");let l=t.enter("label");const c=t.createTracker(r);let u=c.move("![");return u+=c.move(t.safe(e.alt,{before:u,after:"]",...c.current()})),u+=c.move("]("),l(),!e.url&&e.title||/[\0- \u007F]/.test(e.url)?(l=t.enter("destinationLiteral"),u+=c.move("<"),u+=c.move(t.safe(e.url,{before:u,after:">",...c.current()})),u+=c.move(">")):(l=t.enter("destinationRaw"),u+=c.move(t.safe(e.url,{before:u,after:e.title?" ":")",...c.current()}))),l(),e.title&&(l=t.enter(`title${a}`),u+=c.move(" "+s),u+=c.move(t.safe(e.title,{before:u,after:s,...c.current()})),u+=c.move(s),l()),u+=c.move(")"),o(),u}function tp(){return"!"}Eo.peek=np;function Eo(e,n,t,r){const s=e.referenceType,a=t.enter("imageReference");let o=t.enter("label");const l=t.createTracker(r);let c=l.move("![");const u=t.safe(e.alt,{before:c,after:"]",...l.current()});c+=l.move(u+"]["),o();const m=t.stack;t.stack=[],o=t.enter("reference");const d=t.safe(t.associationId(e),{before:c,after:"]",...l.current()});return o(),t.stack=m,a(),s==="full"||!u||u!==d?c+=l.move(d+"]"):s==="shortcut"?c=c.slice(0,-1):c+=l.move("]"),c}function np(){return"!"}Ao.peek=rp;function Ao(e,n,t){let r=e.value||"",s="`",a=-1;for(;new RegExp("(^|[^`])"+s+"([^`]|$)").test(r);)s+="`";for(/[^ \r\n]/.test(r)&&(/^[ \r\n]/.test(r)&&/[ \r\n]$/.test(r)||/^`|`$/.test(r))&&(r=" "+r+" ");++a<t.unsafe.length;){const o=t.unsafe[a],l=t.compilePattern(o);let c;if(o.atBreak)for(;c=l.exec(r);){let u=c.index;r.charCodeAt(u)===10&&r.charCodeAt(u-1)===13&&u--,r=r.slice(0,u)+" "+r.slice(c.index+1)}}return s+r+s}function rp(){return"`"}function Do(e,n){const t=Bi(e);return!!(!n.options.resourceLink&&e.url&&!e.title&&e.children&&e.children.length===1&&e.children[0].type==="text"&&(t===e.url||"mailto:"+t===e.url)&&/^[a-z][a-z+.-]+:/i.test(e.url)&&!/[\0- <>\u007F]/.test(e.url))}Io.peek=ip;function Io(e,n,t,r){const s=Wi(t),a=s==='"'?"Quote":"Apostrophe",o=t.createTracker(r);let l,c;if(Do(e,t)){const m=t.stack;t.stack=[],l=t.enter("autolink");let d=o.move("<");return d+=o.move(t.containerPhrasing(e,{before:d,after:">",...o.current()})),d+=o.move(">"),l(),t.stack=m,d}l=t.enter("link"),c=t.enter("label");let u=o.move("[");return u+=o.move(t.containerPhrasing(e,{before:u,after:"](",...o.current()})),u+=o.move("]("),c(),!e.url&&e.title||/[\0- \u007F]/.test(e.url)?(c=t.enter("destinationLiteral"),u+=o.move("<"),u+=o.move(t.safe(e.url,{before:u,after:">",...o.current()})),u+=o.move(">")):(c=t.enter("destinationRaw"),u+=o.move(t.safe(e.url,{before:u,after:e.title?" ":")",...o.current()}))),c(),e.title&&(c=t.enter(`title${a}`),u+=o.move(" "+s),u+=o.move(t.safe(e.title,{before:u,after:s,...o.current()})),u+=o.move(s),c()),u+=o.move(")"),l(),u}function ip(e,n,t){return Do(e,t)?"<":"["}Oo.peek=ap;function Oo(e,n,t,r){const s=e.referenceType,a=t.enter("linkReference");let o=t.enter("label");const l=t.createTracker(r);let c=l.move("[");const u=t.containerPhrasing(e,{before:c,after:"]",...l.current()});c+=l.move(u+"]["),o();const m=t.stack;t.stack=[],o=t.enter("reference");const d=t.safe(t.associationId(e),{before:c,after:"]",...l.current()});return o(),t.stack=m,a(),s==="full"||!u||u!==d?c+=l.move(d+"]"):s==="shortcut"?c=c.slice(0,-1):c+=l.move("]"),c}function ap(){return"["}function Ji(e){const n=e.options.bullet||"*";if(n!=="*"&&n!=="+"&&n!=="-")throw new Error("Cannot serialize items with `"+n+"` for `options.bullet`, expected `*`, `+`, or `-`");return n}function sp(e){const n=Ji(e),t=e.options.bulletOther;if(!t)return n==="*"?"-":"*";if(t!=="*"&&t!=="+"&&t!=="-")throw new Error("Cannot serialize items with `"+t+"` for `options.bulletOther`, expected `*`, `+`, or `-`");if(t===n)throw new Error("Expected `bullet` (`"+n+"`) and `bulletOther` (`"+t+"`) to be different");return t}function op(e){const n=e.options.bulletOrdered||".";if(n!=="."&&n!==")")throw new Error("Cannot serialize items with `"+n+"` for `options.bulletOrdered`, expected `.` or `)`");return n}function $o(e){const n=e.options.rule||"*";if(n!=="*"&&n!=="-"&&n!=="_")throw new Error("Cannot serialize rules with `"+n+"` for `options.rule`, expected `*`, `-`, or `_`");return n}function lp(e,n,t,r){const s=t.enter("list"),a=t.bulletCurrent;let o=e.ordered?op(t):Ji(t);const l=e.ordered?o==="."?")":".":sp(t);let c=n&&t.bulletLastUsed?o===t.bulletLastUsed:!1;if(!e.ordered){const m=e.children?e.children[0]:void 0;if((o==="*"||o==="-")&&m&&(!m.children||!m.children[0])&&t.stack[t.stack.length-1]==="list"&&t.stack[t.stack.length-2]==="listItem"&&t.stack[t.stack.length-3]==="list"&&t.stack[t.stack.length-4]==="listItem"&&t.indexStack[t.indexStack.length-1]===0&&t.indexStack[t.indexStack.length-2]===0&&t.indexStack[t.indexStack.length-3]===0&&(c=!0),$o(t)===o&&m){let d=-1;for(;++d<e.children.length;){const y=e.children[d];if(y&&y.type==="listItem"&&y.children&&y.children[0]&&y.children[0].type==="thematicBreak"){c=!0;break}}}}c&&(o=l),t.bulletCurrent=o;const u=t.containerFlow(e,r);return t.bulletLastUsed=o,t.bulletCurrent=a,s(),u}function cp(e){const n=e.options.listItemIndent||"one";if(n!=="tab"&&n!=="one"&&n!=="mixed")throw new Error("Cannot serialize items with `"+n+"` for `options.listItemIndent`, expected `tab`, `one`, or `mixed`");return n}function up(e,n,t,r){const s=cp(t);let a=t.bulletCurrent||Ji(t);n&&n.type==="list"&&n.ordered&&(a=(typeof n.start=="number"&&n.start>-1?n.start:1)+(t.options.incrementListMarker===!1?0:n.children.indexOf(e))+a);let o=a.length+1;(s==="tab"||s==="mixed"&&(n&&n.type==="list"&&n.spread||e.spread))&&(o=Math.ceil(o/4)*4);const l=t.createTracker(r);l.move(a+" ".repeat(o-a.length)),l.shift(o);const c=t.enter("listItem"),u=t.indentLines(t.containerFlow(e,l.current()),m);return c(),u;function m(d,y,p){return y?(p?"":" ".repeat(o))+d:(p?a:a+" ".repeat(o-a.length))+d}}function dp(e,n,t,r){const s=t.enter("paragraph"),a=t.enter("phrasing"),o=t.containerPhrasing(e,r);return a(),s(),o}const pp=Vi(["break","delete","emphasis","footnote","footnoteReference","image","imageReference","inlineCode","inlineMath","link","linkReference","mdxJsxTextElement","mdxTextExpression","strong","text","textDirective"]);function hp(e,n,t,r){return(e.children.some(function(o){return pp(o)})?t.containerPhrasing:t.containerFlow).call(t,e,r)}function mp(e){const n=e.options.strong||"*";if(n!=="*"&&n!=="_")throw new Error("Cannot serialize strong with `"+n+"` for `options.strong`, expected `*`, or `_`");return n}Lo.peek=fp;function Lo(e,n,t,r){const s=mp(t),a=t.enter("strong"),o=t.createTracker(r),l=o.move(s+s);let c=o.move(t.containerPhrasing(e,{after:s,before:l,...o.current()}));const u=c.charCodeAt(0),m=xr(r.before.charCodeAt(r.before.length-1),u,s);m.inside&&(c=Bt(u)+c.slice(1));const d=c.charCodeAt(c.length-1),y=xr(r.after.charCodeAt(0),d,s);y.inside&&(c=c.slice(0,-1)+Bt(d));const p=o.move(s+s);return a(),t.attentionEncodeSurroundingInfo={after:y.outside,before:m.outside},l+c+p}function fp(e,n,t){return t.options.strong||"*"}function gp(e,n,t,r){return t.safe(e.value,r)}function yp(e){const n=e.options.ruleRepetition||3;if(n<3)throw new Error("Cannot serialize rules with repetition `"+n+"` for `options.ruleRepetition`, expected `3` or more");return n}function xp(e,n,t){const r=($o(t)+(t.options.ruleSpaces?" ":"")).repeat(yp(t));return t.options.ruleSpaces?r.slice(0,-1):r}const bp={blockquote:$d,break:js,code:zd,definition:Bd,emphasis:vo,hardBreak:js,heading:Xd,html:To,image:Po,imageReference:Eo,inlineCode:Ao,link:Io,linkReference:Oo,list:lp,listItem:up,paragraph:dp,root:hp,strong:Lo,text:gp,thematicBreak:xp},wp=[kp];function kp(e,n,t,r){if(n.type==="code"&&Di(n,r)&&(e.type==="list"||e.type===n.type&&Di(e,r)))return!1;if("spread"in t&&typeof t.spread=="boolean")return e.type==="paragraph"&&(e.type===n.type||n.type==="definition"||n.type==="heading"&&So(n,r))?void 0:t.spread?1:0}const Vt=["autolink","destinationLiteral","destinationRaw","reference","titleQuote","titleApostrophe"],_p=[{character:"	",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",before:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"\r",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:`
`,inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:" ",after:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",before:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"!",after:"\\[",inConstruct:"phrasing",notInConstruct:Vt},{character:'"',inConstruct:"titleQuote"},{atBreak:!0,character:"#"},{character:"#",inConstruct:"headingAtx",after:`(?:[\r
]|$)`},{character:"&",after:"[#A-Za-z]",inConstruct:"phrasing"},{character:"'",inConstruct:"titleApostrophe"},{character:"(",inConstruct:"destinationRaw"},{before:"\\]",character:"(",inConstruct:"phrasing",notInConstruct:Vt},{atBreak:!0,before:"\\d+",character:")"},{character:")",inConstruct:"destinationRaw"},{atBreak:!0,character:"*",after:`(?:[ 	\r
*])`},{character:"*",inConstruct:"phrasing",notInConstruct:Vt},{atBreak:!0,character:"+",after:`(?:[ 	\r
])`},{atBreak:!0,character:"-",after:`(?:[ 	\r
-])`},{atBreak:!0,before:"\\d+",character:".",after:`(?:[ 	\r
]|$)`},{atBreak:!0,character:"<",after:"[!/?A-Za-z]"},{character:"<",after:"[!/?A-Za-z]",inConstruct:"phrasing",notInConstruct:Vt},{character:"<",inConstruct:"destinationLiteral"},{atBreak:!0,character:"="},{atBreak:!0,character:">"},{character:">",inConstruct:"destinationLiteral"},{atBreak:!0,character:"["},{character:"[",inConstruct:"phrasing",notInConstruct:Vt},{character:"[",inConstruct:["label","reference"]},{character:"\\",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"]",inConstruct:["label","reference"]},{atBreak:!0,character:"_"},{character:"_",inConstruct:"phrasing",notInConstruct:Vt},{atBreak:!0,character:"`"},{character:"`",inConstruct:["codeFencedLangGraveAccent","codeFencedMetaGraveAccent"]},{character:"`",inConstruct:"phrasing",notInConstruct:Vt},{atBreak:!0,character:"~"}];function Np(e){return e.label||!e.identifier?e.label||"":xo(e.identifier)}function vp(e){if(!e._compiled){const n=(e.atBreak?"[\\r\\n][\\t ]*":"")+(e.before?"(?:"+e.before+")":"");e._compiled=new RegExp((n?"("+n+")":"")+(/[|\\{}()[\]^$+*?.-]/.test(e.character)?"\\":"")+e.character+(e.after?"(?:"+e.after+")":""),"g")}return e._compiled}function jp(e,n,t){const r=n.indexStack,s=e.children||[],a=[];let o=-1,l=t.before,c;r.push(-1);let u=n.createTracker(t);for(;++o<s.length;){const m=s[o];let d;if(r[r.length-1]=o,o+1<s.length){let E=n.handle.handlers[s[o+1].type];E&&E.peek&&(E=E.peek),d=E?E(s[o+1],e,n,{before:"",after:"",...u.current()}).charAt(0):""}else d=t.after;a.length>0&&(l==="\r"||l===`
`)&&m.type==="html"&&(a[a.length-1]=a[a.length-1].replace(/(\r?\n|\r)$/," "),l=" ",u=n.createTracker(t),u.move(a.join("")));let y=n.handle(m,e,n,{...u.current(),after:d,before:l});c&&c===y.slice(0,1)&&(y=Bt(c.charCodeAt(0))+y.slice(1));const p=n.attentionEncodeSurroundingInfo;n.attentionEncodeSurroundingInfo=void 0,c=void 0,p&&(a.length>0&&p.before&&l===a[a.length-1].slice(-1)&&(a[a.length-1]=a[a.length-1].slice(0,-1)+Bt(l.charCodeAt(0))),p.after&&(c=d)),u.move(y),a.push(y),l=y.slice(-1)}return r.pop(),a.join("")}function Cp(e,n,t){const r=n.indexStack,s=e.children||[],a=n.createTracker(t),o=[];let l=-1;for(r.push(-1);++l<s.length;){const c=s[l];r[r.length-1]=l,o.push(a.move(n.handle(c,e,n,{before:`
`,after:`
`,...a.current()}))),c.type!=="list"&&(n.bulletLastUsed=void 0),l<s.length-1&&o.push(a.move(Sp(c,s[l+1],e,n)))}return r.pop(),o.join("")}function Sp(e,n,t,r){let s=r.join.length;for(;s--;){const a=r.join[s](e,n,t,r);if(a===!0||a===1)break;if(typeof a=="number")return`
`.repeat(1+a);if(a===!1)return`

<!---->

`}return`

`}const Tp=/\r?\n|\r/g;function Pp(e,n){const t=[];let r=0,s=0,a;for(;a=Tp.exec(e);)o(e.slice(r,a.index)),t.push(a[0]),r=a.index+a[0].length,s++;return o(e.slice(r)),t.join("");function o(l){t.push(n(l,s,!l))}}function Ep(e,n,t){const r=(t.before||"")+(n||"")+(t.after||""),s=[],a=[],o={};let l=-1;for(;++l<e.unsafe.length;){const m=e.unsafe[l];if(!No(e.stack,m))continue;const d=e.compilePattern(m);let y;for(;y=d.exec(r);){const p="before"in m||!!m.atBreak,E="after"in m,q=y.index+(p?y[1].length:0);s.includes(q)?(o[q].before&&!p&&(o[q].before=!1),o[q].after&&!E&&(o[q].after=!1)):(s.push(q),o[q]={before:p,after:E})}}s.sort(Ap);let c=t.before?t.before.length:0;const u=r.length-(t.after?t.after.length:0);for(l=-1;++l<s.length;){const m=s[l];m<c||m>=u||m+1<u&&s[l+1]===m+1&&o[m].after&&!o[m+1].before&&!o[m+1].after||s[l-1]===m-1&&o[m].before&&!o[m-1].before&&!o[m-1].after||(c!==m&&a.push(Cs(r.slice(c,m),"\\")),c=m,/[!-/:-@[-`{-~]/.test(r.charAt(m))&&(!t.encode||!t.encode.includes(r.charAt(m)))?a.push("\\"):(a.push(Bt(r.charCodeAt(m))),c++))}return a.push(Cs(r.slice(c,u),t.after)),a.join("")}function Ap(e,n){return e-n}function Cs(e,n){const t=/\\(?=[!-/:-@[-`{-~])/g,r=[],s=[],a=e+n;let o=-1,l=0,c;for(;c=t.exec(a);)r.push(c.index);for(;++o<r.length;)l!==r[o]&&s.push(e.slice(l,r[o])),s.push("\\"),l=r[o];return s.push(e.slice(l)),s.join("")}function Dp(e){const n=e||{},t=n.now||{};let r=n.lineShift||0,s=t.line||1,a=t.column||1;return{move:c,current:o,shift:l};function o(){return{now:{line:s,column:a},lineShift:r}}function l(u){r+=u}function c(u){const m=u||"",d=m.split(/\r?\n|\r/g),y=d[d.length-1];return s+=d.length-1,a=d.length===1?a+y.length:1+y.length+r,m}}function Ip(e,n){const t=n||{},r={associationId:Np,containerPhrasing:Rp,containerFlow:Fp,createTracker:Dp,compilePattern:vp,enter:a,handlers:{...bp},handle:void 0,indentLines:Pp,indexStack:[],join:[...wp],options:{},safe:zp,stack:[],unsafe:[..._p]};_o(r,t),r.options.tightDefinitions&&r.join.push(Lp),r.handle=ko("type",{invalid:Op,unknown:$p,handlers:r.handlers});let s=r.handle(e,void 0,r,{before:`
`,after:`
`,now:{line:1,column:1},lineShift:0});return s&&s.charCodeAt(s.length-1)!==10&&s.charCodeAt(s.length-1)!==13&&(s+=`
`),s;function a(o){return r.stack.push(o),l;function l(){r.stack.pop()}}}function Op(e){throw new Error("Cannot handle value `"+e+"`, expected node")}function $p(e){const n=e;throw new Error("Cannot handle unknown node `"+n.type+"`")}function Lp(e,n){if(e.type==="definition"&&e.type===n.type)return 0}function Rp(e,n){return jp(e,this,n)}function Fp(e,n){return Cp(e,this,n)}function zp(e,n){return Ep(this,e,n)}function qp(e){const n=this;n.compiler=t;function t(r){return Ip(r,{...n.data("settings"),...e,extensions:n.data("toMarkdownExtensions")||[]})}}function Ss(e){if(e)throw e}var ui,Ts;function Bp(){if(Ts)return ui;Ts=1;var e=Object.prototype.hasOwnProperty,n=Object.prototype.toString,t=Object.defineProperty,r=Object.getOwnPropertyDescriptor,s=function(u){return typeof Array.isArray=="function"?Array.isArray(u):n.call(u)==="[object Array]"},a=function(u){if(!u||n.call(u)!=="[object Object]")return!1;var m=e.call(u,"constructor"),d=u.constructor&&u.constructor.prototype&&e.call(u.constructor.prototype,"isPrototypeOf");if(u.constructor&&!m&&!d)return!1;var y;for(y in u);return typeof y>"u"||e.call(u,y)},o=function(u,m){t&&m.name==="__proto__"?t(u,m.name,{enumerable:!0,configurable:!0,value:m.newValue,writable:!0}):u[m.name]=m.newValue},l=function(u,m){if(m==="__proto__")if(e.call(u,m)){if(r)return r(u,m).value}else return;return u[m]};return ui=function c(){var u,m,d,y,p,E,q=arguments[0],G=1,$=arguments.length,B=!1;for(typeof q=="boolean"&&(B=q,q=arguments[1]||{},G=2),(q==null||typeof q!="object"&&typeof q!="function")&&(q={});G<$;++G)if(u=arguments[G],u!=null)for(m in u)d=l(q,m),y=l(u,m),q!==y&&(B&&y&&(a(y)||(p=s(y)))?(p?(p=!1,E=d&&s(d)?d:[]):E=d&&a(d)?d:{},o(q,{name:m,newValue:c(B,E,y)})):typeof y<"u"&&o(q,{name:m,newValue:y}));return q},ui}var Up=Bp();const di=oc(Up);function Oi(e){if(typeof e!="object"||e===null)return!1;const n=Object.getPrototypeOf(e);return(n===null||n===Object.prototype||Object.getPrototypeOf(n)===null)&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)}function Mp(){const e=[],n={run:t,use:r};return n;function t(...s){let a=-1;const o=s.pop();if(typeof o!="function")throw new TypeError("Expected function as last argument, not "+o);l(null,...s);function l(c,...u){const m=e[++a];let d=-1;if(c){o(c);return}for(;++d<s.length;)(u[d]===null||u[d]===void 0)&&(u[d]=s[d]);s=u,m?Hp(m,l)(...u):o(null,...u)}}function r(s){if(typeof s!="function")throw new TypeError("Expected `middelware` to be a function, not "+s);return e.push(s),n}}function Hp(e,n){let t;return r;function r(...o){const l=e.length>o.length;let c;l&&o.push(s);try{c=e.apply(this,o)}catch(u){const m=u;if(l&&t)throw m;return s(m)}l||(c&&c.then&&typeof c.then=="function"?c.then(a,s):c instanceof Error?s(c):a(c))}function s(o,...l){t||(t=!0,n(o,...l))}function a(o){s(null,o)}}class Ze extends Error{constructor(n,t,r){super(),typeof t=="string"&&(r=t,t=void 0);let s="",a={},o=!1;if(t&&("line"in t&&"column"in t?a={place:t}:"start"in t&&"end"in t?a={place:t}:"type"in t?a={ancestors:[t],place:t.position}:a={...t}),typeof n=="string"?s=n:!a.cause&&n&&(o=!0,s=n.message,a.cause=n),!a.ruleId&&!a.source&&typeof r=="string"){const c=r.indexOf(":");c===-1?a.ruleId=r:(a.source=r.slice(0,c),a.ruleId=r.slice(c+1))}if(!a.place&&a.ancestors&&a.ancestors){const c=a.ancestors[a.ancestors.length-1];c&&(a.place=c.position)}const l=a.place&&"start"in a.place?a.place.start:a.place;this.ancestors=a.ancestors||void 0,this.cause=a.cause||void 0,this.column=l?l.column:void 0,this.fatal=void 0,this.file="",this.message=s,this.line=l?l.line:void 0,this.name=Fn(a.place)||"1:1",this.place=a.place||void 0,this.reason=this.message,this.ruleId=a.ruleId||void 0,this.source=a.source||void 0,this.stack=o&&a.cause&&typeof a.cause.stack=="string"?a.cause.stack:"",this.actual=void 0,this.expected=void 0,this.note=void 0,this.url=void 0}}Ze.prototype.file="";Ze.prototype.name="";Ze.prototype.reason="";Ze.prototype.message="";Ze.prototype.stack="";Ze.prototype.column=void 0;Ze.prototype.line=void 0;Ze.prototype.ancestors=void 0;Ze.prototype.cause=void 0;Ze.prototype.fatal=void 0;Ze.prototype.place=void 0;Ze.prototype.ruleId=void 0;Ze.prototype.source=void 0;const _t={basename:Wp,dirname:Vp,extname:Jp,join:Qp,sep:"/"};function Wp(e,n){if(n!==void 0&&typeof n!="string")throw new TypeError('"ext" argument must be a string');Bn(e);let t=0,r=-1,s=e.length,a;if(n===void 0||n.length===0||n.length>e.length){for(;s--;)if(e.codePointAt(s)===47){if(a){t=s+1;break}}else r<0&&(a=!0,r=s+1);return r<0?"":e.slice(t,r)}if(n===e)return"";let o=-1,l=n.length-1;for(;s--;)if(e.codePointAt(s)===47){if(a){t=s+1;break}}else o<0&&(a=!0,o=s+1),l>-1&&(e.codePointAt(s)===n.codePointAt(l--)?l<0&&(r=s):(l=-1,r=o));return t===r?r=o:r<0&&(r=e.length),e.slice(t,r)}function Vp(e){if(Bn(e),e.length===0)return".";let n=-1,t=e.length,r;for(;--t;)if(e.codePointAt(t)===47){if(r){n=t;break}}else r||(r=!0);return n<0?e.codePointAt(0)===47?"/":".":n===1&&e.codePointAt(0)===47?"//":e.slice(0,n)}function Jp(e){Bn(e);let n=e.length,t=-1,r=0,s=-1,a=0,o;for(;n--;){const l=e.codePointAt(n);if(l===47){if(o){r=n+1;break}continue}t<0&&(o=!0,t=n+1),l===46?s<0?s=n:a!==1&&(a=1):s>-1&&(a=-1)}return s<0||t<0||a===0||a===1&&s===t-1&&s===r+1?"":e.slice(s,t)}function Qp(...e){let n=-1,t;for(;++n<e.length;)Bn(e[n]),e[n]&&(t=t===void 0?e[n]:t+"/"+e[n]);return t===void 0?".":Gp(t)}function Gp(e){Bn(e);const n=e.codePointAt(0)===47;let t=Yp(e,!n);return t.length===0&&!n&&(t="."),t.length>0&&e.codePointAt(e.length-1)===47&&(t+="/"),n?"/"+t:t}function Yp(e,n){let t="",r=0,s=-1,a=0,o=-1,l,c;for(;++o<=e.length;){if(o<e.length)l=e.codePointAt(o);else{if(l===47)break;l=47}if(l===47){if(!(s===o-1||a===1))if(s!==o-1&&a===2){if(t.length<2||r!==2||t.codePointAt(t.length-1)!==46||t.codePointAt(t.length-2)!==46){if(t.length>2){if(c=t.lastIndexOf("/"),c!==t.length-1){c<0?(t="",r=0):(t=t.slice(0,c),r=t.length-1-t.lastIndexOf("/")),s=o,a=0;continue}}else if(t.length>0){t="",r=0,s=o,a=0;continue}}n&&(t=t.length>0?t+"/..":"..",r=2)}else t.length>0?t+="/"+e.slice(s+1,o):t=e.slice(s+1,o),r=o-s-1;s=o,a=0}else l===46&&a>-1?a++:a=-1}return t}function Bn(e){if(typeof e!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}const Kp={cwd:Zp};function Zp(){return"/"}function $i(e){return!!(e!==null&&typeof e=="object"&&"href"in e&&e.href&&"protocol"in e&&e.protocol&&e.auth===void 0)}function Xp(e){if(typeof e=="string")e=new URL(e);else if(!$i(e)){const n=new TypeError('The "path" argument must be of type string or an instance of URL. Received `'+e+"`");throw n.code="ERR_INVALID_ARG_TYPE",n}if(e.protocol!=="file:"){const n=new TypeError("The URL must be of scheme file");throw n.code="ERR_INVALID_URL_SCHEME",n}return eh(e)}function eh(e){if(e.hostname!==""){const r=new TypeError('File URL host must be "localhost" or empty on darwin');throw r.code="ERR_INVALID_FILE_URL_HOST",r}const n=e.pathname;let t=-1;for(;++t<n.length;)if(n.codePointAt(t)===37&&n.codePointAt(t+1)===50){const r=n.codePointAt(t+2);if(r===70||r===102){const s=new TypeError("File URL path must not include encoded / characters");throw s.code="ERR_INVALID_FILE_URL_PATH",s}}return decodeURIComponent(n)}const pi=["history","path","basename","stem","extname","dirname"];class th{constructor(n){let t;n?$i(n)?t={path:n}:typeof n=="string"||nh(n)?t={value:n}:t=n:t={},this.cwd="cwd"in t?"":Kp.cwd(),this.data={},this.history=[],this.messages=[],this.value,this.map,this.result,this.stored;let r=-1;for(;++r<pi.length;){const a=pi[r];a in t&&t[a]!==void 0&&t[a]!==null&&(this[a]=a==="history"?[...t[a]]:t[a])}let s;for(s in t)pi.includes(s)||(this[s]=t[s])}get basename(){return typeof this.path=="string"?_t.basename(this.path):void 0}set basename(n){mi(n,"basename"),hi(n,"basename"),this.path=_t.join(this.dirname||"",n)}get dirname(){return typeof this.path=="string"?_t.dirname(this.path):void 0}set dirname(n){Ps(this.basename,"dirname"),this.path=_t.join(n||"",this.basename)}get extname(){return typeof this.path=="string"?_t.extname(this.path):void 0}set extname(n){if(hi(n,"extname"),Ps(this.dirname,"extname"),n){if(n.codePointAt(0)!==46)throw new Error("`extname` must start with `.`");if(n.includes(".",1))throw new Error("`extname` cannot contain multiple dots")}this.path=_t.join(this.dirname,this.stem+(n||""))}get path(){return this.history[this.history.length-1]}set path(n){$i(n)&&(n=Xp(n)),mi(n,"path"),this.path!==n&&this.history.push(n)}get stem(){return typeof this.path=="string"?_t.basename(this.path,this.extname):void 0}set stem(n){mi(n,"stem"),hi(n,"stem"),this.path=_t.join(this.dirname||"",n+(this.extname||""))}fail(n,t,r){const s=this.message(n,t,r);throw s.fatal=!0,s}info(n,t,r){const s=this.message(n,t,r);return s.fatal=void 0,s}message(n,t,r){const s=new Ze(n,t,r);return this.path&&(s.name=this.path+":"+s.name,s.file=this.path),s.fatal=!1,this.messages.push(s),s}toString(n){return this.value===void 0?"":typeof this.value=="string"?this.value:new TextDecoder(n||void 0).decode(this.value)}}function hi(e,n){if(e&&e.includes(_t.sep))throw new Error("`"+n+"` cannot be a path: did not expect `"+_t.sep+"`")}function mi(e,n){if(!e)throw new Error("`"+n+"` cannot be empty")}function Ps(e,n){if(!e)throw new Error("Setting `"+n+"` requires `path` to be set too")}function nh(e){return!!(e&&typeof e=="object"&&"byteLength"in e&&"byteOffset"in e)}const rh=function(e){const r=this.constructor.prototype,s=r[e],a=function(){return s.apply(a,arguments)};return Object.setPrototypeOf(a,r),a},ih={}.hasOwnProperty;class Qi extends rh{constructor(){super("copy"),this.Compiler=void 0,this.Parser=void 0,this.attachers=[],this.compiler=void 0,this.freezeIndex=-1,this.frozen=void 0,this.namespace={},this.parser=void 0,this.transformers=Mp()}copy(){const n=new Qi;let t=-1;for(;++t<this.attachers.length;){const r=this.attachers[t];n.use(...r)}return n.data(di(!0,{},this.namespace)),n}data(n,t){return typeof n=="string"?arguments.length===2?(yi("data",this.frozen),this.namespace[n]=t,this):ih.call(this.namespace,n)&&this.namespace[n]||void 0:n?(yi("data",this.frozen),this.namespace=n,this):this.namespace}freeze(){if(this.frozen)return this;const n=this;for(;++this.freezeIndex<this.attachers.length;){const[t,...r]=this.attachers[this.freezeIndex];if(r[0]===!1)continue;r[0]===!0&&(r[0]=void 0);const s=t.call(n,...r);typeof s=="function"&&this.transformers.use(s)}return this.frozen=!0,this.freezeIndex=Number.POSITIVE_INFINITY,this}parse(n){this.freeze();const t=ur(n),r=this.parser||this.Parser;return fi("parse",r),r(String(t),t)}process(n,t){const r=this;return this.freeze(),fi("process",this.parser||this.Parser),gi("process",this.compiler||this.Compiler),t?s(void 0,t):new Promise(s);function s(a,o){const l=ur(n),c=r.parse(l);r.run(c,l,function(m,d,y){if(m||!d||!y)return u(m);const p=d,E=r.stringify(p,y);oh(E)?y.value=E:y.result=E,u(m,y)});function u(m,d){m||!d?o(m):a?a(d):t(void 0,d)}}}processSync(n){let t=!1,r;return this.freeze(),fi("processSync",this.parser||this.Parser),gi("processSync",this.compiler||this.Compiler),this.process(n,s),As("processSync","process",t),r;function s(a,o){t=!0,Ss(a),r=o}}run(n,t,r){Es(n),this.freeze();const s=this.transformers;return!r&&typeof t=="function"&&(r=t,t=void 0),r?a(void 0,r):new Promise(a);function a(o,l){const c=ur(t);s.run(n,c,u);function u(m,d,y){const p=d||n;m?l(m):o?o(p):r(void 0,p,y)}}}runSync(n,t){let r=!1,s;return this.run(n,t,a),As("runSync","run",r),s;function a(o,l){Ss(o),s=l,r=!0}}stringify(n,t){this.freeze();const r=ur(t),s=this.compiler||this.Compiler;return gi("stringify",s),Es(n),s(n,r)}use(n,...t){const r=this.attachers,s=this.namespace;if(yi("use",this.frozen),n!=null)if(typeof n=="function")c(n,t);else if(typeof n=="object")Array.isArray(n)?l(n):o(n);else throw new TypeError("Expected usable value, not `"+n+"`");return this;function a(u){if(typeof u=="function")c(u,[]);else if(typeof u=="object")if(Array.isArray(u)){const[m,...d]=u;c(m,d)}else o(u);else throw new TypeError("Expected usable value, not `"+u+"`")}function o(u){if(!("plugins"in u)&&!("settings"in u))throw new Error("Expected usable value but received an empty preset, which is probably a mistake: presets typically come with `plugins` and sometimes with `settings`, but this has neither");l(u.plugins),u.settings&&(s.settings=di(!0,s.settings,u.settings))}function l(u){let m=-1;if(u!=null)if(Array.isArray(u))for(;++m<u.length;){const d=u[m];a(d)}else throw new TypeError("Expected a list of plugins, not `"+u+"`")}function c(u,m){let d=-1,y=-1;for(;++d<r.length;)if(r[d][0]===u){y=d;break}if(y===-1)r.push([u,...m]);else if(m.length>0){let[p,...E]=m;const q=r[y][1];Oi(q)&&Oi(p)&&(p=di(!0,q,p)),r[y]=[u,p,...E]}}}}const ah=new Qi().freeze();function fi(e,n){if(typeof n!="function")throw new TypeError("Cannot `"+e+"` without `parser`")}function gi(e,n){if(typeof n!="function")throw new TypeError("Cannot `"+e+"` without `compiler`")}function yi(e,n){if(n)throw new Error("Cannot call `"+e+"` on a frozen processor.\nCreate a new processor first, by calling it: use `processor()` instead of `processor`.")}function Es(e){if(!Oi(e)||typeof e.type!="string")throw new TypeError("Expected node, got `"+e+"`")}function As(e,n,t){if(!t)throw new Error("`"+e+"` finished async. Use `"+n+"` instead")}function ur(e){return sh(e)?e:new th(e)}function sh(e){return!!(e&&typeof e=="object"&&"message"in e&&"messages"in e)}function oh(e){return typeof e=="string"||lh(e)}function lh(e){return!!(e&&typeof e=="object"&&"byteLength"in e&&"byteOffset"in e)}const xi=ah().use(Dd).use(qp).freeze(),ch=e=>{if(!e)return"Unknown Date";try{return new Date(e).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}catch{return"Invalid Date"}},uh=e=>{switch(e){case"pending":return{text:"Billing Pending",className:"status-badge status-pending"};case"billed":return{text:"Sample Pending",className:"status-badge status-billed"};case"collected":return{text:"Sample Collected",className:"status-badge status-collected"};case"processing":return{text:"Processing",className:"status-badge status-processing"};case"report_ready":return{text:"Report Ready",className:"status-badge status-report_ready"};case"reported":return{text:"Reported",className:"status-badge status-reported"};case"completed":return{text:"Completed",className:"status-badge status-completed"};case"cancelled":return{text:"Cancelled",className:"status-badge status-cancelled"};default:return{text:e,className:"status-badge"}}},dh=({title:e,items:n,renderItemContent:t,headerAction:r,isLoading:s,loadingText:a,noDataText:o,onDeleteItem:l,onEditLabOrder:c,onSaveLabOrder:u,onCancelEditLabOrder:m,onLabOrderTestChange:d,onLabOrderStatusChange:y,onEditPharmacyOrder:p,onPrintUnavailablePrescription:E,onBillLabOrder:q,onUpdateLabOrderStatus:G,onEnterLabReport:$,labInventory:B=[],isSavingLabOrder:I=!1,expandedLabReports:W={},toggleLabReport:F=()=>{},selectionEnabled:j=!1,selectedIds:X=new Set,onSelectionChange:ce})=>{const ne=x.useMemo(()=>{const V={};n.forEach(C=>{if(isNaN(C.date.getTime())){V["Unknown Date"]||(V["Unknown Date"]=[]),V["Unknown Date"].push(C);return}const K=ch(C.originalDateString);V[K]||(V[K]=[]),V[K].push(C)});const _=Object.keys(V);return _.sort((C,K)=>{if(C==="Unknown Date")return 1;if(K==="Unknown Date")return-1;try{const A=new Date(C.split(" ").reverse().join(" ")),M=new Date(K.split(" ").reverse().join(" "));if(!isNaN(A.getTime())&&!isNaN(M.getTime()))return M.getTime()-A.getTime()}catch{}return K.localeCompare(C)}),_.map(C=>({date:C,items:V[C]}))},[n]),le=["pending","billed","collected","processing","report_ready","completed","cancelled","reported"];return i.jsxs("div",{className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsx("h4",{className:"ai-context-section-title mb-2 pb-1",children:e}),r]}),s&&i.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(V=>i.jsxs("div",{style:{padding:"10px",background:"var(--glass-light)",borderRadius:"8px",marginBottom:"8px"},children:[i.jsx(Te,{width:"80px",height:"14px",style:{marginBottom:"10px"}}),i.jsx(Te,{width:"100%",height:"16px",style:{marginBottom:"6px"}}),i.jsx(Te,{width:"70%",height:"14px"})]},V))}),!s&&n.length===0&&i.jsx("p",{className:"ai-context-text italic",children:o}),!s&&n.length>0&&i.jsx("div",{className:"space-y-3",children:ne.map(({date:V,items:_})=>i.jsxs("div",{children:[i.jsx("h5",{className:"grouped-history-date",children:V}),i.jsx("div",{className:"space-y-1 grouped-history-item-container",children:_.map((C,K)=>i.jsxs("div",{className:"grouped-history-item ai-context-item flex flex-col",children:[!(C.type==="Lab Order"&&C.data.isEditing)&&i.jsxs("div",{className:"flex justify-between items-center w-full",children:[j&&ce&&C.type==="Pharmacy Order"&&i.jsx("div",{className:"mr-2",children:i.jsx("input",{type:"checkbox",checked:X.has(C.data.id),onChange:A=>ce(C.data.id,A.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),i.jsx("div",{className:"flex-grow mr-2 ai-context-text",children:t(C,K,W,F)}),i.jsxs("div",{className:"flex items-center space-x-1",children:[C.type==="Lab Order"&&!C.data.isEditing&&c&&i.jsx("button",{onClick:()=>c(C.data.id),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400",title:"Edit this lab order",disabled:I,children:i.jsx(ft,{size:14})}),C.type==="Lab Order"&&C.data.isEditing&&i.jsx(i.Fragment,{}),C.type==="Lab Order"&&i.jsxs("div",{className:"lab-table-actions",children:[C.data.status==="pending"&&q&&(()=>{const A=C.data.tests.reduce((M,J)=>M+(Number(J.price)||0),0).toFixed(2);return i.jsx("button",{onClick:()=>q(C.data),className:"text-green-600 hover:text-green-800 p-1 rounded hover:bg-green-100 focus:outline-none focus:ring-1 focus:ring-green-400",title:`Pay total of ₹${A}`,disabled:I,children:i.jsx(ao,{size:14})})})(),C.data.status==="billed"&&G&&i.jsx("button",{onClick:()=>G(C.data.id,"collected"),className:"lab-action-button btn-collect",title:"Collect Sample",children:"Collect"}),C.data.status==="collected"&&G&&i.jsx("button",{onClick:()=>G(C.data.id,"processing"),className:"lab-action-button btn-process",title:"Mark Processing",children:"Process"}),["pending","billed","collected","processing","report_ready","reported","completed"].includes(C.data.status)&&$&&i.jsx("button",{onClick:()=>$(C.data),className:"lab-action-button btn-enter-report",title:"Enter Report",children:"Enter Report"}),(C.data.status==="report_ready"||C.data.status==="reported")&&G&&i.jsx("button",{onClick:()=>G(C.data.id,"completed"),className:"lab-action-button btn-complete",title:"Mark Completed",children:"Complete"})]}),C.type==="Pharmacy Order"&&C.data.status==="pending"&&p&&i.jsx("button",{onClick:()=>p(C.data.id),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400",title:"Edit this pharmacy order",disabled:I,children:i.jsx(ft,{size:14})}),C.type==="Pharmacy Order"&&C.data.prescriptionForUnavailableDrugs&&E&&i.jsx("button",{onClick:()=>E(C.data.prescriptionForUnavailableDrugs,`Prescription for Order ${C.data.id}`),className:"text-purple-600 hover:text-purple-800 p-1 rounded hover:bg-purple-100 focus:outline-none focus:ring-1 focus:ring-purple-400",title:"Print Prescription for Unavailable Drugs",disabled:I,children:i.jsx(Ln,{size:14})}),C.type==="Pharmacy Order"&&C.data.status==="pending"&&l&&i.jsx("button",{onClick:()=>l({type:C.type,data:C.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400",title:"Delete this pending pharmacy order",disabled:I,children:i.jsx(gt,{size:14})}),l&&["Complaint","Lab Order","Lab Report"].includes(C.type)&&i.jsx("button",{onClick:()=>l({type:C.type,data:C.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400",title:`Delete this ${C.type.toLowerCase()}`,disabled:I,children:i.jsx(gt,{size:14})})]})]}),C.type==="Lab Order"&&C.data.isEditing&&i.jsxs("div",{className:"lab-order-edit-form w-full bg-gray-50 border rounded-md p-3",children:[i.jsxs("div",{className:"flex justify-between items-center mb-3",children:[i.jsx("h6",{className:"text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Edit Order"}),i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Status:"}),i.jsx("select",{value:C.data.editedStatus||C.data.status,onChange:A=>y&&y(C.data.id,A.target.value),className:"form-select text-xs py-1 pl-2 pr-6 rounded border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50",disabled:I,children:le.map(A=>i.jsx("option",{value:A,children:A.replace(/_/g," ")},A))})]})]}),i.jsx("div",{className:"overflow-hidden border rounded-md bg-white mb-3",children:i.jsxs("table",{className:"w-full text-xs text-left",children:[i.jsx("thead",{className:"bg-gray-100 border-b",children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-2 px-3 font-medium text-gray-600",children:"Test Name"}),i.jsx("th",{className:"py-2 px-3 text-right font-medium text-gray-600 w-20",children:"Price"}),i.jsx("th",{className:"py-2 px-3 w-10"})]})}),i.jsxs("tbody",{className:"divide-y divide-gray-100",children:[C.data.editedTests.map((A,M)=>i.jsxs("tr",{className:"hover:bg-gray-50",children:[i.jsx("td",{className:"py-1 px-3",children:i.jsxs("select",{value:A.id,onChange:J=>{const Se=B.find(me=>String(me.id)===J.target.value);Se&&(d&&d(C.data.id,M,"id",Se.id),d&&d(C.data.id,M,"name",Se.name),d&&d(C.data.id,M,"price",Se.price))},className:"form-select w-full text-xs border-0 bg-transparent focus:ring-0 p-0",disabled:I,children:[i.jsx("option",{value:"",children:"Select Test"}),B.map(J=>i.jsx("option",{value:J.id,children:J.name},J.id))]})}),i.jsxs("td",{className:"py-1 px-3 text-right text-gray-700",children:["₹",A.price]}),i.jsx("td",{className:"py-1 px-3 text-center",children:i.jsx("button",{onClick:()=>{const J=C.data.editedTests.filter((Se,me)=>me!==M);d&&d(C.data.id,-1,"remove",J)},className:"text-red-400 hover:text-red-600 focus:outline-none",title:"Remove test",disabled:I,children:i.jsx(gt,{size:12})})})]},M)),C.data.editedTests.length===0&&i.jsx("tr",{children:i.jsx("td",{colSpan:3,className:"py-2 px-3 text-center italic text-gray-400",children:"No tests selected"})})]}),i.jsx("tfoot",{className:"bg-gray-50 border-t",children:i.jsx("tr",{children:i.jsx("td",{colSpan:3,className:"py-1 px-3",children:i.jsx("button",{onClick:()=>{d&&d(C.data.id,-1,"add",{id:"",name:"",price:0})},className:"text-blue-600 hover:text-blue-800 text-xs font-medium flex items-center py-1",disabled:I,children:"+ Add Test"})})})})]})}),i.jsxs("div",{className:"flex justify-end space-x-2 border-t border-gray-200 pt-3 mt-1",children:[i.jsx("button",{onClick:()=>m&&m(C.data.id),className:"px-3 py-1.5 rounded text-xs text-gray-600 hover:bg-white hover:text-gray-800 border border-transparent hover:border-gray-200 transition-colors",disabled:I,children:"Cancel"}),i.jsx("button",{onClick:()=>u&&u(C.data.id,C.data.editedTests,C.data.editedStatus),className:"px-3 py-1.5 rounded text-xs bg-blue-600 text-white hover:bg-blue-700 shadow-sm flex items-center space-x-1 transition-colors",disabled:I,children:I?i.jsx("span",{children:"Saving..."}):i.jsxs(i.Fragment,{children:[i.jsx(Ys,{size:12}),i.jsx("span",{children:"Save Changes"})]})})]})]})]},`${C.type}-${C.originalDateString}-${K}`))})]},V))})]})},bi=Si.memo(dh),ph="_modalOverlay_eh310_3",hh="_modalContent_eh310_29",mh="_modalHeader_eh310_61",fh="_modalTitle_eh310_79",gh="_modalCloseButton_eh310_91",yh="_modalBody_eh310_119",xh="_errorText_eh310_137",bh="_formGroup_eh310_155",wh="_inputField_eh310_179",kh="_searchResultsCard_eh310_221",_h="_searchResultsList_eh310_249",Nh="_searchResultItem_eh310_261",vh="_searchResultPrice_eh310_297",jh="_selectedTestsCard_eh310_307",Ch="_selectedTestsHeader_eh310_327",Sh="_noTestsMessage_eh310_343",Th="_selectedTestsList_eh310_359",Ph="_selectedTestItem_eh310_371",Eh="_selectedTestName_eh310_395",Ah="_selectedTestPrice_eh310_407",Dh="_removeTestButton_eh310_419",Ih="_totalAmount_eh310_445",Oh="_modalFooter_eh310_463",$h="_button_eh310_489",Lh="_buttonPrimary_eh310_507",Rh="_buttonSecondary_eh310_529",se={modalOverlay:ph,modalContent:hh,modalHeader:mh,modalTitle:fh,modalCloseButton:gh,modalBody:yh,errorText:xh,formGroup:bh,inputField:wh,searchResultsCard:kh,searchResultsList:_h,searchResultItem:Nh,searchResultPrice:vh,selectedTestsCard:jh,selectedTestsHeader:Ch,noTestsMessage:Sh,selectedTestsList:Th,selectedTestItem:Ph,selectedTestName:Eh,selectedTestPrice:Ah,removeTestButton:Dh,totalAmount:Ih,modalFooter:Oh,button:$h,buttonPrimary:Lh,buttonSecondary:Rh},Fh=({isOpen:e,onClose:n,patientId:t,labInventory:r,fetchPendingLabOrdersData:s,isLoadingInventory:a=!1})=>{const[o,l]=x.useState([]),[c,u]=x.useState(""),[m,d]=x.useState([]),[y,p]=x.useState(null),[E,q]=x.useState(!1);Ks(void 0,e?200:99999);const G=x.useMemo(()=>new Zs(r,{keys:["name","description"],threshold:.3}),[r]);x.useEffect(()=>{if(!c){d([]);return}const W=G.search(c).map(F=>F.item);d(W.slice(0,10))},[c,G]);const $=async()=>{if(!t){p("Patient ID is missing.");return}if(o.length===0){p("Please select at least one lab test.");return}q(!0),p(null);try{const W={patient_id:t,tests:o.map(j=>({id:j.id,name:j.name,price:j.price}))},F=await Y("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(W)});if(!F.ok){const j=await F.json().catch(()=>({}));throw new Error(j.message||`Failed to create lab order: ${F.statusText}`)}await F.json(),s(t),n(),l([]),u("")}catch(W){p(`Lab Order Creation Error: ${W.message}`)}finally{q(!1)}},B=W=>{if(o.some(F=>F.id===W.id)){p(`${W.name} is already in the order.`),setTimeout(()=>p(null),3e3),u(""),d([]);return}l(F=>[...F,{...W}]),u(""),d([])},I=W=>{l(F=>F.filter(j=>j.id!==W))};return e?i.jsx("div",{className:se.modalOverlay,children:i.jsxs("div",{className:se.modalContent,children:[i.jsxs("div",{className:se.modalHeader,children:[i.jsx("h3",{className:se.modalTitle,children:"Create New Lab Order"}),i.jsx("button",{onClick:n,className:se.modalCloseButton,children:i.jsx(fn,{size:20})})]}),i.jsxs("div",{className:se.modalBody,children:[y&&i.jsx("div",{className:se.errorText,children:y}),i.jsxs("div",{className:se.formGroup,style:{position:"relative"},children:[i.jsx("label",{htmlFor:"lab-test-search",children:"Add Lab Test"}),i.jsx("input",{type:"text",id:"lab-test-search",placeholder:"Search available lab tests...",value:c,onChange:W=>u(W.target.value),className:se.inputField}),c&&i.jsx("div",{className:se.searchResultsCard,children:a?i.jsx("div",{className:"p-2 space-y-2",children:[1,2,3].map(W=>i.jsxs("div",{className:"flex justify-between items-center py-2 px-3",children:[i.jsx(Te,{width:"60%",height:20}),i.jsx(Te,{width:"20%",height:20})]},W))}):m.length>0?i.jsx("ul",{className:se.searchResultsList,children:m.map(W=>i.jsxs("li",{onClick:()=>B(W),className:se.searchResultItem,children:[i.jsx("span",{children:W.name}),i.jsxs("span",{className:se.searchResultPrice,children:["(₹",parseFloat(String(W.price)).toFixed(2),")"]})]},W.id))}):i.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No tests found."})})]}),i.jsxs("div",{className:se.selectedTestsCard,children:[i.jsx("h4",{className:se.selectedTestsHeader,children:"Selected Tests"}),o.length===0?i.jsx("p",{className:se.noTestsMessage,children:"No tests added yet."}):i.jsx("ul",{className:se.selectedTestsList,children:o.map(W=>i.jsxs("li",{className:se.selectedTestItem,children:[i.jsx("span",{className:se.selectedTestName,children:W.name}),i.jsxs("span",{className:se.selectedTestPrice,children:["₹",parseFloat(String(W.price)).toFixed(2)]}),i.jsx("button",{type:"button",onClick:()=>I(String(W.id)),className:se.removeTestButton,title:"Remove Test",children:i.jsx(gt,{size:16})})]},W.id))})]}),o.length>0&&i.jsxs("div",{className:se.totalAmount,children:["Total: ₹",o.reduce((W,F)=>W+parseFloat(String(F.price)),0).toFixed(2)]})]}),i.jsxs("div",{className:se.modalFooter,children:[i.jsx("button",{type:"button",onClick:n,className:`${se.button} ${se.buttonSecondary}`,children:" Cancel "}),i.jsxs("button",{type:"button",onClick:$,disabled:o.length===0||E,className:`${se.button} ${se.buttonPrimary} ${o.length===0||E?se.buttonDisabled:""}`,children:[" ",E?"Saving...":"Create Lab Order"," "]})]})]})}):null},zh=`You are an expert OPD (Outpatient Department) medical assistant for a Doctor in a clinic in India. You will receive all the medical data of the patient including complaints (history), labs, pharmacy orders, etc., along with their date and time. Your primary goal is to assist the doctor and analyze patient chief complaints (Co), provide a structured clinical assessment including lab test suggestions (Lx), differential diagnoses (Dx), and a treatment plan (Tx). You have access to tools (actions) to order lab tests and pharmacy items, and update patient details.



**1. Definitions:**
   - Co: Chief complaints
   - Pt: Patient (assume living in India)
   - Lx: Laboratory tests
   - Dx: Differential Diagnosis
   - Tx: Treatment Plan

**2. Workflow:**
   - Analyze Co, generate Lx, Dx, and Tx sections as described below.
   - **Prioritization for Orders:** Always prioritize using \`edit_pharmacy_order\` or \`edit_lab_order\` if there are existing pending orders for the patient, before considering \`create_pharmacy_order\` or \`create_lab_order\`.
   - using edit_lab_order edits the lab order with the given serial numnber use to add new tests to the existing order or remove the tests from existing order, marking the status affects all tests in the order not only the test,always use this tool if there are pending lab orders instead of creating new orders.
   - using edit_pharmacy_order edits the pharmacy order with the given serial numnber to add new items to the existing order, update existing items, or remove items (either by \`items_to_remove\` or by setting \`quantity\` to 0). Always use this tool if there are pending pharmacy orders instead of creating new orders.
   - using bill_lab_order will navigate the user to the billing page for the specific lab order. Use this when the user expresses intent to bill a lab order.
   - using create_and_bill_lab_order will create a new lab order and immediately bill it (navigating to the print/bill screen). Use this when the user says "create and bill", "order and bill", or similar for NEW tests.
   - using bill_pharmacy_order will bill an existing pharmacy order (identified by serial number).
   - using create_and_bill_pharmacy_order will create a new pharmacy order and immediately bill it. Use this when the user says "prescribe and bill", "order and bill meds", etc.
   - If your Lx section suggests tests from the inventory, use the \`create_lab_order\` action, but only for tests that are both clinically required and have not already been ordered or are still pending. Skip tests that are already ordered and in pending.
   - If your Tx section prescribes medications, use the \`create_pharmacy_order\` action — but only for medications that are clinically required and have not already been prescribed or are still pending. Skip medications that are already dispensed or already ordered.
   - If your Tx section prescribes medications that are *not* available in the inventory, use the \`prescription_for_unavailable_drugs\` parameter within the \`create_pharmacy_order\` action to specify the prescription details. **IMPORTANT:** This string MUST be a **Markdown table** with columns: 'Drug Name', 'Quantity', 'Dosage', 'Directions'. Do not use plain text.
   - When ordering pharmacy items, specify both \`pack_quantity\` (number of full packs) and \`loose_quantity\` (number of individual units). The system will handle the conversion based on the drug's pack size.
   - **Patient Details Management:** Always store or update patient name, age, sex, and phone number using the \`update_patient_details\` action. If patient name, age, or sex is received as 'New Patient - Direct Entry', 'N/A', or blank, treat it as missing data; if the user input provides anything resembling a name, age, or sex (e.g., shiva 25m, robin 50m, priya 19f), update them using the \`update_patient_details\` action. If details are missing, you can ask the user for the missing details using the \`ask_followup_question\` action.
   - Always update new complaints of the patient using the \`add_complaint_history\` action.
   - If you generate a concise summary of the patient's current situation based on the interaction and history, use the \`update_case_summary\` action to save it.
   - Remember, when you use \`update_case_summary\`, the previous case summary will be replaced by the new one, so you can use it like a short-term memory to store other stuff that **keeps changing**, like the current treatment plan, plan of action, active problems, or current vitals, etc.
   - When you use \`add_complaint_history\`, it will add the complaint to the previous ones. You will be given all the previous complaints back in every query, so you can use it to store other long-term facts that do **not change**, like the history of a chronic illness, surgical history, allergies, or social history, etc.
   - while placing or editing a pharmacy order make sure to set the \`pack_quantity\` and \`loose_quantity\` right.
   - Use the \`update_clinic_ai_memory\` action to store or update **various types of clinic-wide persistent information in a concise way**. This can include 'summaries of common patient encounters'+'summeries of previous **Clinic-wide AI Memory**'(e.g., 'Patient X, 50m, chronic gastritis, last visit YYYY-MM-DD, prescribed Z, follow-up in N days'+'**Clinic-wide AI Memory** summary'), notes on local health trends, common diagnostic patterns observed in the clinic, specific operational protocols. This memory is shared across all interactions for the clinic and helps tailor responses to its specific context over time.
    -   **Recurring Medications:**
        -   Use \`create_recurring_medication_order\` to add a new recurring medication.
        -   Use \`edit_recurring_medication_order\` to edit an existing recurring medication (using its serial number).
        -   Recurring medications are long-term prescriptions (e.g., for chronic conditions) that automatically re-order or remind.
    -   **Important: Preventing Loops** If you determine that no further actions are needed (e.g., you have already performed necessary actions, or the user's input does not require any specific action), you **MUST** use the \`end_task\` action. This explicitly signals that your task is complete and prevents the system from re-prompting you unnecessarily.
**3.**Multiple Actions:** You can perform multiple actions (like ordering labs AND meds, adding complaints, updating patient information, and asking a follow-up question) in a single response by including multiple action objects within the main JSON array.


**4. Chief Complaints (Co):**
   - Analyze the provided chief complaints.
   - Present them in a table with two columns: 'Relevant Complaint (Score 8-10)' and 'Irrelevant Complaint (Score 0-7)', based on clinical relevance.

**5. Lab Tests (Lx):**
   - Suggest the most probable basic lab tests based on the clinical picture, ordered by likelihood.
   - If a basic test is positive/abnormal, suggest relevant advanced tests.
   - **Inventory Check:** Compare suggested tests against the provided inventory list.
   - **Table 1: Available Lab Tests:** Present tests *available* in the inventory in a table with columns: '**Clinical Importance (High/Medium/Low)**', 'Lab Test'. If suggesting tests from this table, prepare to use the \`create_lab_order\` tool in your response.
   - **Table 2: Unavailable Lab Tests:** Present tests *not available* in the inventory in a separate table with columns: '**Clinical Importance (High/Medium/Low)**', 'Unavailable Basic Test'. Clearly state these are not orderable via the tool (generate Table 2 only when required tests are unavailable).

**6. Differential Diagnosis (Dx):**
   - List potential differential diagnoses.
   - Provide a confidence score (0-10) for each.
   - Present in a table with columns: 'Differential Diagnosis' and 'Confidence Score (0-10)'.

**7. Treatment Plan (Tx):**
   - Create a structured treatment plan including ideal medications based on the diagnosis.
   - **Inventory Check:** Compare prescribed medications against the provided inventory list.
   - **Table 1: Available Medications:** Present medications *available* in the inventory in a table with columns: 'Time Frame' (from and to dates), 'Treatment Goal', 'Intervention', 'Medication Type', 'Drug Form', 'Drug Name', 'Regimen (Dose, Freq)', 'Duration'. Before using the \`create_pharmacy_order\` tool, check if an order for the same drug has already been placed for this patient today. If an order already exists for today, do *not* create a duplicate order. If no order exists for today, prepare to use the \`create_pharmacy_order\` tool in your response.
   - **Table 2: Unavailable Medications:** Present medications *not available* in the inventory in a separate table with columns: 'Unavailable Drug Name', 'Ideal Regimen', 'Reasoning/Indication', '**Clinical Importance (High/Medium/Low)**', 'Suggested Available Substitute (from inventory, if possible)'. Clearly state these are not orderable via the tool (generate Table 2 only when required medications are unavailable in the inventory).

**8. Tools / Actions:**
   When you need to perform actions like ordering tests/meds, updating patient info, or adding history, use the following JSON array format. The response should ONLY contain this JSON array, nothing else.

   ****STRICT JSON****>>>>>>\`\`\`json
[
  { "action": "create_pharmacy_order", "items": [ { "name": "Drug Name", "pack_quantity": number, "loose_quantity": number, "tabletsPerDay": number | null, "numberOfDays": number | null, "directions_to_use": "string | null" } ], "prescription_for_unavailable_drugs": "string | null" },
  { "action": "edit_pharmacy_order", "serialNumber": number, "items": [ { "name": "Drug Name", "pack_quantity": number, "loose_quantity": number, "tabletsPerDay": number | null, "numberOfDays": number | null, "directions_to_use": "string | null" } ], "items_to_remove": [ { "drug_id": number | null, "name": "Drug Name" } ], "status": "pending" | "billed" | "dispensed" | "cancelled", "prescription_for_unavailable_drugs": "string | null" },
  { "action": "bill_pharmacy_order", "serialNumber": number },
  { "action": "create_and_bill_pharmacy_order", "items": [ { "name": "Drug Name", "pack_quantity": number, "loose_quantity": number, "tabletsPerDay": number | null, "numberOfDays": number | null, "directions_to_use": "string | null" } ], "prescription_for_unavailable_drugs": "string | null" },
  { "action": "create_lab_order", "tests": [ { "name": "Test Name" } ] },
  { "action": "edit_lab_order", "serialNumber": number, "tests": [ { "name": "Test Name" } ], "items_to_remove": [ { "id": number | string | null, "name": "Test Name" } ], "status": "pending" | "billed" | "collected" | "processing" | "report_ready" | "completed" | "cancelled" | "reported" },
  { "action": "create_lab_report", "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "edit_lab_report", "serialNumber": number, "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "create_lab_report", "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "edit_lab_report", "serialNumber": number, "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "edit_lab_order_and_create_report", "serialNumber": number, "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ], "items_to_remove": [ { "id": number | string | null, "name": "Test Name" } ] },
  { "action": "create_and_bill_lab_order", "tests": [ { "name": "Test Name" } ] },
  { "action": "add_complaint_history", "complaint": "Specific past complaint text..." },
  { "action": "update_patient_details", "name": "New Name (optional)", "age": number (optional), "gender": "M" | "F" | "O" | null (optional), "phone_number": "string (optional)" },
  { "action": "update_case_summary", "summary": "Concise summary text..." },
  { "action": "update_clinic_ai_memory", "memory_content": "New clinic-wide AI memory content..." },
  { "action": "create_recurring_medication_order", "items": [ { "medication_name": "Drug Name", "drug_id": "string | null", "quantity": number, "frequency_days": number, "next_delivery_date": "YYYY-MM-DD", "tablets_per_day": number | null, "number_of_days": number | null, "directions": "string | null", "notes": "string | null" } ] },
  { "action": "edit_recurring_medication_order", "serialNumber": number, "updates": { "medication_name": "string (opt)", "quantity": number, "frequency_days": number, "status": "active" | "paused" | "stopped", "next_delivery_date": "YYYY-MM-DD", "number_of_days": number, "tablets_per_day": number, "directions": "string" } },
  { "action": "end_task" }
]
\`\`\`

   - **Multiple Actions in One Response:** You can include multiple action objects within this single JSON array if several actions are required based on your analysis (e.g., adding history AND ordering labs).
   - **Prioritization Within the Array:** If including multiple actions, order them within the array according to this priority:
     1. \`add_complaint_history\`
     2. \`update_patient_details\`
     3. \`update_case_summary\`
     4. \`update_clinic_ai_memory\`
     5. \`create_lab_order\`
     6. \`edit_lab_order\`
     7. \`create_pharmacy_order\`
     8. \`edit_pharmacy_order\`
     9. \`bill_lab_order\`
   - **Structure:**
     The AI response can be a flat array of actions OR a list of "function call" objects containing grouped actions.
     **Option 1: Flat Array (Simple)**
     \`\`\`json
     [
       { "action": "add_complaint_history", ... },
       { "action": "create_lab_order", ... }
     ]
     \`\`\`
     **Option 2: Grouped Function Calls (Complex)**
     You can group actions under logical "function calls" if needed.
     \`\`\`json
     [
       {
         "function_call": "assess_patient",
         "actions": [
           { "action": "ask_followup_question", "question": "..." }
         ]
       },
       {
         "function_call": "prescribe_treatment",
         "actions": [
            { "action": "create_pharmacy_order", "items": [...] },
            { "action": "create_lab_order", "tests": [...] }
         ]
       }
     ]
     \`\`\`

   - **Example (Multiple Actions):**
     \`\`\`json
     [
       { "action": "add_complaint_history", "complaint": "Patient also reports mild fever since yesterday." },
       { "action": "create_lab_order", "tests": [ { "name": "CBC" } ] }
     ]
     \`\`\`

   - **\`ask_followup_question\`**: Use this action (either standalone or inside a group) only when you need clarification.
     \`\`\`json
     {
       "action": "ask_followup_question",
       "question": "Your clear, specific question here.",
       "options": ["Optional Answer 1", "Optional Answer 2"]
     }
     \`\`\`
     *Description:* Ask the user a question to gather additional information needed to complete the task. This tool should be used when you encounter ambiguities, need clarification, or require more details to proceed effectively. It allows for interactive problem-solving by enabling direct communication with the user. Use this tool judiciously to maintain a balance between gathering necessary information and avoiding excessive back-and-forth.
     *Parameters:*
       - question: (required) The question to ask the user. This should be a clear, specific question that addresses the information you need.
       - options: (optional) An array of 2-5 options for the user to choose from. Each option should be a string describing a possible answer. You may not always need to provide options, but it may be helpful in many cases where it can save the user from having to type out a response manually.
   - **\`bill_lab_order\`**: Use this action when the intention is to proceed to billing for a specific lab order.
     \`\`\`json
     { "action": "bill_lab_order", "serialNumber": number }
     \`\`\`
     *Description:* Initiates the billing process for a specific lab order, helping the user navigate to the billing screen.
     *Parameters:*
       - serialNumber: (required) The serial number of the lab order to bill.


**Important:**
- Ensure all tables are clearly formatted using Markdown.
- Strictly adhere to the inventory constraints for labs and medications when deciding whether to use \`create_lab_order\` or \`create_pharmacy_order\`.
- When using actions, provide ONLY the JSON array (or the single JSON object for \`ask_followup_question\`) as the *very last* part of your response, after all other content including tables. Do not include any other text after the JSON.

**Plan Mode:**
When the user asks a question about a patient's condition or general medical topics (not entering new medical data), respond in PLAN MODE. In this mode, focus on answering the user's inquiry, clarifying their request, brainstorming ideas, or architecting a solution (like exploring treatment options). Ask clarifying questions if needed. Present detailed plans or explanations **using clear table formats and markdown (like bolding) for easy readability**. Engage in back-and-back discussion to finalize details. Do not use action tools (\`create_lab_order\`, \`create_pharmacy_order\`, \`add_complaint_history\`, \`update_patient_details\`) while in PLAN MODE).`,Ds="AIzaSyBEt7v-LxBxAKwpTCtkI-3IshYxdnEqbes",qh="models/gemini-3-flash-preview";async function Bh(){if(!cc())return console.warn("No auth token found, using default Gemini API key."),Ds;let n=null;try{const t=await Y("/api/clinics/settings");if(t.ok){const r=await t.json();r.gemini_api_key&&r.gemini_api_key.trim()!==""&&(n=r.gemini_api_key.trim())}}catch(t){console.warn("Could not fetch clinic settings (or key missing), proceeding to global fallback.",t)}if(n)return n;try{const t=await Y("/api/global-settings/app_gemini_api_key");if(t.ok){const s=(await t.json()).value;if(s&&s.trim()!=="")return s.trim()}}catch(t){console.warn("Could not fetch global API key.",t)}return console.warn("Clinic-specific and global Gemini API keys not found, using default env var."),Ds}let wi=null;async function Uh(){if(!wi){const e=await Bh();wi=new lc({apiKey:e})}return wi}async function Mh(e,n){const{query:t,currentDateTime:r,patientName:s,patientAge:a,patientGender:o,case_summary:l,case_summary_last_updated:c,clinic_ai_memory:u,clinic_ai_memory_last_updated:m,clinic_wide_system_prompt:d,labHistory:y,pharmacyOrders:p,pastComplaints:E,pharmacyInventory:q,labInventory:G,recurringMedications:$}=e;let B=`Patient Complaint: ${t}`;if(l&&(B+=`

--- Case Summary (Provided by Doctor) ---
${l}`,c))try{const _=new Date(c).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"});B+=`
(Last Updated: ${_})`}catch{console.warn(`Could not format case_summary_last_updated: ${c}`),B+=`
(Last Updated: ${c})`}if(s&&(B+=`

Patient Name: ${s}`),a!=null&&(B+=`
Patient Age: ${a}`),o&&(B+=`
Patient Gender: ${o}`),r)try{const _=new Date(r).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"});B+=`

Current Interaction Time: ${_}`}catch{console.warn(`Could not format currentDateTime: ${r}`),B+=`

Current Interaction Time: ${r}`}if(u&&(B+=`

--- Clinic-wide AI Memory/Context ---
${u}`,m))try{const _=new Date(m).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"});B+=`
(Last Updated: ${_})`}catch{console.warn(`Could not format clinic_ai_memory_last_updated: ${m}`),B+=`
(Last Updated: ${m})`}let I="";y&&Array.isArray(y)&&y.length>0&&(I=`

--- Lab History (Orders & Reports) ---
`,y.forEach(_=>{let C="Unknown Date";try{C=new Date(_.orderDate).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date for lab order: ${_.orderDate}`)}if(I+=`
Order #${_.serialNumber} Date: ${C} (Status: ${_.status})
`,I+=`Tests: ${_.tests.map(K=>K.name).join(", ")}
`,_.report){let K="Unknown Date";try{K=new Date(_.report.reportDate).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date for lab report: ${_.report.reportDate}`)}I+=`  -> Report Date: ${K}
`,_.report.tests&&Array.isArray(_.report.tests)?(I+=`     Findings:
`,_.report.tests.forEach(A=>{I+=`       - Test: ${A.testName}
`,A.parameters&&Array.isArray(A.parameters)&&A.parameters.forEach(M=>{I+=`         - ${M.name}: ${M.value} (Normal: ${M.normal_range})
`})})):(I+=`     Findings: ${_.report.reportContent||"N/A"}
`,_.report.error&&(I+=`     Note: ${_.report.error}
`))}I+=`---
`}),B+=I);let W="";p&&Array.isArray(p)&&p.length>0&&(W=`

--- Recent Pharmacy Orders ---
`,p.forEach(_=>{let C="Unknown Date/Time";try{C=new Date(_.date).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date/time for pharmacy order: ${_.date}`)}W+=`
Order #${_.serialNumber} Date/Time: ${C} (Status: ${_.status})
`,W+=`Prescribed By: ${_.prescribedBy||"N/A"}
`,_.dispensedBy&&(W+=`Dispensed By: ${_.dispensedBy}
`),W+=`Medications:
`,_.medications.forEach(K=>{W+=`  - ${K.name} (Qty: ${K.quantity}`,K.tabletsPerDay&&(W+=`, ${K.tabletsPerDay}/day`),K.numberOfDays&&(W+=` for ${K.numberOfDays} days`),W+=`)
`}),_.prescriptionForUnavailableDrugs&&(W+=`  Prescription for Unavailable Drugs: ${_.prescriptionForUnavailableDrugs}
`),W+=`---
`}),B+=W);let F="";$&&Array.isArray($)&&$.length>0&&(F=`

--- Recurring Medications (Active) ---
`,$.forEach((_,C)=>{let K=`${C+1}. ${_.medicationName} (${_.frequencyDays} days)`;if(_.tabletsPerDay&&(K+=` - ${_.tabletsPerDay} tabs/day`),_.numberOfDays&&(K+=` for ${_.numberOfDays} days`),K+=` [Status: ${_.status}]`,_.nextDeliveryDate)try{const A=new Date(_.nextDeliveryDate).toLocaleDateString();K+=` (Next: ${A})`}catch{}F+=`${K}
`}),B+=F);let j="";E&&Array.isArray(E)&&E.length>0&&(j=`

--- Past Complaints History ---
`,E.forEach(_=>{let C="Unknown Date/Time";try{C=new Date(_.createdAt).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date/time for past complaint: ${_.createdAt}`)}j+=`
Date/Time: ${C}
Complaint: ${_.complaint||"N/A"}
---
`}),B+=j);let X="";q&&Array.isArray(q)&&q.length>0&&(X=`

--- Current Pharmacy Inventory (Stock Levels) ---
`,q.forEach(_=>{let C=`${_.stock??0} packs`;_.loose!==void 0&&_.loose!==null&&_.loose>0&&(C+=`, ${_.loose} loose`);let K=`- ${_.name} (Pack: ${_.pack??"N/A"}): ${C}`;const A=[];_.brand_name&&A.push(`Brand: ${_.brand_name}`),_.batch&&A.push(`Batch: ${_.batch}`),_.expiry_date&&A.push(`Exp: ${_.expiry_date}`),A.length>0&&(K+=` [${A.join(", ")}]`),X+=`${K}
`}),B+=X);let ce="";G&&Array.isArray(G)&&G.length>0&&(ce=`

--- Available Lab Tests (with Parameters) ---
`,G.forEach(_=>{ce+=`- ${_.name} (Price: ${_.price??"N/A"})
`,_.default_parameters&&Array.isArray(_.default_parameters)&&_.default_parameters.length>0&&_.default_parameters.forEach(C=>{let K=`    * ${C.name}`;C.unit&&(K+=` (${C.unit})`),C.normal_range?K+=` [Normal: ${C.normal_range}]`:C.lower_limit!==void 0&&C.upper_limit!==void 0&&C.lower_limit!==null&&C.upper_limit!==null&&(K+=` [Normal: ${C.lower_limit} - ${C.upper_limit}]`),ce+=`${K}
`})}),B+=ce);const ne=[{text:zh}];d&&d.trim()!==""&&ne.push({text:`--- Additional Clinic-Specific Instructions ---
${d}`});const le=[{text:B}];if(n){const _=new FileReader,C=await new Promise((K,A)=>{_.onloadend=()=>{typeof _.result=="string"?K(_.result.split(",")[1]):A(new Error("Failed to read image file as base64."))},_.onerror=A,_.readAsDataURL(n)});le.push({inlineData:{mimeType:n.type,data:C}})}const V=[];ne.length>0&&V.push({role:"user",parts:ne}),V.push({role:"user",parts:le});try{const _={model:qh,contents:V,generationConfig:{temperature:.7,maxOutputTokens:1024,responseMimeType:"text/plain"}},K=await(await Uh()).models.generateContentStream(_);let A="";for await(const M of K)if(M&&typeof M.text=="function"){const J=M.text;J&&(A+=J)}else M&&M.candidates&&M.candidates[0]&&M.candidates[0].content&&M.candidates[0].content.parts&&M.candidates[0].content.parts[0]&&M.candidates[0].content.parts[0].text&&(A+=M.candidates[0].content.parts[0].text);if(A&&A.trim()!=="")return A.trim();throw console.error("Empty or invalid response received from Gemini API stream."),new Error("Failed to get suggestion from AI (Gemini). Empty or invalid stream response.")}catch(_){console.error("Error calling Gemini API:",_);let C="Failed to get suggestion from Gemini.";throw _.message&&(C=`Error processing Gemini request: ${_.message}`),new Error(C)}}const ki=e=>{if(!e)return 1;const n=e.match(/(?:\d+x)?(\d+)(?:s|tabs)?/i);return n?parseInt(n[1],10):1},Hh=x.forwardRef(({recordId:e,patientId:n,patientDetails:t,caseSummary:r,caseSummaryUpdatedAt:s,clinicSettings:a,userMessages:o,selectedImageFile:l,pendingLabOrders:c,labReports:u,pastComplaints:m,pharmacyOrders:d,pharmacyInventory:y,labInventory:p,recurringMedications:E,currentComplaint:q,setCurrentComplaint:G,setAiResponse:$,setAiResponseText:B,setAiResponseJsonString:I,setShowAiJsonDetails:W,setIsLoadingAi:F,setAiError:j,setIsSubmittingAiOrder:X,setAiOrderSubmissionStatus:ce,setIsSubmittingAiLabOrder:ne,setAiLabOrderSubmissionStatus:le,setIsSubmittingAiComplaint:V,setAiComplaintSubmissionStatus:_,setIsUpdatingCaseSummary:C,setAiCaseSummaryUpdateStatus:K,setCaseSummary:A,setIsUpdatingAiMemoryByAI:M,setAiMemoryUpdateByAIStatus:J,setFollowUpQuestion:Se,setFollowUpOptions:me,setError:w,setIsSavingAiResponse:Fe,setSaveAiResponseError:_e,fetchPharmacyOrdersData:b,fetchPendingLabOrdersData:De,fetchLabReportsData:He,fetchRecurringMedicationsData:Ne,fetchPastComplaintsData:at,fetchPatientDetails:Re,setClinicSettings:et,setEditedAiMemory:st,setCanUndo:tt,onAiActionSuccess:Yt,addMessage:v,onPrintLabBill:Ot,onPrintPharmacyBill:jt},Kt)=>{const[pt,yt]=Si.useState(null);Si.useEffect(()=>{tt(!!pt)},[pt,tt]);let Je;const Ct=async($e,T,P,S=0)=>{let ee;const Le=["AI response did not contain a recognized function call","AI response did not result in a recognized or performed function call"].some(Me=>{var je;return(je=T.message)==null?void 0:je.includes(Me)});P&&Le?ee=`AI Error: ${T.message}

${P}`:(ee=`I encountered a frontend error while trying to execute the '${$e}' function. The error message is: "${T.message}". Based on this error, please analyze what went wrong and either correct the function call and try again, or explain the problem.`,($e==="create_pharmacy_order"||$e==="edit_pharmacy_order")&&(ee+=`

IMPORTANT: When ordering medication, please first check if the medication ordered matches the exact name given in the inventory. If the name itself is not given in the inventory, you can use 'prescription_for_unavailable_drugs' to write a prescription. **NOTE:** This field MUST be formatted as a Markdown table (columns: Drug Name, Quantity, Dosage, Directions).`),P&&(ee+=`

The original AI response that caused the error was:
\`\`\`
${P}
\`\`\``)),v==null||v({role:"system",type:"error",content:`AI Error: ${T.message}. Retrying...`}),await Je(ee,S+1)},Mt=async $e=>{console.log("Executing Rollback for actions:",$e);for(const T of $e){const{actionType:P,undoData:S}=T;if(console.log(`Attempting to rollback ${P}`,S),!S){console.warn(`No undoData found for action ${P}, skipping.`);continue}try{if(P==="create_pharmacy_order")S!=null&&S.orderId?(console.log(`Deleting pharmacy order ${S.orderId}`),await Y(`/api/pharmacy-orders/${S.orderId}`,{method:"DELETE"}),b(n)):console.error("Missing orderId for create_pharmacy_order rollback");else if(P==="create_lab_order")S!=null&&S.orderId?(console.log(`Deleting lab order ${S.orderId}`),await Y(`/api/lab/orders/${S.orderId}`,{method:"DELETE"}),De(n)):console.error("Missing orderId for create_lab_order rollback");else if(P==="update_patient_details")if(S!=null&&S.patientId&&(S!=null&&S.originalDetails)){console.log(`Reverting patient details for ${S.patientId}`);const ee=S.originalDetails,ue={name:ee.name,age:ee.age,gender:ee.gender,phone:ee.phone,ai_response:ee.ai_response};await Y(`/api/patients/${S.patientId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ue)}),Re(S.patientId)}else console.error("Missing patientId or originalDetails for update_patient_details rollback");else if(P==="add_complaint_history")S!=null&&S.recordId?(console.log(`Reverting complaint history for ${S.recordId}`),await Y(`/api/queue/doctor/complaint/${S.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:S.originalComplaint||""})}),G(S.originalComplaint||"")):console.error("Missing recordId for add_complaint_history rollback");else if(P==="update_case_summary")S!=null&&S.recordId?(console.log(`Reverting case summary for ${S.recordId}`),await Y(`/api/queue/doctor/complaint/${S.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({case_summary:S.originalSummary||""})}),A(S.originalSummary||"")):console.error("Missing recordId for update_case_summary rollback");else if(P==="update_clinic_ai_memory")(S==null?void 0:S.originalMemory)!==void 0?(console.log("Reverting AI memory"),await Y("/api/clinics/settings",{method:"PUT",body:JSON.stringify({...a,aiMemory:S.originalMemory})}),st(S.originalMemory)):console.error("Missing originalMemory for update_clinic_ai_memory rollback");else if(P==="edit_pharmacy_order")if(S!=null&&S.orderId&&(S!=null&&S.originalState)){console.log(`Reverting pharmacy order ${S.orderId}`);const ee={items:S.originalState.medications||[],status:S.originalState.status,prescription_for_unavailable_drugs:S.originalState.prescription_for_unavailable_drugs,order_total:S.originalState.order_total};await Y(`/api/pharmacy-orders/${S.orderId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ee)}),b(n)}else console.error("Missing orderId or originalState for edit_pharmacy_order rollback");else if(P==="edit_lab_order")if(S!=null&&S.orderId&&(S!=null&&S.originalState)){console.log(`Reverting lab order ${S.orderId}`);const ee={tests:S.originalState.tests,status:S.originalState.status};await Y(`/api/lab/orders/${S.orderId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ee)}),De(n)}else console.error("Missing orderId or originalState for edit_lab_order rollback");else if(P==="create_recurring_medication_order")if(S!=null&&S.createdIds&&S.createdIds.length>0){console.log(`Deleting recurring medications: ${S.createdIds.join(", ")}`);for(const ee of S.createdIds)await Y(`/api/recurring-medications/${ee}`,{method:"DELETE"});n&&Ne&&Ne(n)}else console.error("Missing createdIds for create_recurring_medication_order rollback");else P==="edit_recurring_medication_order"?S!=null&&S.medicationId&&(S!=null&&S.originalState)?(console.log(`Reverting recurring medication ${S.medicationId}`),await Y(`/api/recurring-medications/${S.medicationId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(S.originalState)}),n&&Ne&&Ne(n)):console.error("Missing medicationId or originalState for edit_recurring_medication_order rollback"):console.warn(`Unknown action type for rollback: ${P}`)}catch(ee){console.error(`Failed to rollback ${P}:`,ee)}}},Zt=async()=>{!pt||!window.confirm("Are you sure you want to undo the last AI actions?")||(F(!0),await Mt([...pt].reverse()),yt(null),F(!1),j("Last actions undone successfully."))},We=async($e,T)=>{yt(null),ce(null),le(null),_(null),K(null),J(null),Se(null),me([]),w(null);let P=null;const S=/```json\s*([\s\S]*?)\s*```/,ee=$e.match(S);if(ee&&ee[1])P=ee[1];else{const ue=$e.trim();if(ue.startsWith("{")&&ue.endsWith("}"))P=ue;else if(ue.startsWith("[")&&ue.endsWith("]"))P=ue;else throw new Error("AI response did not contain a recognized function call.")}if(P)try{const ue=JSON.parse(P),Le=D=>{const z=[],L=Array.isArray(D)?D:[D];for(const O of L)O&&(O.actions&&Array.isArray(O.actions)?z.push(...Le(O.actions)):O.sub_actions&&Array.isArray(O.sub_actions)?z.push(...Le(O.sub_actions)):O.function_calls&&Array.isArray(O.function_calls)?z.push(...Le(O.function_calls)):typeof O.action=="string"&&z.push(O));return z},Me=Le(ue),je=[];let Ve=null,Qe=!1;for(const D of Me){if(D.action==="ask_followup_question"){Ve=D,Qe=!0;continue}Qe=!0;const z=D.action;if(z==="update_clinic_ai_memory"&&typeof D.memory_content=="string")je.push((async()=>{M(!0),J("Processing AI mem..."),v==null||v({role:"system",type:"loading",content:"Processing AI memory..."});const L=(a==null?void 0:a.aiMemory)||"";try{if(!a)throw new Error("Clinic settings not loaded.");const O={...a,aiMemory:D.memory_content.trim(),admissionCharge:a.admissionCharge,perDayCharge:a.perDayCharge,otherCharges:a.otherCharges,clinicWideSystemPrompt:a.clinicWideSystemPrompt},ie=await Y("/api/clinics/settings",{method:"PUT",body:JSON.stringify(O)});if(!ie.ok){const R=await ie.json().catch(()=>({}));throw new Error(R.message||`AI-triggered clinic memory update failed: ${ie.statusText}`)}const re=await ie.json();return et(R=>R?{...R,aiMemory:re.settings.aiMemory}:null),st(re.settings.aiMemory||""),J("AI mem updated!"),v==null||v({role:"system",type:"success",content:"AI memory updated successfully."}),{success:!0,actionType:z,undoData:{originalMemory:L}}}catch(O){return J("Failed"),{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{M(!1)}})());else if(z==="create_pharmacy_order")je.push((async()=>{var L,O;X(!0),ce("Processing order..."),v==null||v({role:"system",type:"loading",content:"Processing pharmacy order..."});try{if(!n)throw new Error("Missing patient ID.");const ie=[];let re=null;if(Array.isArray(D.items))for(const ae of D.items){let ge;if(ae.drug_id?ge=y.find(Ee=>Ee.id===ae.drug_id):ae.name&&(ge=It(ae.name,y)),!ge){re=`Drug "${ae.name||ae.drug_id}" not found.`;break}const pe=ki(ge.pack),H=Number(ge.mrp),Z=H,be=pe>0?H/pe:0,qe=Number(ae.pack_quantity)||0,oe=Number(ae.loose_quantity)||0,ve=qe*Z+oe*be;ie.push({drug_id:String(ge.id),name:ge.name,pack_quantity:qe,loose_quantity:oe,tabletsPerDay:ae.tabletsPerDay,numberOfDays:ae.numberOfDays,directions_to_use:ae.directions_to_use,group_id:ae.group_id,pack_price:Z,loose_price:be,total_price:ve,price:H,isLoose:ae.isLoose,unit:ge.pack})}if(re)throw new Error(re);const R=ie.reduce((ae,ge)=>ae+ge.total_price,0),fe={patient_id:n,items:ie,prescription_for_unavailable_drugs:D.prescription_for_unavailable_drugs,order_total:parseFloat(R.toFixed(2))},Ce=await Y("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(fe)});if(!Ce.ok){const ae=await Ce.json().catch(()=>({}));throw new Error(ae.message||"Order creation failed.")}const xe=await Ce.json();return ce("Order created!"),b(n),v==null||v({role:"system",type:"success",content:"Pharmacy order created successfully."}),{success:!0,actionType:z,data:xe,undoData:{orderId:((O=(L=xe.orders)==null?void 0:L[0])==null?void 0:O.id)||xe.id}}}catch(ie){return v==null||v({role:"system",type:"error",content:`Pharmacy order failed: ${ie.message}`}),{success:!1,actionType:z,error:ie,originalActionPayload:D}}finally{X(!1)}})());else if(z==="bill_pharmacy_order")je.push((async()=>{X(!0),ce("Billing Pharmacy Order...");try{const L=D.serialNumber;if(!L)throw new Error("Missing serial number for billing.");if(!n)throw new Error("Missing patient ID.");const O=new Map;(d??[]).forEach(H=>O.set(H.id,{...H}));const ie=Array.from(O.values()).sort((H,Z)=>new Date(Z.date).getTime()-new Date(H.date).getTime()),re=ie.length-L,R=ie[re];if(!R)throw new Error(`Pharmacy order #${L} not found.`);if(R.status==="billed"||R.status==="dispensed")throw new Error(`Order #${L} is already billed.`);const fe=R.medications.map(H=>{let Z;H.drug_id?Z=y.find(Ge=>String(Ge.id)===String(H.drug_id)):Z=y.find(Ge=>Ge.name.toLowerCase()===H.name.toLowerCase());const be=Number(H.pack_price)||Number(Z==null?void 0:Z.mrp)||0,qe=ki(H.unit||(Z==null?void 0:Z.pack)),oe=Number(H.loose_price)||(qe>0?be/qe:0),ve=(H.pack_quantity||0)*qe+(H.loose_quantity||0);let Ee=Number(H.total_price);return Ee||(Ee=ve*oe),{...H,price:Ee,mrp:be,pack_quantity:H.pack_quantity,loose_quantity:H.loose_quantity,expiry_date:H.expiry_date||(Z==null?void 0:Z.expiry_date),batch:H.batch||(Z==null?void 0:Z.box_number)}}),Ce=fe.reduce((H,Z)=>H+Z.price,0),xe=Ce,ae={patientId:n,queueId:R.id,items:fe.map(H=>({name:H.name,pack_quantity:H.pack_quantity,loose_quantity:H.loose_quantity,price:H.mrp,pack_price:H.mrp,loose_price:H.loose_price,total:H.price,drug_id:H.drug_id,discount_percentage:0,batch:H.batch,expiry_date:H.expiry_date})),amount:xe,paymentMode:"cash",type:"pharmacy",related_id:R.id,status:"paid",discountPercentage:0},ge=await Y("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)}),pe=await ge.json();if(!ge.ok)throw new Error(pe.message||"Failed to create pharmacy bill");return await Y(`/api/pharmacy-orders/${R.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:pe.id,medications:fe})}),ce("Billed Successfully!"),b(n),jt&&jt({billId:pe.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:R.date,items:fe,subtotal:Ce,totalDiscount:0,grandTotal:xe,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||""}),v==null||v({role:"system",type:"success",content:`Pharmacy order #${R.id} billed.`}),{success:!0,actionType:z,data:pe}}catch(L){return v==null||v({role:"system",type:"error",content:`Billing failed: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{X(!1)}})());else if(z==="create_and_bill_pharmacy_order")je.push((async()=>{X(!0),ce("Processing & Billing..."),v==null||v({role:"system",type:"loading",content:"Prescribing and billing..."});let L=null;try{if(!n)throw new Error("Missing patient ID.");const O=[];let ie=null;if(Array.isArray(D.items))for(const Z of D.items){let be;if(Z.drug_id?be=y.find(lt=>lt.id===Z.drug_id):Z.name&&(be=It(Z.name,y)),!be){ie=`Drug "${Z.name}" not found.`;break}const qe=ki(be.pack),oe=Number(be.mrp),ve=oe,Ee=qe>0?oe/qe:0,Ge=Number(Z.pack_quantity)||0,ot=Number(Z.loose_quantity)||0,xt=Ge*ve+ot*Ee;O.push({drug_id:String(be.id),name:be.name,pack_quantity:Ge,loose_quantity:ot,tabletsPerDay:Z.tabletsPerDay,numberOfDays:Z.numberOfDays,directions_to_use:Z.directions_to_use,group_id:Z.group_id,pack_price:ve,loose_price:Ee,total_price:xt,price:oe,mrp:oe,isLoose:Z.isLoose,unit:be.pack,batch:be.box_number,expiry_date:be.expiry_date})}if(ie)throw new Error(ie);const re=O.reduce((Z,be)=>Z+be.total_price,0),R={patient_id:n,items:O,prescription_for_unavailable_drugs:D.prescription_for_unavailable_drugs,order_total:parseFloat(re.toFixed(2))},fe=await Y("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(R)});if(!fe.ok)throw new Error("Order creation failed.");const Ce=await fe.json(),xe=Ce.orders?Ce.orders[0]:Ce;L=xe.id;const ae=re,ge={patientId:n,queueId:xe.id,items:O.map(Z=>({name:Z.name,pack_quantity:Z.pack_quantity,loose_quantity:Z.loose_quantity,price:Z.mrp,pack_price:Z.mrp,loose_price:Z.loose_price,total:Z.total_price,drug_id:Z.drug_id,discount_percentage:0,batch:Z.batch,expiry_date:Z.expiry_date})),amount:ae,paymentMode:"cash",type:"pharmacy",related_id:xe.id,status:"paid",discountPercentage:0},pe=await Y("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ge)}),H=await pe.json();if(!pe.ok)throw new Error("Billing failed.");return await Y(`/api/pharmacy-orders/${xe.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:H.id,medications:O})}),ce("Ordered & Billed!"),b(n),jt&&jt({billId:H.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:new Date().toISOString(),items:O.map(Z=>({...Z,price:Z.total_price})),subtotal:ae,totalDiscount:0,grandTotal:ae,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||""}),v==null||v({role:"system",type:"success",content:`Pharmacy order #${xe.id} created and billed.`}),{success:!0,actionType:z,data:xe,undoData:{orderId:xe.id}}}catch(O){return v==null||v({role:"system",type:"error",content:`Create & Bill failed: ${O.message}`}),{success:!1,actionType:z,error:O,originalActionPayload:D,undoData:L?{orderId:L}:void 0}}finally{X(!1)}})());else if(z==="update_patient_details")je.push((async()=>{F(!0),v==null||v({role:"system",type:"loading",content:"Updating patient details..."});const L={...t};try{if(!n)throw new Error("Missing patient ID.");const O={};if(D.name&&(O.name=D.name),D.age&&(O.age=D.age),D.gender&&(O.gender=D.gender),D.phone_number!==void 0&&(O.phone_number=D.phone_number),!(await Y(`/api/patients/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(O)})).ok)throw new Error("Patient update failed.");return Re(n),v==null||v({role:"system",type:"success",content:"Patient details updated."}),{success:!0,actionType:z,undoData:{patientId:n,originalDetails:L}}}catch(O){return{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{F(!1)}})());else if(z==="create_lab_order")je.push((async()=>{ne(!0),le("Processing lab..."),v==null||v({role:"system",type:"loading",content:"Processing lab order..."});try{if(!n)throw new Error("Missing patient ID.");const L=[];for(const re of D.tests||[]){let R;if(re.id?R=p.find(fe=>String(fe.id)===String(re.id)):re.name&&(R=It(re.name,p)),!R)throw new Error(`Lab test "${re.name}" not found.`);L.push({id:R.id,name:R.name,price:Number(R.price)})}const O=await Y("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,tests:L})});if(!O.ok)throw new Error("Lab order creation failed.");const ie=await O.json();return le("Success!"),De(n),v==null||v({role:"system",type:"success",content:"Lab order created."}),{success:!0,actionType:z,data:ie.labOrder,undoData:{orderId:ie.labOrder.id}}}catch(L){return v==null||v({role:"system",type:"error",content:`Lab order failed: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="create_and_bill_lab_order")je.push((async()=>{ne(!0),le("Processing & Billing..."),v==null||v({role:"system",type:"loading",content:"Creating and billing lab order..."});let L=null;try{if(!n)throw new Error("Missing patient ID.");const O=[];for(const H of D.tests||[]){let Z;if(H.id?Z=p.find(be=>String(be.id)===String(H.id)):H.name&&(Z=It(H.name,p)),!Z)throw new Error(`Lab test "${H.name}" not found.`);O.push({id:Z.id,name:Z.name,price:Number(Z.price)})}const ie=await Y("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,tests:O})});if(!ie.ok)throw new Error("Lab order creation failed.");const R=(await ie.json()).labOrder;L=R.id,v==null||v({role:"system",type:"loading",content:`Order #${R.id} created. Generating bill...`});const fe=O.map(H=>({name:H.name,price:typeof H.price=="string"?parseFloat(H.price):H.price||0,discount_percentage:0,quantity:1,item_id:H.id,type:"lab_test"})),Ce=fe.reduce((H,Z)=>H+Z.price,0),xe=Ce,ae={patientId:n,items:fe.map(H=>({...H,total:H.price})),amount:xe,paymentMode:"cash",type:"lab",related_id:R.id,status:"paid",discountPercentage:0},ge=await Y("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)}),pe=await ge.json();if(!ge.ok)throw new Error(pe.message||"Failed to create bill");return await Y(`/api/lab/${R.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:pe.id})}),le("Success & Billed!"),De(n),Ot&&Ot({billId:pe.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:R.createdAt,items:fe,subtotal:Ce,totalDiscount:0,grandTotal:xe,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||"",labLetterheadUrl:a==null?void 0:a.labLetterheadUrl}),v==null||v({role:"system",type:"success",content:`Lab order #${R.id} created and billed. Opening print dialog.`}),{success:!0,actionType:z,data:R,undoData:{orderId:R.id}}}catch(O){return v==null||v({role:"system",type:"error",content:`Create and Bill failed: ${O.message}`}),{success:!1,actionType:z,error:O,originalActionPayload:D,undoData:L?{orderId:L}:void 0}}finally{ne(!1)}})());else if(z==="create_lab_report")je.push((async()=>{ne(!0),le("Creating Report..."),v==null||v({role:"system",type:"loading",content:"Creating lab report..."});try{if(!n)throw new Error("Missing patient ID.");const L=[],O=D.tests||[];for(const xe of O){let ae;if(xe.id?ae=p.find(ge=>String(ge.id)===String(xe.id)):xe.name&&(ae=It(xe.name,p)),!ae)throw new Error(`Lab test "${xe.name}" not found.`);xe._matchedTest=ae,L.push({id:ae.id,name:ae.name,price:Number(ae.price)})}const ie=await Y("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,tests:L,status:"reported"})});if(!ie.ok)throw new Error("Lab order creation failed during report generation.");const re=await ie.json(),R=re.labOrder.id,fe={};if(O.forEach(xe=>{const ae=xe._matchedTest,ge=ae.id,pe=xe.parameters||[],H={},Z=ae.default_parameters||[];for(const be of Z){const qe=pe.find(oe=>{if(!oe.name)return!1;if(oe.name.toLowerCase()===be.name.toLowerCase())return!0;const ve=oe.name.toLowerCase(),Ee=be.name.toLowerCase();return ve.includes(Ee)||Ee.includes(ve)});qe&&qe.value!==void 0?H[be.name]=qe.value:be.defaultValue!==void 0&&be.defaultValue!==null&&(H[be.name]=be.defaultValue)}fe[ge]=H}),!(await Y(`/api/lab/${R}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(fe)})})).ok)throw new Error("Report submission failed.");return le("Report Created!"),De(n),He(n),v==null||v({role:"system",type:"success",content:"Lab report created successfully."}),{success:!0,actionType:z,data:re.labOrder,undoData:{orderId:R}}}catch(L){return v==null||v({role:"system",type:"error",content:`Lab report failed: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="edit_lab_report")je.push((async()=>{ne(!0),le("Updating Report...");try{const L=D.serialNumber;if(!L)throw new Error("Missing serial number for lab report edit.");const O=new Map;(c??[]).forEach(pe=>O.set(pe.id,{...pe})),(u??[]).forEach(pe=>{if(O.has(pe.id)){const H=O.get(pe.id);H.report=pe,H.status=pe.status}else O.set(pe.id,{...pe,createdAt:pe.createdAt})});const ie=Array.from(O.values());ie.sort((pe,H)=>new Date(H.createdAt).getTime()-new Date(pe.createdAt).getTime());const re=ie.length-L,R=ie[re];if(!R)throw new Error(`Lab report #${L} not found.`);const fe=R.id;let Ce={};if(R.report&&R.report.report_content)try{Ce=typeof R.report.report_content=="string"?JSON.parse(R.report.report_content):R.report.report_content}catch{}const xe={...Ce};if((D.tests||[]).forEach(pe=>{let Z=(R.tests||[]).find(Ee=>Ee.name.toLowerCase()===pe.name.toLowerCase());if(!Z)return;const be=Z.id,qe=pe.parameters||[],oe=p.find(Ee=>String(Ee.id)===String(be)),ve=(oe==null?void 0:oe.default_parameters)||[];xe[be]||(xe[be]={});for(const Ee of ve){const Ge=qe.find(ot=>{if(!ot.name)return!1;if(ot.name.toLowerCase()===Ee.name.toLowerCase())return!0;const xt=ot.name.toLowerCase(),lt=Ee.name.toLowerCase();return xt.includes(lt)||lt.includes(xt)});Ge&&Ge.value!==void 0&&(xe[be][Ee.name]=Ge.value)}}),!(await Y(`/api/lab/${fe}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(xe)})})).ok)throw new Error("Report update failed.");return le("Report Updated!"),De(n),He(n),v==null||v({role:"system",type:"success",content:"Lab report updated successfully."}),{success:!0,actionType:z,data:{orderId:fe},undoData:{orderId:fe}}}catch(L){return v==null||v({role:"system",type:"error",content:`Update report failed: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="edit_lab_order_and_create_report")je.push((async()=>{ne(!0),le("Updating Order & Report..."),v==null||v({role:"system",type:"loading",content:"Updating lab order and report..."});try{const L=D.serialNumber;if(!L)throw new Error("Missing serial number.");const O=new Map;(c??[]).forEach(oe=>O.set(oe.id,{...oe})),(u??[]).forEach(oe=>{if(O.has(oe.id)){const ve=O.get(oe.id);ve.report=oe,ve.status=oe.status}else O.set(oe.id,{...oe,createdAt:oe.createdAt})});const ie=Array.from(O.values());ie.sort((oe,ve)=>new Date(ve.createdAt).getTime()-new Date(oe.createdAt).getTime());const re=ie.length-L,R=ie[re];if(!R)throw new Error(`Lab order #${L} not found.`);const fe=R.id,Ce=JSON.parse(JSON.stringify(R));let xe=[];for(const oe of R.tests||[]){const ve=p.find(Ee=>String(Ee.id)===String(oe.id));ve?xe.push({id:ve.id,name:ve.name,price:Number(ve.price)}):xe.push({id:oe.id,name:oe.name,price:Number(oe.price)||0})}if(D.items_to_remove&&Array.isArray(D.items_to_remove)){const oe=D.items_to_remove;xe=xe.filter(ve=>!oe.some(Ee=>Ee.id&&String(Ee.id)===String(ve.id)||Ee.name&&ve.name.toLowerCase()===Ee.name.toLowerCase()))}const ae=D.tests||[],ge={};for(const oe of ae){let ve;if(oe.id?ve=p.find(nt=>String(nt.id)===String(oe.id)):oe.name&&(ve=It(oe.name,p)),!ve)throw new Error(`Lab test "${oe.name}" not found.`);xe.findIndex(nt=>String(nt.id)===String(ve.id))===-1&&xe.push({id:ve.id,name:ve.name,price:Number(ve.price)});const Ge=ve.id,ot=oe.parameters||[],xt={},lt=ve.default_parameters||[];for(const nt of lt){const Xt=ot.find(en=>{if(!en.name)return!1;if(en.name.toLowerCase()===nt.name.toLowerCase())return!0;const Hn=en.name.toLowerCase(),Wn=nt.name.toLowerCase();return Hn.includes(Wn)||Wn.includes(Hn)});Xt&&Xt.value!==void 0?xt[nt.name]=Xt.value:nt.defaultValue!==void 0&&(xt[nt.name]=nt.defaultValue)}ge[Ge]=xt}const pe={tests:xe};console.log("[DEBUG] edit_lab_order_and_create_report - Order Update Payload:",JSON.stringify(pe,null,2)),console.log("[DEBUG] Items to remove:",D.items_to_remove),console.log("[DEBUG] Original tests:",R.tests);const H=await Y(`/api/lab/orders/${fe}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(pe)});if(console.log("[DEBUG] Order update response status:",H.status),!H.ok){const oe=await H.json().catch(()=>({}));throw console.error("[DEBUG] Order update failed:",oe),new Error(`Failed to update lab order tests: ${oe.message||H.statusText}`)}let Z={};if(R.report&&R.report.report_content)try{Z=typeof R.report.report_content=="string"?JSON.parse(R.report.report_content):R.report.report_content}catch{}const be={...Z,...ge};if(!(await Y(`/api/lab/${fe}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(be)})})).ok)throw new Error("Failed to create/update lab report.");return le("Order & Report Updated!"),De(n),He(n),v==null||v({role:"system",type:"success",content:"Lab order and report updated successfully."}),{success:!0,actionType:z,undoData:{orderId:fe,originalState:Ce}}}catch(L){return v==null||v({role:"system",type:"error",content:`Failed to edit order and report: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="edit_pharmacy_order")je.push((async()=>{X(!0);try{const L=D.serialNumber;let O;if(L?O=[...d].sort((ge,pe)=>new Date(ge.date).getTime()-new Date(pe.date).getTime())[L-1]:O=d.find(ae=>ae.status==="pending"),!O)throw new Error("Order to edit not found.");const ie=JSON.parse(JSON.stringify(O));let re=[...O.medications];const R=D.items_to_remove,fe=D.items;if(Array.isArray(R)&&(re=re.filter(ae=>!R.some(ge=>ge.drug_id&&String(ae.drug_id)===String(ge.drug_id)||ge.name&&ae.name.toLowerCase()===ge.name.toLowerCase()))),Array.isArray(fe))for(const ae of fe){let ge;if(ae.drug_id?ge=y.find(Z=>String(Z.id)===String(ae.drug_id)):ae.name&&(ge=It(ae.name,y)),!ge)throw new Error(`Drug ${ae.name} not found.`);const pe=re.findIndex(Z=>Z.drug_id===String(ge==null?void 0:ge.id)),H={drug_id:String(ge.id),name:ge.name,pack_quantity:ae.pack_quantity||0,loose_quantity:ae.loose_quantity||0,pack_price:Number(ge.mrp),loose_price:0,total_price:0,price:Number(ge.mrp)};pe>=0?re[pe]={...re[pe],...H}:re.push(H)}const Ce={items:re,status:D.status,prescription_for_unavailable_drugs:D.prescription_for_unavailable_drugs,order_total:0};if(!(await Y(`/api/pharmacy-orders/${O.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(Ce)})).ok)throw new Error("Order edit failed.");return b(n),{success:!0,actionType:z,undoData:{orderId:O.id,originalState:ie}}}catch(L){return{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{X(!1)}})());else if(z==="edit_lab_order")je.push((async()=>{ne(!0);try{const L=c.sort((R,fe)=>new Date(fe.createdAt).getTime()-new Date(R.createdAt).getTime()).find(R=>R.status==="pending");if(!L)throw new Error("No pending lab order to edit.");const O=JSON.parse(JSON.stringify(L)),ie={tests:[],status:D.status};if(!(await Y(`/api/lab/orders/${L.id}`,{method:"PUT",body:JSON.stringify(ie),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Lab edit failed.");return De(n),{success:!0,actionType:z,undoData:{orderId:L.id,originalState:O}}}catch(L){return{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="add_complaint_history")je.push((async()=>{V(!0),v==null||v({role:"system",type:"loading",content:"Updating complaint history..."});const L=q;try{if(!e)throw new Error("No record ID.");if(!(await Y(`/api/queue/doctor/complaint/${e}`,{method:"PUT",body:JSON.stringify({complaint:D.complaint}),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Complaint update failed.");return G(D.complaint),n&&at(n),v==null||v({role:"system",type:"success",content:"Complaint history updated."}),{success:!0,actionType:z,undoData:{recordId:e,originalComplaint:L}}}catch(O){return v==null||v({role:"system",type:"error",content:`Complaint history update failed: ${O.message}`}),{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{V(!1)}})());else if(z==="update_case_summary")je.push((async()=>{C(!0),v==null||v({role:"system",type:"loading",content:"Updating case summary..."});const L=r;try{if(!e)throw new Error("No record ID.");const O=await Y(`/api/queue/doctor/complaint/${e}`,{method:"PUT",body:JSON.stringify({case_summary:D.summary}),headers:{"Content-Type":"application/json"}});if(!O.ok)throw new Error("Summary update failed.");const ie=await O.json();return A(ie.case_summary),v==null||v({role:"system",type:"success",content:"Case summary updated."}),{success:!0,actionType:z,undoData:{recordId:e,originalSummary:L}}}catch(O){return v==null||v({role:"system",type:"error",content:`Case summary update failed: ${O.message}`}),{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{C(!1)}})());else if(z==="create_recurring_medication_order")je.push((async()=>{X(!0),ce("Creating recurring medication(s)..."),v==null||v({role:"system",type:"loading",content:"Creating recurring medication(s)..."});try{if(!n)throw new Error("Missing patient ID.");if(!D.items||!Array.isArray(D.items))throw new Error("No items provided for recurring medication order.");const L=await Promise.all(D.items.map(async R=>{let fe=R.drug_id;if(!fe){const Ce=It(R.medication_name,y);fe=Ce?Ce.id:null}if(!fe)throw new Error(`Drug "${R.medication_name}" not found in inventory for recurring medication.`);return{...R,drug_id:fe}})),O=await Y("/api/recurring-medications",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,items:L})});if(!O.ok){const R=await O.json().catch(()=>({}));throw new Error(R.message||"Failed to create recurring medication order")}const ie=await O.json(),re=ie.map(R=>R.id);return n&&Ne&&Ne(n),ce("Recurring medication(s) created."),v==null||v({role:"system",type:"success",content:`Successfully created ${re.length} recurring medication(s).`}),{success:!0,actionType:z,data:ie,undoData:{createdIds:re}}}catch(L){return v==null||v({role:"system",type:"error",content:`Error creating recurring medication: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{X(!1)}})());else if(z==="edit_recurring_medication_order")je.push((async()=>{X(!0),ce("Updating recurring medication..."),v==null||v({role:"system",type:"loading",content:"Updating recurring medication..."});try{if(!n)throw new Error("Missing patient ID.");if(!D.serialNumber||!D.updates)throw new Error("Missing serialNumber or updates for recurring medication edit.");if(!E||E.length===0)throw new Error("No recurring medications found to edit.");const L=D.serialNumber-1;if(L<0||L>=E.length)throw new Error(`Recurring medication with serial number ${D.serialNumber} not found.`);const O=E[L],ie=JSON.parse(JSON.stringify(O));if(D.updates.drug_id===null||D.updates.medication_name){let R=D.updates.drug_id;if(!R&&D.updates.medication_name){const fe=It(D.updates.medication_name,y);R=fe?fe.id:null}if(!R&&D.updates.medication_name)throw new Error(`Drug "${D.updates.medication_name}" not found in inventory for update.`);D.updates.drug_id=R}const re=await Y(`/api/recurring-medications/${O.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(D.updates)});if(!re.ok){const R=await re.json().catch(()=>({}));throw new Error(R.message||"Failed to update recurring medication")}return n&&Ne&&Ne(n),ce("Recurring medication updated."),v==null||v({role:"system",type:"success",content:`Successfully updated recurring medication #${D.serialNumber}.`}),{success:!0,actionType:z,data:{id:O.id,...D.updates},undoData:{medicationId:O.id,originalState:ie}}}catch(L){return v==null||v({role:"system",type:"error",content:`Error updating recurring medication: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{X(!1)}})());else if(z==="end_task")je.push((async()=>(v==null||v({role:"system",type:"success",content:"Task completed."}),{success:!0,actionType:z}))());else{if(z==="bill_lab_order")continue;console.warn(`Unknown action ${z}`),je.push(Promise.resolve({success:!1,actionType:z,error:new Error(`Unknown action: ${z}`),originalActionPayload:D}))}}const ze=await Promise.all(je),te=ze.filter(D=>!D.success);if(te.length>0){console.log("AI Actions Failed. Initiating Rollback...",te);const D=ze.filter(re=>re.success),z=[...D].reverse();await Mt(z);const L=te.map(re=>{var R;return`${re.actionType}: ${(R=re.error)==null?void 0:R.message}`}).join("; "),O=D.length>0?` I successfully rolled back ${D.length} other actions that succeeded.`:"",ie=`One or more actions failed: [${L}].${O} Please analyze the failure and try again.`;await Ct("multiple_actions",{message:ie},$e,T)}else{const D=ze.filter(L=>L.success);D.length>0&&(yt(D),Yt&&D.forEach(L=>Yt(L.actionType)));const z=Me.find(L=>L.action==="bill_lab_order");if(z&&z.serialNumber){const L=new Map;(c??[]).forEach(R=>L.set(R.id,{...R}));const O=Array.from(L.values());O.sort((R,fe)=>new Date(fe.createdAt).getTime()-new Date(R.createdAt).getTime());const ie=O.length-z.serialNumber,re=O[ie];if(re&&re.id){v==null||v({role:"system",type:"success",content:`Processing billing for Lab Order #${z.serialNumber}...`});try{const R=re.tests.map(H=>({name:H.test_name||H.name,price:typeof H.price=="string"?parseFloat(H.price):H.price||0,discount_percentage:0,quantity:1,item_id:H.test_id||H.id,type:"lab_test"})),fe=R.reduce((H,Z)=>H+Z.price,0),Ce=0,xe=fe,ae={patientId:re.patient_id,items:R.map(H=>({...H,total:H.price})),amount:xe,paymentMode:"cash",type:"lab",related_id:re.id,status:"paid",discountPercentage:0},ge=await Y("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)}),pe=await ge.json();if(!ge.ok)throw new Error(pe.message||"Failed to create bill");await Y(`/api/lab/${re.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:pe.id})}),n&&De(n),Ot&&(Ot({billId:pe.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:re.createdAt,items:R,subtotal:fe,totalDiscount:Ce,grandTotal:xe,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||"",labLetterheadUrl:a==null?void 0:a.labLetterheadUrl}),v==null||v({role:"system",type:"success",content:`Bill #${pe.id} created. Opening print dialog.`}))}catch(R){console.error("Auto-billing failed:",R),v==null||v({role:"system",type:"error",content:`Billing failed: ${R.message}`})}}else console.warn(`Could not find lab order with serialNumber ${z.serialNumber} to bill.`),v==null||v({role:"system",type:"error",content:`Could not find lab order #${z.serialNumber} to bill.`})}if(Ve&&typeof Ve.question=="string")Se(Ve.question),me(Array.isArray(Ve.options)?Ve.options:[]);else if(D.length===0&&!z&&!Qe)throw new Error("AI response did not result in a recognized or performed function call.")}}catch(ue){await Ct("parse_json_actions",ue,$e,T)}else throw new Error("AI response did not contain a recognized function call.")};Je=async($e,T=0)=>{if(T>1){j("AI call failed after multiple retries. Please try a different prompt."),F(!1);return}F(!0),j(null);let P;const ee=[...o,$e].join(`

`);try{const ue=new Map;(c??[]).forEach(te=>{ue.set(te.id,{...te})}),(u??[]).forEach(te=>{if(!ue.has(te.id))ue.set(te.id,{id:te.id,patient_id:te.patient_id,tests:te.tests,status:te.status,createdAt:te.createdAt,report:te});else{const D=ue.get(te.id);D&&(D.report=te,D.status=te.status)}});const Le=Array.from(ue.values());Le.sort((te,D)=>new Date(D.createdAt).getTime()-new Date(te.createdAt).getTime());const Me=Le.map((te,D)=>{let z=null;if(te.report)try{const L=typeof te.report.report_content=="string"?te.report.report_content:JSON.stringify(te.report.report_content||{}),O=JSON.parse(L||"{}"),ie=re=>{const R=O[re.id]||{},fe=Ce=>({name:Ce.name,value:R[Ce.name]!==void 0?String(R[Ce.name]):String(Ce.defaultValue),normal_range:Ce.normal_range||"N/A"});return{testId:re.id,testName:re.name,parameters:(re.default_parameters||[]).map(fe)}};z={reportId:te.report.reportId,reportDate:te.report.report_date,tests:(te.tests||[]).map(ie)}}catch{z={reportId:te.report.reportId,reportDate:te.report.report_date,reportContent:typeof te.report.report_content=="string"?te.report.report_content:JSON.stringify(te.report.report_content),error:"Failed to parse report content JSON."}}return{serialNumber:Le.length-D,orderId:te.id,orderDate:isNaN(new Date(te.createdAt).getTime())?te.createdAt:new Date(te.createdAt).toISOString(),tests:te.tests.map(L=>({id:L.id,name:L.name,price:L.price})),status:te.status,report:z}}),je=m.map(te=>{try{return{...te,createdAt:isNaN(new Date(te.createdAt).getTime())?te.createdAt:new Date(te.createdAt).toISOString()}}catch{return te}}),Qe=[...d].sort((te,D)=>{const z=new Date(te.date).getTime(),L=new Date(D.date).getTime();return z-L}).map((te,D)=>{try{return{serialNumber:D+1,...te,date:te.date&&!isNaN(new Date(te.date).getTime())?new Date(te.date).toISOString():te.date}}catch{return{serialNumber:D+1,...te}}}),ze={query:ee,currentDateTime:new Date().toISOString(),patientName:(t==null?void 0:t.name)||"",patientAge:(t==null?void 0:t.age)||void 0,patientGender:(t==null?void 0:t.gender)||void 0,case_summary:r||"",case_summary_last_updated:s?new Date(s).toISOString():void 0,clinic_ai_memory:(a==null?void 0:a.aiMemory)||"",clinic_ai_memory_last_updated:a!=null&&a.aiMemoryUpdatedAt?new Date(a.aiMemoryUpdatedAt).toISOString():void 0,clinic_wide_system_prompt:(a==null?void 0:a.clinicWideSystemPrompt)||"",labHistory:Me,pharmacyOrders:Qe,pastComplaints:je,pharmacyInventory:y,labInventory:p,recurringMedications:E};if(console.log("DEBUG: Payload before sending to Gemini API:",JSON.stringify(ze,null,2)),P=await Mh(ze,l),P){$(P),v==null||v({role:"ai",content:P});const te=/```json\s*([\s\S]*?)\s*```/,D=P.match(te);if(D&&D[1])B(P.replace(te,"").trim()),I(D[1].trim());else{const z=P.trim();if(z.startsWith("{")&&z.endsWith("}"))try{JSON.parse(z),B(""),I(z)}catch{B(z),I(null)}else if(z.startsWith("[")&&z.endsWith("]"))try{JSON.parse(z),B(""),I(z)}catch{B(z),I(null)}else B(z),I(null)}W(!1),n&&P&&await St(n,P),await We(P,T),G("")}else throw new Error("Invalid AI response format.")}catch(ue){await Ct("call_generative_api",ue,P,T)}finally{F(!1)}};const St=async($e,T)=>{Fe(!0),_e(null);try{const P={ai_response:T},S=await Y(`/api/patients/${$e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(P)});if(!S.ok){const ee=await S.json().catch(()=>({}));throw new Error(ee.message||`Failed to save AI response to patient: ${S.statusText}`)}}catch(P){_e(`AI Response Save Error: ${P.message}`),v==null||v({role:"system",type:"error",content:`AI Response Save Error: ${P.message}`})}finally{Fe(!1)}};return x.useImperativeHandle(Kt,()=>({callGenerativeApi:Je,undoLastAction:Zt})),null}),Ro=-1,Nr=0,zn=1,br=2,Gi=3,Yi=4,Ki=5,Zi=6,Fo=7,zo=8,Is=typeof self=="object"?self:globalThis,Wh=(e,n)=>{const t=(s,a)=>(e.set(a,s),s),r=s=>{if(e.has(s))return e.get(s);const[a,o]=n[s];switch(a){case Nr:case Ro:return t(o,s);case zn:{const l=t([],s);for(const c of o)l.push(r(c));return l}case br:{const l=t({},s);for(const[c,u]of o)l[r(c)]=r(u);return l}case Gi:return t(new Date(o),s);case Yi:{const{source:l,flags:c}=o;return t(new RegExp(l,c),s)}case Ki:{const l=t(new Map,s);for(const[c,u]of o)l.set(r(c),r(u));return l}case Zi:{const l=t(new Set,s);for(const c of o)l.add(r(c));return l}case Fo:{const{name:l,message:c}=o;return t(new Is[l](c),s)}case zo:return t(BigInt(o),s);case"BigInt":return t(Object(BigInt(o)),s);case"ArrayBuffer":return t(new Uint8Array(o).buffer,o);case"DataView":{const{buffer:l}=new Uint8Array(o);return t(new DataView(l),o)}}return t(new Is[a](o),s)};return r},Os=e=>Wh(new Map,e)(0),dn="",{toString:Vh}={},{keys:Jh}=Object,$n=e=>{const n=typeof e;if(n!=="object"||!e)return[Nr,n];const t=Vh.call(e).slice(8,-1);switch(t){case"Array":return[zn,dn];case"Object":return[br,dn];case"Date":return[Gi,dn];case"RegExp":return[Yi,dn];case"Map":return[Ki,dn];case"Set":return[Zi,dn];case"DataView":return[zn,t]}return t.includes("Array")?[zn,t]:t.includes("Error")?[Fo,t]:[br,t]},dr=([e,n])=>e===Nr&&(n==="function"||n==="symbol"),Qh=(e,n,t,r)=>{const s=(o,l)=>{const c=r.push(o)-1;return t.set(l,c),c},a=o=>{if(t.has(o))return t.get(o);let[l,c]=$n(o);switch(l){case Nr:{let m=o;switch(c){case"bigint":l=zo,m=o.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+c);m=null;break;case"undefined":return s([Ro],o)}return s([l,m],o)}case zn:{if(c){let y=o;return c==="DataView"?y=new Uint8Array(o.buffer):c==="ArrayBuffer"&&(y=new Uint8Array(o)),s([c,[...y]],o)}const m=[],d=s([l,m],o);for(const y of o)m.push(a(y));return d}case br:{if(c)switch(c){case"BigInt":return s([c,o.toString()],o);case"Boolean":case"Number":case"String":return s([c,o.valueOf()],o)}if(n&&"toJSON"in o)return a(o.toJSON());const m=[],d=s([l,m],o);for(const y of Jh(o))(e||!dr($n(o[y])))&&m.push([a(y),a(o[y])]);return d}case Gi:return s([l,o.toISOString()],o);case Yi:{const{source:m,flags:d}=o;return s([l,{source:m,flags:d}],o)}case Ki:{const m=[],d=s([l,m],o);for(const[y,p]of o)(e||!(dr($n(y))||dr($n(p))))&&m.push([a(y),a(p)]);return d}case Zi:{const m=[],d=s([l,m],o);for(const y of o)(e||!dr($n(y)))&&m.push(a(y));return d}}const{message:u}=o;return s([l,{name:c,message:u}],o)};return a},$s=(e,{json:n,lossy:t}={})=>{const r=[];return Qh(!(n||t),!!n,new Map,r)(e),r},qn=typeof structuredClone=="function"?(e,n)=>n&&("json"in n||"lossy"in n)?Os($s(e,n)):structuredClone(e):(e,n)=>Os($s(e,n)),qo=Uo("end"),Bo=Uo("start");function Uo(e){return n;function n(t){const r=t&&t.position&&t.position[e]||{};if(typeof r.line=="number"&&r.line>0&&typeof r.column=="number"&&r.column>0)return{line:r.line,column:r.column,offset:typeof r.offset=="number"&&r.offset>-1?r.offset:void 0}}}function Mo(e){const n=Bo(e),t=qo(e);if(n&&t)return{start:n,end:t}}const Jt=["ariaDescribedBy","ariaLabel","ariaLabelledBy"],Ls={ancestors:{tbody:["table"],td:["table"],th:["table"],thead:["table"],tfoot:["table"],tr:["table"]},attributes:{a:[...Jt,"dataFootnoteBackref","dataFootnoteRef",["className","data-footnote-backref"],"href"],blockquote:["cite"],code:[["className",/^language-./]],del:["cite"],div:["itemScope","itemType"],dl:[...Jt],h2:[["className","sr-only"]],img:[...Jt,"longDesc","src"],input:[["disabled",!0],["type","checkbox"]],ins:["cite"],li:[["className","task-list-item"]],ol:[...Jt,["className","contains-task-list"]],q:["cite"],section:["dataFootnotes",["className","footnotes"]],source:["srcSet"],summary:[...Jt],table:[...Jt],ul:[...Jt,["className","contains-task-list"]],"*":["abbr","accept","acceptCharset","accessKey","action","align","alt","axis","border","cellPadding","cellSpacing","char","charOff","charSet","checked","clear","colSpan","color","cols","compact","coords","dateTime","dir","encType","frame","hSpace","headers","height","hrefLang","htmlFor","id","isMap","itemProp","label","lang","maxLength","media","method","multiple","name","noHref","noShade","noWrap","open","prompt","readOnly","rev","rowSpan","rows","rules","scope","selected","shape","size","span","start","summary","tabIndex","title","useMap","vAlign","value","width"]},clobber:["ariaDescribedBy","ariaLabelledBy","id","name"],clobberPrefix:"user-content-",protocols:{cite:["http","https"],href:["http","https","irc","ircs","mailto","xmpp"],longDesc:["http","https"],src:["http","https"]},required:{input:{disabled:!0,type:"checkbox"}},strip:["script"],tagNames:["a","b","blockquote","br","code","dd","del","details","div","dl","dt","em","h1","h2","h3","h4","h5","h6","hr","i","img","input","ins","kbd","li","ol","p","picture","pre","q","rp","rt","ruby","s","samp","section","source","span","strike","strong","sub","summary","sup","table","tbody","td","tfoot","th","thead","tr","tt","ul","var"]},qt={}.hasOwnProperty;function Gh(e,n){let t={type:"root",children:[]};const r={schema:n?{...Ls,...n}:Ls,stack:[]},s=Ho(r,e);return s&&(Array.isArray(s)?s.length===1?t=s[0]:t.children=s:t=s),t}function Ho(e,n){if(n&&typeof n=="object"){const t=n;switch(typeof t.type=="string"?t.type:""){case"comment":return Yh(e,t);case"doctype":return Kh(e,t);case"element":return Zh(e,t);case"root":return Xh(e,t);case"text":return em(e,t)}}}function Yh(e,n){if(e.schema.allowComments){const t=typeof n.value=="string"?n.value:"",r=t.indexOf("-->"),a={type:"comment",value:r<0?t:t.slice(0,r)};return Un(a,n),a}}function Kh(e,n){if(e.schema.allowDoctypes){const t={type:"doctype"};return Un(t,n),t}}function Zh(e,n){const t=typeof n.tagName=="string"?n.tagName:"";e.stack.push(t);const r=Wo(e,n.children),s=tm(e,n.properties);e.stack.pop();let a=!1;if(t&&t!=="*"&&(!e.schema.tagNames||e.schema.tagNames.includes(t))&&(a=!0,e.schema.ancestors&&qt.call(e.schema.ancestors,t))){const l=e.schema.ancestors[t];let c=-1;for(a=!1;++c<l.length;)e.stack.includes(l[c])&&(a=!0)}if(!a)return e.schema.strip&&!e.schema.strip.includes(t)?r:void 0;const o={type:"element",tagName:t,properties:s,children:r};return Un(o,n),o}function Xh(e,n){const r={type:"root",children:Wo(e,n.children)};return Un(r,n),r}function em(e,n){const r={type:"text",value:typeof n.value=="string"?n.value:""};return Un(r,n),r}function Wo(e,n){const t=[];if(Array.isArray(n)){const r=n;let s=-1;for(;++s<r.length;){const a=Ho(e,r[s]);a&&(Array.isArray(a)?t.push(...a):t.push(a))}}return t}function tm(e,n){const t=e.stack[e.stack.length-1],r=e.schema.attributes,s=e.schema.required,a=r&&qt.call(r,t)?r[t]:void 0,o=r&&qt.call(r,"*")?r["*"]:void 0,l=n&&typeof n=="object"?n:{},c={};let u;for(u in l)if(qt.call(l,u)){const m=l[u];let d=Rs(e,Fs(a,u),u,m);d==null&&(d=Rs(e,Fs(o,u),u,m)),d!=null&&(c[u]=d)}if(s&&qt.call(s,t)){const m=s[t];for(u in m)qt.call(m,u)&&!qt.call(c,u)&&(c[u]=m[u])}return c}function Rs(e,n,t,r){return n?Array.isArray(r)?nm(e,n,t,r):Vo(e,n,t,r):void 0}function nm(e,n,t,r){let s=-1;const a=[];for(;++s<r.length;){const o=Vo(e,n,t,r[s]);(typeof o=="number"||typeof o=="string")&&a.push(o)}return a}function Vo(e,n,t,r){if(!(typeof r!="boolean"&&typeof r!="number"&&typeof r!="string")&&rm(e,t,r)){if(typeof n=="object"&&n.length>1){let s=!1,a=0;for(;++a<n.length;){const o=n[a];if(o&&typeof o=="object"&&"flags"in o){if(o.test(String(r))){s=!0;break}}else if(o===r){s=!0;break}}if(!s)return}return e.schema.clobber&&e.schema.clobberPrefix&&e.schema.clobber.includes(t)?e.schema.clobberPrefix+r:r}}function rm(e,n,t){const r=e.schema.protocols&&qt.call(e.schema.protocols,n)?e.schema.protocols[n]:void 0;if(!r||r.length===0)return!0;const s=String(t),a=s.indexOf(":"),o=s.indexOf("?"),l=s.indexOf("#"),c=s.indexOf("/");if(a<0||c>-1&&a>c||o>-1&&a>o||l>-1&&a>l)return!0;let u=-1;for(;++u<r.length;){const m=r[u];if(a===m.length&&s.slice(0,m.length)===m)return!0}return!1}function Un(e,n){const t=Mo(n);n.data&&(e.data=qn(n.data)),t&&(e.position=t)}function Fs(e,n){let t,r=-1;if(e)for(;++r<e.length;){const s=e[r],a=typeof s=="string"?s:s[0];if(a===n)return s;a==="data*"&&(t=s)}if(n.length>4&&n.slice(0,4).toLowerCase()==="data")return t}function im(e,n){const t={type:"element",tagName:"blockquote",properties:{},children:e.wrap(e.all(n),!0)};return e.patch(n,t),e.applyData(n,t)}function am(e,n){const t={type:"element",tagName:"br",properties:{},children:[]};return e.patch(n,t),[e.applyData(n,t),{type:"text",value:`
`}]}function sm(e,n){const t=n.value?n.value+`
`:"",r={};n.lang&&(r.className=["language-"+n.lang]);let s={type:"element",tagName:"code",properties:r,children:[{type:"text",value:t}]};return n.meta&&(s.data={meta:n.meta}),e.patch(n,s),s=e.applyData(n,s),s={type:"element",tagName:"pre",properties:{},children:[s]},e.patch(n,s),s}function om(e,n){const t={type:"element",tagName:"del",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function lm(e,n){const t={type:"element",tagName:"em",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function cm(e,n){const t=typeof e.options.clobberPrefix=="string"?e.options.clobberPrefix:"user-content-",r=String(n.identifier).toUpperCase(),s=gn(r.toLowerCase()),a=e.footnoteOrder.indexOf(r);let o,l=e.footnoteCounts.get(r);l===void 0?(l=0,e.footnoteOrder.push(r),o=e.footnoteOrder.length):o=a+1,l+=1,e.footnoteCounts.set(r,l);const c={type:"element",tagName:"a",properties:{href:"#"+t+"fn-"+s,id:t+"fnref-"+s+(l>1?"-"+l:""),dataFootnoteRef:!0,ariaDescribedBy:["footnote-label"]},children:[{type:"text",value:String(o)}]};e.patch(n,c);const u={type:"element",tagName:"sup",properties:{},children:[c]};return e.patch(n,u),e.applyData(n,u)}function um(e,n){const t={type:"element",tagName:"h"+n.depth,properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function dm(e,n){if(e.options.allowDangerousHtml){const t={type:"raw",value:n.value};return e.patch(n,t),e.applyData(n,t)}}function Jo(e,n){const t=n.referenceType;let r="]";if(t==="collapsed"?r+="[]":t==="full"&&(r+="["+(n.label||n.identifier)+"]"),n.type==="imageReference")return[{type:"text",value:"!["+n.alt+r}];const s=e.all(n),a=s[0];a&&a.type==="text"?a.value="["+a.value:s.unshift({type:"text",value:"["});const o=s[s.length-1];return o&&o.type==="text"?o.value+=r:s.push({type:"text",value:r}),s}function pm(e,n){const t=String(n.identifier).toUpperCase(),r=e.definitionById.get(t);if(!r)return Jo(e,n);const s={src:gn(r.url||""),alt:n.alt};r.title!==null&&r.title!==void 0&&(s.title=r.title);const a={type:"element",tagName:"img",properties:s,children:[]};return e.patch(n,a),e.applyData(n,a)}function hm(e,n){const t={src:gn(n.url)};n.alt!==null&&n.alt!==void 0&&(t.alt=n.alt),n.title!==null&&n.title!==void 0&&(t.title=n.title);const r={type:"element",tagName:"img",properties:t,children:[]};return e.patch(n,r),e.applyData(n,r)}function mm(e,n){const t={type:"text",value:n.value.replace(/\r?\n|\r/g," ")};e.patch(n,t);const r={type:"element",tagName:"code",properties:{},children:[t]};return e.patch(n,r),e.applyData(n,r)}function fm(e,n){const t=String(n.identifier).toUpperCase(),r=e.definitionById.get(t);if(!r)return Jo(e,n);const s={href:gn(r.url||"")};r.title!==null&&r.title!==void 0&&(s.title=r.title);const a={type:"element",tagName:"a",properties:s,children:e.all(n)};return e.patch(n,a),e.applyData(n,a)}function gm(e,n){const t={href:gn(n.url)};n.title!==null&&n.title!==void 0&&(t.title=n.title);const r={type:"element",tagName:"a",properties:t,children:e.all(n)};return e.patch(n,r),e.applyData(n,r)}function ym(e,n,t){const r=e.all(n),s=t?xm(t):Qo(n),a={},o=[];if(typeof n.checked=="boolean"){const m=r[0];let d;m&&m.type==="element"&&m.tagName==="p"?d=m:(d={type:"element",tagName:"p",properties:{},children:[]},r.unshift(d)),d.children.length>0&&d.children.unshift({type:"text",value:" "}),d.children.unshift({type:"element",tagName:"input",properties:{type:"checkbox",checked:n.checked,disabled:!0},children:[]}),a.className=["task-list-item"]}let l=-1;for(;++l<r.length;){const m=r[l];(s||l!==0||m.type!=="element"||m.tagName!=="p")&&o.push({type:"text",value:`
`}),m.type==="element"&&m.tagName==="p"&&!s?o.push(...m.children):o.push(m)}const c=r[r.length-1];c&&(s||c.type!=="element"||c.tagName!=="p")&&o.push({type:"text",value:`
`});const u={type:"element",tagName:"li",properties:a,children:o};return e.patch(n,u),e.applyData(n,u)}function xm(e){let n=!1;if(e.type==="list"){n=e.spread||!1;const t=e.children;let r=-1;for(;!n&&++r<t.length;)n=Qo(t[r])}return n}function Qo(e){const n=e.spread;return n??e.children.length>1}function bm(e,n){const t={},r=e.all(n);let s=-1;for(typeof n.start=="number"&&n.start!==1&&(t.start=n.start);++s<r.length;){const o=r[s];if(o.type==="element"&&o.tagName==="li"&&o.properties&&Array.isArray(o.properties.className)&&o.properties.className.includes("task-list-item")){t.className=["contains-task-list"];break}}const a={type:"element",tagName:n.ordered?"ol":"ul",properties:t,children:e.wrap(r,!0)};return e.patch(n,a),e.applyData(n,a)}function wm(e,n){const t={type:"element",tagName:"p",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function km(e,n){const t={type:"root",children:e.wrap(e.all(n))};return e.patch(n,t),e.applyData(n,t)}function _m(e,n){const t={type:"element",tagName:"strong",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function Nm(e,n){const t=e.all(n),r=t.shift(),s=[];if(r){const o={type:"element",tagName:"thead",properties:{},children:e.wrap([r],!0)};e.patch(n.children[0],o),s.push(o)}if(t.length>0){const o={type:"element",tagName:"tbody",properties:{},children:e.wrap(t,!0)},l=Bo(n.children[1]),c=qo(n.children[n.children.length-1]);l&&c&&(o.position={start:l,end:c}),s.push(o)}const a={type:"element",tagName:"table",properties:{},children:e.wrap(s,!0)};return e.patch(n,a),e.applyData(n,a)}function vm(e,n,t){const r=t?t.children:void 0,a=(r?r.indexOf(n):1)===0?"th":"td",o=t&&t.type==="table"?t.align:void 0,l=o?o.length:n.children.length;let c=-1;const u=[];for(;++c<l;){const d=n.children[c],y={},p=o?o[c]:void 0;p&&(y.align=p);let E={type:"element",tagName:a,properties:y,children:[]};d&&(E.children=e.all(d),e.patch(d,E),E=e.applyData(d,E)),u.push(E)}const m={type:"element",tagName:"tr",properties:{},children:e.wrap(u,!0)};return e.patch(n,m),e.applyData(n,m)}function jm(e,n){const t={type:"element",tagName:"td",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}const zs=9,qs=32;function Cm(e){const n=String(e),t=/\r?\n|\r/g;let r=t.exec(n),s=0;const a=[];for(;r;)a.push(Bs(n.slice(s,r.index),s>0,!0),r[0]),s=r.index+r[0].length,r=t.exec(n);return a.push(Bs(n.slice(s),s>0,!1)),a.join("")}function Bs(e,n,t){let r=0,s=e.length;if(n){let a=e.codePointAt(r);for(;a===zs||a===qs;)r++,a=e.codePointAt(r)}if(t){let a=e.codePointAt(s-1);for(;a===zs||a===qs;)s--,a=e.codePointAt(s-1)}return s>r?e.slice(r,s):""}function Sm(e,n){const t={type:"text",value:Cm(String(n.value))};return e.patch(n,t),e.applyData(n,t)}function Tm(e,n){const t={type:"element",tagName:"hr",properties:{},children:[]};return e.patch(n,t),e.applyData(n,t)}const Pm={blockquote:im,break:am,code:sm,delete:om,emphasis:lm,footnoteReference:cm,heading:um,html:dm,imageReference:pm,image:hm,inlineCode:mm,linkReference:fm,link:gm,listItem:ym,list:bm,paragraph:wm,root:km,strong:_m,table:Nm,tableCell:jm,tableRow:vm,text:Sm,thematicBreak:Tm,toml:pr,yaml:pr,definition:pr,footnoteDefinition:pr};function pr(){}function Em(e,n){const t=[{type:"text",value:"↩"}];return n>1&&t.push({type:"element",tagName:"sup",properties:{},children:[{type:"text",value:String(n)}]}),t}function Am(e,n){return"Back to reference "+(e+1)+(n>1?"-"+n:"")}function Dm(e){const n=typeof e.options.clobberPrefix=="string"?e.options.clobberPrefix:"user-content-",t=e.options.footnoteBackContent||Em,r=e.options.footnoteBackLabel||Am,s=e.options.footnoteLabel||"Footnotes",a=e.options.footnoteLabelTagName||"h2",o=e.options.footnoteLabelProperties||{className:["sr-only"]},l=[];let c=-1;for(;++c<e.footnoteOrder.length;){const u=e.footnoteById.get(e.footnoteOrder[c]);if(!u)continue;const m=e.all(u),d=String(u.identifier).toUpperCase(),y=gn(d.toLowerCase());let p=0;const E=[],q=e.footnoteCounts.get(d);for(;q!==void 0&&++p<=q;){E.length>0&&E.push({type:"text",value:" "});let B=typeof t=="string"?t:t(c,p);typeof B=="string"&&(B={type:"text",value:B}),E.push({type:"element",tagName:"a",properties:{href:"#"+n+"fnref-"+y+(p>1?"-"+p:""),dataFootnoteBackref:"",ariaLabel:typeof r=="string"?r:r(c,p),className:["data-footnote-backref"]},children:Array.isArray(B)?B:[B]})}const G=m[m.length-1];if(G&&G.type==="element"&&G.tagName==="p"){const B=G.children[G.children.length-1];B&&B.type==="text"?B.value+=" ":G.children.push({type:"text",value:" "}),G.children.push(...E)}else m.push(...E);const $={type:"element",tagName:"li",properties:{id:n+"fn-"+y},children:e.wrap(m,!0)};e.patch(u,$),l.push($)}if(l.length!==0)return{type:"element",tagName:"section",properties:{dataFootnotes:!0,className:["footnotes"]},children:[{type:"element",tagName:a,properties:{...qn(o),id:"footnote-label"},children:[{type:"text",value:s}]},{type:"text",value:`
`},{type:"element",tagName:"ol",properties:{},children:e.wrap(l,!0)},{type:"text",value:`
`}]}}const Li={}.hasOwnProperty,Im={};function Om(e,n){const t=n||Im,r=new Map,s=new Map,a=new Map,o={...Pm,...t.handlers},l={all:u,applyData:Lm,definitionById:r,footnoteById:s,footnoteCounts:a,footnoteOrder:[],handlers:o,one:c,options:t,patch:$m,wrap:Fm};return Co(e,function(m){if(m.type==="definition"||m.type==="footnoteDefinition"){const d=m.type==="definition"?r:s,y=String(m.identifier).toUpperCase();d.has(y)||d.set(y,m)}}),l;function c(m,d){const y=m.type,p=l.handlers[y];if(Li.call(l.handlers,y)&&p)return p(l,m,d);if(l.options.passThrough&&l.options.passThrough.includes(y)){if("children"in m){const{children:q,...G}=m,$=qn(G);return $.children=l.all(m),$}return qn(m)}return(l.options.unknownHandler||Rm)(l,m,d)}function u(m){const d=[];if("children"in m){const y=m.children;let p=-1;for(;++p<y.length;){const E=l.one(y[p],m);if(E){if(p&&y[p-1].type==="break"&&(!Array.isArray(E)&&E.type==="text"&&(E.value=Us(E.value)),!Array.isArray(E)&&E.type==="element")){const q=E.children[0];q&&q.type==="text"&&(q.value=Us(q.value))}Array.isArray(E)?d.push(...E):d.push(E)}}}return d}}function $m(e,n){e.position&&(n.position=Mo(e))}function Lm(e,n){let t=n;if(e&&e.data){const r=e.data.hName,s=e.data.hChildren,a=e.data.hProperties;if(typeof r=="string")if(t.type==="element")t.tagName=r;else{const o="children"in t?t.children:[t];t={type:"element",tagName:r,properties:{},children:o}}t.type==="element"&&a&&Object.assign(t.properties,qn(a)),"children"in t&&t.children&&s!==null&&s!==void 0&&(t.children=s)}return t}function Rm(e,n){const t=n.data||{},r="value"in n&&!(Li.call(t,"hProperties")||Li.call(t,"hChildren"))?{type:"text",value:n.value}:{type:"element",tagName:"div",properties:{},children:e.all(n)};return e.patch(n,r),e.applyData(n,r)}function Fm(e,n){const t=[];let r=-1;for(n&&t.push({type:"text",value:`
`});++r<e.length;)r&&t.push({type:"text",value:`
`}),t.push(e[r]);return n&&e.length>0&&t.push({type:"text",value:`
`}),t}function Us(e){let n=0,t=e.charCodeAt(n);for(;t===9||t===32;)n++,t=e.charCodeAt(n);return e.slice(n)}function zm(e,n){const t=Om(e,n),r=t.one(e,void 0),s=Dm(t),a=Array.isArray(r)?{type:"root",children:r}:r||{type:"root",children:[]};return s&&a.children.push({type:"text",value:`
`},s),a}const qm=["area","base","basefont","bgsound","br","col","command","embed","frame","hr","image","img","input","keygen","link","meta","param","source","track","wbr"];class Mn{constructor(n,t,r){this.normal=t,this.property=n,r&&(this.space=r)}}Mn.prototype.normal={};Mn.prototype.property={};Mn.prototype.space=void 0;function Go(e,n){const t={},r={};for(const s of e)Object.assign(t,s.property),Object.assign(r,s.normal);return new Mn(t,r,n)}function Ri(e){return e.toLowerCase()}class Xe{constructor(n,t){this.attribute=t,this.property=n}}Xe.prototype.attribute="";Xe.prototype.booleanish=!1;Xe.prototype.boolean=!1;Xe.prototype.commaOrSpaceSeparated=!1;Xe.prototype.commaSeparated=!1;Xe.prototype.defined=!1;Xe.prototype.mustUseProperty=!1;Xe.prototype.number=!1;Xe.prototype.overloadedBoolean=!1;Xe.prototype.property="";Xe.prototype.spaceSeparated=!1;Xe.prototype.space=void 0;let Bm=0;const ke=Gt(),Be=Gt(),Fi=Gt(),U=Gt(),Ie=Gt(),hn=Gt(),rt=Gt();function Gt(){return 2**++Bm}const zi=Object.freeze(Object.defineProperty({__proto__:null,boolean:ke,booleanish:Be,commaOrSpaceSeparated:rt,commaSeparated:hn,number:U,overloadedBoolean:Fi,spaceSeparated:Ie},Symbol.toStringTag,{value:"Module"})),_i=Object.keys(zi);class Xi extends Xe{constructor(n,t,r,s){let a=-1;if(super(n,t),Ms(this,"space",s),typeof r=="number")for(;++a<_i.length;){const o=_i[a];Ms(this,_i[a],(r&zi[o])===zi[o])}}}Xi.prototype.defined=!0;function Ms(e,n,t){t&&(e[n]=t)}function yn(e){const n={},t={};for(const[r,s]of Object.entries(e.properties)){const a=new Xi(r,e.transform(e.attributes||{},r),s,e.space);e.mustUseProperty&&e.mustUseProperty.includes(r)&&(a.mustUseProperty=!0),n[r]=a,t[Ri(r)]=r,t[Ri(a.attribute)]=r}return new Mn(n,t,e.space)}const Yo=yn({properties:{ariaActiveDescendant:null,ariaAtomic:Be,ariaAutoComplete:null,ariaBusy:Be,ariaChecked:Be,ariaColCount:U,ariaColIndex:U,ariaColSpan:U,ariaControls:Ie,ariaCurrent:null,ariaDescribedBy:Ie,ariaDetails:null,ariaDisabled:Be,ariaDropEffect:Ie,ariaErrorMessage:null,ariaExpanded:Be,ariaFlowTo:Ie,ariaGrabbed:Be,ariaHasPopup:null,ariaHidden:Be,ariaInvalid:null,ariaKeyShortcuts:null,ariaLabel:null,ariaLabelledBy:Ie,ariaLevel:U,ariaLive:null,ariaModal:Be,ariaMultiLine:Be,ariaMultiSelectable:Be,ariaOrientation:null,ariaOwns:Ie,ariaPlaceholder:null,ariaPosInSet:U,ariaPressed:Be,ariaReadOnly:Be,ariaRelevant:null,ariaRequired:Be,ariaRoleDescription:Ie,ariaRowCount:U,ariaRowIndex:U,ariaRowSpan:U,ariaSelected:Be,ariaSetSize:U,ariaSort:null,ariaValueMax:U,ariaValueMin:U,ariaValueNow:U,ariaValueText:null,role:null},transform(e,n){return n==="role"?n:"aria-"+n.slice(4).toLowerCase()}});function Ko(e,n){return n in e?e[n]:n}function Zo(e,n){return Ko(e,n.toLowerCase())}const Um=yn({attributes:{acceptcharset:"accept-charset",classname:"class",htmlfor:"for",httpequiv:"http-equiv"},mustUseProperty:["checked","multiple","muted","selected"],properties:{abbr:null,accept:hn,acceptCharset:Ie,accessKey:Ie,action:null,allow:null,allowFullScreen:ke,allowPaymentRequest:ke,allowUserMedia:ke,alt:null,as:null,async:ke,autoCapitalize:null,autoComplete:Ie,autoFocus:ke,autoPlay:ke,blocking:Ie,capture:null,charSet:null,checked:ke,cite:null,className:Ie,cols:U,colSpan:null,content:null,contentEditable:Be,controls:ke,controlsList:Ie,coords:U|hn,crossOrigin:null,data:null,dateTime:null,decoding:null,default:ke,defer:ke,dir:null,dirName:null,disabled:ke,download:Fi,draggable:Be,encType:null,enterKeyHint:null,fetchPriority:null,form:null,formAction:null,formEncType:null,formMethod:null,formNoValidate:ke,formTarget:null,headers:Ie,height:U,hidden:Fi,high:U,href:null,hrefLang:null,htmlFor:Ie,httpEquiv:Ie,id:null,imageSizes:null,imageSrcSet:null,inert:ke,inputMode:null,integrity:null,is:null,isMap:ke,itemId:null,itemProp:Ie,itemRef:Ie,itemScope:ke,itemType:Ie,kind:null,label:null,lang:null,language:null,list:null,loading:null,loop:ke,low:U,manifest:null,max:null,maxLength:U,media:null,method:null,min:null,minLength:U,multiple:ke,muted:ke,name:null,nonce:null,noModule:ke,noValidate:ke,onAbort:null,onAfterPrint:null,onAuxClick:null,onBeforeMatch:null,onBeforePrint:null,onBeforeToggle:null,onBeforeUnload:null,onBlur:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onContextLost:null,onContextMenu:null,onContextRestored:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnded:null,onError:null,onFocus:null,onFormData:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLanguageChange:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadEnd:null,onLoadStart:null,onMessage:null,onMessageError:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRejectionHandled:null,onReset:null,onResize:null,onScroll:null,onScrollEnd:null,onSecurityPolicyViolation:null,onSeeked:null,onSeeking:null,onSelect:null,onSlotChange:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnhandledRejection:null,onUnload:null,onVolumeChange:null,onWaiting:null,onWheel:null,open:ke,optimum:U,pattern:null,ping:Ie,placeholder:null,playsInline:ke,popover:null,popoverTarget:null,popoverTargetAction:null,poster:null,preload:null,readOnly:ke,referrerPolicy:null,rel:Ie,required:ke,reversed:ke,rows:U,rowSpan:U,sandbox:Ie,scope:null,scoped:ke,seamless:ke,selected:ke,shadowRootClonable:ke,shadowRootDelegatesFocus:ke,shadowRootMode:null,shape:null,size:U,sizes:null,slot:null,span:U,spellCheck:Be,src:null,srcDoc:null,srcLang:null,srcSet:null,start:U,step:null,style:null,tabIndex:U,target:null,title:null,translate:null,type:null,typeMustMatch:ke,useMap:null,value:Be,width:U,wrap:null,writingSuggestions:null,align:null,aLink:null,archive:Ie,axis:null,background:null,bgColor:null,border:U,borderColor:null,bottomMargin:U,cellPadding:null,cellSpacing:null,char:null,charOff:null,classId:null,clear:null,code:null,codeBase:null,codeType:null,color:null,compact:ke,declare:ke,event:null,face:null,frame:null,frameBorder:null,hSpace:U,leftMargin:U,link:null,longDesc:null,lowSrc:null,marginHeight:U,marginWidth:U,noResize:ke,noHref:ke,noShade:ke,noWrap:ke,object:null,profile:null,prompt:null,rev:null,rightMargin:U,rules:null,scheme:null,scrolling:Be,standby:null,summary:null,text:null,topMargin:U,valueType:null,version:null,vAlign:null,vLink:null,vSpace:U,allowTransparency:null,autoCorrect:null,autoSave:null,disablePictureInPicture:ke,disableRemotePlayback:ke,prefix:null,property:null,results:U,security:null,unselectable:null},space:"html",transform:Zo}),Mm=yn({attributes:{accentHeight:"accent-height",alignmentBaseline:"alignment-baseline",arabicForm:"arabic-form",baselineShift:"baseline-shift",capHeight:"cap-height",className:"class",clipPath:"clip-path",clipRule:"clip-rule",colorInterpolation:"color-interpolation",colorInterpolationFilters:"color-interpolation-filters",colorProfile:"color-profile",colorRendering:"color-rendering",crossOrigin:"crossorigin",dataType:"datatype",dominantBaseline:"dominant-baseline",enableBackground:"enable-background",fillOpacity:"fill-opacity",fillRule:"fill-rule",floodColor:"flood-color",floodOpacity:"flood-opacity",fontFamily:"font-family",fontSize:"font-size",fontSizeAdjust:"font-size-adjust",fontStretch:"font-stretch",fontStyle:"font-style",fontVariant:"font-variant",fontWeight:"font-weight",glyphName:"glyph-name",glyphOrientationHorizontal:"glyph-orientation-horizontal",glyphOrientationVertical:"glyph-orientation-vertical",hrefLang:"hreflang",horizAdvX:"horiz-adv-x",horizOriginX:"horiz-origin-x",horizOriginY:"horiz-origin-y",imageRendering:"image-rendering",letterSpacing:"letter-spacing",lightingColor:"lighting-color",markerEnd:"marker-end",markerMid:"marker-mid",markerStart:"marker-start",navDown:"nav-down",navDownLeft:"nav-down-left",navDownRight:"nav-down-right",navLeft:"nav-left",navNext:"nav-next",navPrev:"nav-prev",navRight:"nav-right",navUp:"nav-up",navUpLeft:"nav-up-left",navUpRight:"nav-up-right",onAbort:"onabort",onActivate:"onactivate",onAfterPrint:"onafterprint",onBeforePrint:"onbeforeprint",onBegin:"onbegin",onCancel:"oncancel",onCanPlay:"oncanplay",onCanPlayThrough:"oncanplaythrough",onChange:"onchange",onClick:"onclick",onClose:"onclose",onCopy:"oncopy",onCueChange:"oncuechange",onCut:"oncut",onDblClick:"ondblclick",onDrag:"ondrag",onDragEnd:"ondragend",onDragEnter:"ondragenter",onDragExit:"ondragexit",onDragLeave:"ondragleave",onDragOver:"ondragover",onDragStart:"ondragstart",onDrop:"ondrop",onDurationChange:"ondurationchange",onEmptied:"onemptied",onEnd:"onend",onEnded:"onended",onError:"onerror",onFocus:"onfocus",onFocusIn:"onfocusin",onFocusOut:"onfocusout",onHashChange:"onhashchange",onInput:"oninput",onInvalid:"oninvalid",onKeyDown:"onkeydown",onKeyPress:"onkeypress",onKeyUp:"onkeyup",onLoad:"onload",onLoadedData:"onloadeddata",onLoadedMetadata:"onloadedmetadata",onLoadStart:"onloadstart",onMessage:"onmessage",onMouseDown:"onmousedown",onMouseEnter:"onmouseenter",onMouseLeave:"onmouseleave",onMouseMove:"onmousemove",onMouseOut:"onmouseout",onMouseOver:"onmouseover",onMouseUp:"onmouseup",onMouseWheel:"onmousewheel",onOffline:"onoffline",onOnline:"ononline",onPageHide:"onpagehide",onPageShow:"onpageshow",onPaste:"onpaste",onPause:"onpause",onPlay:"onplay",onPlaying:"onplaying",onPopState:"onpopstate",onProgress:"onprogress",onRateChange:"onratechange",onRepeat:"onrepeat",onReset:"onreset",onResize:"onresize",onScroll:"onscroll",onSeeked:"onseeked",onSeeking:"onseeking",onSelect:"onselect",onShow:"onshow",onStalled:"onstalled",onStorage:"onstorage",onSubmit:"onsubmit",onSuspend:"onsuspend",onTimeUpdate:"ontimeupdate",onToggle:"ontoggle",onUnload:"onunload",onVolumeChange:"onvolumechange",onWaiting:"onwaiting",onZoom:"onzoom",overlinePosition:"overline-position",overlineThickness:"overline-thickness",paintOrder:"paint-order",panose1:"panose-1",pointerEvents:"pointer-events",referrerPolicy:"referrerpolicy",renderingIntent:"rendering-intent",shapeRendering:"shape-rendering",stopColor:"stop-color",stopOpacity:"stop-opacity",strikethroughPosition:"strikethrough-position",strikethroughThickness:"strikethrough-thickness",strokeDashArray:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",strokeLineCap:"stroke-linecap",strokeLineJoin:"stroke-linejoin",strokeMiterLimit:"stroke-miterlimit",strokeOpacity:"stroke-opacity",strokeWidth:"stroke-width",tabIndex:"tabindex",textAnchor:"text-anchor",textDecoration:"text-decoration",textRendering:"text-rendering",transformOrigin:"transform-origin",typeOf:"typeof",underlinePosition:"underline-position",underlineThickness:"underline-thickness",unicodeBidi:"unicode-bidi",unicodeRange:"unicode-range",unitsPerEm:"units-per-em",vAlphabetic:"v-alphabetic",vHanging:"v-hanging",vIdeographic:"v-ideographic",vMathematical:"v-mathematical",vectorEffect:"vector-effect",vertAdvY:"vert-adv-y",vertOriginX:"vert-origin-x",vertOriginY:"vert-origin-y",wordSpacing:"word-spacing",writingMode:"writing-mode",xHeight:"x-height",playbackOrder:"playbackorder",timelineBegin:"timelinebegin"},properties:{about:rt,accentHeight:U,accumulate:null,additive:null,alignmentBaseline:null,alphabetic:U,amplitude:U,arabicForm:null,ascent:U,attributeName:null,attributeType:null,azimuth:U,bandwidth:null,baselineShift:null,baseFrequency:null,baseProfile:null,bbox:null,begin:null,bias:U,by:null,calcMode:null,capHeight:U,className:Ie,clip:null,clipPath:null,clipPathUnits:null,clipRule:null,color:null,colorInterpolation:null,colorInterpolationFilters:null,colorProfile:null,colorRendering:null,content:null,contentScriptType:null,contentStyleType:null,crossOrigin:null,cursor:null,cx:null,cy:null,d:null,dataType:null,defaultAction:null,descent:U,diffuseConstant:U,direction:null,display:null,dur:null,divisor:U,dominantBaseline:null,download:ke,dx:null,dy:null,edgeMode:null,editable:null,elevation:U,enableBackground:null,end:null,event:null,exponent:U,externalResourcesRequired:null,fill:null,fillOpacity:U,fillRule:null,filter:null,filterRes:null,filterUnits:null,floodColor:null,floodOpacity:null,focusable:null,focusHighlight:null,fontFamily:null,fontSize:null,fontSizeAdjust:null,fontStretch:null,fontStyle:null,fontVariant:null,fontWeight:null,format:null,fr:null,from:null,fx:null,fy:null,g1:hn,g2:hn,glyphName:hn,glyphOrientationHorizontal:null,glyphOrientationVertical:null,glyphRef:null,gradientTransform:null,gradientUnits:null,handler:null,hanging:U,hatchContentUnits:null,hatchUnits:null,height:null,href:null,hrefLang:null,horizAdvX:U,horizOriginX:U,horizOriginY:U,id:null,ideographic:U,imageRendering:null,initialVisibility:null,in:null,in2:null,intercept:U,k:U,k1:U,k2:U,k3:U,k4:U,kernelMatrix:rt,kernelUnitLength:null,keyPoints:null,keySplines:null,keyTimes:null,kerning:null,lang:null,lengthAdjust:null,letterSpacing:null,lightingColor:null,limitingConeAngle:U,local:null,markerEnd:null,markerMid:null,markerStart:null,markerHeight:null,markerUnits:null,markerWidth:null,mask:null,maskContentUnits:null,maskUnits:null,mathematical:null,max:null,media:null,mediaCharacterEncoding:null,mediaContentEncodings:null,mediaSize:U,mediaTime:null,method:null,min:null,mode:null,name:null,navDown:null,navDownLeft:null,navDownRight:null,navLeft:null,navNext:null,navPrev:null,navRight:null,navUp:null,navUpLeft:null,navUpRight:null,numOctaves:null,observer:null,offset:null,onAbort:null,onActivate:null,onAfterPrint:null,onBeforePrint:null,onBegin:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnd:null,onEnded:null,onError:null,onFocus:null,onFocusIn:null,onFocusOut:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadStart:null,onMessage:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onMouseWheel:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRepeat:null,onReset:null,onResize:null,onScroll:null,onSeeked:null,onSeeking:null,onSelect:null,onShow:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnload:null,onVolumeChange:null,onWaiting:null,onZoom:null,opacity:null,operator:null,order:null,orient:null,orientation:null,origin:null,overflow:null,overlay:null,overlinePosition:U,overlineThickness:U,paintOrder:null,panose1:null,path:null,pathLength:U,patternContentUnits:null,patternTransform:null,patternUnits:null,phase:null,ping:Ie,pitch:null,playbackOrder:null,pointerEvents:null,points:null,pointsAtX:U,pointsAtY:U,pointsAtZ:U,preserveAlpha:null,preserveAspectRatio:null,primitiveUnits:null,propagate:null,property:rt,r:null,radius:null,referrerPolicy:null,refX:null,refY:null,rel:rt,rev:rt,renderingIntent:null,repeatCount:null,repeatDur:null,requiredExtensions:rt,requiredFeatures:rt,requiredFonts:rt,requiredFormats:rt,resource:null,restart:null,result:null,rotate:null,rx:null,ry:null,scale:null,seed:null,shapeRendering:null,side:null,slope:null,snapshotTime:null,specularConstant:U,specularExponent:U,spreadMethod:null,spacing:null,startOffset:null,stdDeviation:null,stemh:null,stemv:null,stitchTiles:null,stopColor:null,stopOpacity:null,strikethroughPosition:U,strikethroughThickness:U,string:null,stroke:null,strokeDashArray:rt,strokeDashOffset:null,strokeLineCap:null,strokeLineJoin:null,strokeMiterLimit:U,strokeOpacity:U,strokeWidth:null,style:null,surfaceScale:U,syncBehavior:null,syncBehaviorDefault:null,syncMaster:null,syncTolerance:null,syncToleranceDefault:null,systemLanguage:rt,tabIndex:U,tableValues:null,target:null,targetX:U,targetY:U,textAnchor:null,textDecoration:null,textRendering:null,textLength:null,timelineBegin:null,title:null,transformBehavior:null,type:null,typeOf:rt,to:null,transform:null,transformOrigin:null,u1:null,u2:null,underlinePosition:U,underlineThickness:U,unicode:null,unicodeBidi:null,unicodeRange:null,unitsPerEm:U,values:null,vAlphabetic:U,vMathematical:U,vectorEffect:null,vHanging:U,vIdeographic:U,version:null,vertAdvY:U,vertOriginX:U,vertOriginY:U,viewBox:null,viewTarget:null,visibility:null,width:null,widths:null,wordSpacing:null,writingMode:null,x:null,x1:null,x2:null,xChannelSelector:null,xHeight:U,y:null,y1:null,y2:null,yChannelSelector:null,z:null,zoomAndPan:null},space:"svg",transform:Ko}),Xo=yn({properties:{xLinkActuate:null,xLinkArcRole:null,xLinkHref:null,xLinkRole:null,xLinkShow:null,xLinkTitle:null,xLinkType:null},space:"xlink",transform(e,n){return"xlink:"+n.slice(5).toLowerCase()}}),el=yn({attributes:{xmlnsxlink:"xmlns:xlink"},properties:{xmlnsXLink:null,xmlns:null},space:"xmlns",transform:Zo}),tl=yn({properties:{xmlBase:null,xmlLang:null,xmlSpace:null},space:"xml",transform(e,n){return"xml:"+n.slice(3).toLowerCase()}}),Hm=/[A-Z]/g,Hs=/-[a-z]/g,Wm=/^data[-\w.:]+$/i;function Vm(e,n){const t=Ri(n);let r=n,s=Xe;if(t in e.normal)return e.property[e.normal[t]];if(t.length>4&&t.slice(0,4)==="data"&&Wm.test(n)){if(n.charAt(4)==="-"){const a=n.slice(5).replace(Hs,Qm);r="data"+a.charAt(0).toUpperCase()+a.slice(1)}else{const a=n.slice(4);if(!Hs.test(a)){let o=a.replace(Hm,Jm);o.charAt(0)!=="-"&&(o="-"+o),n="data"+o}}s=Xi}return new s(r,n)}function Jm(e){return"-"+e.toLowerCase()}function Qm(e){return e.charAt(1).toUpperCase()}const Gm=Go([Yo,Um,Xo,el,tl],"html"),nl=Go([Yo,Mm,Xo,el,tl],"svg"),Ym=/["&'<>`]/g,Km=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,Zm=/[\x01-\t\v\f\x0E-\x1F\x7F\x81\x8D\x8F\x90\x9D\xA0-\uFFFF]/g,Xm=/[|\\{}()[\]^$+*?.]/g,Ws=new WeakMap;function ef(e,n){if(e=e.replace(n.subset?tf(n.subset):Ym,r),n.subset||n.escapeOnly)return e;return e.replace(Km,t).replace(Zm,r);function t(s,a,o){return n.format((s.charCodeAt(0)-55296)*1024+s.charCodeAt(1)-56320+65536,o.charCodeAt(a+2),n)}function r(s,a,o){return n.format(s.charCodeAt(0),o.charCodeAt(a+1),n)}}function tf(e){let n=Ws.get(e);return n||(n=nf(e),Ws.set(e,n)),n}function nf(e){const n=[];let t=-1;for(;++t<e.length;)n.push(e[t].replace(Xm,"\\$&"));return new RegExp("(?:"+n.join("|")+")","g")}const rf=/[\dA-Fa-f]/;function af(e,n,t){const r="&#x"+e.toString(16).toUpperCase();return t&&n&&!rf.test(String.fromCharCode(n))?r:r+";"}const sf=/\d/;function of(e,n,t){const r="&#"+String(e);return t&&n&&!sf.test(String.fromCharCode(n))?r:r+";"}const lf=["AElig","AMP","Aacute","Acirc","Agrave","Aring","Atilde","Auml","COPY","Ccedil","ETH","Eacute","Ecirc","Egrave","Euml","GT","Iacute","Icirc","Igrave","Iuml","LT","Ntilde","Oacute","Ocirc","Ograve","Oslash","Otilde","Ouml","QUOT","REG","THORN","Uacute","Ucirc","Ugrave","Uuml","Yacute","aacute","acirc","acute","aelig","agrave","amp","aring","atilde","auml","brvbar","ccedil","cedil","cent","copy","curren","deg","divide","eacute","ecirc","egrave","eth","euml","frac12","frac14","frac34","gt","iacute","icirc","iexcl","igrave","iquest","iuml","laquo","lt","macr","micro","middot","nbsp","not","ntilde","oacute","ocirc","ograve","ordf","ordm","oslash","otilde","ouml","para","plusmn","pound","quot","raquo","reg","sect","shy","sup1","sup2","sup3","szlig","thorn","times","uacute","ucirc","ugrave","uml","uuml","yacute","yen","yuml"],Ni={nbsp:" ",iexcl:"¡",cent:"¢",pound:"£",curren:"¤",yen:"¥",brvbar:"¦",sect:"§",uml:"¨",copy:"©",ordf:"ª",laquo:"«",not:"¬",shy:"­",reg:"®",macr:"¯",deg:"°",plusmn:"±",sup2:"²",sup3:"³",acute:"´",micro:"µ",para:"¶",middot:"·",cedil:"¸",sup1:"¹",ordm:"º",raquo:"»",frac14:"¼",frac12:"½",frac34:"¾",iquest:"¿",Agrave:"À",Aacute:"Á",Acirc:"Â",Atilde:"Ã",Auml:"Ä",Aring:"Å",AElig:"Æ",Ccedil:"Ç",Egrave:"È",Eacute:"É",Ecirc:"Ê",Euml:"Ë",Igrave:"Ì",Iacute:"Í",Icirc:"Î",Iuml:"Ï",ETH:"Ð",Ntilde:"Ñ",Ograve:"Ò",Oacute:"Ó",Ocirc:"Ô",Otilde:"Õ",Ouml:"Ö",times:"×",Oslash:"Ø",Ugrave:"Ù",Uacute:"Ú",Ucirc:"Û",Uuml:"Ü",Yacute:"Ý",THORN:"Þ",szlig:"ß",agrave:"à",aacute:"á",acirc:"â",atilde:"ã",auml:"ä",aring:"å",aelig:"æ",ccedil:"ç",egrave:"è",eacute:"é",ecirc:"ê",euml:"ë",igrave:"ì",iacute:"í",icirc:"î",iuml:"ï",eth:"ð",ntilde:"ñ",ograve:"ò",oacute:"ó",ocirc:"ô",otilde:"õ",ouml:"ö",divide:"÷",oslash:"ø",ugrave:"ù",uacute:"ú",ucirc:"û",uuml:"ü",yacute:"ý",thorn:"þ",yuml:"ÿ",fnof:"ƒ",Alpha:"Α",Beta:"Β",Gamma:"Γ",Delta:"Δ",Epsilon:"Ε",Zeta:"Ζ",Eta:"Η",Theta:"Θ",Iota:"Ι",Kappa:"Κ",Lambda:"Λ",Mu:"Μ",Nu:"Ν",Xi:"Ξ",Omicron:"Ο",Pi:"Π",Rho:"Ρ",Sigma:"Σ",Tau:"Τ",Upsilon:"Υ",Phi:"Φ",Chi:"Χ",Psi:"Ψ",Omega:"Ω",alpha:"α",beta:"β",gamma:"γ",delta:"δ",epsilon:"ε",zeta:"ζ",eta:"η",theta:"θ",iota:"ι",kappa:"κ",lambda:"λ",mu:"μ",nu:"ν",xi:"ξ",omicron:"ο",pi:"π",rho:"ρ",sigmaf:"ς",sigma:"σ",tau:"τ",upsilon:"υ",phi:"φ",chi:"χ",psi:"ψ",omega:"ω",thetasym:"ϑ",upsih:"ϒ",piv:"ϖ",bull:"•",hellip:"…",prime:"′",Prime:"″",oline:"‾",frasl:"⁄",weierp:"℘",image:"ℑ",real:"ℜ",trade:"™",alefsym:"ℵ",larr:"←",uarr:"↑",rarr:"→",darr:"↓",harr:"↔",crarr:"↵",lArr:"⇐",uArr:"⇑",rArr:"⇒",dArr:"⇓",hArr:"⇔",forall:"∀",part:"∂",exist:"∃",empty:"∅",nabla:"∇",isin:"∈",notin:"∉",ni:"∋",prod:"∏",sum:"∑",minus:"−",lowast:"∗",radic:"√",prop:"∝",infin:"∞",ang:"∠",and:"∧",or:"∨",cap:"∩",cup:"∪",int:"∫",there4:"∴",sim:"∼",cong:"≅",asymp:"≈",ne:"≠",equiv:"≡",le:"≤",ge:"≥",sub:"⊂",sup:"⊃",nsub:"⊄",sube:"⊆",supe:"⊇",oplus:"⊕",otimes:"⊗",perp:"⊥",sdot:"⋅",lceil:"⌈",rceil:"⌉",lfloor:"⌊",rfloor:"⌋",lang:"〈",rang:"〉",loz:"◊",spades:"♠",clubs:"♣",hearts:"♥",diams:"♦",quot:'"',amp:"&",lt:"<",gt:">",OElig:"Œ",oelig:"œ",Scaron:"Š",scaron:"š",Yuml:"Ÿ",circ:"ˆ",tilde:"˜",ensp:" ",emsp:" ",thinsp:" ",zwnj:"‌",zwj:"‍",lrm:"‎",rlm:"‏",ndash:"–",mdash:"—",lsquo:"‘",rsquo:"’",sbquo:"‚",ldquo:"“",rdquo:"”",bdquo:"„",dagger:"†",Dagger:"‡",permil:"‰",lsaquo:"‹",rsaquo:"›",euro:"€"},cf=["cent","copy","divide","gt","lt","not","para","times"],rl={}.hasOwnProperty,qi={};let hr;for(hr in Ni)rl.call(Ni,hr)&&(qi[Ni[hr]]=hr);const uf=/[^\dA-Za-z]/;function df(e,n,t,r){const s=String.fromCharCode(e);if(rl.call(qi,s)){const a=qi[s],o="&"+a;return t&&lf.includes(a)&&!cf.includes(a)&&(!r||n&&n!==61&&uf.test(String.fromCharCode(n)))?o:o+";"}return""}function pf(e,n,t){let r=af(e,n,t.omitOptionalSemicolons),s;if((t.useNamedReferences||t.useShortestReferences)&&(s=df(e,n,t.omitOptionalSemicolons,t.attribute)),(t.useShortestReferences||!s)&&t.useShortestReferences){const a=of(e,n,t.omitOptionalSemicolons);a.length<r.length&&(r=a)}return s&&(!t.useShortestReferences||s.length<r.length)?s:r}function mn(e,n){return ef(e,Object.assign({format:pf},n))}const hf=/^>|^->|<!--|-->|--!>|<!-$/g,mf=[">"],ff=["<",">"];function gf(e,n,t,r){return r.settings.bogusComments?"<?"+mn(e.value,Object.assign({},r.settings.characterReferences,{subset:mf}))+">":"<!--"+e.value.replace(hf,s)+"-->";function s(a){return mn(a,Object.assign({},r.settings.characterReferences,{subset:ff}))}}function yf(e,n,t,r){return"<!"+(r.settings.upperDoctype?"DOCTYPE":"doctype")+(r.settings.tightDoctype?"":" ")+"html>"}function Vs(e,n){const t=String(e);if(typeof n!="string")throw new TypeError("Expected character");let r=0,s=t.indexOf(n);for(;s!==-1;)r++,s=t.indexOf(n,s+n.length);return r}function xf(e,n){const t=n||{};return(e[e.length-1]===""?[...e,""]:e).join((t.padRight?" ":"")+","+(t.padLeft===!1?"":" ")).trim()}function bf(e){return e.join(" ").trim()}const wf=/[ \t\n\f\r]/g;function ea(e){return typeof e=="object"?e.type==="text"?Js(e.value):!1:Js(e)}function Js(e){return e.replace(wf,"")===""}const Ue=al(1),il=al(-1),kf=[];function al(e){return n;function n(t,r,s){const a=t?t.children:kf;let o=(r||0)+e,l=a[o];if(!s)for(;l&&ea(l);)o+=e,l=a[o];return l}}const _f={}.hasOwnProperty;function sl(e){return n;function n(t,r,s){return _f.call(e,t.tagName)&&e[t.tagName](t,r,s)}}const ta=sl({body:vf,caption:vi,colgroup:vi,dd:Tf,dt:Sf,head:vi,html:Nf,li:Cf,optgroup:Pf,option:Ef,p:jf,rp:Qs,rt:Qs,tbody:Df,td:Gs,tfoot:If,th:Gs,thead:Af,tr:Of});function vi(e,n,t){const r=Ue(t,n,!0);return!r||r.type!=="comment"&&!(r.type==="text"&&ea(r.value.charAt(0)))}function Nf(e,n,t){const r=Ue(t,n);return!r||r.type!=="comment"}function vf(e,n,t){const r=Ue(t,n);return!r||r.type!=="comment"}function jf(e,n,t){const r=Ue(t,n);return r?r.type==="element"&&(r.tagName==="address"||r.tagName==="article"||r.tagName==="aside"||r.tagName==="blockquote"||r.tagName==="details"||r.tagName==="div"||r.tagName==="dl"||r.tagName==="fieldset"||r.tagName==="figcaption"||r.tagName==="figure"||r.tagName==="footer"||r.tagName==="form"||r.tagName==="h1"||r.tagName==="h2"||r.tagName==="h3"||r.tagName==="h4"||r.tagName==="h5"||r.tagName==="h6"||r.tagName==="header"||r.tagName==="hgroup"||r.tagName==="hr"||r.tagName==="main"||r.tagName==="menu"||r.tagName==="nav"||r.tagName==="ol"||r.tagName==="p"||r.tagName==="pre"||r.tagName==="section"||r.tagName==="table"||r.tagName==="ul"):!t||!(t.type==="element"&&(t.tagName==="a"||t.tagName==="audio"||t.tagName==="del"||t.tagName==="ins"||t.tagName==="map"||t.tagName==="noscript"||t.tagName==="video"))}function Cf(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&r.tagName==="li"}function Sf(e,n,t){const r=Ue(t,n);return!!(r&&r.type==="element"&&(r.tagName==="dt"||r.tagName==="dd"))}function Tf(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&(r.tagName==="dt"||r.tagName==="dd")}function Qs(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&(r.tagName==="rp"||r.tagName==="rt")}function Pf(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&r.tagName==="optgroup"}function Ef(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&(r.tagName==="option"||r.tagName==="optgroup")}function Af(e,n,t){const r=Ue(t,n);return!!(r&&r.type==="element"&&(r.tagName==="tbody"||r.tagName==="tfoot"))}function Df(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&(r.tagName==="tbody"||r.tagName==="tfoot")}function If(e,n,t){return!Ue(t,n)}function Of(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&r.tagName==="tr"}function Gs(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&(r.tagName==="td"||r.tagName==="th")}const $f=sl({body:Ff,colgroup:zf,head:Rf,html:Lf,tbody:qf});function Lf(e){const n=Ue(e,-1);return!n||n.type!=="comment"}function Rf(e){const n=new Set;for(const r of e.children)if(r.type==="element"&&(r.tagName==="base"||r.tagName==="title")){if(n.has(r.tagName))return!1;n.add(r.tagName)}const t=e.children[0];return!t||t.type==="element"}function Ff(e){const n=Ue(e,-1,!0);return!n||n.type!=="comment"&&!(n.type==="text"&&ea(n.value.charAt(0)))&&!(n.type==="element"&&(n.tagName==="meta"||n.tagName==="link"||n.tagName==="script"||n.tagName==="style"||n.tagName==="template"))}function zf(e,n,t){const r=il(t,n),s=Ue(e,-1,!0);return t&&r&&r.type==="element"&&r.tagName==="colgroup"&&ta(r,t.children.indexOf(r),t)?!1:!!(s&&s.type==="element"&&s.tagName==="col")}function qf(e,n,t){const r=il(t,n),s=Ue(e,-1);return t&&r&&r.type==="element"&&(r.tagName==="thead"||r.tagName==="tbody")&&ta(r,t.children.indexOf(r),t)?!1:!!(s&&s.type==="element"&&s.tagName==="tr")}const mr={name:[[`	
\f\r &/=>`.split(""),`	
\f\r "&'/=>\``.split("")],[`\0	
\f\r "&'/<=>`.split(""),`\0	
\f\r "&'/<=>\``.split("")]],unquoted:[[`	
\f\r &>`.split(""),`\0	
\f\r "&'<=>\``.split("")],[`\0	
\f\r "&'<=>\``.split(""),`\0	
\f\r "&'<=>\``.split("")]],single:[["&'".split(""),"\"&'`".split("")],["\0&'".split(""),"\0\"&'`".split("")]],double:[['"&'.split(""),"\"&'`".split("")],['\0"&'.split(""),"\0\"&'`".split("")]]};function Bf(e,n,t,r){const s=r.schema,a=s.space==="svg"?!1:r.settings.omitOptionalTags;let o=s.space==="svg"?r.settings.closeEmptyElements:r.settings.voids.includes(e.tagName.toLowerCase());const l=[];let c;s.space==="html"&&e.tagName==="svg"&&(r.schema=nl);const u=Uf(r,e.properties),m=r.all(s.space==="html"&&e.tagName==="template"?e.content:e);return r.schema=s,m&&(o=!1),(u||!a||!$f(e,n,t))&&(l.push("<",e.tagName,u?" "+u:""),o&&(s.space==="svg"||r.settings.closeSelfClosing)&&(c=u.charAt(u.length-1),(!r.settings.tightSelfClosing||c==="/"||c&&c!=='"'&&c!=="'")&&l.push(" "),l.push("/")),l.push(">")),l.push(m),!o&&(!a||!ta(e,n,t))&&l.push("</"+e.tagName+">"),l.join("")}function Uf(e,n){const t=[];let r=-1,s;if(n){for(s in n)if(n[s]!==null&&n[s]!==void 0){const a=Mf(e,s,n[s]);a&&t.push(a)}}for(;++r<t.length;){const a=e.settings.tightAttributes?t[r].charAt(t[r].length-1):void 0;r!==t.length-1&&a!=='"'&&a!=="'"&&(t[r]+=" ")}return t.join("")}function Mf(e,n,t){const r=Vm(e.schema,n),s=e.settings.allowParseErrors&&e.schema.space==="html"?0:1,a=e.settings.allowDangerousCharacters?0:1;let o=e.quote,l;if(r.overloadedBoolean&&(t===r.attribute||t==="")?t=!0:(r.boolean||r.overloadedBoolean)&&(typeof t!="string"||t===r.attribute||t==="")&&(t=!!t),t==null||t===!1||typeof t=="number"&&Number.isNaN(t))return"";const c=mn(r.attribute,Object.assign({},e.settings.characterReferences,{subset:mr.name[s][a]}));return t===!0||(t=Array.isArray(t)?(r.commaSeparated?xf:bf)(t,{padLeft:!e.settings.tightCommaSeparatedLists}):String(t),e.settings.collapseEmptyAttributes&&!t)?c:(e.settings.preferUnquoted&&(l=mn(t,Object.assign({},e.settings.characterReferences,{attribute:!0,subset:mr.unquoted[s][a]}))),l!==t&&(e.settings.quoteSmart&&Vs(t,o)>Vs(t,e.alternative)&&(o=e.alternative),l=o+mn(t,Object.assign({},e.settings.characterReferences,{subset:(o==="'"?mr.single:mr.double)[s][a],attribute:!0}))+o),c+(l&&"="+l))}const Hf=["<","&"];function ol(e,n,t,r){return t&&t.type==="element"&&(t.tagName==="script"||t.tagName==="style")?e.value:mn(e.value,Object.assign({},r.settings.characterReferences,{subset:Hf}))}function Wf(e,n,t,r){return r.settings.allowDangerousHtml?e.value:ol(e,n,t,r)}function Vf(e,n,t,r){return r.all(e)}const Jf=ko("type",{invalid:Qf,unknown:Gf,handlers:{comment:gf,doctype:yf,element:Bf,raw:Wf,root:Vf,text:ol}});function Qf(e){throw new Error("Expected node, not `"+e+"`")}function Gf(e){const n=e;throw new Error("Cannot compile unknown node `"+n.type+"`")}const Yf={},Kf={},Zf=[];function Xf(e,n){const t=n||Yf,r=t.quote||'"',s=r==='"'?"'":'"';if(r!=='"'&&r!=="'")throw new Error("Invalid quote `"+r+"`, expected `'` or `\"`");return{one:eg,all:tg,settings:{omitOptionalTags:t.omitOptionalTags||!1,allowParseErrors:t.allowParseErrors||!1,allowDangerousCharacters:t.allowDangerousCharacters||!1,quoteSmart:t.quoteSmart||!1,preferUnquoted:t.preferUnquoted||!1,tightAttributes:t.tightAttributes||!1,upperDoctype:t.upperDoctype||!1,tightDoctype:t.tightDoctype||!1,bogusComments:t.bogusComments||!1,tightCommaSeparatedLists:t.tightCommaSeparatedLists||!1,tightSelfClosing:t.tightSelfClosing||!1,collapseEmptyAttributes:t.collapseEmptyAttributes||!1,allowDangerousHtml:t.allowDangerousHtml||!1,voids:t.voids||qm,characterReferences:t.characterReferences||Kf,closeSelfClosing:t.closeSelfClosing||!1,closeEmptyElements:t.closeEmptyElements||!1},schema:t.space==="svg"?nl:Gm,quote:r,alternative:s}.one(Array.isArray(e)?{type:"root",children:e}:e,void 0,void 0)}function eg(e,n,t){return Jf(e,n,t,this)}function tg(e){const n=[],t=e&&e.children||Zf;let r=-1;for(;++r<t.length;)n[r]=this.one(t[r],r,e);return n.join("")}const ng={};function ji(e){const n=this,{handlers:t,sanitize:r,...s}=e||ng;let a=!1,o;typeof r=="boolean"?a=!r:r&&(o=r),n.compiler=l;function l(c,u){const m=zm(c,{handlers:t,allowDangerousHtml:a}),d=a?m:Gh(m,o),y=Xf(d,{...s,allowDangerousHtml:a});return u.extname&&(u.extname=".html"),c&&c.type==="root"&&y&&/[^\r\n]/.test(y.charAt(y.length-1))?y+`
`:y}}const rg=({isOpen:e,onClose:n,patientId:t,pharmacyInventory:r,fetchPharmacyOrdersData:s,isLoadingInventory:a=!1})=>{const[o,l]=x.useState([]),[c,u]=x.useState(""),[m,d]=x.useState([]),[y,p]=x.useState(null),[E,q]=x.useState(!1);Ks(void 0,e?200:99999);const G=x.useMemo(()=>new Zs(r,{keys:["name"],threshold:.3}),[r]);x.useEffect(()=>{if(!c){d([]);return}const F=G.search(c).map(j=>j.item);d(F.slice(0,10))},[c,G]);const $=async()=>{if(!t){p("Patient ID is missing.");return}if(o.length===0){p("Please select at least one drug.");return}for(const F of o)if(F.selected_pack_quantity===0&&F.selected_loose_quantity===0){p(`Please specify a quantity for ${F.name}.`);return}q(!0),p(null);try{const F={patient_id:t,items:o.map(X=>({drug_id:X.id,name:X.name,pack_quantity:X.selected_pack_quantity,loose_quantity:X.selected_loose_quantity,pack_price:0,loose_price:0,total_price:0,tabletsPerDay:1,numberOfDays:1,directions_to_use:"As directed"})),order_total:0,prescription_for_unavailable_drugs:""},j=await Y("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(F)});if(!j.ok){const X=await j.json().catch(()=>({}));throw new Error(X.message||`Failed to create pharmacy order: ${j.statusText} `)}await j.json(),s(t),n(),l([]),u("")}catch(F){p(`Order Creation Error: ${F.message} `)}finally{q(!1)}},B=F=>{if(o.some(j=>j.id===F.id)){p(`${F.name} is already in the order.`),setTimeout(()=>p(null),3e3),u(""),d([]);return}l(j=>[...j,{...F,selected_pack_quantity:0,selected_loose_quantity:0}]),u(""),d([])},I=F=>{l(j=>j.filter(X=>X.id!==F))},W=(F,j,X)=>{const ce=parseInt(X)||0;l(ne=>ne.map(le=>le.id===F?{...le,[j==="pack"?"selected_pack_quantity":"selected_loose_quantity"]:ce}:le))};return e?i.jsx("div",{className:se.modalOverlay,children:i.jsxs("div",{className:se.modalContent,children:[i.jsxs("div",{className:se.modalHeader,children:[i.jsx("h3",{className:se.modalTitle,children:"Create Pharmacy Order"}),i.jsx("button",{onClick:n,className:se.modalCloseButton,children:i.jsx(fn,{size:20})})]}),i.jsxs("div",{className:se.modalBody,children:[y&&i.jsx("div",{className:se.errorText,children:y}),i.jsxs("div",{className:se.formGroup,style:{position:"relative"},children:[i.jsx("label",{htmlFor:"drug-search",children:"Add Drug"}),i.jsx("input",{type:"text",id:"drug-search",placeholder:"Search available drugs...",value:c,onChange:F=>u(F.target.value),className:se.inputField,autoComplete:"off"}),c&&i.jsx("div",{className:se.searchResultsCard,children:a?i.jsx("div",{className:"p-2 space-y-2",children:[1,2,3].map(F=>i.jsxs("div",{className:"flex justify-between items-center py-2 px-3",children:[i.jsx(Te,{width:"60%",height:20}),i.jsx(Te,{width:"30%",height:20})]},F))}):m.length>0?i.jsx("ul",{className:se.searchResultsList,children:m.map(F=>i.jsx("li",{onClick:()=>B(F),className:se.searchResultItem,children:i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"},children:[i.jsx("span",{children:F.name}),i.jsxs("span",{className:se.searchResultPrice,children:["Stock: ",F.stock," (Box) / ",F.loose||0," (Loose)"]})]})},F.id))}):i.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No drugs found."})})]}),i.jsxs("div",{className:se.selectedTestsCard,children:[" ",i.jsx("h4",{className:se.selectedTestsHeader,children:"Selected Drugs"}),o.length===0?i.jsx("p",{className:se.noTestsMessage,children:"No drugs added yet."}):i.jsx("ul",{className:se.selectedTestsList,children:o.map(F=>i.jsxs("li",{className:se.selectedTestItem,style:{flexDirection:"column",alignItems:"flex-start",gap:"8px"},children:[i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",width:"100%",alignItems:"center"},children:[i.jsx("span",{className:se.selectedTestName,style:{fontWeight:"bold"},children:F.name}),i.jsx("button",{type:"button",onClick:()=>I(String(F.id)),className:se.removeTestButton,title:"Remove Drug",children:i.jsx(gt,{size:16})})]}),i.jsxs("div",{style:{display:"flex",gap:"10px",alignItems:"center",width:"100%"},children:[i.jsxs("div",{style:{flex:1},children:[i.jsx("label",{style:{fontSize:"0.75rem",color:"#666"},children:"Packs"}),i.jsx("input",{type:"number",min:"0",className:se.inputField,style:{padding:"4px 8px"},value:F.selected_pack_quantity||"",onChange:j=>W(F.id,"pack",j.target.value),placeholder:"0"})]}),i.jsxs("div",{style:{flex:1},children:[i.jsx("label",{style:{fontSize:"0.75rem",color:"#666"},children:"Loose"}),i.jsx("input",{type:"number",min:"0",className:se.inputField,style:{padding:"4px 8px"},value:F.selected_loose_quantity||"",onChange:j=>W(F.id,"loose",j.target.value),placeholder:"0"})]})]})]},F.id))})]})]}),i.jsxs("div",{className:se.modalFooter,children:[i.jsx("button",{type:"button",onClick:n,className:`${se.button} ${se.buttonSecondary} `,children:" Cancel "}),i.jsxs("button",{type:"button",onClick:$,disabled:o.length===0||E,className:`${se.button} ${se.buttonPrimary} ${o.length===0||E?se.buttonDisabled:""} `,children:[" ",E?"Creating...":"Create Order"," "]})]})]})}):null},ig=({isOpen:e,onClose:n,onSuccess:t,patientId:r,initialItems:s})=>{const[a,o]=x.useState([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:"",packs:0,loose:0,pack_size:1}]),[l,c]=x.useState(30),[u,m]=x.useState(""),[d,y]=x.useState(null),[p,E]=x.useState(""),[q,G]=x.useState([]),[$,B]=x.useState(!1),[I,W]=x.useState(!1),[F,j]=x.useState(null),X=x.useRef(null);x.useEffect(()=>{if(e){s&&s.length>0?o(s):o([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:"",packs:0,loose:0,pack_size:1}]);const A=new Date;A.setDate(A.getDate()+30),m(A.toISOString().split("T")[0]),c(30)}},[e,s]);const ce=x.useCallback(async A=>{if(!A.trim()){G([]);return}B(!0);try{const M=await Y(`/api/drugs?search=${encodeURIComponent(A)}&limit=10`);if(M.ok){const J=await M.json();G(J.drugs||[])}}catch(M){console.error("Error searching drugs:",M)}finally{B(!1)}},[]);x.useEffect(()=>{X.current&&clearTimeout(X.current),p&&d!==null?X.current=setTimeout(()=>ce(p),300):G([])},[p,d,ce]);const ne=A=>{if(!A)return 1;const M=A.match(/(?:\d+x)?(\d+)(?:s|tabs)?/i);return M?parseInt(M[1],10):1},le=(A,M)=>{const J=[...a];J[M]={...J[M],medication_name:A.name,drug_id:A.id,pack_size:ne(A.pack),packs:0,loose:0,quantity:0},o(J),y(null),E(""),G([])},V=(A,M,J)=>{const Se=[...a],me={...Se[A]},w=me.pack_size||1;if(M==="packs"||M==="loose"){const Fe=parseInt(J)||0;M==="packs"&&(me.packs=Fe),M==="loose"&&(me.loose=Fe);const _e=me.packs||0,b=me.loose||0;me.quantity=_e*w+b}else if(M==="tablets_per_day"||M==="number_of_days"){M==="tablets_per_day"&&(me.tablets_per_day=J),M==="number_of_days"&&(me.number_of_days=J);const Fe=parseFloat(me.tablets_per_day.toString())||0,_e=parseInt(me.number_of_days.toString())||0,b=Math.ceil(Fe*_e);me.quantity=b,me.packs=Math.floor(b/w),me.loose=b%w}else me[M]=J;Se[A]=me,o(Se)},_=()=>{o([...a,{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:l,directions:"",notes:"",packs:0,loose:0,pack_size:1}])},C=A=>{a.length>1&&o(a.filter((M,J)=>J!==A))},K=async A=>{if(A.preventDefault(),j(null),!r){j("Patient ID is missing.");return}if(a.some(J=>!J.medication_name||J.quantity<=0)){j("Please ensure all items have a medication name and valid quantity.");return}W(!0);try{const J={patient_id:r,items:a.map(me=>({medication_name:me.medication_name,drug_id:me.drug_id,quantity:me.quantity,tablets_per_day:me.tablets_per_day,number_of_days:me.number_of_days,directions:me.directions,notes:me.notes,frequency_days:l,next_delivery_date:u}))},Se=await Y("/api/recurring-medications",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(J)});if(!Se.ok){const me=await Se.json();throw new Error(me.message+(me.error?": "+me.error:"")||"Failed to create recurring medication.")}t(),n()}catch(J){j(J.message)}finally{W(!1)}};return e?i.jsx("div",{className:"modal-overlay",children:i.jsxs("div",{className:"add-recurring-modal",style:{maxWidth:"800px",width:"95%"},children:[i.jsxs("div",{className:"modal-header",children:[i.jsx("h3",{children:"Add Recurring Medications"}),i.jsx("button",{className:"close-btn",onClick:n,children:i.jsx(fn,{size:20})})]}),i.jsxs("div",{className:"modal-body",children:[F&&i.jsx("div",{className:"error-message",children:F}),i.jsxs("form",{onSubmit:K,className:"recurring-form",children:[i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsxs("label",{children:[i.jsx(Xs,{size:16})," Frequency"]}),i.jsxs("select",{value:l,onChange:A=>{const M=parseInt(A.target.value);c(M);const J=new Date;J.setDate(J.getDate()+M),m(J.toISOString().split("T")[0]);const Se=a.map(me=>({...me,number_of_days:M}));o(Se)},children:[i.jsx("option",{value:15,children:"Every 15 Days"}),i.jsx("option",{value:30,children:"Every 30 Days"}),i.jsx("option",{value:60,children:"Every 60 Days"}),i.jsx("option",{value:90,children:"Every 90 Days"})]})]}),i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsxs("label",{children:[i.jsx(wr,{size:16})," Next Delivery"]}),i.jsx("input",{type:"date",value:u,onChange:A=>m(A.target.value)})]})]}),i.jsx("hr",{className:"divider"}),i.jsxs("div",{className:"items-header",children:[i.jsx("h4",{children:"Medications"}),i.jsxs("button",{type:"button",className:"add-item-btn",onClick:_,children:[i.jsx(fr,{size:14})," Add Drug"]})]}),i.jsx("div",{className:"items-list",children:a.map((A,M)=>i.jsxs("div",{className:"medication-item-row",children:[i.jsxs("div",{className:"row-top",children:[i.jsxs("div",{className:"form-group med-search-group",children:[i.jsx("label",{children:"Drug Name"}),i.jsxs("div",{className:"search-wrapper",children:[i.jsx("input",{type:"text",placeholder:"Search drug...",value:d===M?p:A.medication_name,onFocus:()=>{y(M),E(A.medication_name)},onChange:J=>{E(J.target.value),V(M,"medication_name",J.target.value)}}),d===M&&$&&i.jsx("span",{className:"spinner",children:"..."}),d===M&&p&&q.length>0&&i.jsx("ul",{className:"suggestions-list",children:q.map(J=>i.jsxs("li",{onClick:()=>le(J,M),children:[i.jsx("div",{className:"suggestion-name",children:J.name}),i.jsxs("div",{className:"suggestion-details",children:["Stock: ",J.stock]})]},J.id))})]})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Tabs/Day"}),i.jsx("input",{type:"number",min:"0.5",step:"0.5",value:A.tablets_per_day,onChange:J=>V(M,"tablets_per_day",J.target.value)})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Days"}),i.jsx("input",{type:"number",min:"1",value:A.number_of_days,onChange:J=>V(M,"number_of_days",J.target.value)})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Packs"}),i.jsx("input",{type:"number",min:"0",value:A.packs||"",onChange:J=>V(M,"packs",J.target.value),placeholder:"0"})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Loose"}),i.jsx("input",{type:"number",min:"0",value:A.loose||"",onChange:J=>V(M,"loose",J.target.value),placeholder:"0"})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Total"}),i.jsx("input",{type:"number",value:A.quantity,disabled:!0,style:{backgroundColor:"#f5f5f5",cursor:"not-allowed"}})]}),i.jsx("button",{type:"button",className:"remove-btn",onClick:()=>C(M),disabled:a.length===1,children:i.jsx(gt,{size:16})})]}),i.jsxs("div",{className:"row-bottom",children:[i.jsx("div",{className:"form-group",style:{flex:1},children:i.jsx("input",{type:"text",placeholder:"Directions (e.g. 1-0-1 after food)",value:A.directions,onChange:J=>V(M,"directions",J.target.value)})}),i.jsx("div",{className:"form-group",style:{flex:1},children:i.jsx("input",{type:"text",placeholder:"Notes",value:A.notes,onChange:J=>V(M,"notes",J.target.value)})})]})]},A.id))}),i.jsxs("div",{className:"modal-actions",children:[i.jsx("button",{type:"button",className:"btn-cancel",onClick:n,children:"Cancel"}),i.jsx("button",{type:"submit",className:"btn-submit",disabled:I,children:I?"Creating...":"Create Recurring Order"})]})]})]})]})}):null},ag=({isOpen:e,onClose:n,onSuccess:t,medication:r})=>{const[s,a]=x.useState(""),[o,l]=x.useState(0),[c,u]=x.useState(1),[m,d]=x.useState(30),[y,p]=x.useState(""),[E,q]=x.useState(""),[G,$]=x.useState(30),[B,I]=x.useState(""),[W,F]=x.useState("active"),[j,X]=x.useState(!1),[ce,ne]=x.useState(null);x.useEffect(()=>{if(e&&r){a(r.medicationName),l(r.quantity),u(r.tabletsPerDay||1),d(r.numberOfDays||30),p(r.directions||""),q(r.notes||""),$(r.frequencyDays),F(r.status);try{const _=new Date(r.nextDeliveryDate);isNaN(_.getTime())||I(_.toISOString().split("T")[0])}catch(_){console.error("Error parsing date",_)}}},[e,r]);const le=async _=>{if(_.preventDefault(),ne(null),!s||o<=0){ne("Please provide a valid medication name and quantity.");return}X(!0);try{const C={medication_name:s,quantity:o,tablets_per_day:c,number_of_days:m,directions:y,notes:E,frequency_days:G,next_delivery_date:B,status:W},K=await Y(`/api/recurring-medications/${r.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(C)});if(!K.ok){const A=await K.json();throw new Error(A.message||"Failed to update recurring medication.")}t(),n()}catch(C){ne(C.message)}finally{X(!1)}},V=async()=>{if(window.confirm("Are you sure you want to delete this recurring medication?")){X(!0);try{if(!(await Y(`/api/recurring-medications/${r.id}`,{method:"DELETE"})).ok)throw new Error("Failed to delete recurring medication.");t(),n()}catch(_){ne(_.message)}finally{X(!1)}}};return e?i.jsx("div",{className:"modal-overlay",children:i.jsxs("div",{className:"add-recurring-modal",style:{maxWidth:"600px",width:"90%"},children:[i.jsxs("div",{className:"modal-header",children:[i.jsx("h3",{children:"Edit Recurring Medication"}),i.jsx("button",{className:"close-btn",onClick:n,children:i.jsx(fn,{size:20})})]}),i.jsxs("div",{className:"modal-body",children:[ce&&i.jsx("div",{className:"error-message",children:ce}),i.jsxs("form",{onSubmit:le,className:"recurring-form",children:[i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Medication Name"}),i.jsx("input",{type:"text",value:s,onChange:_=>a(_.target.value)})]}),i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsxs("label",{children:[i.jsx(Xs,{size:16})," Frequency"]}),i.jsxs("select",{value:G,onChange:_=>$(parseInt(_.target.value)),children:[i.jsx("option",{value:15,children:"Every 15 Days"}),i.jsx("option",{value:30,children:"Every 30 Days"}),i.jsx("option",{value:60,children:"Every 60 Days"}),i.jsx("option",{value:90,children:"Every 90 Days"})]})]}),i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsxs("label",{children:[i.jsx(wr,{size:16})," Next Delivery"]}),i.jsx("input",{type:"date",value:B,onChange:_=>I(_.target.value)})]})]}),i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsx("label",{children:"Tabs/Day"}),i.jsx("input",{type:"number",min:"0.5",step:"0.5",value:c,onChange:_=>u(parseFloat(_.target.value))})]}),i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsx("label",{children:"Days"}),i.jsx("input",{type:"number",min:"1",value:m,onChange:_=>d(parseInt(_.target.value))})]}),i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsx("label",{children:"Total Qty"}),i.jsx("input",{type:"number",min:"1",value:o,onChange:_=>l(parseInt(_.target.value))})]})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Directions"}),i.jsx("input",{type:"text",value:y,onChange:_=>p(_.target.value)})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Notes"}),i.jsx("input",{type:"text",value:E,onChange:_=>q(_.target.value)})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Status"}),i.jsxs("select",{value:W,onChange:_=>F(_.target.value),children:[i.jsx("option",{value:"active",children:"Active"}),i.jsx("option",{value:"paused",children:"Paused"}),i.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),i.jsxs("div",{className:"modal-actions",style:{justifyContent:"space-between"},children:[i.jsxs("button",{type:"button",className:"btn-cancel text-red-600 hover:bg-red-50",onClick:V,style:{color:"#dc3545"},children:[i.jsx(gt,{size:16,style:{marginRight:"5px"}})," Delete"]}),i.jsxs("div",{style:{display:"flex",gap:"10px"},children:[i.jsx("button",{type:"button",className:"btn-cancel",onClick:n,children:"Cancel"}),i.jsx("button",{type:"submit",className:"btn-submit",disabled:j,children:j?"Saving...":"Save Changes"})]})]})]})]})]})}):null},sg=({isOpen:e,onClose:n,billData:t})=>{if(x.useEffect(()=>{if(e&&t){const a=setTimeout(()=>{window.print()},500);return()=>clearTimeout(a)}},[e,t]),!e||!t)return null;const r=t.clinicUpiId&&t.grandTotal>0?`upi://pay?pa=${t.clinicUpiId}&pn=${encodeURIComponent(t.clinicName)}&am=${t.grandTotal.toFixed(2)}&cu=INR`:"",s=i.jsxs("div",{id:"print-modal-root",className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 print:bg-white print:static print:block",children:[i.jsxs("div",{className:"bg-white w-full max-w-4xl h-[90vh] overflow-y-auto rounded-lg shadow-xl print:shadow-none print:w-full print:max-w-none print:h-auto print:overflow-visible relative",children:[i.jsx("button",{onClick:n,className:"absolute top-4 right-4 z-50 p-2 bg-gray-100 hover:bg-gray-200 rounded-full no-print",children:i.jsx(fn,{size:24})}),i.jsx("div",{className:"pharmacy-billing-page",style:{padding:0,minHeight:"auto",background:"white"},children:i.jsx("div",{className:"billing-container printable-section",style:{border:"none",boxShadow:"none",maxWidth:"100%",margin:0},children:i.jsxs("div",{className:"p-8 print:p-0",children:[t.labLetterheadUrl&&i.jsx("div",{className:"print-letterhead-container mb-4",children:i.jsx("img",{src:t.labLetterheadUrl,alt:"Lab Letterhead",className:"print-letterhead-image w-full object-contain max-h-[150px]"})}),i.jsxs("div",{className:"billing-header print-only",children:[i.jsx("div",{className:"clinic-header-left",children:i.jsx("div",{className:"clinic-info-print",children:i.jsxs("div",{className:"clinic-name-and-details-print",children:[i.jsx("h1",{className:"bill-title",children:"INVOICE"}),i.jsx("h2",{className:"clinic-name-print",children:t.clinicName?`${t.clinicName} Lab`:"Lab Bill"}),(t.clinicAddress||t.clinicNotes)&&i.jsxs("div",{className:"clinic-details-print",children:[t.clinicAddress&&i.jsx("span",{className:"small-text clinic-address",children:t.clinicAddress}),t.clinicNotes&&i.jsx("span",{className:"small-text clinic-notes",children:t.clinicNotes})]})]})})}),i.jsxs("div",{className:"patient-info-grid print-only-patient-details mt-4 text-sm",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem"},children:[i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(eo,{size:16})," Patient Name"]}),t.patientName]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(to,{size:16})," Token"]}),t.patientToken||"N/A"]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(wr,{size:16})," Order Date"]}),new Date(t.orderDate).toLocaleDateString()]})]})]}),i.jsx("div",{className:"medications-card mb-6",style:{border:"none",boxShadow:"none"},children:i.jsxs("table",{className:"medications-table w-full text-left collapse",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b-2 border-gray-300",children:[i.jsx("th",{className:"py-2",children:"S.No."}),i.jsx("th",{className:"py-2",children:"TEST DESCRIPTION"}),i.jsx("th",{className:"py-2 text-right",children:"PRICE"}),i.jsx("th",{className:"py-2 text-right",children:"DIS %"}),i.jsx("th",{className:"py-2 text-right",children:"AMT"})]})}),i.jsx("tbody",{children:t.items.map((a,o)=>{const l=a.price??0,c=l*(a.discount_percentage??0)/100,u=l-c;return i.jsxs("tr",{className:"border-b border-gray-100",children:[i.jsx("td",{className:"py-2",children:o+1}),i.jsx("td",{className:"py-2 font-medium",children:a.name}),i.jsx("td",{className:"py-2 text-right",children:a.price.toFixed(2)}),i.jsxs("td",{className:"py-2 text-right",children:[a.discount_percentage??0,"%"]}),i.jsx("td",{className:"py-2 text-right font-bold",children:u.toFixed(2)})]},o)})})]})}),i.jsx("div",{className:"bill-summary-print flex justify-end",children:i.jsxs("div",{className:"bill-summary-details w-1/3 bg-gray-50 p-4 rounded print:w-1/2 print:bg-transparent print:p-0",children:[i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Subtotal"}),i.jsxs("span",{children:["₹",t.subtotal.toFixed(2)]})]}),i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Total Discount"}),i.jsxs("span",{children:["- ₹",t.totalDiscount.toFixed(2)]})]}),i.jsxs("div",{className:"print-only-total flex justify-between font-bold text-lg border-t pt-2 mt-2",children:[i.jsx("span",{children:"Grand Total:"}),i.jsxs("span",{children:["₹",t.grandTotal.toFixed(2)]})]}),r&&i.jsxs("div",{className:"qr-code-container mt-4 flex flex-col items-center",style:{boxShadow:"none",background:"transparent"},children:[i.jsx(no,{value:r,size:80}),i.jsx("p",{className:"text-xs mt-1 text-center text-gray-500",children:"Scan to pay"})]})]})}),i.jsxs("footer",{className:"billing-footer mt-8 text-center text-xs text-gray-500 print:absolute print:bottom-0 print:w-full",children:[i.jsx("p",{children:"Thank you for your business!"}),i.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})})})]}),i.jsx("style",{children:`
                @media print {
                    /* Hide EVERYTHING in body */
                    body > * {
                        display: none !important;
                    }
                    
                    /* Explicitly hide #root to override any other styles */
                    #root {
                        display: none !important;
                    }

                    /* Show ONLY our portal root */
                    #print-modal-root {
                        display: block !important;
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        background: white !important;
                        z-index: 99999 !important;
                    }

                     /* Reset visibility for children of the portal */
                    #print-modal-root * {
                        visibility: visible !important;
                    }
                    
                    /* IMPORTANT: Prevent style tags from being displayed by the wildcard above */
                    #print-modal-root style {
                        display: none !important;
                    }
                    
                     /* Specifically restore display for key layout containers that rely on Flex */
                    .flex { display: flex !important; }
                    .grid { display: grid !important; }
                    .table { display: table !important; }
                    tr { display: table-row !important; }
                    td, th { display: table-cell !important; }

                    /* Ensure no scrollbars in print */
                    .overflow-y-auto {
                        overflow: visible !important;
                        height: auto !important;
                    }

                    /* 
                       CRITICAL: Hide elements explicitly marked with no-print class 
                       Must be at the END to override any restoration rules above.
                    */
                    #print-modal-root .no-print, .no-print {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                    }
                }
            `})]});return ro.createPortal(s,document.body)},og=({isOpen:e,onClose:n,billData:t})=>{if(x.useEffect(()=>{if(e&&t){const a=setTimeout(()=>{window.print()},500);return()=>clearTimeout(a)}},[e,t]),!e||!t)return null;const r=t.clinicUpiId&&t.grandTotal>0?`upi://pay?pa=${t.clinicUpiId}&pn=${encodeURIComponent(t.clinicName)}&am=${t.grandTotal.toFixed(2)}&cu=INR`:"",s=i.jsxs("div",{id:"print-pharmacy-modal-root",className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 print:bg-white print:static print:block",children:[i.jsxs("div",{className:"bg-white w-full max-w-4xl h-[90vh] overflow-y-auto rounded-lg shadow-xl print:shadow-none print:w-full print:max-w-none print:h-auto print:overflow-visible relative",children:[i.jsx("button",{onClick:n,className:"absolute top-4 right-4 z-50 p-2 bg-gray-100 hover:bg-gray-200 rounded-full no-print",children:i.jsx(fn,{size:24})}),i.jsx("div",{className:"pharmacy-billing-page",style:{padding:0,minHeight:"auto",background:"white"},children:i.jsx("div",{className:"billing-container printable-section",style:{border:"none",boxShadow:"none",maxWidth:"100%",margin:0},children:i.jsxs("div",{className:"p-8 print:p-0",children:[i.jsxs("div",{className:"billing-header print-only",children:[i.jsx("div",{className:"clinic-header-left",children:i.jsx("div",{className:"clinic-info-print",children:i.jsxs("div",{className:"clinic-name-and-details-print",children:[i.jsx("h1",{className:"bill-title",children:"INVOICE"}),i.jsx("h2",{className:"clinic-name-print",children:t.clinicName?`${t.clinicName} Pharmacy`:"Pharmacy Bill"}),(t.clinicAddress||t.clinicNotes)&&i.jsxs("div",{className:"clinic-details-print",children:[t.clinicAddress&&i.jsx("span",{className:"small-text clinic-address",children:t.clinicAddress}),t.clinicNotes&&i.jsx("span",{className:"small-text clinic-notes",children:t.clinicNotes})]})]})})}),i.jsxs("div",{className:"patient-info-grid print-only-patient-details mt-4 text-sm",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem"},children:[i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(eo,{size:16})," Patient Name"]}),t.patientName]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(to,{size:16})," Token"]}),t.patientToken||"N/A"]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(wr,{size:16})," Order Date"]}),new Date(t.orderDate).toLocaleDateString()]})]})]}),i.jsx("div",{className:"medications-card mb-6",style:{border:"none",boxShadow:"none"},children:i.jsxs("table",{className:"medications-table w-full text-left collapse",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b-2 border-gray-300",children:[i.jsx("th",{className:"py-2",children:"S.No."}),i.jsx("th",{className:"py-2",children:"DESCRIPTION"}),i.jsx("th",{className:"py-2",children:"BATCH"}),i.jsx("th",{className:"py-2",children:"EXPIRY"}),i.jsx("th",{className:"py-2",children:"QTY"}),i.jsx("th",{className:"py-2 text-right",children:"MRP"}),i.jsx("th",{className:"py-2 text-right",children:"DIS %"}),i.jsx("th",{className:"py-2 text-right",children:"AMT"})]})}),i.jsx("tbody",{children:t.items.map((a,o)=>i.jsxs("tr",{className:"border-b border-gray-100",children:[i.jsx("td",{className:"py-2",children:o+1}),i.jsx("td",{className:"py-2 font-medium",children:a.name}),i.jsx("td",{className:"py-2",children:a.batch||"-"}),i.jsx("td",{className:"py-2",children:a.expiry_date?new Date(a.expiry_date).toLocaleDateString():"-"}),i.jsxs("td",{className:"py-2",children:[a.pack_quantity?`${a.pack_quantity} Pkts `:"",a.loose_quantity?`${a.loose_quantity} Loose`:""]}),i.jsx("td",{className:"py-2 text-right",children:a.mrp.toFixed(2)}),i.jsxs("td",{className:"py-2 text-right",children:[a.discount_percentage??0,"%"]}),i.jsx("td",{className:"py-2 text-right font-bold",children:a.price.toFixed(2)})]},o))})]})}),i.jsx("div",{className:"bill-summary-print flex justify-end",children:i.jsxs("div",{className:"bill-summary-details w-1/3 bg-gray-50 p-4 rounded print:w-1/2 print:bg-transparent print:p-0",children:[i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Subtotal"}),i.jsxs("span",{children:["₹",t.subtotal.toFixed(2)]})]}),i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Total Discount"}),i.jsxs("span",{children:["- ₹",t.totalDiscount.toFixed(2)]})]}),i.jsxs("div",{className:"print-only-total flex justify-between font-bold text-lg border-t pt-2 mt-2",children:[i.jsx("span",{children:"Grand Total:"}),i.jsxs("span",{children:["₹",t.grandTotal.toFixed(2)]})]}),r&&i.jsxs("div",{className:"qr-code-container mt-4 flex flex-col items-center",style:{boxShadow:"none",background:"transparent"},children:[i.jsx(no,{value:r,size:80}),i.jsx("p",{className:"text-xs mt-1 text-center text-gray-500",children:"Scan to pay"})]})]})}),i.jsxs("footer",{className:"billing-footer mt-8 text-center text-xs text-gray-500 print:absolute print:bottom-0 print:w-full",children:[i.jsx("p",{children:"Thank you for your business!"}),i.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})})})]}),i.jsx("style",{children:`
                @media print {
                    body > * { display: none !important; }
                    #root { display: none !important; }
                    #print-pharmacy-modal-root {
                        display: block !important;
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        background: white !important;
                        z-index: 99999 !important;
                    }
                    #print-pharmacy-modal-root * { visibility: visible !important; }
                    #print-pharmacy-modal-root style { display: none !important; }
                    
                    .flex { display: flex !important; }
                    .grid { display: grid !important; }
                    .table { display: table !important; }
                    tr { display: table-row !important; }
                    td, th { display: table-cell !important; }

                    .overflow-y-auto { overflow: visible !important; height: auto !important; }
                    #print-pharmacy-modal-root .no-print, .no-print {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                    }
                }
            `})]});return ro.createPortal(s,document.body)},lg=({messages:e})=>{const n=x.useRef(null);return x.useEffect(()=>{n.current&&(n.current.scrollTop=n.current.scrollHeight)},[e]),i.jsxs("div",{className:"conversation-panel",children:[i.jsxs("div",{className:"conversation-header",children:[i.jsx("div",{className:"conversation-title",children:i.jsx("h3",{children:"Conversation"})}),i.jsxs("span",{className:"conversation-count",children:[e.length," messages"]})]}),i.jsxs("div",{ref:n,className:"message-list custom-scrollbar",children:[e.length===0&&i.jsx("div",{className:"empty-state",children:"Start talking to the AI..."}),e.map(t=>i.jsxs("div",{className:`message-wrapper ${t.role}`,children:[i.jsx("div",{className:`message-bubble ${t.role} ${t.role==="system"?t.type||"info":""}`,children:t.role==="ai"||t.role==="system"&&t.type==="loading"?i.jsx("div",{className:"prose prose-sm max-w-none",children:t.role==="system"&&t.type==="loading"?i.jsxs("div",{className:"typing-indicator",children:[i.jsx("span",{className:"dot"}),i.jsx("span",{className:"dot"}),i.jsx("span",{className:"dot"})]}):i.jsx(Qt,{remarkPlugins:[kt],children:t.content})}):i.jsx("div",{className:"whitespace-pre-wrap",children:t.content})}),t.role!=="system"&&i.jsx("span",{className:"message-timestamp",children:t.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]},t.id))]})]})},cg=e=>io({queryKey:mt.patients.context(e||""),queryFn:async()=>{if(!e)throw new Error("Patient ID is required");const n=await Y(`/api/patients/${e}/context`);if(!n.ok)throw new Error("Failed to fetch patient context");return n.json()},enabled:!!e,staleTime:5*60*1e3}),Ci=e=>{if(!e)return"";const n=new Date(e);if(isNaN(n.getTime()))return"";const t=n.getTimezoneOffset()*6e4;return new Date(n.getTime()-t).toISOString().slice(0,16)},ug=(e,n=[])=>{const r=(I=>[1,2,3,14,15,16,17,18,19,30,31,32].includes(I)?"molar":[4,5,12,13,20,21,28,29].includes(I)?"premolar":[6,11,22,27].includes(I)?"canine":"incisor")(e),s=e<=16,a={molar:{crown:"M5,20 Q5,5 18,5 Q31,5 31,20 L29,25 Q18,28 7,25 Z",roots:["M7,25 Q5,40 10,44 Q14,40 14,26","M29,25 Q31,40 26,44 Q22,40 22,26"]},premolar:{crown:"M8,20 Q8,8 18,8 Q28,8 28,20 L26,24 Q18,27 10,24 Z",roots:["M10,24 Q16,44 18,45 Q20,44 26,24"]},canine:{crown:"M8,22 Q18,2 28,22 L26,25 Q18,28 10,25 Z",roots:["M10,25 Q18,48 26,25"]},incisor:{crown:"M10,22 L10,12 Q18,12 26,12 L26,22 L24,25 Q18,27 12,25 Z",roots:["M12,25 Q18,46 24,25"]}},{crown:o,roots:l}=a[r],c=n.includes("condition-rct"),u=n.includes("condition-filling"),m=n.includes("condition-crown"),d=n.includes("condition-bridge"),y=n.includes("condition-extraction"),p=n.includes("condition-implant"),E=c?"#e9d5ff":"#f3f4f6",q=y?"#fee2e2":m?"#fde047":d?"#67e8f9":"#ffffff",G=y?"#ef4444":d?"#0891b2":p?"#475569":m?"#b45309":"#6b7280",$=d||m||p?2:1.5;let B=`<svg viewBox="0 0 36 50" width="24" height="34" style="display:inline-block;${s?"transform:rotate(180deg);":""}">`;return l.forEach(I=>{B+=`<path d="${I}" fill="${E}" stroke="${G}" stroke-width="${$}" stroke-linejoin="round"/>`}),c&&(r==="molar"?(B+='<path d="M12,28 L11,42" fill="none" stroke="#9333ea" stroke-width="2.5" stroke-linecap="round"/>',B+='<path d="M24,28 L25,42" fill="none" stroke="#9333ea" stroke-width="2.5" stroke-linecap="round"/>'):B+='<path d="M18,25 L18,44" fill="none" stroke="#9333ea" stroke-width="2.5" stroke-linecap="round"/>'),B+=`<path d="${o}" fill="${q}" stroke="${G}" stroke-width="${$}" stroke-linejoin="round"/>`,u&&!m&&!d&&(B+='<circle cx="18" cy="16" r="4" fill="#3b82f6" stroke="#1d4ed8" stroke-width="1"/>'),y&&(B+='<line x1="8" y1="8" x2="28" y2="42" stroke="#ef4444" stroke-width="3" stroke-linecap="round"/>',B+='<line x1="28" y1="8" x2="8" y2="42" stroke="#ef4444" stroke-width="3" stroke-linecap="round"/>'),B+="</svg>",B},pg=()=>{var rs,is;const{openCommandBar:e}=uc(),{recordId:n,patientId:t}=dc(),[r,s]=x.useState(n||void 0),a=pc(),o=hc(),l=mc(),[c,u]=x.useState(""),[m]=x.useState([]),[d,y]=x.useState(null),[p,E]=x.useState(null),[q,G]=x.useState(void 0),[$,B]=x.useState(void 0),[I,W]=x.useState(null),[F,j]=x.useState(!1),[X,ce]=x.useState(""),[ne,le]=x.useState(!1),[V,_]=x.useState(null),[C,K]=x.useState(null),[A,M]=x.useState(!1),[J,Se]=x.useState([]),[me,w]=x.useState(!1),[Fe,_e]=x.useState(null),[b,De]=x.useState(""),[He,Ne]=x.useState(""),[at,Re]=x.useState(null),[et,st]=x.useState(!1),[tt,Yt]=x.useState(!1),[v,Ot]=x.useState(!1),[jt,Kt]=x.useState(window.innerHeight),[pt,yt]=x.useState([]),[Je,Ct]=x.useState(!1),[Mt,Zt]=x.useState(null),[We,St]=x.useState([]),[$e,T]=x.useState([]),[P,S]=x.useState([]),[ee,ue]=x.useState(!1),[Le,Me]=x.useState(null),je=x.useRef(null),Ve=x.useRef(null),Qe=x.useRef(!1),ze=x.useRef(null),te=x.useRef(null),D=x.useRef(null),z=x.useRef(null),L=x.useRef(null),O=x.useRef(null),ie=x.useRef(null),[re,R]=x.useState([]),[fe,Ce]=x.useState(!1);x.useEffect(()=>{(async()=>{if(re.length>0&&!fe){Ce(!0);const g=re[0];g.current&&(g.current.scrollIntoView({behavior:"smooth",block:"center"}),g.current.classList.add("ai-glow"),await new Promise(f=>setTimeout(f,2e3)),g.current&&g.current.classList.remove("ai-glow")),R(f=>f.slice(1)),Ce(!1)}})()},[re,fe]);const xe=h=>{let g=null;switch(h){case"update_patient_details":g=D;break;case"create_pharmacy_order":case"edit_pharmacy_order":g=z;break;case"create_lab_order":case"edit_lab_order":g=L;break;case"add_complaint_history":g=O;break;case"update_case_summary":g=ie;break}g&&R(f=>[...f,g])},[ae,ge]=x.useState(55),[pe,H]=x.useState(!1),Z=x.useRef(null),be=x.useRef(null),qe=x.useRef(null),oe=x.useRef(null),ve=150,[Ee,Ge]=x.useState([]),[ot,xt]=x.useState([]),[lt,nt]=x.useState(!0),[Xt,en]=x.useState(null),[Hn,Wn]=x.useState(!1),[ll,cl]=x.useState(!1),[ul,dl]=x.useState(!1),[pl,hl]=x.useState(!1),[ml,fl]=x.useState(!1),[vr,Tt]=x.useState([]),[xn,na]=x.useState(!1),[ra,ia]=x.useState(null),[Vn,jr]=x.useState(!1),[aa,sa]=x.useState(null),[bn,gl]=x.useState({}),[yl,oa]=x.useState(!1),[la,ca]=x.useState(!1),[ua,da]=x.useState(!1),[pa,Jn]=x.useState(!1),[ha,Cr]=x.useState(!1),[ma,wn]=x.useState([]),[Sr,Qn]=x.useState(void 0),[xl,fa]=x.useState(!1),[bl,wl]=x.useState(null),[kl,ga]=x.useState(!1),[_l,Nl]=x.useState(null),[ht,ya]=x.useState(!1),[Tr,xa]=x.useState(!1),[Pr,ba]=x.useState(!1),[Er,wa]=x.useState(!1),[Ar,ka]=x.useState(!1),[Gn,kn]=x.useState(!1),Yn=x.useMemo(()=>(p==null?void 0:p.admission_date)&&!(p!=null&&p.discharge_date),[p]),[vl,Kn]=x.useState(!1),[_a,Dr]=x.useState(null),[Ir,Or]=x.useState(""),[$r,Lr]=x.useState(void 0),[Rr,Fr]=x.useState(void 0),[zr,qr]=x.useState(void 0),[Pt,Br]=x.useState(!1),[Na,Ht]=x.useState(null),[va,Ur]=x.useState(null),[ja,Mr]=x.useState(null),[Ca,_n]=x.useState(null),[Et,tn]=x.useState(""),[Nn,Zn]=x.useState(!1),[vn,jl]=x.useState(!1),Xn=x.useRef(null),[Sa,Hr]=x.useState(null),[Ta,nn]=x.useState([]),Wr=x.useCallback(h=>{nn(g=>[...g,{id:Math.random().toString(36).substr(2,9),timestamp:new Date,role:"system",content:"",...h}])},[]),[Vr,Pa]=x.useState(null),[Ea,Aa]=x.useState(!1),er=x.useRef(null),tr=x.useRef(null),[Cl,Jr]=x.useState(!1),[nr,Da]=x.useState(!1),[Qr,Ia]=x.useState(null),[Ae,Gr]=x.useState(null),[rr,Yr]=x.useState(""),[jn,Cn]=x.useState(""),[Oa,$a]=x.useState(!0),[rn,La]=x.useState(!1),[Kr,ir]=x.useState(!1),[an,Ra]=x.useState(!1),[Sl,Fa]=x.useState(!1),Sn=x.useRef(null),Tl=async()=>{Sn.current&&(await Sn.current.undoLastAction(),Fa(!1))},Pl=h=>{Nl(h),ga(!0)},sn=async h=>{try{const g=await Y(`/api/patients/${h}`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`Failed to fetch patient details: ${g.status}`)}const f=await g.json();if(E(f),G(f.age),B(f.gender),De(f.ai_response||""),E(k=>k?{...k,current_status:f.current_status,admission_date:f.admission_date,discharge_date:f.discharge_date}:{...f,current_status:f.current_status,admission_date:f.admission_date,discharge_date:f.discharge_date}),f.insurance_type&&E(k=>k?{...k,insurance_type:f.insurance_type}:{...f}),ei(h),f.ai_response){const k=/```json\s*([\s\S]*?)\s*```/,N=f.ai_response.match(k);if(N&&N[1])Ne(f.ai_response.replace(k,"").trim()),Re(N[1].trim());else{const Q=f.ai_response.trim();if(Q.startsWith("{")&&Q.endsWith("}"))try{JSON.parse(Q),Ne(""),Re(Q)}catch{Ne(Q),Re(null)}else if(Q.startsWith("[")&&Q.endsWith("]"))try{JSON.parse(Q),Ne(""),Re(Q)}catch{Ne(Q),Re(null)}else Ne(Q),Re(null)}}else Ne(""),Re(null)}catch{E(null),De(""),Ne(""),Re(null)}},El=async(h,g)=>{E(f=>f?{...f,insurance_type:g}:null);try{const f=await Y(`/api/patients/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({insurance_type:g})});if(!f.ok){const k=await f.json();throw new Error(k.message||"Failed to update insurance type")}}catch(f){console.error("Error updating insurance type:",f),h&&sn(h)}},za=async h=>{ue(!0),Me(null),S([]);try{const g=await Y(`/api/queue/patient/${h}/complaints`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`HTTP error! status: ${g.status}`)}const f=await g.json();S(f||[])}catch(g){Me(`Past complaints error: ${g.message}`)}finally{ue(!1)}},on=async h=>{St([]);try{const g=await Y(`/api/pharmacy-orders/patient/${h}`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`HTTP error! status: ${g.status}`)}const f=await g.json();St(f||[])}catch{}},ln=async h=>{na(!0),ia(null),Tt([]);try{const g=await Y(`/api/lab/orders/patient/${h}`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`HTTP error! status: ${g.status}`)}const f=await g.json();Tt(f||[])}catch(g){ia(`Pending labs error: ${g.message}`)}finally{na(!1)}},Tn=async h=>{Ct(!0),Zt(null),yt([]);try{const g=await Y(`/api/lab/patient/${h}`);if(!g.ok){const N=await g.json().catch(()=>({}));throw new Error(N.message||`HTTP error! status: ${g.status}`)}const k=(await g.json()||[]).map(N=>({...N.report,id:N.id,patient_id:N.patient_id,createdAt:N.createdAt,tests:N.tests,status:N.status}));yt(k)}catch(g){Zt(`Lab reports error: ${g.message}`)}finally{Ct(!1)}},{data:At,isLoading:$t}=cg(d),Pn=x.useCallback(async h=>{h===d?await o.invalidateQueries({queryKey:mt.patients.context(h)}):y(h)},[d,o]);x.useEffect(()=>{if(At){console.log("EditComplaintPage: Syncing data from useQuery cache");const h=At.patient;if(h){if(E(h),G(h.age),B(h.gender),De(h.ai_response||""),h.ai_response){const g=/```json\s*([\s\S]*?)\s*```/,f=h.ai_response.match(g);if(f&&f[1])Ne(h.ai_response.replace(g,"").trim()),Re(f[1].trim());else{const k=h.ai_response.trim();k.startsWith("{")||k.startsWith("[")?(Ne(""),Re(k)):(Ne(k),Re(null))}}kn(h.current_status==="In Doctor Queue"||h.current_status==="In Consultation")}if(S(At.history||[]),St(At.pharmacyOrders||[]),At.labOrders){Tt(At.labOrders.filter(f=>!f.report));const g=At.labOrders.filter(f=>f.report).map(f=>({...f.report,id:f.id,patient_id:f.patient_id,createdAt:f.createdAt,tests:f.tests}));yt(g)}T(At.recurringMedications||[])}},[At]),x.useEffect(()=>{(async()=>{if(d)try{const g=await o.fetchQuery({queryKey:mt.patientDebts.balance(d),queryFn:async()=>{const f=await Y(`/api/patient-debts/${d}/balance`);return f.ok?f.json():{netDebt:0}},staleTime:6e4});Ia(g.netDebt||0)}catch(g){console.error("Error fetching patient debt:",g),Ia(0)}})()},[d,o]);const Zr=x.useCallback(()=>{if(!p)return;const h={id:p.id,token:p.patient_token_number??null,name:p.name,age:p.age??null,gender:p.gender==="M"||p.gender==="F"||p.gender==="O"?p.gender:null,phone:p.phone};a("/dashboard/dental",{state:{patient:h}})},[p,a]),Al=x.useCallback(()=>{if(!p)return;const h={id:p.id,token:p.patient_token_number??null,name:p.name,age:p.age??null,gender:p.gender==="M"||p.gender==="F"||p.gender==="O"?p.gender:null,phone:p.phone};a("/dashboard/medical",{state:{patient:h}})},[p,a]),{data:Xr}=io({queryKey:mt.dental.records(d),queryFn:async()=>{const h=await Y(`/api/dental/patient/${d}`);if(!h.ok)throw new Error("Failed to fetch dental records");return h.json()},enabled:!!d,staleTime:5*60*1e3});x.useEffect(()=>{Se(Xr||[])},[Xr]);const{conditions:ar,details:sr}=x.useMemo(()=>{const h={},g={},f=(N,Q)=>{h[N]||(h[N]=[]);const he=`condition-${Q}`;h[N].includes(he)||h[N].push(he)},k=(N,Q)=>{g[N]||(g[N]=[]),g[N].push(Q)};return J.forEach(N=>{N.teeth&&Array.isArray(N.teeth)&&N.teeth.forEach(Q=>{Q.procedures.forEach(he=>{var we;let de=(we=N.selected_procedures)==null?void 0:we.find(wt=>wt.id===he);de&&de.type!=="general"&&(f(Q.toothNumber,de.type),k(Q.toothNumber,{name:de.name,date:new Date(N.date||N.createdAt||0).toLocaleDateString(),recordId:N.id,isPast:!0}))})})}),{conditions:h,details:g}},[J]),ei=async h=>{try{const g=await o.fetchQuery({queryKey:mt.queue.latest(h),queryFn:async()=>{const f=await Y(`/api/queue/patient/${h}/latest`);if(!f.ok)throw new Error("Failed");return f.json()},staleTime:5e3});if(g){const f=new Date(g.createdAt),k=new Date,N=f.getDate()===k.getDate()&&f.getMonth()===k.getMonth()&&f.getFullYear()===k.getFullYear(),Q=["waiting","consulting"].includes(g.status);kn(N&&Q)}else kn(!1)}catch(g){console.error("Error checking patient queue status:",g),kn(!1)}},ti=x.useCallback(async(h,g)=>{try{if(!(await Y(`/api/pharmacy-orders/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:g})})).ok)throw new Error("Failed to update pharmacy order date");d&&on(d)}catch(f){console.error("Error updating pharmacy order date:",f),_e("Failed to update pharmacy order date")}},[d]),En=x.useCallback(async(h,g,f)=>{try{const k={};if(g==="order"?k.date=f:g==="report"&&(k.reportDate=f),!(await Y(`/api/lab/orders/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)})).ok)throw new Error("Failed to update lab date");d&&(ln(d),Tn(d))}catch(k){console.error("Error updating lab order date:",k),_e("Failed to update lab order date")}},[d]),ni=x.useCallback(h=>{a(`/dashboard/edit-pharmacy-order/${h}`)},[a]),qa=x.useCallback(h=>{const g=h.medications.map((f,k)=>({id:Date.now()+k,medication_name:f.name,drug_id:f.drug_id?String(f.drug_id):null,quantity:(f.pack_quantity||0)*(f.pack_size||1)+(f.loose_quantity||0),tablets_per_day:f.tabletsPerDay||1,number_of_days:f.numberOfDays||30,directions:f.directions_to_use||"",notes:"",packs:f.pack_quantity,loose:f.loose_quantity,pack_size:f.pack_size}));wn(g),Jn(!0)},[]),Ba=x.useCallback(h=>{_e(null),console.log(`Preparing billing navigation for order: ${h}`);const g=We.find(f=>f.id===h);if(g){const f=g.medications.map(k=>{const N=k.price??0;return(k.price===void 0||k.price===null)&&console.warn(`Medication "${k.name}" in order ${h} is missing a price. Defaulting to 0.`),{name:k.name,pack_quantity:k.pack_quantity,loose_quantity:k.loose_quantity,price:N,pack_price:k.pack_price,loose_price:k.loose_price,total_price:Number(k.total_price)||0,isLoose:k.isLoose,unit:k.unit,drug_id:k.drug_id?String(k.drug_id):null,tabletsPerDay:k.tabletsPerDay,numberOfDays:k.numberOfDays,directions_to_use:k.directions_to_use,discount_percentage:k.discount_percentage??0,batch:k.batch,expiry_date:k.expiry_date}});console.log("Navigating to /dashboard/pharmacy-billing with state:",{initialItems:f}),a(`/dashboard/pharmacy-billing/${h}`,{state:{initialItems:f}})}else console.error(`Order with ID ${h} not found.`),_e(`Order with ID ${h} not found.`),alert(`Error: Could not find order ${h} to bill.`)},[We,a]),Ua=x.useCallback(async(h,g)=>{_e(null);const f=We.find(N=>N.id===h);if(!f){_e(`Order with ID ${h} not found.`);return}const k={status:g,medications:f.medications};try{const N=await Y(`/api/pharmacy-orders/${h}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)});if(!N.ok){const he=await N.text();throw new Error(`Failed to update status: ${N.statusText} (${N.status}) - ${he}`)}const Q=await N.json();St(he=>he.map(de=>de.id===Q.id?{...de,status:Q.status}:de)),d&&on(d)}catch(N){console.error("Failed to update order status:",N),_e(N.message||`Failed to update status for order ${h}.`),alert(`Error updating status for order ${h}: ${N.message||"Please try again."}`)}},[We,d]),ri=x.useCallback(h=>{Tt(g=>g.map(f=>f.id===h?{...f,isEditing:!0,editedTests:[...f.tests],editedStatus:f.status}:{...f,isEditing:!1}))},[]),Dl=x.useCallback(h=>{Tt(g=>g.map(f=>f.id===h?{...f,isEditing:!1,editedTests:void 0,editedStatus:void 0}:f))},[]),Il=x.useCallback((h,g,f,k)=>{Tt(N=>N.map(Q=>{if(Q.id===h){const he=Q.editedTests?[...Q.editedTests]:[...Q.tests];if(f==="add")return{...Q,editedTests:[...he,{id:"",name:"",price:0}]};if(f==="remove")return{...Q,editedTests:k};if(g!==-1){const de={...he[g],[f]:k};return he[g]=de,{...Q,editedTests:he}}}return Q}))},[]),Ol=x.useCallback((h,g)=>{Tt(f=>f.map(k=>k.id===h?{...k,editedStatus:g}:k))},[]),Ma=x.useCallback(async h=>{if(!h){console.error("Cannot navigate to billing: Lab Order data is missing."),alert("Could not open billing page: Lab Order information is missing.");return}a(`/dashboard/lab-billing/${h.id}`)},[a]),Ha=x.useCallback(async(h,g)=>{console.log(`Updating lab order ${h} to status ${g}`);try{const f=await Y(`/api/lab/${h}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:g})});if(!f.ok){const k=await f.json();throw new Error(k.message||`Failed to update lab order status: ${f.status}`)}d&&(ln(d),Tn(d)),console.log(`Lab Order ${h} status updated to ${g}, refetching data.`)}catch(f){console.error("Error updating lab order status:",f),alert(`Failed to update lab order status: ${f instanceof Error?f.message:"Unknown error"}`)}},[d]),or=x.useCallback(h=>{h&&h.id?a(`/lab/report/${h.id}`):(console.error("Cannot navigate: Lab Order or Lab Order ID is missing."),alert("Could not open the report entry page: Lab Order information is missing."))},[a]),$l=x.useCallback(async(h,g,f)=>{ya(!0),_e(null);try{if(!g||g.length===0)throw new Error("Lab order must have at least one test.");for(const Q of g)if(!Q.id||!Q.name||isNaN(Q.price)||Q.price<0)throw new Error(`Invalid test data: ${JSON.stringify(Q)}. Each test must have id, name, and a valid price.`);const k={tests:g,status:f},N=await Y(`/api/lab/orders/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)});if(!N.ok){const Q=await N.json().catch(()=>({}));throw new Error(Q.message||`Failed to update lab order: ${N.statusText}`)}d&&ln(d),Tt(Q=>Q.map(he=>he.id===h?{...he,isEditing:!1,editedTests:void 0,editedStatus:void 0}:he))}catch(k){_e(`Lab Order Save Error: ${k.message}`)}finally{ya(!1)}},[d]),Lt=x.useCallback(async h=>{if(!window.confirm(`Are you sure you want to delete this ${h.type.toLowerCase()} record? This action cannot be undone.`))return;jr(!0),sa(null);let f=null,k;const N=h.type;try{switch(N){case"Complaint":if(k=h.data.id,!k)throw new Error("Complaint ID is missing.");f=`/api/patients/complaints/${k}`;break;case"Lab Order":if(k=h.data.id,!k)throw new Error("Lab Order ID is missing.");f=`/api/lab/orders/${k}`;break;case"Lab Report":if(k=h.data.reportId,!k)throw new Error("Lab Report ID is missing.");f=`/api/lab/reports/${k}`;break;case"Pharmacy Order":if(k=h.data.id,!k)throw new Error("Pharmacy Order ID is missing.");f=`/api/pharmacy-orders/${k}`;break;default:throw new Error(`Deletion not supported for item type: ${N}`)}if(!f)throw new Error(`Could not determine delete URL for type: ${N}`);const Q=await Y(f,{method:"DELETE"});if(!Q.ok){const he=await Q.json().catch(()=>({}));throw new Error(he.message||`Failed to delete ${N}: ${Q.statusText}`)}d&&(N==="Complaint"?za(d):N==="Lab Order"?(ln(d),Tn(d)):N==="Lab Report"?Tn(d):N==="Pharmacy Order"&&on(d))}catch(Q){sa(`Delete Error (${N}): ${Q.message}`),Vn&&jr(!1)}finally{jr(!1)}},[d,Vn]),Wa=x.useCallback(async()=>{if(!d)return;if(We.filter(g=>g.status==="pending").length<2){alert("You need at least two pending orders to merge.");return}Da(!0);try{const g=await Y(`/api/pharmacy-orders/patient/${d}/merge-pending`,{method:"POST"});if(!g.ok){const f=await g.json().catch(()=>({}));throw new Error(f.message||"Failed to merge orders")}on(d)}catch(g){_e(`Merge Error: ${g.message}`)}finally{Da(!1)}},[d,We]),Rt=x.useMemo(()=>{if(!d||!P)return[];const h=P.map(g=>({date:new Date(g.createdAt),type:"Complaint",data:g,originalDateString:g.createdAt})).filter(g=>!isNaN(g.date.getTime()));return h.sort((g,f)=>f.date.getTime()-g.date.getTime()),h},[d,P]),Ft=x.useMemo(()=>{if(!d)return[];const h=new Map;(vr??[]).forEach(f=>{h.set(f.id,{...f})}),(pt??[]).forEach(f=>{if(!h.has(f.id))h.set(f.id,{id:f.id,patient_id:f.patient_id,tests:f.tests,status:f.status,createdAt:f.createdAt,report:f});else{const k=h.get(f.id);k&&(k.report=f,k.status=f.status)}});let g=Array.from(h.values());return g.sort((f,k)=>new Date(f.createdAt).getTime()-new Date(k.createdAt).getTime()),g=g.map((f,k)=>({...f,serialNumber:k+1})),g.map(f=>({date:new Date(f.createdAt),type:"Lab Order",data:f,originalDateString:f.createdAt}))},[d,vr,pt]),Wt=x.useCallback(async h=>{const g=h??c;if(!g.trim())return;tr.current&&(clearTimeout(tr.current),tr.current=null),Wr({role:"user",content:g});const f=Math.random().toString(36).substr(2,9);nn(k=>[...k,{id:f,role:"system",type:"loading",content:"",timestamp:new Date}]),Sn.current?(await Sn.current.callGenerativeApi(g),nn(k=>k.filter(N=>N.id!==f)),tr.current=setTimeout(()=>{nn([])},1e4)):nn(k=>k.filter(N=>N.id!==f))},[c,Wr,nn]),Va=x.useCallback(()=>{const h="reports came,please anaylse";u(h),setTimeout(()=>{Wt(h)},0)},[Wt,u]),ii=x.useCallback(h=>{gl(g=>({...g,[h]:!g[h]}))},[]),bt=x.useMemo(()=>{if(!d||!We)return[];const h=We.map(g=>({date:new Date(g.date),type:"Pharmacy Order",data:g,originalDateString:g.date})).filter(g=>!isNaN(g.date.getTime()));return h.sort((g,f)=>f.date.getTime()-g.date.getTime()),h},[d,We]),Ll=x.useCallback((h,g)=>i.jsxs("div",{className:"flex flex-col w-full",children:[i.jsxs("span",{className:"ai-context-text flex items-center",children:[bt.length-g,". Order Status: (",h.data.status,")",i.jsx("span",{className:"text-gray-400 ml-1 flex items-center",children:_a===h.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",children:i.jsx("input",{type:"datetime-local",defaultValue:Ci(h.originalDateString),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:f=>{f.target.value&&ti(h.data.id,f.target.value),Dr(null)},onKeyDown:f=>{if(f.key==="Enter"){const k=f.target;k.value&&ti(h.data.id,k.value),Dr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/date ml-1",onClick:()=>Dr(h.data.id),title:"Click to edit date",children:["(",new Date(h.originalDateString).toLocaleDateString(),")",i.jsx(ft,{size:14,className:"ml-1 text-gray-500 hover:text-gray-700"})]})}),i.jsxs("div",{className:"inline-flex space-x-2 ml-2",children:[i.jsx("button",{onClick:()=>ni(h.data.id),className:"icon-button small",title:"Edit Pharmacy Order",children:i.jsx(ft,{size:12})}),h.data.prescriptionForUnavailableDrugs&&i.jsx("button",{onClick:()=>{const f=xi().use(kt).use(ji).processSync(h.data.prescriptionForUnavailableDrugs).toString();ai(f,"Unavailable Drugs Prescription")},className:"icon-button small",title:"Print Unavailable Drugs Prescription",children:i.jsx(Ln,{size:12})}),h.data.status==="dispensed"||h.data.status==="billed"?i.jsx("button",{onClick:()=>a(`/dashboard/pharmacy-billing/${h.data.id}`),className:"icon-button small text-blue-600",title:"View Pharmacy Bill",children:i.jsx(oi,{size:12})}):i.jsx("button",{onClick:()=>Lt({type:"Pharmacy Order",data:h.data}),className:"icon-button small text-red-500",title:"Delete Pharmacy Order",children:i.jsx(gt,{size:12})}),h.data.status==="pending"&&i.jsx("button",{onClick:()=>Ba(h.data.id),className:"icon-button small",title:"Bill this pharmacy order",disabled:ht,children:i.jsx(as,{size:12})}),h.data.status==="billed"&&i.jsx("button",{onClick:()=>Ua(h.data.id,"dispensed"),className:"icon-button small",title:"Dispense this pharmacy order",disabled:ht,children:i.jsx(ss,{size:12})}),i.jsx("button",{onClick:()=>qa(h.data),className:"icon-button small group-hover:block",title:"Add to Recurring Medications",children:i.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-repeat",children:[i.jsx("path",{d:"m17 2 4 4-4 4"}),i.jsx("path",{d:"M3 11v-1a4 4 0 0 1 4-4h14"}),i.jsx("path",{d:"m7 22-4-4 4-4"}),i.jsx("path",{d:"M21 13v1a4 4 0 0 1-4 4H3"})]})})]})]}),i.jsx("div",{className:"pharmacy-order-drugs-table-container mobile-edge-to-edge-table-container mt-2 cursor-pointer hover:bg-gray-50 transition-colors rounded p-1",onClick:()=>ni(h.data.id),title:"Click to edit order",children:i.jsxs("table",{className:"pharmacy-order-drugs-table mobile-edge-to-edge-table w-full text-xs",children:[i.jsx("thead",{children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-1 px-2 text-left",children:"Drug Name"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Quantity"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Dosage"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Directions"})]})}),i.jsx("tbody",{children:h.data.medications.map((f,k)=>i.jsxs("tr",{children:[i.jsx("td",{className:"py-1 px-2",children:i.jsx("strong",{children:f.name})}),i.jsxs("td",{className:"py-1 px-2",children:[f.pack_quantity!==void 0&&f.pack_quantity>0&&`Packs: ${f.pack_quantity}`,f.pack_quantity!==void 0&&f.pack_quantity>0&&f.loose_quantity!==void 0&&f.loose_quantity>0&&", ",f.loose_quantity!==void 0&&f.loose_quantity>0&&`Loose: ${f.loose_quantity}`]}),i.jsx("td",{className:"py-1 px-2",children:f.tabletsPerDay&&f.numberOfDays?`${f.tabletsPerDay} tab/day for ${f.numberOfDays} days`:"N/A"}),i.jsx("td",{className:"py-1 px-2",children:f.directions_to_use||"N/A"})]},f.drug_id||f.name||k))})]})}),h.data.prescriptionForUnavailableDrugs&&i.jsxs("div",{className:"unavailable-drugs-markdown mt-2",children:[i.jsx("span",{className:"font-semibold text-xs text-gray-600 block mb-1",children:"Prescription for Unavailable Drugs:"}),i.jsx(Qt,{remarkPlugins:[kt],children:h.data.prescriptionForUnavailableDrugs})]})]}),[bt,_a,ti,ni,Ba,Ua,qa,Lt,ht,a]),Rl=x.useCallback((h,g)=>{const f=uh(h.data.report?h.data.report.status:h.data.status),k=(h.data.tests||[]).reduce((N,Q)=>N+(Number(Q.price)||0),0).toFixed(2);return i.jsxs("div",{className:"flex flex-col w-full",children:[i.jsxs("div",{className:"flex justify-between items-start mb-2",children:[i.jsxs("div",{className:"ai-context-text flex items-center flex-wrap",children:[i.jsxs("span",{className:"font-medium cursor-pointer hover:text-blue-600 transition-colors mr-2",onClick:()=>or(h.data),title:"Click to enter report",children:["#",h.data.serialNumber," [Order]"]}),i.jsx("span",{className:`mr-2 ${f.className}`,children:f.text}),i.jsx("span",{className:"text-gray-400 inline-flex items-center",children:va===h.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",onClick:N=>N.stopPropagation(),children:i.jsx("input",{type:"datetime-local",defaultValue:Ci(h.originalDateString),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:N=>{N.target.value&&En(h.data.id,"order",N.target.value),Ur(null)},onKeyDown:N=>{if(N.key==="Enter"){const Q=N.target;Q.value&&En(h.data.id,"order",Q.value),Ur(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/date ml-1",onClick:N=>{N.stopPropagation(),Ur(h.data.id)},title:"Click to edit order date",children:["(",new Date(h.originalDateString).toLocaleDateString(),")",i.jsx(ft,{size:14,className:"ml-1 text-gray-500 hover:text-gray-700"})]})})]}),!h.data.isEditing&&i.jsxs("div",{className:"flex space-x-1 items-center",children:[i.jsx("button",{onClick:()=>ri(h.data.id),className:"icon-button small",title:"Edit",disabled:ht,children:i.jsx(ft,{size:12})}),h.data.status==="pending"?i.jsx("button",{onClick:()=>Ma(h.data),className:"icon-button small font-medium text-green-600 w-auto px-1",title:`Pay total of ₹${k}`,disabled:ht,children:i.jsx(ao,{size:12})}):i.jsx("button",{onClick:()=>a(`/dashboard/lab-billing/${h.data.id}`),className:"icon-button small text-blue-600",title:"View Lab Bill",children:i.jsx(fc,{size:12})}),["pending","billed","collected","processing","report_ready","reported","completed"].includes(h.data.status)&&i.jsx("button",{onClick:()=>or(h.data),className:"icon-button small text-indigo-600",title:"Enter Report",disabled:ht,children:i.jsx(oi,{size:12})}),(h.data.status==="report_ready"||h.data.status==="reported")&&i.jsx("button",{onClick:()=>Ha(h.data.id,"completed"),className:"icon-button small text-green-600",title:"Mark Completed",disabled:ht,children:i.jsx(ss,{size:12})}),i.jsx("button",{onClick:()=>Lt({type:"Lab Order",data:h.data}),className:"icon-button small text-red-500",title:"Delete",disabled:ht,children:i.jsx(gt,{size:12})})]})]}),i.jsx("div",{className:"lab-order-tests-table-container mobile-edge-to-edge-table-container mt-1 mb-2 cursor-pointer hover:bg-gray-50 transition-colors rounded p-1 border border-gray-100",onClick:()=>{h.data.status==="pending"?ri(h.data.id):or(h.data)},title:h.data.status==="pending"?"Click to edit order":"Click to enter report",children:i.jsxs("table",{className:"lab-order-tests-table mobile-edge-to-edge-table w-full text-xs text-left",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b bg-gray-50",children:[i.jsx("th",{className:"py-1 px-2 font-medium text-gray-600",children:"Test Name"}),i.jsx("th",{className:"py-1 px-2 text-right font-medium text-gray-600",children:"Price"})]})}),i.jsxs("tbody",{children:[h.data.tests&&h.data.tests.length>0?h.data.tests.map(N=>i.jsxs("tr",{className:"border-b last:border-0 hover:bg-gray-100",children:[i.jsx("td",{className:"py-1 px-2",children:N.name}),i.jsxs("td",{className:"py-1 px-2 text-right",children:["₹",N.price]})]},N.id||N.name)):i.jsx("tr",{children:i.jsx("td",{colSpan:2,className:"py-1 px-2 italic text-gray-500",children:"No tests specified"})}),i.jsxs("tr",{className:"bg-gray-50 font-semibold",children:[i.jsx("td",{className:"py-1 px-2 text-right text-gray-700",children:"Total:"}),i.jsxs("td",{className:"py-1 px-2 text-right text-gray-900",children:["₹",k]})]})]})]})}),h.data.report&&i.jsxs("div",{className:"ml-4 mt-1 p-2 border-l-2 border-gray-200",children:[i.jsxs("div",{className:"flex justify-between items-center mb-2",children:[i.jsx("span",{className:"font-medium text-sm text-gray-700",children:"[Report]"}),i.jsxs("div",{className:"flex items-center",children:[i.jsx("span",{className:"text-gray-400 ml-1 flex items-center text-xs",children:ja===h.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",onClick:N=>N.stopPropagation(),children:i.jsx("input",{type:"datetime-local",defaultValue:Ci(h.data.report.report_date),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:N=>{N.target.value&&En(h.data.id,"report",N.target.value),Mr(null)},onKeyDown:N=>{if(N.key==="Enter"){const Q=N.target;Q.value&&En(h.data.id,"report",Q.value),Mr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/reportDate ml-1",onClick:N=>{N.stopPropagation(),Mr(h.data.id)},title:"Click to edit report date",children:["(",new Date(h.data.report.report_date).toLocaleDateString(),")",i.jsx(ft,{size:12,className:"ml-1 text-gray-500 hover:text-gray-700"})]})}),i.jsx("button",{onClick:()=>ii(h.data.report.reportId),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400 ml-2",title:bn[h.data.report.reportId]?"Collapse Report":"Expand Report",children:bn[h.data.report.reportId]?i.jsx(os,{size:14}):i.jsx(ls,{size:14})}),i.jsx("button",{onClick:()=>Lt({type:"Lab Report",data:h.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400 ml-1",title:"Delete Report",children:i.jsx(gt,{size:12})})]})]}),bn[h.data.report.reportId]&&(()=>{try{const N=JSON.parse(h.data.report.report_content||"{}");return typeof N=="object"&&N!==null&&h.data.report.tests?h.data.report.tests.map(Q=>i.jsxs("div",{style:{marginBottom:"10px"},children:[i.jsx("h5",{className:"font-semibold text-xs mt-2 mb-1 text-gray-700",children:Q.name}),N[Q.id]?i.jsx("div",{className:"mobile-edge-to-edge-table-container",children:i.jsxs("table",{className:"lab-inventory-table mobile-edge-to-edge-table w-full text-xs",children:[i.jsx("thead",{children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Parameter"}),i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Value"}),i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Normal Range"})]})}),i.jsx("tbody",{children:Object.entries(N[Q.id]).map(([he,de])=>{var wt;const we=(wt=Q.default_parameters)==null?void 0:wt.find(ut=>ut.name===he);return i.jsxs("tr",{className:"border-b last:border-0",children:[i.jsx("td",{className:"py-1 px-2",children:he}),i.jsxs("td",{className:"py-1 px-2",children:[String(de)," ",(we==null?void 0:we.unit)||""]}),i.jsx("td",{className:"py-1 px-2 text-gray-500",children:(()=>{if(we&&we.type==="number"&&(we.lower_limit!=null||we.upper_limit!=null)){let ut="";return we.lower_limit!=null&&(ut+=` > ${we.lower_limit}`),we.lower_limit!=null&&we.upper_limit!=null&&(ut+=" - "),we.upper_limit!=null&&(ut+=` < ${we.upper_limit}`),ut.trim()||"N/A"}else if((we==null?void 0:we.type)==="boolean")return"N/A";return(we==null?void 0:we.normal_range)||"N/A"})()})]},he)})})]})}):i.jsx("p",{className:"italic text-gray-500 text-xs",children:"No parameters reported for this test."})]},Q.id)):i.jsx("div",{className:"text-xs prose",children:i.jsx(Qt,{remarkPlugins:[kt],children:h.data.report.report_content})})}catch{return i.jsx("div",{className:"text-xs prose",children:i.jsx(Qt,{remarkPlugins:[kt],children:h.data.report.report_content||"*No findings recorded.*"})})}})()]})]})},[va,or,En,ri,ht,Ma,a,Lt,ja,bn,ii,Ha]),Fl=x.useCallback((h,g)=>i.jsx("div",{className:"ai-context-text w-full",children:Ca===h.data.id?i.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[i.jsx("input",{type:"text",value:Et,onChange:f=>tn(f.target.value),className:"border rounded px-2 py-1 text-sm w-full",autoFocus:!0,onKeyDown:async f=>{if(f.key==="Enter"&&Et.trim()){Zn(!0);try{await Y(`/api/patients/complaints/${h.data.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:Et.trim()})}),h.data.complaint=Et.trim(),_n(null),tn("")}catch(k){console.error("Error updating complaint:",k)}Zn(!1)}f.key==="Escape"&&(_n(null),tn(""))},disabled:Nn}),i.jsxs("div",{className:"flex gap-1",children:[i.jsx("button",{onClick:async()=>{if(Et.trim()){Zn(!0);try{await Y(`/api/patients/complaints/${h.data.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:Et.trim()})}),h.data.complaint=Et.trim(),_n(null),tn("")}catch(f){console.error("Error updating complaint:",f)}Zn(!1)}},className:"text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600",disabled:Nn||!Et.trim(),children:Nn?"Saving...":"Save"}),i.jsx("button",{onClick:()=>{_n(null),tn("")},className:"text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300",disabled:Nn,children:"Cancel"})]})]}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 rounded px-1 -mx-1 transition-colors inline-block",onClick:()=>{_n(h.data.id),tn(h.data.complaint)},title:"Click to edit",children:[h.data.complaint,i.jsxs("span",{className:"text-gray-400 ml-1",children:["(",new Date(h.originalDateString).toLocaleDateString(),")"]})]})}),[Ca,Et,Nn,Lt]),zl=x.useMemo(()=>i.jsxs("div",{className:"flex space-x-2",children:[i.jsx("button",{onClick:Wa,className:"button-primary blue text-xs px-2 py-1",disabled:nr||We.filter(h=>h.status==="pending").length<2,title:"Merge all pending orders into one",children:nr?"Merging...":"Merge Orders"}),i.jsxs("button",{onClick:()=>ca(!0),className:"button-primary green text-xs px-2 py-1",title:"Manually create a new pharmacy order",disabled:!d,children:[i.jsx(fr,{size:12,className:"mr-1"})," Create Order"]})]}),[Wa,nr,We,d]),ql=x.useMemo(()=>i.jsxs("div",{className:"flex space-x-2",children:[i.jsx("button",{onClick:Va,className:"button-primary blue text-xs px-2 py-1",title:"Tell AI to analyse the reports",disabled:A||tt||$t||Je,children:"Analyse Reports"}),i.jsxs("button",{onClick:()=>oa(!0),className:"button-primary green text-xs px-2 py-1",title:"Manually create a new lab order",disabled:!d,children:[i.jsx(fr,{size:12,className:"mr-1"})," Create Lab Order"]})]}),[Va,A,tt,$t,Je,d]),[Ja,Qa]=x.useState(null),[Ga,Ya]=x.useState([]),[lr,Ka]=x.useState(""),Za=(h,g)=>{if(!h||!h.report_content||!g)return"";try{const f=JSON.parse(h.report_content||"{}");if(typeof f!="object"||f===null)return`<p class="italic text-gray-500 text-xs">Report content is not structured data.</p><pre>${h.report_content}</pre>`;let k="";return g.forEach(N=>{f[N.id]?(k+=`<h5 class="font-semibold text-sm mt-2 mb-1">${N.name}</h5>`,k+='<table class="lab-report-print-table"><thead><tr><th>Parameter</th><th>Value</th><th>Normal Range</th></tr></thead><tbody>',Object.entries(f[N.id]).map(([Q,he])=>{var wt;const de=(wt=N.default_parameters)==null?void 0:wt.find(ut=>ut.name===Q);let we="N/A";de&&de.type==="number"&&(de.lower_limit!=null||de.upper_limit!=null)?(we="",de.lower_limit!=null&&(we+=` > ${de.lower_limit}`),de.lower_limit!=null&&de.upper_limit!=null&&(we+=" - "),de.upper_limit!=null&&(we+=` < ${de.upper_limit}`),we=we.trim()||"N/A"):(de==null?void 0:de.type)==="boolean"?we="N/A":de!=null&&de.normal_range&&(we=de.normal_range),k+=`<tr><td>${Q}</td><td>${String(he)} ${(de==null?void 0:de.unit)||""}</td><td>${we}</td></tr>`}),k+="</tbody></table>"):k+=`<p class="italic text-gray-500 text-xs">No parameters reported for ${N.name}.</p>`}),k}catch{return`<p class="italic text-gray-500 text-xs">Error parsing report content.</p><pre>${h.report_content}</pre>`}};x.useEffect(()=>{const h=()=>{Kt(window.innerHeight)};return window.addEventListener("resize",h),h(),()=>window.removeEventListener("resize",h)},[]),x.useEffect(()=>{const h=f=>{if(!pe||!oe.current||!qe.current)return;const k=qe.current.getBoundingClientRect(),Q=f.clientX-oe.current.x;let he=oe.current.initialWidth+Q;const de=k.width-ve-10;he=Math.max(ve,he),he=Math.min(he,de);const we=he/k.width*100;ge(we)},g=()=>{H(!1),oe.current=null,document.body.style.cursor="",document.body.style.userSelect=""};return pe&&(window.addEventListener("mousemove",h),window.addEventListener("mouseup",g),document.body.style.cursor="col-resize",document.body.style.userSelect="none"),()=>{window.removeEventListener("mousemove",h),window.removeEventListener("mouseup",g),document.body.style.cursor="",document.body.style.userSelect=""}},[pe]);const Bl=h=>{if(!qe.current)return;h.preventDefault();const g=qe.current.querySelector(".edit-complaint-context-column");g&&(oe.current={x:h.clientX,initialWidth:g.offsetWidth},H(!0))},Xa=x.useCallback(async()=>{w(!0),_e(null);try{const h=await Y("/api/queue/doctor/new",{method:"POST"});if(!h.ok){const f=await h.json().catch(()=>({}));throw new Error(f.message||`Failed to create record: ${h.statusText}`)}const g=await h.json();if(!g.recordId)throw new Error("New record ID not received from server.");a(`/edit-complaint/${g.recordId}`,{replace:!0})}catch(h){_e(`Failed to create new complaint record: ${h.message}`)}finally{w(!1)}},[a]);x.useEffect(()=>{(async()=>{$a(!0);try{const g=await o.fetchQuery({queryKey:mt.clinicSettings,queryFn:async()=>{const f=await Y("/api/clinics/settings");if(!f.ok)throw new Error("Failed to fetch clinic settings.");return f.json()},staleTime:18e5});Gr({admissionCharge:parseFloat(g.admissionCharge||0).toFixed(2),perDayCharge:parseFloat(g.perDayCharge||0).toFixed(2),otherCharges:parseFloat(g.otherCharges||0).toFixed(2),aiMemory:g.aiMemory||"",aiMemoryUpdatedAt:g.aiMemoryUpdatedAt||null,clinicWideSystemPrompt:g.clinicWideSystemPrompt||"",clinicWideSystemPromptUpdatedAt:g.clinicWideSystemPromptUpdatedAt||null,gemini_api_key:g.gemini_api_key||""}),Yr(g.aiMemory||""),Cn(g.clinicWideSystemPrompt||"")}catch{}finally{$a(!1)}})()},[]),x.useEffect(()=>{var g;(g=l.state)!=null&&g.initialComplaint&&u(l.state.initialComplaint);const h=async f=>{M(!0),_e(null);try{const k=await o.fetchQuery({queryKey:mt.queue.entry(f),queryFn:async()=>{const N=await Y(`/api/queue/doctor/complaint/${f}`);if(!N.ok){const Q=await N.json().catch(()=>({}));throw new Error(Q.message||`HTTP error! status: ${N.status}`)}return N.json()},staleTime:6e4});y(k.patientId),G(k.age),B(k.gender),W(k.case_summary||null),K(k.updatedAt||null)}catch{_e("Failed to load current complaint details."),y(null),G(void 0),B(void 0),W(null),K(null)}finally{M(!1)}};if(r)h(r);else if(t){const f=t;f&&(y(f),(async()=>{try{let N;try{N=await o.fetchQuery({queryKey:mt.queue.latest(f),queryFn:async()=>{const he=await Y(`/api/queue/patient/${f}/latest`);if(!he.ok)throw new Error("Failed");return he.json()},staleTime:5e3})}catch{}if(N!=null&&N._id){s(N._id),h(N._id);return}const Q=await Y("/api/queue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:f,complaint:"Visit Initiated"})});if(Q.ok){const he=await Q.json();if(he!=null&&he.id){s(he.id),h(he.id);return}}}catch(N){console.error("Background queue resolution failed",N),_e("Failed to initialize visit record.")}})())}else Xa()},[r,Xa,(rs=l.state)==null?void 0:rs.initialComplaint,t]),x.useEffect(()=>{d?Pn(d):(E(null),S([]),St([]),Tt([]),yt([]),K(null),kn(!1))},[d]),x.useEffect(()=>{var f;const h=(f=l.state)==null?void 0:f.initialComplaint;h&&r&&(!A&&!ee&&!xn&&!Je&&!lt)&&!Qe.current&&c===h&&(Qe.current=!0,Wt(),a(l.pathname,{replace:!0,state:{}}))},[(is=l.state)==null?void 0:is.initialComplaint,r,c,A,ee,xn,Je,lt,a]);const es=()=>{ce(I||""),j(!0),_(null)},Ul=()=>{j(!1),ce(""),_(null)},Ml=async()=>{if(!r){_("Missing Record ID.");return}le(!0),_(null);try{const h=await Y(`/api/queue/doctor/complaint/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({case_summary:X.trim()})});if(!h.ok){const f=await h.json().catch(()=>({}));throw new Error(f.message||`Failed to save case summary: ${h.statusText}`)}const g=await h.json();W(g.case_summary||X.trim()),K(g.updatedAt||null),j(!1)}catch(h){_(`Save Error: ${h.message}`)}finally{le(!1)}};x.useEffect(()=>{(async()=>{nt(!0),en(null);try{const[g,f]=await Promise.all([o.fetchQuery({queryKey:mt.drugs.all,queryFn:async()=>{const k=await Y("/api/drugs");if(!k.ok)throw new Error(`Pharmacy inventory error! status: ${k.status}`);const N=await k.json();return N.drugs||N},staleTime:6e5}),o.fetchQuery({queryKey:mt.labTests.all,queryFn:async()=>{const k=await Y("/api/lab-tests");if(!k.ok)throw new Error(`Lab inventory error! status: ${k.status}`);return k.json()},staleTime:6e5})]);Ge(g),xt(f||[])}catch(g){en(g.message)}finally{nt(!1)}})()},[]);const Hl=async()=>{if(!Ae)return;if(rr===Ae.aiMemory&&jn===Ae.clinicWideSystemPrompt){ir(!1);return}const h=rr!==Ae.aiMemory,g=jn!==Ae.clinicWideSystemPrompt;h&&La(!0),g&&Ra(!0);try{const f={...Ae};h&&(f.aiMemory=rr),g&&(f.clinicWideSystemPrompt=jn);const k=await Y("/api/clinics/settings",{method:"PUT",body:JSON.stringify(f)});if(!k.ok){const Q=await k.json().catch(()=>({}));throw new Error(Q.message||"Failed to update clinic settings.")}const N=await k.json();Gr({admissionCharge:parseFloat(N.settings.admissionCharge).toFixed(2),perDayCharge:parseFloat(N.settings.perDayCharge).toFixed(2),otherCharges:parseFloat(N.settings.otherCharges).toFixed(2),aiMemory:N.settings.aiMemory||"",aiMemoryUpdatedAt:N.settings.aiMemoryUpdatedAt||(Ae==null?void 0:Ae.aiMemoryUpdatedAt)||null,clinicWideSystemPrompt:N.settings.clinicWideSystemPrompt||"",clinicWideSystemPromptUpdatedAt:N.settings.clinicWideSystemPromptUpdatedAt||(Ae==null?void 0:Ae.clinicWideSystemPromptUpdatedAt)||null}),h&&Yr(N.settings.aiMemory||""),g&&(Cn(N.settings.clinicWideSystemPrompt||""),ir(!1))}catch{}finally{h&&La(!1),g&&Ra(!1)}},ts=()=>{Ae&&(Cn(Ae.clinicWideSystemPrompt||""),ir(!0))},Wl=()=>{ir(!1),Ae&&Cn(Ae.clinicWideSystemPrompt||"")},Vl=h=>{navigator.clipboard.writeText(h).then(()=>{}).catch(g=>{console.error("Failed to copy text: ",g)})},ai=(h,g)=>{const f=window.open("","_blank");f&&(f.document.write(`
        <html>
          <head>
            <title>${g}</title>
            <style>
              body { font-family: sans-serif; margin: 20px; }
              h2 { text-align: center; margin-bottom: 20px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              pre { white-space: pre-wrap; word-wrap: break-word; }
              .ai-context-section { margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 5px; }
              .ai-context-section-title { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; color: #333; }
              .ai-context-text { margin-bottom: 5px; }
              .text-gray-400 { color: #999; }
              .font-semibold { font-weight: 600; }
              .italic { font-style: italic; }
              .mt-2 { margin-top: 8px; }
              .ml-1 { margin-left: 4px; }
              .ml-2 { margin-left: 8px; }
              .flex { display: flex; }
              .flex-col { flex-direction: column; }
              .w-full { width: 100%; }
              .text-xs { font-size: 0.75rem; }
              .text-sm { font-size: 0.875rem; }
              .prose { max-width: 65ch; }
              .prose table { display: table; } /* Ensure tables in markdown render correctly */
            </style>
          </head>
          <body>
            <h2>${g}</h2>
            <div id="print-content">${h}</div>
          </body>
        </html>
      `),f.document.close(),f.print())},Jl=()=>{if(b){const h=xi().use(kt).use(ji).processSync(He).toString();ai(`<div class="prose">${h}</div>`,"Summary")}};x.useEffect(()=>{if(p){let h=`
        <div class="print-section">
          <h3>Patient Details</h3>
          <p><strong>Name:</strong> ${p.name||"N/A"}</p>
          <p><strong>Token:</strong> ${p.patient_token_number||"N/A"}</p>
          <p><strong>Age:</strong> ${p.age||"N/A"}</p>
          <p><strong>Gender:</strong> ${p.gender||"N/A"}</p>
          <p><strong>Phone:</strong> ${p.phone||"N/A"}</p>
          <p><strong>Insurance:</strong> ${p.insurance_type||"N/A"}</p>
          <p><strong>Status:</strong> ${p.current_status||"N/A"}</p>
          <p><strong>Admitted:</strong> ${p.admission_date?new Date(p.admission_date).toLocaleDateString():"N/A"}</p>
          <p><strong>Discharged:</strong> ${p.discharge_date?new Date(p.discharge_date).toLocaleDateString():"N/A"}</p>
        </div>
        <div class="print-section">
          <h3>Case Summary</h3>
          <p>${I||"No summary available."}</p>
        </div>
        <div class="print-section">
          <h3>Complaints History</h3>
          ${Rt.length>0?`
            <ul>
              ${Rt.map(g=>`<li>${new Date(g.originalDateString).toLocaleDateString()}: ${g.data.complaint}</li>`).join("")}
            </ul>
          `:"<p>No past complaints.</p>"}
        </div>
        <div class="print-section">
          <h3>Pharmacy Orders</h3>
          ${bt.length>0?`
            <table class="print-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Drug Name</th>
                  <th>Quantity</th>
                  <th>Dosage</th>
                  <th>Directions</th>
                </tr>
              </thead>
              <tbody>
                ${bt.map(g=>{const f=g.data.medications.map((N,Q)=>`
                    <tr>
                      ${Q===0?`<td rowspan="${g.data.medications.length+(g.data.prescriptionForUnavailableDrugs?1:0)}">${new Date(g.originalDateString).toLocaleDateString()}</td>`:""}
                      ${Q===0?`<td rowspan="${g.data.medications.length+(g.data.prescriptionForUnavailableDrugs?1:0)}">${g.data.status}</td>`:""}
                      <td><strong>${N.name}</strong></td>
                      <td>
                        ${N.pack_quantity!==void 0&&N.pack_quantity>0?`Packs: ${N.pack_quantity}`:""}
                        ${N.pack_quantity!==void 0&&N.pack_quantity>0&&N.loose_quantity!==void 0&&N.loose_quantity>0?", ":""}
                        ${N.loose_quantity!==void 0&&N.loose_quantity>0?`Loose: ${N.loose_quantity}`:""}
                      </td>
                      <td>${N.tabletsPerDay&&N.numberOfDays?`${N.tabletsPerDay} tab/day for ${N.numberOfDays} days`:"N/A"}</td>
                      <td>${N.directions_to_use||"N/A"}</td>
                    </tr>
                  `).join("");let k="";return g.data.prescriptionForUnavailableDrugs&&(k=`
                      <tr>
                        <td colspan="4" style="background-color: #f9f9f9; padding: 10px;">
                          <div style="font-style: italic; margin-bottom: 5px; font-weight: 600;">Prescription for Unavailable Drugs:</div>
                          <div class="prose" style="font-size: 0.9em;">${xi().use(kt).use(ji).processSync(g.data.prescriptionForUnavailableDrugs).toString()}</div>
                        </td>
                      </tr>
                    `),f+k}).join("")}
              </tbody>
            </table>
          `:"<p>No pharmacy orders.</p>"}
        </div>
        <div class="print-section">
          <h3>Lab History (Orders & Reports)</h3>
          ${Ft.length>0?`
            ${Ft.map(g=>{const f=g.data.tests.map(N=>N.name).join(", ");let k="";return g.data.report&&(k=`
                  <div class="lab-report-print-container">
                    <h4>Lab Report (${new Date(g.data.report.report_date).toLocaleDateString()})</h4>
                    ${Za(g.data.report,g.data.report.tests)}
                  </div>
                `),`
                <div class="lab-history-item">
                  <p><strong>Order Date:</strong> ${new Date(g.originalDateString).toLocaleDateString()}</p>
                  <p><strong>Status:</strong> ${g.data.status}</p>
                  <p><strong>Tests:</strong> ${f}</p>
                  ${k}
                </div>
              `}).join("")}
          `:"<p>No lab history.</p>"}
        </div>
      `;if(Object.keys(sr).length>0){const g=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],f=[32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17],k=(de,we)=>{const wt=ar[de]||[],ut=ug(de,wt);return`
            <div style="display:inline-flex;flex-direction:column;align-items:center;margin:2px;">
              ${we?`<span style="font-size:8px;color:#666;margin-bottom:2px;">${de}</span>`:""}
              ${ut}
              ${we?"":`<span style="font-size:8px;color:#666;margin-top:2px;">${de}</span>`}
            </div>
          `},N=g.map(de=>k(de,!0)).join(""),Q=f.map(de=>k(de,!1)).join(""),he=Object.entries(sr).sort(([de],[we])=>Number(de)-Number(we)).map(([de,we])=>{const ut=(ar[Number(de)]||[]).map(cr=>cr.replace("condition-","")).join(", "),ac=we.map(cr=>`${cr.name} (${cr.date})`).join("; ");return`
              <tr>
                <td><strong>Tooth ${de}</strong></td>
                <td>${ut||"N/A"}</td>
                <td>${ac||"N/A"}</td>
              </tr>
            `}).join("");h+=`
          <div class="print-section">
            <h3>Dental Chart</h3>
            <div style="text-align:center;margin-bottom:15px;padding:10px;background:#f9f9f9;border-radius:8px;">
              <div style="margin-bottom:8px;">
                <div style="font-size:10px;color:#666;margin-bottom:4px;">Upper Arch</div>
                <div style="display:flex;justify-content:center;flex-wrap:nowrap;">${N}</div>
              </div>
              <div style="border-top:1px solid #ddd;padding-top:8px;">
                <div style="display:flex;justify-content:center;flex-wrap:nowrap;">${Q}</div>
                <div style="font-size:10px;color:#666;margin-top:4px;">Lower Arch</div>
              </div>
            </div>
            <h4 style="margin-top:15px;margin-bottom:8px;">Procedure Details</h4>
            <table class="print-table">
              <thead>
                <tr>
                  <th>Tooth</th>
                  <th>Conditions</th>
                  <th>Procedures</th>
                </tr>
              </thead>
              <tbody>
                ${he}
              </tbody>
            </table>
          </div>
        `}Ka(h)}else Ka("")},[p,I,Rt,bt,Ft,Za,sr,ar]);const ns=()=>{lr&&ai(lr,`Patient Details - ${p==null?void 0:p.name}`)},Ql=h=>{u(h),Qa(null),Ya([]),setTimeout(()=>{Wt(h)},0)},Dt=A||tt||v||Je||ee||lt||xn||me||Hn||ll||ul||pl||ml||ht||Pt||rn||an||nr||Vn||Tr||Pr||Er||Ar||ne,Gl=h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),!Dt&&c.trim()&&r&&Wt())};x.useEffect(()=>{const h=window.SpeechRecognition||window.webkitSpeechRecognition;if(!h){Hr("Speech recognition not supported in this browser.");return}const g=new h;return g.continuous=!0,g.interimResults=!0,g.lang="en-US",g.onresult=f=>{let k="";for(let N=f.resultIndex;N<f.results.length;++N)f.results[N].isFinal&&(k+=f.results[N][0].transcript);k&&u(N=>N+(N.endsWith(" ")||N===""?"":" ")+k)},g.onerror=f=>{Hr(`Speech error: ${f.error}`),jl(!1)},g.onend=()=>{},Xn.current=g,()=>{Xn.current&&Xn.current.stop()}},[]);const Yl=async()=>{if(d)if(Yn){ba(!0);try{const h=await Y(`/api/patients/${d}/discharge`,{method:"POST"});if(!h.ok){const g=await h.json().catch(()=>({}));throw new Error(g.message||`Failed to discharge patient: ${h.status}`)}sn(d)}catch(h){_e(`Discharge Error: ${h.message}`)}finally{ba(!1)}}else{xa(!0);try{const h=await Y(`/api/patients/${d}/admit`,{method:"POST"});if(!h.ok){const g=await h.json().catch(()=>({}));throw new Error(g.message||`Failed to admit patient: ${h.status}`)}sn(d)}catch(h){_e(`Admit Error: ${h.message}`)}finally{xa(!1)}}},Kl=async h=>{if(d){wa(!0);try{const f=await Y("/api/queue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:d})});if(!f.ok){const k=await f.json().catch(()=>({}));throw new Error(k.message||`Failed to add patient to ${h} queue: ${f.status}`)}d&&(sn(d),ei(d))}catch(g){_e(`Add to Queue Error: ${g.message}`)}finally{wa(!1)}}},Zl=async()=>{if(r){ka(!0),_e(null);try{const h=await Y(`/api/queue/${r}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"seen"})});if(!h.ok){const f=await h.json().catch(()=>({}));throw new Error(f.message||"Failed to complete consultation")}d&&(sn(d),ei(d));const g=localStorage.getItem("currentUser");if(o.removeQueries({queryKey:mt.queue.all}),g){const f=JSON.parse(g);f.role==="receptionist"?a("/dashboard"):f.role==="doctor"||f.role==="admin"?a("/dashboard/queue"):a("/dashboard")}else a("/dashboard")}catch(h){_e(`Error completing consultation: ${h.message}`)}finally{ka(!1)}}},Xl=async()=>{if(!d){Ht("Missing Patient ID.");return}if(!p){Ht("Patient details not loaded.");return}Br(!0),Ht(null);try{const h={};let g=!1;if(Ir!==p.name&&(h.name=Ir,g=!0),$r!==p.age&&(h.age=$r,g=!0),Rr!==p.gender&&(h.gender=Rr,g=!0),zr!==p.phone&&(h.phone=zr,g=!0),!g){Ht("No changes detected."),Br(!1),Kn(!1);return}const f=await Y(`/api/patients/${d}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)});if(!f.ok){const N=await f.json().catch(()=>({}));throw new Error(N.message||`Failed to update patient details: ${f.statusText}`)}const k=await f.json();E(k),G(k.age),B(k.gender),Or(k.name),Lr(k.age),Fr(k.gender),qr(k.phone),Kn(!1)}catch(h){Ht(`Save Error: ${h.message}`)}finally{Br(!1)}},ec=async(h,g,f)=>{h.stopPropagation();const k=[null,"red","green","blue"],N=k.indexOf(f||null),Q=k[(N+1)%k.length];E(he=>he?{...he,color_code:Q}:null);try{await Y(`/api/patients/${g}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({color_code:Q})})}catch(he){console.error("Error updating color code:",he),E(de=>de?{...de,color_code:f||null}:null)}},tc=x.useCallback(()=>{if(!p)return null;const h={token_number:p.patient_token_number||"N/A",name:p.name||"N/A",age:p.age||"N/A",gender:p.gender||"N/A",phone:p.phone||"N/A"};return Rt.length>0?h.complaints_history=Rt.map(g=>`${g.data.complaint} (${new Date(g.originalDateString).toLocaleDateString()})`).join("; "):h.complaints_history="No past complaints.",bt.length>0?h.pharmacy_orders_history=bt.map(g=>`Order: ${g.data.medications.map(k=>{let N=`${k.name}`;return k.pack_quantity!==void 0&&k.pack_quantity>0&&(N+=` Packs: ${k.pack_quantity}`),k.loose_quantity!==void 0&&k.loose_quantity>0&&(N+=` Loose: ${k.loose_quantity}`),N}).join(", ")} (${g.data.status}, ${new Date(g.originalDateString).toLocaleDateString()})`).join("; "):h.pharmacy_orders_history="No pharmacy orders.",Ft.length>0?h.lab_orders_history=Ft.map(g=>{let k=`Lab Order: ${g.data.tests.map(N=>N.name).join(", ")} (${g.data.status}, ${new Date(g.originalDateString).toLocaleDateString()})`;return g.data.report&&(k+=` - Report: ${g.data.report.report_content} (${new Date(g.data.report.report_date).toLocaleDateString()})`),k}).join("; "):h.lab_orders_history="No lab history.",$e.length>0?h.recurring_medications=$e.map((g,f)=>{let k=`${f+1}. ${g.medicationName} (${g.frequencyDays} days, ${g.status})`;return g.tabletsPerDay&&(k+=` - ${g.tabletsPerDay} tabs/day`),g.numberOfDays&&(k+=` for ${g.numberOfDays} days`),k}).join("; "):h.recurring_medications="No recurring medications.",h},[p,Rt,bt,Ft,$e]),nc=()=>{if(!p){Hr("Patient details are required to use the Live API.");return}Jr(!0)},rc=()=>{var h;(h=er.current)==null||h.click()},ic=async h=>{var f;const g=(f=h.target.files)==null?void 0:f[0];if(g&&d){Pa(g),Aa(!0);try{const k=new FormData;k.append("files",g),(await Y(`/api/patient-files/${d}`,{method:"POST",body:k})).ok||_e("Image upload failed. Please try again.")}catch(k){console.error("Image upload error:",k),_e("Image upload failed. Please try again.")}finally{Aa(!1)}}},si=x.useRef(!1),An=x.useRef(null),cn=x.useRef(null),ct=x.useRef({response:!0,pharmacy:!1,recurring:!1,labs:!1,history:!1,summary:!1}),[Dn,un]=x.useState("response"),In=h=>{si.current=!0,un(h),An.current&&clearTimeout(An.current),An.current=setTimeout(()=>{si.current=!1},1e3);const g={behavior:"smooth",block:"start"};h==="response"&&be.current?be.current.scrollIntoView(g):h==="meds"?z.current?z.current.scrollIntoView(g):cn.current&&cn.current.scrollIntoView(g):h==="labs"&&L.current?L.current.scrollIntoView(g):h==="history"&&O.current?O.current.scrollIntoView(g):h==="summary"&&ie.current&&ie.current.scrollIntoView(g)};return x.useEffect(()=>{const h=new IntersectionObserver(g=>{si.current||(g.forEach(f=>{f.target===be.current?ct.current.response=f.isIntersecting:f.target===z.current?ct.current.pharmacy=f.isIntersecting:f.target===cn.current?ct.current.recurring=f.isIntersecting:f.target===L.current?ct.current.labs=f.isIntersecting:f.target===O.current?ct.current.history=f.isIntersecting:f.target===ie.current&&(ct.current.summary=f.isIntersecting)}),ct.current.response?un("response"):ct.current.pharmacy||ct.current.recurring?un("meds"):ct.current.labs?un("labs"):ct.current.history?un("history"):ct.current.summary&&un("summary"))},{root:null,threshold:0,rootMargin:"-10% 0px -50% 0px"});return be.current&&h.observe(be.current),z.current&&h.observe(z.current),L.current&&h.observe(L.current),O.current&&h.observe(O.current),ie.current&&h.observe(ie.current),cn.current&&h.observe(cn.current),()=>{h.disconnect(),An.current&&clearTimeout(An.current)}},[]),i.jsxs("div",{className:"edit-complaint-page",style:{height:`${jt}px`},children:[i.jsx(Hh,{ref:Sn,recordId:r,patientId:d,patientDetails:p,caseSummary:I,caseSummaryUpdatedAt:C,clinicSettings:Ae,userMessages:m,selectedImageFile:Vr,pendingLabOrders:vr,labReports:pt,pastComplaints:P,pharmacyOrders:We,pharmacyInventory:Ee,labInventory:ot,recurringMedications:$e,currentComplaint:c,setCurrentComplaint:u,setAiResponse:De,setAiResponseText:Ne,setAiResponseJsonString:Re,setShowAiJsonDetails:st,setIsLoadingAi:Yt,setAiError:()=>{},setIsSubmittingAiOrder:Wn,setAiOrderSubmissionStatus:()=>{},setIsSubmittingAiLabOrder:cl,setAiLabOrderSubmissionStatus:()=>{},setIsSubmittingAiComplaint:dl,setAiComplaintSubmissionStatus:()=>{},setIsUpdatingCaseSummary:hl,setAiCaseSummaryUpdateStatus:()=>{},setCaseSummary:W,setCaseSummaryUpdatedAt:K,setIsUpdatingAiMemoryByAI:fl,setAiMemoryUpdateByAIStatus:()=>{},setFollowUpQuestion:Qa,setFollowUpOptions:Ya,setError:_e,setIsSavingAiResponse:Ot,setSaveAiResponseError:()=>{},fetchPharmacyOrdersData:on,fetchPendingLabOrdersData:ln,fetchLabReportsData:Tn,fetchPastComplaintsData:za,fetchPatientDetails:sn,fetchRecurringMedicationsData:Pn,setClinicSettings:Gr,setEditedAiMemory:Yr,handleDeleteItem:Lt,setCanUndo:Fa,onAiActionSuccess:xe,addMessage:Wr,onPrintLabBill:h=>{wl(h),fa(!0)},onPrintPharmacyBill:Pl}),i.jsx(sg,{isOpen:xl,onClose:()=>fa(!1),billData:bl}),i.jsx(og,{isOpen:kl,onClose:()=>ga(!1),billData:_l}),Cl&&p&&i.jsx(gc,{onClose:()=>Jr(!1),patientData:tc(),tokenNumber:p.patient_token_number?String(p.patient_token_number):null,onAiSummaryChange:h=>{h&&(u(h),Wt(h),Jr(!1))}}),i.jsxs("div",{className:"edit-complaint-header",children:[i.jsx("button",{onClick:()=>a(-1),disabled:Dt,className:"back-button",title:"Go Back",children:i.jsx(yc,{size:20})}),i.jsx("span",{ref:te,style:{position:"absolute",visibility:"hidden",height:"auto",width:"auto",whiteSpace:"nowrap"}}),!p&&$t&&i.jsx("div",{className:"patient-header-details",children:i.jsxs("div",{className:"patient-info-display skeleton",children:[i.jsx(Te,{width:"120px",height:"18px"}),i.jsx(Te,{width:"60px",height:"16px"}),i.jsx(Te,{width:"80px",height:"16px"}),i.jsx(Te,{width:"90px",height:"16px"})]})}),p&&i.jsx("div",{className:"patient-header-details",children:vl?i.jsxs("div",{className:"patient-details-edit-form",children:[i.jsx("input",{type:"text",value:Ir,onChange:h=>Or(h.target.value),placeholder:"Name",className:"edit-input",disabled:Pt}),i.jsx("input",{type:"number",value:$r??"",onChange:h=>Lr(h.target.value?parseInt(h.target.value):null),placeholder:"Age",className:"edit-input age",disabled:Pt}),i.jsxs("select",{value:Rr??"",onChange:h=>Fr(h.target.value||null),className:"edit-input gender",disabled:Pt,children:[i.jsx("option",{value:"",children:"Gender"}),i.jsx("option",{value:"M",children:"M"}),i.jsx("option",{value:"F",children:"F"}),i.jsx("option",{value:"O",children:"O"})]}),i.jsx("input",{type:"text",value:zr??"",onChange:h=>qr(h.target.value||null),placeholder:"Phone",className:"edit-input phone",disabled:Pt}),i.jsxs("div",{className:"edit-form-actions",children:[i.jsx("button",{onClick:()=>{Kn(!1),Ht(null)},className:"cancel-btn",disabled:Pt,children:"Cancel"}),i.jsx("button",{onClick:Xl,className:"save-btn",disabled:Pt,children:Pt?"...":"Save"})]}),Na&&i.jsx("div",{className:"error-note",children:Na})]}):i.jsxs("div",{className:"patient-info-display",children:[i.jsx("button",{onClick:()=>{Kn(!0),Or(p.name||""),Lr(p.age),Fr(p.gender),qr(p.phone),Ht(null)},className:"patient-edit-trigger",title:"Edit Patient Details",disabled:Pt,children:i.jsx(ft,{size:14})}),i.jsxs("div",{className:"patient-ident-group",children:[i.jsx("span",{className:"patient-name",children:p.name??"N/A"}),i.jsxs("span",{className:"patient-id-badge",children:["#",p.patient_token_number??"N/A"]}),i.jsxs("span",{className:"patient-demographics",children:[p.age??"N/A"," / ",p.gender??"N/A"]}),i.jsx("div",{className:`patient-color-indicator status-color-${p.color_code||"none"}`,onClick:h=>ec(h,p.id,p.color_code),title:"Click to cycle status color"}),p.phone&&i.jsxs("span",{className:"patient-phone-display",children:["(",p.phone,")"]}),Qr!==null&&Qr>0&&i.jsxs("div",{className:"patient-debt-indicator",onClick:()=>a("/dashboard/patient-debts"),title:"Manage Debts",children:["₹",Qr.toFixed(2)]})]}),i.jsxs("div",{className:"patient-action-group",children:[i.jsxs("button",{onClick:Zr,className:"action-icon-btn indigo",title:"Dental Overview",children:[i.jsx(xc,{toothNumber:30,style:{width:"14px",height:"14px"}}),i.jsx("span",{className:"btn-label",children:"Dental"})]}),i.jsxs("button",{onClick:Al,className:"action-icon-btn indigo",title:"Medical Procedures",children:[i.jsx(bc,{size:14}),i.jsx("span",{className:"btn-label",children:"Medical"})]}),i.jsxs("button",{onClick:()=>{p&&a("/dashboard/files",{state:{patient:{id:p.id,name:p.name,token:p.patient_token_number,age:p.age,gender:p.gender,phone:p.phone}}})},className:"action-icon-btn indigo",title:"Files",children:[i.jsx(oi,{size:14}),i.jsx("span",{className:"btn-label",children:"Files"})]}),i.jsxs("button",{onClick:h=>{h.stopPropagation(),ns()},disabled:!lr,className:"action-icon-btn gray",title:"Print Summary",children:[i.jsx(Ln,{size:14}),i.jsx("span",{className:"btn-label",children:"Print"})]})]})]})}),!p&&q!==void 0&&$!==void 0&&i.jsx("div",{className:"patient-header-details",children:i.jsxs("div",{className:"patient-info-display",children:[i.jsxs("span",{className:"patient-demographics",children:[q??"N/A"," / ",$??"N/A"]}),i.jsx("button",{onClick:h=>{h.stopPropagation(),ns()},disabled:!lr,className:"action-icon-btn gray",title:"Print Summary",children:i.jsx(Ln,{size:14})})]})}),i.jsx("div",{style:{minWidth:"64px",display:"flex",justifyContent:"flex-end"},children:i.jsx("button",{onClick:e,className:"icon-button small text-gray-600 hover:text-gray-900 bg-gray-100 hover:bg-gray-200",title:"Open Command Bar (Ctrl+K)",style:{padding:"0.2rem",borderRadius:"8px"},children:i.jsx(wc,{size:24})})})]}),i.jsxs("div",{className:"edit-complaint-content-area",ref:qe,children:[Ta.length>0&&i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"edit-complaint-chat-column",style:{width:"30%",minWidth:"320px",maxWidth:"40%",flexShrink:0},children:i.jsx(lg,{messages:Ta})}),i.jsx("div",{className:"draggable-divider",onMouseDown:()=>{}})]}),i.jsxs("div",{ref:be,className:"edit-complaint-main-column",style:{flex:1,minWidth:0},children:[Fe&&i.jsxs("div",{className:"general-error-message",children:["Error: ",Fe]}),tt&&i.jsxs("div",{className:"ai-response-container",style:{padding:"16px"},children:[i.jsx(Te,{width:"100%",height:"18px",style:{marginBottom:"10px"}}),i.jsx(Te,{width:"95%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"85%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"90%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"70%",height:"16px"})]}),!tt&&(He||at)&&i.jsxs("div",{ref:je,className:`${at?"ai-function-call-block":"ai-response-container"} group`,children:[He&&i.jsx(Qt,{remarkPlugins:[kt],children:He}),at&&i.jsxs("div",{className:"ai-json-details-container",children:[i.jsxs("button",{onClick:()=>st(!et),className:"ai-json-toggle-button",children:[et?i.jsx(os,{size:14,className:"mr-1"}):i.jsx(ls,{size:14,className:"mr-1"}),et?"Hide":"Show"," AI Function Call Details"]}),et&&i.jsx("pre",{className:"ai-json-pre",children:i.jsx("code",{children:JSON.stringify(JSON.parse(at),null,2)})})]}),i.jsxs("div",{className:"ai-response-actions",children:[i.jsx("button",{onClick:()=>Vl(b),disabled:!b,title:"Copy Full AI Response",children:i.jsx(kc,{size:12})}),i.jsx("button",{onClick:Jl,disabled:!b,title:"Print AI Response",children:i.jsx(Ln,{size:12})})]})]})]}),i.jsx("div",{className:"draggable-divider",onMouseDown:Bl}),i.jsx("div",{ref:Z,className:"edit-complaint-context-column",style:{flexBasis:`calc(${100-ae}% - 5px)`},children:i.jsxs("div",{className:"ai-context-container",children:[i.jsxs("h3",{className:"ai-context-header",children:[i.jsx("span",{children:"AI Context:"}),(p==null?void 0:p.insurance_type)&&i.jsx("div",{className:"insurance-type-container mt-2",children:i.jsxs("select",{ref:ze,value:p.insurance_type,onChange:h=>El(p.id,h.target.value),className:"insurance-type-select",children:[i.jsx("option",{value:"cash",children:"Cash"}),i.jsx("option",{value:"insurance",children:"Insurance"}),i.jsx("option",{value:"no_cash_insurance",children:"No Cash Insurance"})]})})]}),J.length>0&&i.jsxs("div",{className:"ai-context-section",children:[i.jsx("div",{className:"flex justify-between items-center mb-2",children:i.jsx("h4",{className:"ai-context-section-title mb-0",children:"Dental Overview"})}),i.jsx("div",{onClick:Zr,style:{cursor:"pointer",transform:"scale(0.8)",transformOrigin:"top left",width:"125%",height:"350px",overflow:"hidden",pointerEvents:"auto"},title:"Click to open full Dental Page",children:i.jsx(_c,{selectedTeeth:[],onToothClick:()=>Zr(),toothConditions:ar,toothDetails:sr,numberingSystem:localStorage.getItem("dentalNumberingSystem")||"universal"})})]}),i.jsxs("div",{ref:D,className:"ai-context-section",children:[i.jsx("h4",{className:"ai-context-section-title",children:"Admission Status"}),$t?i.jsxs("div",{className:"space-y-2",children:[i.jsx(Te,{width:"60%",height:"1.2em"}),i.jsx(Te,{width:"50%",height:"1.2em"}),i.jsx(Te,{width:"40%",height:"1.2em"}),i.jsxs("div",{className:"flex space-x-2 mt-2",children:[i.jsx(Te,{width:"80px",height:"30px"}),i.jsx(Te,{width:"100px",height:"30px"})]})]}):i.jsxs(i.Fragment,{children:[(p==null?void 0:p.admission_date)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Admitted:"})," ",new Date(p.admission_date).toLocaleDateString()]}),(p==null?void 0:p.discharge_date)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Discharged:"})," ",new Date(p.discharge_date).toLocaleDateString()]}),(p==null?void 0:p.current_status)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Current Status:"})," ",i.jsx("span",{className:"font-semibold",children:p.current_status})]}),i.jsxs("div",{className:"flex space-x-2 mt-2",children:[i.jsx("button",{onClick:Yl,className:`admit-discharge-button ${Yn?"discharge":"admit"}`,title:Yn?"Discharge Patient":"Admit Patient",disabled:!d||Tr||Pr,children:Tr?"Admitting...":Pr?"Discharging...":Yn?"Discharge":"Admit"}),i.jsxs("button",{onClick:()=>a(`/patient/${encodeURIComponent(d??"")}/admission-billing`),className:"queue-status-button",style:{backgroundColor:"#e0f2fe",color:"#0369a1",border:"1px solid #bae6fd",display:"flex",alignItems:"center",gap:"4px"},title:"Go to Admission Billing",disabled:!d,children:[i.jsx(as,{size:14})," Billing"]}),i.jsx("button",{onClick:()=>Kl("doctor"),className:`queue-status-button ${Gn?"in-queue":"add-to-queue"}`,title:Gn?"Patient is in Doctor Queue":"Add Patient to Doctor Queue",disabled:!d||Er||Gn,children:Er?"Adding...":Gn?"In Queue":"Add to Queue"}),i.jsx("button",{onClick:Zl,className:"complete-consultation-button",title:"Mark Consultation as Complete",disabled:Ar,children:Ar?"Completing...":"Complete Consultation"})]})]})]}),i.jsx("div",{ref:z,children:i.jsx(bi,{title:"Pharmacy Order History",headerAction:zl,items:bt,isLoading:A||$t,loadingText:"Loading...",noDataText:"No orders.",renderItemContent:Ll})}),i.jsxs("div",{ref:cn,className:"ai-context-section mt-4",children:[i.jsxs("div",{className:"flex justify-between items-center mb-2",children:[i.jsx("h4",{className:"ai-context-section-title mb-0",children:"Recurring Medications"}),i.jsxs("button",{onClick:()=>{wn([]),Jn(!0)},className:"text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded flex items-center gap-1",children:[i.jsx(fr,{size:12})," Add"]})]}),$e.length>0?i.jsx("div",{className:"overflow-x-auto",children:i.jsxs("table",{className:"w-full text-xs text-left",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b",children:[i.jsx("th",{className:"py-1 px-2",children:"#"}),i.jsx("th",{className:"py-1 px-2",children:"Medication"}),i.jsx("th",{className:"py-1 px-2",children:"Qty"}),i.jsx("th",{className:"py-1 px-2",children:"Frequency"}),i.jsx("th",{className:"py-1 px-2",children:"Next Delivery"}),i.jsx("th",{className:"py-1 px-2",children:"Status"}),i.jsx("th",{className:"py-1 px-2"})]})}),i.jsx("tbody",{children:$e.map((h,g)=>i.jsxs("tr",{className:"border-b last:border-0 hover:bg-gray-50",children:[i.jsx("td",{className:"py-1 px-2 font-medium text-gray-500",children:g+1}),i.jsxs("td",{className:"py-1 px-2 font-medium",children:[h.medicationName,i.jsxs("div",{className:"text-[10px] text-gray-500 font-normal",children:[h.tabletsPerDay?`${h.tabletsPerDay} tabs/day`:"",h.tabletsPerDay&&h.numberOfDays?" • ":"",h.numberOfDays?`${h.numberOfDays} days`:"",h.directions?` • ${h.directions}`:""]})]}),i.jsx("td",{className:"py-1 px-2",children:h.quantity}),i.jsxs("td",{className:"py-1 px-2",children:[h.frequencyDays," days"]}),i.jsx("td",{className:"py-1 px-2",children:new Date(h.nextDeliveryDate).toLocaleDateString()}),i.jsx("td",{className:"py-1 px-2",children:i.jsx("span",{className:`px-1.5 py-0.5 rounded-full text-[10px] ${h.status==="active"?"bg-green-100 text-green-800":h.status==="paused"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:h.status})}),i.jsx("td",{className:"py-1 px-2 text-right",children:i.jsx("button",{onClick:()=>{Qn(h),Cr(!0)},className:"text-gray-400 hover:text-blue-600 p-1",title:"Edit",children:i.jsx(ft,{size:12})})})]},h.id))})]})}):A||$t?i.jsx("div",{style:{marginTop:"8px"},children:[1,2,3].map(h=>i.jsxs("div",{style:{display:"flex",gap:"12px",marginBottom:"10px"},children:[i.jsx(Te,{width:"30px",height:"14px"}),i.jsx(Te,{width:"120px",height:"14px"}),i.jsx(Te,{width:"40px",height:"14px"}),i.jsx(Te,{width:"60px",height:"14px"}),i.jsx(Te,{width:"80px",height:"14px"})]},h))}):i.jsx("p",{className:"text-gray-500 text-sm italic",children:"No recurring medications."})]}),la&&i.jsx(rg,{isOpen:la,onClose:()=>ca(!1),patientId:d,pharmacyInventory:Ee,fetchPharmacyOrdersData:on,isLoadingInventory:lt}),i.jsxs("div",{ref:L,children:[i.jsx(bi,{title:"Lab History (Orders & Reports)",headerAction:ql,items:Ft,onDeleteItem:void 0,onEditLabOrder:void 0,onSaveLabOrder:$l,onCancelEditLabOrder:Dl,onLabOrderTestChange:Il,onLabOrderStatusChange:Ol,onBillLabOrder:void 0,onUpdateLabOrderStatus:void 0,onEnterLabReport:void 0,labInventory:ot,isSavingLabOrder:ht,isLoading:xn||Je||$t,loadingText:"Loading...",noDataText:"No lab Hx.",expandedLabReports:bn,toggleLabReport:ii,renderItemContent:Rl}),i.jsx(Fh,{isOpen:yl,onClose:()=>oa(!1),patientId:d,labInventory:ot,fetchPendingLabOrdersData:ln,isLoadingInventory:lt}),i.jsx("div",{ref:O,children:i.jsx(bi,{title:"Complaints History",items:Rt,isLoading:ee||$t,loadingText:"Loading...",noDataText:"No past Hx.",renderItemContent:Fl,onDeleteItem:Lt})}),i.jsxs("div",{className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsxs("h4",{className:"ai-context-section-title",children:[i.jsx(Nc,{size:16,className:"text-purple-600"})," Clinic-wide System Prompt"]}),!Kr&&i.jsx("button",{onClick:ts,className:"edit-button",title:"Edit System Prompt",disabled:Oa||rn||an,children:i.jsx(ft,{size:14})})]}),Kr&&Ae?i.jsxs("div",{className:"mt-2",children:[i.jsx("textarea",{value:jn,onChange:h=>Cn(h.target.value),className:"context-edit-textarea",placeholder:"Enter clinic system prompt...",disabled:rn||an}),i.jsxs("div",{className:"context-edit-actions",children:[i.jsx("button",{onClick:Wl,disabled:rn||an,className:"button-secondary",children:"Cancel"}),i.jsxs("button",{onClick:Hl,disabled:rn||an||rr===Ae.aiMemory&&jn===Ae.clinicWideSystemPrompt,className:"button-primary purple",children:[i.jsx(Ys,{size:14,className:"mr-1"}),an||rn?"Saving...":"Save Settings"]})]})]}):i.jsx("div",{className:"ai-context-text whitespace-pre-wrap mt-1 prose prose-sm max-w-none cursor-pointer hover:bg-gray-50 rounded p-1 -m-1 transition-colors",onClick:ts,title:"Click to edit system prompt",children:Oa?i.jsxs("div",{style:{marginTop:"4px"},children:[i.jsx(Te,{width:"100%",height:"14px",style:{marginBottom:"6px"}}),i.jsx(Te,{width:"90%",height:"14px",style:{marginBottom:"6px"}}),i.jsx(Te,{width:"70%",height:"14px"})]}):Ae!=null&&Ae.clinicWideSystemPrompt?i.jsx(Qt,{remarkPlugins:[kt],children:Ae.clinicWideSystemPrompt}):i.jsx("span",{className:"italic text-gray-400",children:"N/A - Click to add."})}),!Kr&&(Ae==null?void 0:Ae.clinicWideSystemPromptUpdatedAt)&&i.jsxs("p",{className:"ai-context-text text-gray-400 mt-1",style:{fontSize:"0.625rem"},children:["Prompt Last Updated: ",new Date(Ae.clinicWideSystemPromptUpdatedAt).toLocaleDateString()]})]}),i.jsxs("div",{ref:ie,className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsx("h4",{className:"ai-context-section-title",children:"Case Summary"}),!F&&i.jsx("button",{onClick:es,className:"edit-button",title:"Edit Case Summary",disabled:A||ne,children:i.jsx(ft,{size:14})})]}),F?i.jsxs("div",{className:"mt-2",children:[i.jsx("textarea",{value:X,onChange:h=>ce(h.target.value),className:"context-edit-textarea",rows:4,placeholder:"Enter case summary...",disabled:ne}),V&&i.jsx("p",{className:"text-red-500 text-xs mt-1",children:V}),i.jsxs("div",{className:"context-edit-actions",children:[i.jsx("button",{onClick:Ul,disabled:ne,className:"button-secondary",children:"Cancel"}),i.jsx("button",{onClick:Ml,disabled:ne||X===I,className:"button-primary blue",children:ne?"Saving...":"Save"})]})]}):i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"ai-context-text whitespace-pre-wrap mt-1 prose prose-sm max-w-none cursor-pointer hover:bg-gray-50 rounded p-1 -m-1 transition-colors",onClick:es,title:"Click to edit case summary",children:A?i.jsxs("div",{style:{marginTop:"8px"},children:[i.jsx(Te,{width:"100%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"85%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"65%",height:"16px"})]}):I?i.jsx(Qt,{remarkPlugins:[kt],components:{},children:I}):i.jsx("span",{className:"italic text-gray-400",children:"N/A - Click to add."})}),C&&i.jsxs("p",{className:"ai-context-text text-gray-400 mt-1",style:{fontSize:"0.625rem"},children:["Last Edited: ",new Date(C).toLocaleDateString()]})]})]}),Rt.length===0&&Ft.length===0&&bt.length===0&&!(ee||xn||Je)&&i.jsx("p",{className:"ai-context-text italic mt-4",children:"No recent history for this patient."}),Vn&&i.jsx("p",{className:"text-yellow-600 text-xs mt-2 ai-context-text",children:"Deleting..."}),aa&&i.jsx("p",{className:"text-red-600 text-xs mt-2 ai-context-text",children:aa})]})]})})]}),i.jsxs("div",{className:"edit-complaint-input-area",children:[i.jsxs("div",{className:"status-messages-container",children:[Mt&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:Mt}),Le&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:Le}),ra&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:ra}),Xt&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:Xt})]}),r&&!me&&i.jsxs(x.Fragment,{children:[Ja&&i.jsxs("div",{className:"follow-up-question-container",children:[i.jsx("p",{className:"question-text",children:Ja}),Ga.length>0&&i.jsx("div",{className:"options-grid",children:Ga.map((h,g)=>i.jsx("button",{onClick:()=>Ql(h),className:"option-button",children:h},g))})]}),Sa&&i.jsx("div",{className:"speech-error-display",children:Sa}),Ea&&i.jsx("div",{className:"selected-file-display",children:i.jsx("span",{children:"Uploading image..."})}),Vr&&!Ea&&i.jsxs("div",{className:"selected-file-display",children:[i.jsxs("span",{children:["Selected: ",Vr.name]}),i.jsx("button",{onClick:()=>{Pa(null),er.current&&(er.current.value="")},className:"remove-file-button",title:"Remove image",children:"×"})]}),i.jsxs("div",{className:"input-section-selector",children:[i.jsx("button",{onClick:()=>In("response"),className:`selector-button ${Dn==="response"?"active":""}`,children:"AI"}),i.jsx("button",{onClick:()=>In("meds"),className:`selector-button ${Dn==="meds"?"active":""}`,children:"Meds"}),i.jsx("button",{onClick:()=>In("labs"),className:`selector-button ${Dn==="labs"?"active":""}`,children:"Labs"}),i.jsx("button",{onClick:()=>In("history"),className:`selector-button ${Dn==="history"?"active":""}`,children:"Hx"}),i.jsx("button",{onClick:()=>In("summary"),className:`selector-button ${Dn==="summary"?"active":""}`,children:"Sum"})]}),i.jsx("div",{className:"input-wrapper",children:i.jsxs("div",{className:"main-input-container",children:[i.jsx("input",{type:"file",ref:er,onChange:ic,accept:"image/*",className:"hidden"}),i.jsx("textarea",{ref:Ve,className:"complaint-textarea",value:c,onChange:h=>u(h.target.value),onKeyDown:Gl,placeholder:"Name, Age, Sex... Chat with Patient Manager AI",disabled:Dt||!r||vn}),i.jsxs("div",{className:"chat-input-actions-container",children:[i.jsx("button",{type:"button",onClick:rc,disabled:Dt||!r||vn,className:"icon-button",title:"Attach Image",children:i.jsx(vc,{size:14})}),i.jsx("button",{type:"button",onClick:nc,disabled:Dt||!r||!Xn.current,className:`mic-button ${vn?"listening":""}`,title:vn?"Stop":"Mic",children:i.jsx(jc,{size:14})}),i.jsx("button",{onClick:()=>Wt(),disabled:Dt||!c.trim()||!r||vn,className:"send-button",title:Dt?"Processing...":"Save & Ask AI",children:Dt?i.jsx("div",{className:"custom-loader-circle",role:"status","aria-label":"loading"}):i.jsx(Cc,{size:14})}),Sl&&i.jsx("button",{type:"button",onClick:Tl,disabled:Dt,className:"icon-button text-red-500",title:"Undo Last AI Actions",children:i.jsx(gt,{size:14})})]})]})})]})]}),pa&&d&&i.jsx(ig,{isOpen:pa,onClose:()=>Jn(!1),onSuccess:()=>{d&&Pn(d),Jn(!1),wn([])},patientId:d,initialItems:ma}),ha&&Sr&&i.jsx(ag,{isOpen:ha,onClose:()=>Cr(!1),onSuccess:()=>{d&&Pn(d),Cr(!1),Qn(void 0)},medication:Sr}),ua&&i.jsx(Sc,{isOpen:ua,onClose:()=>{da(!1),Qn(void 0),wn([])},onSuccess:()=>{d&&Pn(d),da(!1),Qn(void 0),wn([])},initialItems:ma,medication:Sr,initialPatient:p?{id:p.id,name:p.name,phone:p.phone||"",patient_token_number:String(p.patient_token_number||"")}:void 0})]})};export{pg as default};
