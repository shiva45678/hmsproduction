import{j as e,N as fe,f as $,S as je}from"./index-DE8wu5Ou.js";import{r as h,b as ye,u as ge}from"./react-vendor-Cc0P4_ZX.js";import{f as _e}from"./fuzzyMatch-BaTsC35g.js";import{X as Z,a5 as R,a0 as L,aa as ke,W as Ne,E as ve,i as we,a7 as De,z as Ce,aL as Fe,v as Ie,aM as Se}from"./ui-vendor-SmiJk_kJ.js";/* empty css                */import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const Pe=({isOpen:v,onClose:m,excelHeaders:k,onConfirm:l,availableFields:a})=>{const[g,x]=h.useState({});if(h.useEffect(()=>{v&&r()},[v,k,a]),!v)return null;const s=(d,p)=>{x(u=>({...u,[d]:p}))},r=()=>{const d={};k.forEach(p=>{const u=a.map(S=>({name:S})),w=_e(p,u);w&&(d[p]=w.name)}),x(d)},t=()=>{const d={};for(const p in g)g[p]&&g[p]!=="none"&&(d[p]=g[p]);l(d),m()};return e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal-content",children:[e.jsx("button",{onClick:m,className:"modal-close-button",children:e.jsx(Z,{size:20})}),e.jsx("h3",{className:"modal-title",children:"Match File Columns"}),e.jsx("p",{className:"modal-description",children:'Please match the columns from your uploaded file to the corresponding fields in the drug inventory. You can use the "Auto Match" button for suggestions.'}),e.jsx("div",{className:"modal-actions-top",children:e.jsx("button",{type:"button",onClick:r,className:"button-auto-match",children:"Auto Match"})}),e.jsxs("div",{className:"column-mapping-grid",children:[e.jsx("div",{className:"grid-header",children:"Excel Column"}),e.jsx("div",{className:"grid-header",children:"App Field"}),k.map((d,p)=>e.jsxs(ye.Fragment,{children:[e.jsx("div",{className:"excel-header-cell",children:d}),e.jsx("div",{className:"app-field-cell",children:e.jsxs("select",{value:g[d]||"",onChange:u=>s(d,u.target.value),className:"app-field-select",children:[e.jsx("option",{value:"",children:"-- Select Field --"}),e.jsx("option",{value:"none",children:"None (Ignore Column)"}),a.map((u,w)=>e.jsxs("option",{value:u,children:[u==="name"?"Composition Name":u==="brand_name"?"Brand Name":u==="price"?"MRP":u==="buying_price"?"Rate":u==="unit"?"Pack":u==="batch"?"Batch":u==="hsn_code"?"HSN Code":u==="mfg"?"MFG":u==="loose_quantity"?"Loose":u.replace(/_/g," ").replace(/\b\w/g,S=>S.toUpperCase())," "]},w))]})})]},p))]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",onClick:m,className:"button-cancel",children:"Cancel"}),e.jsx("button",{type:"button",onClick:t,className:"button-submit",children:"Confirm Mapping"})]})]})})},$e=({entityType:v,config:m,values:k,onChange:l,className:a=""})=>{const x=(m[v]||[]).filter(r=>r.type!=="computed");if(x.length===0)return null;const s=r=>{const t=k[r.key]??"";switch(r.type){case"number":return e.jsx("input",{type:"number",id:`custom_${r.key}`,name:`custom_${r.key}`,value:t,onChange:d=>l(r.key,d.target.value===""?null:parseFloat(d.target.value)),className:"custom-text-input mt-1",placeholder:r.label,required:r.required});case"date":return e.jsx("input",{type:"date",id:`custom_${r.key}`,name:`custom_${r.key}`,value:t,onChange:d=>l(r.key,d.target.value||null),className:"custom-text-input mt-1",required:r.required});case"boolean":return e.jsx("input",{type:"checkbox",id:`custom_${r.key}`,name:`custom_${r.key}`,checked:!!t,onChange:d=>l(r.key,d.target.checked),className:"custom-checkbox mt-1"});case"text":default:return e.jsx("input",{type:"text",id:`custom_${r.key}`,name:`custom_${r.key}`,value:t,onChange:d=>l(r.key,d.target.value||null),className:"custom-text-input mt-1",placeholder:r.label,required:r.required})}};return e.jsxs("div",{className:`custom-fields-section ${a}`,children:[e.jsx("h4",{className:"custom-fields-title",children:"Custom Fields"}),e.jsx("div",{className:"custom-fields-grid",children:x.map(r=>e.jsxs("div",{className:"custom-field-item",children:[e.jsxs("label",{htmlFor:`custom_${r.key}`,className:"form-label",children:[r.label,r.required&&e.jsx("span",{className:"required-star",children:"*"})]}),s(r)]},r.key))})]})},Te=({isOpen:v,onClose:m,onDrugAddedToPurchase:k,customColumnsConfig:l={}})=>{const[a,g]=h.useState({name:"",composition:"",description:"",mrp:0,stock:0,pack:"",expiry_date:"",rate:null,box_number:"",gst:5,margin:null,discount:null,brand_name:"",batch:"",hsn_code:"",mfg:"",loose:null,custom_fields:{}}),[x,s]=h.useState(null),[r,t]=h.useState(!1),[d,p]=h.useState(!1),u=h.useRef(null),w=h.useRef(null),S=h.useRef(null);h.useEffect(()=>{v&&(g({name:"",composition:"",description:"",mrp:0,stock:0,pack:"",expiry_date:"",rate:null,box_number:"",gst:5,margin:null,discount:null,brand_name:"",batch:"",hsn_code:"",mfg:"",loose:null,custom_fields:{}}),s(null),t(!1),p(!1))},[v]),h.useEffect(()=>{const D=I=>{I.key==="Tab"&&w.current===document.activeElement&&(d||(p(!0),setTimeout(()=>{var P;(P=S.current)==null||P.focus()},0),I.preventDefault()))},C=I=>{u.current&&!u.current.contains(I.target)&&p(!1)};return document.addEventListener("keydown",D),document.addEventListener("mousedown",C),()=>{document.removeEventListener("keydown",D),document.removeEventListener("mousedown",C)}},[d]);const f=D=>{const{name:C,value:I,type:P}=D.target;g(B=>({...B,[C]:P==="number"?parseFloat(I)||null:I}))},T=(D,C)=>{g(I=>({...I,custom_fields:{...I.custom_fields,[D]:C}}))},O=D=>{if(D.preventDefault(),s(null),t(!0),a.mrp===void 0||a.stock===void 0){s("MRP and Stock Quantity are required."),t(!1);return}const C={...a,name:a.name===""?null:a.name,composition:a.composition===""?null:a.composition,rate:a.rate===0?null:a.rate,expiry_date:a.expiry_date===""?null:a.expiry_date,gst:a.gst===0?null:a.gst,margin:a.margin===0?null:a.margin,discount:a.discount===0?null:a.discount,brand_name:a.brand_name===""?null:a.brand_name,batch:a.batch===""?null:a.batch,hsn_code:a.hsn_code===""?null:a.hsn_code,mfg:a.mfg===""?null:a.mfg,loose:a.loose===0?null:a.loose,custom_fields:a.custom_fields||{}};k(C),t(!1),m()};return v?e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal-content add-drug-form-container max-w-2xl mx-auto",children:[e.jsxs("div",{className:"add-drug-form-header",children:[e.jsx("h2",{children:"Add New Drug"}),e.jsx("button",{onClick:m,className:"cancel-button",title:"Close",children:e.jsx(Z,{size:24})})]}),x&&e.jsx("div",{className:"error-message",children:x}),e.jsxs("form",{onSubmit:O,className:"add-drug-form",children:[e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"sm-col-span-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("label",{htmlFor:"name",className:"form-label",children:"Composition Name"}),e.jsxs("div",{className:"relative ml-2 group",children:[e.jsx(R,{size:16,className:"text-gray-400"}),e.jsx("div",{className:"tooltip",children:"Enter the drug's composition. This field is optional."})]})]}),e.jsx("input",{type:"text",name:"name",id:"name",value:a.name||"",onChange:f,className:"custom-text-input mt-1",placeholder:"e.g., Paracetamol",tabIndex:1})]}),e.jsxs("div",{className:"sm-col-span-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("label",{htmlFor:"brand_name",className:"form-label",children:"Brand Name"}),e.jsxs("div",{className:"relative ml-2 group",children:[e.jsx(R,{size:16,className:"text-gray-400"}),e.jsx("div",{className:"tooltip",children:"Enter the drug's brand name. This field is optional."})]})]}),e.jsx("input",{type:"text",name:"brand_name",id:"brand_name",value:a.brand_name||"",onChange:f,className:"custom-text-input mt-1",placeholder:"e.g., Calpol",tabIndex:2})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("label",{htmlFor:"mrp",className:"form-label",children:"MRP (₹) *"}),e.jsxs("div",{className:"relative ml-2 group",children:[e.jsx(R,{size:16,className:"text-gray-400"}),e.jsx("div",{className:"tooltip",children:"Enter the price for the pack size mentioned above. For example, if the pack is 10 tablets, enter the price for all 10 tablets."})]})]}),e.jsx("input",{type:"number",name:"mrp",id:"mrp",required:!0,step:"0.01",min:"0",value:a.mrp||"",onChange:f,className:"custom-text-input mt-1",placeholder:"e.g., 500",tabIndex:3})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("label",{htmlFor:"stock",className:"form-label",children:"Stock Quantity *"}),e.jsxs("div",{className:"relative ml-2 group",children:[e.jsx(R,{size:16,className:"text-gray-400"}),e.jsx("div",{className:"tooltip",children:"Enter the number of packs you have in stock. For example, if you have 5 strips of 10 tablets each, enter 5."})]})]}),e.jsx("input",{type:"number",name:"stock",id:"stock",required:!0,step:"1",min:"0",value:a.stock||"",onChange:f,className:"custom-text-input mt-1",placeholder:"e.g., 5",tabIndex:4})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"pack",className:"form-label",children:"Pack (e.g., strip, bottle)"}),e.jsx("input",{type:"text",name:"pack",id:"pack",value:a.pack||"",onChange:f,className:"custom-text-input mt-1",placeholder:"e.g., strip, bottle",tabIndex:5})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"expiry_date",className:"form-label",children:"Expiry Date"}),e.jsx("input",{type:"date",name:"expiry_date",id:"expiry_date",value:a.expiry_date||"",onChange:f,className:"custom-text-input mt-1",tabIndex:6})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"box_number",className:"form-label",children:"Box Number"}),e.jsx("input",{type:"text",name:"box_number",id:"box_number",value:a.box_number||"",onChange:f,className:"custom-text-input mt-1",tabIndex:7})]}),e.jsxs("div",{className:"relative sm-col-span-2",ref:u,children:[e.jsx("button",{type:"button",onClick:()=>p(!d),className:"form-button w-full text-left",tabIndex:8,ref:w,children:"Others"}),d&&e.jsxs("div",{className:"others-fields-grid",children:[" ",e.jsxs("div",{className:"sm-col-span-2",children:[e.jsx("label",{htmlFor:"description",className:"form-label",children:"Description"}),e.jsx("textarea",{name:"description",id:"description",rows:3,value:a.description||"",onChange:f,className:"custom-text-input mt-1",tabIndex:9})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"rate",className:"form-label",children:"Rate (₹)"}),e.jsx("input",{type:"number",name:"rate",id:"rate",step:"0.01",min:"0",value:a.rate??"",onChange:f,placeholder:"Optional",className:"custom-text-input mt-1",tabIndex:10,ref:S})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"gst",className:"form-label",children:"GST (%)"}),e.jsx("input",{type:"number",name:"gst",id:"gst",step:"0.01",min:"0",max:"100",value:a.gst??"",onChange:f,placeholder:"Optional",className:"custom-text-input mt-1",tabIndex:11})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"margin",className:"form-label",children:"Margin (%)"}),e.jsx("input",{type:"number",name:"margin",id:"margin",step:"0.01",min:"0",max:"100",value:a.margin??"",onChange:f,placeholder:"Optional",className:"custom-text-input mt-1",tabIndex:12})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"discount",className:"form-label",children:"Discount (%)"}),e.jsx("input",{type:"number",name:"discount",id:"discount",step:"0.01",min:"0",max:"100",value:a.discount??"",onChange:f,placeholder:"Optional",className:"custom-text-input mt-1",tabIndex:13})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"batch",className:"form-label",children:"Batch"}),e.jsx("input",{type:"text",name:"batch",id:"batch",value:a.batch||"",onChange:f,className:"custom-text-input mt-1",placeholder:"Optional",tabIndex:14})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"hsn_code",className:"form-label",children:"HSN Code"}),e.jsx("input",{type:"text",name:"hsn_code",id:"hsn_code",value:a.hsn_code||"",onChange:f,className:"custom-text-input mt-1",placeholder:"Optional",tabIndex:15})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"mfg",className:"form-label",children:"MFG"}),e.jsx("input",{type:"text",name:"mfg",id:"mfg",value:a.mfg||"",onChange:f,className:"custom-text-input mt-1",placeholder:"Optional",tabIndex:16})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"loose",className:"form-label",children:"Loose Quantity"}),e.jsx("input",{type:"number",name:"loose",id:"loose",step:"1",min:"0",value:a.loose??"",onChange:f,placeholder:"Optional",className:"custom-text-input mt-1",tabIndex:17})]})]})]})]}),e.jsx($e,{entityType:"drugs",config:l,values:a.custom_fields||{},onChange:T}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",onClick:m,disabled:r,className:"form-button cancel-form-button",tabIndex:18,children:"Cancel"}),e.jsx("button",{type:"submit",disabled:r,className:"form-button submit-form-button inline-flex justify-center",tabIndex:19,children:r?"Adding...":"Add Drug"})]})]})]})}):null},Ee=({purchaseRows:v,onCellChange:m,onRemoveDrug:k,onAddEmptyRow:l})=>{const a=h.useRef(new Map),g=["name","mrp","stock","pack","expiry_date","rate","brand_name","box_number","gst","discount","batch","hsn_code","mfg","loose"],x=(s,r,t)=>{if(s.key==="Tab"){s.preventDefault();const d=g.indexOf(t);if(d!==-1){const p=(d+1)%g.length,u=g[p],w=a.current.get(`${r}-${u}`);w==null||w.focus()}}};return v.length===0?e.jsxs("div",{className:"no-drugs-message",children:[e.jsx("p",{children:"No drugs added to the purchase list yet."}),e.jsxs("button",{onClick:l,className:"action-button add-drug-to-table-button",children:[e.jsx(L,{size:18,className:"button-icon"}),"Add the first drug"]})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"purchase-drugs-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Composition Name"}),e.jsx("th",{children:"MRP (₹)"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Pack"}),e.jsx("th",{children:"Supplier"}),e.jsx("th",{children:"Expiry Date"}),e.jsx("th",{children:"Rate (₹)"}),e.jsx("th",{children:"Brand Name"}),e.jsx("th",{children:"Box Number"}),e.jsx("th",{children:"GST (%)"}),e.jsx("th",{children:"Discount (%)"}),e.jsx("th",{children:"Margin (%)"}),e.jsx("th",{children:"Batch"}),e.jsx("th",{children:"HSN Code"}),e.jsx("th",{children:"MFG"}),e.jsx("th",{children:"Loose"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:v.map((s,r)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("input",{type:"text",value:s.name||"",onChange:t=>m(t,s.id,"name"),onKeyDown:t=>x(t,s.id,"name"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-name`,t)}})}),e.jsx("td",{children:e.jsx("input",{type:"number",value:s.mrp||"",onChange:t=>m(t,s.id,"mrp"),onKeyDown:t=>x(t,s.id,"mrp"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-mrp`,t)}})}),e.jsx("td",{children:e.jsx("input",{type:"number",value:s.stock||"",onChange:t=>m(t,s.id,"stock"),onKeyDown:t=>x(t,s.id,"stock"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-stock`,t)}})}),e.jsx("td",{children:e.jsx("input",{type:"text",value:s.pack||"",onChange:t=>m(t,s.id,"pack"),onKeyDown:t=>x(t,s.id,"pack"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-pack`,t)}})}),e.jsx("td",{children:s.supplier||"N/A"}),e.jsx("td",{children:e.jsx("input",{type:"date",value:s.expiry_date||"",onChange:t=>m(t,s.id,"expiry_date"),onKeyDown:t=>x(t,s.id,"expiry_date"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-expiry_date`,t)}})}),e.jsx("td",{children:e.jsx("input",{type:"number",value:s.rate||"",onChange:t=>m(t,s.id,"rate"),onKeyDown:t=>x(t,s.id,"rate"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-rate`,t)}})}),e.jsx("td",{children:e.jsx("input",{type:"text",value:s.brand_name||"",onChange:t=>m(t,s.id,"brand_name"),onKeyDown:t=>x(t,s.id,"brand_name"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-brand_name`,t)}})}),e.jsx("td",{children:e.jsx("input",{type:"text",value:s.box_number||"",onChange:t=>m(t,s.id,"box_number"),onKeyDown:t=>x(t,s.id,"box_number"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-box_number`,t)}})}),e.jsx("td",{children:e.jsx("input",{type:"number",value:s.gst||"",onChange:t=>m(t,s.id,"gst"),onKeyDown:t=>x(t,s.id,"gst"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-gst`,t)}})}),e.jsx("td",{children:e.jsx("input",{type:"number",value:s.discount||"",onChange:t=>m(t,s.id,"discount"),onKeyDown:t=>x(t,s.id,"discount"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-discount`,t)}})}),e.jsx("td",{children:(()=>{const t=s.mrp||0,d=s.rate||0,p=s.gst!==null&&s.gst!==void 0?s.gst/100*d:0,u=s.discount!==null&&s.discount!==void 0?s.discount/100*t:0,w=t-(d+p)-u;return`${(t>0?w/t*100:0).toFixed(2)}%`})()}),e.jsx("td",{children:e.jsx("input",{type:"text",value:s.batch||"",onChange:t=>m(t,s.id,"batch"),onKeyDown:t=>x(t,s.id,"batch"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-batch`,t)}})}),e.jsx("td",{children:e.jsx("input",{type:"text",value:s.hsn_code||"",onChange:t=>m(t,s.id,"hsn_code"),onKeyDown:t=>x(t,s.id,"hsn_code"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-hsn_code`,t)}})}),e.jsx("td",{children:e.jsx("input",{type:"text",value:s.mfg||"",onChange:t=>m(t,s.id,"mfg"),onKeyDown:t=>x(t,s.id,"mfg"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-mfg`,t)}})}),e.jsx("td",{children:e.jsx("input",{type:"number",value:s.loose||"",onChange:t=>m(t,s.id,"loose"),onKeyDown:t=>x(t,s.id,"loose"),className:"editable-cell-input",ref:t=>{s.id&&a.current.set(`${s.id}-loose`,t)}})}),e.jsx("td",{children:e.jsx("button",{onClick:()=>k(s.id),className:"delete-button",title:"Remove Item",children:e.jsx(ke,{size:16})})})]},s.id||r))})]})})},Ae="_container_7ak2k_7",Me="_header_7ak2k_207",Re="_backButton_7ak2k_221",Oe="_title_7ak2k_265",Be="_stickyActionBar_7ak2k_287",ze="_actionRow_7ak2k_317",Le="_inputWrapper_7ak2k_335",Ke="_inputIcon_7ak2k_345",qe="_input_7ak2k_335",Ge="_quickDistributors_7ak2k_401",Ve="_distributorChip_7ak2k_417",We="_distributorChipIcon_7ak2k_463",He="_selectedInfo_7ak2k_473",Qe="_resultsDropdown_7ak2k_503",Ue="_resultItem_7ak2k_537",Je="_buttonGroup_7ak2k_565",Xe="_button_7ak2k_565",Ye="_buttonPrimary_7ak2k_609",Ze="_buttonSecondary_7ak2k_631",et="_buttonAccent_7ak2k_653",tt="_buttonDisabled_7ak2k_675",st="_tableSection_7ak2k_691",at="_cardTitle_7ak2k_707",nt="_cardIcon_7ak2k_727",it="_footer_7ak2k_947",ot="_totalValue_7ak2k_981",rt="_footerControls_7ak2k_1005",lt="_paidInputGroup_7ak2k_1017",ct="_paidLabel_7ak2k_1029",dt="_paidInput_7ak2k_1017",ut="_errorMsg_7ak2k_1075",o={container:Ae,header:Me,backButton:Re,title:Oe,stickyActionBar:Be,actionRow:ze,inputWrapper:Le,inputIcon:Ke,input:qe,quickDistributors:Ge,distributorChip:Ve,distributorChipIcon:We,selectedInfo:He,resultsDropdown:Qe,resultItem:Ue,buttonGroup:Je,button:Xe,buttonPrimary:Ye,buttonSecondary:Ze,buttonAccent:et,buttonDisabled:tt,tableSection:st,cardTitle:at,cardIcon:nt,footer:it,totalValue:ot,footerControls:rt,paidInputGroup:lt,paidLabel:ct,paidInput:dt,errorMsg:ut},_t=()=>{const v=ge(),{purchaseRows:m,setPurchaseRows:k,selectedDistributor:l,setSelectedDistributor:a,searchTerm:g,setSearchTerm:x,amountPaidToDistributor:s,setAmountPaidToDistributor:r,distributors:t,setDistributors:d}=fe(),[p,u]=h.useState(!1),[w,S]=h.useState(!0),f=h.useRef(null),T=h.useRef(null),[O,D]=h.useState(!1),C=h.useRef(null),[I,P]=h.useState(!1),[B,z]=h.useState([]),[K,E]=h.useState(null),[q,N]=h.useState(null),[G,V]=h.useState(!1),[W,ee]=h.useState([]),te=["name","description","mrp","stock","pack","supplier","expiry_date","rate","box_number","gst","margin","discount","brand_name","batch","hsn_code","mfg","loose"];h.useEffect(()=>{(async()=>{S(!0);try{const i=await $("/api/distributors?limit=4");if(i.ok){const c=await i.json();ee(Array.isArray(c)?c.slice(0,4):[])}}catch(i){console.error("Failed to fetch initial distributors",i)}finally{S(!1)}})()},[]);const H=()=>{const i={id:Date.now().toString()+Math.random().toString(36).substring(2,9),name:"",composition:"",description:"",mrp:0,stock:0,pack:"",supplier:l?l.name:"",expiry_date:"",rate:0,box_number:"",gst:0,margin:0,discount:0,brand_name:"",batch:"",hsn_code:"",mfg:"",loose:0,last_updated:"",created_at:""};k(c=>[...c,i])},se=async(n,i)=>{if(!n){N("No file provided for import.");return}if(!l){N("Please select a distributor before importing.");return}u(!0),N(null);const c=new FormData;c.append("inventoryFile",n),c.append("columnMapping",JSON.stringify(i));try{const b=await $("/api/drugs/parse-excel",{method:"POST",body:c});if(!b.ok){const j=await b.json();throw new Error(j.message||`Failed to parse Excel file: ${b.statusText}`)}const _=await b.json();k(j=>[...j,..._.map(y=>({...y,id:Date.now().toString()+Math.random().toString(36).substring(2,9),supplier:l?l.name:y.supplier}))]),alert(`Successfully parsed ${_.length} drugs from Excel. They have been added to the purchase list.`)}catch(b){console.error("Failed to parse Excel file:",b),N(b.message||"Failed to parse Excel file. Please check the file format and try again.")}finally{f.current&&(f.current.value=""),u(!1),E(null)}},ae=async n=>{if(n.target.files&&n.target.files[0]){const i=n.target.files[0];E(i),N(null),u(!0);const c=new FormData;c.append("inventoryFile",i);try{const b=await $("/api/drugs/get-file-headers",{method:"POST",body:c});if(!b.ok){const j=await b.json();throw new Error(j.message||`Failed to get file headers: ${b.statusText}`)}const{headers:_}=await b.json();z(_),P(!0)}catch(b){console.error("Failed to get file headers:",b),N(b.message||"Failed to read file headers. Please check the file format and try again."),E(null)}finally{u(!1)}}else E(null)},ne=n=>{K?se(K,n):N("No file selected for import after mapping."),P(!1)},ie=()=>{P(!1),z([]),E(null),f.current&&(f.current.value="")},oe=()=>{var n;(n=f.current)==null||n.click()},re=async n=>{if(n.target.files&&n.target.files[0]){const i=n.target.files[0];N(null),u(!0);const c=new FormData;c.append("file",i),c.append("output_type","csv");const _={Authorization:"Bearer 00841ac4-b279-11f0-ab55-0a3a41e3fad1"};try{const j=await fetch("https://extraction-api.nanonets.com/extract",{method:"POST",headers:_,body:c});if(!j.ok){const A=await j.json();throw new Error(A.message||`Failed to extract data from image/PDF: ${j.statusText}`)}const y=await j.json();if(!y.success||!y.content)throw new Error(y.detail||"Nanonets API did not return expected content.");let F=y.content;F=F.split(`
`).filter(A=>!A.startsWith("#")&&A.trim()!=="").join(`
`);const X=new File([F],"extracted_data.csv",{type:"text/csv"}),Y=new FormData;Y.append("inventoryFile",X);const M=await $("/api/drugs/get-file-headers",{method:"POST",body:Y});if(!M.ok){const A=await M.json();throw new Error(A.message||`Failed to get headers from extracted CSV: ${M.statusText}`)}const{headers:be}=await M.json();z(be),E(X),P(!0)}catch(j){console.error("Failed to extract data from image/PDF:",j),N(j.message||"Failed to extract data from image/PDF. Please check the file and try again.")}finally{T.current&&(T.current.value=""),u(!1)}}},le=()=>{var n;(n=T.current)==null||n.click()},ce=()=>{if(!l){N("Please select a distributor before adding a drug manually.");return}V(!0)},Q=()=>{V(!1),N(null)},de=n=>{k(i=>[...i,{...n,id:Date.now().toString(),supplier:l?l.name:n.supplier}]),Q()},ue=n=>{k(i=>i.filter(c=>c.id!==n))},me=(n,i,c)=>{const{value:b}=n.target;k(_=>_.map(j=>{if(j.id===i){let y=b;c==="expiry_date"?y=b.trim()===""?null:b:["mrp","stock","rate","gst","margin","discount","loose"].includes(c)&&(y=parseFloat(b),isNaN(y)&&(y=null));const F={...j,[c]:y};return c==="name"&&l&&!F.supplier&&(F.supplier=l.name),F}return j}))},U=h.useCallback(()=>m.reduce((n,i)=>{const c=i.stock||0,b=i.rate||0,_=i.gst||0,j=i.discount||0;let y=b*(1-j/100),F=c*y;return F+=F*(_/100),n+F},0),[m]),pe=async()=>{if(!l){N("Please select a distributor before submitting the purchase.");return}const n=m.filter(i=>Object.values(i).some(c=>typeof c=="string"&&c.trim()!==""||typeof c=="number"&&c!==0||c!=null&&typeof c!="string"&&typeof c!="number"));if(n.length===0){N("No valid drugs to submit. Please fill in at least one field for a row, or remove empty rows."),u(!1);return}u(!0),N(null);try{for(const _ of n){const j={..._,expiry_date:_.expiry_date===""?null:_.expiry_date,distributorId:l.id},y=await $("/api/drugs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(j)});if(!y.ok){const F=await y.json();throw new Error(F.message||`Failed to add drug ${_.name}: ${y.statusText}`)}}const i=U(),c=new Date().toISOString().split("T")[0],b=await $(`/api/distributors/${l.id}/payments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({payment_date:c,order_value:i,amount_paid:s,notes:"Payment from purchase page."})});if(!b.ok){const _=await b.json();throw new Error(_.message||`Failed to record distributor payment: ${b.statusText}`)}alert("All valid drugs added to inventory and distributor payment recorded successfully!"),k([]),a(null),x(""),r(0),v("/dashboard/inventory")}catch(i){console.error("Failed to submit purchase:",i),N(i.message||"Failed to submit purchase. Please try again.")}finally{u(!1)}},he=h.useCallback(async n=>{if(n.trim()===""){d([]);return}try{const i=await $(`/api/distributors?search=${encodeURIComponent(n)}`);if(!i.ok)throw new Error(`Failed to fetch distributors: ${i.statusText}`);const c=await i.json();d(c)}catch(i){console.error("Failed to fetch distributors:",i),N(i.message||"Failed to load distributors.")}},[]),xe=n=>{const i=n.target.value;x(i),a(null),C.current&&clearTimeout(C.current),i.trim()!==""?C.current=setTimeout(()=>{he(i),D(!0)},300):(d([]),D(!1))},J=n=>{a(n),x(n.name),D(!1),d([])};return h.useEffect(()=>{const n=i=>{i.target instanceof HTMLElement&&!i.target.closest(`.${o.inputWrapper}`)&&D(!1)};return document.addEventListener("mousedown",n),()=>{document.removeEventListener("mousedown",n),C.current&&clearTimeout(C.current)}},[]),e.jsxs("div",{className:o.container,children:[e.jsxs("div",{className:o.header,children:[e.jsx("button",{onClick:()=>v(-1),className:o.backButton,title:"Go Back",children:e.jsx(Ne,{size:24})}),e.jsx("h2",{className:o.title,children:"Purchase Inventory"})]}),q&&e.jsxs("div",{className:o.errorMsg,children:[e.jsx(ve,{size:20}),q]}),e.jsx("div",{className:o.stickyActionBar,children:e.jsxs("div",{className:o.actionRow,children:[e.jsxs("div",{style:{flex:1,minWidth:"300px",position:"relative"},children:[e.jsxs("div",{className:o.inputWrapper,children:[e.jsx(we,{className:o.inputIcon,size:20}),e.jsx("input",{type:"text",placeholder:"Search distributor...",value:g,onChange:xe,onFocus:()=>g.trim()!==""&&D(!0),className:o.input}),O&&t.length>0&&e.jsx("ul",{className:o.resultsDropdown,children:t.map(n=>e.jsx("li",{onClick:()=>J(n),className:o.resultItem,children:n.name},n.id))})]}),w?e.jsx("div",{className:o.quickDistributors,children:[1,2,3,4].map(n=>e.jsx(je,{width:100,height:32,style:{borderRadius:"16px"}},n))}):W.length>0&&!l&&e.jsx("div",{className:o.quickDistributors,children:W.map(n=>e.jsxs("button",{className:o.distributorChip,onClick:()=>J(n),children:[e.jsx(De,{className:o.distributorChipIcon}),n.name]},n.id))}),l&&e.jsxs("div",{className:o.selectedInfo,style:{marginTop:"0.5rem",marginBottom:0},children:[e.jsx(Ce,{size:18}),e.jsxs("span",{children:["Selected: ",e.jsx("strong",{children:l.name})]})]})]}),e.jsxs("div",{className:o.buttonGroup,children:[e.jsx("input",{ref:f,type:"file",className:"sr-only",style:{display:"none"},accept:".xlsx, .xls, .csv",onChange:ae}),e.jsx("input",{ref:T,type:"file",className:"sr-only",style:{display:"none"},accept:".pdf, .png, .jpg, .jpeg",onChange:re}),e.jsxs("button",{onClick:oe,disabled:p||!l,className:`${o.button} ${o.buttonPrimary} ${p||!l?o.buttonDisabled:""}`,title:l?"":"Select a distributor to import",children:[e.jsx(Fe,{size:18}),p?"Processing...":"Import Excel/CSV"]}),e.jsxs("button",{onClick:le,disabled:p||!l,className:`${o.button} ${o.buttonSecondary} ${p||!l?o.buttonDisabled:""}`,title:l?"":"Select a distributor",children:[e.jsx(Ie,{size:18}),"Scan Image/PDF"]}),e.jsxs("button",{onClick:ce,disabled:!l,className:`${o.button} ${o.buttonAccent} ${l?"":o.buttonDisabled}`,title:l?"":"Select a distributor",children:[e.jsx(L,{size:18}),"Add Manually"]})]})]})}),e.jsx(Pe,{isOpen:I,onClose:ie,excelHeaders:B,onConfirm:ne,availableFields:te}),G&&e.jsx(Te,{isOpen:G,onClose:Q,onDrugAddedToPurchase:de}),e.jsxs("div",{className:o.tableSection,children:[e.jsxs("div",{className:o.cardTitle,children:[e.jsx(Se,{className:o.cardIcon,size:24}),"Purchase Items (",m.length,")"]}),e.jsx(Ee,{purchaseRows:m,onCellChange:me,onRemoveDrug:ue,onAddEmptyRow:H})]}),e.jsxs("div",{className:o.footer,children:[e.jsxs("button",{onClick:H,className:`${o.button} ${o.buttonSecondary}`,children:[e.jsx(L,{size:18}),"Add New Row"]}),e.jsxs("div",{className:o.footerControls,children:[e.jsxs("div",{className:o.paidInputGroup,children:[e.jsx("label",{htmlFor:"amount-paid",className:o.paidLabel,children:"Amount Paid:"}),e.jsx("input",{type:"number",id:"amount-paid",value:s,onChange:n=>r(parseFloat(n.target.value)||0),placeholder:"0.00",className:o.paidInput,step:"0.01",disabled:!l})]}),e.jsxs("div",{className:o.totalValue,children:["Total: ",e.jsxs("span",{children:["₹",U().toFixed(2)]})]}),e.jsx("button",{onClick:pe,disabled:p||m.length===0||!l,className:`${o.button} ${o.buttonPrimary} ${o.submitButton} ${p||!l||m.length===0?o.buttonDisabled:""}`,style:{padding:"0.8rem 1.5rem",fontSize:"1rem"},children:p?"Submitting...":"Complete Purchase"})]})]})]})};export{_t as default};
