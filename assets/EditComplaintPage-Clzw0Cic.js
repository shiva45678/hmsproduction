import{c as so,g as yc,R as Di,r as x,j as i,S as Ie,P as zn,T as bt,d as oo,a as lo,F as co,X as Xt,f as W,e as xc,h as $t,C as uo,i as Hn,k as Nr,l as Ji,H as _r,Q as Qi,m as Gi,M as Yt,n as jt,o as po,q as pt,p as bc,s as wc,u as kc,t as Nc,v as jc,w as hi,D as mi,x as ys,E as _c,y as xs,z as bs,B as vc,G as Sc,L as Cc,A as Pc,I as Tc,J as Ic,K as Ac,N as Ec,O as Dc,V as Oc,W as Lc,Y as $c,Z as Rc,_ as Fc}from"./index-DY1tegpu.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zc=[["path",{d:"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z",key:"3c2336"}],["path",{d:"M8 8h8",key:"1bis0t"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"m13 17-5-1h1a4 4 0 0 0 0-8",key:"nu2bwa"}]],ho=so("badge-indian-rupee",zc);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bc=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],xt=so("pencil",Bc),Mc={};function Ki(e,n){const t=Mc,r=typeof t.includeImageAlt=="boolean"?t.includeImageAlt:!0,a=typeof t.includeHtml=="boolean"?t.includeHtml:!0;return mo(e,r,a)}function mo(e,n,t){if(qc(e)){if("value"in e)return e.type==="html"&&!t?"":e.value;if(n&&"alt"in e&&e.alt)return e.alt;if("children"in e)return ws(e.children,n,t)}return Array.isArray(e)?ws(e,n,t):""}function ws(e,n,t){const r=[];let a=-1;for(;++a<e.length;)r[a]=mo(e[a],n,t);return r.join("")}function qc(e){return!!(e&&typeof e=="object")}const ks=document.createElement("i");function Yi(e){const n="&"+e+";";ks.innerHTML=n;const t=ks.textContent;return t.charCodeAt(t.length-1)===59&&e!=="semi"||t===n?!1:t}function St(e,n,t,r){const a=e.length;let s=0,o;if(n<0?n=-n>a?0:a+n:n=n>a?a:n,t=t>0?t:0,r.length<1e4)o=Array.from(r),o.unshift(n,t),e.splice(...o);else for(t&&e.splice(n,t);s<r.length;)o=r.slice(s,s+1e4),o.unshift(n,0),e.splice(...o),s+=1e4,n+=1e4}function ht(e,n){return e.length>0?(St(e,e.length,0,n),e):n}const Ns={}.hasOwnProperty;function Uc(e){const n={};let t=-1;for(;++t<e.length;)Hc(n,e[t]);return n}function Hc(e,n){let t;for(t in n){const a=(Ns.call(e,t)?e[t]:void 0)||(e[t]={}),s=n[t];let o;if(s)for(o in s){Ns.call(a,o)||(a[o]=[]);const l=s[o];Vc(a[o],Array.isArray(l)?l:l?[l]:[])}}}function Vc(e,n){let t=-1;const r=[];for(;++t<n.length;)(n[t].add==="after"?e:r).push(n[t]);St(e,0,0,r)}function fo(e,n){const t=Number.parseInt(e,n);return t<9||t===11||t>13&&t<32||t>126&&t<160||t>55295&&t<57344||t>64975&&t<65008||(t&65535)===65535||(t&65535)===65534||t>1114111?"�":String.fromCodePoint(t)}function mn(e){return e.replace(/[\t\n\r ]+/g," ").replace(/^ | $/g,"").toLowerCase().toUpperCase()}const vt=Wt(/[A-Za-z]/),ot=Wt(/[\dA-Za-z]/),Wc=Wt(/[#-'*+\--9=?A-Z^-~]/);function Oi(e){return e!==null&&(e<32||e===127)}const Li=Wt(/\d/),Jc=Wt(/[\dA-Fa-f]/),Qc=Wt(/[!-/:-@[-`{-~]/);function me(e){return e!==null&&e<-2}function tt(e){return e!==null&&(e<0||e===32)}function Ee(e){return e===-2||e===-1||e===32}const Gc=Wt(new RegExp("\\p{P}|\\p{S}","u")),Kc=Wt(/\s/);function Wt(e){return n;function n(t){return t!==null&&t>-1&&e.test(String.fromCharCode(t))}}function yn(e){const n=[];let t=-1,r=0,a=0;for(;++t<e.length;){const s=e.charCodeAt(t);let o="";if(s===37&&ot(e.charCodeAt(t+1))&&ot(e.charCodeAt(t+2)))a=2;else if(s<128)/[!#$&-;=?-Z_a-z~]/.test(String.fromCharCode(s))||(o=String.fromCharCode(s));else if(s>55295&&s<57344){const l=e.charCodeAt(t+1);s<56320&&l>56319&&l<57344?(o=String.fromCharCode(s,l),a=1):o="�"}else o=String.fromCharCode(s);o&&(n.push(e.slice(r,t),encodeURIComponent(o)),r=t+a+1,o=""),a&&(t+=a,a=0)}return n.join("")+e.slice(r)}function Re(e,n,t,r){const a=r?r-1:Number.POSITIVE_INFINITY;let s=0;return o;function o(u){return Ee(u)?(e.enter(t),l(u)):n(u)}function l(u){return Ee(u)&&s++<a?(e.consume(u),l):(e.exit(t),n(u))}}const Yc={tokenize:Xc};function Xc(e){const n=e.attempt(this.parser.constructs.contentInitial,r,a);let t;return n;function r(l){if(l===null){e.consume(l);return}return e.enter("lineEnding"),e.consume(l),e.exit("lineEnding"),Re(e,n,"linePrefix")}function a(l){return e.enter("paragraph"),s(l)}function s(l){const u=e.enter("chunkText",{contentType:"text",previous:t});return t&&(t.next=u),t=u,o(l)}function o(l){if(l===null){e.exit("chunkText"),e.exit("paragraph"),e.consume(l);return}return me(l)?(e.consume(l),e.exit("chunkText"),s):(e.consume(l),o)}}const Zc={tokenize:eu},js={tokenize:tu};function eu(e){const n=this,t=[];let r=0,a,s,o;return l;function l(z){if(r<t.length){const Y=t[r];return n.containerState=Y[1],e.attempt(Y[0].continuation,u,c)(z)}return c(z)}function u(z){if(r++,n.containerState._closeFlow){n.containerState._closeFlow=void 0,a&&X();const Y=n.events.length;let M=Y,_;for(;M--;)if(n.events[M][0]==="exit"&&n.events[M][1].type==="chunkFlow"){_=n.events[M][1].end;break}D(r);let ee=Y;for(;ee<n.events.length;)n.events[ee][1].end={..._},ee++;return St(n.events,M+1,0,n.events.slice(Y)),n.events.length=ee,c(z)}return l(z)}function c(z){if(r===t.length){if(!a)return y(z);if(a.currentConstruct&&a.currentConstruct.concrete)return S(z);n.interrupt=!!(a.currentConstruct&&!a._gfmTableDynamicInterruptHack)}return n.containerState={},e.check(js,m,d)(z)}function m(z){return a&&X(),D(r),y(z)}function d(z){return n.parser.lazy[n.now().line]=r!==t.length,o=n.now().offset,S(z)}function y(z){return n.containerState={},e.attempt(js,p,S)(z)}function p(z){return r++,t.push([n.currentConstruct,n.containerState]),y(z)}function S(z){if(z===null){a&&X(),D(0),e.consume(z);return}return a=a||n.parser.flow(n.now()),e.enter("chunkFlow",{_tokenizer:a,contentType:"flow",previous:s}),$(z)}function $(z){if(z===null){K(e.exit("chunkFlow"),!0),D(0),e.consume(z);return}return me(z)?(e.consume(z),K(e.exit("chunkFlow")),r=0,n.interrupt=void 0,l):(e.consume(z),$)}function K(z,Y){const M=n.sliceStream(z);if(Y&&M.push(null),z.previous=s,s&&(s.next=z),s=z,a.defineSkip(z.start),a.write(M),n.parser.lazy[z.start.line]){let _=a.events.length;for(;_--;)if(a.events[_][1].start.offset<o&&(!a.events[_][1].end||a.events[_][1].end.offset>o))return;const ee=n.events.length;let je=ee,se,ue;for(;je--;)if(n.events[je][0]==="exit"&&n.events[je][1].type==="chunkFlow"){if(se){ue=n.events[je][1].end;break}se=!0}for(D(r),_=ee;_<n.events.length;)n.events[_][1].end={...ue},_++;St(n.events,je+1,0,n.events.slice(ee)),n.events.length=_}}function D(z){let Y=t.length;for(;Y-- >z;){const M=t[Y];n.containerState=M[1],M[0].exit.call(n,e)}t.length=z}function X(){a.write([null]),s=void 0,a=void 0,n.containerState._closeFlow=void 0}}function tu(e,n,t){return Re(e,e.attempt(this.parser.constructs.document,n,t),"linePrefix",this.parser.constructs.disable.null.includes("codeIndented")?void 0:4)}function vr(e){if(e===null||tt(e)||Kc(e))return 1;if(Gc(e))return 2}function Xi(e,n,t){const r=[];let a=-1;for(;++a<e.length;){const s=e[a].resolveAll;s&&!r.includes(s)&&(n=s(n,t),r.push(s))}return n}const $i={name:"attention",resolveAll:nu,tokenize:ru};function nu(e,n){let t=-1,r,a,s,o,l,u,c,m;for(;++t<e.length;)if(e[t][0]==="enter"&&e[t][1].type==="attentionSequence"&&e[t][1]._close){for(r=t;r--;)if(e[r][0]==="exit"&&e[r][1].type==="attentionSequence"&&e[r][1]._open&&n.sliceSerialize(e[r][1]).charCodeAt(0)===n.sliceSerialize(e[t][1]).charCodeAt(0)){if((e[r][1]._close||e[t][1]._open)&&(e[t][1].end.offset-e[t][1].start.offset)%3&&!((e[r][1].end.offset-e[r][1].start.offset+e[t][1].end.offset-e[t][1].start.offset)%3))continue;u=e[r][1].end.offset-e[r][1].start.offset>1&&e[t][1].end.offset-e[t][1].start.offset>1?2:1;const d={...e[r][1].end},y={...e[t][1].start};_s(d,-u),_s(y,u),o={type:u>1?"strongSequence":"emphasisSequence",start:d,end:{...e[r][1].end}},l={type:u>1?"strongSequence":"emphasisSequence",start:{...e[t][1].start},end:y},s={type:u>1?"strongText":"emphasisText",start:{...e[r][1].end},end:{...e[t][1].start}},a={type:u>1?"strong":"emphasis",start:{...o.start},end:{...l.end}},e[r][1].end={...o.start},e[t][1].start={...l.end},c=[],e[r][1].end.offset-e[r][1].start.offset&&(c=ht(c,[["enter",e[r][1],n],["exit",e[r][1],n]])),c=ht(c,[["enter",a,n],["enter",o,n],["exit",o,n],["enter",s,n]]),c=ht(c,Xi(n.parser.constructs.insideSpan.null,e.slice(r+1,t),n)),c=ht(c,[["exit",s,n],["enter",l,n],["exit",l,n],["exit",a,n]]),e[t][1].end.offset-e[t][1].start.offset?(m=2,c=ht(c,[["enter",e[t][1],n],["exit",e[t][1],n]])):m=0,St(e,r-1,t-r+3,c),t=r+c.length-m-2;break}}for(t=-1;++t<e.length;)e[t][1].type==="attentionSequence"&&(e[t][1].type="data");return e}function ru(e,n){const t=this.parser.constructs.attentionMarkers.null,r=this.previous,a=vr(r);let s;return o;function o(u){return s=u,e.enter("attentionSequence"),l(u)}function l(u){if(u===s)return e.consume(u),l;const c=e.exit("attentionSequence"),m=vr(u),d=!m||m===2&&a||t.includes(u),y=!a||a===2&&m||t.includes(r);return c._open=!!(s===42?d:d&&(a||!y)),c._close=!!(s===42?y:y&&(m||!d)),n(u)}}function _s(e,n){e.column+=n,e.offset+=n,e._bufferIndex+=n}const iu={name:"autolink",tokenize:au};function au(e,n,t){let r=0;return a;function a(p){return e.enter("autolink"),e.enter("autolinkMarker"),e.consume(p),e.exit("autolinkMarker"),e.enter("autolinkProtocol"),s}function s(p){return vt(p)?(e.consume(p),o):p===64?t(p):c(p)}function o(p){return p===43||p===45||p===46||ot(p)?(r=1,l(p)):c(p)}function l(p){return p===58?(e.consume(p),r=0,u):(p===43||p===45||p===46||ot(p))&&r++<32?(e.consume(p),l):(r=0,c(p))}function u(p){return p===62?(e.exit("autolinkProtocol"),e.enter("autolinkMarker"),e.consume(p),e.exit("autolinkMarker"),e.exit("autolink"),n):p===null||p===32||p===60||Oi(p)?t(p):(e.consume(p),u)}function c(p){return p===64?(e.consume(p),m):Wc(p)?(e.consume(p),c):t(p)}function m(p){return ot(p)?d(p):t(p)}function d(p){return p===46?(e.consume(p),r=0,m):p===62?(e.exit("autolinkProtocol").type="autolinkEmail",e.enter("autolinkMarker"),e.consume(p),e.exit("autolinkMarker"),e.exit("autolink"),n):y(p)}function y(p){if((p===45||ot(p))&&r++<63){const S=p===45?y:d;return e.consume(p),S}return t(p)}}const Pr={partial:!0,tokenize:su};function su(e,n,t){return r;function r(s){return Ee(s)?Re(e,a,"linePrefix")(s):a(s)}function a(s){return s===null||me(s)?n(s):t(s)}}const go={continuation:{tokenize:lu},exit:cu,name:"blockQuote",tokenize:ou};function ou(e,n,t){const r=this;return a;function a(o){if(o===62){const l=r.containerState;return l.open||(e.enter("blockQuote",{_container:!0}),l.open=!0),e.enter("blockQuotePrefix"),e.enter("blockQuoteMarker"),e.consume(o),e.exit("blockQuoteMarker"),s}return t(o)}function s(o){return Ee(o)?(e.enter("blockQuotePrefixWhitespace"),e.consume(o),e.exit("blockQuotePrefixWhitespace"),e.exit("blockQuotePrefix"),n):(e.exit("blockQuotePrefix"),n(o))}}function lu(e,n,t){const r=this;return a;function a(o){return Ee(o)?Re(e,s,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(o):s(o)}function s(o){return e.attempt(go,n,t)(o)}}function cu(e){e.exit("blockQuote")}const yo={name:"characterEscape",tokenize:uu};function uu(e,n,t){return r;function r(s){return e.enter("characterEscape"),e.enter("escapeMarker"),e.consume(s),e.exit("escapeMarker"),a}function a(s){return Qc(s)?(e.enter("characterEscapeValue"),e.consume(s),e.exit("characterEscapeValue"),e.exit("characterEscape"),n):t(s)}}const xo={name:"characterReference",tokenize:du};function du(e,n,t){const r=this;let a=0,s,o;return l;function l(d){return e.enter("characterReference"),e.enter("characterReferenceMarker"),e.consume(d),e.exit("characterReferenceMarker"),u}function u(d){return d===35?(e.enter("characterReferenceMarkerNumeric"),e.consume(d),e.exit("characterReferenceMarkerNumeric"),c):(e.enter("characterReferenceValue"),s=31,o=ot,m(d))}function c(d){return d===88||d===120?(e.enter("characterReferenceMarkerHexadecimal"),e.consume(d),e.exit("characterReferenceMarkerHexadecimal"),e.enter("characterReferenceValue"),s=6,o=Jc,m):(e.enter("characterReferenceValue"),s=7,o=Li,m(d))}function m(d){if(d===59&&a){const y=e.exit("characterReferenceValue");return o===ot&&!Yi(r.sliceSerialize(y))?t(d):(e.enter("characterReferenceMarker"),e.consume(d),e.exit("characterReferenceMarker"),e.exit("characterReference"),n)}return o(d)&&a++<s?(e.consume(d),m):t(d)}}const vs={partial:!0,tokenize:hu},Ss={concrete:!0,name:"codeFenced",tokenize:pu};function pu(e,n,t){const r=this,a={partial:!0,tokenize:M};let s=0,o=0,l;return u;function u(_){return c(_)}function c(_){const ee=r.events[r.events.length-1];return s=ee&&ee[1].type==="linePrefix"?ee[2].sliceSerialize(ee[1],!0).length:0,l=_,e.enter("codeFenced"),e.enter("codeFencedFence"),e.enter("codeFencedFenceSequence"),m(_)}function m(_){return _===l?(o++,e.consume(_),m):o<3?t(_):(e.exit("codeFencedFenceSequence"),Ee(_)?Re(e,d,"whitespace")(_):d(_))}function d(_){return _===null||me(_)?(e.exit("codeFencedFence"),r.interrupt?n(_):e.check(vs,$,Y)(_)):(e.enter("codeFencedFenceInfo"),e.enter("chunkString",{contentType:"string"}),y(_))}function y(_){return _===null||me(_)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),d(_)):Ee(_)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),Re(e,p,"whitespace")(_)):_===96&&_===l?t(_):(e.consume(_),y)}function p(_){return _===null||me(_)?d(_):(e.enter("codeFencedFenceMeta"),e.enter("chunkString",{contentType:"string"}),S(_))}function S(_){return _===null||me(_)?(e.exit("chunkString"),e.exit("codeFencedFenceMeta"),d(_)):_===96&&_===l?t(_):(e.consume(_),S)}function $(_){return e.attempt(a,Y,K)(_)}function K(_){return e.enter("lineEnding"),e.consume(_),e.exit("lineEnding"),D}function D(_){return s>0&&Ee(_)?Re(e,X,"linePrefix",s+1)(_):X(_)}function X(_){return _===null||me(_)?e.check(vs,$,Y)(_):(e.enter("codeFlowValue"),z(_))}function z(_){return _===null||me(_)?(e.exit("codeFlowValue"),X(_)):(e.consume(_),z)}function Y(_){return e.exit("codeFenced"),n(_)}function M(_,ee,je){let se=0;return ue;function ue(R){return _.enter("lineEnding"),_.consume(R),_.exit("lineEnding"),U}function U(R){return _.enter("codeFencedFence"),Ee(R)?Re(_,O,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(R):O(R)}function O(R){return R===l?(_.enter("codeFencedFenceSequence"),E(R)):je(R)}function E(R){return R===l?(se++,_.consume(R),E):se>=o?(_.exit("codeFencedFenceSequence"),Ee(R)?Re(_,ge,"whitespace")(R):ge(R)):je(R)}function ge(R){return R===null||me(R)?(_.exit("codeFencedFence"),ee(R)):je(R)}}}function hu(e,n,t){const r=this;return a;function a(o){return o===null?t(o):(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),s)}function s(o){return r.parser.lazy[r.now().line]?t(o):n(o)}}const fi={name:"codeIndented",tokenize:fu},mu={partial:!0,tokenize:gu};function fu(e,n,t){const r=this;return a;function a(c){return e.enter("codeIndented"),Re(e,s,"linePrefix",5)(c)}function s(c){const m=r.events[r.events.length-1];return m&&m[1].type==="linePrefix"&&m[2].sliceSerialize(m[1],!0).length>=4?o(c):t(c)}function o(c){return c===null?u(c):me(c)?e.attempt(mu,o,u)(c):(e.enter("codeFlowValue"),l(c))}function l(c){return c===null||me(c)?(e.exit("codeFlowValue"),o(c)):(e.consume(c),l)}function u(c){return e.exit("codeIndented"),n(c)}}function gu(e,n,t){const r=this;return a;function a(o){return r.parser.lazy[r.now().line]?t(o):me(o)?(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),a):Re(e,s,"linePrefix",5)(o)}function s(o){const l=r.events[r.events.length-1];return l&&l[1].type==="linePrefix"&&l[2].sliceSerialize(l[1],!0).length>=4?n(o):me(o)?a(o):t(o)}}const yu={name:"codeText",previous:bu,resolve:xu,tokenize:wu};function xu(e){let n=e.length-4,t=3,r,a;if((e[t][1].type==="lineEnding"||e[t][1].type==="space")&&(e[n][1].type==="lineEnding"||e[n][1].type==="space")){for(r=t;++r<n;)if(e[r][1].type==="codeTextData"){e[t][1].type="codeTextPadding",e[n][1].type="codeTextPadding",t+=2,n-=2;break}}for(r=t-1,n++;++r<=n;)a===void 0?r!==n&&e[r][1].type!=="lineEnding"&&(a=r):(r===n||e[r][1].type==="lineEnding")&&(e[a][1].type="codeTextData",r!==a+2&&(e[a][1].end=e[r-1][1].end,e.splice(a+2,r-a-2),n-=r-a-2,r=a+2),a=void 0);return e}function bu(e){return e!==96||this.events[this.events.length-1][1].type==="characterEscape"}function wu(e,n,t){let r=0,a,s;return o;function o(d){return e.enter("codeText"),e.enter("codeTextSequence"),l(d)}function l(d){return d===96?(e.consume(d),r++,l):(e.exit("codeTextSequence"),u(d))}function u(d){return d===null?t(d):d===32?(e.enter("space"),e.consume(d),e.exit("space"),u):d===96?(s=e.enter("codeTextSequence"),a=0,m(d)):me(d)?(e.enter("lineEnding"),e.consume(d),e.exit("lineEnding"),u):(e.enter("codeTextData"),c(d))}function c(d){return d===null||d===32||d===96||me(d)?(e.exit("codeTextData"),u(d)):(e.consume(d),c)}function m(d){return d===96?(e.consume(d),a++,m):a===r?(e.exit("codeTextSequence"),e.exit("codeText"),n(d)):(s.type="codeTextData",c(d))}}class ku{constructor(n){this.left=n?[...n]:[],this.right=[]}get(n){if(n<0||n>=this.left.length+this.right.length)throw new RangeError("Cannot access index `"+n+"` in a splice buffer of size `"+(this.left.length+this.right.length)+"`");return n<this.left.length?this.left[n]:this.right[this.right.length-n+this.left.length-1]}get length(){return this.left.length+this.right.length}shift(){return this.setCursor(0),this.right.pop()}slice(n,t){const r=t??Number.POSITIVE_INFINITY;return r<this.left.length?this.left.slice(n,r):n>this.left.length?this.right.slice(this.right.length-r+this.left.length,this.right.length-n+this.left.length).reverse():this.left.slice(n).concat(this.right.slice(this.right.length-r+this.left.length).reverse())}splice(n,t,r){const a=t||0;this.setCursor(Math.trunc(n));const s=this.right.splice(this.right.length-a,Number.POSITIVE_INFINITY);return r&&Rn(this.left,r),s.reverse()}pop(){return this.setCursor(Number.POSITIVE_INFINITY),this.left.pop()}push(n){this.setCursor(Number.POSITIVE_INFINITY),this.left.push(n)}pushMany(n){this.setCursor(Number.POSITIVE_INFINITY),Rn(this.left,n)}unshift(n){this.setCursor(0),this.right.push(n)}unshiftMany(n){this.setCursor(0),Rn(this.right,n.reverse())}setCursor(n){if(!(n===this.left.length||n>this.left.length&&this.right.length===0||n<0&&this.left.length===0))if(n<this.left.length){const t=this.left.splice(n,Number.POSITIVE_INFINITY);Rn(this.right,t.reverse())}else{const t=this.right.splice(this.left.length+this.right.length-n,Number.POSITIVE_INFINITY);Rn(this.left,t.reverse())}}}function Rn(e,n){let t=0;if(n.length<1e4)e.push(...n);else for(;t<n.length;)e.push(...n.slice(t,t+1e4)),t+=1e4}function bo(e){const n={};let t=-1,r,a,s,o,l,u,c;const m=new ku(e);for(;++t<m.length;){for(;t in n;)t=n[t];if(r=m.get(t),t&&r[1].type==="chunkFlow"&&m.get(t-1)[1].type==="listItemPrefix"&&(u=r[1]._tokenizer.events,s=0,s<u.length&&u[s][1].type==="lineEndingBlank"&&(s+=2),s<u.length&&u[s][1].type==="content"))for(;++s<u.length&&u[s][1].type!=="content";)u[s][1].type==="chunkText"&&(u[s][1]._isInFirstContentOfListItem=!0,s++);if(r[0]==="enter")r[1].contentType&&(Object.assign(n,Nu(m,t)),t=n[t],c=!0);else if(r[1]._container){for(s=t,a=void 0;s--;)if(o=m.get(s),o[1].type==="lineEnding"||o[1].type==="lineEndingBlank")o[0]==="enter"&&(a&&(m.get(a)[1].type="lineEndingBlank"),o[1].type="lineEnding",a=s);else if(!(o[1].type==="linePrefix"||o[1].type==="listItemIndent"))break;a&&(r[1].end={...m.get(a)[1].start},l=m.slice(a,t),l.unshift(r),m.splice(a,t-a+1,l))}}return St(e,0,Number.POSITIVE_INFINITY,m.slice(0)),!c}function Nu(e,n){const t=e.get(n)[1],r=e.get(n)[2];let a=n-1;const s=[];let o=t._tokenizer;o||(o=r.parser[t.contentType](t.start),t._contentTypeTextTrailing&&(o._contentTypeTextTrailing=!0));const l=o.events,u=[],c={};let m,d,y=-1,p=t,S=0,$=0;const K=[$];for(;p;){for(;e.get(++a)[1]!==p;);s.push(a),p._tokenizer||(m=r.sliceStream(p),p.next||m.push(null),d&&o.defineSkip(p.start),p._isInFirstContentOfListItem&&(o._gfmTasklistFirstContentOfListItem=!0),o.write(m),p._isInFirstContentOfListItem&&(o._gfmTasklistFirstContentOfListItem=void 0)),d=p,p=p.next}for(p=t;++y<l.length;)l[y][0]==="exit"&&l[y-1][0]==="enter"&&l[y][1].type===l[y-1][1].type&&l[y][1].start.line!==l[y][1].end.line&&($=y+1,K.push($),p._tokenizer=void 0,p.previous=void 0,p=p.next);for(o.events=[],p?(p._tokenizer=void 0,p.previous=void 0):K.pop(),y=K.length;y--;){const D=l.slice(K[y],K[y+1]),X=s.pop();u.push([X,X+D.length-1]),e.splice(X,2,D)}for(u.reverse(),y=-1;++y<u.length;)c[S+u[y][0]]=S+u[y][1],S+=u[y][1]-u[y][0]-1;return c}const ju={resolve:vu,tokenize:Su},_u={partial:!0,tokenize:Cu};function vu(e){return bo(e),e}function Su(e,n){let t;return r;function r(l){return e.enter("content"),t=e.enter("chunkContent",{contentType:"content"}),a(l)}function a(l){return l===null?s(l):me(l)?e.check(_u,o,s)(l):(e.consume(l),a)}function s(l){return e.exit("chunkContent"),e.exit("content"),n(l)}function o(l){return e.consume(l),e.exit("chunkContent"),t.next=e.enter("chunkContent",{contentType:"content",previous:t}),t=t.next,a}}function Cu(e,n,t){const r=this;return a;function a(o){return e.exit("chunkContent"),e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),Re(e,s,"linePrefix")}function s(o){if(o===null||me(o))return t(o);const l=r.events[r.events.length-1];return!r.parser.constructs.disable.null.includes("codeIndented")&&l&&l[1].type==="linePrefix"&&l[2].sliceSerialize(l[1],!0).length>=4?n(o):e.interrupt(r.parser.constructs.flow,t,n)(o)}}function wo(e,n,t,r,a,s,o,l,u){const c=u||Number.POSITIVE_INFINITY;let m=0;return d;function d(D){return D===60?(e.enter(r),e.enter(a),e.enter(s),e.consume(D),e.exit(s),y):D===null||D===32||D===41||Oi(D)?t(D):(e.enter(r),e.enter(o),e.enter(l),e.enter("chunkString",{contentType:"string"}),$(D))}function y(D){return D===62?(e.enter(s),e.consume(D),e.exit(s),e.exit(a),e.exit(r),n):(e.enter(l),e.enter("chunkString",{contentType:"string"}),p(D))}function p(D){return D===62?(e.exit("chunkString"),e.exit(l),y(D)):D===null||D===60||me(D)?t(D):(e.consume(D),D===92?S:p)}function S(D){return D===60||D===62||D===92?(e.consume(D),p):p(D)}function $(D){return!m&&(D===null||D===41||tt(D))?(e.exit("chunkString"),e.exit(l),e.exit(o),e.exit(r),n(D)):m<c&&D===40?(e.consume(D),m++,$):D===41?(e.consume(D),m--,$):D===null||D===32||D===40||Oi(D)?t(D):(e.consume(D),D===92?K:$)}function K(D){return D===40||D===41||D===92?(e.consume(D),$):$(D)}}function ko(e,n,t,r,a,s){const o=this;let l=0,u;return c;function c(p){return e.enter(r),e.enter(a),e.consume(p),e.exit(a),e.enter(s),m}function m(p){return l>999||p===null||p===91||p===93&&!u||p===94&&!l&&"_hiddenFootnoteSupport"in o.parser.constructs?t(p):p===93?(e.exit(s),e.enter(a),e.consume(p),e.exit(a),e.exit(r),n):me(p)?(e.enter("lineEnding"),e.consume(p),e.exit("lineEnding"),m):(e.enter("chunkString",{contentType:"string"}),d(p))}function d(p){return p===null||p===91||p===93||me(p)||l++>999?(e.exit("chunkString"),m(p)):(e.consume(p),u||(u=!Ee(p)),p===92?y:d)}function y(p){return p===91||p===92||p===93?(e.consume(p),l++,d):d(p)}}function No(e,n,t,r,a,s){let o;return l;function l(y){return y===34||y===39||y===40?(e.enter(r),e.enter(a),e.consume(y),e.exit(a),o=y===40?41:y,u):t(y)}function u(y){return y===o?(e.enter(a),e.consume(y),e.exit(a),e.exit(r),n):(e.enter(s),c(y))}function c(y){return y===o?(e.exit(s),u(o)):y===null?t(y):me(y)?(e.enter("lineEnding"),e.consume(y),e.exit("lineEnding"),Re(e,c,"linePrefix")):(e.enter("chunkString",{contentType:"string"}),m(y))}function m(y){return y===o||y===null||me(y)?(e.exit("chunkString"),c(y)):(e.consume(y),y===92?d:m)}function d(y){return y===o||y===92?(e.consume(y),m):m(y)}}function Bn(e,n){let t;return r;function r(a){return me(a)?(e.enter("lineEnding"),e.consume(a),e.exit("lineEnding"),t=!0,r):Ee(a)?Re(e,r,t?"linePrefix":"lineSuffix")(a):n(a)}}const Pu={name:"definition",tokenize:Iu},Tu={partial:!0,tokenize:Au};function Iu(e,n,t){const r=this;let a;return s;function s(p){return e.enter("definition"),o(p)}function o(p){return ko.call(r,e,l,t,"definitionLabel","definitionLabelMarker","definitionLabelString")(p)}function l(p){return a=mn(r.sliceSerialize(r.events[r.events.length-1][1]).slice(1,-1)),p===58?(e.enter("definitionMarker"),e.consume(p),e.exit("definitionMarker"),u):t(p)}function u(p){return tt(p)?Bn(e,c)(p):c(p)}function c(p){return wo(e,m,t,"definitionDestination","definitionDestinationLiteral","definitionDestinationLiteralMarker","definitionDestinationRaw","definitionDestinationString")(p)}function m(p){return e.attempt(Tu,d,d)(p)}function d(p){return Ee(p)?Re(e,y,"whitespace")(p):y(p)}function y(p){return p===null||me(p)?(e.exit("definition"),r.parser.defined.push(a),n(p)):t(p)}}function Au(e,n,t){return r;function r(l){return tt(l)?Bn(e,a)(l):t(l)}function a(l){return No(e,s,t,"definitionTitle","definitionTitleMarker","definitionTitleString")(l)}function s(l){return Ee(l)?Re(e,o,"whitespace")(l):o(l)}function o(l){return l===null||me(l)?n(l):t(l)}}const Eu={name:"hardBreakEscape",tokenize:Du};function Du(e,n,t){return r;function r(s){return e.enter("hardBreakEscape"),e.consume(s),a}function a(s){return me(s)?(e.exit("hardBreakEscape"),n(s)):t(s)}}const Ou={name:"headingAtx",resolve:Lu,tokenize:$u};function Lu(e,n){let t=e.length-2,r=3,a,s;return e[r][1].type==="whitespace"&&(r+=2),t-2>r&&e[t][1].type==="whitespace"&&(t-=2),e[t][1].type==="atxHeadingSequence"&&(r===t-1||t-4>r&&e[t-2][1].type==="whitespace")&&(t-=r+1===t?2:4),t>r&&(a={type:"atxHeadingText",start:e[r][1].start,end:e[t][1].end},s={type:"chunkText",start:e[r][1].start,end:e[t][1].end,contentType:"text"},St(e,r,t-r+1,[["enter",a,n],["enter",s,n],["exit",s,n],["exit",a,n]])),e}function $u(e,n,t){let r=0;return a;function a(m){return e.enter("atxHeading"),s(m)}function s(m){return e.enter("atxHeadingSequence"),o(m)}function o(m){return m===35&&r++<6?(e.consume(m),o):m===null||tt(m)?(e.exit("atxHeadingSequence"),l(m)):t(m)}function l(m){return m===35?(e.enter("atxHeadingSequence"),u(m)):m===null||me(m)?(e.exit("atxHeading"),n(m)):Ee(m)?Re(e,l,"whitespace")(m):(e.enter("atxHeadingText"),c(m))}function u(m){return m===35?(e.consume(m),u):(e.exit("atxHeadingSequence"),l(m))}function c(m){return m===null||m===35||tt(m)?(e.exit("atxHeadingText"),l(m)):(e.consume(m),c)}}const Ru=["address","article","aside","base","basefont","blockquote","body","caption","center","col","colgroup","dd","details","dialog","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hr","html","iframe","legend","li","link","main","menu","menuitem","nav","noframes","ol","optgroup","option","p","param","search","section","summary","table","tbody","td","tfoot","th","thead","title","tr","track","ul"],Cs=["pre","script","style","textarea"],Fu={concrete:!0,name:"htmlFlow",resolveTo:Mu,tokenize:qu},zu={partial:!0,tokenize:Hu},Bu={partial:!0,tokenize:Uu};function Mu(e){let n=e.length;for(;n--&&!(e[n][0]==="enter"&&e[n][1].type==="htmlFlow"););return n>1&&e[n-2][1].type==="linePrefix"&&(e[n][1].start=e[n-2][1].start,e[n+1][1].start=e[n-2][1].start,e.splice(n-2,2)),e}function qu(e,n,t){const r=this;let a,s,o,l,u;return c;function c(b){return m(b)}function m(b){return e.enter("htmlFlow"),e.enter("htmlFlowData"),e.consume(b),d}function d(b){return b===33?(e.consume(b),y):b===47?(e.consume(b),s=!0,$):b===63?(e.consume(b),a=3,r.interrupt?n:w):vt(b)?(e.consume(b),o=String.fromCharCode(b),K):t(b)}function y(b){return b===45?(e.consume(b),a=2,p):b===91?(e.consume(b),a=5,l=0,S):vt(b)?(e.consume(b),a=4,r.interrupt?n:w):t(b)}function p(b){return b===45?(e.consume(b),r.interrupt?n:w):t(b)}function S(b){const qe="CDATA[";return b===qe.charCodeAt(l++)?(e.consume(b),l===qe.length?r.interrupt?n:O:S):t(b)}function $(b){return vt(b)?(e.consume(b),o=String.fromCharCode(b),K):t(b)}function K(b){if(b===null||b===47||b===62||tt(b)){const qe=b===47,Ue=o.toLowerCase();return!qe&&!s&&Cs.includes(Ue)?(a=1,r.interrupt?n(b):O(b)):Ru.includes(o.toLowerCase())?(a=6,qe?(e.consume(b),D):r.interrupt?n(b):O(b)):(a=7,r.interrupt&&!r.parser.lazy[r.now().line]?t(b):s?X(b):z(b))}return b===45||ot(b)?(e.consume(b),o+=String.fromCharCode(b),K):t(b)}function D(b){return b===62?(e.consume(b),r.interrupt?n:O):t(b)}function X(b){return Ee(b)?(e.consume(b),X):ue(b)}function z(b){return b===47?(e.consume(b),ue):b===58||b===95||vt(b)?(e.consume(b),Y):Ee(b)?(e.consume(b),z):ue(b)}function Y(b){return b===45||b===46||b===58||b===95||ot(b)?(e.consume(b),Y):M(b)}function M(b){return b===61?(e.consume(b),_):Ee(b)?(e.consume(b),M):z(b)}function _(b){return b===null||b===60||b===61||b===62||b===96?t(b):b===34||b===39?(e.consume(b),u=b,ee):Ee(b)?(e.consume(b),_):je(b)}function ee(b){return b===u?(e.consume(b),u=null,se):b===null||me(b)?t(b):(e.consume(b),ee)}function je(b){return b===null||b===34||b===39||b===47||b===60||b===61||b===62||b===96||tt(b)?M(b):(e.consume(b),je)}function se(b){return b===47||b===62||Ee(b)?z(b):t(b)}function ue(b){return b===62?(e.consume(b),U):t(b)}function U(b){return b===null||me(b)?O(b):Ee(b)?(e.consume(b),U):t(b)}function O(b){return b===45&&a===2?(e.consume(b),Z):b===60&&a===1?(e.consume(b),Q):b===62&&a===4?(e.consume(b),ze):b===63&&a===3?(e.consume(b),w):b===93&&a===5?(e.consume(b),le):me(b)&&(a===6||a===7)?(e.exit("htmlFlowData"),e.check(zu,_e,E)(b)):b===null||me(b)?(e.exit("htmlFlowData"),E(b)):(e.consume(b),O)}function E(b){return e.check(Bu,ge,_e)(b)}function ge(b){return e.enter("lineEnding"),e.consume(b),e.exit("lineEnding"),R}function R(b){return b===null||me(b)?E(b):(e.enter("htmlFlowData"),O(b))}function Z(b){return b===45?(e.consume(b),w):O(b)}function Q(b){return b===47?(e.consume(b),o="",Pe):O(b)}function Pe(b){if(b===62){const qe=o.toLowerCase();return Cs.includes(qe)?(e.consume(b),ze):O(b)}return vt(b)&&o.length<8?(e.consume(b),o+=String.fromCharCode(b),Pe):O(b)}function le(b){return b===93?(e.consume(b),w):O(b)}function w(b){return b===62?(e.consume(b),ze):b===45&&a===2?(e.consume(b),w):O(b)}function ze(b){return b===null||me(b)?(e.exit("htmlFlowData"),_e(b)):(e.consume(b),ze)}function _e(b){return e.exit("htmlFlow"),n(b)}}function Uu(e,n,t){const r=this;return a;function a(o){return me(o)?(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),s):t(o)}function s(o){return r.parser.lazy[r.now().line]?t(o):n(o)}}function Hu(e,n,t){return r;function r(a){return e.enter("lineEnding"),e.consume(a),e.exit("lineEnding"),e.attempt(Pr,n,t)}}const Vu={name:"htmlText",tokenize:Wu};function Wu(e,n,t){const r=this;let a,s,o;return l;function l(w){return e.enter("htmlText"),e.enter("htmlTextData"),e.consume(w),u}function u(w){return w===33?(e.consume(w),c):w===47?(e.consume(w),M):w===63?(e.consume(w),z):vt(w)?(e.consume(w),je):t(w)}function c(w){return w===45?(e.consume(w),m):w===91?(e.consume(w),s=0,S):vt(w)?(e.consume(w),X):t(w)}function m(w){return w===45?(e.consume(w),p):t(w)}function d(w){return w===null?t(w):w===45?(e.consume(w),y):me(w)?(o=d,Q(w)):(e.consume(w),d)}function y(w){return w===45?(e.consume(w),p):d(w)}function p(w){return w===62?Z(w):w===45?y(w):d(w)}function S(w){const ze="CDATA[";return w===ze.charCodeAt(s++)?(e.consume(w),s===ze.length?$:S):t(w)}function $(w){return w===null?t(w):w===93?(e.consume(w),K):me(w)?(o=$,Q(w)):(e.consume(w),$)}function K(w){return w===93?(e.consume(w),D):$(w)}function D(w){return w===62?Z(w):w===93?(e.consume(w),D):$(w)}function X(w){return w===null||w===62?Z(w):me(w)?(o=X,Q(w)):(e.consume(w),X)}function z(w){return w===null?t(w):w===63?(e.consume(w),Y):me(w)?(o=z,Q(w)):(e.consume(w),z)}function Y(w){return w===62?Z(w):z(w)}function M(w){return vt(w)?(e.consume(w),_):t(w)}function _(w){return w===45||ot(w)?(e.consume(w),_):ee(w)}function ee(w){return me(w)?(o=ee,Q(w)):Ee(w)?(e.consume(w),ee):Z(w)}function je(w){return w===45||ot(w)?(e.consume(w),je):w===47||w===62||tt(w)?se(w):t(w)}function se(w){return w===47?(e.consume(w),Z):w===58||w===95||vt(w)?(e.consume(w),ue):me(w)?(o=se,Q(w)):Ee(w)?(e.consume(w),se):Z(w)}function ue(w){return w===45||w===46||w===58||w===95||ot(w)?(e.consume(w),ue):U(w)}function U(w){return w===61?(e.consume(w),O):me(w)?(o=U,Q(w)):Ee(w)?(e.consume(w),U):se(w)}function O(w){return w===null||w===60||w===61||w===62||w===96?t(w):w===34||w===39?(e.consume(w),a=w,E):me(w)?(o=O,Q(w)):Ee(w)?(e.consume(w),O):(e.consume(w),ge)}function E(w){return w===a?(e.consume(w),a=void 0,R):w===null?t(w):me(w)?(o=E,Q(w)):(e.consume(w),E)}function ge(w){return w===null||w===34||w===39||w===60||w===61||w===96?t(w):w===47||w===62||tt(w)?se(w):(e.consume(w),ge)}function R(w){return w===47||w===62||tt(w)?se(w):t(w)}function Z(w){return w===62?(e.consume(w),e.exit("htmlTextData"),e.exit("htmlText"),n):t(w)}function Q(w){return e.exit("htmlTextData"),e.enter("lineEnding"),e.consume(w),e.exit("lineEnding"),Pe}function Pe(w){return Ee(w)?Re(e,le,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(w):le(w)}function le(w){return e.enter("htmlTextData"),o(w)}}const Zi={name:"labelEnd",resolveAll:Ku,resolveTo:Yu,tokenize:Xu},Ju={tokenize:Zu},Qu={tokenize:ed},Gu={tokenize:td};function Ku(e){let n=-1;const t=[];for(;++n<e.length;){const r=e[n][1];if(t.push(e[n]),r.type==="labelImage"||r.type==="labelLink"||r.type==="labelEnd"){const a=r.type==="labelImage"?4:2;r.type="data",n+=a}}return e.length!==t.length&&St(e,0,e.length,t),e}function Yu(e,n){let t=e.length,r=0,a,s,o,l;for(;t--;)if(a=e[t][1],s){if(a.type==="link"||a.type==="labelLink"&&a._inactive)break;e[t][0]==="enter"&&a.type==="labelLink"&&(a._inactive=!0)}else if(o){if(e[t][0]==="enter"&&(a.type==="labelImage"||a.type==="labelLink")&&!a._balanced&&(s=t,a.type!=="labelLink")){r=2;break}}else a.type==="labelEnd"&&(o=t);const u={type:e[s][1].type==="labelLink"?"link":"image",start:{...e[s][1].start},end:{...e[e.length-1][1].end}},c={type:"label",start:{...e[s][1].start},end:{...e[o][1].end}},m={type:"labelText",start:{...e[s+r+2][1].end},end:{...e[o-2][1].start}};return l=[["enter",u,n],["enter",c,n]],l=ht(l,e.slice(s+1,s+r+3)),l=ht(l,[["enter",m,n]]),l=ht(l,Xi(n.parser.constructs.insideSpan.null,e.slice(s+r+4,o-3),n)),l=ht(l,[["exit",m,n],e[o-2],e[o-1],["exit",c,n]]),l=ht(l,e.slice(o+1)),l=ht(l,[["exit",u,n]]),St(e,s,e.length,l),e}function Xu(e,n,t){const r=this;let a=r.events.length,s,o;for(;a--;)if((r.events[a][1].type==="labelImage"||r.events[a][1].type==="labelLink")&&!r.events[a][1]._balanced){s=r.events[a][1];break}return l;function l(y){return s?s._inactive?d(y):(o=r.parser.defined.includes(mn(r.sliceSerialize({start:s.end,end:r.now()}))),e.enter("labelEnd"),e.enter("labelMarker"),e.consume(y),e.exit("labelMarker"),e.exit("labelEnd"),u):t(y)}function u(y){return y===40?e.attempt(Ju,m,o?m:d)(y):y===91?e.attempt(Qu,m,o?c:d)(y):o?m(y):d(y)}function c(y){return e.attempt(Gu,m,d)(y)}function m(y){return n(y)}function d(y){return s._balanced=!0,t(y)}}function Zu(e,n,t){return r;function r(d){return e.enter("resource"),e.enter("resourceMarker"),e.consume(d),e.exit("resourceMarker"),a}function a(d){return tt(d)?Bn(e,s)(d):s(d)}function s(d){return d===41?m(d):wo(e,o,l,"resourceDestination","resourceDestinationLiteral","resourceDestinationLiteralMarker","resourceDestinationRaw","resourceDestinationString",32)(d)}function o(d){return tt(d)?Bn(e,u)(d):m(d)}function l(d){return t(d)}function u(d){return d===34||d===39||d===40?No(e,c,t,"resourceTitle","resourceTitleMarker","resourceTitleString")(d):m(d)}function c(d){return tt(d)?Bn(e,m)(d):m(d)}function m(d){return d===41?(e.enter("resourceMarker"),e.consume(d),e.exit("resourceMarker"),e.exit("resource"),n):t(d)}}function ed(e,n,t){const r=this;return a;function a(l){return ko.call(r,e,s,o,"reference","referenceMarker","referenceString")(l)}function s(l){return r.parser.defined.includes(mn(r.sliceSerialize(r.events[r.events.length-1][1]).slice(1,-1)))?n(l):t(l)}function o(l){return t(l)}}function td(e,n,t){return r;function r(s){return e.enter("reference"),e.enter("referenceMarker"),e.consume(s),e.exit("referenceMarker"),a}function a(s){return s===93?(e.enter("referenceMarker"),e.consume(s),e.exit("referenceMarker"),e.exit("reference"),n):t(s)}}const nd={name:"labelStartImage",resolveAll:Zi.resolveAll,tokenize:rd};function rd(e,n,t){const r=this;return a;function a(l){return e.enter("labelImage"),e.enter("labelImageMarker"),e.consume(l),e.exit("labelImageMarker"),s}function s(l){return l===91?(e.enter("labelMarker"),e.consume(l),e.exit("labelMarker"),e.exit("labelImage"),o):t(l)}function o(l){return l===94&&"_hiddenFootnoteSupport"in r.parser.constructs?t(l):n(l)}}const id={name:"labelStartLink",resolveAll:Zi.resolveAll,tokenize:ad};function ad(e,n,t){const r=this;return a;function a(o){return e.enter("labelLink"),e.enter("labelMarker"),e.consume(o),e.exit("labelMarker"),e.exit("labelLink"),s}function s(o){return o===94&&"_hiddenFootnoteSupport"in r.parser.constructs?t(o):n(o)}}const gi={name:"lineEnding",tokenize:sd};function sd(e,n){return t;function t(r){return e.enter("lineEnding"),e.consume(r),e.exit("lineEnding"),Re(e,n,"linePrefix")}}const jr={name:"thematicBreak",tokenize:od};function od(e,n,t){let r=0,a;return s;function s(c){return e.enter("thematicBreak"),o(c)}function o(c){return a=c,l(c)}function l(c){return c===a?(e.enter("thematicBreakSequence"),u(c)):r>=3&&(c===null||me(c))?(e.exit("thematicBreak"),n(c)):t(c)}function u(c){return c===a?(e.consume(c),r++,u):(e.exit("thematicBreakSequence"),Ee(c)?Re(e,l,"whitespace")(c):l(c))}}const et={continuation:{tokenize:dd},exit:hd,name:"list",tokenize:ud},ld={partial:!0,tokenize:md},cd={partial:!0,tokenize:pd};function ud(e,n,t){const r=this,a=r.events[r.events.length-1];let s=a&&a[1].type==="linePrefix"?a[2].sliceSerialize(a[1],!0).length:0,o=0;return l;function l(p){const S=r.containerState.type||(p===42||p===43||p===45?"listUnordered":"listOrdered");if(S==="listUnordered"?!r.containerState.marker||p===r.containerState.marker:Li(p)){if(r.containerState.type||(r.containerState.type=S,e.enter(S,{_container:!0})),S==="listUnordered")return e.enter("listItemPrefix"),p===42||p===45?e.check(jr,t,c)(p):c(p);if(!r.interrupt||p===49)return e.enter("listItemPrefix"),e.enter("listItemValue"),u(p)}return t(p)}function u(p){return Li(p)&&++o<10?(e.consume(p),u):(!r.interrupt||o<2)&&(r.containerState.marker?p===r.containerState.marker:p===41||p===46)?(e.exit("listItemValue"),c(p)):t(p)}function c(p){return e.enter("listItemMarker"),e.consume(p),e.exit("listItemMarker"),r.containerState.marker=r.containerState.marker||p,e.check(Pr,r.interrupt?t:m,e.attempt(ld,y,d))}function m(p){return r.containerState.initialBlankLine=!0,s++,y(p)}function d(p){return Ee(p)?(e.enter("listItemPrefixWhitespace"),e.consume(p),e.exit("listItemPrefixWhitespace"),y):t(p)}function y(p){return r.containerState.size=s+r.sliceSerialize(e.exit("listItemPrefix"),!0).length,n(p)}}function dd(e,n,t){const r=this;return r.containerState._closeFlow=void 0,e.check(Pr,a,s);function a(l){return r.containerState.furtherBlankLines=r.containerState.furtherBlankLines||r.containerState.initialBlankLine,Re(e,n,"listItemIndent",r.containerState.size+1)(l)}function s(l){return r.containerState.furtherBlankLines||!Ee(l)?(r.containerState.furtherBlankLines=void 0,r.containerState.initialBlankLine=void 0,o(l)):(r.containerState.furtherBlankLines=void 0,r.containerState.initialBlankLine=void 0,e.attempt(cd,n,o)(l))}function o(l){return r.containerState._closeFlow=!0,r.interrupt=void 0,Re(e,e.attempt(et,n,t),"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(l)}}function pd(e,n,t){const r=this;return Re(e,a,"listItemIndent",r.containerState.size+1);function a(s){const o=r.events[r.events.length-1];return o&&o[1].type==="listItemIndent"&&o[2].sliceSerialize(o[1],!0).length===r.containerState.size?n(s):t(s)}}function hd(e){e.exit(this.containerState.type)}function md(e,n,t){const r=this;return Re(e,a,"listItemPrefixWhitespace",r.parser.constructs.disable.null.includes("codeIndented")?void 0:5);function a(s){const o=r.events[r.events.length-1];return!Ee(s)&&o&&o[1].type==="listItemPrefixWhitespace"?n(s):t(s)}}const Ps={name:"setextUnderline",resolveTo:fd,tokenize:gd};function fd(e,n){let t=e.length,r,a,s;for(;t--;)if(e[t][0]==="enter"){if(e[t][1].type==="content"){r=t;break}e[t][1].type==="paragraph"&&(a=t)}else e[t][1].type==="content"&&e.splice(t,1),!s&&e[t][1].type==="definition"&&(s=t);const o={type:"setextHeading",start:{...e[r][1].start},end:{...e[e.length-1][1].end}};return e[a][1].type="setextHeadingText",s?(e.splice(a,0,["enter",o,n]),e.splice(s+1,0,["exit",e[r][1],n]),e[r][1].end={...e[s][1].end}):e[r][1]=o,e.push(["exit",o,n]),e}function gd(e,n,t){const r=this;let a;return s;function s(c){let m=r.events.length,d;for(;m--;)if(r.events[m][1].type!=="lineEnding"&&r.events[m][1].type!=="linePrefix"&&r.events[m][1].type!=="content"){d=r.events[m][1].type==="paragraph";break}return!r.parser.lazy[r.now().line]&&(r.interrupt||d)?(e.enter("setextHeadingLine"),a=c,o(c)):t(c)}function o(c){return e.enter("setextHeadingLineSequence"),l(c)}function l(c){return c===a?(e.consume(c),l):(e.exit("setextHeadingLineSequence"),Ee(c)?Re(e,u,"lineSuffix")(c):u(c))}function u(c){return c===null||me(c)?(e.exit("setextHeadingLine"),n(c)):t(c)}}const yd={tokenize:xd};function xd(e){const n=this,t=e.attempt(Pr,r,e.attempt(this.parser.constructs.flowInitial,a,Re(e,e.attempt(this.parser.constructs.flow,a,e.attempt(ju,a)),"linePrefix")));return t;function r(s){if(s===null){e.consume(s);return}return e.enter("lineEndingBlank"),e.consume(s),e.exit("lineEndingBlank"),n.currentConstruct=void 0,t}function a(s){if(s===null){e.consume(s);return}return e.enter("lineEnding"),e.consume(s),e.exit("lineEnding"),n.currentConstruct=void 0,t}}const bd={resolveAll:_o()},wd=jo("string"),kd=jo("text");function jo(e){return{resolveAll:_o(e==="text"?Nd:void 0),tokenize:n};function n(t){const r=this,a=this.parser.constructs[e],s=t.attempt(a,o,l);return o;function o(m){return c(m)?s(m):l(m)}function l(m){if(m===null){t.consume(m);return}return t.enter("data"),t.consume(m),u}function u(m){return c(m)?(t.exit("data"),s(m)):(t.consume(m),u)}function c(m){if(m===null)return!0;const d=a[m];let y=-1;if(d)for(;++y<d.length;){const p=d[y];if(!p.previous||p.previous.call(r,r.previous))return!0}return!1}}}function _o(e){return n;function n(t,r){let a=-1,s;for(;++a<=t.length;)s===void 0?t[a]&&t[a][1].type==="data"&&(s=a,a++):(!t[a]||t[a][1].type!=="data")&&(a!==s+2&&(t[s][1].end=t[a-1][1].end,t.splice(s+2,a-s-2),a=s+2),s=void 0);return e?e(t,r):t}}function Nd(e,n){let t=0;for(;++t<=e.length;)if((t===e.length||e[t][1].type==="lineEnding")&&e[t-1][1].type==="data"){const r=e[t-1][1],a=n.sliceStream(r);let s=a.length,o=-1,l=0,u;for(;s--;){const c=a[s];if(typeof c=="string"){for(o=c.length;c.charCodeAt(o-1)===32;)l++,o--;if(o)break;o=-1}else if(c===-2)u=!0,l++;else if(c!==-1){s++;break}}if(n._contentTypeTextTrailing&&t===e.length&&(l=0),l){const c={type:t===e.length||u||l<2?"lineSuffix":"hardBreakTrailing",start:{_bufferIndex:s?o:r.start._bufferIndex+o,_index:r.start._index+s,line:r.end.line,column:r.end.column-l,offset:r.end.offset-l},end:{...r.end}};r.end={...c.start},r.start.offset===r.end.offset?Object.assign(r,c):(e.splice(t,0,["enter",c,n],["exit",c,n]),t+=2)}t++}return e}const jd={42:et,43:et,45:et,48:et,49:et,50:et,51:et,52:et,53:et,54:et,55:et,56:et,57:et,62:go},_d={91:Pu},vd={[-2]:fi,[-1]:fi,32:fi},Sd={35:Ou,42:jr,45:[Ps,jr],60:Fu,61:Ps,95:jr,96:Ss,126:Ss},Cd={38:xo,92:yo},Pd={[-5]:gi,[-4]:gi,[-3]:gi,33:nd,38:xo,42:$i,60:[iu,Vu],91:id,92:[Eu,yo],93:Zi,95:$i,96:yu},Td={null:[$i,bd]},Id={null:[42,95]},Ad={null:[]},Ed=Object.freeze(Object.defineProperty({__proto__:null,attentionMarkers:Id,contentInitial:_d,disable:Ad,document:jd,flow:Sd,flowInitial:vd,insideSpan:Td,string:Cd,text:Pd},Symbol.toStringTag,{value:"Module"}));function Dd(e,n,t){let r={_bufferIndex:-1,_index:0,line:t&&t.line||1,column:t&&t.column||1,offset:t&&t.offset||0};const a={},s=[];let o=[],l=[];const u={attempt:ee(M),check:ee(_),consume:X,enter:z,exit:Y,interrupt:ee(_,{interrupt:!0})},c={code:null,containerState:{},defineSkip:$,events:[],now:S,parser:e,previous:null,sliceSerialize:y,sliceStream:p,write:d};let m=n.tokenize.call(c,u);return n.resolveAll&&s.push(n),c;function d(U){return o=ht(o,U),K(),o[o.length-1]!==null?[]:(je(n,0),c.events=Xi(s,c.events,c),c.events)}function y(U,O){return Ld(p(U),O)}function p(U){return Od(o,U)}function S(){const{_bufferIndex:U,_index:O,line:E,column:ge,offset:R}=r;return{_bufferIndex:U,_index:O,line:E,column:ge,offset:R}}function $(U){a[U.line]=U.column,ue()}function K(){let U;for(;r._index<o.length;){const O=o[r._index];if(typeof O=="string")for(U=r._index,r._bufferIndex<0&&(r._bufferIndex=0);r._index===U&&r._bufferIndex<O.length;)D(O.charCodeAt(r._bufferIndex));else D(O)}}function D(U){m=m(U)}function X(U){me(U)?(r.line++,r.column=1,r.offset+=U===-3?2:1,ue()):U!==-1&&(r.column++,r.offset++),r._bufferIndex<0?r._index++:(r._bufferIndex++,r._bufferIndex===o[r._index].length&&(r._bufferIndex=-1,r._index++)),c.previous=U}function z(U,O){const E=O||{};return E.type=U,E.start=S(),c.events.push(["enter",E,c]),l.push(E),E}function Y(U){const O=l.pop();return O.end=S(),c.events.push(["exit",O,c]),O}function M(U,O){je(U,O.from)}function _(U,O){O.restore()}function ee(U,O){return E;function E(ge,R,Z){let Q,Pe,le,w;return Array.isArray(ge)?_e(ge):"tokenize"in ge?_e([ge]):ze(ge);function ze(ke){return Ge;function Ge(De){const it=De!==null&&ke[De],lt=De!==null&&ke.null,ct=[...Array.isArray(it)?it:it?[it]:[],...Array.isArray(lt)?lt:lt?[lt]:[]];return _e(ct)(De)}}function _e(ke){return Q=ke,Pe=0,ke.length===0?Z:b(ke[Pe])}function b(ke){return Ge;function Ge(De){return w=se(),le=ke,ke.partial||(c.currentConstruct=ke),ke.name&&c.parser.constructs.disable.null.includes(ke.name)?Ue():ke.tokenize.call(O?Object.assign(Object.create(c),O):c,u,qe,Ue)(De)}}function qe(ke){return U(le,w),R}function Ue(ke){return w.restore(),++Pe<Q.length?b(Q[Pe]):Z}}}function je(U,O){U.resolveAll&&!s.includes(U)&&s.push(U),U.resolve&&St(c.events,O,c.events.length-O,U.resolve(c.events.slice(O),c)),U.resolveTo&&(c.events=U.resolveTo(c.events,c))}function se(){const U=S(),O=c.previous,E=c.currentConstruct,ge=c.events.length,R=Array.from(l);return{from:ge,restore:Z};function Z(){r=U,c.previous=O,c.currentConstruct=E,c.events.length=ge,l=R,ue()}}function ue(){r.line in a&&r.column<2&&(r.column=a[r.line],r.offset+=a[r.line]-1)}}function Od(e,n){const t=n.start._index,r=n.start._bufferIndex,a=n.end._index,s=n.end._bufferIndex;let o;if(t===a)o=[e[t].slice(r,s)];else{if(o=e.slice(t,a),r>-1){const l=o[0];typeof l=="string"?o[0]=l.slice(r):o.shift()}s>0&&o.push(e[a].slice(0,s))}return o}function Ld(e,n){let t=-1;const r=[];let a;for(;++t<e.length;){const s=e[t];let o;if(typeof s=="string")o=s;else switch(s){case-5:{o="\r";break}case-4:{o=`
`;break}case-3:{o=`\r
`;break}case-2:{o=n?" ":"	";break}case-1:{if(!n&&a)continue;o=" ";break}default:o=String.fromCharCode(s)}a=s===-2,r.push(o)}return r.join("")}function $d(e){const r={constructs:Uc([Ed,...(e||{}).extensions||[]]),content:a(Yc),defined:[],document:a(Zc),flow:a(yd),lazy:{},string:a(wd),text:a(kd)};return r;function a(s){return o;function o(l){return Dd(r,s,l)}}}function Rd(e){for(;!bo(e););return e}const Ts=/[\0\t\n\r]/g;function Fd(){let e=1,n="",t=!0,r;return a;function a(s,o,l){const u=[];let c,m,d,y,p;for(s=n+(typeof s=="string"?s.toString():new TextDecoder(o||void 0).decode(s)),d=0,n="",t&&(s.charCodeAt(0)===65279&&d++,t=void 0);d<s.length;){if(Ts.lastIndex=d,c=Ts.exec(s),y=c&&c.index!==void 0?c.index:s.length,p=s.charCodeAt(y),!c){n=s.slice(d);break}if(p===10&&d===y&&r)u.push(-3),r=void 0;else switch(r&&(u.push(-5),r=void 0),d<y&&(u.push(s.slice(d,y)),e+=y-d),p){case 0:{u.push(65533),e++;break}case 9:{for(m=Math.ceil(e/4)*4,u.push(-2);e++<m;)u.push(-1);break}case 10:{u.push(-4),e=1;break}default:r=!0,e=1}d=y+1}return l&&(r&&u.push(-5),n&&u.push(n),u.push(null)),u}}const zd=/\\([!-/:-@[-`{-~])|&(#(?:\d{1,7}|x[\da-f]{1,6})|[\da-z]{1,31});/gi;function vo(e){return e.replace(zd,Bd)}function Bd(e,n,t){if(n)return n;if(t.charCodeAt(0)===35){const a=t.charCodeAt(1),s=a===120||a===88;return fo(t.slice(s?2:1),s?16:10)}return Yi(t)||e}function Mn(e){return!e||typeof e!="object"?"":"position"in e||"type"in e?Is(e.position):"start"in e||"end"in e?Is(e):"line"in e||"column"in e?Ri(e):""}function Ri(e){return As(e&&e.line)+":"+As(e&&e.column)}function Is(e){return Ri(e&&e.start)+"-"+Ri(e&&e.end)}function As(e){return e&&typeof e=="number"?e:1}const So={}.hasOwnProperty;function Md(e,n,t){return typeof n!="string"&&(t=n,n=void 0),qd(t)(Rd($d(t).document().write(Fd()(e,n,!0))))}function qd(e){const n={transforms:[],canContainEols:["emphasis","fragment","heading","paragraph","strong"],enter:{autolink:s(Qe),autolinkProtocol:se,autolinkEmail:se,atxHeading:s(j),blockQuote:s(lt),characterEscape:se,characterReference:se,codeFenced:s(ct),codeFencedFenceInfo:o,codeFencedFenceMeta:o,codeIndented:s(ct,o),codeText:s(en,o),codeTextData:se,data:se,codeFlowValue:se,definition:s(tn),definitionDestinationString:o,definitionLabelString:o,definitionTitleString:o,emphasis:s(nn),hardBreakEscape:s(Ct),hardBreakTrailing:s(Ct),htmlFlow:s(mt,o),htmlFlowData:se,htmlText:s(mt,o),htmlTextData:se,image:s(ft),label:o,link:s(Qe),listItem:s(Rt),listItemValue:y,listOrdered:s(Pt,d),listUnordered:s(Pt),paragraph:s(Ft),reference:b,referenceString:o,resourceDestinationString:o,resourceTitleString:o,setextHeading:s(j),strong:s(Je),thematicBreak:s(wt)},exit:{atxHeading:u(),atxHeadingSequence:M,autolink:u(),autolinkEmail:it,autolinkProtocol:De,blockQuote:u(),characterEscapeValue:ue,characterReferenceMarkerHexadecimal:Ue,characterReferenceMarkerNumeric:Ue,characterReferenceValue:ke,characterReference:Ge,codeFenced:u(K),codeFencedFence:$,codeFencedFenceInfo:p,codeFencedFenceMeta:S,codeFlowValue:ue,codeIndented:u(D),codeText:u(R),codeTextData:ue,data:ue,definition:u(),definitionDestinationString:Y,definitionLabelString:X,definitionTitleString:z,emphasis:u(),hardBreakEscape:u(O),hardBreakTrailing:u(O),htmlFlow:u(E),htmlFlowData:ue,htmlText:u(ge),htmlTextData:ue,image:u(Q),label:le,labelText:Pe,lineEnding:U,link:u(Z),listItem:u(),listOrdered:u(),listUnordered:u(),paragraph:u(),referenceString:qe,resourceDestinationString:w,resourceTitleString:ze,resource:_e,setextHeading:u(je),setextHeadingLineSequence:ee,setextHeadingText:_,strong:u(),thematicBreak:u()}};Co(n,(e||{}).mdastExtensions||[]);const t={};return r;function r(T){let F={type:"root",children:[]};const ne={stack:[F],tokenStack:[],config:n,enter:l,exit:c,buffer:o,resume:m,data:t},H=[];let P=-1;for(;++P<T.length;)if(T[P][1].type==="listOrdered"||T[P][1].type==="listUnordered")if(T[P][0]==="enter")H.push(P);else{const ye=H.pop();P=a(T,ye,P)}for(P=-1;++P<T.length;){const ye=n[T[P][0]];So.call(ye,T[P][1].type)&&ye[T[P][1].type].call(Object.assign({sliceSerialize:T[P][2].sliceSerialize},ne),T[P][1])}if(ne.tokenStack.length>0){const ye=ne.tokenStack[ne.tokenStack.length-1];(ye[1]||Es).call(ne,void 0,ye[0])}for(F.position={start:Ut(T.length>0?T[0][1].start:{line:1,column:1,offset:0}),end:Ut(T.length>0?T[T.length-2][1].end:{line:1,column:1,offset:0})},P=-1;++P<n.transforms.length;)F=n.transforms[P](F)||F;return F}function a(T,F,ne){let H=F-1,P=-1,ye=!1,Te,Be,Ke,Ce;for(;++H<=ne;){const Fe=T[H];switch(Fe[1].type){case"listUnordered":case"listOrdered":case"blockQuote":{Fe[0]==="enter"?P++:P--,Ce=void 0;break}case"lineEndingBlank":{Fe[0]==="enter"&&(Te&&!Ce&&!P&&!Ke&&(Ke=H),Ce=void 0);break}case"linePrefix":case"listItemValue":case"listItemMarker":case"listItemPrefix":case"listItemPrefixWhitespace":break;default:Ce=void 0}if(!P&&Fe[0]==="enter"&&Fe[1].type==="listItemPrefix"||P===-1&&Fe[0]==="exit"&&(Fe[1].type==="listUnordered"||Fe[1].type==="listOrdered")){if(Te){let Ye=H;for(Be=void 0;Ye--;){const He=T[Ye];if(He[1].type==="lineEnding"||He[1].type==="lineEndingBlank"){if(He[0]==="exit")continue;Be&&(T[Be][1].type="lineEndingBlank",ye=!0),He[1].type="lineEnding",Be=Ye}else if(!(He[1].type==="linePrefix"||He[1].type==="blockQuotePrefix"||He[1].type==="blockQuotePrefixWhitespace"||He[1].type==="blockQuoteMarker"||He[1].type==="listItemIndent"))break}Ke&&(!Be||Ke<Be)&&(Te._spread=!0),Te.end=Object.assign({},Be?T[Be][1].start:Fe[1].end),T.splice(Be||H,0,["exit",Te,Fe[2]]),H++,ne++}if(Fe[1].type==="listItemPrefix"){const Ye={type:"listItem",_spread:!1,start:Object.assign({},Fe[1].start),end:void 0};Te=Ye,T.splice(H,0,["enter",Ye,Fe[2]]),H++,ne++,Ke=void 0,Ce=!0}}}return T[F][1]._spread=ye,ne}function s(T,F){return ne;function ne(H){l.call(this,T(H),H),F&&F.call(this,H)}}function o(){this.stack.push({type:"fragment",children:[]})}function l(T,F,ne){this.stack[this.stack.length-1].children.push(T),this.stack.push(T),this.tokenStack.push([F,ne||void 0]),T.position={start:Ut(F.start),end:void 0}}function u(T){return F;function F(ne){T&&T.call(this,ne),c.call(this,ne)}}function c(T,F){const ne=this.stack.pop(),H=this.tokenStack.pop();if(H)H[0].type!==T.type&&(F?F.call(this,T,H[0]):(H[1]||Es).call(this,T,H[0]));else throw new Error("Cannot close `"+T.type+"` ("+Mn({start:T.start,end:T.end})+"): it’s not open");ne.position.end=Ut(T.end)}function m(){return Ki(this.stack.pop())}function d(){this.data.expectingFirstListItemValue=!0}function y(T){if(this.data.expectingFirstListItemValue){const F=this.stack[this.stack.length-2];F.start=Number.parseInt(this.sliceSerialize(T),10),this.data.expectingFirstListItemValue=void 0}}function p(){const T=this.resume(),F=this.stack[this.stack.length-1];F.lang=T}function S(){const T=this.resume(),F=this.stack[this.stack.length-1];F.meta=T}function $(){this.data.flowCodeInside||(this.buffer(),this.data.flowCodeInside=!0)}function K(){const T=this.resume(),F=this.stack[this.stack.length-1];F.value=T.replace(/^(\r?\n|\r)|(\r?\n|\r)$/g,""),this.data.flowCodeInside=void 0}function D(){const T=this.resume(),F=this.stack[this.stack.length-1];F.value=T.replace(/(\r?\n|\r)$/g,"")}function X(T){const F=this.resume(),ne=this.stack[this.stack.length-1];ne.label=F,ne.identifier=mn(this.sliceSerialize(T)).toLowerCase()}function z(){const T=this.resume(),F=this.stack[this.stack.length-1];F.title=T}function Y(){const T=this.resume(),F=this.stack[this.stack.length-1];F.url=T}function M(T){const F=this.stack[this.stack.length-1];if(!F.depth){const ne=this.sliceSerialize(T).length;F.depth=ne}}function _(){this.data.setextHeadingSlurpLineEnding=!0}function ee(T){const F=this.stack[this.stack.length-1];F.depth=this.sliceSerialize(T).codePointAt(0)===61?1:2}function je(){this.data.setextHeadingSlurpLineEnding=void 0}function se(T){const ne=this.stack[this.stack.length-1].children;let H=ne[ne.length-1];(!H||H.type!=="text")&&(H=Tt(),H.position={start:Ut(T.start),end:void 0},ne.push(H)),this.stack.push(H)}function ue(T){const F=this.stack.pop();F.value+=this.sliceSerialize(T),F.position.end=Ut(T.end)}function U(T){const F=this.stack[this.stack.length-1];if(this.data.atHardBreak){const ne=F.children[F.children.length-1];ne.position.end=Ut(T.end),this.data.atHardBreak=void 0;return}!this.data.setextHeadingSlurpLineEnding&&n.canContainEols.includes(F.type)&&(se.call(this,T),ue.call(this,T))}function O(){this.data.atHardBreak=!0}function E(){const T=this.resume(),F=this.stack[this.stack.length-1];F.value=T}function ge(){const T=this.resume(),F=this.stack[this.stack.length-1];F.value=T}function R(){const T=this.resume(),F=this.stack[this.stack.length-1];F.value=T}function Z(){const T=this.stack[this.stack.length-1];if(this.data.inReference){const F=this.data.referenceType||"shortcut";T.type+="Reference",T.referenceType=F,delete T.url,delete T.title}else delete T.identifier,delete T.label;this.data.referenceType=void 0}function Q(){const T=this.stack[this.stack.length-1];if(this.data.inReference){const F=this.data.referenceType||"shortcut";T.type+="Reference",T.referenceType=F,delete T.url,delete T.title}else delete T.identifier,delete T.label;this.data.referenceType=void 0}function Pe(T){const F=this.sliceSerialize(T),ne=this.stack[this.stack.length-2];ne.label=vo(F),ne.identifier=mn(F).toLowerCase()}function le(){const T=this.stack[this.stack.length-1],F=this.resume(),ne=this.stack[this.stack.length-1];if(this.data.inReference=!0,ne.type==="link"){const H=T.children;ne.children=H}else ne.alt=F}function w(){const T=this.resume(),F=this.stack[this.stack.length-1];F.url=T}function ze(){const T=this.resume(),F=this.stack[this.stack.length-1];F.title=T}function _e(){this.data.inReference=void 0}function b(){this.data.referenceType="collapsed"}function qe(T){const F=this.resume(),ne=this.stack[this.stack.length-1];ne.label=F,ne.identifier=mn(this.sliceSerialize(T)).toLowerCase(),this.data.referenceType="full"}function Ue(T){this.data.characterReferenceType=T.type}function ke(T){const F=this.sliceSerialize(T),ne=this.data.characterReferenceType;let H;ne?(H=fo(F,ne==="characterReferenceMarkerNumeric"?10:16),this.data.characterReferenceType=void 0):H=Yi(F);const P=this.stack[this.stack.length-1];P.value+=H}function Ge(T){const F=this.stack.pop();F.position.end=Ut(T.end)}function De(T){ue.call(this,T);const F=this.stack[this.stack.length-1];F.url=this.sliceSerialize(T)}function it(T){ue.call(this,T);const F=this.stack[this.stack.length-1];F.url="mailto:"+this.sliceSerialize(T)}function lt(){return{type:"blockquote",children:[]}}function ct(){return{type:"code",lang:null,meta:null,value:""}}function en(){return{type:"inlineCode",value:""}}function tn(){return{type:"definition",identifier:"",label:null,title:null,url:""}}function nn(){return{type:"emphasis",children:[]}}function j(){return{type:"heading",depth:0,children:[]}}function Ct(){return{type:"break"}}function mt(){return{type:"html",value:""}}function ft(){return{type:"image",title:null,url:"",alt:null}}function Qe(){return{type:"link",title:null,url:"",children:[]}}function Pt(T){return{type:"list",ordered:T.type==="listOrdered",start:null,spread:T._spread,children:[]}}function Rt(T){return{type:"listItem",spread:T._spread,checked:null,children:[]}}function Ft(){return{type:"paragraph",children:[]}}function Je(){return{type:"strong",children:[]}}function Tt(){return{type:"text",value:""}}function wt(){return{type:"thematicBreak"}}}function Ut(e){return{line:e.line,column:e.column,offset:e.offset}}function Co(e,n){let t=-1;for(;++t<n.length;){const r=n[t];Array.isArray(r)?Co(e,r):Ud(e,r)}}function Ud(e,n){let t;for(t in n)if(So.call(n,t))switch(t){case"canContainEols":{const r=n[t];r&&e[t].push(...r);break}case"transforms":{const r=n[t];r&&e[t].push(...r);break}case"enter":case"exit":{const r=n[t];r&&Object.assign(e[t],r);break}}}function Es(e,n){throw e?new Error("Cannot close `"+e.type+"` ("+Mn({start:e.start,end:e.end})+"): a different token (`"+n.type+"`, "+Mn({start:n.start,end:n.end})+") is open"):new Error("Cannot close document, a token (`"+n.type+"`, "+Mn({start:n.start,end:n.end})+") is still open")}function Hd(e){const n=this;n.parser=t;function t(r){return Md(r,{...n.data("settings"),...e,extensions:n.data("micromarkExtensions")||[],mdastExtensions:n.data("fromMarkdownExtensions")||[]})}}const Ds={}.hasOwnProperty;function Po(e,n){const t=n||{};function r(a,...s){let o=r.invalid;const l=r.handlers;if(a&&Ds.call(a,e)){const u=String(a[e]);o=Ds.call(l,u)?l[u]:r.unknown}if(o)return o.call(this,a,...s)}return r.handlers=t.handlers||{},r.invalid=t.invalid,r.unknown=t.unknown,r}const Vd={}.hasOwnProperty;function To(e,n){let t=-1,r;if(n.extensions)for(;++t<n.extensions.length;)To(e,n.extensions[t]);for(r in n)if(Vd.call(n,r))switch(r){case"extensions":break;case"unsafe":{Os(e[r],n[r]);break}case"join":{Os(e[r],n[r]);break}case"handlers":{Wd(e[r],n[r]);break}default:e.options[r]=n[r]}return e}function Os(e,n){n&&e.push(...n)}function Wd(e,n){n&&Object.assign(e,n)}function Jd(e,n,t,r){const a=t.enter("blockquote"),s=t.createTracker(r);s.move("> "),s.shift(2);const o=t.indentLines(t.containerFlow(e,s.current()),Qd);return a(),o}function Qd(e,n,t){return">"+(t?"":" ")+e}function Io(e,n){return Ls(e,n.inConstruct,!0)&&!Ls(e,n.notInConstruct,!1)}function Ls(e,n,t){if(typeof n=="string"&&(n=[n]),!n||n.length===0)return t;let r=-1;for(;++r<n.length;)if(e.includes(n[r]))return!0;return!1}function $s(e,n,t,r){let a=-1;for(;++a<t.unsafe.length;)if(t.unsafe[a].character===`
`&&Io(t.stack,t.unsafe[a]))return/[ \t]/.test(r.before)?"":" ";return`\\
`}function Gd(e,n){const t=String(e);let r=t.indexOf(n),a=r,s=0,o=0;if(typeof n!="string")throw new TypeError("Expected substring");for(;r!==-1;)r===a?++s>o&&(o=s):s=1,a=r+n.length,r=t.indexOf(n,a);return o}function Fi(e,n){return!!(n.options.fences===!1&&e.value&&!e.lang&&/[^ \r\n]/.test(e.value)&&!/^[\t ]*(?:[\r\n]|$)|(?:^|[\r\n])[\t ]*$/.test(e.value))}function Kd(e){const n=e.options.fence||"`";if(n!=="`"&&n!=="~")throw new Error("Cannot serialize code with `"+n+"` for `options.fence`, expected `` ` `` or `~`");return n}function Yd(e,n,t,r){const a=Kd(t),s=e.value||"",o=a==="`"?"GraveAccent":"Tilde";if(Fi(e,t)){const d=t.enter("codeIndented"),y=t.indentLines(s,Xd);return d(),y}const l=t.createTracker(r),u=a.repeat(Math.max(Gd(s,a)+1,3)),c=t.enter("codeFenced");let m=l.move(u);if(e.lang){const d=t.enter(`codeFencedLang${o}`);m+=l.move(t.safe(e.lang,{before:m,after:" ",encode:["`"],...l.current()})),d()}if(e.lang&&e.meta){const d=t.enter(`codeFencedMeta${o}`);m+=l.move(" "),m+=l.move(t.safe(e.meta,{before:m,after:`
`,encode:["`"],...l.current()})),d()}return m+=l.move(`
`),s&&(m+=l.move(s+`
`)),m+=l.move(u),c(),m}function Xd(e,n,t){return(t?"":"    ")+e}function ea(e){const n=e.options.quote||'"';if(n!=='"'&&n!=="'")throw new Error("Cannot serialize title with `"+n+"` for `options.quote`, expected `\"`, or `'`");return n}function Zd(e,n,t,r){const a=ea(t),s=a==='"'?"Quote":"Apostrophe",o=t.enter("definition");let l=t.enter("label");const u=t.createTracker(r);let c=u.move("[");return c+=u.move(t.safe(t.associationId(e),{before:c,after:"]",...u.current()})),c+=u.move("]: "),l(),!e.url||/[\0- \u007F]/.test(e.url)?(l=t.enter("destinationLiteral"),c+=u.move("<"),c+=u.move(t.safe(e.url,{before:c,after:">",...u.current()})),c+=u.move(">")):(l=t.enter("destinationRaw"),c+=u.move(t.safe(e.url,{before:c,after:e.title?" ":`
`,...u.current()}))),l(),e.title&&(l=t.enter(`title${s}`),c+=u.move(" "+a),c+=u.move(t.safe(e.title,{before:c,after:a,...u.current()})),c+=u.move(a),l()),o(),c}function ep(e){const n=e.options.emphasis||"*";if(n!=="*"&&n!=="_")throw new Error("Cannot serialize emphasis with `"+n+"` for `options.emphasis`, expected `*`, or `_`");return n}function Vt(e){return"&#x"+e.toString(16).toUpperCase()+";"}function Sr(e,n,t){const r=vr(e),a=vr(n);return r===void 0?a===void 0?t==="_"?{inside:!0,outside:!0}:{inside:!1,outside:!1}:a===1?{inside:!0,outside:!0}:{inside:!1,outside:!0}:r===1?a===void 0?{inside:!1,outside:!1}:a===1?{inside:!0,outside:!0}:{inside:!1,outside:!1}:a===void 0?{inside:!1,outside:!1}:a===1?{inside:!0,outside:!1}:{inside:!1,outside:!1}}Ao.peek=tp;function Ao(e,n,t,r){const a=ep(t),s=t.enter("emphasis"),o=t.createTracker(r),l=o.move(a);let u=o.move(t.containerPhrasing(e,{after:a,before:l,...o.current()}));const c=u.charCodeAt(0),m=Sr(r.before.charCodeAt(r.before.length-1),c,a);m.inside&&(u=Vt(c)+u.slice(1));const d=u.charCodeAt(u.length-1),y=Sr(r.after.charCodeAt(0),d,a);y.inside&&(u=u.slice(0,-1)+Vt(d));const p=o.move(a);return s(),t.attentionEncodeSurroundingInfo={after:y.outside,before:m.outside},l+u+p}function tp(e,n,t){return t.options.emphasis||"*"}const ta=function(e){if(e==null)return ap;if(typeof e=="function")return Tr(e);if(typeof e=="object")return Array.isArray(e)?np(e):rp(e);if(typeof e=="string")return ip(e);throw new Error("Expected function, string, or object as test")};function np(e){const n=[];let t=-1;for(;++t<e.length;)n[t]=ta(e[t]);return Tr(r);function r(...a){let s=-1;for(;++s<n.length;)if(n[s].apply(this,a))return!0;return!1}}function rp(e){const n=e;return Tr(t);function t(r){const a=r;let s;for(s in e)if(a[s]!==n[s])return!1;return!0}}function ip(e){return Tr(n);function n(t){return t&&t.type===e}}function Tr(e){return n;function n(t,r,a){return!!(sp(t)&&e.call(this,t,typeof r=="number"?r:void 0,a||void 0))}}function ap(){return!0}function sp(e){return e!==null&&typeof e=="object"&&"type"in e}const Eo=[],op=!0,zi=!1,lp="skip";function cp(e,n,t,r){let a;typeof n=="function"&&typeof t!="function"?(r=t,t=n):a=n;const s=ta(a),o=r?-1:1;l(e,void 0,[])();function l(u,c,m){const d=u&&typeof u=="object"?u:{};if(typeof d.type=="string"){const p=typeof d.tagName=="string"?d.tagName:typeof d.name=="string"?d.name:void 0;Object.defineProperty(y,"name",{value:"node ("+(u.type+(p?"<"+p+">":""))+")"})}return y;function y(){let p=Eo,S,$,K;if((!n||s(u,c,m[m.length-1]||void 0))&&(p=up(t(u,m)),p[0]===zi))return p;if("children"in u&&u.children){const D=u;if(D.children&&p[0]!==lp)for($=(r?D.children.length:-1)+o,K=m.concat(D);$>-1&&$<D.children.length;){const X=D.children[$];if(S=l(X,$,K)(),S[0]===zi)return S;$=typeof S[1]=="number"?S[1]:$+o}}return p}}}function up(e){return Array.isArray(e)?e:typeof e=="number"?[op,e]:e==null?Eo:[e]}function Do(e,n,t,r){let a,s,o;typeof n=="function"?(s=void 0,o=n,a=t):(s=n,o=t,a=r),cp(e,s,l,a);function l(u,c){const m=c[c.length-1],d=m?m.children.indexOf(u):void 0;return o(u,d,m)}}function Oo(e,n){let t=!1;return Do(e,function(r){if("value"in r&&/\r?\n|\r/.test(r.value)||r.type==="break")return t=!0,zi}),!!((!e.depth||e.depth<3)&&Ki(e)&&(n.options.setext||t))}function dp(e,n,t,r){const a=Math.max(Math.min(6,e.depth||1),1),s=t.createTracker(r);if(Oo(e,t)){const m=t.enter("headingSetext"),d=t.enter("phrasing"),y=t.containerPhrasing(e,{...s.current(),before:`
`,after:`
`});return d(),m(),y+`
`+(a===1?"=":"-").repeat(y.length-(Math.max(y.lastIndexOf("\r"),y.lastIndexOf(`
`))+1))}const o="#".repeat(a),l=t.enter("headingAtx"),u=t.enter("phrasing");s.move(o+" ");let c=t.containerPhrasing(e,{before:"# ",after:`
`,...s.current()});return/^[\t ]/.test(c)&&(c=Vt(c.charCodeAt(0))+c.slice(1)),c=c?o+" "+c:o,t.options.closeAtx&&(c+=" "+o),u(),l(),c}Lo.peek=pp;function Lo(e){return e.value||""}function pp(){return"<"}$o.peek=hp;function $o(e,n,t,r){const a=ea(t),s=a==='"'?"Quote":"Apostrophe",o=t.enter("image");let l=t.enter("label");const u=t.createTracker(r);let c=u.move("![");return c+=u.move(t.safe(e.alt,{before:c,after:"]",...u.current()})),c+=u.move("]("),l(),!e.url&&e.title||/[\0- \u007F]/.test(e.url)?(l=t.enter("destinationLiteral"),c+=u.move("<"),c+=u.move(t.safe(e.url,{before:c,after:">",...u.current()})),c+=u.move(">")):(l=t.enter("destinationRaw"),c+=u.move(t.safe(e.url,{before:c,after:e.title?" ":")",...u.current()}))),l(),e.title&&(l=t.enter(`title${s}`),c+=u.move(" "+a),c+=u.move(t.safe(e.title,{before:c,after:a,...u.current()})),c+=u.move(a),l()),c+=u.move(")"),o(),c}function hp(){return"!"}Ro.peek=mp;function Ro(e,n,t,r){const a=e.referenceType,s=t.enter("imageReference");let o=t.enter("label");const l=t.createTracker(r);let u=l.move("![");const c=t.safe(e.alt,{before:u,after:"]",...l.current()});u+=l.move(c+"]["),o();const m=t.stack;t.stack=[],o=t.enter("reference");const d=t.safe(t.associationId(e),{before:u,after:"]",...l.current()});return o(),t.stack=m,s(),a==="full"||!c||c!==d?u+=l.move(d+"]"):a==="shortcut"?u=u.slice(0,-1):u+=l.move("]"),u}function mp(){return"!"}Fo.peek=fp;function Fo(e,n,t){let r=e.value||"",a="`",s=-1;for(;new RegExp("(^|[^`])"+a+"([^`]|$)").test(r);)a+="`";for(/[^ \r\n]/.test(r)&&(/^[ \r\n]/.test(r)&&/[ \r\n]$/.test(r)||/^`|`$/.test(r))&&(r=" "+r+" ");++s<t.unsafe.length;){const o=t.unsafe[s],l=t.compilePattern(o);let u;if(o.atBreak)for(;u=l.exec(r);){let c=u.index;r.charCodeAt(c)===10&&r.charCodeAt(c-1)===13&&c--,r=r.slice(0,c)+" "+r.slice(u.index+1)}}return a+r+a}function fp(){return"`"}function zo(e,n){const t=Ki(e);return!!(!n.options.resourceLink&&e.url&&!e.title&&e.children&&e.children.length===1&&e.children[0].type==="text"&&(t===e.url||"mailto:"+t===e.url)&&/^[a-z][a-z+.-]+:/i.test(e.url)&&!/[\0- <>\u007F]/.test(e.url))}Bo.peek=gp;function Bo(e,n,t,r){const a=ea(t),s=a==='"'?"Quote":"Apostrophe",o=t.createTracker(r);let l,u;if(zo(e,t)){const m=t.stack;t.stack=[],l=t.enter("autolink");let d=o.move("<");return d+=o.move(t.containerPhrasing(e,{before:d,after:">",...o.current()})),d+=o.move(">"),l(),t.stack=m,d}l=t.enter("link"),u=t.enter("label");let c=o.move("[");return c+=o.move(t.containerPhrasing(e,{before:c,after:"](",...o.current()})),c+=o.move("]("),u(),!e.url&&e.title||/[\0- \u007F]/.test(e.url)?(u=t.enter("destinationLiteral"),c+=o.move("<"),c+=o.move(t.safe(e.url,{before:c,after:">",...o.current()})),c+=o.move(">")):(u=t.enter("destinationRaw"),c+=o.move(t.safe(e.url,{before:c,after:e.title?" ":")",...o.current()}))),u(),e.title&&(u=t.enter(`title${s}`),c+=o.move(" "+a),c+=o.move(t.safe(e.title,{before:c,after:a,...o.current()})),c+=o.move(a),u()),c+=o.move(")"),l(),c}function gp(e,n,t){return zo(e,t)?"<":"["}Mo.peek=yp;function Mo(e,n,t,r){const a=e.referenceType,s=t.enter("linkReference");let o=t.enter("label");const l=t.createTracker(r);let u=l.move("[");const c=t.containerPhrasing(e,{before:u,after:"]",...l.current()});u+=l.move(c+"]["),o();const m=t.stack;t.stack=[],o=t.enter("reference");const d=t.safe(t.associationId(e),{before:u,after:"]",...l.current()});return o(),t.stack=m,s(),a==="full"||!c||c!==d?u+=l.move(d+"]"):a==="shortcut"?u=u.slice(0,-1):u+=l.move("]"),u}function yp(){return"["}function na(e){const n=e.options.bullet||"*";if(n!=="*"&&n!=="+"&&n!=="-")throw new Error("Cannot serialize items with `"+n+"` for `options.bullet`, expected `*`, `+`, or `-`");return n}function xp(e){const n=na(e),t=e.options.bulletOther;if(!t)return n==="*"?"-":"*";if(t!=="*"&&t!=="+"&&t!=="-")throw new Error("Cannot serialize items with `"+t+"` for `options.bulletOther`, expected `*`, `+`, or `-`");if(t===n)throw new Error("Expected `bullet` (`"+n+"`) and `bulletOther` (`"+t+"`) to be different");return t}function bp(e){const n=e.options.bulletOrdered||".";if(n!=="."&&n!==")")throw new Error("Cannot serialize items with `"+n+"` for `options.bulletOrdered`, expected `.` or `)`");return n}function qo(e){const n=e.options.rule||"*";if(n!=="*"&&n!=="-"&&n!=="_")throw new Error("Cannot serialize rules with `"+n+"` for `options.rule`, expected `*`, `-`, or `_`");return n}function wp(e,n,t,r){const a=t.enter("list"),s=t.bulletCurrent;let o=e.ordered?bp(t):na(t);const l=e.ordered?o==="."?")":".":xp(t);let u=n&&t.bulletLastUsed?o===t.bulletLastUsed:!1;if(!e.ordered){const m=e.children?e.children[0]:void 0;if((o==="*"||o==="-")&&m&&(!m.children||!m.children[0])&&t.stack[t.stack.length-1]==="list"&&t.stack[t.stack.length-2]==="listItem"&&t.stack[t.stack.length-3]==="list"&&t.stack[t.stack.length-4]==="listItem"&&t.indexStack[t.indexStack.length-1]===0&&t.indexStack[t.indexStack.length-2]===0&&t.indexStack[t.indexStack.length-3]===0&&(u=!0),qo(t)===o&&m){let d=-1;for(;++d<e.children.length;){const y=e.children[d];if(y&&y.type==="listItem"&&y.children&&y.children[0]&&y.children[0].type==="thematicBreak"){u=!0;break}}}}u&&(o=l),t.bulletCurrent=o;const c=t.containerFlow(e,r);return t.bulletLastUsed=o,t.bulletCurrent=s,a(),c}function kp(e){const n=e.options.listItemIndent||"one";if(n!=="tab"&&n!=="one"&&n!=="mixed")throw new Error("Cannot serialize items with `"+n+"` for `options.listItemIndent`, expected `tab`, `one`, or `mixed`");return n}function Np(e,n,t,r){const a=kp(t);let s=t.bulletCurrent||na(t);n&&n.type==="list"&&n.ordered&&(s=(typeof n.start=="number"&&n.start>-1?n.start:1)+(t.options.incrementListMarker===!1?0:n.children.indexOf(e))+s);let o=s.length+1;(a==="tab"||a==="mixed"&&(n&&n.type==="list"&&n.spread||e.spread))&&(o=Math.ceil(o/4)*4);const l=t.createTracker(r);l.move(s+" ".repeat(o-s.length)),l.shift(o);const u=t.enter("listItem"),c=t.indentLines(t.containerFlow(e,l.current()),m);return u(),c;function m(d,y,p){return y?(p?"":" ".repeat(o))+d:(p?s:s+" ".repeat(o-s.length))+d}}function jp(e,n,t,r){const a=t.enter("paragraph"),s=t.enter("phrasing"),o=t.containerPhrasing(e,r);return s(),a(),o}const _p=ta(["break","delete","emphasis","footnote","footnoteReference","image","imageReference","inlineCode","inlineMath","link","linkReference","mdxJsxTextElement","mdxTextExpression","strong","text","textDirective"]);function vp(e,n,t,r){return(e.children.some(function(o){return _p(o)})?t.containerPhrasing:t.containerFlow).call(t,e,r)}function Sp(e){const n=e.options.strong||"*";if(n!=="*"&&n!=="_")throw new Error("Cannot serialize strong with `"+n+"` for `options.strong`, expected `*`, or `_`");return n}Uo.peek=Cp;function Uo(e,n,t,r){const a=Sp(t),s=t.enter("strong"),o=t.createTracker(r),l=o.move(a+a);let u=o.move(t.containerPhrasing(e,{after:a,before:l,...o.current()}));const c=u.charCodeAt(0),m=Sr(r.before.charCodeAt(r.before.length-1),c,a);m.inside&&(u=Vt(c)+u.slice(1));const d=u.charCodeAt(u.length-1),y=Sr(r.after.charCodeAt(0),d,a);y.inside&&(u=u.slice(0,-1)+Vt(d));const p=o.move(a+a);return s(),t.attentionEncodeSurroundingInfo={after:y.outside,before:m.outside},l+u+p}function Cp(e,n,t){return t.options.strong||"*"}function Pp(e,n,t,r){return t.safe(e.value,r)}function Tp(e){const n=e.options.ruleRepetition||3;if(n<3)throw new Error("Cannot serialize rules with repetition `"+n+"` for `options.ruleRepetition`, expected `3` or more");return n}function Ip(e,n,t){const r=(qo(t)+(t.options.ruleSpaces?" ":"")).repeat(Tp(t));return t.options.ruleSpaces?r.slice(0,-1):r}const Ap={blockquote:Jd,break:$s,code:Yd,definition:Zd,emphasis:Ao,hardBreak:$s,heading:dp,html:Lo,image:$o,imageReference:Ro,inlineCode:Fo,link:Bo,linkReference:Mo,list:wp,listItem:Np,paragraph:jp,root:vp,strong:Uo,text:Pp,thematicBreak:Ip},Ep=[Dp];function Dp(e,n,t,r){if(n.type==="code"&&Fi(n,r)&&(e.type==="list"||e.type===n.type&&Fi(e,r)))return!1;if("spread"in t&&typeof t.spread=="boolean")return e.type==="paragraph"&&(e.type===n.type||n.type==="definition"||n.type==="heading"&&Oo(n,r))?void 0:t.spread?1:0}const Gt=["autolink","destinationLiteral","destinationRaw","reference","titleQuote","titleApostrophe"],Op=[{character:"	",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",before:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"\r",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:`
`,inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:" ",after:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",before:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"!",after:"\\[",inConstruct:"phrasing",notInConstruct:Gt},{character:'"',inConstruct:"titleQuote"},{atBreak:!0,character:"#"},{character:"#",inConstruct:"headingAtx",after:`(?:[\r
]|$)`},{character:"&",after:"[#A-Za-z]",inConstruct:"phrasing"},{character:"'",inConstruct:"titleApostrophe"},{character:"(",inConstruct:"destinationRaw"},{before:"\\]",character:"(",inConstruct:"phrasing",notInConstruct:Gt},{atBreak:!0,before:"\\d+",character:")"},{character:")",inConstruct:"destinationRaw"},{atBreak:!0,character:"*",after:`(?:[ 	\r
*])`},{character:"*",inConstruct:"phrasing",notInConstruct:Gt},{atBreak:!0,character:"+",after:`(?:[ 	\r
])`},{atBreak:!0,character:"-",after:`(?:[ 	\r
-])`},{atBreak:!0,before:"\\d+",character:".",after:`(?:[ 	\r
]|$)`},{atBreak:!0,character:"<",after:"[!/?A-Za-z]"},{character:"<",after:"[!/?A-Za-z]",inConstruct:"phrasing",notInConstruct:Gt},{character:"<",inConstruct:"destinationLiteral"},{atBreak:!0,character:"="},{atBreak:!0,character:">"},{character:">",inConstruct:"destinationLiteral"},{atBreak:!0,character:"["},{character:"[",inConstruct:"phrasing",notInConstruct:Gt},{character:"[",inConstruct:["label","reference"]},{character:"\\",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"]",inConstruct:["label","reference"]},{atBreak:!0,character:"_"},{character:"_",inConstruct:"phrasing",notInConstruct:Gt},{atBreak:!0,character:"`"},{character:"`",inConstruct:["codeFencedLangGraveAccent","codeFencedMetaGraveAccent"]},{character:"`",inConstruct:"phrasing",notInConstruct:Gt},{atBreak:!0,character:"~"}];function Lp(e){return e.label||!e.identifier?e.label||"":vo(e.identifier)}function $p(e){if(!e._compiled){const n=(e.atBreak?"[\\r\\n][\\t ]*":"")+(e.before?"(?:"+e.before+")":"");e._compiled=new RegExp((n?"("+n+")":"")+(/[|\\{}()[\]^$+*?.-]/.test(e.character)?"\\":"")+e.character+(e.after?"(?:"+e.after+")":""),"g")}return e._compiled}function Rp(e,n,t){const r=n.indexStack,a=e.children||[],s=[];let o=-1,l=t.before,u;r.push(-1);let c=n.createTracker(t);for(;++o<a.length;){const m=a[o];let d;if(r[r.length-1]=o,o+1<a.length){let S=n.handle.handlers[a[o+1].type];S&&S.peek&&(S=S.peek),d=S?S(a[o+1],e,n,{before:"",after:"",...c.current()}).charAt(0):""}else d=t.after;s.length>0&&(l==="\r"||l===`
`)&&m.type==="html"&&(s[s.length-1]=s[s.length-1].replace(/(\r?\n|\r)$/," "),l=" ",c=n.createTracker(t),c.move(s.join("")));let y=n.handle(m,e,n,{...c.current(),after:d,before:l});u&&u===y.slice(0,1)&&(y=Vt(u.charCodeAt(0))+y.slice(1));const p=n.attentionEncodeSurroundingInfo;n.attentionEncodeSurroundingInfo=void 0,u=void 0,p&&(s.length>0&&p.before&&l===s[s.length-1].slice(-1)&&(s[s.length-1]=s[s.length-1].slice(0,-1)+Vt(l.charCodeAt(0))),p.after&&(u=d)),c.move(y),s.push(y),l=y.slice(-1)}return r.pop(),s.join("")}function Fp(e,n,t){const r=n.indexStack,a=e.children||[],s=n.createTracker(t),o=[];let l=-1;for(r.push(-1);++l<a.length;){const u=a[l];r[r.length-1]=l,o.push(s.move(n.handle(u,e,n,{before:`
`,after:`
`,...s.current()}))),u.type!=="list"&&(n.bulletLastUsed=void 0),l<a.length-1&&o.push(s.move(zp(u,a[l+1],e,n)))}return r.pop(),o.join("")}function zp(e,n,t,r){let a=r.join.length;for(;a--;){const s=r.join[a](e,n,t,r);if(s===!0||s===1)break;if(typeof s=="number")return`
`.repeat(1+s);if(s===!1)return`

<!---->

`}return`

`}const Bp=/\r?\n|\r/g;function Mp(e,n){const t=[];let r=0,a=0,s;for(;s=Bp.exec(e);)o(e.slice(r,s.index)),t.push(s[0]),r=s.index+s[0].length,a++;return o(e.slice(r)),t.join("");function o(l){t.push(n(l,a,!l))}}function qp(e,n,t){const r=(t.before||"")+(n||"")+(t.after||""),a=[],s=[],o={};let l=-1;for(;++l<e.unsafe.length;){const m=e.unsafe[l];if(!Io(e.stack,m))continue;const d=e.compilePattern(m);let y;for(;y=d.exec(r);){const p="before"in m||!!m.atBreak,S="after"in m,$=y.index+(p?y[1].length:0);a.includes($)?(o[$].before&&!p&&(o[$].before=!1),o[$].after&&!S&&(o[$].after=!1)):(a.push($),o[$]={before:p,after:S})}}a.sort(Up);let u=t.before?t.before.length:0;const c=r.length-(t.after?t.after.length:0);for(l=-1;++l<a.length;){const m=a[l];m<u||m>=c||m+1<c&&a[l+1]===m+1&&o[m].after&&!o[m+1].before&&!o[m+1].after||a[l-1]===m-1&&o[m].before&&!o[m-1].before&&!o[m-1].after||(u!==m&&s.push(Rs(r.slice(u,m),"\\")),u=m,/[!-/:-@[-`{-~]/.test(r.charAt(m))&&(!t.encode||!t.encode.includes(r.charAt(m)))?s.push("\\"):(s.push(Vt(r.charCodeAt(m))),u++))}return s.push(Rs(r.slice(u,c),t.after)),s.join("")}function Up(e,n){return e-n}function Rs(e,n){const t=/\\(?=[!-/:-@[-`{-~])/g,r=[],a=[],s=e+n;let o=-1,l=0,u;for(;u=t.exec(s);)r.push(u.index);for(;++o<r.length;)l!==r[o]&&a.push(e.slice(l,r[o])),a.push("\\"),l=r[o];return a.push(e.slice(l)),a.join("")}function Hp(e){const n=e||{},t=n.now||{};let r=n.lineShift||0,a=t.line||1,s=t.column||1;return{move:u,current:o,shift:l};function o(){return{now:{line:a,column:s},lineShift:r}}function l(c){r+=c}function u(c){const m=c||"",d=m.split(/\r?\n|\r/g),y=d[d.length-1];return a+=d.length-1,s=d.length===1?s+y.length:1+y.length+r,m}}function Vp(e,n){const t=n||{},r={associationId:Lp,containerPhrasing:Gp,containerFlow:Kp,createTracker:Hp,compilePattern:$p,enter:s,handlers:{...Ap},handle:void 0,indentLines:Mp,indexStack:[],join:[...Ep],options:{},safe:Yp,stack:[],unsafe:[...Op]};To(r,t),r.options.tightDefinitions&&r.join.push(Qp),r.handle=Po("type",{invalid:Wp,unknown:Jp,handlers:r.handlers});let a=r.handle(e,void 0,r,{before:`
`,after:`
`,now:{line:1,column:1},lineShift:0});return a&&a.charCodeAt(a.length-1)!==10&&a.charCodeAt(a.length-1)!==13&&(a+=`
`),a;function s(o){return r.stack.push(o),l;function l(){r.stack.pop()}}}function Wp(e){throw new Error("Cannot handle value `"+e+"`, expected node")}function Jp(e){const n=e;throw new Error("Cannot handle unknown node `"+n.type+"`")}function Qp(e,n){if(e.type==="definition"&&e.type===n.type)return 0}function Gp(e,n){return Rp(e,this,n)}function Kp(e,n){return Fp(e,this,n)}function Yp(e,n){return qp(this,e,n)}function Xp(e){const n=this;n.compiler=t;function t(r){return Vp(r,{...n.data("settings"),...e,extensions:n.data("toMarkdownExtensions")||[]})}}function Fs(e){if(e)throw e}var yi,zs;function Zp(){if(zs)return yi;zs=1;var e=Object.prototype.hasOwnProperty,n=Object.prototype.toString,t=Object.defineProperty,r=Object.getOwnPropertyDescriptor,a=function(c){return typeof Array.isArray=="function"?Array.isArray(c):n.call(c)==="[object Array]"},s=function(c){if(!c||n.call(c)!=="[object Object]")return!1;var m=e.call(c,"constructor"),d=c.constructor&&c.constructor.prototype&&e.call(c.constructor.prototype,"isPrototypeOf");if(c.constructor&&!m&&!d)return!1;var y;for(y in c);return typeof y>"u"||e.call(c,y)},o=function(c,m){t&&m.name==="__proto__"?t(c,m.name,{enumerable:!0,configurable:!0,value:m.newValue,writable:!0}):c[m.name]=m.newValue},l=function(c,m){if(m==="__proto__")if(e.call(c,m)){if(r)return r(c,m).value}else return;return c[m]};return yi=function u(){var c,m,d,y,p,S,$=arguments[0],K=1,D=arguments.length,X=!1;for(typeof $=="boolean"&&(X=$,$=arguments[1]||{},K=2),($==null||typeof $!="object"&&typeof $!="function")&&($={});K<D;++K)if(c=arguments[K],c!=null)for(m in c)d=l($,m),y=l(c,m),$!==y&&(X&&y&&(s(y)||(p=a(y)))?(p?(p=!1,S=d&&a(d)?d:[]):S=d&&s(d)?d:{},o($,{name:m,newValue:u(X,S,y)})):typeof y<"u"&&o($,{name:m,newValue:y}));return $},yi}var eh=Zp();const xi=yc(eh);function Bi(e){if(typeof e!="object"||e===null)return!1;const n=Object.getPrototypeOf(e);return(n===null||n===Object.prototype||Object.getPrototypeOf(n)===null)&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)}function th(){const e=[],n={run:t,use:r};return n;function t(...a){let s=-1;const o=a.pop();if(typeof o!="function")throw new TypeError("Expected function as last argument, not "+o);l(null,...a);function l(u,...c){const m=e[++s];let d=-1;if(u){o(u);return}for(;++d<a.length;)(c[d]===null||c[d]===void 0)&&(c[d]=a[d]);a=c,m?nh(m,l)(...c):o(null,...c)}}function r(a){if(typeof a!="function")throw new TypeError("Expected `middelware` to be a function, not "+a);return e.push(a),n}}function nh(e,n){let t;return r;function r(...o){const l=e.length>o.length;let u;l&&o.push(a);try{u=e.apply(this,o)}catch(c){const m=c;if(l&&t)throw m;return a(m)}l||(u&&u.then&&typeof u.then=="function"?u.then(s,a):u instanceof Error?a(u):s(u))}function a(o,...l){t||(t=!0,n(o,...l))}function s(o){a(null,o)}}class nt extends Error{constructor(n,t,r){super(),typeof t=="string"&&(r=t,t=void 0);let a="",s={},o=!1;if(t&&("line"in t&&"column"in t?s={place:t}:"start"in t&&"end"in t?s={place:t}:"type"in t?s={ancestors:[t],place:t.position}:s={...t}),typeof n=="string"?a=n:!s.cause&&n&&(o=!0,a=n.message,s.cause=n),!s.ruleId&&!s.source&&typeof r=="string"){const u=r.indexOf(":");u===-1?s.ruleId=r:(s.source=r.slice(0,u),s.ruleId=r.slice(u+1))}if(!s.place&&s.ancestors&&s.ancestors){const u=s.ancestors[s.ancestors.length-1];u&&(s.place=u.position)}const l=s.place&&"start"in s.place?s.place.start:s.place;this.ancestors=s.ancestors||void 0,this.cause=s.cause||void 0,this.column=l?l.column:void 0,this.fatal=void 0,this.file="",this.message=a,this.line=l?l.line:void 0,this.name=Mn(s.place)||"1:1",this.place=s.place||void 0,this.reason=this.message,this.ruleId=s.ruleId||void 0,this.source=s.source||void 0,this.stack=o&&s.cause&&typeof s.cause.stack=="string"?s.cause.stack:"",this.actual=void 0,this.expected=void 0,this.note=void 0,this.url=void 0}}nt.prototype.file="";nt.prototype.name="";nt.prototype.reason="";nt.prototype.message="";nt.prototype.stack="";nt.prototype.column=void 0;nt.prototype.line=void 0;nt.prototype.ancestors=void 0;nt.prototype.cause=void 0;nt.prototype.fatal=void 0;nt.prototype.place=void 0;nt.prototype.ruleId=void 0;nt.prototype.source=void 0;const _t={basename:rh,dirname:ih,extname:ah,join:sh,sep:"/"};function rh(e,n){if(n!==void 0&&typeof n!="string")throw new TypeError('"ext" argument must be a string');Vn(e);let t=0,r=-1,a=e.length,s;if(n===void 0||n.length===0||n.length>e.length){for(;a--;)if(e.codePointAt(a)===47){if(s){t=a+1;break}}else r<0&&(s=!0,r=a+1);return r<0?"":e.slice(t,r)}if(n===e)return"";let o=-1,l=n.length-1;for(;a--;)if(e.codePointAt(a)===47){if(s){t=a+1;break}}else o<0&&(s=!0,o=a+1),l>-1&&(e.codePointAt(a)===n.codePointAt(l--)?l<0&&(r=a):(l=-1,r=o));return t===r?r=o:r<0&&(r=e.length),e.slice(t,r)}function ih(e){if(Vn(e),e.length===0)return".";let n=-1,t=e.length,r;for(;--t;)if(e.codePointAt(t)===47){if(r){n=t;break}}else r||(r=!0);return n<0?e.codePointAt(0)===47?"/":".":n===1&&e.codePointAt(0)===47?"//":e.slice(0,n)}function ah(e){Vn(e);let n=e.length,t=-1,r=0,a=-1,s=0,o;for(;n--;){const l=e.codePointAt(n);if(l===47){if(o){r=n+1;break}continue}t<0&&(o=!0,t=n+1),l===46?a<0?a=n:s!==1&&(s=1):a>-1&&(s=-1)}return a<0||t<0||s===0||s===1&&a===t-1&&a===r+1?"":e.slice(a,t)}function sh(...e){let n=-1,t;for(;++n<e.length;)Vn(e[n]),e[n]&&(t=t===void 0?e[n]:t+"/"+e[n]);return t===void 0?".":oh(t)}function oh(e){Vn(e);const n=e.codePointAt(0)===47;let t=lh(e,!n);return t.length===0&&!n&&(t="."),t.length>0&&e.codePointAt(e.length-1)===47&&(t+="/"),n?"/"+t:t}function lh(e,n){let t="",r=0,a=-1,s=0,o=-1,l,u;for(;++o<=e.length;){if(o<e.length)l=e.codePointAt(o);else{if(l===47)break;l=47}if(l===47){if(!(a===o-1||s===1))if(a!==o-1&&s===2){if(t.length<2||r!==2||t.codePointAt(t.length-1)!==46||t.codePointAt(t.length-2)!==46){if(t.length>2){if(u=t.lastIndexOf("/"),u!==t.length-1){u<0?(t="",r=0):(t=t.slice(0,u),r=t.length-1-t.lastIndexOf("/")),a=o,s=0;continue}}else if(t.length>0){t="",r=0,a=o,s=0;continue}}n&&(t=t.length>0?t+"/..":"..",r=2)}else t.length>0?t+="/"+e.slice(a+1,o):t=e.slice(a+1,o),r=o-a-1;a=o,s=0}else l===46&&s>-1?s++:s=-1}return t}function Vn(e){if(typeof e!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}const ch={cwd:uh};function uh(){return"/"}function Mi(e){return!!(e!==null&&typeof e=="object"&&"href"in e&&e.href&&"protocol"in e&&e.protocol&&e.auth===void 0)}function dh(e){if(typeof e=="string")e=new URL(e);else if(!Mi(e)){const n=new TypeError('The "path" argument must be of type string or an instance of URL. Received `'+e+"`");throw n.code="ERR_INVALID_ARG_TYPE",n}if(e.protocol!=="file:"){const n=new TypeError("The URL must be of scheme file");throw n.code="ERR_INVALID_URL_SCHEME",n}return ph(e)}function ph(e){if(e.hostname!==""){const r=new TypeError('File URL host must be "localhost" or empty on darwin');throw r.code="ERR_INVALID_FILE_URL_HOST",r}const n=e.pathname;let t=-1;for(;++t<n.length;)if(n.codePointAt(t)===37&&n.codePointAt(t+1)===50){const r=n.codePointAt(t+2);if(r===70||r===102){const a=new TypeError("File URL path must not include encoded / characters");throw a.code="ERR_INVALID_FILE_URL_PATH",a}}return decodeURIComponent(n)}const bi=["history","path","basename","stem","extname","dirname"];class hh{constructor(n){let t;n?Mi(n)?t={path:n}:typeof n=="string"||mh(n)?t={value:n}:t=n:t={},this.cwd="cwd"in t?"":ch.cwd(),this.data={},this.history=[],this.messages=[],this.value,this.map,this.result,this.stored;let r=-1;for(;++r<bi.length;){const s=bi[r];s in t&&t[s]!==void 0&&t[s]!==null&&(this[s]=s==="history"?[...t[s]]:t[s])}let a;for(a in t)bi.includes(a)||(this[a]=t[a])}get basename(){return typeof this.path=="string"?_t.basename(this.path):void 0}set basename(n){ki(n,"basename"),wi(n,"basename"),this.path=_t.join(this.dirname||"",n)}get dirname(){return typeof this.path=="string"?_t.dirname(this.path):void 0}set dirname(n){Bs(this.basename,"dirname"),this.path=_t.join(n||"",this.basename)}get extname(){return typeof this.path=="string"?_t.extname(this.path):void 0}set extname(n){if(wi(n,"extname"),Bs(this.dirname,"extname"),n){if(n.codePointAt(0)!==46)throw new Error("`extname` must start with `.`");if(n.includes(".",1))throw new Error("`extname` cannot contain multiple dots")}this.path=_t.join(this.dirname,this.stem+(n||""))}get path(){return this.history[this.history.length-1]}set path(n){Mi(n)&&(n=dh(n)),ki(n,"path"),this.path!==n&&this.history.push(n)}get stem(){return typeof this.path=="string"?_t.basename(this.path,this.extname):void 0}set stem(n){ki(n,"stem"),wi(n,"stem"),this.path=_t.join(this.dirname||"",n+(this.extname||""))}fail(n,t,r){const a=this.message(n,t,r);throw a.fatal=!0,a}info(n,t,r){const a=this.message(n,t,r);return a.fatal=void 0,a}message(n,t,r){const a=new nt(n,t,r);return this.path&&(a.name=this.path+":"+a.name,a.file=this.path),a.fatal=!1,this.messages.push(a),a}toString(n){return this.value===void 0?"":typeof this.value=="string"?this.value:new TextDecoder(n||void 0).decode(this.value)}}function wi(e,n){if(e&&e.includes(_t.sep))throw new Error("`"+n+"` cannot be a path: did not expect `"+_t.sep+"`")}function ki(e,n){if(!e)throw new Error("`"+n+"` cannot be empty")}function Bs(e,n){if(!e)throw new Error("Setting `"+n+"` requires `path` to be set too")}function mh(e){return!!(e&&typeof e=="object"&&"byteLength"in e&&"byteOffset"in e)}const fh=function(e){const r=this.constructor.prototype,a=r[e],s=function(){return a.apply(s,arguments)};return Object.setPrototypeOf(s,r),s},gh={}.hasOwnProperty;class ra extends fh{constructor(){super("copy"),this.Compiler=void 0,this.Parser=void 0,this.attachers=[],this.compiler=void 0,this.freezeIndex=-1,this.frozen=void 0,this.namespace={},this.parser=void 0,this.transformers=th()}copy(){const n=new ra;let t=-1;for(;++t<this.attachers.length;){const r=this.attachers[t];n.use(...r)}return n.data(xi(!0,{},this.namespace)),n}data(n,t){return typeof n=="string"?arguments.length===2?(_i("data",this.frozen),this.namespace[n]=t,this):gh.call(this.namespace,n)&&this.namespace[n]||void 0:n?(_i("data",this.frozen),this.namespace=n,this):this.namespace}freeze(){if(this.frozen)return this;const n=this;for(;++this.freezeIndex<this.attachers.length;){const[t,...r]=this.attachers[this.freezeIndex];if(r[0]===!1)continue;r[0]===!0&&(r[0]=void 0);const a=t.call(n,...r);typeof a=="function"&&this.transformers.use(a)}return this.frozen=!0,this.freezeIndex=Number.POSITIVE_INFINITY,this}parse(n){this.freeze();const t=yr(n),r=this.parser||this.Parser;return Ni("parse",r),r(String(t),t)}process(n,t){const r=this;return this.freeze(),Ni("process",this.parser||this.Parser),ji("process",this.compiler||this.Compiler),t?a(void 0,t):new Promise(a);function a(s,o){const l=yr(n),u=r.parse(l);r.run(u,l,function(m,d,y){if(m||!d||!y)return c(m);const p=d,S=r.stringify(p,y);bh(S)?y.value=S:y.result=S,c(m,y)});function c(m,d){m||!d?o(m):s?s(d):t(void 0,d)}}}processSync(n){let t=!1,r;return this.freeze(),Ni("processSync",this.parser||this.Parser),ji("processSync",this.compiler||this.Compiler),this.process(n,a),qs("processSync","process",t),r;function a(s,o){t=!0,Fs(s),r=o}}run(n,t,r){Ms(n),this.freeze();const a=this.transformers;return!r&&typeof t=="function"&&(r=t,t=void 0),r?s(void 0,r):new Promise(s);function s(o,l){const u=yr(t);a.run(n,u,c);function c(m,d,y){const p=d||n;m?l(m):o?o(p):r(void 0,p,y)}}}runSync(n,t){let r=!1,a;return this.run(n,t,s),qs("runSync","run",r),a;function s(o,l){Fs(o),a=l,r=!0}}stringify(n,t){this.freeze();const r=yr(t),a=this.compiler||this.Compiler;return ji("stringify",a),Ms(n),a(n,r)}use(n,...t){const r=this.attachers,a=this.namespace;if(_i("use",this.frozen),n!=null)if(typeof n=="function")u(n,t);else if(typeof n=="object")Array.isArray(n)?l(n):o(n);else throw new TypeError("Expected usable value, not `"+n+"`");return this;function s(c){if(typeof c=="function")u(c,[]);else if(typeof c=="object")if(Array.isArray(c)){const[m,...d]=c;u(m,d)}else o(c);else throw new TypeError("Expected usable value, not `"+c+"`")}function o(c){if(!("plugins"in c)&&!("settings"in c))throw new Error("Expected usable value but received an empty preset, which is probably a mistake: presets typically come with `plugins` and sometimes with `settings`, but this has neither");l(c.plugins),c.settings&&(a.settings=xi(!0,a.settings,c.settings))}function l(c){let m=-1;if(c!=null)if(Array.isArray(c))for(;++m<c.length;){const d=c[m];s(d)}else throw new TypeError("Expected a list of plugins, not `"+c+"`")}function u(c,m){let d=-1,y=-1;for(;++d<r.length;)if(r[d][0]===c){y=d;break}if(y===-1)r.push([c,...m]);else if(m.length>0){let[p,...S]=m;const $=r[y][1];Bi($)&&Bi(p)&&(p=xi(!0,$,p)),r[y]=[c,p,...S]}}}}const yh=new ra().freeze();function Ni(e,n){if(typeof n!="function")throw new TypeError("Cannot `"+e+"` without `parser`")}function ji(e,n){if(typeof n!="function")throw new TypeError("Cannot `"+e+"` without `compiler`")}function _i(e,n){if(n)throw new Error("Cannot call `"+e+"` on a frozen processor.\nCreate a new processor first, by calling it: use `processor()` instead of `processor`.")}function Ms(e){if(!Bi(e)||typeof e.type!="string")throw new TypeError("Expected node, got `"+e+"`")}function qs(e,n,t){if(!t)throw new Error("`"+e+"` finished async. Use `"+n+"` instead")}function yr(e){return xh(e)?e:new hh(e)}function xh(e){return!!(e&&typeof e=="object"&&"message"in e&&"messages"in e)}function bh(e){return typeof e=="string"||wh(e)}function wh(e){return!!(e&&typeof e=="object"&&"byteLength"in e&&"byteOffset"in e)}const vi=yh().use(Hd).use(Xp).freeze(),kh=e=>{if(!e)return"Unknown Date";try{return new Date(e).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}catch{return"Invalid Date"}},Nh=e=>{switch(e){case"pending":return{text:"Billing Pending",className:"status-badge status-pending"};case"billed":return{text:"Sample Pending",className:"status-badge status-billed"};case"collected":return{text:"Sample Collected",className:"status-badge status-collected"};case"processing":return{text:"Processing",className:"status-badge status-processing"};case"report_ready":return{text:"Report Ready",className:"status-badge status-report_ready"};case"reported":return{text:"Reported",className:"status-badge status-reported"};case"completed":return{text:"Completed",className:"status-badge status-completed"};case"cancelled":return{text:"Cancelled",className:"status-badge status-cancelled"};default:return{text:e,className:"status-badge"}}},jh=({title:e,items:n,renderItemContent:t,headerAction:r,isLoading:a,loadingText:s,noDataText:o,onDeleteItem:l,onEditLabOrder:u,onSaveLabOrder:c,onCancelEditLabOrder:m,onLabOrderTestChange:d,onLabOrderStatusChange:y,onEditPharmacyOrder:p,onPrintUnavailablePrescription:S,onBillLabOrder:$,onUpdateLabOrderStatus:K,onEnterLabReport:D,labInventory:X=[],isSavingLabOrder:z=!1,expandedLabReports:Y={},toggleLabReport:M=()=>{},selectionEnabled:_=!1,selectedIds:ee=new Set,onSelectionChange:je})=>{const se=x.useMemo(()=>{const U={};n.forEach(E=>{if(isNaN(E.date.getTime())){U["Unknown Date"]||(U["Unknown Date"]=[]),U["Unknown Date"].push(E);return}const ge=kh(E.originalDateString);U[ge]||(U[ge]=[]),U[ge].push(E)});const O=Object.keys(U);return O.sort((E,ge)=>{if(E==="Unknown Date")return 1;if(ge==="Unknown Date")return-1;try{const R=new Date(E.split(" ").reverse().join(" ")),Z=new Date(ge.split(" ").reverse().join(" "));if(!isNaN(R.getTime())&&!isNaN(Z.getTime()))return Z.getTime()-R.getTime()}catch{}return ge.localeCompare(E)}),O.map(E=>({date:E,items:U[E]}))},[n]),ue=["pending","billed","collected","processing","report_ready","completed","cancelled","reported"];return i.jsxs("div",{className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsx("h4",{className:"ai-context-section-title mb-2 pb-1",children:e}),r]}),a&&i.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(U=>i.jsxs("div",{style:{padding:"10px",background:"var(--glass-light)",borderRadius:"8px",marginBottom:"8px"},children:[i.jsx(Ie,{width:"80px",height:"14px",style:{marginBottom:"10px"}}),i.jsx(Ie,{width:"100%",height:"16px",style:{marginBottom:"6px"}}),i.jsx(Ie,{width:"70%",height:"14px"})]},U))}),!a&&n.length===0&&i.jsx("p",{className:"ai-context-text italic",children:o}),!a&&n.length>0&&i.jsx("div",{className:"space-y-3",children:se.map(({date:U,items:O})=>i.jsxs("div",{children:[i.jsx("h5",{className:"grouped-history-date",children:U}),i.jsx("div",{className:"space-y-1 grouped-history-item-container",children:O.map((E,ge)=>i.jsxs("div",{className:"grouped-history-item ai-context-item flex flex-col",children:[!(E.type==="Lab Order"&&E.data.isEditing)&&i.jsxs("div",{className:"flex justify-between items-center w-full",children:[_&&je&&E.type==="Pharmacy Order"&&i.jsx("div",{className:"mr-2",children:i.jsx("input",{type:"checkbox",checked:ee.has(E.data.id),onChange:R=>je(E.data.id,R.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),i.jsx("div",{className:"flex-grow mr-2 ai-context-text",children:t(E,ge,Y,M)}),i.jsxs("div",{className:"flex items-center space-x-1",children:[E.type==="Lab Order"&&!E.data.isEditing&&u&&i.jsx("button",{onClick:()=>u(E.data.id),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400",title:"Edit this lab order",disabled:z,children:i.jsx(xt,{size:14})}),E.type==="Lab Order"&&E.data.isEditing&&i.jsx(i.Fragment,{}),E.type==="Lab Order"&&i.jsxs("div",{className:"lab-table-actions",children:[E.data.status==="pending"&&$&&(()=>{const R=E.data.tests.reduce((Z,Q)=>Z+(Number(Q.price)||0),0).toFixed(2);return i.jsx("button",{onClick:()=>$(E.data),className:"text-green-600 hover:text-green-800 p-1 rounded hover:bg-green-100 focus:outline-none focus:ring-1 focus:ring-green-400",title:`Pay total of ₹${R}`,disabled:z,children:i.jsx(ho,{size:14})})})(),E.data.status==="billed"&&K&&i.jsx("button",{onClick:()=>K(E.data.id,"collected"),className:"lab-action-button btn-collect",title:"Collect Sample",children:"Collect"}),E.data.status==="collected"&&K&&i.jsx("button",{onClick:()=>K(E.data.id,"processing"),className:"lab-action-button btn-process",title:"Mark Processing",children:"Process"}),["pending","billed","collected","processing","report_ready","reported","completed"].includes(E.data.status)&&D&&i.jsx("button",{onClick:()=>D(E.data),className:"lab-action-button btn-enter-report",title:"Enter Report",children:"Enter Report"}),(E.data.status==="report_ready"||E.data.status==="reported")&&K&&i.jsx("button",{onClick:()=>K(E.data.id,"completed"),className:"lab-action-button btn-complete",title:"Mark Completed",children:"Complete"})]}),E.type==="Pharmacy Order"&&E.data.status==="pending"&&p&&i.jsx("button",{onClick:()=>p(E.data.id),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400",title:"Edit this pharmacy order",disabled:z,children:i.jsx(xt,{size:14})}),E.type==="Pharmacy Order"&&E.data.prescriptionForUnavailableDrugs&&S&&i.jsx("button",{onClick:()=>S(E.data.prescriptionForUnavailableDrugs,`Prescription for Order ${E.data.id}`),className:"text-purple-600 hover:text-purple-800 p-1 rounded hover:bg-purple-100 focus:outline-none focus:ring-1 focus:ring-purple-400",title:"Print Prescription for Unavailable Drugs",disabled:z,children:i.jsx(zn,{size:14})}),E.type==="Pharmacy Order"&&E.data.status==="pending"&&l&&i.jsx("button",{onClick:()=>l({type:E.type,data:E.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400",title:"Delete this pending pharmacy order",disabled:z,children:i.jsx(bt,{size:14})}),l&&["Complaint","Lab Order","Lab Report"].includes(E.type)&&i.jsx("button",{onClick:()=>l({type:E.type,data:E.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400",title:`Delete this ${E.type.toLowerCase()}`,disabled:z,children:i.jsx(bt,{size:14})})]})]}),E.type==="Lab Order"&&E.data.isEditing&&i.jsxs("div",{className:"lab-order-edit-form w-full bg-gray-50 border rounded-md p-3",children:[i.jsxs("div",{className:"flex justify-between items-center mb-3",children:[i.jsx("h6",{className:"text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Edit Order"}),i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Status:"}),i.jsx("select",{value:E.data.editedStatus||E.data.status,onChange:R=>y&&y(E.data.id,R.target.value),className:"form-select text-xs py-1 pl-2 pr-6 rounded border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50",disabled:z,children:ue.map(R=>i.jsx("option",{value:R,children:R.replace(/_/g," ")},R))})]})]}),i.jsx("div",{className:"overflow-hidden border rounded-md bg-white mb-3",children:i.jsxs("table",{className:"w-full text-xs text-left",children:[i.jsx("thead",{className:"bg-gray-100 border-b",children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-2 px-3 font-medium text-gray-600",children:"Test Name"}),i.jsx("th",{className:"py-2 px-3 text-right font-medium text-gray-600 w-20",children:"Price"}),i.jsx("th",{className:"py-2 px-3 w-10"})]})}),i.jsxs("tbody",{className:"divide-y divide-gray-100",children:[E.data.editedTests.map((R,Z)=>i.jsxs("tr",{className:"hover:bg-gray-50",children:[i.jsx("td",{className:"py-1 px-3",children:i.jsxs("select",{value:R.id,onChange:Q=>{const Pe=X.find(le=>String(le.id)===Q.target.value);Pe&&(d&&d(E.data.id,Z,"id",Pe.id),d&&d(E.data.id,Z,"name",Pe.name),d&&d(E.data.id,Z,"price",Pe.price))},className:"form-select w-full text-xs border-0 bg-transparent focus:ring-0 p-0",disabled:z,children:[i.jsx("option",{value:"",children:"Select Test"}),X.map(Q=>i.jsx("option",{value:Q.id,children:Q.name},Q.id))]})}),i.jsxs("td",{className:"py-1 px-3 text-right text-gray-700",children:["₹",R.price]}),i.jsx("td",{className:"py-1 px-3 text-center",children:i.jsx("button",{onClick:()=>{const Q=E.data.editedTests.filter((Pe,le)=>le!==Z);d&&d(E.data.id,-1,"remove",Q)},className:"text-red-400 hover:text-red-600 focus:outline-none",title:"Remove test",disabled:z,children:i.jsx(bt,{size:12})})})]},Z)),E.data.editedTests.length===0&&i.jsx("tr",{children:i.jsx("td",{colSpan:3,className:"py-2 px-3 text-center italic text-gray-400",children:"No tests selected"})})]}),i.jsx("tfoot",{className:"bg-gray-50 border-t",children:i.jsx("tr",{children:i.jsx("td",{colSpan:3,className:"py-1 px-3",children:i.jsx("button",{onClick:()=>{d&&d(E.data.id,-1,"add",{id:"",name:"",price:0})},className:"text-blue-600 hover:text-blue-800 text-xs font-medium flex items-center py-1",disabled:z,children:"+ Add Test"})})})})]})}),i.jsxs("div",{className:"flex justify-end space-x-2 border-t border-gray-200 pt-3 mt-1",children:[i.jsx("button",{onClick:()=>m&&m(E.data.id),className:"px-3 py-1.5 rounded text-xs text-gray-600 hover:bg-white hover:text-gray-800 border border-transparent hover:border-gray-200 transition-colors",disabled:z,children:"Cancel"}),i.jsx("button",{onClick:()=>c&&c(E.data.id,E.data.editedTests,E.data.editedStatus),className:"px-3 py-1.5 rounded text-xs bg-blue-600 text-white hover:bg-blue-700 shadow-sm flex items-center space-x-1 transition-colors",disabled:z,children:z?i.jsx("span",{children:"Saving..."}):i.jsxs(i.Fragment,{children:[i.jsx(oo,{size:12}),i.jsx("span",{children:"Save Changes"})]})})]})]})]},`${E.type}-${E.originalDateString}-${ge}`))})]},U))})]})},Si=Di.memo(jh),_h="_modalOverlay_i1kv7_3",vh="_modalContent_i1kv7_29",Sh="_modalHeader_i1kv7_63",Ch="_modalTitle_i1kv7_81",Ph="_modalCloseButton_i1kv7_95",Th="_modalBody_i1kv7_123",Ih="_errorText_i1kv7_141",Ah="_formGroup_i1kv7_159",Eh="_inputField_i1kv7_185",Dh="_searchResultsCard_i1kv7_229",Oh="_searchResultsList_i1kv7_257",Lh="_searchResultItem_i1kv7_269",$h="_searchResultPrice_i1kv7_305",Rh="_selectedTestsCard_i1kv7_315",Fh="_selectedTestsHeader_i1kv7_335",zh="_noTestsMessage_i1kv7_353",Bh="_selectedTestsList_i1kv7_369",Mh="_selectedTestItem_i1kv7_381",qh="_selectedTestName_i1kv7_405",Uh="_selectedTestPrice_i1kv7_417",Hh="_removeTestButton_i1kv7_429",Vh="_totalAmount_i1kv7_455",Wh="_modalFooter_i1kv7_473",Jh="_button_i1kv7_499",Qh="_buttonPrimary_i1kv7_517",Gh="_buttonSecondary_i1kv7_539",Le={modalOverlay:_h,modalContent:vh,modalHeader:Sh,modalTitle:Ch,modalCloseButton:Ph,modalBody:Th,errorText:Ih,formGroup:Ah,inputField:Eh,searchResultsCard:Dh,searchResultsList:Oh,searchResultItem:Lh,searchResultPrice:$h,selectedTestsCard:Rh,selectedTestsHeader:Fh,noTestsMessage:zh,selectedTestsList:Bh,selectedTestItem:Mh,selectedTestName:qh,selectedTestPrice:Uh,removeTestButton:Hh,totalAmount:Vh,modalFooter:Wh,button:Jh,buttonPrimary:Qh,buttonSecondary:Gh},Kh=({isOpen:e,onClose:n,patientId:t,labInventory:r,fetchPendingLabOrdersData:a,isLoadingInventory:s=!1})=>{const[o,l]=x.useState([]),[u,c]=x.useState(""),[m,d]=x.useState([]),[y,p]=x.useState(null),[S,$]=x.useState(!1);lo(void 0,e?200:99999);const K=x.useMemo(()=>new co(r,{keys:["name","description"],threshold:.3}),[r]);x.useEffect(()=>{if(!u){d([]);return}const Y=K.search(u).map(M=>M.item);d(Y.slice(0,10))},[u,K]);const D=async()=>{if(!t){p("Patient ID is missing.");return}if(o.length===0){p("Please select at least one lab test.");return}$(!0),p(null);try{const Y={patient_id:t,tests:o.map(_=>({id:_.id,name:_.name,price:_.price}))},M=await W("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Y)});if(!M.ok){const _=await M.json().catch(()=>({}));throw new Error(_.message||`Failed to create lab order: ${M.statusText}`)}await M.json(),a(t),n(),l([]),c("")}catch(Y){p(`Lab Order Creation Error: ${Y.message}`)}finally{$(!1)}},X=Y=>{if(o.some(M=>M.id===Y.id)){p(`${Y.name} is already in the order.`),setTimeout(()=>p(null),3e3),c(""),d([]);return}l(M=>[...M,{...Y}]),c(""),d([])},z=Y=>{l(M=>M.filter(_=>_.id!==Y))};return e?i.jsx("div",{className:Le.modalOverlay,children:i.jsxs("div",{className:Le.modalContent,children:[i.jsxs("div",{className:Le.modalHeader,children:[i.jsx("h3",{className:Le.modalTitle,children:"Create New Lab Order"}),i.jsx("button",{onClick:n,className:Le.modalCloseButton,children:i.jsx(Xt,{size:20})})]}),i.jsxs("div",{className:Le.modalBody,children:[y&&i.jsx("div",{className:Le.errorText,children:y}),i.jsxs("div",{className:Le.formGroup,style:{position:"relative"},children:[i.jsx("label",{htmlFor:"lab-test-search",children:"Add Lab Test"}),i.jsx("input",{type:"text",id:"lab-test-search",placeholder:"Search available lab tests...",value:u,onChange:Y=>c(Y.target.value),className:Le.inputField}),u&&i.jsx("div",{className:Le.searchResultsCard,children:s?i.jsx("div",{className:"p-2 space-y-2",children:[1,2,3].map(Y=>i.jsxs("div",{className:"flex justify-between items-center py-2 px-3",children:[i.jsx(Ie,{width:"60%",height:20}),i.jsx(Ie,{width:"20%",height:20})]},Y))}):m.length>0?i.jsx("ul",{className:Le.searchResultsList,children:m.map(Y=>i.jsxs("li",{onClick:()=>X(Y),className:Le.searchResultItem,children:[i.jsx("span",{children:Y.name}),i.jsxs("span",{className:Le.searchResultPrice,children:["(₹",parseFloat(String(Y.price)).toFixed(2),")"]})]},Y.id))}):i.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No tests found."})})]}),i.jsxs("div",{className:Le.selectedTestsCard,children:[i.jsx("h4",{className:Le.selectedTestsHeader,children:"Selected Tests"}),o.length===0?i.jsx("p",{className:Le.noTestsMessage,children:"No tests added yet."}):i.jsx("ul",{className:Le.selectedTestsList,children:o.map(Y=>i.jsxs("li",{className:Le.selectedTestItem,children:[i.jsx("span",{className:Le.selectedTestName,children:Y.name}),i.jsxs("span",{className:Le.selectedTestPrice,children:["₹",parseFloat(String(Y.price)).toFixed(2)]}),i.jsx("button",{type:"button",onClick:()=>z(String(Y.id)),className:Le.removeTestButton,title:"Remove Test",children:i.jsx(bt,{size:16})})]},Y.id))})]}),o.length>0&&i.jsxs("div",{className:Le.totalAmount,children:["Total: ₹",o.reduce((Y,M)=>Y+parseFloat(String(M.price)),0).toFixed(2)]})]}),i.jsxs("div",{className:Le.modalFooter,children:[i.jsx("button",{type:"button",onClick:n,className:`${Le.button} ${Le.buttonSecondary}`,children:" Cancel "}),i.jsxs("button",{type:"button",onClick:D,disabled:o.length===0||S,className:`${Le.button} ${Le.buttonPrimary} ${o.length===0||S?Le.buttonDisabled:""}`,children:[" ",S?"Saving...":"Create Lab Order"," "]})]})]})}):null},Ci=e=>{if(!e)return 1;const n=e.match(/(?:\d+x)?(\d+)(?:s|tabs)?/i);return n?parseInt(n[1],10):1},Yh=x.forwardRef((e,n)=>{const{recordId:t,patientId:r,patientDetails:a,caseSummary:s,caseSummaryUpdatedAt:o,clinicSettings:l,userMessages:u,selectedImageFile:c,pendingLabOrders:m,labReports:d,pastComplaints:y,pharmacyOrders:p,pharmacyInventory:S,labInventory:$,recurringMedications:K,currentComplaint:D,setCurrentComplaint:X,setAiResponse:z,setAiResponseText:Y,setAiResponseJsonString:M,setShowAiJsonDetails:_,setIsLoadingAi:ee,setAiError:je,setIsSubmittingAiOrder:se,setAiOrderSubmissionStatus:ue,setIsSubmittingAiLabOrder:U,setAiLabOrderSubmissionStatus:O,setIsSubmittingAiComplaint:E,setAiComplaintSubmissionStatus:ge,setIsUpdatingCaseSummary:R,setAiCaseSummaryUpdateStatus:Z,setCaseSummary:Q,setIsUpdatingAiMemoryByAI:Pe,setAiMemoryUpdateByAIStatus:le,setFollowUpQuestion:w,setFollowUpOptions:ze,setError:_e,setIsSavingAiResponse:b,setSaveAiResponseError:qe,fetchPharmacyOrdersData:Ue,fetchPendingLabOrdersData:ke,fetchLabReportsData:Ge,fetchRecurringMedicationsData:De,fetchPastComplaintsData:it,fetchPatientDetails:lt,setClinicSettings:ct,setEditedAiMemory:en,setCanUndo:tn,onAiActionSuccess:nn,addMessage:j,onPrintLabBill:Ct,onPrintPharmacyBill:mt,onPrintCustomBill:ft}=e,[Qe,Pt]=Di.useState(null);Di.useEffect(()=>{tn(!!Qe)},[Qe,tn]);let Rt;const Ft=async(F,ne,H,P=0)=>{let ye;const Be=["AI response did not contain a recognized function call","AI response did not result in a recognized or performed function call"].some(Ke=>{var Ce;return(Ce=ne.message)==null?void 0:Ce.includes(Ke)});H&&Be?ye=`AI Error: ${ne.message}

${H}`:(ye=`I encountered a frontend error while trying to execute the '${F}' function. The error message is: "${ne.message}". Based on this error, please analyze what went wrong and either correct the function call and try again, or explain the problem.`,(F==="create_pharmacy_order"||F==="edit_pharmacy_order")&&(ye+=`

IMPORTANT: When ordering medication, please first check if the medication ordered matches the exact name given in the inventory. If the name itself is not given in the inventory, you can use 'prescription_for_unavailable_drugs' to write a prescription. **NOTE:** This field MUST be formatted as a Markdown table (columns: Drug Name, Quantity, Dosage, Directions).`),H&&(ye+=`

The original AI response that caused the error was:
\`\`\`
${H}
\`\`\``)),j==null||j({role:"system",type:"error",content:`AI Error: ${ne.message}. Retrying...`}),await Rt(ye,P+1)},Je=async F=>{console.log("Executing Rollback for actions:",F);for(const ne of F){const{actionType:H,undoData:P}=ne;if(console.log(`Attempting to rollback ${H}`,P),!P){console.warn(`No undoData found for action ${H}, skipping.`);continue}try{if(H==="create_pharmacy_order")P!=null&&P.orderId?(console.log(`Deleting pharmacy order ${P.orderId}`),await W(`/api/pharmacy-orders/${P.orderId}`,{method:"DELETE"}),Ue(r)):console.error("Missing orderId for create_pharmacy_order rollback");else if(H==="create_lab_order")P!=null&&P.orderId?(console.log(`Deleting lab order ${P.orderId}`),await W(`/api/lab/orders/${P.orderId}`,{method:"DELETE"}),ke(r)):console.error("Missing orderId for create_lab_order rollback");else if(H==="update_patient_details")if(P!=null&&P.patientId&&(P!=null&&P.originalDetails)){console.log(`Reverting patient details for ${P.patientId}`);const ye=P.originalDetails,Te={name:ye.name,age:ye.age,gender:ye.gender,phone:ye.phone,ai_response:ye.ai_response};await W(`/api/patients/${P.patientId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(Te)}),lt(P.patientId)}else console.error("Missing patientId or originalDetails for update_patient_details rollback");else if(H==="add_complaint_history")P!=null&&P.recordId?(console.log(`Reverting complaint history for ${P.recordId}`),await W(`/api/queue/doctor/complaint/${P.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:P.originalComplaint||""})}),X(P.originalComplaint||"")):console.error("Missing recordId for add_complaint_history rollback");else if(H==="update_case_summary")P!=null&&P.recordId?(console.log(`Reverting case summary for ${P.recordId}`),await W(`/api/queue/doctor/complaint/${P.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({case_summary:P.originalSummary||""})}),Q(P.originalSummary||"")):console.error("Missing recordId for update_case_summary rollback");else if(H==="update_clinic_ai_memory")(P==null?void 0:P.originalMemory)!==void 0?(console.log("Reverting AI memory"),await W("/api/clinics/settings",{method:"PUT",body:JSON.stringify({...l,aiMemory:P.originalMemory})}),en(P.originalMemory)):console.error("Missing originalMemory for update_clinic_ai_memory rollback");else if(H==="edit_pharmacy_order")if(P!=null&&P.orderId&&(P!=null&&P.originalState)){console.log(`Reverting pharmacy order ${P.orderId}`);const ye={items:P.originalState.medications||[],status:P.originalState.status,prescription_for_unavailable_drugs:P.originalState.prescription_for_unavailable_drugs,order_total:P.originalState.order_total};await W(`/api/pharmacy-orders/${P.orderId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ye)}),Ue(r)}else console.error("Missing orderId or originalState for edit_pharmacy_order rollback");else if(H==="edit_lab_order")if(P!=null&&P.orderId&&(P!=null&&P.originalState)){console.log(`Reverting lab order ${P.orderId}`);const ye={tests:P.originalState.tests,status:P.originalState.status};await W(`/api/lab/orders/${P.orderId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ye)}),ke(r)}else console.error("Missing orderId or originalState for edit_lab_order rollback");else if(H==="create_recurring_medication_order")if(P!=null&&P.createdIds&&P.createdIds.length>0){console.log(`Deleting recurring medications: ${P.createdIds.join(", ")}`);for(const ye of P.createdIds)await W(`/api/recurring-medications/${ye}`,{method:"DELETE"});r&&De&&De(r)}else console.error("Missing createdIds for create_recurring_medication_order rollback");else H==="edit_recurring_medication_order"?P!=null&&P.medicationId&&(P!=null&&P.originalState)?(console.log(`Reverting recurring medication ${P.medicationId}`),await W(`/api/recurring-medications/${P.medicationId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(P.originalState)}),r&&De&&De(r)):console.error("Missing medicationId or originalState for edit_recurring_medication_order rollback"):H==="create_custom_bill"&&(P!=null&&P.billId?(console.log(`Reverting custom bill ${P.billId}`),await W(`/api/bills/${P.billId}`,{method:"DELETE"})):console.error("Missing billId for create_custom_bill rollback"))}catch(ye){console.error(`Failed to rollback ${H}:`,ye)}}},Tt=async()=>{!Qe||!window.confirm("Are you sure you want to undo the last AI actions?")||(ee(!0),await Je([...Qe].reverse()),Pt(null),ee(!1),je("Last actions undone successfully."))},wt=async(F,ne)=>{Pt(null),ue(null),O(null),ge(null),Z(null),le(null),w(null),ze([]),_e(null);let H=null;const P=/```json\s*([\s\S]*?)\s*```/,ye=F.match(P);if(ye&&ye[1])H=ye[1];else{const Te=F.trim();if(Te.startsWith("{")&&Te.endsWith("}"))H=Te;else if(Te.startsWith("[")&&Te.endsWith("]"))H=Te;else throw new Error("AI response did not contain a recognized function call.")}if(H)try{const Te=JSON.parse(H),Be=v=>{const L=[],C=Array.isArray(v)?v:[v];for(const I of C)I&&(I.actions&&Array.isArray(I.actions)?L.push(...Be(I.actions)):I.sub_actions&&Array.isArray(I.sub_actions)?L.push(...Be(I.sub_actions)):I.function_calls&&Array.isArray(I.function_calls)?L.push(...Be(I.function_calls)):typeof I.action=="string"&&L.push(I));return L},Ke=Be(Te),Ce=[];let Fe=null,Ye=!1;for(const v of Ke){if(v.action==="ask_followup_question"){Fe=v,Ye=!0;continue}Ye=!0;const L=v.action;if(console.log("AiFunctionCaller processing action:",L),L==="create_custom_bill")Ce.push((async()=>{ee(!0),j==null||j({role:"system",type:"loading",content:"Creating custom bill..."});try{if(!r)throw new Error("Missing patient ID.");let C=[],I=0;if(v.items&&Array.isArray(v.items)&&v.items.length>0)C=v.items.map(G=>({name:G.name||"Custom Item",quantity:Number(G.quantity)||1,price:Number(G.price)||0,total:(Number(G.quantity)||1)*(Number(G.price)||0)})),I=C.reduce((G,Ne)=>G+Ne.total,0);else{const G=Number(v.amount)||0;C=[{name:v.description||"Custom Charge",quantity:1,price:G,total:G}],I=G}const ie={amount:I,type:"other",status:"paid",paymentMode:v.payment_mode||"cash",patientId:r,items:C},te=await W("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ie)});if(!te.ok)throw new Error("Failed to create bill.");const A=await te.json();return ft&&ft({billId:A.id,patientName:(a==null?void 0:a.name)||"Patient",patientToken:(a==null?void 0:a.patient_token_number)||"",orderDate:new Date().toISOString(),items:C,subtotal:I,totalDiscount:0,grandTotal:I,clinicName:(l==null?void 0:l.name)||"",clinicAddress:(l==null?void 0:l.address)||"",clinicNotes:(l==null?void 0:l.notes)||"",clinicUpiId:(l==null?void 0:l.upi_id)||""}),j==null||j({role:"system",type:"success",content:`Custom bill created for ₹${I}.`}),{success:!0,actionType:L,data:A,undoData:{billId:A.id}}}catch(C){return j==null||j({role:"system",type:"error",content:`Create custom bill failed: ${C.message}`}),{success:!1,actionType:L,error:C,originalActionPayload:v}}finally{ee(!1)}})());else if(L==="update_clinic_ai_memory"&&typeof v.memory_content=="string")Ce.push((async()=>{Pe(!0),le("Processing AI mem..."),j==null||j({role:"system",type:"loading",content:"Processing AI memory..."});const C=(l==null?void 0:l.aiMemory)||"";try{if(!l)throw new Error("Clinic settings not loaded.");const I={...l,aiMemory:v.memory_content.trim(),admissionCharge:l.admissionCharge,perDayCharge:l.perDayCharge,otherCharges:l.otherCharges,clinicWideSystemPrompt:l.clinicWideSystemPrompt},ie=await W("/api/clinics/settings",{method:"PUT",body:JSON.stringify(I)});if(!ie.ok){const A=await ie.json().catch(()=>({}));throw new Error(A.message||`AI-triggered clinic memory update failed: ${ie.statusText}`)}const te=await ie.json();return ct(A=>A?{...A,aiMemory:te.settings.aiMemory}:null),en(te.settings.aiMemory||""),le("AI mem updated!"),j==null||j({role:"system",type:"success",content:"AI memory updated successfully."}),{success:!0,actionType:L,undoData:{originalMemory:C}}}catch(I){return le("Failed"),{success:!1,actionType:L,error:I,originalActionPayload:v}}finally{Pe(!1)}})());else if(L==="create_pharmacy_order")Ce.push((async()=>{var C,I;se(!0),ue("Processing order..."),j==null||j({role:"system",type:"loading",content:"Processing pharmacy order..."});try{if(!r)throw new Error("Missing patient ID.");const ie=[];let te=null;if(Array.isArray(v.items))for(const ae of v.items){let de;if(ae.drug_id?de=S.find(Ae=>Ae.id===ae.drug_id):ae.name&&(de=$t(ae.name,S)),!de){te=`Drug "${ae.name||ae.drug_id}" not found.`;break}const he=Ci(de.pack),B=Number(de.mrp),J=B,xe=he>0?B/he:0,Ve=Number(ae.pack_quantity)||0,ce=Number(ae.loose_quantity)||0,Se=Ve*J+ce*xe;ie.push({drug_id:String(de.id),name:de.name,pack_quantity:Ve,loose_quantity:ce,tabletsPerDay:ae.tabletsPerDay,numberOfDays:ae.numberOfDays,directions_to_use:ae.directions_to_use,group_id:ae.group_id,pack_price:J,loose_price:xe,total_price:Se,price:B,isLoose:ae.isLoose,unit:de.pack})}if(te)throw new Error(te);const A=ie.reduce((ae,de)=>ae+de.total_price,0),G={patient_id:r,items:ie,prescription_for_unavailable_drugs:v.prescription_for_unavailable_drugs,order_total:parseFloat(A.toFixed(2))},Ne=await W("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(G)});if(!Ne.ok){const ae=await Ne.json().catch(()=>({}));throw new Error(ae.message||"Order creation failed.")}const fe=await Ne.json();return ue("Order created!"),Ue(r),j==null||j({role:"system",type:"success",content:"Pharmacy order created successfully."}),{success:!0,actionType:L,data:fe,undoData:{orderId:((I=(C=fe.orders)==null?void 0:C[0])==null?void 0:I.id)||fe.id}}}catch(ie){return j==null||j({role:"system",type:"error",content:`Pharmacy order failed: ${ie.message}`}),{success:!1,actionType:L,error:ie,originalActionPayload:v}}finally{se(!1)}})());else if(L==="bill_pharmacy_order")Ce.push((async()=>{se(!0),ue("Billing Pharmacy Order...");try{const C=v.serialNumber;if(!C)throw new Error("Missing serial number for billing.");if(!r)throw new Error("Missing patient ID.");const I=new Map;(p??[]).forEach(B=>I.set(B.id,{...B}));const ie=Array.from(I.values()).sort((B,J)=>new Date(J.date).getTime()-new Date(B.date).getTime()),te=ie.length-C,A=ie[te];if(!A)throw new Error(`Pharmacy order #${C} not found.`);if(A.status==="billed"||A.status==="dispensed")throw new Error(`Order #${C} is already billed.`);const G=A.medications.map(B=>{let J;B.drug_id?J=S.find(Xe=>String(Xe.id)===String(B.drug_id)):J=S.find(Xe=>Xe.name.toLowerCase()===B.name.toLowerCase());const xe=Number(B.pack_price)||Number(J==null?void 0:J.mrp)||0,Ve=Ci(B.unit||(J==null?void 0:J.pack)),ce=Number(B.loose_price)||(Ve>0?xe/Ve:0),Se=(B.pack_quantity||0)*Ve+(B.loose_quantity||0);let Ae=Number(B.total_price);return Ae||(Ae=Se*ce),{...B,price:Ae,mrp:xe,pack_quantity:B.pack_quantity,loose_quantity:B.loose_quantity,expiry_date:B.expiry_date||(J==null?void 0:J.expiry_date),batch:B.batch||(J==null?void 0:J.box_number)}}),Ne=G.reduce((B,J)=>B+J.price,0),fe=Ne,ae={patientId:r,queueId:A.id,items:G.map(B=>({name:B.name,pack_quantity:B.pack_quantity,loose_quantity:B.loose_quantity,price:B.mrp,pack_price:B.mrp,loose_price:B.loose_price,total:B.price,drug_id:B.drug_id,discount_percentage:0,batch:B.batch,expiry_date:B.expiry_date})),amount:fe,paymentMode:"cash",type:"pharmacy",related_id:A.id,status:"paid",discountPercentage:0},de=await W("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)}),he=await de.json();if(!de.ok)throw new Error(he.message||"Failed to create pharmacy bill");return await W(`/api/pharmacy-orders/${A.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:he.id,medications:G})}),ue("Billed Successfully!"),Ue(r),mt&&mt({billId:he.id,patientName:(a==null?void 0:a.name)||"Patient",patientToken:(a==null?void 0:a.patient_token_number)||"",orderDate:A.date,items:G,subtotal:Ne,totalDiscount:0,grandTotal:fe,clinicName:(l==null?void 0:l.name)||"",clinicAddress:(l==null?void 0:l.address)||"",clinicNotes:(l==null?void 0:l.notes)||"",clinicUpiId:(l==null?void 0:l.upi_id)||""}),j==null||j({role:"system",type:"success",content:`Pharmacy order #${A.id} billed.`}),{success:!0,actionType:L,data:he}}catch(C){return j==null||j({role:"system",type:"error",content:`Billing failed: ${C.message}`}),{success:!1,actionType:L,error:C,originalActionPayload:v}}finally{se(!1)}})());else if(L==="create_and_bill_pharmacy_order")Ce.push((async()=>{se(!0),ue("Processing & Billing..."),j==null||j({role:"system",type:"loading",content:"Prescribing and billing..."});let C=null;try{if(!r)throw new Error("Missing patient ID.");const I=[];let ie=null;if(Array.isArray(v.items))for(const J of v.items){let xe;if(J.drug_id?xe=S.find(It=>It.id===J.drug_id):J.name&&(xe=$t(J.name,S)),!xe){ie=`Drug "${J.name}" not found.`;break}const Ve=Ci(xe.pack),ce=Number(xe.mrp),Se=ce,Ae=Ve>0?ce/Ve:0,Xe=Number(J.pack_quantity)||0,Ze=Number(J.loose_quantity)||0,gt=Xe*Se+Ze*Ae;I.push({drug_id:String(xe.id),name:xe.name,pack_quantity:Xe,loose_quantity:Ze,tabletsPerDay:J.tabletsPerDay,numberOfDays:J.numberOfDays,directions_to_use:J.directions_to_use,group_id:J.group_id,pack_price:Se,loose_price:Ae,total_price:gt,price:ce,mrp:ce,isLoose:J.isLoose,unit:xe.pack,batch:xe.box_number,expiry_date:xe.expiry_date})}if(ie)throw new Error(ie);const te=I.reduce((J,xe)=>J+xe.total_price,0),A={patient_id:r,items:I,prescription_for_unavailable_drugs:v.prescription_for_unavailable_drugs,order_total:parseFloat(te.toFixed(2))},G=await W("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(A)});if(!G.ok)throw new Error("Order creation failed.");const Ne=await G.json(),fe=Ne.orders?Ne.orders[0]:Ne;C=fe.id;const ae=te,de={patientId:r,queueId:fe.id,items:I.map(J=>({name:J.name,pack_quantity:J.pack_quantity,loose_quantity:J.loose_quantity,price:J.mrp,pack_price:J.mrp,loose_price:J.loose_price,total:J.total_price,drug_id:J.drug_id,discount_percentage:0,batch:J.batch,expiry_date:J.expiry_date})),amount:ae,paymentMode:"cash",type:"pharmacy",related_id:fe.id,status:"paid",discountPercentage:0},he=await W("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(de)}),B=await he.json();if(!he.ok)throw new Error("Billing failed.");return await W(`/api/pharmacy-orders/${fe.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:B.id,medications:I})}),ue("Ordered & Billed!"),Ue(r),mt&&mt({billId:B.id,patientName:(a==null?void 0:a.name)||"Patient",patientToken:(a==null?void 0:a.patient_token_number)||"",orderDate:new Date().toISOString(),items:I.map(J=>({...J,price:J.total_price})),subtotal:ae,totalDiscount:0,grandTotal:ae,clinicName:(l==null?void 0:l.name)||"",clinicAddress:(l==null?void 0:l.address)||"",clinicNotes:(l==null?void 0:l.notes)||"",clinicUpiId:(l==null?void 0:l.upi_id)||""}),j==null||j({role:"system",type:"success",content:`Pharmacy order #${fe.id} created and billed.`}),{success:!0,actionType:L,data:fe,undoData:{orderId:fe.id}}}catch(I){return j==null||j({role:"system",type:"error",content:`Create & Bill failed: ${I.message}`}),{success:!1,actionType:L,error:I,originalActionPayload:v,undoData:C?{orderId:C}:void 0}}finally{se(!1)}})());else if(L==="create_custom_bill")Ce.push((async()=>{ee(!0),j==null||j({role:"system",type:"loading",content:"Creating custom bill..."});try{if(!r)throw new Error("Missing patient ID.");let C=[],I=0;if(v.items&&Array.isArray(v.items)&&v.items.length>0)C=v.items.map(G=>({name:G.name||"Custom Item",quantity:Number(G.quantity)||1,price:Number(G.price)||0,total:(Number(G.quantity)||1)*(Number(G.price)||0)})),I=C.reduce((G,Ne)=>G+Ne.total,0);else{const G=Number(v.amount)||0;C=[{name:v.description||"Custom Charge",quantity:1,price:G,total:G}],I=G}const ie={amount:I,type:"other",status:"paid",paymentMode:v.payment_mode||"cash",patientId:r,items:C},te=await W("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ie)});if(!te.ok)throw new Error("Failed to create bill.");const A=await te.json();return ft&&ft({billId:A.id,patientName:(a==null?void 0:a.name)||"Patient",patientToken:(a==null?void 0:a.patient_token_number)||"",orderDate:new Date().toISOString(),items:C.map(G=>({name:G.name,price:G.price,quantity:G.quantity,total_price:G.total})),subtotal:I,totalDiscount:0,grandTotal:I,clinicName:(l==null?void 0:l.name)||"",clinicAddress:(l==null?void 0:l.address)||"",clinicNotes:(l==null?void 0:l.notes)||"",clinicUpiId:(l==null?void 0:l.upi_id)||""}),j==null||j({role:"system",type:"success",content:`Custom bill created for ₹${I}.`}),{success:!0,actionType:L,data:A,undoData:{billId:A.id}}}catch(C){return j==null||j({role:"system",type:"error",content:`Create custom bill failed: ${C.message}`}),{success:!1,actionType:L,error:C,originalActionPayload:v}}finally{ee(!1)}})());else if(L==="update_patient_details")Ce.push((async()=>{ee(!0),j==null||j({role:"system",type:"loading",content:"Updating patient details..."});const C={...a};try{if(!r)throw new Error("Missing patient ID.");const I={};if(v.name&&(I.name=v.name),v.age&&(I.age=v.age),v.gender&&(I.gender=v.gender),v.phone_number!==void 0&&(I.phone_number=v.phone_number),!(await W(`/api/patients/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(I)})).ok)throw new Error("Patient update failed.");return lt(r),j==null||j({role:"system",type:"success",content:"Patient details updated."}),{success:!0,actionType:L,undoData:{patientId:r,originalDetails:C}}}catch(I){return{success:!1,actionType:L,error:I,originalActionPayload:v}}finally{ee(!1)}})());else if(L==="create_lab_order")Ce.push((async()=>{U(!0),O("Processing lab..."),j==null||j({role:"system",type:"loading",content:"Processing lab order..."});try{if(!r)throw new Error("Missing patient ID.");const C=[];for(const te of v.tests||[]){let A;if(te.id?A=$.find(G=>String(G.id)===String(te.id)):te.name&&(A=$t(te.name,$)),!A)throw new Error(`Lab test "${te.name}" not found.`);C.push({id:A.id,name:A.name,price:Number(A.price)})}const I=await W("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:r,tests:C})});if(!I.ok)throw new Error("Lab order creation failed.");const ie=await I.json();return O("Success!"),ke(r),j==null||j({role:"system",type:"success",content:"Lab order created."}),{success:!0,actionType:L,data:ie.labOrder,undoData:{orderId:ie.labOrder.id}}}catch(C){return j==null||j({role:"system",type:"error",content:`Lab order failed: ${C.message}`}),{success:!1,actionType:L,error:C,originalActionPayload:v}}finally{U(!1)}})());else if(L==="create_and_bill_lab_order")Ce.push((async()=>{U(!0),O("Processing & Billing..."),j==null||j({role:"system",type:"loading",content:"Creating and billing lab order..."});let C=null;try{if(!r)throw new Error("Missing patient ID.");const I=[];for(const B of v.tests||[]){let J;if(B.id?J=$.find(xe=>String(xe.id)===String(B.id)):B.name&&(J=$t(B.name,$)),!J)throw new Error(`Lab test "${B.name}" not found.`);I.push({id:J.id,name:J.name,price:Number(J.price)})}const ie=await W("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:r,tests:I})});if(!ie.ok)throw new Error("Lab order creation failed.");const A=(await ie.json()).labOrder;C=A.id,j==null||j({role:"system",type:"loading",content:`Order #${A.id} created. Generating bill...`});const G=I.map(B=>({name:B.name,price:typeof B.price=="string"?parseFloat(B.price):B.price||0,discount_percentage:0,quantity:1,item_id:B.id,type:"lab_test"})),Ne=G.reduce((B,J)=>B+J.price,0),fe=Ne,ae={patientId:r,items:G.map(B=>({...B,total:B.price})),amount:fe,paymentMode:"cash",type:"lab",related_id:A.id,status:"paid",discountPercentage:0},de=await W("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)}),he=await de.json();if(!de.ok)throw new Error(he.message||"Failed to create bill");return await W(`/api/lab/${A.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:he.id})}),O("Success & Billed!"),ke(r),Ct&&Ct({billId:he.id,patientName:(a==null?void 0:a.name)||"Patient",patientToken:(a==null?void 0:a.patient_token_number)||"",orderDate:A.createdAt,items:G,subtotal:Ne,totalDiscount:0,grandTotal:fe,clinicName:(l==null?void 0:l.name)||"",clinicAddress:(l==null?void 0:l.address)||"",clinicNotes:(l==null?void 0:l.notes)||"",clinicUpiId:(l==null?void 0:l.upi_id)||"",labLetterheadUrl:l==null?void 0:l.labLetterheadUrl}),j==null||j({role:"system",type:"success",content:`Lab order #${A.id} created and billed. Opening print dialog.`}),{success:!0,actionType:L,data:A,undoData:{orderId:A.id}}}catch(I){return j==null||j({role:"system",type:"error",content:`Create and Bill failed: ${I.message}`}),{success:!1,actionType:L,error:I,originalActionPayload:v,undoData:C?{orderId:C}:void 0}}finally{U(!1)}})());else if(L==="create_lab_report")Ce.push((async()=>{U(!0),O("Creating Report..."),j==null||j({role:"system",type:"loading",content:"Creating lab report..."});try{if(!r)throw new Error("Missing patient ID.");const C=[],I=v.tests||[];for(const fe of I){let ae;if(fe.id?ae=$.find(de=>String(de.id)===String(fe.id)):fe.name&&(ae=$t(fe.name,$)),!ae)throw new Error(`Lab test "${fe.name}" not found.`);fe._matchedTest=ae,C.push({id:ae.id,name:ae.name,price:Number(ae.price)})}const ie=await W("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:r,tests:C,status:"reported"})});if(!ie.ok)throw new Error("Lab order creation failed during report generation.");const te=await ie.json(),A=te.labOrder.id,G={};if(I.forEach(fe=>{const ae=fe._matchedTest,de=ae.id,he=fe.parameters||[],B={},J=ae.default_parameters||[];for(const xe of J){const Ve=he.find(ce=>{if(!ce.name)return!1;if(ce.name.toLowerCase()===xe.name.toLowerCase())return!0;const Se=ce.name.toLowerCase(),Ae=xe.name.toLowerCase();return Se.includes(Ae)||Ae.includes(Se)});Ve&&Ve.value!==void 0?B[xe.name]=Ve.value:xe.defaultValue!==void 0&&xe.defaultValue!==null&&(B[xe.name]=xe.defaultValue)}G[de]=B}),!(await W(`/api/lab/${A}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(G)})})).ok)throw new Error("Report submission failed.");return O("Report Created!"),ke(r),Ge(r),j==null||j({role:"system",type:"success",content:"Lab report created successfully."}),{success:!0,actionType:L,data:te.labOrder,undoData:{orderId:A}}}catch(C){return j==null||j({role:"system",type:"error",content:`Lab report failed: ${C.message}`}),{success:!1,actionType:L,error:C,originalActionPayload:v}}finally{U(!1)}})());else if(L==="edit_lab_report")Ce.push((async()=>{U(!0),O("Updating Report...");try{const C=v.serialNumber;if(!C)throw new Error("Missing serial number for lab report edit.");const I=new Map;(m??[]).forEach(he=>I.set(he.id,{...he})),(d??[]).forEach(he=>{if(I.has(he.id)){const B=I.get(he.id);B.report=he,B.status=he.status}else I.set(he.id,{...he,createdAt:he.createdAt})});const ie=Array.from(I.values());ie.sort((he,B)=>new Date(B.createdAt).getTime()-new Date(he.createdAt).getTime());const te=ie.length-C,A=ie[te];if(!A)throw new Error(`Lab report #${C} not found.`);const G=A.id;let Ne={};if(A.report&&A.report.report_content)try{Ne=typeof A.report.report_content=="string"?JSON.parse(A.report.report_content):A.report.report_content}catch{}const fe={...Ne};if((v.tests||[]).forEach(he=>{let J=(A.tests||[]).find(Ae=>Ae.name.toLowerCase()===he.name.toLowerCase());if(!J)return;const xe=J.id,Ve=he.parameters||[],ce=$.find(Ae=>String(Ae.id)===String(xe)),Se=(ce==null?void 0:ce.default_parameters)||[];fe[xe]||(fe[xe]={});for(const Ae of Se){const Xe=Ve.find(Ze=>{if(!Ze.name)return!1;if(Ze.name.toLowerCase()===Ae.name.toLowerCase())return!0;const gt=Ze.name.toLowerCase(),It=Ae.name.toLowerCase();return gt.includes(It)||It.includes(gt)});Xe&&Xe.value!==void 0&&(fe[xe][Ae.name]=Xe.value)}}),!(await W(`/api/lab/${G}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(fe)})})).ok)throw new Error("Report update failed.");return O("Report Updated!"),ke(r),Ge(r),j==null||j({role:"system",type:"success",content:"Lab report updated successfully."}),{success:!0,actionType:L,data:{orderId:G},undoData:{orderId:G}}}catch(C){return j==null||j({role:"system",type:"error",content:`Update report failed: ${C.message}`}),{success:!1,actionType:L,error:C,originalActionPayload:v}}finally{U(!1)}})());else if(L==="edit_lab_order_and_create_report")Ce.push((async()=>{U(!0),O("Updating Order & Report..."),j==null||j({role:"system",type:"loading",content:"Updating lab order and report..."});try{const C=v.serialNumber;if(!C)throw new Error("Missing serial number.");const I=new Map;(m??[]).forEach(ce=>I.set(ce.id,{...ce})),(d??[]).forEach(ce=>{if(I.has(ce.id)){const Se=I.get(ce.id);Se.report=ce,Se.status=ce.status}else I.set(ce.id,{...ce,createdAt:ce.createdAt})});const ie=Array.from(I.values());ie.sort((ce,Se)=>new Date(Se.createdAt).getTime()-new Date(ce.createdAt).getTime());const te=ie.length-C,A=ie[te];if(!A)throw new Error(`Lab order #${C} not found.`);const G=A.id,Ne=JSON.parse(JSON.stringify(A));let fe=[];for(const ce of A.tests||[]){const Se=$.find(Ae=>String(Ae.id)===String(ce.id));Se?fe.push({id:Se.id,name:Se.name,price:Number(Se.price)}):fe.push({id:ce.id,name:ce.name,price:Number(ce.price)||0})}if(v.items_to_remove&&Array.isArray(v.items_to_remove)){const ce=v.items_to_remove;fe=fe.filter(Se=>!ce.some(Ae=>Ae.id&&String(Ae.id)===String(Se.id)||Ae.name&&Se.name.toLowerCase()===Ae.name.toLowerCase()))}const ae=v.tests||[],de={};for(const ce of ae){let Se;if(ce.id?Se=$.find(at=>String(at.id)===String(ce.id)):ce.name&&(Se=$t(ce.name,$)),!Se)throw new Error(`Lab test "${ce.name}" not found.`);fe.findIndex(at=>String(at.id)===String(Se.id))===-1&&fe.push({id:Se.id,name:Se.name,price:Number(Se.price)});const Xe=Se.id,Ze=ce.parameters||[],gt={},It=Se.default_parameters||[];for(const at of It){const bn=Ze.find(wn=>{if(!wn.name)return!1;if(wn.name.toLowerCase()===at.name.toLowerCase())return!0;const Qn=wn.name.toLowerCase(),Gn=at.name.toLowerCase();return Qn.includes(Gn)||Gn.includes(Qn)});bn&&bn.value!==void 0?gt[at.name]=bn.value:at.defaultValue!==void 0&&(gt[at.name]=at.defaultValue)}de[Xe]=gt}const he={tests:fe};console.log("[DEBUG] edit_lab_order_and_create_report - Order Update Payload:",JSON.stringify(he,null,2)),console.log("[DEBUG] Items to remove:",v.items_to_remove),console.log("[DEBUG] Original tests:",A.tests);const B=await W(`/api/lab/orders/${G}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(he)});if(console.log("[DEBUG] Order update response status:",B.status),!B.ok){const ce=await B.json().catch(()=>({}));throw console.error("[DEBUG] Order update failed:",ce),new Error(`Failed to update lab order tests: ${ce.message||B.statusText}`)}let J={};if(A.report&&A.report.report_content)try{J=typeof A.report.report_content=="string"?JSON.parse(A.report.report_content):A.report.report_content}catch{}const xe={...J,...de};if(!(await W(`/api/lab/${G}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(xe)})})).ok)throw new Error("Failed to create/update lab report.");return O("Order & Report Updated!"),ke(r),Ge(r),j==null||j({role:"system",type:"success",content:"Lab order and report updated successfully."}),{success:!0,actionType:L,undoData:{orderId:G,originalState:Ne}}}catch(C){return j==null||j({role:"system",type:"error",content:`Failed to edit order and report: ${C.message}`}),{success:!1,actionType:L,error:C,originalActionPayload:v}}finally{U(!1)}})());else if(L==="edit_pharmacy_order")Ce.push((async()=>{se(!0);try{const C=v.serialNumber;let I;if(C?I=[...p].sort((de,he)=>new Date(de.date).getTime()-new Date(he.date).getTime())[C-1]:I=p.find(ae=>ae.status==="pending"),!I)throw new Error("Order to edit not found.");const ie=JSON.parse(JSON.stringify(I));let te=[...I.medications];const A=v.items_to_remove,G=v.items;if(Array.isArray(A)&&(te=te.filter(ae=>!A.some(de=>de.drug_id&&String(ae.drug_id)===String(de.drug_id)||de.name&&ae.name.toLowerCase()===de.name.toLowerCase()))),Array.isArray(G))for(const ae of G){let de;if(ae.drug_id?de=S.find(J=>String(J.id)===String(ae.drug_id)):ae.name&&(de=$t(ae.name,S)),!de)throw new Error(`Drug ${ae.name} not found.`);const he=te.findIndex(J=>J.drug_id===String(de==null?void 0:de.id)),B={drug_id:String(de.id),name:de.name,pack_quantity:ae.pack_quantity||0,loose_quantity:ae.loose_quantity||0,pack_price:Number(de.mrp),loose_price:0,total_price:0,price:Number(de.mrp)};he>=0?te[he]={...te[he],...B}:te.push(B)}const Ne={items:te,status:v.status,prescription_for_unavailable_drugs:v.prescription_for_unavailable_drugs,order_total:0};if(!(await W(`/api/pharmacy-orders/${I.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(Ne)})).ok)throw new Error("Order edit failed.");return Ue(r),{success:!0,actionType:L,undoData:{orderId:I.id,originalState:ie}}}catch(C){return{success:!1,actionType:L,error:C,originalActionPayload:v}}finally{se(!1)}})());else if(L==="edit_lab_order")Ce.push((async()=>{U(!0);try{const C=m.sort((A,G)=>new Date(G.createdAt).getTime()-new Date(A.createdAt).getTime()).find(A=>A.status==="pending");if(!C)throw new Error("No pending lab order to edit.");const I=JSON.parse(JSON.stringify(C)),ie={tests:[],status:v.status};if(!(await W(`/api/lab/orders/${C.id}`,{method:"PUT",body:JSON.stringify(ie),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Lab edit failed.");return ke(r),{success:!0,actionType:L,undoData:{orderId:C.id,originalState:I}}}catch(C){return{success:!1,actionType:L,error:C,originalActionPayload:v}}finally{U(!1)}})());else if(L==="add_complaint_history")Ce.push((async()=>{E(!0),j==null||j({role:"system",type:"loading",content:"Updating complaint history..."});const C=D;try{if(!t)throw new Error("No record ID.");if(!(await W(`/api/queue/doctor/complaint/${t}`,{method:"PUT",body:JSON.stringify({complaint:v.complaint}),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Complaint update failed.");return X(v.complaint),r&&it(r),j==null||j({role:"system",type:"success",content:"Complaint history updated."}),{success:!0,actionType:L,undoData:{recordId:t,originalComplaint:C}}}catch(I){return j==null||j({role:"system",type:"error",content:`Complaint history update failed: ${I.message}`}),{success:!1,actionType:L,error:I,originalActionPayload:v}}finally{E(!1)}})());else if(L==="update_case_summary")Ce.push((async()=>{R(!0),j==null||j({role:"system",type:"loading",content:"Updating case summary..."});const C=s;try{if(!t)throw new Error("No record ID.");const I=await W(`/api/queue/doctor/complaint/${t}`,{method:"PUT",body:JSON.stringify({case_summary:v.summary}),headers:{"Content-Type":"application/json"}});if(!I.ok)throw new Error("Summary update failed.");const ie=await I.json();return Q(ie.case_summary),j==null||j({role:"system",type:"success",content:"Case summary updated."}),{success:!0,actionType:L,undoData:{recordId:t,originalSummary:C}}}catch(I){return j==null||j({role:"system",type:"error",content:`Case summary update failed: ${I.message}`}),{success:!1,actionType:L,error:I,originalActionPayload:v}}finally{R(!1)}})());else if(L==="create_recurring_medication_order")Ce.push((async()=>{se(!0),ue("Creating recurring medication(s)..."),j==null||j({role:"system",type:"loading",content:"Creating recurring medication(s)..."});try{if(!r)throw new Error("Missing patient ID.");if(!v.items||!Array.isArray(v.items))throw new Error("No items provided for recurring medication order.");const C=await Promise.all(v.items.map(async A=>{let G=A.drug_id;if(!G){const Ne=$t(A.medication_name,S);G=Ne?Ne.id:null}if(!G)throw new Error(`Drug "${A.medication_name}" not found in inventory for recurring medication.`);return{...A,drug_id:G}})),I=await W("/api/recurring-medications",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:r,items:C})});if(!I.ok){const A=await I.json().catch(()=>({}));throw new Error(A.message||"Failed to create recurring medication order")}const ie=await I.json(),te=ie.map(A=>A.id);return r&&De&&De(r),ue("Recurring medication(s) created."),j==null||j({role:"system",type:"success",content:`Successfully created ${te.length} recurring medication(s).`}),{success:!0,actionType:L,data:ie,undoData:{createdIds:te}}}catch(C){return j==null||j({role:"system",type:"error",content:`Error creating recurring medication: ${C.message}`}),{success:!1,actionType:L,error:C,originalActionPayload:v}}finally{se(!1)}})());else if(L==="edit_recurring_medication_order")Ce.push((async()=>{se(!0),ue("Updating recurring medication..."),j==null||j({role:"system",type:"loading",content:"Updating recurring medication..."});try{if(!r)throw new Error("Missing patient ID.");if(!v.serialNumber||!v.updates)throw new Error("Missing serialNumber or updates for recurring medication edit.");if(!K||K.length===0)throw new Error("No recurring medications found to edit.");const C=v.serialNumber-1;if(C<0||C>=K.length)throw new Error(`Recurring medication with serial number ${v.serialNumber} not found.`);const I=K[C],ie=JSON.parse(JSON.stringify(I));if(v.updates.drug_id===null||v.updates.medication_name){let A=v.updates.drug_id;if(!A&&v.updates.medication_name){const G=$t(v.updates.medication_name,S);A=G?G.id:null}if(!A&&v.updates.medication_name)throw new Error(`Drug "${v.updates.medication_name}" not found in inventory for update.`);v.updates.drug_id=A}const te=await W(`/api/recurring-medications/${I.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(v.updates)});if(!te.ok){const A=await te.json().catch(()=>({}));throw new Error(A.message||"Failed to update recurring medication")}return r&&De&&De(r),ue("Recurring medication updated."),j==null||j({role:"system",type:"success",content:`Successfully updated recurring medication #${v.serialNumber}.`}),{success:!0,actionType:L,data:{id:I.id,...v.updates},undoData:{medicationId:I.id,originalState:ie}}}catch(C){return j==null||j({role:"system",type:"error",content:`Error updating recurring medication: ${C.message}`}),{success:!1,actionType:L,error:C,originalActionPayload:v}}finally{se(!1)}})());else if(L==="end_task")Ce.push((async()=>(j==null||j({role:"system",type:"success",content:"Task completed."}),{success:!0,actionType:L}))());else{if(L==="bill_lab_order")continue;console.warn(`Unknown action ${L}`),Ce.push(Promise.resolve({success:!1,actionType:L,error:new Error(`Unknown action: ${L}`),originalActionPayload:v}))}}const He=await Promise.all(Ce),re=He.filter(v=>!v.success);if(re.length>0){console.log("AI Actions Failed. Initiating Rollback...",re);const v=He.filter(te=>te.success),L=[...v].reverse();await Je(L);const C=re.map(te=>{var A;return`${te.actionType}: ${(A=te.error)==null?void 0:A.message}`}).join("; "),I=v.length>0?` I successfully rolled back ${v.length} other actions that succeeded.`:"",ie=`One or more actions failed: [${C}].${I} Please analyze the failure and try again.`;await Ft("multiple_actions",{message:ie},F,ne)}else{const v=He.filter(C=>C.success);v.length>0&&(Pt(v),nn&&v.forEach(C=>nn(C.actionType)));const L=Ke.find(C=>C.action==="bill_lab_order");if(L&&L.serialNumber){const C=new Map;(m??[]).forEach(A=>C.set(A.id,{...A}));const I=Array.from(C.values());I.sort((A,G)=>new Date(G.createdAt).getTime()-new Date(A.createdAt).getTime());const ie=I.length-L.serialNumber,te=I[ie];if(te&&te.id){j==null||j({role:"system",type:"success",content:`Processing billing for Lab Order #${L.serialNumber}...`});try{const A=te.tests.map(B=>({name:B.test_name||B.name,price:typeof B.price=="string"?parseFloat(B.price):B.price||0,discount_percentage:0,quantity:1,item_id:B.test_id||B.id,type:"lab_test"})),G=A.reduce((B,J)=>B+J.price,0),Ne=0,fe=G,ae={patientId:te.patient_id,items:A.map(B=>({...B,total:B.price})),amount:fe,paymentMode:"cash",type:"lab",related_id:te.id,status:"paid",discountPercentage:0},de=await W("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)}),he=await de.json();if(!de.ok)throw new Error(he.message||"Failed to create bill");await W(`/api/lab/${te.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:he.id})}),r&&ke(r),Ct&&(Ct({billId:he.id,patientName:(a==null?void 0:a.name)||"Patient",patientToken:(a==null?void 0:a.patient_token_number)||"",orderDate:te.createdAt,items:A,subtotal:G,totalDiscount:Ne,grandTotal:fe,clinicName:(l==null?void 0:l.name)||"",clinicAddress:(l==null?void 0:l.address)||"",clinicNotes:(l==null?void 0:l.notes)||"",clinicUpiId:(l==null?void 0:l.upi_id)||"",labLetterheadUrl:l==null?void 0:l.labLetterheadUrl}),j==null||j({role:"system",type:"success",content:`Bill #${he.id} created. Opening print dialog.`}))}catch(A){console.error("Auto-billing failed:",A),j==null||j({role:"system",type:"error",content:`Billing failed: ${A.message}`})}}else console.warn(`Could not find lab order with serialNumber ${L.serialNumber} to bill.`),j==null||j({role:"system",type:"error",content:`Could not find lab order #${L.serialNumber} to bill.`})}if(Fe&&typeof Fe.question=="string")w(Fe.question),ze(Array.isArray(Fe.options)?Fe.options:[]);else if(v.length===0&&!L&&!Ye)throw new Error("AI response did not result in a recognized or performed function call.")}}catch(Te){await Ft("parse_json_actions",Te,F,ne)}else throw new Error("AI response did not contain a recognized function call.")};Rt=async(F,ne=0)=>{if(ne>1){je("AI call failed after multiple retries. Please try a different prompt."),ee(!1);return}ee(!0),je(null);let H;const ye=[...u,F].join(`

`);try{const Te=new Map;(m??[]).forEach(re=>{Te.set(re.id,{...re})}),(d??[]).forEach(re=>{if(!Te.has(re.id))Te.set(re.id,{id:re.id,patient_id:re.patient_id,tests:re.tests,status:re.status,createdAt:re.createdAt,report:re});else{const v=Te.get(re.id);v&&(v.report=re,v.status=re.status)}});const Be=Array.from(Te.values());Be.sort((re,v)=>new Date(v.createdAt).getTime()-new Date(re.createdAt).getTime());const Ke=Be.map((re,v)=>{let L=null;if(re.report)try{const C=typeof re.report.report_content=="string"?re.report.report_content:JSON.stringify(re.report.report_content||{}),I=JSON.parse(C||"{}"),ie=te=>{const A=I[te.id]||{},G=Ne=>({name:Ne.name,value:A[Ne.name]!==void 0?String(A[Ne.name]):String(Ne.defaultValue),normal_range:Ne.normal_range||"N/A"});return{testId:te.id,testName:te.name,parameters:(te.default_parameters||[]).map(G)}};L={reportId:re.report.reportId,reportDate:re.report.report_date,tests:(re.tests||[]).map(ie)}}catch{L={reportId:re.report.reportId,reportDate:re.report.report_date,reportContent:typeof re.report.report_content=="string"?re.report.report_content:JSON.stringify(re.report.report_content),error:"Failed to parse report content JSON."}}return{serialNumber:Be.length-v,orderId:re.id,orderDate:isNaN(new Date(re.createdAt).getTime())?re.createdAt:new Date(re.createdAt).toISOString(),tests:re.tests.map(C=>({id:C.id,name:C.name,price:C.price})),status:re.status,report:L}}),Ce=y.map(re=>{try{return{...re,createdAt:isNaN(new Date(re.createdAt).getTime())?re.createdAt:new Date(re.createdAt).toISOString()}}catch{return re}}),Ye=[...p].sort((re,v)=>{const L=new Date(re.date).getTime(),C=new Date(v.date).getTime();return L-C}).map((re,v)=>{try{return{serialNumber:v+1,...re,date:re.date&&!isNaN(new Date(re.date).getTime())?new Date(re.date).toISOString():re.date}}catch{return{serialNumber:v+1,...re}}}),He={query:ye,currentDateTime:new Date().toISOString(),patientName:(a==null?void 0:a.name)||"",patientAge:(a==null?void 0:a.age)||void 0,patientGender:(a==null?void 0:a.gender)||void 0,case_summary:s||"",case_summary_last_updated:o?new Date(o).toISOString():void 0,clinic_ai_memory:(l==null?void 0:l.aiMemory)||"",clinic_ai_memory_last_updated:l!=null&&l.aiMemoryUpdatedAt?new Date(l.aiMemoryUpdatedAt).toISOString():void 0,clinic_wide_system_prompt:(l==null?void 0:l.clinicWideSystemPrompt)||"",labHistory:Ke,pharmacyOrders:Ye,pastComplaints:Ce,pharmacyInventory:S,labInventory:$,recurringMedications:K};if(console.log("DEBUG: Payload before sending to Gemini API:",JSON.stringify(He,null,2)),H=await xc(He,c),H){z(H),j==null||j({role:"ai",content:H});const re=/```json\s*([\s\S]*?)\s*```/,v=H.match(re);if(v&&v[1])Y(H.replace(re,"").trim()),M(v[1].trim());else{const L=H.trim();if(L.startsWith("{")&&L.endsWith("}"))try{JSON.parse(L),Y(""),M(L)}catch{Y(L),M(null)}else if(L.startsWith("[")&&L.endsWith("]"))try{JSON.parse(L),Y(""),M(L)}catch{Y(L),M(null)}else Y(L),M(null)}_(!1),r&&H&&await T(r,H),await wt(H,ne),X("")}else throw new Error("Invalid AI response format.")}catch(Te){await Ft("call_generative_api",Te,H,ne)}finally{ee(!1)}};const T=async(F,ne)=>{b(!0),qe(null);try{const H={ai_response:ne},P=await W(`/api/patients/${F}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(H)});if(!P.ok){const ye=await P.json().catch(()=>({}));throw new Error(ye.message||`Failed to save AI response to patient: ${P.statusText}`)}}catch(H){qe(`AI Response Save Error: ${H.message}`),j==null||j({role:"system",type:"error",content:`AI Response Save Error: ${H.message}`})}finally{b(!1)}};return x.useImperativeHandle(n,()=>({callGenerativeApi:Rt,undoLastAction:Tt})),null}),Ho=-1,Ir=0,qn=1,Cr=2,ia=3,aa=4,sa=5,oa=6,Vo=7,Wo=8,Us=typeof self=="object"?self:globalThis,Xh=(e,n)=>{const t=(a,s)=>(e.set(s,a),a),r=a=>{if(e.has(a))return e.get(a);const[s,o]=n[a];switch(s){case Ir:case Ho:return t(o,a);case qn:{const l=t([],a);for(const u of o)l.push(r(u));return l}case Cr:{const l=t({},a);for(const[u,c]of o)l[r(u)]=r(c);return l}case ia:return t(new Date(o),a);case aa:{const{source:l,flags:u}=o;return t(new RegExp(l,u),a)}case sa:{const l=t(new Map,a);for(const[u,c]of o)l.set(r(u),r(c));return l}case oa:{const l=t(new Set,a);for(const u of o)l.add(r(u));return l}case Vo:{const{name:l,message:u}=o;return t(new Us[l](u),a)}case Wo:return t(BigInt(o),a);case"BigInt":return t(Object(BigInt(o)),a);case"ArrayBuffer":return t(new Uint8Array(o).buffer,o);case"DataView":{const{buffer:l}=new Uint8Array(o);return t(new DataView(l),o)}}return t(new Us[s](o),a)};return r},Hs=e=>Xh(new Map,e)(0),hn="",{toString:Zh}={},{keys:em}=Object,Fn=e=>{const n=typeof e;if(n!=="object"||!e)return[Ir,n];const t=Zh.call(e).slice(8,-1);switch(t){case"Array":return[qn,hn];case"Object":return[Cr,hn];case"Date":return[ia,hn];case"RegExp":return[aa,hn];case"Map":return[sa,hn];case"Set":return[oa,hn];case"DataView":return[qn,t]}return t.includes("Array")?[qn,t]:t.includes("Error")?[Vo,t]:[Cr,t]},xr=([e,n])=>e===Ir&&(n==="function"||n==="symbol"),tm=(e,n,t,r)=>{const a=(o,l)=>{const u=r.push(o)-1;return t.set(l,u),u},s=o=>{if(t.has(o))return t.get(o);let[l,u]=Fn(o);switch(l){case Ir:{let m=o;switch(u){case"bigint":l=Wo,m=o.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+u);m=null;break;case"undefined":return a([Ho],o)}return a([l,m],o)}case qn:{if(u){let y=o;return u==="DataView"?y=new Uint8Array(o.buffer):u==="ArrayBuffer"&&(y=new Uint8Array(o)),a([u,[...y]],o)}const m=[],d=a([l,m],o);for(const y of o)m.push(s(y));return d}case Cr:{if(u)switch(u){case"BigInt":return a([u,o.toString()],o);case"Boolean":case"Number":case"String":return a([u,o.valueOf()],o)}if(n&&"toJSON"in o)return s(o.toJSON());const m=[],d=a([l,m],o);for(const y of em(o))(e||!xr(Fn(o[y])))&&m.push([s(y),s(o[y])]);return d}case ia:return a([l,o.toISOString()],o);case aa:{const{source:m,flags:d}=o;return a([l,{source:m,flags:d}],o)}case sa:{const m=[],d=a([l,m],o);for(const[y,p]of o)(e||!(xr(Fn(y))||xr(Fn(p))))&&m.push([s(y),s(p)]);return d}case oa:{const m=[],d=a([l,m],o);for(const y of o)(e||!xr(Fn(y)))&&m.push(s(y));return d}}const{message:c}=o;return a([l,{name:u,message:c}],o)};return s},Vs=(e,{json:n,lossy:t}={})=>{const r=[];return tm(!(n||t),!!n,new Map,r)(e),r},Un=typeof structuredClone=="function"?(e,n)=>n&&("json"in n||"lossy"in n)?Hs(Vs(e,n)):structuredClone(e):(e,n)=>Hs(Vs(e,n)),Jo=Go("end"),Qo=Go("start");function Go(e){return n;function n(t){const r=t&&t.position&&t.position[e]||{};if(typeof r.line=="number"&&r.line>0&&typeof r.column=="number"&&r.column>0)return{line:r.line,column:r.column,offset:typeof r.offset=="number"&&r.offset>-1?r.offset:void 0}}}function Ko(e){const n=Qo(e),t=Jo(e);if(n&&t)return{start:n,end:t}}const Kt=["ariaDescribedBy","ariaLabel","ariaLabelledBy"],Ws={ancestors:{tbody:["table"],td:["table"],th:["table"],thead:["table"],tfoot:["table"],tr:["table"]},attributes:{a:[...Kt,"dataFootnoteBackref","dataFootnoteRef",["className","data-footnote-backref"],"href"],blockquote:["cite"],code:[["className",/^language-./]],del:["cite"],div:["itemScope","itemType"],dl:[...Kt],h2:[["className","sr-only"]],img:[...Kt,"longDesc","src"],input:[["disabled",!0],["type","checkbox"]],ins:["cite"],li:[["className","task-list-item"]],ol:[...Kt,["className","contains-task-list"]],q:["cite"],section:["dataFootnotes",["className","footnotes"]],source:["srcSet"],summary:[...Kt],table:[...Kt],ul:[...Kt,["className","contains-task-list"]],"*":["abbr","accept","acceptCharset","accessKey","action","align","alt","axis","border","cellPadding","cellSpacing","char","charOff","charSet","checked","clear","colSpan","color","cols","compact","coords","dateTime","dir","encType","frame","hSpace","headers","height","hrefLang","htmlFor","id","isMap","itemProp","label","lang","maxLength","media","method","multiple","name","noHref","noShade","noWrap","open","prompt","readOnly","rev","rowSpan","rows","rules","scope","selected","shape","size","span","start","summary","tabIndex","title","useMap","vAlign","value","width"]},clobber:["ariaDescribedBy","ariaLabelledBy","id","name"],clobberPrefix:"user-content-",protocols:{cite:["http","https"],href:["http","https","irc","ircs","mailto","xmpp"],longDesc:["http","https"],src:["http","https"]},required:{input:{disabled:!0,type:"checkbox"}},strip:["script"],tagNames:["a","b","blockquote","br","code","dd","del","details","div","dl","dt","em","h1","h2","h3","h4","h5","h6","hr","i","img","input","ins","kbd","li","ol","p","picture","pre","q","rp","rt","ruby","s","samp","section","source","span","strike","strong","sub","summary","sup","table","tbody","td","tfoot","th","thead","tr","tt","ul","var"]},Ht={}.hasOwnProperty;function nm(e,n){let t={type:"root",children:[]};const r={schema:n?{...Ws,...n}:Ws,stack:[]},a=Yo(r,e);return a&&(Array.isArray(a)?a.length===1?t=a[0]:t.children=a:t=a),t}function Yo(e,n){if(n&&typeof n=="object"){const t=n;switch(typeof t.type=="string"?t.type:""){case"comment":return rm(e,t);case"doctype":return im(e,t);case"element":return am(e,t);case"root":return sm(e,t);case"text":return om(e,t)}}}function rm(e,n){if(e.schema.allowComments){const t=typeof n.value=="string"?n.value:"",r=t.indexOf("-->"),s={type:"comment",value:r<0?t:t.slice(0,r)};return Wn(s,n),s}}function im(e,n){if(e.schema.allowDoctypes){const t={type:"doctype"};return Wn(t,n),t}}function am(e,n){const t=typeof n.tagName=="string"?n.tagName:"";e.stack.push(t);const r=Xo(e,n.children),a=lm(e,n.properties);e.stack.pop();let s=!1;if(t&&t!=="*"&&(!e.schema.tagNames||e.schema.tagNames.includes(t))&&(s=!0,e.schema.ancestors&&Ht.call(e.schema.ancestors,t))){const l=e.schema.ancestors[t];let u=-1;for(s=!1;++u<l.length;)e.stack.includes(l[u])&&(s=!0)}if(!s)return e.schema.strip&&!e.schema.strip.includes(t)?r:void 0;const o={type:"element",tagName:t,properties:a,children:r};return Wn(o,n),o}function sm(e,n){const r={type:"root",children:Xo(e,n.children)};return Wn(r,n),r}function om(e,n){const r={type:"text",value:typeof n.value=="string"?n.value:""};return Wn(r,n),r}function Xo(e,n){const t=[];if(Array.isArray(n)){const r=n;let a=-1;for(;++a<r.length;){const s=Yo(e,r[a]);s&&(Array.isArray(s)?t.push(...s):t.push(s))}}return t}function lm(e,n){const t=e.stack[e.stack.length-1],r=e.schema.attributes,a=e.schema.required,s=r&&Ht.call(r,t)?r[t]:void 0,o=r&&Ht.call(r,"*")?r["*"]:void 0,l=n&&typeof n=="object"?n:{},u={};let c;for(c in l)if(Ht.call(l,c)){const m=l[c];let d=Js(e,Qs(s,c),c,m);d==null&&(d=Js(e,Qs(o,c),c,m)),d!=null&&(u[c]=d)}if(a&&Ht.call(a,t)){const m=a[t];for(c in m)Ht.call(m,c)&&!Ht.call(u,c)&&(u[c]=m[c])}return u}function Js(e,n,t,r){return n?Array.isArray(r)?cm(e,n,t,r):Zo(e,n,t,r):void 0}function cm(e,n,t,r){let a=-1;const s=[];for(;++a<r.length;){const o=Zo(e,n,t,r[a]);(typeof o=="number"||typeof o=="string")&&s.push(o)}return s}function Zo(e,n,t,r){if(!(typeof r!="boolean"&&typeof r!="number"&&typeof r!="string")&&um(e,t,r)){if(typeof n=="object"&&n.length>1){let a=!1,s=0;for(;++s<n.length;){const o=n[s];if(o&&typeof o=="object"&&"flags"in o){if(o.test(String(r))){a=!0;break}}else if(o===r){a=!0;break}}if(!a)return}return e.schema.clobber&&e.schema.clobberPrefix&&e.schema.clobber.includes(t)?e.schema.clobberPrefix+r:r}}function um(e,n,t){const r=e.schema.protocols&&Ht.call(e.schema.protocols,n)?e.schema.protocols[n]:void 0;if(!r||r.length===0)return!0;const a=String(t),s=a.indexOf(":"),o=a.indexOf("?"),l=a.indexOf("#"),u=a.indexOf("/");if(s<0||u>-1&&s>u||o>-1&&s>o||l>-1&&s>l)return!0;let c=-1;for(;++c<r.length;){const m=r[c];if(s===m.length&&a.slice(0,m.length)===m)return!0}return!1}function Wn(e,n){const t=Ko(n);n.data&&(e.data=Un(n.data)),t&&(e.position=t)}function Qs(e,n){let t,r=-1;if(e)for(;++r<e.length;){const a=e[r],s=typeof a=="string"?a:a[0];if(s===n)return a;s==="data*"&&(t=a)}if(n.length>4&&n.slice(0,4).toLowerCase()==="data")return t}function dm(e,n){const t={type:"element",tagName:"blockquote",properties:{},children:e.wrap(e.all(n),!0)};return e.patch(n,t),e.applyData(n,t)}function pm(e,n){const t={type:"element",tagName:"br",properties:{},children:[]};return e.patch(n,t),[e.applyData(n,t),{type:"text",value:`
`}]}function hm(e,n){const t=n.value?n.value+`
`:"",r={};n.lang&&(r.className=["language-"+n.lang]);let a={type:"element",tagName:"code",properties:r,children:[{type:"text",value:t}]};return n.meta&&(a.data={meta:n.meta}),e.patch(n,a),a=e.applyData(n,a),a={type:"element",tagName:"pre",properties:{},children:[a]},e.patch(n,a),a}function mm(e,n){const t={type:"element",tagName:"del",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function fm(e,n){const t={type:"element",tagName:"em",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function gm(e,n){const t=typeof e.options.clobberPrefix=="string"?e.options.clobberPrefix:"user-content-",r=String(n.identifier).toUpperCase(),a=yn(r.toLowerCase()),s=e.footnoteOrder.indexOf(r);let o,l=e.footnoteCounts.get(r);l===void 0?(l=0,e.footnoteOrder.push(r),o=e.footnoteOrder.length):o=s+1,l+=1,e.footnoteCounts.set(r,l);const u={type:"element",tagName:"a",properties:{href:"#"+t+"fn-"+a,id:t+"fnref-"+a+(l>1?"-"+l:""),dataFootnoteRef:!0,ariaDescribedBy:["footnote-label"]},children:[{type:"text",value:String(o)}]};e.patch(n,u);const c={type:"element",tagName:"sup",properties:{},children:[u]};return e.patch(n,c),e.applyData(n,c)}function ym(e,n){const t={type:"element",tagName:"h"+n.depth,properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function xm(e,n){if(e.options.allowDangerousHtml){const t={type:"raw",value:n.value};return e.patch(n,t),e.applyData(n,t)}}function el(e,n){const t=n.referenceType;let r="]";if(t==="collapsed"?r+="[]":t==="full"&&(r+="["+(n.label||n.identifier)+"]"),n.type==="imageReference")return[{type:"text",value:"!["+n.alt+r}];const a=e.all(n),s=a[0];s&&s.type==="text"?s.value="["+s.value:a.unshift({type:"text",value:"["});const o=a[a.length-1];return o&&o.type==="text"?o.value+=r:a.push({type:"text",value:r}),a}function bm(e,n){const t=String(n.identifier).toUpperCase(),r=e.definitionById.get(t);if(!r)return el(e,n);const a={src:yn(r.url||""),alt:n.alt};r.title!==null&&r.title!==void 0&&(a.title=r.title);const s={type:"element",tagName:"img",properties:a,children:[]};return e.patch(n,s),e.applyData(n,s)}function wm(e,n){const t={src:yn(n.url)};n.alt!==null&&n.alt!==void 0&&(t.alt=n.alt),n.title!==null&&n.title!==void 0&&(t.title=n.title);const r={type:"element",tagName:"img",properties:t,children:[]};return e.patch(n,r),e.applyData(n,r)}function km(e,n){const t={type:"text",value:n.value.replace(/\r?\n|\r/g," ")};e.patch(n,t);const r={type:"element",tagName:"code",properties:{},children:[t]};return e.patch(n,r),e.applyData(n,r)}function Nm(e,n){const t=String(n.identifier).toUpperCase(),r=e.definitionById.get(t);if(!r)return el(e,n);const a={href:yn(r.url||"")};r.title!==null&&r.title!==void 0&&(a.title=r.title);const s={type:"element",tagName:"a",properties:a,children:e.all(n)};return e.patch(n,s),e.applyData(n,s)}function jm(e,n){const t={href:yn(n.url)};n.title!==null&&n.title!==void 0&&(t.title=n.title);const r={type:"element",tagName:"a",properties:t,children:e.all(n)};return e.patch(n,r),e.applyData(n,r)}function _m(e,n,t){const r=e.all(n),a=t?vm(t):tl(n),s={},o=[];if(typeof n.checked=="boolean"){const m=r[0];let d;m&&m.type==="element"&&m.tagName==="p"?d=m:(d={type:"element",tagName:"p",properties:{},children:[]},r.unshift(d)),d.children.length>0&&d.children.unshift({type:"text",value:" "}),d.children.unshift({type:"element",tagName:"input",properties:{type:"checkbox",checked:n.checked,disabled:!0},children:[]}),s.className=["task-list-item"]}let l=-1;for(;++l<r.length;){const m=r[l];(a||l!==0||m.type!=="element"||m.tagName!=="p")&&o.push({type:"text",value:`
`}),m.type==="element"&&m.tagName==="p"&&!a?o.push(...m.children):o.push(m)}const u=r[r.length-1];u&&(a||u.type!=="element"||u.tagName!=="p")&&o.push({type:"text",value:`
`});const c={type:"element",tagName:"li",properties:s,children:o};return e.patch(n,c),e.applyData(n,c)}function vm(e){let n=!1;if(e.type==="list"){n=e.spread||!1;const t=e.children;let r=-1;for(;!n&&++r<t.length;)n=tl(t[r])}return n}function tl(e){const n=e.spread;return n??e.children.length>1}function Sm(e,n){const t={},r=e.all(n);let a=-1;for(typeof n.start=="number"&&n.start!==1&&(t.start=n.start);++a<r.length;){const o=r[a];if(o.type==="element"&&o.tagName==="li"&&o.properties&&Array.isArray(o.properties.className)&&o.properties.className.includes("task-list-item")){t.className=["contains-task-list"];break}}const s={type:"element",tagName:n.ordered?"ol":"ul",properties:t,children:e.wrap(r,!0)};return e.patch(n,s),e.applyData(n,s)}function Cm(e,n){const t={type:"element",tagName:"p",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function Pm(e,n){const t={type:"root",children:e.wrap(e.all(n))};return e.patch(n,t),e.applyData(n,t)}function Tm(e,n){const t={type:"element",tagName:"strong",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function Im(e,n){const t=e.all(n),r=t.shift(),a=[];if(r){const o={type:"element",tagName:"thead",properties:{},children:e.wrap([r],!0)};e.patch(n.children[0],o),a.push(o)}if(t.length>0){const o={type:"element",tagName:"tbody",properties:{},children:e.wrap(t,!0)},l=Qo(n.children[1]),u=Jo(n.children[n.children.length-1]);l&&u&&(o.position={start:l,end:u}),a.push(o)}const s={type:"element",tagName:"table",properties:{},children:e.wrap(a,!0)};return e.patch(n,s),e.applyData(n,s)}function Am(e,n,t){const r=t?t.children:void 0,s=(r?r.indexOf(n):1)===0?"th":"td",o=t&&t.type==="table"?t.align:void 0,l=o?o.length:n.children.length;let u=-1;const c=[];for(;++u<l;){const d=n.children[u],y={},p=o?o[u]:void 0;p&&(y.align=p);let S={type:"element",tagName:s,properties:y,children:[]};d&&(S.children=e.all(d),e.patch(d,S),S=e.applyData(d,S)),c.push(S)}const m={type:"element",tagName:"tr",properties:{},children:e.wrap(c,!0)};return e.patch(n,m),e.applyData(n,m)}function Em(e,n){const t={type:"element",tagName:"td",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}const Gs=9,Ks=32;function Dm(e){const n=String(e),t=/\r?\n|\r/g;let r=t.exec(n),a=0;const s=[];for(;r;)s.push(Ys(n.slice(a,r.index),a>0,!0),r[0]),a=r.index+r[0].length,r=t.exec(n);return s.push(Ys(n.slice(a),a>0,!1)),s.join("")}function Ys(e,n,t){let r=0,a=e.length;if(n){let s=e.codePointAt(r);for(;s===Gs||s===Ks;)r++,s=e.codePointAt(r)}if(t){let s=e.codePointAt(a-1);for(;s===Gs||s===Ks;)a--,s=e.codePointAt(a-1)}return a>r?e.slice(r,a):""}function Om(e,n){const t={type:"text",value:Dm(String(n.value))};return e.patch(n,t),e.applyData(n,t)}function Lm(e,n){const t={type:"element",tagName:"hr",properties:{},children:[]};return e.patch(n,t),e.applyData(n,t)}const $m={blockquote:dm,break:pm,code:hm,delete:mm,emphasis:fm,footnoteReference:gm,heading:ym,html:xm,imageReference:bm,image:wm,inlineCode:km,linkReference:Nm,link:jm,listItem:_m,list:Sm,paragraph:Cm,root:Pm,strong:Tm,table:Im,tableCell:Em,tableRow:Am,text:Om,thematicBreak:Lm,toml:br,yaml:br,definition:br,footnoteDefinition:br};function br(){}function Rm(e,n){const t=[{type:"text",value:"↩"}];return n>1&&t.push({type:"element",tagName:"sup",properties:{},children:[{type:"text",value:String(n)}]}),t}function Fm(e,n){return"Back to reference "+(e+1)+(n>1?"-"+n:"")}function zm(e){const n=typeof e.options.clobberPrefix=="string"?e.options.clobberPrefix:"user-content-",t=e.options.footnoteBackContent||Rm,r=e.options.footnoteBackLabel||Fm,a=e.options.footnoteLabel||"Footnotes",s=e.options.footnoteLabelTagName||"h2",o=e.options.footnoteLabelProperties||{className:["sr-only"]},l=[];let u=-1;for(;++u<e.footnoteOrder.length;){const c=e.footnoteById.get(e.footnoteOrder[u]);if(!c)continue;const m=e.all(c),d=String(c.identifier).toUpperCase(),y=yn(d.toLowerCase());let p=0;const S=[],$=e.footnoteCounts.get(d);for(;$!==void 0&&++p<=$;){S.length>0&&S.push({type:"text",value:" "});let X=typeof t=="string"?t:t(u,p);typeof X=="string"&&(X={type:"text",value:X}),S.push({type:"element",tagName:"a",properties:{href:"#"+n+"fnref-"+y+(p>1?"-"+p:""),dataFootnoteBackref:"",ariaLabel:typeof r=="string"?r:r(u,p),className:["data-footnote-backref"]},children:Array.isArray(X)?X:[X]})}const K=m[m.length-1];if(K&&K.type==="element"&&K.tagName==="p"){const X=K.children[K.children.length-1];X&&X.type==="text"?X.value+=" ":K.children.push({type:"text",value:" "}),K.children.push(...S)}else m.push(...S);const D={type:"element",tagName:"li",properties:{id:n+"fn-"+y},children:e.wrap(m,!0)};e.patch(c,D),l.push(D)}if(l.length!==0)return{type:"element",tagName:"section",properties:{dataFootnotes:!0,className:["footnotes"]},children:[{type:"element",tagName:s,properties:{...Un(o),id:"footnote-label"},children:[{type:"text",value:a}]},{type:"text",value:`
`},{type:"element",tagName:"ol",properties:{},children:e.wrap(l,!0)},{type:"text",value:`
`}]}}const qi={}.hasOwnProperty,Bm={};function Mm(e,n){const t=n||Bm,r=new Map,a=new Map,s=new Map,o={...$m,...t.handlers},l={all:c,applyData:Um,definitionById:r,footnoteById:a,footnoteCounts:s,footnoteOrder:[],handlers:o,one:u,options:t,patch:qm,wrap:Vm};return Do(e,function(m){if(m.type==="definition"||m.type==="footnoteDefinition"){const d=m.type==="definition"?r:a,y=String(m.identifier).toUpperCase();d.has(y)||d.set(y,m)}}),l;function u(m,d){const y=m.type,p=l.handlers[y];if(qi.call(l.handlers,y)&&p)return p(l,m,d);if(l.options.passThrough&&l.options.passThrough.includes(y)){if("children"in m){const{children:$,...K}=m,D=Un(K);return D.children=l.all(m),D}return Un(m)}return(l.options.unknownHandler||Hm)(l,m,d)}function c(m){const d=[];if("children"in m){const y=m.children;let p=-1;for(;++p<y.length;){const S=l.one(y[p],m);if(S){if(p&&y[p-1].type==="break"&&(!Array.isArray(S)&&S.type==="text"&&(S.value=Xs(S.value)),!Array.isArray(S)&&S.type==="element")){const $=S.children[0];$&&$.type==="text"&&($.value=Xs($.value))}Array.isArray(S)?d.push(...S):d.push(S)}}}return d}}function qm(e,n){e.position&&(n.position=Ko(e))}function Um(e,n){let t=n;if(e&&e.data){const r=e.data.hName,a=e.data.hChildren,s=e.data.hProperties;if(typeof r=="string")if(t.type==="element")t.tagName=r;else{const o="children"in t?t.children:[t];t={type:"element",tagName:r,properties:{},children:o}}t.type==="element"&&s&&Object.assign(t.properties,Un(s)),"children"in t&&t.children&&a!==null&&a!==void 0&&(t.children=a)}return t}function Hm(e,n){const t=n.data||{},r="value"in n&&!(qi.call(t,"hProperties")||qi.call(t,"hChildren"))?{type:"text",value:n.value}:{type:"element",tagName:"div",properties:{},children:e.all(n)};return e.patch(n,r),e.applyData(n,r)}function Vm(e,n){const t=[];let r=-1;for(n&&t.push({type:"text",value:`
`});++r<e.length;)r&&t.push({type:"text",value:`
`}),t.push(e[r]);return n&&e.length>0&&t.push({type:"text",value:`
`}),t}function Xs(e){let n=0,t=e.charCodeAt(n);for(;t===9||t===32;)n++,t=e.charCodeAt(n);return e.slice(n)}function Wm(e,n){const t=Mm(e,n),r=t.one(e,void 0),a=zm(t),s=Array.isArray(r)?{type:"root",children:r}:r||{type:"root",children:[]};return a&&s.children.push({type:"text",value:`
`},a),s}const Jm=["area","base","basefont","bgsound","br","col","command","embed","frame","hr","image","img","input","keygen","link","meta","param","source","track","wbr"];class Jn{constructor(n,t,r){this.normal=t,this.property=n,r&&(this.space=r)}}Jn.prototype.normal={};Jn.prototype.property={};Jn.prototype.space=void 0;function nl(e,n){const t={},r={};for(const a of e)Object.assign(t,a.property),Object.assign(r,a.normal);return new Jn(t,r,n)}function Ui(e){return e.toLowerCase()}class rt{constructor(n,t){this.attribute=t,this.property=n}}rt.prototype.attribute="";rt.prototype.booleanish=!1;rt.prototype.boolean=!1;rt.prototype.commaOrSpaceSeparated=!1;rt.prototype.commaSeparated=!1;rt.prototype.defined=!1;rt.prototype.mustUseProperty=!1;rt.prototype.number=!1;rt.prototype.overloadedBoolean=!1;rt.prototype.property="";rt.prototype.spaceSeparated=!1;rt.prototype.space=void 0;let Qm=0;const we=Zt(),Me=Zt(),Hi=Zt(),q=Zt(),$e=Zt(),fn=Zt(),st=Zt();function Zt(){return 2**++Qm}const Vi=Object.freeze(Object.defineProperty({__proto__:null,boolean:we,booleanish:Me,commaOrSpaceSeparated:st,commaSeparated:fn,number:q,overloadedBoolean:Hi,spaceSeparated:$e},Symbol.toStringTag,{value:"Module"})),Pi=Object.keys(Vi);class la extends rt{constructor(n,t,r,a){let s=-1;if(super(n,t),Zs(this,"space",a),typeof r=="number")for(;++s<Pi.length;){const o=Pi[s];Zs(this,Pi[s],(r&Vi[o])===Vi[o])}}}la.prototype.defined=!0;function Zs(e,n,t){t&&(e[n]=t)}function xn(e){const n={},t={};for(const[r,a]of Object.entries(e.properties)){const s=new la(r,e.transform(e.attributes||{},r),a,e.space);e.mustUseProperty&&e.mustUseProperty.includes(r)&&(s.mustUseProperty=!0),n[r]=s,t[Ui(r)]=r,t[Ui(s.attribute)]=r}return new Jn(n,t,e.space)}const rl=xn({properties:{ariaActiveDescendant:null,ariaAtomic:Me,ariaAutoComplete:null,ariaBusy:Me,ariaChecked:Me,ariaColCount:q,ariaColIndex:q,ariaColSpan:q,ariaControls:$e,ariaCurrent:null,ariaDescribedBy:$e,ariaDetails:null,ariaDisabled:Me,ariaDropEffect:$e,ariaErrorMessage:null,ariaExpanded:Me,ariaFlowTo:$e,ariaGrabbed:Me,ariaHasPopup:null,ariaHidden:Me,ariaInvalid:null,ariaKeyShortcuts:null,ariaLabel:null,ariaLabelledBy:$e,ariaLevel:q,ariaLive:null,ariaModal:Me,ariaMultiLine:Me,ariaMultiSelectable:Me,ariaOrientation:null,ariaOwns:$e,ariaPlaceholder:null,ariaPosInSet:q,ariaPressed:Me,ariaReadOnly:Me,ariaRelevant:null,ariaRequired:Me,ariaRoleDescription:$e,ariaRowCount:q,ariaRowIndex:q,ariaRowSpan:q,ariaSelected:Me,ariaSetSize:q,ariaSort:null,ariaValueMax:q,ariaValueMin:q,ariaValueNow:q,ariaValueText:null,role:null},transform(e,n){return n==="role"?n:"aria-"+n.slice(4).toLowerCase()}});function il(e,n){return n in e?e[n]:n}function al(e,n){return il(e,n.toLowerCase())}const Gm=xn({attributes:{acceptcharset:"accept-charset",classname:"class",htmlfor:"for",httpequiv:"http-equiv"},mustUseProperty:["checked","multiple","muted","selected"],properties:{abbr:null,accept:fn,acceptCharset:$e,accessKey:$e,action:null,allow:null,allowFullScreen:we,allowPaymentRequest:we,allowUserMedia:we,alt:null,as:null,async:we,autoCapitalize:null,autoComplete:$e,autoFocus:we,autoPlay:we,blocking:$e,capture:null,charSet:null,checked:we,cite:null,className:$e,cols:q,colSpan:null,content:null,contentEditable:Me,controls:we,controlsList:$e,coords:q|fn,crossOrigin:null,data:null,dateTime:null,decoding:null,default:we,defer:we,dir:null,dirName:null,disabled:we,download:Hi,draggable:Me,encType:null,enterKeyHint:null,fetchPriority:null,form:null,formAction:null,formEncType:null,formMethod:null,formNoValidate:we,formTarget:null,headers:$e,height:q,hidden:Hi,high:q,href:null,hrefLang:null,htmlFor:$e,httpEquiv:$e,id:null,imageSizes:null,imageSrcSet:null,inert:we,inputMode:null,integrity:null,is:null,isMap:we,itemId:null,itemProp:$e,itemRef:$e,itemScope:we,itemType:$e,kind:null,label:null,lang:null,language:null,list:null,loading:null,loop:we,low:q,manifest:null,max:null,maxLength:q,media:null,method:null,min:null,minLength:q,multiple:we,muted:we,name:null,nonce:null,noModule:we,noValidate:we,onAbort:null,onAfterPrint:null,onAuxClick:null,onBeforeMatch:null,onBeforePrint:null,onBeforeToggle:null,onBeforeUnload:null,onBlur:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onContextLost:null,onContextMenu:null,onContextRestored:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnded:null,onError:null,onFocus:null,onFormData:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLanguageChange:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadEnd:null,onLoadStart:null,onMessage:null,onMessageError:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRejectionHandled:null,onReset:null,onResize:null,onScroll:null,onScrollEnd:null,onSecurityPolicyViolation:null,onSeeked:null,onSeeking:null,onSelect:null,onSlotChange:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnhandledRejection:null,onUnload:null,onVolumeChange:null,onWaiting:null,onWheel:null,open:we,optimum:q,pattern:null,ping:$e,placeholder:null,playsInline:we,popover:null,popoverTarget:null,popoverTargetAction:null,poster:null,preload:null,readOnly:we,referrerPolicy:null,rel:$e,required:we,reversed:we,rows:q,rowSpan:q,sandbox:$e,scope:null,scoped:we,seamless:we,selected:we,shadowRootClonable:we,shadowRootDelegatesFocus:we,shadowRootMode:null,shape:null,size:q,sizes:null,slot:null,span:q,spellCheck:Me,src:null,srcDoc:null,srcLang:null,srcSet:null,start:q,step:null,style:null,tabIndex:q,target:null,title:null,translate:null,type:null,typeMustMatch:we,useMap:null,value:Me,width:q,wrap:null,writingSuggestions:null,align:null,aLink:null,archive:$e,axis:null,background:null,bgColor:null,border:q,borderColor:null,bottomMargin:q,cellPadding:null,cellSpacing:null,char:null,charOff:null,classId:null,clear:null,code:null,codeBase:null,codeType:null,color:null,compact:we,declare:we,event:null,face:null,frame:null,frameBorder:null,hSpace:q,leftMargin:q,link:null,longDesc:null,lowSrc:null,marginHeight:q,marginWidth:q,noResize:we,noHref:we,noShade:we,noWrap:we,object:null,profile:null,prompt:null,rev:null,rightMargin:q,rules:null,scheme:null,scrolling:Me,standby:null,summary:null,text:null,topMargin:q,valueType:null,version:null,vAlign:null,vLink:null,vSpace:q,allowTransparency:null,autoCorrect:null,autoSave:null,disablePictureInPicture:we,disableRemotePlayback:we,prefix:null,property:null,results:q,security:null,unselectable:null},space:"html",transform:al}),Km=xn({attributes:{accentHeight:"accent-height",alignmentBaseline:"alignment-baseline",arabicForm:"arabic-form",baselineShift:"baseline-shift",capHeight:"cap-height",className:"class",clipPath:"clip-path",clipRule:"clip-rule",colorInterpolation:"color-interpolation",colorInterpolationFilters:"color-interpolation-filters",colorProfile:"color-profile",colorRendering:"color-rendering",crossOrigin:"crossorigin",dataType:"datatype",dominantBaseline:"dominant-baseline",enableBackground:"enable-background",fillOpacity:"fill-opacity",fillRule:"fill-rule",floodColor:"flood-color",floodOpacity:"flood-opacity",fontFamily:"font-family",fontSize:"font-size",fontSizeAdjust:"font-size-adjust",fontStretch:"font-stretch",fontStyle:"font-style",fontVariant:"font-variant",fontWeight:"font-weight",glyphName:"glyph-name",glyphOrientationHorizontal:"glyph-orientation-horizontal",glyphOrientationVertical:"glyph-orientation-vertical",hrefLang:"hreflang",horizAdvX:"horiz-adv-x",horizOriginX:"horiz-origin-x",horizOriginY:"horiz-origin-y",imageRendering:"image-rendering",letterSpacing:"letter-spacing",lightingColor:"lighting-color",markerEnd:"marker-end",markerMid:"marker-mid",markerStart:"marker-start",navDown:"nav-down",navDownLeft:"nav-down-left",navDownRight:"nav-down-right",navLeft:"nav-left",navNext:"nav-next",navPrev:"nav-prev",navRight:"nav-right",navUp:"nav-up",navUpLeft:"nav-up-left",navUpRight:"nav-up-right",onAbort:"onabort",onActivate:"onactivate",onAfterPrint:"onafterprint",onBeforePrint:"onbeforeprint",onBegin:"onbegin",onCancel:"oncancel",onCanPlay:"oncanplay",onCanPlayThrough:"oncanplaythrough",onChange:"onchange",onClick:"onclick",onClose:"onclose",onCopy:"oncopy",onCueChange:"oncuechange",onCut:"oncut",onDblClick:"ondblclick",onDrag:"ondrag",onDragEnd:"ondragend",onDragEnter:"ondragenter",onDragExit:"ondragexit",onDragLeave:"ondragleave",onDragOver:"ondragover",onDragStart:"ondragstart",onDrop:"ondrop",onDurationChange:"ondurationchange",onEmptied:"onemptied",onEnd:"onend",onEnded:"onended",onError:"onerror",onFocus:"onfocus",onFocusIn:"onfocusin",onFocusOut:"onfocusout",onHashChange:"onhashchange",onInput:"oninput",onInvalid:"oninvalid",onKeyDown:"onkeydown",onKeyPress:"onkeypress",onKeyUp:"onkeyup",onLoad:"onload",onLoadedData:"onloadeddata",onLoadedMetadata:"onloadedmetadata",onLoadStart:"onloadstart",onMessage:"onmessage",onMouseDown:"onmousedown",onMouseEnter:"onmouseenter",onMouseLeave:"onmouseleave",onMouseMove:"onmousemove",onMouseOut:"onmouseout",onMouseOver:"onmouseover",onMouseUp:"onmouseup",onMouseWheel:"onmousewheel",onOffline:"onoffline",onOnline:"ononline",onPageHide:"onpagehide",onPageShow:"onpageshow",onPaste:"onpaste",onPause:"onpause",onPlay:"onplay",onPlaying:"onplaying",onPopState:"onpopstate",onProgress:"onprogress",onRateChange:"onratechange",onRepeat:"onrepeat",onReset:"onreset",onResize:"onresize",onScroll:"onscroll",onSeeked:"onseeked",onSeeking:"onseeking",onSelect:"onselect",onShow:"onshow",onStalled:"onstalled",onStorage:"onstorage",onSubmit:"onsubmit",onSuspend:"onsuspend",onTimeUpdate:"ontimeupdate",onToggle:"ontoggle",onUnload:"onunload",onVolumeChange:"onvolumechange",onWaiting:"onwaiting",onZoom:"onzoom",overlinePosition:"overline-position",overlineThickness:"overline-thickness",paintOrder:"paint-order",panose1:"panose-1",pointerEvents:"pointer-events",referrerPolicy:"referrerpolicy",renderingIntent:"rendering-intent",shapeRendering:"shape-rendering",stopColor:"stop-color",stopOpacity:"stop-opacity",strikethroughPosition:"strikethrough-position",strikethroughThickness:"strikethrough-thickness",strokeDashArray:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",strokeLineCap:"stroke-linecap",strokeLineJoin:"stroke-linejoin",strokeMiterLimit:"stroke-miterlimit",strokeOpacity:"stroke-opacity",strokeWidth:"stroke-width",tabIndex:"tabindex",textAnchor:"text-anchor",textDecoration:"text-decoration",textRendering:"text-rendering",transformOrigin:"transform-origin",typeOf:"typeof",underlinePosition:"underline-position",underlineThickness:"underline-thickness",unicodeBidi:"unicode-bidi",unicodeRange:"unicode-range",unitsPerEm:"units-per-em",vAlphabetic:"v-alphabetic",vHanging:"v-hanging",vIdeographic:"v-ideographic",vMathematical:"v-mathematical",vectorEffect:"vector-effect",vertAdvY:"vert-adv-y",vertOriginX:"vert-origin-x",vertOriginY:"vert-origin-y",wordSpacing:"word-spacing",writingMode:"writing-mode",xHeight:"x-height",playbackOrder:"playbackorder",timelineBegin:"timelinebegin"},properties:{about:st,accentHeight:q,accumulate:null,additive:null,alignmentBaseline:null,alphabetic:q,amplitude:q,arabicForm:null,ascent:q,attributeName:null,attributeType:null,azimuth:q,bandwidth:null,baselineShift:null,baseFrequency:null,baseProfile:null,bbox:null,begin:null,bias:q,by:null,calcMode:null,capHeight:q,className:$e,clip:null,clipPath:null,clipPathUnits:null,clipRule:null,color:null,colorInterpolation:null,colorInterpolationFilters:null,colorProfile:null,colorRendering:null,content:null,contentScriptType:null,contentStyleType:null,crossOrigin:null,cursor:null,cx:null,cy:null,d:null,dataType:null,defaultAction:null,descent:q,diffuseConstant:q,direction:null,display:null,dur:null,divisor:q,dominantBaseline:null,download:we,dx:null,dy:null,edgeMode:null,editable:null,elevation:q,enableBackground:null,end:null,event:null,exponent:q,externalResourcesRequired:null,fill:null,fillOpacity:q,fillRule:null,filter:null,filterRes:null,filterUnits:null,floodColor:null,floodOpacity:null,focusable:null,focusHighlight:null,fontFamily:null,fontSize:null,fontSizeAdjust:null,fontStretch:null,fontStyle:null,fontVariant:null,fontWeight:null,format:null,fr:null,from:null,fx:null,fy:null,g1:fn,g2:fn,glyphName:fn,glyphOrientationHorizontal:null,glyphOrientationVertical:null,glyphRef:null,gradientTransform:null,gradientUnits:null,handler:null,hanging:q,hatchContentUnits:null,hatchUnits:null,height:null,href:null,hrefLang:null,horizAdvX:q,horizOriginX:q,horizOriginY:q,id:null,ideographic:q,imageRendering:null,initialVisibility:null,in:null,in2:null,intercept:q,k:q,k1:q,k2:q,k3:q,k4:q,kernelMatrix:st,kernelUnitLength:null,keyPoints:null,keySplines:null,keyTimes:null,kerning:null,lang:null,lengthAdjust:null,letterSpacing:null,lightingColor:null,limitingConeAngle:q,local:null,markerEnd:null,markerMid:null,markerStart:null,markerHeight:null,markerUnits:null,markerWidth:null,mask:null,maskContentUnits:null,maskUnits:null,mathematical:null,max:null,media:null,mediaCharacterEncoding:null,mediaContentEncodings:null,mediaSize:q,mediaTime:null,method:null,min:null,mode:null,name:null,navDown:null,navDownLeft:null,navDownRight:null,navLeft:null,navNext:null,navPrev:null,navRight:null,navUp:null,navUpLeft:null,navUpRight:null,numOctaves:null,observer:null,offset:null,onAbort:null,onActivate:null,onAfterPrint:null,onBeforePrint:null,onBegin:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnd:null,onEnded:null,onError:null,onFocus:null,onFocusIn:null,onFocusOut:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadStart:null,onMessage:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onMouseWheel:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRepeat:null,onReset:null,onResize:null,onScroll:null,onSeeked:null,onSeeking:null,onSelect:null,onShow:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnload:null,onVolumeChange:null,onWaiting:null,onZoom:null,opacity:null,operator:null,order:null,orient:null,orientation:null,origin:null,overflow:null,overlay:null,overlinePosition:q,overlineThickness:q,paintOrder:null,panose1:null,path:null,pathLength:q,patternContentUnits:null,patternTransform:null,patternUnits:null,phase:null,ping:$e,pitch:null,playbackOrder:null,pointerEvents:null,points:null,pointsAtX:q,pointsAtY:q,pointsAtZ:q,preserveAlpha:null,preserveAspectRatio:null,primitiveUnits:null,propagate:null,property:st,r:null,radius:null,referrerPolicy:null,refX:null,refY:null,rel:st,rev:st,renderingIntent:null,repeatCount:null,repeatDur:null,requiredExtensions:st,requiredFeatures:st,requiredFonts:st,requiredFormats:st,resource:null,restart:null,result:null,rotate:null,rx:null,ry:null,scale:null,seed:null,shapeRendering:null,side:null,slope:null,snapshotTime:null,specularConstant:q,specularExponent:q,spreadMethod:null,spacing:null,startOffset:null,stdDeviation:null,stemh:null,stemv:null,stitchTiles:null,stopColor:null,stopOpacity:null,strikethroughPosition:q,strikethroughThickness:q,string:null,stroke:null,strokeDashArray:st,strokeDashOffset:null,strokeLineCap:null,strokeLineJoin:null,strokeMiterLimit:q,strokeOpacity:q,strokeWidth:null,style:null,surfaceScale:q,syncBehavior:null,syncBehaviorDefault:null,syncMaster:null,syncTolerance:null,syncToleranceDefault:null,systemLanguage:st,tabIndex:q,tableValues:null,target:null,targetX:q,targetY:q,textAnchor:null,textDecoration:null,textRendering:null,textLength:null,timelineBegin:null,title:null,transformBehavior:null,type:null,typeOf:st,to:null,transform:null,transformOrigin:null,u1:null,u2:null,underlinePosition:q,underlineThickness:q,unicode:null,unicodeBidi:null,unicodeRange:null,unitsPerEm:q,values:null,vAlphabetic:q,vMathematical:q,vectorEffect:null,vHanging:q,vIdeographic:q,version:null,vertAdvY:q,vertOriginX:q,vertOriginY:q,viewBox:null,viewTarget:null,visibility:null,width:null,widths:null,wordSpacing:null,writingMode:null,x:null,x1:null,x2:null,xChannelSelector:null,xHeight:q,y:null,y1:null,y2:null,yChannelSelector:null,z:null,zoomAndPan:null},space:"svg",transform:il}),sl=xn({properties:{xLinkActuate:null,xLinkArcRole:null,xLinkHref:null,xLinkRole:null,xLinkShow:null,xLinkTitle:null,xLinkType:null},space:"xlink",transform(e,n){return"xlink:"+n.slice(5).toLowerCase()}}),ol=xn({attributes:{xmlnsxlink:"xmlns:xlink"},properties:{xmlnsXLink:null,xmlns:null},space:"xmlns",transform:al}),ll=xn({properties:{xmlBase:null,xmlLang:null,xmlSpace:null},space:"xml",transform(e,n){return"xml:"+n.slice(3).toLowerCase()}}),Ym=/[A-Z]/g,eo=/-[a-z]/g,Xm=/^data[-\w.:]+$/i;function Zm(e,n){const t=Ui(n);let r=n,a=rt;if(t in e.normal)return e.property[e.normal[t]];if(t.length>4&&t.slice(0,4)==="data"&&Xm.test(n)){if(n.charAt(4)==="-"){const s=n.slice(5).replace(eo,tf);r="data"+s.charAt(0).toUpperCase()+s.slice(1)}else{const s=n.slice(4);if(!eo.test(s)){let o=s.replace(Ym,ef);o.charAt(0)!=="-"&&(o="-"+o),n="data"+o}}a=la}return new a(r,n)}function ef(e){return"-"+e.toLowerCase()}function tf(e){return e.charAt(1).toUpperCase()}const nf=nl([rl,Gm,sl,ol,ll],"html"),cl=nl([rl,Km,sl,ol,ll],"svg"),rf=/["&'<>`]/g,af=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,sf=/[\x01-\t\v\f\x0E-\x1F\x7F\x81\x8D\x8F\x90\x9D\xA0-\uFFFF]/g,of=/[|\\{}()[\]^$+*?.]/g,to=new WeakMap;function lf(e,n){if(e=e.replace(n.subset?cf(n.subset):rf,r),n.subset||n.escapeOnly)return e;return e.replace(af,t).replace(sf,r);function t(a,s,o){return n.format((a.charCodeAt(0)-55296)*1024+a.charCodeAt(1)-56320+65536,o.charCodeAt(s+2),n)}function r(a,s,o){return n.format(a.charCodeAt(0),o.charCodeAt(s+1),n)}}function cf(e){let n=to.get(e);return n||(n=uf(e),to.set(e,n)),n}function uf(e){const n=[];let t=-1;for(;++t<e.length;)n.push(e[t].replace(of,"\\$&"));return new RegExp("(?:"+n.join("|")+")","g")}const df=/[\dA-Fa-f]/;function pf(e,n,t){const r="&#x"+e.toString(16).toUpperCase();return t&&n&&!df.test(String.fromCharCode(n))?r:r+";"}const hf=/\d/;function mf(e,n,t){const r="&#"+String(e);return t&&n&&!hf.test(String.fromCharCode(n))?r:r+";"}const ff=["AElig","AMP","Aacute","Acirc","Agrave","Aring","Atilde","Auml","COPY","Ccedil","ETH","Eacute","Ecirc","Egrave","Euml","GT","Iacute","Icirc","Igrave","Iuml","LT","Ntilde","Oacute","Ocirc","Ograve","Oslash","Otilde","Ouml","QUOT","REG","THORN","Uacute","Ucirc","Ugrave","Uuml","Yacute","aacute","acirc","acute","aelig","agrave","amp","aring","atilde","auml","brvbar","ccedil","cedil","cent","copy","curren","deg","divide","eacute","ecirc","egrave","eth","euml","frac12","frac14","frac34","gt","iacute","icirc","iexcl","igrave","iquest","iuml","laquo","lt","macr","micro","middot","nbsp","not","ntilde","oacute","ocirc","ograve","ordf","ordm","oslash","otilde","ouml","para","plusmn","pound","quot","raquo","reg","sect","shy","sup1","sup2","sup3","szlig","thorn","times","uacute","ucirc","ugrave","uml","uuml","yacute","yen","yuml"],Ti={nbsp:" ",iexcl:"¡",cent:"¢",pound:"£",curren:"¤",yen:"¥",brvbar:"¦",sect:"§",uml:"¨",copy:"©",ordf:"ª",laquo:"«",not:"¬",shy:"­",reg:"®",macr:"¯",deg:"°",plusmn:"±",sup2:"²",sup3:"³",acute:"´",micro:"µ",para:"¶",middot:"·",cedil:"¸",sup1:"¹",ordm:"º",raquo:"»",frac14:"¼",frac12:"½",frac34:"¾",iquest:"¿",Agrave:"À",Aacute:"Á",Acirc:"Â",Atilde:"Ã",Auml:"Ä",Aring:"Å",AElig:"Æ",Ccedil:"Ç",Egrave:"È",Eacute:"É",Ecirc:"Ê",Euml:"Ë",Igrave:"Ì",Iacute:"Í",Icirc:"Î",Iuml:"Ï",ETH:"Ð",Ntilde:"Ñ",Ograve:"Ò",Oacute:"Ó",Ocirc:"Ô",Otilde:"Õ",Ouml:"Ö",times:"×",Oslash:"Ø",Ugrave:"Ù",Uacute:"Ú",Ucirc:"Û",Uuml:"Ü",Yacute:"Ý",THORN:"Þ",szlig:"ß",agrave:"à",aacute:"á",acirc:"â",atilde:"ã",auml:"ä",aring:"å",aelig:"æ",ccedil:"ç",egrave:"è",eacute:"é",ecirc:"ê",euml:"ë",igrave:"ì",iacute:"í",icirc:"î",iuml:"ï",eth:"ð",ntilde:"ñ",ograve:"ò",oacute:"ó",ocirc:"ô",otilde:"õ",ouml:"ö",divide:"÷",oslash:"ø",ugrave:"ù",uacute:"ú",ucirc:"û",uuml:"ü",yacute:"ý",thorn:"þ",yuml:"ÿ",fnof:"ƒ",Alpha:"Α",Beta:"Β",Gamma:"Γ",Delta:"Δ",Epsilon:"Ε",Zeta:"Ζ",Eta:"Η",Theta:"Θ",Iota:"Ι",Kappa:"Κ",Lambda:"Λ",Mu:"Μ",Nu:"Ν",Xi:"Ξ",Omicron:"Ο",Pi:"Π",Rho:"Ρ",Sigma:"Σ",Tau:"Τ",Upsilon:"Υ",Phi:"Φ",Chi:"Χ",Psi:"Ψ",Omega:"Ω",alpha:"α",beta:"β",gamma:"γ",delta:"δ",epsilon:"ε",zeta:"ζ",eta:"η",theta:"θ",iota:"ι",kappa:"κ",lambda:"λ",mu:"μ",nu:"ν",xi:"ξ",omicron:"ο",pi:"π",rho:"ρ",sigmaf:"ς",sigma:"σ",tau:"τ",upsilon:"υ",phi:"φ",chi:"χ",psi:"ψ",omega:"ω",thetasym:"ϑ",upsih:"ϒ",piv:"ϖ",bull:"•",hellip:"…",prime:"′",Prime:"″",oline:"‾",frasl:"⁄",weierp:"℘",image:"ℑ",real:"ℜ",trade:"™",alefsym:"ℵ",larr:"←",uarr:"↑",rarr:"→",darr:"↓",harr:"↔",crarr:"↵",lArr:"⇐",uArr:"⇑",rArr:"⇒",dArr:"⇓",hArr:"⇔",forall:"∀",part:"∂",exist:"∃",empty:"∅",nabla:"∇",isin:"∈",notin:"∉",ni:"∋",prod:"∏",sum:"∑",minus:"−",lowast:"∗",radic:"√",prop:"∝",infin:"∞",ang:"∠",and:"∧",or:"∨",cap:"∩",cup:"∪",int:"∫",there4:"∴",sim:"∼",cong:"≅",asymp:"≈",ne:"≠",equiv:"≡",le:"≤",ge:"≥",sub:"⊂",sup:"⊃",nsub:"⊄",sube:"⊆",supe:"⊇",oplus:"⊕",otimes:"⊗",perp:"⊥",sdot:"⋅",lceil:"⌈",rceil:"⌉",lfloor:"⌊",rfloor:"⌋",lang:"〈",rang:"〉",loz:"◊",spades:"♠",clubs:"♣",hearts:"♥",diams:"♦",quot:'"',amp:"&",lt:"<",gt:">",OElig:"Œ",oelig:"œ",Scaron:"Š",scaron:"š",Yuml:"Ÿ",circ:"ˆ",tilde:"˜",ensp:" ",emsp:" ",thinsp:" ",zwnj:"‌",zwj:"‍",lrm:"‎",rlm:"‏",ndash:"–",mdash:"—",lsquo:"‘",rsquo:"’",sbquo:"‚",ldquo:"“",rdquo:"”",bdquo:"„",dagger:"†",Dagger:"‡",permil:"‰",lsaquo:"‹",rsaquo:"›",euro:"€"},gf=["cent","copy","divide","gt","lt","not","para","times"],ul={}.hasOwnProperty,Wi={};let wr;for(wr in Ti)ul.call(Ti,wr)&&(Wi[Ti[wr]]=wr);const yf=/[^\dA-Za-z]/;function xf(e,n,t,r){const a=String.fromCharCode(e);if(ul.call(Wi,a)){const s=Wi[a],o="&"+s;return t&&ff.includes(s)&&!gf.includes(s)&&(!r||n&&n!==61&&yf.test(String.fromCharCode(n)))?o:o+";"}return""}function bf(e,n,t){let r=pf(e,n,t.omitOptionalSemicolons),a;if((t.useNamedReferences||t.useShortestReferences)&&(a=xf(e,n,t.omitOptionalSemicolons,t.attribute)),(t.useShortestReferences||!a)&&t.useShortestReferences){const s=mf(e,n,t.omitOptionalSemicolons);s.length<r.length&&(r=s)}return a&&(!t.useShortestReferences||a.length<r.length)?a:r}function gn(e,n){return lf(e,Object.assign({format:bf},n))}const wf=/^>|^->|<!--|-->|--!>|<!-$/g,kf=[">"],Nf=["<",">"];function jf(e,n,t,r){return r.settings.bogusComments?"<?"+gn(e.value,Object.assign({},r.settings.characterReferences,{subset:kf}))+">":"<!--"+e.value.replace(wf,a)+"-->";function a(s){return gn(s,Object.assign({},r.settings.characterReferences,{subset:Nf}))}}function _f(e,n,t,r){return"<!"+(r.settings.upperDoctype?"DOCTYPE":"doctype")+(r.settings.tightDoctype?"":" ")+"html>"}function no(e,n){const t=String(e);if(typeof n!="string")throw new TypeError("Expected character");let r=0,a=t.indexOf(n);for(;a!==-1;)r++,a=t.indexOf(n,a+n.length);return r}function vf(e,n){const t=n||{};return(e[e.length-1]===""?[...e,""]:e).join((t.padRight?" ":"")+","+(t.padLeft===!1?"":" ")).trim()}function Sf(e){return e.join(" ").trim()}const Cf=/[ \t\n\f\r]/g;function ca(e){return typeof e=="object"?e.type==="text"?ro(e.value):!1:ro(e)}function ro(e){return e.replace(Cf,"")===""}const We=pl(1),dl=pl(-1),Pf=[];function pl(e){return n;function n(t,r,a){const s=t?t.children:Pf;let o=(r||0)+e,l=s[o];if(!a)for(;l&&ca(l);)o+=e,l=s[o];return l}}const Tf={}.hasOwnProperty;function hl(e){return n;function n(t,r,a){return Tf.call(e,t.tagName)&&e[t.tagName](t,r,a)}}const ua=hl({body:Af,caption:Ii,colgroup:Ii,dd:Lf,dt:Of,head:Ii,html:If,li:Df,optgroup:$f,option:Rf,p:Ef,rp:io,rt:io,tbody:zf,td:ao,tfoot:Bf,th:ao,thead:Ff,tr:Mf});function Ii(e,n,t){const r=We(t,n,!0);return!r||r.type!=="comment"&&!(r.type==="text"&&ca(r.value.charAt(0)))}function If(e,n,t){const r=We(t,n);return!r||r.type!=="comment"}function Af(e,n,t){const r=We(t,n);return!r||r.type!=="comment"}function Ef(e,n,t){const r=We(t,n);return r?r.type==="element"&&(r.tagName==="address"||r.tagName==="article"||r.tagName==="aside"||r.tagName==="blockquote"||r.tagName==="details"||r.tagName==="div"||r.tagName==="dl"||r.tagName==="fieldset"||r.tagName==="figcaption"||r.tagName==="figure"||r.tagName==="footer"||r.tagName==="form"||r.tagName==="h1"||r.tagName==="h2"||r.tagName==="h3"||r.tagName==="h4"||r.tagName==="h5"||r.tagName==="h6"||r.tagName==="header"||r.tagName==="hgroup"||r.tagName==="hr"||r.tagName==="main"||r.tagName==="menu"||r.tagName==="nav"||r.tagName==="ol"||r.tagName==="p"||r.tagName==="pre"||r.tagName==="section"||r.tagName==="table"||r.tagName==="ul"):!t||!(t.type==="element"&&(t.tagName==="a"||t.tagName==="audio"||t.tagName==="del"||t.tagName==="ins"||t.tagName==="map"||t.tagName==="noscript"||t.tagName==="video"))}function Df(e,n,t){const r=We(t,n);return!r||r.type==="element"&&r.tagName==="li"}function Of(e,n,t){const r=We(t,n);return!!(r&&r.type==="element"&&(r.tagName==="dt"||r.tagName==="dd"))}function Lf(e,n,t){const r=We(t,n);return!r||r.type==="element"&&(r.tagName==="dt"||r.tagName==="dd")}function io(e,n,t){const r=We(t,n);return!r||r.type==="element"&&(r.tagName==="rp"||r.tagName==="rt")}function $f(e,n,t){const r=We(t,n);return!r||r.type==="element"&&r.tagName==="optgroup"}function Rf(e,n,t){const r=We(t,n);return!r||r.type==="element"&&(r.tagName==="option"||r.tagName==="optgroup")}function Ff(e,n,t){const r=We(t,n);return!!(r&&r.type==="element"&&(r.tagName==="tbody"||r.tagName==="tfoot"))}function zf(e,n,t){const r=We(t,n);return!r||r.type==="element"&&(r.tagName==="tbody"||r.tagName==="tfoot")}function Bf(e,n,t){return!We(t,n)}function Mf(e,n,t){const r=We(t,n);return!r||r.type==="element"&&r.tagName==="tr"}function ao(e,n,t){const r=We(t,n);return!r||r.type==="element"&&(r.tagName==="td"||r.tagName==="th")}const qf=hl({body:Vf,colgroup:Wf,head:Hf,html:Uf,tbody:Jf});function Uf(e){const n=We(e,-1);return!n||n.type!=="comment"}function Hf(e){const n=new Set;for(const r of e.children)if(r.type==="element"&&(r.tagName==="base"||r.tagName==="title")){if(n.has(r.tagName))return!1;n.add(r.tagName)}const t=e.children[0];return!t||t.type==="element"}function Vf(e){const n=We(e,-1,!0);return!n||n.type!=="comment"&&!(n.type==="text"&&ca(n.value.charAt(0)))&&!(n.type==="element"&&(n.tagName==="meta"||n.tagName==="link"||n.tagName==="script"||n.tagName==="style"||n.tagName==="template"))}function Wf(e,n,t){const r=dl(t,n),a=We(e,-1,!0);return t&&r&&r.type==="element"&&r.tagName==="colgroup"&&ua(r,t.children.indexOf(r),t)?!1:!!(a&&a.type==="element"&&a.tagName==="col")}function Jf(e,n,t){const r=dl(t,n),a=We(e,-1);return t&&r&&r.type==="element"&&(r.tagName==="thead"||r.tagName==="tbody")&&ua(r,t.children.indexOf(r),t)?!1:!!(a&&a.type==="element"&&a.tagName==="tr")}const kr={name:[[`	
\f\r &/=>`.split(""),`	
\f\r "&'/=>\``.split("")],[`\0	
\f\r "&'/<=>`.split(""),`\0	
\f\r "&'/<=>\``.split("")]],unquoted:[[`	
\f\r &>`.split(""),`\0	
\f\r "&'<=>\``.split("")],[`\0	
\f\r "&'<=>\``.split(""),`\0	
\f\r "&'<=>\``.split("")]],single:[["&'".split(""),"\"&'`".split("")],["\0&'".split(""),"\0\"&'`".split("")]],double:[['"&'.split(""),"\"&'`".split("")],['\0"&'.split(""),"\0\"&'`".split("")]]};function Qf(e,n,t,r){const a=r.schema,s=a.space==="svg"?!1:r.settings.omitOptionalTags;let o=a.space==="svg"?r.settings.closeEmptyElements:r.settings.voids.includes(e.tagName.toLowerCase());const l=[];let u;a.space==="html"&&e.tagName==="svg"&&(r.schema=cl);const c=Gf(r,e.properties),m=r.all(a.space==="html"&&e.tagName==="template"?e.content:e);return r.schema=a,m&&(o=!1),(c||!s||!qf(e,n,t))&&(l.push("<",e.tagName,c?" "+c:""),o&&(a.space==="svg"||r.settings.closeSelfClosing)&&(u=c.charAt(c.length-1),(!r.settings.tightSelfClosing||u==="/"||u&&u!=='"'&&u!=="'")&&l.push(" "),l.push("/")),l.push(">")),l.push(m),!o&&(!s||!ua(e,n,t))&&l.push("</"+e.tagName+">"),l.join("")}function Gf(e,n){const t=[];let r=-1,a;if(n){for(a in n)if(n[a]!==null&&n[a]!==void 0){const s=Kf(e,a,n[a]);s&&t.push(s)}}for(;++r<t.length;){const s=e.settings.tightAttributes?t[r].charAt(t[r].length-1):void 0;r!==t.length-1&&s!=='"'&&s!=="'"&&(t[r]+=" ")}return t.join("")}function Kf(e,n,t){const r=Zm(e.schema,n),a=e.settings.allowParseErrors&&e.schema.space==="html"?0:1,s=e.settings.allowDangerousCharacters?0:1;let o=e.quote,l;if(r.overloadedBoolean&&(t===r.attribute||t==="")?t=!0:(r.boolean||r.overloadedBoolean)&&(typeof t!="string"||t===r.attribute||t==="")&&(t=!!t),t==null||t===!1||typeof t=="number"&&Number.isNaN(t))return"";const u=gn(r.attribute,Object.assign({},e.settings.characterReferences,{subset:kr.name[a][s]}));return t===!0||(t=Array.isArray(t)?(r.commaSeparated?vf:Sf)(t,{padLeft:!e.settings.tightCommaSeparatedLists}):String(t),e.settings.collapseEmptyAttributes&&!t)?u:(e.settings.preferUnquoted&&(l=gn(t,Object.assign({},e.settings.characterReferences,{attribute:!0,subset:kr.unquoted[a][s]}))),l!==t&&(e.settings.quoteSmart&&no(t,o)>no(t,e.alternative)&&(o=e.alternative),l=o+gn(t,Object.assign({},e.settings.characterReferences,{subset:(o==="'"?kr.single:kr.double)[a][s],attribute:!0}))+o),u+(l&&"="+l))}const Yf=["<","&"];function ml(e,n,t,r){return t&&t.type==="element"&&(t.tagName==="script"||t.tagName==="style")?e.value:gn(e.value,Object.assign({},r.settings.characterReferences,{subset:Yf}))}function Xf(e,n,t,r){return r.settings.allowDangerousHtml?e.value:ml(e,n,t,r)}function Zf(e,n,t,r){return r.all(e)}const eg=Po("type",{invalid:tg,unknown:ng,handlers:{comment:jf,doctype:_f,element:Qf,raw:Xf,root:Zf,text:ml}});function tg(e){throw new Error("Expected node, not `"+e+"`")}function ng(e){const n=e;throw new Error("Cannot compile unknown node `"+n.type+"`")}const rg={},ig={},ag=[];function sg(e,n){const t=n||rg,r=t.quote||'"',a=r==='"'?"'":'"';if(r!=='"'&&r!=="'")throw new Error("Invalid quote `"+r+"`, expected `'` or `\"`");return{one:og,all:lg,settings:{omitOptionalTags:t.omitOptionalTags||!1,allowParseErrors:t.allowParseErrors||!1,allowDangerousCharacters:t.allowDangerousCharacters||!1,quoteSmart:t.quoteSmart||!1,preferUnquoted:t.preferUnquoted||!1,tightAttributes:t.tightAttributes||!1,upperDoctype:t.upperDoctype||!1,tightDoctype:t.tightDoctype||!1,bogusComments:t.bogusComments||!1,tightCommaSeparatedLists:t.tightCommaSeparatedLists||!1,tightSelfClosing:t.tightSelfClosing||!1,collapseEmptyAttributes:t.collapseEmptyAttributes||!1,allowDangerousHtml:t.allowDangerousHtml||!1,voids:t.voids||Jm,characterReferences:t.characterReferences||ig,closeSelfClosing:t.closeSelfClosing||!1,closeEmptyElements:t.closeEmptyElements||!1},schema:t.space==="svg"?cl:nf,quote:r,alternative:a}.one(Array.isArray(e)?{type:"root",children:e}:e,void 0,void 0)}function og(e,n,t){return eg(e,n,t,this)}function lg(e){const n=[],t=e&&e.children||ag;let r=-1;for(;++r<t.length;)n[r]=this.one(t[r],r,e);return n.join("")}const cg={};function Ai(e){const n=this,{handlers:t,sanitize:r,...a}=e||cg;let s=!1,o;typeof r=="boolean"?s=!r:r&&(o=r),n.compiler=l;function l(u,c){const m=Wm(u,{handlers:t,allowDangerousHtml:s}),d=s?m:nm(m,o),y=sg(d,{...a,allowDangerousHtml:s});return c.extname&&(c.extname=".html"),u&&u.type==="root"&&y&&/[^\r\n]/.test(y.charAt(y.length-1))?y+`
`:y}}const ug="_modalOverlay_8xawn_1",dg="_modalContent_8xawn_31",pg="_modalHeader_8xawn_59",hg="_modalTitle_8xawn_77",mg="_modalCloseButton_8xawn_91",fg="_modalBody_8xawn_123",gg="_formGroup_8xawn_135",yg="_inputField_8xawn_159",xg="_searchResultsCard_8xawn_193",bg="_searchResultsList_8xawn_221",wg="_searchResultItem_8xawn_233",kg="_searchResultPrice_8xawn_265",Ng="_selectedTestsCard_8xawn_277",jg="_selectedTestsHeader_8xawn_293",_g="_noTestsMessage_8xawn_313",vg="_selectedTestsList_8xawn_329",Sg="_selectedTestItem_8xawn_341",Cg="_selectedTestName_8xawn_365",Pg="_removeTestButton_8xawn_377",Tg="_quantityRow_8xawn_407",Ig="_quantityGroup_8xawn_421",Ag="_quantityLabel_8xawn_429",Eg="_compactInput_8xawn_445",Dg="_modalFooter_8xawn_453",Og="_button_8xawn_471",Lg="_buttonPrimary_8xawn_491",$g="_buttonSecondary_8xawn_511",Rg="_buttonDisabled_8xawn_533",Fg="_errorText_8xawn_543",zg="_noResults_8xawn_563",Bg="_skeletonContainer_8xawn_577",Mg="_skeletonItem_8xawn_585",ve={modalOverlay:ug,modalContent:dg,modalHeader:pg,modalTitle:hg,modalCloseButton:mg,modalBody:fg,formGroup:gg,inputField:yg,searchResultsCard:xg,searchResultsList:bg,searchResultItem:wg,searchResultPrice:kg,selectedTestsCard:Ng,selectedTestsHeader:jg,noTestsMessage:_g,selectedTestsList:vg,selectedTestItem:Sg,selectedTestName:Cg,removeTestButton:Pg,quantityRow:Tg,quantityGroup:Ig,quantityLabel:Ag,compactInput:Eg,modalFooter:Dg,button:Og,buttonPrimary:Lg,buttonSecondary:$g,buttonDisabled:Rg,errorText:Fg,noResults:zg,skeletonContainer:Bg,skeletonItem:Mg},qg=({isOpen:e,onClose:n,patientId:t,pharmacyInventory:r,fetchPharmacyOrdersData:a,isLoadingInventory:s=!1})=>{const[o,l]=x.useState([]),[u,c]=x.useState(""),[m,d]=x.useState([]),[y,p]=x.useState(null),[S,$]=x.useState(!1);lo(void 0,e?200:99999);const K=x.useMemo(()=>new co(r,{keys:["name"],threshold:.3}),[r]);x.useEffect(()=>{if(!u){d([]);return}const M=K.search(u).map(_=>_.item);d(M.slice(0,10))},[u,K]);const D=async()=>{if(!t){p("Patient ID is missing.");return}if(o.length===0){p("Please select at least one drug.");return}for(const M of o)if(M.selected_pack_quantity===0&&M.selected_loose_quantity===0){p(`Please specify a quantity for ${M.name}.`);return}$(!0),p(null);try{const M={patient_id:t,items:o.map(ee=>({drug_id:ee.id,name:ee.name,pack_quantity:ee.selected_pack_quantity,loose_quantity:ee.selected_loose_quantity,pack_price:0,loose_price:0,total_price:0,tabletsPerDay:1,numberOfDays:1,directions_to_use:"As directed"})),order_total:0,prescription_for_unavailable_drugs:""},_=await W("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(M)});if(!_.ok){const ee=await _.json().catch(()=>({}));throw new Error(ee.message||`Failed to create pharmacy order: ${_.statusText} `)}await _.json(),a(t),n(),l([]),c("")}catch(M){p(`Order Creation Error: ${M.message} `)}finally{$(!1)}},X=M=>{if(o.some(_=>_.id===M.id)){p(`${M.name} is already in the order.`),setTimeout(()=>p(null),3e3),c(""),d([]);return}l(_=>[..._,{...M,selected_pack_quantity:0,selected_loose_quantity:0}]),c(""),d([])},z=M=>{l(_=>_.filter(ee=>ee.id!==M))},Y=(M,_,ee)=>{const je=parseInt(ee)||0;l(se=>se.map(ue=>ue.id===M?{...ue,[_==="pack"?"selected_pack_quantity":"selected_loose_quantity"]:je}:ue))};return e?i.jsx("div",{className:ve.modalOverlay,children:i.jsxs("div",{className:ve.modalContent,children:[i.jsxs("div",{className:ve.modalHeader,children:[i.jsx("h3",{className:ve.modalTitle,children:"Create Pharmacy Order"}),i.jsx("button",{onClick:n,className:ve.modalCloseButton,children:i.jsx(Xt,{size:20})})]}),i.jsxs("div",{className:ve.modalBody,children:[y&&i.jsx("div",{className:ve.errorText,children:y}),i.jsxs("div",{className:ve.formGroup,style:{position:"relative"},children:[i.jsx("label",{htmlFor:"drug-search",children:"Add Drug"}),i.jsx("input",{type:"text",id:"drug-search",placeholder:"Search available drugs...",value:u,onChange:M=>c(M.target.value),className:ve.inputField,autoComplete:"off"}),u&&i.jsx("div",{className:ve.searchResultsCard,children:s?i.jsx("div",{className:ve.skeletonContainer,children:[1,2,3].map(M=>i.jsxs("div",{className:ve.skeletonItem,children:[i.jsx(Ie,{width:"60%",height:20}),i.jsx(Ie,{width:"30%",height:20})]},M))}):m.length>0?i.jsx("ul",{className:ve.searchResultsList,children:m.map(M=>i.jsx("li",{onClick:()=>X(M),className:ve.searchResultItem,children:i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"},children:[i.jsx("span",{children:M.name}),i.jsxs("span",{className:ve.searchResultPrice,children:["Stock: ",M.stock," (Box) / ",M.loose||0," (Loose)"]})]})},M.id))}):i.jsx("div",{className:ve.noResults,children:"No drugs found."})})]}),i.jsxs("div",{className:ve.selectedTestsCard,children:[i.jsx("h4",{className:ve.selectedTestsHeader,children:"Selected Drugs"}),o.length===0?i.jsx("p",{className:ve.noTestsMessage,children:"No drugs added yet."}):i.jsx("ul",{className:ve.selectedTestsList,children:o.map(M=>i.jsxs("li",{className:ve.selectedTestItem,children:[i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",width:"100%",alignItems:"center"},children:[i.jsx("span",{className:ve.selectedTestName,children:M.name}),i.jsx("button",{type:"button",onClick:()=>z(String(M.id)),className:ve.removeTestButton,title:"Remove Drug",children:i.jsx(bt,{size:16})})]}),i.jsxs("div",{className:ve.quantityRow,children:[i.jsxs("div",{className:ve.quantityGroup,children:[i.jsx("label",{className:ve.quantityLabel,children:"Packs"}),i.jsx("input",{type:"number",min:"0",className:`${ve.inputField} ${ve.compactInput}`,value:M.selected_pack_quantity||"",onChange:_=>Y(M.id,"pack",_.target.value),placeholder:"0"})]}),i.jsxs("div",{className:ve.quantityGroup,children:[i.jsx("label",{className:ve.quantityLabel,children:"Loose"}),i.jsx("input",{type:"number",min:"0",className:`${ve.inputField} ${ve.compactInput}`,value:M.selected_loose_quantity||"",onChange:_=>Y(M.id,"loose",_.target.value),placeholder:"0"})]})]})]},M.id))})]})]}),i.jsxs("div",{className:ve.modalFooter,children:[i.jsx("button",{type:"button",onClick:n,className:`${ve.button} ${ve.buttonSecondary}`,children:" Cancel "}),i.jsxs("button",{type:"button",onClick:D,disabled:o.length===0||S,className:`${ve.button} ${ve.buttonPrimary} ${o.length===0||S?ve.buttonDisabled:""}`,children:[" ",S?"Creating...":"Create Order"," "]})]})]})}):null},Ug=({isOpen:e,onClose:n,onSuccess:t,patientId:r,initialItems:a})=>{const[s,o]=x.useState([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:"",packs:0,loose:0,pack_size:1}]),[l,u]=x.useState(30),[c,m]=x.useState(""),[d,y]=x.useState(null),[p,S]=x.useState(""),[$,K]=x.useState([]),[D,X]=x.useState(!1),[z,Y]=x.useState(!1),[M,_]=x.useState(null),ee=x.useRef(null);x.useEffect(()=>{if(e){a&&a.length>0?o(a):o([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:"",packs:0,loose:0,pack_size:1}]);const R=new Date;R.setDate(R.getDate()+30),m(R.toISOString().split("T")[0]),u(30)}},[e,a]);const je=x.useCallback(async R=>{if(!R.trim()){K([]);return}X(!0);try{const Z=await W(`/api/drugs?search=${encodeURIComponent(R)}&limit=10`);if(Z.ok){const Q=await Z.json();K(Q.drugs||[])}}catch(Z){console.error("Error searching drugs:",Z)}finally{X(!1)}},[]);x.useEffect(()=>{ee.current&&clearTimeout(ee.current),p&&d!==null?ee.current=setTimeout(()=>je(p),300):K([])},[p,d,je]);const se=R=>{if(!R)return 1;const Z=R.match(/(?:\d+x)?(\d+)(?:s|tabs)?/i);return Z?parseInt(Z[1],10):1},ue=(R,Z)=>{const Q=[...s];Q[Z]={...Q[Z],medication_name:R.name,drug_id:R.id,pack_size:se(R.pack),packs:0,loose:0,quantity:0},o(Q),y(null),S(""),K([])},U=(R,Z,Q)=>{const Pe=[...s],le={...Pe[R]},w=le.pack_size||1;if(Z==="packs"||Z==="loose"){const ze=parseInt(Q)||0;Z==="packs"&&(le.packs=ze),Z==="loose"&&(le.loose=ze);const _e=le.packs||0,b=le.loose||0;le.quantity=_e*w+b}else if(Z==="tablets_per_day"||Z==="number_of_days"){Z==="tablets_per_day"&&(le.tablets_per_day=Q),Z==="number_of_days"&&(le.number_of_days=Q);const ze=parseFloat(le.tablets_per_day.toString())||0,_e=parseInt(le.number_of_days.toString())||0,b=Math.ceil(ze*_e);le.quantity=b,le.packs=Math.floor(b/w),le.loose=b%w}else le[Z]=Q;Pe[R]=le,o(Pe)},O=()=>{o([...s,{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:l,directions:"",notes:"",packs:0,loose:0,pack_size:1}])},E=R=>{s.length>1&&o(s.filter((Z,Q)=>Q!==R))},ge=async R=>{if(R.preventDefault(),_(null),!r){_("Patient ID is missing.");return}if(s.some(Q=>!Q.medication_name||Q.quantity<=0)){_("Please ensure all items have a medication name and valid quantity.");return}Y(!0);try{const Q={patient_id:r,items:s.map(le=>({medication_name:le.medication_name,drug_id:le.drug_id,quantity:le.quantity,tablets_per_day:le.tablets_per_day,number_of_days:le.number_of_days,directions:le.directions,notes:le.notes,frequency_days:l,next_delivery_date:c}))},Pe=await W("/api/recurring-medications",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Q)});if(!Pe.ok){const le=await Pe.json();throw new Error(le.message+(le.error?": "+le.error:"")||"Failed to create recurring medication.")}t(),n()}catch(Q){_(Q.message)}finally{Y(!1)}};return e?i.jsx("div",{className:"modal-overlay",children:i.jsxs("div",{className:"add-recurring-modal wide-modal",children:[i.jsxs("div",{className:"modal-header",children:[i.jsx("h3",{children:"Add Recurring Medications"}),i.jsx("button",{className:"close-btn",onClick:n,children:i.jsx(Xt,{size:20})})]}),i.jsxs("div",{className:"modal-body",children:[M&&i.jsx("div",{className:"error-message",children:M}),i.jsxs("form",{onSubmit:ge,className:"recurring-form",children:[i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group flex-1",children:[i.jsxs("label",{children:[i.jsx(uo,{size:16})," Frequency"]}),i.jsxs("select",{value:l,onChange:R=>{const Z=parseInt(R.target.value);u(Z);const Q=new Date;Q.setDate(Q.getDate()+Z),m(Q.toISOString().split("T")[0]);const Pe=s.map(le=>({...le,number_of_days:Z}));o(Pe)},children:[i.jsx("option",{value:15,children:"Every 15 Days"}),i.jsx("option",{value:30,children:"Every 30 Days"}),i.jsx("option",{value:60,children:"Every 60 Days"}),i.jsx("option",{value:90,children:"Every 90 Days"})]})]}),i.jsxs("div",{className:"form-group flex-1",children:[i.jsxs("label",{children:[i.jsx(Hn,{size:16})," Next Delivery"]}),i.jsx("input",{type:"date",value:c,onChange:R=>m(R.target.value)})]})]}),i.jsx("hr",{className:"divider"}),i.jsxs("div",{className:"items-header",children:[i.jsx("h4",{children:"Medications"}),i.jsxs("button",{type:"button",className:"add-item-btn",onClick:O,children:[i.jsx(Nr,{size:14})," Add Drug"]})]}),i.jsx("div",{className:"items-list",children:s.map((R,Z)=>i.jsxs("div",{className:"medication-item-row",children:[i.jsxs("div",{className:"row-top",children:[i.jsxs("div",{className:"form-group med-search-group",children:[i.jsx("label",{children:"Drug Name"}),i.jsxs("div",{className:"search-wrapper",children:[i.jsx("input",{type:"text",placeholder:"Search drug...",value:d===Z?p:R.medication_name,onFocus:()=>{y(Z),S(R.medication_name)},onChange:Q=>{S(Q.target.value),U(Z,"medication_name",Q.target.value)}}),d===Z&&D&&i.jsx("span",{className:"spinner",children:"..."}),d===Z&&p&&$.length>0&&i.jsx("ul",{className:"suggestions-list",children:$.map(Q=>i.jsxs("li",{onClick:()=>ue(Q,Z),children:[i.jsx("div",{className:"suggestion-name",children:Q.name}),i.jsxs("div",{className:"suggestion-details",children:["Stock: ",Q.stock]})]},Q.id))})]})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Tabs/Day"}),i.jsx("input",{type:"number",min:"0.5",step:"0.5",value:R.tablets_per_day,onChange:Q=>U(Z,"tablets_per_day",Q.target.value)})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Days"}),i.jsx("input",{type:"number",min:"1",value:R.number_of_days,onChange:Q=>U(Z,"number_of_days",Q.target.value)})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Packs"}),i.jsx("input",{type:"number",min:"0",value:R.packs||"",onChange:Q=>U(Z,"packs",Q.target.value),placeholder:"0"})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Loose"}),i.jsx("input",{type:"number",min:"0",value:R.loose||"",onChange:Q=>U(Z,"loose",Q.target.value),placeholder:"0"})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Total"}),i.jsx("input",{type:"number",value:R.quantity,disabled:!0,className:"input-disabled"})]}),i.jsx("button",{type:"button",className:"remove-btn",onClick:()=>E(Z),disabled:s.length===1,children:i.jsx(bt,{size:16})})]}),i.jsxs("div",{className:"row-bottom",children:[i.jsx("div",{className:"form-group flex-1",children:i.jsx("input",{type:"text",placeholder:"Directions (e.g. 1-0-1 after food)",value:R.directions,onChange:Q=>U(Z,"directions",Q.target.value)})}),i.jsx("div",{className:"form-group flex-1",children:i.jsx("input",{type:"text",placeholder:"Notes",value:R.notes,onChange:Q=>U(Z,"notes",Q.target.value)})})]})]},R.id))}),i.jsxs("div",{className:"modal-actions",children:[i.jsx("button",{type:"button",className:"btn-cancel",onClick:n,children:"Cancel"}),i.jsx("button",{type:"submit",className:"btn-submit",disabled:z,children:z?"Creating...":"Create Recurring Order"})]})]})]})]})}):null},Hg=({isOpen:e,onClose:n,onSuccess:t,medication:r})=>{const[a,s]=x.useState(""),[o,l]=x.useState(0),[u,c]=x.useState(1),[m,d]=x.useState(30),[y,p]=x.useState(""),[S,$]=x.useState(""),[K,D]=x.useState(30),[X,z]=x.useState(""),[Y,M]=x.useState("active"),[_,ee]=x.useState(!1),[je,se]=x.useState(null);x.useEffect(()=>{if(e&&r){s(r.medicationName),l(r.quantity),c(r.tabletsPerDay||1),d(r.numberOfDays||30),p(r.directions||""),$(r.notes||""),D(r.frequencyDays),M(r.status);try{const O=new Date(r.nextDeliveryDate);isNaN(O.getTime())||z(O.toISOString().split("T")[0])}catch(O){console.error("Error parsing date",O)}}},[e,r]);const ue=async O=>{if(O.preventDefault(),se(null),!a||o<=0){se("Please provide a valid medication name and quantity.");return}ee(!0);try{const E={medication_name:a,quantity:o,tablets_per_day:u,number_of_days:m,directions:y,notes:S,frequency_days:K,next_delivery_date:X,status:Y},ge=await W(`/api/recurring-medications/${r.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(E)});if(!ge.ok){const R=await ge.json();throw new Error(R.message||"Failed to update recurring medication.")}t(),n()}catch(E){se(E.message)}finally{ee(!1)}},U=async()=>{if(window.confirm("Are you sure you want to delete this recurring medication?")){ee(!0);try{if(!(await W(`/api/recurring-medications/${r.id}`,{method:"DELETE"})).ok)throw new Error("Failed to delete recurring medication.");t(),n()}catch(O){se(O.message)}finally{ee(!1)}}};return e?i.jsx("div",{className:"modal-overlay",children:i.jsxs("div",{className:"add-recurring-modal medium-modal",children:[i.jsxs("div",{className:"modal-header",children:[i.jsx("h3",{children:"Edit Recurring Medication"}),i.jsx("button",{className:"close-btn",onClick:n,children:i.jsx(Xt,{size:20})})]}),i.jsxs("div",{className:"modal-body",children:[je&&i.jsx("div",{className:"error-message",children:je}),i.jsxs("form",{onSubmit:ue,className:"recurring-form",children:[i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Medication Name"}),i.jsx("input",{type:"text",value:a,onChange:O=>s(O.target.value)})]}),i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group flex-1",children:[i.jsxs("label",{children:[i.jsx(uo,{size:16})," Frequency"]}),i.jsxs("select",{value:K,onChange:O=>D(parseInt(O.target.value)),children:[i.jsx("option",{value:15,children:"Every 15 Days"}),i.jsx("option",{value:30,children:"Every 30 Days"}),i.jsx("option",{value:60,children:"Every 60 Days"}),i.jsx("option",{value:90,children:"Every 90 Days"})]})]}),i.jsxs("div",{className:"form-group flex-1",children:[i.jsxs("label",{children:[i.jsx(Hn,{size:16})," Next Delivery"]}),i.jsx("input",{type:"date",value:X,onChange:O=>z(O.target.value)})]})]}),i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group flex-1",children:[i.jsx("label",{children:"Tabs/Day"}),i.jsx("input",{type:"number",min:"0.5",step:"0.5",value:u,onChange:O=>c(parseFloat(O.target.value))})]}),i.jsxs("div",{className:"form-group flex-1",children:[i.jsx("label",{children:"Days"}),i.jsx("input",{type:"number",min:"1",value:m,onChange:O=>d(parseInt(O.target.value))})]}),i.jsxs("div",{className:"form-group flex-1",children:[i.jsx("label",{children:"Total Qty"}),i.jsx("input",{type:"number",min:"1",value:o,onChange:O=>l(parseInt(O.target.value))})]})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Directions"}),i.jsx("input",{type:"text",value:y,onChange:O=>p(O.target.value)})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Notes"}),i.jsx("input",{type:"text",value:S,onChange:O=>$(O.target.value)})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Status"}),i.jsxs("select",{value:Y,onChange:O=>M(O.target.value),children:[i.jsx("option",{value:"active",children:"Active"}),i.jsx("option",{value:"paused",children:"Paused"}),i.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),i.jsxs("div",{className:"modal-actions space-between",children:[i.jsxs("button",{type:"button",className:"btn-delete-text",onClick:U,children:[i.jsx(bt,{size:16})," Delete"]}),i.jsxs("div",{className:"flex-row gap-10",children:[i.jsx("button",{type:"button",className:"btn-cancel",onClick:n,children:"Cancel"}),i.jsx("button",{type:"submit",className:"btn-submit",disabled:_,children:_?"Saving...":"Save Changes"})]})]})]})]})]})}):null},Vg=({isOpen:e,onClose:n,billData:t})=>{if(x.useEffect(()=>{if(e&&t){const s=setTimeout(()=>{window.print()},500);return()=>clearTimeout(s)}},[e,t]),!e||!t)return null;const r=t.clinicUpiId&&t.grandTotal>0?`upi://pay?pa=${t.clinicUpiId}&pn=${encodeURIComponent(t.clinicName)}&am=${t.grandTotal.toFixed(2)}&cu=INR`:"",a=i.jsxs("div",{id:"print-modal-root",className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 print:bg-white print:static print:block",children:[i.jsxs("div",{className:"bg-white w-full max-w-4xl h-[90vh] overflow-y-auto rounded-lg shadow-xl print:shadow-none print:w-full print:max-w-none print:h-auto print:overflow-visible relative",children:[i.jsx("button",{onClick:n,className:"absolute top-4 right-4 z-50 p-2 bg-gray-100 hover:bg-gray-200 rounded-full no-print",children:i.jsx(Xt,{size:24})}),i.jsx("div",{className:"pharmacy-billing-page",style:{padding:0,minHeight:"auto",background:"white"},children:i.jsx("div",{className:"billing-container printable-section",style:{border:"none",boxShadow:"none",maxWidth:"100%",margin:0},children:i.jsxs("div",{className:"p-8 print:p-0",children:[i.jsxs("div",{className:"billing-header print-only",children:[i.jsx("div",{className:"clinic-header-left",children:i.jsx("div",{className:"clinic-info-print",children:i.jsxs("div",{className:"clinic-name-and-details-print",children:[i.jsx("h1",{className:"bill-title",children:"INVOICE"}),i.jsx("h2",{className:"clinic-name-print",children:t.clinicName?`${t.clinicName} Lab`:"Lab Bill"}),(t.clinicAddress||t.clinicNotes)&&i.jsxs("div",{className:"clinic-details-print",children:[t.clinicAddress&&i.jsx("span",{className:"small-text clinic-address",children:t.clinicAddress}),t.clinicNotes&&i.jsx("span",{className:"small-text clinic-notes",children:t.clinicNotes})]})]})})}),i.jsxs("div",{className:"patient-info-grid print-only-patient-details mt-4 text-sm",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem"},children:[i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Ji,{size:16})," Patient Name"]}),t.patientName]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(_r,{size:16})," Token"]}),t.patientToken||"N/A"]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Hn,{size:16})," Order Date"]}),new Date(t.orderDate).toLocaleDateString()]})]})]}),i.jsx("div",{className:"medications-card mb-6",style:{border:"none",boxShadow:"none"},children:i.jsxs("table",{className:"medications-table w-full text-left collapse",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b-2 border-gray-300",children:[i.jsx("th",{className:"py-2",children:"S.No."}),i.jsx("th",{className:"py-2",children:"TEST DESCRIPTION"}),i.jsx("th",{className:"py-2 text-right",children:"PRICE"}),i.jsx("th",{className:"py-2 text-right",children:"DIS %"}),i.jsx("th",{className:"py-2 text-right",children:"AMT"})]})}),i.jsx("tbody",{children:t.items.map((s,o)=>{const l=s.price??0,u=l*(s.discount_percentage??0)/100,c=l-u;return i.jsxs("tr",{className:"border-b border-gray-100",children:[i.jsx("td",{className:"py-2",children:o+1}),i.jsx("td",{className:"py-2 font-medium",children:s.name}),i.jsx("td",{className:"py-2 text-right",children:s.price.toFixed(2)}),i.jsxs("td",{className:"py-2 text-right",children:[s.discount_percentage??0,"%"]}),i.jsx("td",{className:"py-2 text-right font-bold",children:c.toFixed(2)})]},o)})})]})}),i.jsx("div",{className:"bill-summary-print flex justify-end",children:i.jsxs("div",{className:"bill-summary-details w-1/3 bg-gray-50 p-4 rounded print:w-1/2 print:bg-transparent print:p-0",children:[i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Subtotal"}),i.jsxs("span",{children:["₹",t.subtotal.toFixed(2)]})]}),i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Total Discount"}),i.jsxs("span",{children:["- ₹",t.totalDiscount.toFixed(2)]})]}),i.jsxs("div",{className:"print-only-total flex justify-between font-bold text-lg border-t pt-2 mt-2",children:[i.jsx("span",{children:"Grand Total:"}),i.jsxs("span",{children:["₹",t.grandTotal.toFixed(2)]})]}),r&&i.jsxs("div",{className:"qr-code-container mt-4 flex flex-col items-center",style:{boxShadow:"none",background:"transparent"},children:[i.jsx(Qi,{value:r,size:80}),i.jsx("p",{className:"text-xs mt-1 text-center text-gray-500",children:"Scan to pay"})]})]})}),i.jsxs("footer",{className:"billing-footer mt-8 text-center text-xs text-gray-500 print:absolute print:bottom-0 print:w-full",children:[i.jsx("p",{children:"Thank you for your business!"}),i.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})})})]}),i.jsx("style",{children:`
                @media print {
                    /* Hide EVERYTHING in body */
                    body > * {
                        display: none !important;
                    }
                    
                    /* Explicitly hide #root to override any other styles */
                    #root {
                        display: none !important;
                    }

                    /* Show ONLY our portal root */
                    #print-modal-root {
                        display: block !important;
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        background: white !important;
                        z-index: 99999 !important;
                    }

                     /* Reset visibility for children of the portal */
                    #print-modal-root * {
                        visibility: visible !important;
                    }
                    
                    /* IMPORTANT: Prevent style tags from being displayed by the wildcard above */
                    #print-modal-root style {
                        display: none !important;
                    }
                    
                     /* Specifically restore display for key layout containers that rely on Flex */
                    .flex { display: flex !important; }
                    .grid { display: grid !important; }
                    .table { display: table !important; }
                    tr { display: table-row !important; }
                    td, th { display: table-cell !important; }

                    /* Ensure no scrollbars in print */
                    .overflow-y-auto {
                        overflow: visible !important;
                        height: auto !important;
                    }

                    /* 
                       CRITICAL: Hide elements explicitly marked with no-print class 
                       Must be at the END to override any restoration rules above.
                    */
                    #print-modal-root .no-print, .no-print {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                    }
                }
            `})]});return Gi.createPortal(a,document.body)},Wg=({isOpen:e,onClose:n,billData:t})=>{if(x.useEffect(()=>{if(e&&t){const s=setTimeout(()=>{window.print()},500);return()=>clearTimeout(s)}},[e,t]),!e||!t)return null;const r=t.clinicUpiId&&t.grandTotal>0?`upi://pay?pa=${t.clinicUpiId}&pn=${encodeURIComponent(t.clinicName)}&am=${t.grandTotal.toFixed(2)}&cu=INR`:"",a=i.jsxs("div",{id:"print-pharmacy-modal-root",className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 print:bg-white print:static print:block",children:[i.jsxs("div",{className:"bg-white w-full max-w-4xl h-[90vh] overflow-y-auto rounded-lg shadow-xl print:shadow-none print:w-full print:max-w-none print:h-auto print:overflow-visible relative",children:[i.jsx("button",{onClick:n,className:"absolute top-4 right-4 z-50 p-2 bg-gray-100 hover:bg-gray-200 rounded-full no-print",children:i.jsx(Xt,{size:24})}),i.jsx("div",{className:"pharmacy-billing-page",style:{padding:0,minHeight:"auto",background:"white"},children:i.jsx("div",{className:"billing-container printable-section",style:{border:"none",boxShadow:"none",maxWidth:"100%",margin:0},children:i.jsxs("div",{className:"p-8 print:p-0",children:[i.jsxs("div",{className:"billing-header print-only",children:[i.jsx("div",{className:"clinic-header-left",children:i.jsx("div",{className:"clinic-info-print",children:i.jsxs("div",{className:"clinic-name-and-details-print",children:[i.jsx("h1",{className:"bill-title",children:"INVOICE"}),i.jsx("h2",{className:"clinic-name-print",children:t.clinicName?`${t.clinicName} Pharmacy`:"Pharmacy Bill"}),(t.clinicAddress||t.clinicNotes)&&i.jsxs("div",{className:"clinic-details-print",children:[t.clinicAddress&&i.jsx("span",{className:"small-text clinic-address",children:t.clinicAddress}),t.clinicNotes&&i.jsx("span",{className:"small-text clinic-notes",children:t.clinicNotes})]})]})})}),i.jsxs("div",{className:"patient-info-grid print-only-patient-details mt-4 text-sm",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem"},children:[i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Ji,{size:16})," Patient Name"]}),t.patientName]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(_r,{size:16})," Token"]}),t.patientToken||"N/A"]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Hn,{size:16})," Order Date"]}),new Date(t.orderDate).toLocaleDateString()]})]})]}),i.jsx("div",{className:"medications-card mb-6",style:{border:"none",boxShadow:"none"},children:i.jsxs("table",{className:"medications-table w-full text-left collapse",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b-2 border-gray-300",children:[i.jsx("th",{className:"py-2",children:"S.No."}),i.jsx("th",{className:"py-2",children:"DESCRIPTION"}),i.jsx("th",{className:"py-2",children:"BATCH"}),i.jsx("th",{className:"py-2",children:"EXPIRY"}),i.jsx("th",{className:"py-2",children:"QTY"}),i.jsx("th",{className:"py-2 text-right",children:"MRP"}),i.jsx("th",{className:"py-2 text-right",children:"DIS %"}),i.jsx("th",{className:"py-2 text-right",children:"AMT"})]})}),i.jsx("tbody",{children:t.items.map((s,o)=>i.jsxs("tr",{className:"border-b border-gray-100",children:[i.jsx("td",{className:"py-2",children:o+1}),i.jsx("td",{className:"py-2 font-medium",children:s.name}),i.jsx("td",{className:"py-2",children:s.batch||"-"}),i.jsx("td",{className:"py-2",children:s.expiry_date?new Date(s.expiry_date).toLocaleDateString():"-"}),i.jsxs("td",{className:"py-2",children:[s.pack_quantity?`${s.pack_quantity} Pkts `:"",s.loose_quantity?`${s.loose_quantity} Loose`:""]}),i.jsx("td",{className:"py-2 text-right",children:s.mrp.toFixed(2)}),i.jsxs("td",{className:"py-2 text-right",children:[s.discount_percentage??0,"%"]}),i.jsx("td",{className:"py-2 text-right font-bold",children:s.price.toFixed(2)})]},o))})]})}),i.jsx("div",{className:"bill-summary-print flex justify-end",children:i.jsxs("div",{className:"bill-summary-details w-1/3 bg-gray-50 p-4 rounded print:w-1/2 print:bg-transparent print:p-0",children:[i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Subtotal"}),i.jsxs("span",{children:["₹",t.subtotal.toFixed(2)]})]}),i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Total Discount"}),i.jsxs("span",{children:["- ₹",t.totalDiscount.toFixed(2)]})]}),i.jsxs("div",{className:"print-only-total flex justify-between font-bold text-lg border-t pt-2 mt-2",children:[i.jsx("span",{children:"Grand Total:"}),i.jsxs("span",{children:["₹",t.grandTotal.toFixed(2)]})]}),r&&i.jsxs("div",{className:"qr-code-container mt-4 flex flex-col items-center",style:{boxShadow:"none",background:"transparent"},children:[i.jsx(Qi,{value:r,size:80}),i.jsx("p",{className:"text-xs mt-1 text-center text-gray-500",children:"Scan to pay"})]})]})}),i.jsxs("footer",{className:"billing-footer mt-8 text-center text-xs text-gray-500 print:absolute print:bottom-0 print:w-full",children:[i.jsx("p",{children:"Thank you for your business!"}),i.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})})})]}),i.jsx("style",{children:`
                @media print {
                    body > * { display: none !important; }
                    #root { display: none !important; }
                    #print-pharmacy-modal-root {
                        display: block !important;
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        background: white !important;
                        z-index: 99999 !important;
                    }
                    #print-pharmacy-modal-root * { visibility: visible !important; }
                    #print-pharmacy-modal-root style { display: none !important; }
                    
                    .flex { display: flex !important; }
                    .grid { display: grid !important; }
                    .table { display: table !important; }
                    tr { display: table-row !important; }
                    td, th { display: table-cell !important; }

                    .overflow-y-auto { overflow: visible !important; height: auto !important; }
                    #print-pharmacy-modal-root .no-print, .no-print {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                    }
                }
            `})]});return Gi.createPortal(a,document.body)},Jg=({isOpen:e,onClose:n,billData:t})=>{if(x.useEffect(()=>{if(e&&t){const s=setTimeout(()=>{window.print()},500);return()=>clearTimeout(s)}},[e,t]),!e||!t)return null;const r=t.clinicUpiId&&t.grandTotal>0?`upi://pay?pa=${t.clinicUpiId}&pn=${encodeURIComponent(t.clinicName)}&am=${t.grandTotal.toFixed(2)}&cu=INR`:"",a=i.jsxs("div",{id:"print-custom-modal-root",className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 print:bg-white print:static print:block",children:[i.jsxs("div",{className:"bg-white w-full max-w-4xl h-[90vh] overflow-y-auto rounded-lg shadow-xl print:shadow-none print:w-full print:max-w-none print:h-auto print:overflow-visible relative",children:[i.jsx("button",{onClick:n,className:"absolute top-4 right-4 z-50 p-2 bg-gray-100 hover:bg-gray-200 rounded-full no-print",children:i.jsx(Xt,{size:24})}),i.jsx("div",{className:"pharmacy-billing-page",style:{padding:0,minHeight:"auto",background:"white"},children:i.jsx("div",{className:"billing-container printable-section",style:{border:"none",boxShadow:"none",maxWidth:"100%",margin:0},children:i.jsxs("div",{className:"p-8 print:p-0",children:[i.jsxs("div",{className:"billing-header print-only",children:[i.jsx("div",{className:"clinic-header-left",children:i.jsx("div",{className:"clinic-info-print",children:i.jsxs("div",{className:"clinic-name-and-details-print",children:[i.jsx("h1",{className:"bill-title",children:"INVOICE"}),i.jsx("h2",{className:"clinic-name-print",children:t.clinicName||"Clinic Bill"}),(t.clinicAddress||t.clinicNotes)&&i.jsxs("div",{className:"clinic-details-print",children:[t.clinicAddress&&i.jsx("span",{className:"small-text clinic-address",children:t.clinicAddress}),t.clinicNotes&&i.jsx("span",{className:"small-text clinic-notes",children:t.clinicNotes})]})]})})}),i.jsxs("div",{className:"patient-info-grid print-only-patient-details mt-4 text-sm",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem"},children:[i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Ji,{size:16})," Patient Name"]}),t.patientName]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(_r,{size:16})," Token"]}),t.patientToken||"N/A"]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Hn,{size:16})," Date"]}),new Date(t.orderDate).toLocaleDateString()]}),i.jsxs("div",{className:"info-item no-print",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(_r,{size:16})," Bill No"]}),t.billId]})]})]}),i.jsx("div",{className:"medications-card mb-6",style:{border:"none",boxShadow:"none"},children:i.jsxs("table",{className:"medications-table w-full text-left collapse",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b-2 border-gray-300",children:[i.jsx("th",{className:"py-2",children:"S.No."}),i.jsx("th",{className:"py-2",children:"DESCRIPTION"}),i.jsx("th",{className:"py-2 text-center",children:"QTY"}),i.jsx("th",{className:"py-2 text-right",children:"PRICE"}),i.jsx("th",{className:"py-2 text-right",children:"AMOUNT"})]})}),i.jsx("tbody",{children:t.items.map((s,o)=>{const l=s.quantity||1,u=s.price,c=s.unit_price||u/l;return i.jsxs("tr",{className:"border-b border-gray-100",children:[i.jsx("td",{className:"py-2",children:o+1}),i.jsx("td",{className:"py-2 font-medium",children:s.name}),i.jsx("td",{className:"py-2 text-center",children:l}),i.jsx("td",{className:"py-2 text-right",children:c.toFixed(2)}),i.jsx("td",{className:"py-2 text-right font-bold",children:u.toFixed(2)})]},o)})})]})}),i.jsx("div",{className:"bill-summary-print flex justify-end",children:i.jsxs("div",{className:"bill-summary-details w-1/3 bg-gray-50 p-4 rounded print:w-1/2 print:bg-transparent print:p-0",children:[i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Subtotal"}),i.jsxs("span",{children:["₹",t.subtotal.toFixed(2)]})]}),i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Total Discount"}),i.jsxs("span",{children:["- ₹",t.totalDiscount.toFixed(2)]})]}),i.jsxs("div",{className:"print-only-total flex justify-between font-bold text-lg border-t pt-2 mt-2",children:[i.jsx("span",{children:"Grand Total:"}),i.jsxs("span",{children:["₹",t.grandTotal.toFixed(2)]})]}),r&&i.jsxs("div",{className:"qr-code-container mt-4 flex flex-col items-center",style:{boxShadow:"none",background:"transparent"},children:[i.jsx(Qi,{value:r,size:80}),i.jsx("p",{className:"text-xs mt-1 text-center text-gray-500",children:"Scan to pay"})]})]})}),i.jsxs("footer",{className:"billing-footer mt-8 text-center text-xs text-gray-500 print:absolute print:bottom-0 print:w-full",children:[i.jsx("p",{children:"Thank you for your business!"}),i.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})})})]}),i.jsx("style",{children:`
                @media print {
                    body > * { display: none !important; }
                    #root { display: none !important; }
                    #print-custom-modal-root {
                        display: block !important;
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        background: white !important;
                        z-index: 99999 !important;
                    }
                    #print-custom-modal-root * { visibility: visible !important; }
                    #print-custom-modal-root style { display: none !important; }
                    
                    .flex { display: flex !important; }
                    .grid { display: grid !important; }
                    .table { display: table !important; }
                    tr { display: table-row !important; }
                    td, th { display: table-cell !important; }

                    .overflow-y-auto { overflow: visible !important; height: auto !important; }
                    #print-custom-modal-root .no-print, .no-print {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                    }
                }
            `})]});return Gi.createPortal(a,document.body)},Qg=({messages:e})=>{const n=x.useRef(null);return x.useEffect(()=>{n.current&&(n.current.scrollTop=n.current.scrollHeight)},[e]),i.jsxs("div",{className:"conversation-panel",children:[i.jsxs("div",{className:"conversation-header",children:[i.jsx("div",{className:"conversation-title",children:i.jsx("h3",{children:"Conversation"})}),i.jsxs("span",{className:"conversation-count",children:[e.length," messages"]})]}),i.jsxs("div",{ref:n,className:"message-list custom-scrollbar",children:[e.length===0&&i.jsx("div",{className:"empty-state",children:"Start talking to the AI..."}),e.map(t=>i.jsxs("div",{className:`message-wrapper ${t.role}`,children:[i.jsx("div",{className:`message-bubble ${t.role} ${t.role==="system"?t.type||"info":""}`,children:t.role==="ai"||t.role==="system"&&t.type==="loading"?i.jsx("div",{className:"prose prose-sm max-w-none",children:t.role==="system"&&t.type==="loading"?i.jsxs("div",{className:"typing-indicator",children:[i.jsx("span",{className:"dot"}),i.jsx("span",{className:"dot"}),i.jsx("span",{className:"dot"})]}):i.jsx(Yt,{remarkPlugins:[jt],children:t.content})}):i.jsx("div",{className:"whitespace-pre-wrap",children:t.content})}),t.role!=="system"&&i.jsx("span",{className:"message-timestamp",children:t.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]},t.id))]})]})},Gg=e=>po({queryKey:pt.patients.context(e||""),queryFn:async()=>{if(!e)throw new Error("Patient ID is required");const n=await W(`/api/patients/${e}/context`);if(!n.ok)throw new Error("Failed to fetch patient context");return n.json()},enabled:!!e,staleTime:5*60*1e3}),Ei=e=>{if(!e)return"";const n=new Date(e);if(isNaN(n.getTime()))return"";const t=n.getTimezoneOffset()*6e4;return new Date(n.getTime()-t).toISOString().slice(0,16)},Kg=(e,n=[])=>{const r=(z=>[1,2,3,14,15,16,17,18,19,30,31,32].includes(z)?"molar":[4,5,12,13,20,21,28,29].includes(z)?"premolar":[6,11,22,27].includes(z)?"canine":"incisor")(e),a=e<=16,s={molar:{crown:"M5,20 Q5,5 18,5 Q31,5 31,20 L29,25 Q18,28 7,25 Z",roots:["M7,25 Q5,40 10,44 Q14,40 14,26","M29,25 Q31,40 26,44 Q22,40 22,26"]},premolar:{crown:"M8,20 Q8,8 18,8 Q28,8 28,20 L26,24 Q18,27 10,24 Z",roots:["M10,24 Q16,44 18,45 Q20,44 26,24"]},canine:{crown:"M8,22 Q18,2 28,22 L26,25 Q18,28 10,25 Z",roots:["M10,25 Q18,48 26,25"]},incisor:{crown:"M10,22 L10,12 Q18,12 26,12 L26,22 L24,25 Q18,27 12,25 Z",roots:["M12,25 Q18,46 24,25"]}},{crown:o,roots:l}=s[r],u=n.includes("condition-rct"),c=n.includes("condition-filling"),m=n.includes("condition-crown"),d=n.includes("condition-bridge"),y=n.includes("condition-extraction"),p=n.includes("condition-implant"),S=u?"#e9d5ff":"#f3f4f6",$=y?"#fee2e2":m?"#fde047":d?"#67e8f9":"#ffffff",K=y?"#ef4444":d?"#0891b2":p?"#475569":m?"#b45309":"#6b7280",D=d||m||p?2:1.5;let X=`<svg viewBox="0 0 36 50" width="24" height="34" style="display:inline-block;${a?"transform:rotate(180deg);":""}">`;return l.forEach(z=>{X+=`<path d="${z}" fill="${S}" stroke="${K}" stroke-width="${D}" stroke-linejoin="round"/>`}),u&&(r==="molar"?(X+='<path d="M12,28 L11,42" fill="none" stroke="#9333ea" stroke-width="2.5" stroke-linecap="round"/>',X+='<path d="M24,28 L25,42" fill="none" stroke="#9333ea" stroke-width="2.5" stroke-linecap="round"/>'):X+='<path d="M18,25 L18,44" fill="none" stroke="#9333ea" stroke-width="2.5" stroke-linecap="round"/>'),X+=`<path d="${o}" fill="${$}" stroke="${K}" stroke-width="${D}" stroke-linejoin="round"/>`,c&&!m&&!d&&(X+='<circle cx="18" cy="16" r="4" fill="#3b82f6" stroke="#1d4ed8" stroke-width="1"/>'),y&&(X+='<line x1="8" y1="8" x2="28" y2="42" stroke="#ef4444" stroke-width="3" stroke-linecap="round"/>',X+='<line x1="28" y1="8" x2="8" y2="42" stroke="#ef4444" stroke-width="3" stroke-linecap="round"/>'),X+="</svg>",X},Xg=()=>{var fs,gs;const{openCommandBar:e}=bc(),{recordId:n,patientId:t}=wc(),[r,a]=x.useState(n||void 0),s=kc(),o=Nc(),l=jc(),[u,c]=x.useState(""),[m]=x.useState([]),[d,y]=x.useState(null),[p,S]=x.useState(null),[$,K]=x.useState(void 0),[D,X]=x.useState(void 0),[z,Y]=x.useState(null),[M,_]=x.useState(!1),[ee,je]=x.useState(""),[se,ue]=x.useState(!1),[U,O]=x.useState(null),[E,ge]=x.useState(null),[R,Z]=x.useState(!1),[Q,Pe]=x.useState([]),[le,w]=x.useState(!1),[ze,_e]=x.useState(null),[b,qe]=x.useState(""),[Ue,ke]=x.useState(""),[Ge,De]=x.useState(null),[it,lt]=x.useState(!1),[ct,en]=x.useState(!1),[tn,nn]=x.useState(!1),[j,Ct]=x.useState(window.innerHeight),[mt,ft]=x.useState([]),[Qe,Pt]=x.useState(!1),[Rt,Ft]=x.useState(null),[Je,Tt]=x.useState([]),[wt,T]=x.useState([]),[F,ne]=x.useState([]),[H,P]=x.useState(!1),[ye,Te]=x.useState(null),Be=x.useRef(null),Ke=x.useRef(null),Ce=x.useRef(!1),Fe=x.useRef(null),Ye=x.useRef(null),He=x.useRef(null),re=x.useRef(null),v=x.useRef(null),L=x.useRef(null),C=x.useRef(null),[I,ie]=x.useState([]),[te,A]=x.useState(!1);x.useEffect(()=>{(async()=>{if(I.length>0&&!te){A(!0);const g=I[0];g.current&&(g.current.scrollIntoView({behavior:"smooth",block:"center"}),g.current.classList.add("ai-glow"),await new Promise(f=>setTimeout(f,2e3)),g.current&&g.current.classList.remove("ai-glow")),ie(f=>f.slice(1)),A(!1)}})()},[I,te]);const G=h=>{let g=null;switch(h){case"update_patient_details":g=He;break;case"create_pharmacy_order":case"edit_pharmacy_order":case"create_and_bill_pharmacy_order":case"create_custom_bill":break;case"create_lab_order":case"edit_lab_order":g=v;break;case"add_complaint_history":g=L;break;case"update_case_summary":g=C;break}g&&ie(f=>[...f,g])},[Ne,fe]=x.useState(55),[ae,de]=x.useState(!1),he=x.useRef(null),B=x.useRef(null),J=x.useRef(null),xe=x.useRef(null),Ve=150,[ce,Se]=x.useState([]),[Ae,Xe]=x.useState([]),[Ze,gt]=x.useState(!0),[It,at]=x.useState(null),[bn,wn]=x.useState(!1),[Qn,Gn]=x.useState(!1),[fl,gl]=x.useState(!1),[yl,xl]=x.useState(!1),[bl,wl]=x.useState(!1),[Ar,At]=x.useState([]),[kn,da]=x.useState(!1),[pa,ha]=x.useState(null),[Kn,Er]=x.useState(!1),[ma,fa]=x.useState(null),[Nn,kl]=x.useState({}),[Nl,ga]=x.useState(!1),[ya,xa]=x.useState(!1),[ba,wa]=x.useState(!1),[ka,Yn]=x.useState(!1),[Na,Dr]=x.useState(!1),[ja,jn]=x.useState([]),[Or,Xn]=x.useState(void 0),[jl,_a]=x.useState(!1),[_l,vl]=x.useState(null),[Sl,va]=x.useState(!1),[Cl,Pl]=x.useState(null),[Tl,Sa]=x.useState(!1),[Il,Al]=x.useState(null),[yt,Ca]=x.useState(!1),[Lr,Pa]=x.useState(!1),[$r,Ta]=x.useState(!1),[Rr,Ia]=x.useState(!1),[Fr,Aa]=x.useState(!1),[Zn,_n]=x.useState(!1),er=x.useMemo(()=>(p==null?void 0:p.admission_date)&&!(p!=null&&p.discharge_date),[p]),[El,tr]=x.useState(!1),[Ea,zr]=x.useState(null),[Br,Mr]=x.useState(""),[qr,Ur]=x.useState(void 0),[Hr,Vr]=x.useState(void 0),[Wr,Jr]=x.useState(void 0),[Et,Qr]=x.useState(!1),[Da,Jt]=x.useState(null),[Oa,Gr]=x.useState(null),[La,Kr]=x.useState(null),[$a,vn]=x.useState(null),[Dt,rn]=x.useState(""),[Sn,nr]=x.useState(!1),[Cn,Dl]=x.useState(!1),rr=x.useRef(null),[Ra,Yr]=x.useState(null),[Fa,an]=x.useState([]),Xr=x.useCallback(h=>{an(g=>[...g,{id:Math.random().toString(36).substr(2,9),timestamp:new Date,role:"system",content:"",...h}])},[]),[Zr,za]=x.useState(null),[Ba,Ma]=x.useState(!1),ir=x.useRef(null),ar=x.useRef(null),[Ol,ei]=x.useState(!1),[sr,qa]=x.useState(!1),[or,Ua]=x.useState(null),[Ll,lr]=x.useState(!1),[$l,Ha]=x.useState(!1),[Oe,ti]=x.useState(null),[cr,ni]=x.useState(""),[Pn,Tn]=x.useState(""),[Va,Wa]=x.useState(!0),[sn,Ja]=x.useState(!1),[ri,ur]=x.useState(!1),[on,Qa]=x.useState(!1),[Rl,Ga]=x.useState(!1),In=x.useRef(null),Fl=async()=>{In.current&&(await In.current.undoLastAction(),Ga(!1))},zl=h=>{Pl(h),va(!0)},Bl=h=>{Al(h),Sa(!0)},ln=async h=>{try{const g=await W(`/api/patients/${h}`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`Failed to fetch patient details: ${g.status}`)}const f=await g.json();if(S(f),K(f.age),X(f.gender),qe(f.ai_response||""),S(k=>k?{...k,current_status:f.current_status,admission_date:f.admission_date,discharge_date:f.discharge_date}:{...f,current_status:f.current_status,admission_date:f.admission_date,discharge_date:f.discharge_date}),f.insurance_type&&S(k=>k?{...k,insurance_type:f.insurance_type}:{...f}),si(h),f.ai_response){const k=/```json\s*([\s\S]*?)\s*```/,N=f.ai_response.match(k);if(N&&N[1])ke(f.ai_response.replace(k,"").trim()),De(N[1].trim());else{const V=f.ai_response.trim();if(V.startsWith("{")&&V.endsWith("}"))try{JSON.parse(V),ke(""),De(V)}catch{ke(V),De(null)}else if(V.startsWith("[")&&V.endsWith("]"))try{JSON.parse(V),ke(""),De(V)}catch{ke(V),De(null)}else ke(V),De(null)}}else ke(""),De(null)}catch{S(null),qe(""),ke(""),De(null)}},Ml=async(h,g)=>{S(f=>f?{...f,insurance_type:g}:null);try{const f=await W(`/api/patients/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({insurance_type:g})});if(!f.ok){const k=await f.json();throw new Error(k.message||"Failed to update insurance type")}}catch(f){console.error("Error updating insurance type:",f),h&&ln(h)}},Ka=async h=>{P(!0),Te(null),ne([]);try{const g=await W(`/api/queue/patient/${h}/complaints`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`HTTP error! status: ${g.status}`)}const f=await g.json();ne(f||[])}catch(g){Te(`Past complaints error: ${g.message}`)}finally{P(!1)}},cn=async h=>{Tt([]);try{const g=await W(`/api/pharmacy-orders/patient/${h}`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`HTTP error! status: ${g.status}`)}const f=await g.json();Tt(f||[])}catch{}},un=async h=>{da(!0),ha(null),At([]);try{const g=await W(`/api/lab/orders/patient/${h}`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`HTTP error! status: ${g.status}`)}const f=await g.json();At(f||[])}catch(g){ha(`Pending labs error: ${g.message}`)}finally{da(!1)}},An=async h=>{Pt(!0),Ft(null),ft([]);try{const g=await W(`/api/lab/patient/${h}`);if(!g.ok){const N=await g.json().catch(()=>({}));throw new Error(N.message||`HTTP error! status: ${g.status}`)}const k=(await g.json()||[]).map(N=>({...N.report,id:N.id,patient_id:N.patient_id,createdAt:N.createdAt,tests:N.tests,status:N.status}));ft(k)}catch(g){Ft(`Lab reports error: ${g.message}`)}finally{Pt(!1)}},{data:Ot,isLoading:zt}=Gg(d),En=x.useCallback(async h=>{h===d?await o.invalidateQueries({queryKey:pt.patients.context(h)}):y(h)},[d,o]);x.useEffect(()=>{if(Ot){console.log("EditComplaintPage: Syncing data from useQuery cache");const h=Ot.patient;if(h){if(S(h),K(h.age),X(h.gender),qe(h.ai_response||""),h.ai_response){const g=/```json\s*([\s\S]*?)\s*```/,f=h.ai_response.match(g);if(f&&f[1])ke(h.ai_response.replace(g,"").trim()),De(f[1].trim());else{const k=h.ai_response.trim();k.startsWith("{")||k.startsWith("[")?(ke(""),De(k)):(ke(k),De(null))}}_n(h.current_status==="In Doctor Queue"||h.current_status==="In Consultation")}if(ne(Ot.history||[]),Tt(Ot.pharmacyOrders||[]),Ot.labOrders){At(Ot.labOrders.filter(f=>!f.report));const g=Ot.labOrders.filter(f=>f.report).map(f=>({...f.report,id:f.id,patient_id:f.patient_id,createdAt:f.createdAt,tests:f.tests}));ft(g)}T(Ot.recurringMedications||[])}},[Ot]),x.useEffect(()=>{(async()=>{if(d)try{const g=await o.fetchQuery({queryKey:pt.patientDebts.balance(d),queryFn:async()=>{const f=await W(`/api/patient-debts/${d}/balance`);return f.ok?f.json():{netDebt:0}},staleTime:6e4});Ua(g.netDebt||0)}catch(g){console.error("Error fetching patient debt:",g),Ua(0)}})()},[d,o]);const ii=x.useCallback(()=>{if(!p)return;const h={id:p.id,token:p.patient_token_number??null,name:p.name,age:p.age??null,gender:p.gender==="M"||p.gender==="F"||p.gender==="O"?p.gender:null,phone:p.phone};s("/dashboard/dental",{state:{patient:h}})},[p,s]),ql=x.useCallback(()=>{if(!p)return;const h={id:p.id,token:p.patient_token_number??null,name:p.name,age:p.age??null,gender:p.gender==="M"||p.gender==="F"||p.gender==="O"?p.gender:null,phone:p.phone};s("/dashboard/medical",{state:{patient:h}})},[p,s]),{data:ai}=po({queryKey:pt.dental.records(d),queryFn:async()=>{const h=await W(`/api/dental/patient/${d}`);if(!h.ok)throw new Error("Failed to fetch dental records");return h.json()},enabled:!!d,staleTime:5*60*1e3});x.useEffect(()=>{Pe(ai||[])},[ai]);const{conditions:dr,details:pr}=x.useMemo(()=>{const h={},g={},f=(N,V)=>{h[N]||(h[N]=[]);const pe=`condition-${V}`;h[N].includes(pe)||h[N].push(pe)},k=(N,V)=>{g[N]||(g[N]=[]),g[N].push(V)};return Q.forEach(N=>{N.teeth&&Array.isArray(N.teeth)&&N.teeth.forEach(V=>{V.procedures.forEach(pe=>{var be;let oe=(be=N.selected_procedures)==null?void 0:be.find(Nt=>Nt.id===pe);oe&&oe.type!=="general"&&(f(V.toothNumber,oe.type),k(V.toothNumber,{name:oe.name,date:new Date(N.date||N.createdAt||0).toLocaleDateString(),recordId:N.id,isPast:!0}))})})}),{conditions:h,details:g}},[Q]),si=async h=>{try{const g=await o.fetchQuery({queryKey:pt.queue.latest(h),queryFn:async()=>{const f=await W(`/api/queue/patient/${h}/latest`);if(!f.ok)throw new Error("Failed");return f.json()},staleTime:5e3});if(g){const f=new Date(g.createdAt),k=new Date,N=f.getDate()===k.getDate()&&f.getMonth()===k.getMonth()&&f.getFullYear()===k.getFullYear(),V=["waiting","consulting"].includes(g.status);_n(N&&V)}else _n(!1)}catch(g){console.error("Error checking patient queue status:",g),_n(!1)}},oi=x.useCallback(async(h,g)=>{try{if(!(await W(`/api/pharmacy-orders/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:g})})).ok)throw new Error("Failed to update pharmacy order date");d&&cn(d)}catch(f){console.error("Error updating pharmacy order date:",f),_e("Failed to update pharmacy order date")}},[d]),Dn=x.useCallback(async(h,g,f)=>{try{const k={};if(g==="order"?k.date=f:g==="report"&&(k.reportDate=f),!(await W(`/api/lab/orders/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)})).ok)throw new Error("Failed to update lab date");d&&(un(d),An(d))}catch(k){console.error("Error updating lab order date:",k),_e("Failed to update lab order date")}},[d]),li=x.useCallback(h=>{s(`/dashboard/edit-pharmacy-order/${h}`)},[s]),Ya=x.useCallback(h=>{const g=h.medications.map((f,k)=>({id:Date.now()+k,medication_name:f.name,drug_id:f.drug_id?String(f.drug_id):null,quantity:(f.pack_quantity||0)*(f.pack_size||1)+(f.loose_quantity||0),tablets_per_day:f.tabletsPerDay||1,number_of_days:f.numberOfDays||30,directions:f.directions_to_use||"",notes:"",packs:f.pack_quantity,loose:f.loose_quantity,pack_size:f.pack_size}));jn(g),Yn(!0)},[]),Xa=x.useCallback(h=>{_e(null),console.log(`Preparing billing navigation for order: ${h}`);const g=Je.find(f=>f.id===h);if(g){const f=g.medications.map(k=>{const N=k.price??0;return(k.price===void 0||k.price===null)&&console.warn(`Medication "${k.name}" in order ${h} is missing a price. Defaulting to 0.`),{name:k.name,pack_quantity:k.pack_quantity,loose_quantity:k.loose_quantity,price:N,pack_price:k.pack_price,loose_price:k.loose_price,total_price:Number(k.total_price)||0,isLoose:k.isLoose,unit:k.unit,drug_id:k.drug_id?String(k.drug_id):null,tabletsPerDay:k.tabletsPerDay,numberOfDays:k.numberOfDays,directions_to_use:k.directions_to_use,discount_percentage:k.discount_percentage??0,batch:k.batch,expiry_date:k.expiry_date}});console.log("Navigating to /dashboard/pharmacy-billing with state:",{initialItems:f}),s(`/dashboard/pharmacy-billing/${h}`,{state:{initialItems:f}})}else console.error(`Order with ID ${h} not found.`),_e(`Order with ID ${h} not found.`),alert(`Error: Could not find order ${h} to bill.`)},[Je,s]),Za=x.useCallback(async(h,g)=>{_e(null);const f=Je.find(N=>N.id===h);if(!f){_e(`Order with ID ${h} not found.`);return}const k={status:g,medications:f.medications};try{const N=await W(`/api/pharmacy-orders/${h}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)});if(!N.ok){const pe=await N.text();throw new Error(`Failed to update status: ${N.statusText} (${N.status}) - ${pe}`)}const V=await N.json();Tt(pe=>pe.map(oe=>oe.id===V.id?{...oe,status:V.status}:oe)),d&&cn(d)}catch(N){console.error("Failed to update order status:",N),_e(N.message||`Failed to update status for order ${h}.`),alert(`Error updating status for order ${h}: ${N.message||"Please try again."}`)}},[Je,d]),ci=x.useCallback(h=>{At(g=>g.map(f=>f.id===h?{...f,isEditing:!0,editedTests:[...f.tests],editedStatus:f.status}:{...f,isEditing:!1}))},[]),Ul=x.useCallback(h=>{At(g=>g.map(f=>f.id===h?{...f,isEditing:!1,editedTests:void 0,editedStatus:void 0}:f))},[]),Hl=x.useCallback((h,g,f,k)=>{At(N=>N.map(V=>{if(V.id===h){const pe=V.editedTests?[...V.editedTests]:[...V.tests];if(f==="add")return{...V,editedTests:[...pe,{id:"",name:"",price:0}]};if(f==="remove")return{...V,editedTests:k};if(g!==-1){const oe={...pe[g],[f]:k};return pe[g]=oe,{...V,editedTests:pe}}}return V}))},[]),Vl=x.useCallback((h,g)=>{At(f=>f.map(k=>k.id===h?{...k,editedStatus:g}:k))},[]),es=x.useCallback(async h=>{if(!h){console.error("Cannot navigate to billing: Lab Order data is missing."),alert("Could not open billing page: Lab Order information is missing.");return}s(`/dashboard/lab-billing/${h.id}`)},[s]),ts=x.useCallback(async(h,g)=>{console.log(`Updating lab order ${h} to status ${g}`);try{const f=await W(`/api/lab/${h}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:g})});if(!f.ok){const k=await f.json();throw new Error(k.message||`Failed to update lab order status: ${f.status}`)}d&&(un(d),An(d)),console.log(`Lab Order ${h} status updated to ${g}, refetching data.`)}catch(f){console.error("Error updating lab order status:",f),alert(`Failed to update lab order status: ${f instanceof Error?f.message:"Unknown error"}`)}},[d]),hr=x.useCallback(h=>{h&&h.id?s(`/lab/report/${h.id}`):(console.error("Cannot navigate: Lab Order or Lab Order ID is missing."),alert("Could not open the report entry page: Lab Order information is missing."))},[s]),Wl=x.useCallback(async(h,g,f)=>{Ca(!0),_e(null);try{if(!g||g.length===0)throw new Error("Lab order must have at least one test.");for(const V of g)if(!V.id||!V.name||isNaN(V.price)||V.price<0)throw new Error(`Invalid test data: ${JSON.stringify(V)}. Each test must have id, name, and a valid price.`);const k={tests:g,status:f},N=await W(`/api/lab/orders/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)});if(!N.ok){const V=await N.json().catch(()=>({}));throw new Error(V.message||`Failed to update lab order: ${N.statusText}`)}d&&un(d),At(V=>V.map(pe=>pe.id===h?{...pe,isEditing:!1,editedTests:void 0,editedStatus:void 0}:pe))}catch(k){_e(`Lab Order Save Error: ${k.message}`)}finally{Ca(!1)}},[d]),Bt=x.useCallback(async h=>{if(!window.confirm(`Are you sure you want to delete this ${h.type.toLowerCase()} record? This action cannot be undone.`))return;Er(!0),fa(null);let f=null,k;const N=h.type;try{switch(N){case"Complaint":if(k=h.data.id,!k)throw new Error("Complaint ID is missing.");f=`/api/patients/complaints/${k}`;break;case"Lab Order":if(k=h.data.id,!k)throw new Error("Lab Order ID is missing.");f=`/api/lab/orders/${k}`;break;case"Lab Report":if(k=h.data.reportId,!k)throw new Error("Lab Report ID is missing.");f=`/api/lab/reports/${k}`;break;case"Pharmacy Order":if(k=h.data.id,!k)throw new Error("Pharmacy Order ID is missing.");f=`/api/pharmacy-orders/${k}`;break;default:throw new Error(`Deletion not supported for item type: ${N}`)}if(!f)throw new Error(`Could not determine delete URL for type: ${N}`);const V=await W(f,{method:"DELETE"});if(!V.ok){const pe=await V.json().catch(()=>({}));throw new Error(pe.message||`Failed to delete ${N}: ${V.statusText}`)}d&&(N==="Complaint"?Ka(d):N==="Lab Order"?(un(d),An(d)):N==="Lab Report"?An(d):N==="Pharmacy Order"&&cn(d))}catch(V){fa(`Delete Error (${N}): ${V.message}`),Kn&&Er(!1)}finally{Er(!1)}},[d,Kn]),ns=x.useCallback(async()=>{if(!d)return;if(Je.filter(g=>g.status==="pending").length<2){alert("You need at least two pending orders to merge.");return}qa(!0);try{const g=await W(`/api/pharmacy-orders/patient/${d}/merge-pending`,{method:"POST"});if(!g.ok){const f=await g.json().catch(()=>({}));throw new Error(f.message||"Failed to merge orders")}cn(d)}catch(g){_e(`Merge Error: ${g.message}`)}finally{qa(!1)}},[d,Je]),Mt=x.useMemo(()=>{if(!d||!F)return[];const h=F.map(g=>({date:new Date(g.createdAt),type:"Complaint",data:g,originalDateString:g.createdAt})).filter(g=>!isNaN(g.date.getTime()));return h.sort((g,f)=>f.date.getTime()-g.date.getTime()),h},[d,F]),qt=x.useMemo(()=>{if(!d)return[];const h=new Map;(Ar??[]).forEach(f=>{h.set(f.id,{...f})}),(mt??[]).forEach(f=>{if(!h.has(f.id))h.set(f.id,{id:f.id,patient_id:f.patient_id,tests:f.tests,status:f.status,createdAt:f.createdAt,report:f});else{const k=h.get(f.id);k&&(k.report=f,k.status=f.status)}});let g=Array.from(h.values());return g.sort((f,k)=>new Date(f.createdAt).getTime()-new Date(k.createdAt).getTime()),g=g.map((f,k)=>({...f,serialNumber:k+1})),g.map(f=>({date:new Date(f.createdAt),type:"Lab Order",data:f,originalDateString:f.createdAt}))},[d,Ar,mt]),Qt=x.useCallback(async h=>{const g=h??u;if(!g.trim())return;ar.current&&(clearTimeout(ar.current),ar.current=null),Xr({role:"user",content:g});const f=Math.random().toString(36).substr(2,9);an(k=>[...k,{id:f,role:"system",type:"loading",content:"",timestamp:new Date}]),In.current?(await In.current.callGenerativeApi(g),an(k=>k.filter(N=>N.id!==f)),ar.current=setTimeout(()=>{an([])},1e4)):an(k=>k.filter(N=>N.id!==f))},[u,Xr,an]),rs=x.useCallback(()=>{const h="reports came,please anaylse";c(h),setTimeout(()=>{Qt(h)},0)},[Qt,c]),ui=x.useCallback(h=>{kl(g=>({...g,[h]:!g[h]}))},[]),kt=x.useMemo(()=>{if(!d||!Je)return[];const h=Je.map(g=>({date:new Date(g.date),type:"Pharmacy Order",data:g,originalDateString:g.date})).filter(g=>!isNaN(g.date.getTime()));return h.sort((g,f)=>f.date.getTime()-g.date.getTime()),h},[d,Je]),Jl=x.useCallback((h,g)=>i.jsxs("div",{className:"flex flex-col w-full",children:[i.jsxs("span",{className:"ai-context-text flex items-center",children:[kt.length-g,". Order Status: (",h.data.status,")",i.jsx("span",{className:"text-gray-400 ml-1 flex items-center",children:Ea===h.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",children:i.jsx("input",{type:"datetime-local",defaultValue:Ei(h.originalDateString),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:f=>{f.target.value&&oi(h.data.id,f.target.value),zr(null)},onKeyDown:f=>{if(f.key==="Enter"){const k=f.target;k.value&&oi(h.data.id,k.value),zr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/date ml-1",onClick:()=>zr(h.data.id),title:"Click to edit date",children:["(",new Date(h.originalDateString).toLocaleDateString(),")",i.jsx(xt,{size:14,className:"ml-1 text-gray-500 hover:text-gray-700"})]})}),i.jsxs("div",{className:"inline-flex space-x-2 ml-2",children:[i.jsx("button",{onClick:()=>li(h.data.id),className:"icon-button small",title:"Edit Pharmacy Order",children:i.jsx(xt,{size:12})}),h.data.prescriptionForUnavailableDrugs&&i.jsx("button",{onClick:()=>{const f=vi().use(jt).use(Ai).processSync(h.data.prescriptionForUnavailableDrugs).toString();di(f,"Unavailable Drugs Prescription")},className:"icon-button small",title:"Print Unavailable Drugs Prescription",children:i.jsx(zn,{size:12})}),h.data.status==="dispensed"||h.data.status==="billed"?i.jsx("button",{onClick:()=>s(`/dashboard/pharmacy-billing/${h.data.id}`),className:"icon-button small text-blue-600",title:"View Pharmacy Bill",children:i.jsx(hi,{size:12})}):i.jsx("button",{onClick:()=>Bt({type:"Pharmacy Order",data:h.data}),className:"icon-button small text-red-500",title:"Delete Pharmacy Order",children:i.jsx(bt,{size:12})}),h.data.status==="pending"&&i.jsx("button",{onClick:()=>Xa(h.data.id),className:"icon-button small",title:"Bill this pharmacy order",disabled:yt,children:i.jsx(mi,{size:12})}),h.data.status==="billed"&&i.jsx("button",{onClick:()=>Za(h.data.id,"dispensed"),className:"icon-button small",title:"Dispense this pharmacy order",disabled:yt,children:i.jsx(ys,{size:12})}),i.jsx("button",{onClick:()=>Ya(h.data),className:"icon-button small group-hover:block",title:"Add to Recurring Medications",children:i.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-repeat",children:[i.jsx("path",{d:"m17 2 4 4-4 4"}),i.jsx("path",{d:"M3 11v-1a4 4 0 0 1 4-4h14"}),i.jsx("path",{d:"m7 22-4-4 4-4"}),i.jsx("path",{d:"M21 13v1a4 4 0 0 1-4 4H3"})]})})]})]}),i.jsx("div",{className:"pharmacy-order-drugs-table-container mobile-edge-to-edge-table-container mt-2 cursor-pointer hover:bg-gray-50 transition-colors rounded p-1",onClick:()=>li(h.data.id),title:"Click to edit order",children:i.jsxs("table",{className:"pharmacy-order-drugs-table mobile-edge-to-edge-table w-full text-xs",children:[i.jsx("thead",{children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-1 px-2 text-left",children:"Drug Name"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Quantity"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Dosage"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Directions"})]})}),i.jsx("tbody",{children:h.data.medications.map((f,k)=>i.jsxs("tr",{children:[i.jsx("td",{className:"py-1 px-2",children:i.jsx("strong",{children:f.name})}),i.jsxs("td",{className:"py-1 px-2",children:[f.pack_quantity!==void 0&&f.pack_quantity>0&&`Packs: ${f.pack_quantity}`,f.pack_quantity!==void 0&&f.pack_quantity>0&&f.loose_quantity!==void 0&&f.loose_quantity>0&&", ",f.loose_quantity!==void 0&&f.loose_quantity>0&&`Loose: ${f.loose_quantity}`]}),i.jsx("td",{className:"py-1 px-2",children:f.tabletsPerDay&&f.numberOfDays?`${f.tabletsPerDay} tab/day for ${f.numberOfDays} days`:"N/A"}),i.jsx("td",{className:"py-1 px-2",children:f.directions_to_use||"N/A"})]},f.drug_id||f.name||k))})]})}),h.data.prescriptionForUnavailableDrugs&&i.jsxs("div",{className:"unavailable-drugs-markdown mt-2",children:[i.jsx("span",{className:"font-semibold text-xs text-gray-600 block mb-1",children:"Prescription for Unavailable Drugs:"}),i.jsx(Yt,{remarkPlugins:[jt],children:h.data.prescriptionForUnavailableDrugs})]})]}),[kt,Ea,oi,li,Xa,Za,Ya,Bt,yt,s]),Ql=x.useCallback((h,g)=>{const f=Nh(h.data.report?h.data.report.status:h.data.status),k=(h.data.tests||[]).reduce((N,V)=>N+(Number(V.price)||0),0).toFixed(2);return i.jsxs("div",{className:"flex flex-col w-full",children:[i.jsxs("div",{className:"flex justify-between items-start mb-2",children:[i.jsxs("div",{className:"ai-context-text flex items-center flex-wrap",children:[i.jsxs("span",{className:"font-medium cursor-pointer hover:text-blue-600 transition-colors mr-2",onClick:()=>hr(h.data),title:"Click to enter report",children:["#",h.data.serialNumber," [Order]"]}),i.jsx("span",{className:`mr-2 ${f.className}`,children:f.text}),i.jsx("span",{className:"text-gray-400 inline-flex items-center",children:Oa===h.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",onClick:N=>N.stopPropagation(),children:i.jsx("input",{type:"datetime-local",defaultValue:Ei(h.originalDateString),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:N=>{N.target.value&&Dn(h.data.id,"order",N.target.value),Gr(null)},onKeyDown:N=>{if(N.key==="Enter"){const V=N.target;V.value&&Dn(h.data.id,"order",V.value),Gr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/date ml-1",onClick:N=>{N.stopPropagation(),Gr(h.data.id)},title:"Click to edit order date",children:["(",new Date(h.originalDateString).toLocaleDateString(),")",i.jsx(xt,{size:14,className:"ml-1 text-gray-500 hover:text-gray-700"})]})})]}),!h.data.isEditing&&i.jsxs("div",{className:"flex space-x-1 items-center",children:[i.jsx("button",{onClick:()=>ci(h.data.id),className:"icon-button small",title:"Edit",disabled:yt,children:i.jsx(xt,{size:12})}),h.data.status==="pending"?i.jsx("button",{onClick:()=>es(h.data),className:"icon-button small font-medium text-green-600 w-auto px-1",title:`Pay total of ₹${k}`,disabled:yt,children:i.jsx(ho,{size:12})}):i.jsx("button",{onClick:()=>s(`/dashboard/lab-billing/${h.data.id}`),className:"icon-button small text-blue-600",title:"View Lab Bill",children:i.jsx(_c,{size:12})}),["pending","billed","collected","processing","report_ready","reported","completed"].includes(h.data.status)&&i.jsx("button",{onClick:()=>hr(h.data),className:"icon-button small text-indigo-600",title:"Enter Report",disabled:yt,children:i.jsx(hi,{size:12})}),(h.data.status==="report_ready"||h.data.status==="reported")&&i.jsx("button",{onClick:()=>ts(h.data.id,"completed"),className:"icon-button small text-green-600",title:"Mark Completed",disabled:yt,children:i.jsx(ys,{size:12})}),i.jsx("button",{onClick:()=>Bt({type:"Lab Order",data:h.data}),className:"icon-button small text-red-500",title:"Delete",disabled:yt,children:i.jsx(bt,{size:12})})]})]}),i.jsx("div",{className:"lab-order-tests-table-container mobile-edge-to-edge-table-container mt-1 mb-2 cursor-pointer hover:bg-gray-50 transition-colors rounded p-1 border border-gray-100",onClick:()=>{h.data.status==="pending"?ci(h.data.id):hr(h.data)},title:h.data.status==="pending"?"Click to edit order":"Click to enter report",children:i.jsxs("table",{className:"lab-order-tests-table mobile-edge-to-edge-table w-full text-xs text-left",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b bg-gray-50",children:[i.jsx("th",{className:"py-1 px-2 font-medium text-gray-600",children:"Test Name"}),i.jsx("th",{className:"py-1 px-2 text-right font-medium text-gray-600",children:"Price"})]})}),i.jsxs("tbody",{children:[h.data.tests&&h.data.tests.length>0?h.data.tests.map(N=>i.jsxs("tr",{className:"border-b last:border-0 hover:bg-gray-100",children:[i.jsx("td",{className:"py-1 px-2",children:N.name}),i.jsxs("td",{className:"py-1 px-2 text-right",children:["₹",N.price]})]},N.id||N.name)):i.jsx("tr",{children:i.jsx("td",{colSpan:2,className:"py-1 px-2 italic text-gray-500",children:"No tests specified"})}),i.jsxs("tr",{className:"bg-gray-50 font-semibold",children:[i.jsx("td",{className:"py-1 px-2 text-right text-gray-700",children:"Total:"}),i.jsxs("td",{className:"py-1 px-2 text-right text-gray-900",children:["₹",k]})]})]})]})}),h.data.report&&i.jsxs("div",{className:"ml-4 mt-1 p-2 border-l-2 border-gray-200",children:[i.jsxs("div",{className:"flex justify-between items-center mb-2",children:[i.jsx("span",{className:"font-medium text-sm text-gray-700",children:"[Report]"}),i.jsxs("div",{className:"flex items-center",children:[i.jsx("span",{className:"text-gray-400 ml-1 flex items-center text-xs",children:La===h.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",onClick:N=>N.stopPropagation(),children:i.jsx("input",{type:"datetime-local",defaultValue:Ei(h.data.report.report_date),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:N=>{N.target.value&&Dn(h.data.id,"report",N.target.value),Kr(null)},onKeyDown:N=>{if(N.key==="Enter"){const V=N.target;V.value&&Dn(h.data.id,"report",V.value),Kr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/reportDate ml-1",onClick:N=>{N.stopPropagation(),Kr(h.data.id)},title:"Click to edit report date",children:["(",new Date(h.data.report.report_date).toLocaleDateString(),")",i.jsx(xt,{size:12,className:"ml-1 text-gray-500 hover:text-gray-700"})]})}),i.jsx("button",{onClick:()=>ui(h.data.report.reportId),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400 ml-2",title:Nn[h.data.report.reportId]?"Collapse Report":"Expand Report",children:Nn[h.data.report.reportId]?i.jsx(xs,{size:14}):i.jsx(bs,{size:14})}),i.jsx("button",{onClick:()=>Bt({type:"Lab Report",data:h.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400 ml-1",title:"Delete Report",children:i.jsx(bt,{size:12})})]})]}),Nn[h.data.report.reportId]&&(()=>{try{const N=JSON.parse(h.data.report.report_content||"{}");return typeof N=="object"&&N!==null&&h.data.report.tests?h.data.report.tests.map(V=>i.jsxs("div",{style:{marginBottom:"10px"},children:[i.jsx("h5",{className:"font-semibold text-xs mt-2 mb-1 text-gray-700",children:V.name}),N[V.id]?i.jsx("div",{className:"mobile-edge-to-edge-table-container",children:i.jsxs("table",{className:"lab-inventory-table mobile-edge-to-edge-table w-full text-xs",children:[i.jsx("thead",{children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Parameter"}),i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Value"}),i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Normal Range"})]})}),i.jsx("tbody",{children:Object.entries(N[V.id]).map(([pe,oe])=>{var Nt;const be=(Nt=V.default_parameters)==null?void 0:Nt.find(dt=>dt.name===pe);return i.jsxs("tr",{className:"border-b last:border-0",children:[i.jsx("td",{className:"py-1 px-2",children:pe}),i.jsxs("td",{className:"py-1 px-2",children:[String(oe)," ",(be==null?void 0:be.unit)||""]}),i.jsx("td",{className:"py-1 px-2 text-gray-500",children:(()=>{if(be&&be.type==="number"&&(be.lower_limit!=null||be.upper_limit!=null)){let dt="";return be.lower_limit!=null&&(dt+=` > ${be.lower_limit}`),be.lower_limit!=null&&be.upper_limit!=null&&(dt+=" - "),be.upper_limit!=null&&(dt+=` < ${be.upper_limit}`),dt.trim()||"N/A"}else if((be==null?void 0:be.type)==="boolean")return"N/A";return(be==null?void 0:be.normal_range)||"N/A"})()})]},pe)})})]})}):i.jsx("p",{className:"italic text-gray-500 text-xs",children:"No parameters reported for this test."})]},V.id)):i.jsx("div",{className:"text-xs prose",children:i.jsx(Yt,{remarkPlugins:[jt],children:h.data.report.report_content})})}catch{return i.jsx("div",{className:"text-xs prose",children:i.jsx(Yt,{remarkPlugins:[jt],children:h.data.report.report_content||"*No findings recorded.*"})})}})()]})]})},[Oa,hr,Dn,ci,yt,es,s,Bt,La,Nn,ui,ts]),Gl=x.useCallback((h,g)=>i.jsx("div",{className:"ai-context-text w-full",children:$a===h.data.id?i.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[i.jsx("input",{type:"text",value:Dt,onChange:f=>rn(f.target.value),className:"border rounded px-2 py-1 text-sm w-full",autoFocus:!0,onKeyDown:async f=>{if(f.key==="Enter"&&Dt.trim()){nr(!0);try{await W(`/api/patients/complaints/${h.data.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:Dt.trim()})}),h.data.complaint=Dt.trim(),vn(null),rn("")}catch(k){console.error("Error updating complaint:",k)}nr(!1)}f.key==="Escape"&&(vn(null),rn(""))},disabled:Sn}),i.jsxs("div",{className:"flex gap-1",children:[i.jsx("button",{onClick:async()=>{if(Dt.trim()){nr(!0);try{await W(`/api/patients/complaints/${h.data.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:Dt.trim()})}),h.data.complaint=Dt.trim(),vn(null),rn("")}catch(f){console.error("Error updating complaint:",f)}nr(!1)}},className:"text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600",disabled:Sn||!Dt.trim(),children:Sn?"Saving...":"Save"}),i.jsx("button",{onClick:()=>{vn(null),rn("")},className:"text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300",disabled:Sn,children:"Cancel"})]})]}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 rounded px-1 -mx-1 transition-colors inline-block",onClick:()=>{vn(h.data.id),rn(h.data.complaint)},title:"Click to edit",children:[h.data.complaint,i.jsxs("span",{className:"text-gray-400 ml-1",children:["(",new Date(h.originalDateString).toLocaleDateString(),")"]})]})}),[$a,Dt,Sn,Bt]),Kl=x.useMemo(()=>i.jsxs("div",{className:"flex space-x-2",children:[i.jsx("button",{onClick:ns,className:"button-primary blue text-xs px-2 py-1",disabled:sr||Je.filter(h=>h.status==="pending").length<2,title:"Merge all pending orders into one",children:sr?"Merging...":"Merge Orders"}),i.jsxs("button",{onClick:()=>xa(!0),className:"button-primary green text-xs px-2 py-1",title:"Manually create a new pharmacy order",disabled:!d,children:[i.jsx(Nr,{size:12,className:"mr-1"})," Create Order"]})]}),[ns,sr,Je,d]),Yl=x.useMemo(()=>i.jsxs("div",{className:"flex space-x-2",children:[i.jsx("button",{onClick:rs,className:"button-primary blue text-xs px-2 py-1",title:"Tell AI to analyse the reports",disabled:R||ct||zt||Qe,children:"Analyse Reports"}),i.jsxs("button",{onClick:()=>ga(!0),className:"button-primary green text-xs px-2 py-1",title:"Manually create a new lab order",disabled:!d,children:[i.jsx(Nr,{size:12,className:"mr-1"})," Create Lab Order"]})]}),[rs,R,ct,zt,Qe,d]),[is,as]=x.useState(null),[ss,os]=x.useState([]),[mr,ls]=x.useState(!1),[fr,cs]=x.useState(""),us=(h,g)=>{if(!h||!h.report_content||!g)return"";try{const f=JSON.parse(h.report_content||"{}");if(typeof f!="object"||f===null)return`<p class="italic text-gray-500 text-xs">Report content is not structured data.</p><pre>${h.report_content}</pre>`;let k="";return g.forEach(N=>{f[N.id]?(k+=`<h5 class="font-semibold text-sm mt-2 mb-1">${N.name}</h5>`,k+='<table class="lab-report-print-table"><thead><tr><th>Parameter</th><th>Value</th><th>Normal Range</th></tr></thead><tbody>',Object.entries(f[N.id]).map(([V,pe])=>{var Nt;const oe=(Nt=N.default_parameters)==null?void 0:Nt.find(dt=>dt.name===V);let be="N/A";oe&&oe.type==="number"&&(oe.lower_limit!=null||oe.upper_limit!=null)?(be="",oe.lower_limit!=null&&(be+=` > ${oe.lower_limit}`),oe.lower_limit!=null&&oe.upper_limit!=null&&(be+=" - "),oe.upper_limit!=null&&(be+=` < ${oe.upper_limit}`),be=be.trim()||"N/A"):(oe==null?void 0:oe.type)==="boolean"?be="N/A":oe!=null&&oe.normal_range&&(be=oe.normal_range),k+=`<tr><td>${V}</td><td>${String(pe)} ${(oe==null?void 0:oe.unit)||""}</td><td>${be}</td></tr>`}),k+="</tbody></table>"):k+=`<p class="italic text-gray-500 text-xs">No parameters reported for ${N.name}.</p>`}),k}catch{return`<p class="italic text-gray-500 text-xs">Error parsing report content.</p><pre>${h.report_content}</pre>`}};x.useEffect(()=>{const h=()=>{Ct(window.innerHeight)};return window.addEventListener("resize",h),h(),()=>window.removeEventListener("resize",h)},[]),x.useEffect(()=>{const h=f=>{if(!ae||!xe.current||!J.current)return;const k=J.current.getBoundingClientRect(),V=f.clientX-xe.current.x;let pe=xe.current.initialWidth+V;const oe=k.width-Ve-10;pe=Math.max(Ve,pe),pe=Math.min(pe,oe);const be=pe/k.width*100;fe(be)},g=()=>{de(!1),xe.current=null,document.body.style.cursor="",document.body.style.userSelect=""};return ae&&(window.addEventListener("mousemove",h),window.addEventListener("mouseup",g),document.body.style.cursor="col-resize",document.body.style.userSelect="none"),()=>{window.removeEventListener("mousemove",h),window.removeEventListener("mouseup",g),document.body.style.cursor="",document.body.style.userSelect=""}},[ae]);const Xl=h=>{if(!J.current)return;h.preventDefault();const g=J.current.querySelector(".edit-complaint-context-column");g&&(xe.current={x:h.clientX,initialWidth:g.offsetWidth},de(!0))},ds=x.useCallback(async()=>{w(!0),_e(null);try{const h=await W("/api/queue/doctor/new",{method:"POST"});if(!h.ok){const f=await h.json().catch(()=>({}));throw new Error(f.message||`Failed to create record: ${h.statusText}`)}const g=await h.json();if(!g.recordId)throw new Error("New record ID not received from server.");s(`/edit-complaint/${g.recordId}`,{replace:!0})}catch(h){_e(`Failed to create new complaint record: ${h.message}`)}finally{w(!1)}},[s]);x.useEffect(()=>{(async()=>{Wa(!0);try{const g=await o.fetchQuery({queryKey:pt.clinicSettings,queryFn:async()=>{const f=await W("/api/clinics/settings");if(!f.ok)throw new Error("Failed to fetch clinic settings.");return f.json()},staleTime:18e5});ti({admissionCharge:parseFloat(g.admissionCharge||0).toFixed(2),perDayCharge:parseFloat(g.perDayCharge||0).toFixed(2),otherCharges:parseFloat(g.otherCharges||0).toFixed(2),aiMemory:g.aiMemory||"",aiMemoryUpdatedAt:g.aiMemoryUpdatedAt||null,clinicWideSystemPrompt:g.clinicWideSystemPrompt||"",clinicWideSystemPromptUpdatedAt:g.clinicWideSystemPromptUpdatedAt||null,gemini_api_key:g.gemini_api_key||""}),ni(g.aiMemory||""),Tn(g.clinicWideSystemPrompt||"")}catch{}finally{Wa(!1)}})()},[]),x.useEffect(()=>{var g;(g=l.state)!=null&&g.initialComplaint&&c(l.state.initialComplaint);const h=async f=>{Z(!0),_e(null);try{const k=await o.fetchQuery({queryKey:pt.queue.entry(f),queryFn:async()=>{const N=await W(`/api/queue/doctor/complaint/${f}`);if(!N.ok){const V=await N.json().catch(()=>({}));throw new Error(V.message||`HTTP error! status: ${N.status}`)}return N.json()},staleTime:6e4});y(k.patientId),K(k.age),X(k.gender),Y(k.case_summary||null),ge(k.updatedAt||null)}catch{_e("Failed to load current complaint details."),y(null),K(void 0),X(void 0),Y(null),ge(null)}finally{Z(!1)}};if(r)h(r);else if(t){const f=t;f&&(y(f),(async()=>{try{let N;try{N=await o.fetchQuery({queryKey:pt.queue.latest(f),queryFn:async()=>{const pe=await W(`/api/queue/patient/${f}/latest`);if(!pe.ok)throw new Error("Failed");return pe.json()},staleTime:5e3})}catch{}if(N!=null&&N._id){a(N._id),h(N._id);return}const V=await W("/api/queue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:f,complaint:"Visit Initiated"})});if(V.ok){const pe=await V.json();if(pe!=null&&pe.id){a(pe.id),h(pe.id);return}}}catch(N){console.error("Background queue resolution failed",N),_e("Failed to initialize visit record.")}})())}else ds()},[r,ds,(fs=l.state)==null?void 0:fs.initialComplaint,t]),x.useEffect(()=>{d?En(d):(S(null),ne([]),Tt([]),At([]),ft([]),ge(null),_n(!1))},[d]),x.useEffect(()=>{var f;const h=(f=l.state)==null?void 0:f.initialComplaint;h&&r&&(!R&&!H&&!kn&&!Qe&&!Ze)&&!Ce.current&&u===h&&(Ce.current=!0,Qt(),s(l.pathname,{replace:!0,state:{}}))},[(gs=l.state)==null?void 0:gs.initialComplaint,r,u,R,H,kn,Qe,Ze,s]);const ps=()=>{je(z||""),_(!0),O(null)},Zl=()=>{_(!1),je(""),O(null)},ec=async()=>{if(!r){O("Missing Record ID.");return}ue(!0),O(null);try{const h=await W(`/api/queue/doctor/complaint/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({case_summary:ee.trim()})});if(!h.ok){const f=await h.json().catch(()=>({}));throw new Error(f.message||`Failed to save case summary: ${h.statusText}`)}const g=await h.json();Y(g.case_summary||ee.trim()),ge(g.updatedAt||null),_(!1)}catch(h){O(`Save Error: ${h.message}`)}finally{ue(!1)}};x.useEffect(()=>{(async()=>{gt(!0),at(null);try{const[g,f]=await Promise.all([o.fetchQuery({queryKey:pt.drugs.all,queryFn:async()=>{const k=await W("/api/drugs");if(!k.ok)throw new Error(`Pharmacy inventory error! status: ${k.status}`);const N=await k.json();return N.drugs||N},staleTime:6e5}),o.fetchQuery({queryKey:pt.labTests.all,queryFn:async()=>{const k=await W("/api/lab-tests");if(!k.ok)throw new Error(`Lab inventory error! status: ${k.status}`);return k.json()},staleTime:6e5})]);Se(g),Xe(f||[])}catch(g){at(g.message)}finally{gt(!1)}})()},[]);const tc=async()=>{if(!Oe)return;if(cr===Oe.aiMemory&&Pn===Oe.clinicWideSystemPrompt){ur(!1);return}const h=cr!==Oe.aiMemory,g=Pn!==Oe.clinicWideSystemPrompt;h&&Ja(!0),g&&Qa(!0);try{const f={...Oe};h&&(f.aiMemory=cr),g&&(f.clinicWideSystemPrompt=Pn);const k=await W("/api/clinics/settings",{method:"PUT",body:JSON.stringify(f)});if(!k.ok){const V=await k.json().catch(()=>({}));throw new Error(V.message||"Failed to update clinic settings.")}const N=await k.json();ti({admissionCharge:parseFloat(N.settings.admissionCharge).toFixed(2),perDayCharge:parseFloat(N.settings.perDayCharge).toFixed(2),otherCharges:parseFloat(N.settings.otherCharges).toFixed(2),aiMemory:N.settings.aiMemory||"",aiMemoryUpdatedAt:N.settings.aiMemoryUpdatedAt||(Oe==null?void 0:Oe.aiMemoryUpdatedAt)||null,clinicWideSystemPrompt:N.settings.clinicWideSystemPrompt||"",clinicWideSystemPromptUpdatedAt:N.settings.clinicWideSystemPromptUpdatedAt||(Oe==null?void 0:Oe.clinicWideSystemPromptUpdatedAt)||null}),h&&ni(N.settings.aiMemory||""),g&&(Tn(N.settings.clinicWideSystemPrompt||""),ur(!1))}catch{}finally{h&&Ja(!1),g&&Qa(!1)}},hs=()=>{Oe&&(Tn(Oe.clinicWideSystemPrompt||""),ur(!0))},nc=()=>{ur(!1),Oe&&Tn(Oe.clinicWideSystemPrompt||"")},rc=h=>{navigator.clipboard.writeText(h).then(()=>{}).catch(g=>{console.error("Failed to copy text: ",g)})},di=(h,g)=>{const f=window.open("","_blank");f&&(f.document.write(`
        <html>
          <head>
            <title>${g}</title>
            <style>
              body { font-family: sans-serif; margin: 20px; }
              h2 { text-align: center; margin-bottom: 20px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              pre { white-space: pre-wrap; word-wrap: break-word; }
              .ai-context-section { margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 5px; }
              .ai-context-section-title { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; color: #333; }
              .ai-context-text { margin-bottom: 5px; }
              .text-gray-400 { color: #999; }
              .font-semibold { font-weight: 600; }
              .italic { font-style: italic; }
              .mt-2 { margin-top: 8px; }
              .ml-1 { margin-left: 4px; }
              .ml-2 { margin-left: 8px; }
              .flex { display: flex; }
              .flex-col { flex-direction: column; }
              .w-full { width: 100%; }
              .text-xs { font-size: 0.75rem; }
              .text-sm { font-size: 0.875rem; }
              .prose { max-width: 65ch; }
              .prose table { display: table; } /* Ensure tables in markdown render correctly */
            </style>
          </head>
          <body>
            <h2>${g}</h2>
            <div id="print-content">${h}</div>
          </body>
        </html>
      `),f.document.close(),f.print())},ic=()=>{if(b){const h=vi().use(jt).use(Ai).processSync(Ue).toString();di(`<div class="prose">${h}</div>`,"Summary")}};x.useEffect(()=>{if(p){let h=`
        <div class="print-section">
          <h3>Patient Details</h3>
          <p><strong>Name:</strong> ${p.name||"N/A"}</p>
          <p><strong>Token:</strong> ${p.patient_token_number||"N/A"}</p>
          <p><strong>Age:</strong> ${p.age||"N/A"}</p>
          <p><strong>Gender:</strong> ${p.gender||"N/A"}</p>
          <p><strong>Phone:</strong> ${p.phone||"N/A"}</p>
          <p><strong>Insurance:</strong> ${p.insurance_type||"N/A"}</p>
          <p><strong>Status:</strong> ${p.current_status||"N/A"}</p>
          <p><strong>Admitted:</strong> ${p.admission_date?new Date(p.admission_date).toLocaleDateString():"N/A"}</p>
          <p><strong>Discharged:</strong> ${p.discharge_date?new Date(p.discharge_date).toLocaleDateString():"N/A"}</p>
        </div>
        <div class="print-section">
          <h3>Case Summary</h3>
          <p>${z||"No summary available."}</p>
        </div>
        <div class="print-section">
          <h3>Complaints History</h3>
          ${Mt.length>0?`
            <ul>
              ${Mt.map(g=>`<li>${new Date(g.originalDateString).toLocaleDateString()}: ${g.data.complaint}</li>`).join("")}
            </ul>
          `:"<p>No past complaints.</p>"}
        </div>
        <div class="print-section">
          <h3>Pharmacy Orders</h3>
          ${kt.length>0?`
            <table class="print-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Drug Name</th>
                  <th>Quantity</th>
                  <th>Dosage</th>
                  <th>Directions</th>
                </tr>
              </thead>
              <tbody>
                ${kt.map(g=>{const f=g.data.medications.map((N,V)=>`
                    <tr>
                      ${V===0?`<td rowspan="${g.data.medications.length+(g.data.prescriptionForUnavailableDrugs?1:0)}">${new Date(g.originalDateString).toLocaleDateString()}</td>`:""}
                      ${V===0?`<td rowspan="${g.data.medications.length+(g.data.prescriptionForUnavailableDrugs?1:0)}">${g.data.status}</td>`:""}
                      <td><strong>${N.name}</strong></td>
                      <td>
                        ${N.pack_quantity!==void 0&&N.pack_quantity>0?`Packs: ${N.pack_quantity}`:""}
                        ${N.pack_quantity!==void 0&&N.pack_quantity>0&&N.loose_quantity!==void 0&&N.loose_quantity>0?", ":""}
                        ${N.loose_quantity!==void 0&&N.loose_quantity>0?`Loose: ${N.loose_quantity}`:""}
                      </td>
                      <td>${N.tabletsPerDay&&N.numberOfDays?`${N.tabletsPerDay} tab/day for ${N.numberOfDays} days`:"N/A"}</td>
                      <td>${N.directions_to_use||"N/A"}</td>
                    </tr>
                  `).join("");let k="";return g.data.prescriptionForUnavailableDrugs&&(k=`
                      <tr>
                        <td colspan="4" style="background-color: #f9f9f9; padding: 10px;">
                          <div style="font-style: italic; margin-bottom: 5px; font-weight: 600;">Prescription for Unavailable Drugs:</div>
                          <div class="prose" style="font-size: 0.9em;">${vi().use(jt).use(Ai).processSync(g.data.prescriptionForUnavailableDrugs).toString()}</div>
                        </td>
                      </tr>
                    `),f+k}).join("")}
              </tbody>
            </table>
          `:"<p>No pharmacy orders.</p>"}
        </div>
        <div class="print-section">
          <h3>Lab History (Orders & Reports)</h3>
          ${qt.length>0?`
            ${qt.map(g=>{const f=g.data.tests.map(N=>N.name).join(", ");let k="";return g.data.report&&(k=`
                  <div class="lab-report-print-container">
                    <h4>Lab Report (${new Date(g.data.report.report_date).toLocaleDateString()})</h4>
                    ${us(g.data.report,g.data.report.tests)}
                  </div>
                `),`
                <div class="lab-history-item">
                  <p><strong>Order Date:</strong> ${new Date(g.originalDateString).toLocaleDateString()}</p>
                  <p><strong>Status:</strong> ${g.data.status}</p>
                  <p><strong>Tests:</strong> ${f}</p>
                  ${k}
                </div>
              `}).join("")}
          `:"<p>No lab history.</p>"}
        </div>
      `;if(Object.keys(pr).length>0){const g=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],f=[32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17],k=(oe,be)=>{const Nt=dr[oe]||[],dt=Kg(oe,Nt);return`
            <div style="display:inline-flex;flex-direction:column;align-items:center;margin:2px;">
              ${be?`<span style="font-size:8px;color:#666;margin-bottom:2px;">${oe}</span>`:""}
              ${dt}
              ${be?"":`<span style="font-size:8px;color:#666;margin-top:2px;">${oe}</span>`}
            </div>
          `},N=g.map(oe=>k(oe,!0)).join(""),V=f.map(oe=>k(oe,!1)).join(""),pe=Object.entries(pr).sort(([oe],[be])=>Number(oe)-Number(be)).map(([oe,be])=>{const dt=(dr[Number(oe)]||[]).map(gr=>gr.replace("condition-","")).join(", "),gc=be.map(gr=>`${gr.name} (${gr.date})`).join("; ");return`
              <tr>
                <td><strong>Tooth ${oe}</strong></td>
                <td>${dt||"N/A"}</td>
                <td>${gc||"N/A"}</td>
              </tr>
            `}).join("");h+=`
          <div class="print-section">
            <h3>Dental Chart</h3>
            <div style="text-align:center;margin-bottom:15px;padding:10px;background:#f9f9f9;border-radius:8px;">
              <div style="margin-bottom:8px;">
                <div style="font-size:10px;color:#666;margin-bottom:4px;">Upper Arch</div>
                <div style="display:flex;justify-content:center;flex-wrap:nowrap;">${N}</div>
              </div>
              <div style="border-top:1px solid #ddd;padding-top:8px;">
                <div style="display:flex;justify-content:center;flex-wrap:nowrap;">${V}</div>
                <div style="font-size:10px;color:#666;margin-top:4px;">Lower Arch</div>
              </div>
            </div>
            <h4 style="margin-top:15px;margin-bottom:8px;">Procedure Details</h4>
            <table class="print-table">
              <thead>
                <tr>
                  <th>Tooth</th>
                  <th>Conditions</th>
                  <th>Procedures</th>
                </tr>
              </thead>
              <tbody>
                ${pe}
              </tbody>
            </table>
          </div>
        `}cs(h)}else cs("")},[p,z,Mt,kt,qt,us,pr,dr]);const ms=()=>{fr&&di(fr,`Patient Details - ${p==null?void 0:p.name}`)},ac=h=>{c(h),as(null),os([]),setTimeout(()=>{Qt(h)},0)},Lt=R||ct||tn||Qe||H||Ze||kn||le||bn||Qn||fl||yl||bl||yt||Et||sn||on||sr||Kn||Lr||$r||Rr||Fr||se,sc=h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),!Lt&&u.trim()&&r&&Qt())};x.useEffect(()=>{const h=window.SpeechRecognition||window.webkitSpeechRecognition;if(!h){Yr("Speech recognition not supported in this browser.");return}const g=new h;return g.continuous=!0,g.interimResults=!0,g.lang="en-US",g.onresult=f=>{let k="";for(let N=f.resultIndex;N<f.results.length;++N)f.results[N].isFinal&&(k+=f.results[N][0].transcript);k&&c(N=>N+(N.endsWith(" ")||N===""?"":" ")+k)},g.onerror=f=>{Yr(`Speech error: ${f.error}`),Dl(!1)},g.onend=()=>{},rr.current=g,()=>{rr.current&&rr.current.stop()}},[]);const oc=async()=>{if(d)if(er){Ta(!0);try{const h=await W(`/api/patients/${d}/discharge`,{method:"POST"});if(!h.ok){const g=await h.json().catch(()=>({}));throw new Error(g.message||`Failed to discharge patient: ${h.status}`)}ln(d)}catch(h){_e(`Discharge Error: ${h.message}`)}finally{Ta(!1)}}else{Pa(!0);try{const h=await W(`/api/patients/${d}/admit`,{method:"POST"});if(!h.ok){const g=await h.json().catch(()=>({}));throw new Error(g.message||`Failed to admit patient: ${h.status}`)}ln(d)}catch(h){_e(`Admit Error: ${h.message}`)}finally{Pa(!1)}}},lc=async h=>{if(d){Ia(!0);try{const f=await W("/api/queue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:d})});if(!f.ok){const k=await f.json().catch(()=>({}));throw new Error(k.message||`Failed to add patient to ${h} queue: ${f.status}`)}d&&(ln(d),si(d))}catch(g){_e(`Add to Queue Error: ${g.message}`)}finally{Ia(!1)}}},cc=async()=>{if(r){Aa(!0),_e(null);try{const h=await W(`/api/queue/${r}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"seen"})});if(!h.ok){const f=await h.json().catch(()=>({}));throw new Error(f.message||"Failed to complete consultation")}d&&(ln(d),si(d));const g=localStorage.getItem("currentUser");if(o.removeQueries({queryKey:pt.queue.all}),g){const f=JSON.parse(g);f.role==="receptionist"?s("/dashboard"):f.role==="doctor"||f.role==="admin"?s("/dashboard/queue"):s("/dashboard")}else s("/dashboard")}catch(h){_e(`Error completing consultation: ${h.message}`)}finally{Aa(!1)}}},uc=async()=>{if(!d){Jt("Missing Patient ID.");return}if(!p){Jt("Patient details not loaded.");return}Qr(!0),Jt(null);try{const h={};let g=!1;if(Br!==p.name&&(h.name=Br,g=!0),qr!==p.age&&(h.age=qr,g=!0),Hr!==p.gender&&(h.gender=Hr,g=!0),Wr!==p.phone&&(h.phone=Wr,g=!0),!g){Jt("No changes detected."),Qr(!1),tr(!1);return}const f=await W(`/api/patients/${d}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)});if(!f.ok){const N=await f.json().catch(()=>({}));throw new Error(N.message||`Failed to update patient details: ${f.statusText}`)}const k=await f.json();S(k),K(k.age),X(k.gender),Mr(k.name),Ur(k.age),Vr(k.gender),Jr(k.phone),tr(!1)}catch(h){Jt(`Save Error: ${h.message}`)}finally{Qr(!1)}},dc=async(h,g,f)=>{h.stopPropagation();const k=[null,"red","green","blue"],N=k.indexOf(f||null),V=k[(N+1)%k.length];S(pe=>pe?{...pe,color_code:V}:null);try{await W(`/api/patients/${g}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({color_code:V})})}catch(pe){console.error("Error updating color code:",pe),S(oe=>oe?{...oe,color_code:f||null}:null)}},pc=x.useCallback(()=>{if(!p)return null;const h={token_number:p.patient_token_number||"N/A",name:p.name||"N/A",age:p.age||"N/A",gender:p.gender||"N/A",phone:p.phone||"N/A"};return Mt.length>0?h.complaints_history=Mt.map(g=>`${g.data.complaint} (${new Date(g.originalDateString).toLocaleDateString()})`).join("; "):h.complaints_history="No past complaints.",kt.length>0?h.pharmacy_orders_history=kt.map(g=>`Order: ${g.data.medications.map(k=>{let N=`${k.name}`;return k.pack_quantity!==void 0&&k.pack_quantity>0&&(N+=` Packs: ${k.pack_quantity}`),k.loose_quantity!==void 0&&k.loose_quantity>0&&(N+=` Loose: ${k.loose_quantity}`),N}).join(", ")} (${g.data.status}, ${new Date(g.originalDateString).toLocaleDateString()})`).join("; "):h.pharmacy_orders_history="No pharmacy orders.",qt.length>0?h.lab_orders_history=qt.map(g=>{let k=`Lab Order: ${g.data.tests.map(N=>N.name).join(", ")} (${g.data.status}, ${new Date(g.originalDateString).toLocaleDateString()})`;return g.data.report&&(k+=` - Report: ${g.data.report.report_content} (${new Date(g.data.report.report_date).toLocaleDateString()})`),k}).join("; "):h.lab_orders_history="No lab history.",wt.length>0?h.recurring_medications=wt.map((g,f)=>{let k=`${f+1}. ${g.medicationName} (${g.frequencyDays} days, ${g.status})`;return g.tabletsPerDay&&(k+=` - ${g.tabletsPerDay} tabs/day`),g.numberOfDays&&(k+=` for ${g.numberOfDays} days`),k}).join("; "):h.recurring_medications="No recurring medications.",h},[p,Mt,kt,qt,wt]),hc=()=>{if(!p){Yr("Patient details are required to use the Live API.");return}ei(!0)},mc=()=>{var h;(h=ir.current)==null||h.click()},fc=async h=>{var f;const g=(f=h.target.files)==null?void 0:f[0];if(g&&d){za(g),Ma(!0);try{const k=new FormData;k.append("files",g),(await W(`/api/patient-files/${d}`,{method:"POST",body:k})).ok||_e("Image upload failed. Please try again.")}catch(k){console.error("Image upload error:",k),_e("Image upload failed. Please try again.")}finally{Ma(!1)}}},pi=x.useRef(!1),On=x.useRef(null),dn=x.useRef(null),ut=x.useRef({response:!0,pharmacy:!1,recurring:!1,labs:!1,history:!1,summary:!1}),[Ln,pn]=x.useState("response"),$n=h=>{pi.current=!0,pn(h),On.current&&clearTimeout(On.current),On.current=setTimeout(()=>{pi.current=!1},1e3);const g={behavior:"smooth",block:"start"};h==="response"&&B.current?B.current.scrollIntoView(g):h==="meds"?re.current?re.current.scrollIntoView(g):dn.current&&dn.current.scrollIntoView(g):h==="labs"&&v.current?v.current.scrollIntoView(g):h==="history"&&L.current?L.current.scrollIntoView(g):h==="summary"&&C.current&&C.current.scrollIntoView(g)};return x.useEffect(()=>{const h=new IntersectionObserver(g=>{pi.current||(g.forEach(f=>{f.target===B.current?ut.current.response=f.isIntersecting:f.target===re.current?ut.current.pharmacy=f.isIntersecting:f.target===dn.current?ut.current.recurring=f.isIntersecting:f.target===v.current?ut.current.labs=f.isIntersecting:f.target===L.current?ut.current.history=f.isIntersecting:f.target===C.current&&(ut.current.summary=f.isIntersecting)}),ut.current.response?pn("response"):ut.current.pharmacy||ut.current.recurring?pn("meds"):ut.current.labs?pn("labs"):ut.current.history?pn("history"):ut.current.summary&&pn("summary"))},{root:null,threshold:0,rootMargin:"-10% 0px -50% 0px"});return B.current&&h.observe(B.current),re.current&&h.observe(re.current),v.current&&h.observe(v.current),L.current&&h.observe(L.current),C.current&&h.observe(C.current),dn.current&&h.observe(dn.current),()=>{h.disconnect(),On.current&&clearTimeout(On.current)}},[]),i.jsxs("div",{className:"edit-complaint-page",style:{height:`${j}px`},children:[i.jsx(Yh,{ref:In,recordId:r,patientId:d,patientDetails:p,caseSummary:z,caseSummaryUpdatedAt:E,clinicSettings:Oe,userMessages:m,selectedImageFile:Zr,pendingLabOrders:Ar,labReports:mt,pastComplaints:F,pharmacyOrders:Je,pharmacyInventory:ce,labInventory:Ae,recurringMedications:wt,currentComplaint:u,setCurrentComplaint:c,setAiResponse:qe,setAiResponseText:ke,setAiResponseJsonString:De,setShowAiJsonDetails:lt,setIsLoadingAi:en,setAiError:()=>{},setIsSubmittingAiOrder:wn,setAiOrderSubmissionStatus:()=>{},setIsSubmittingAiLabOrder:Gn,setAiLabOrderSubmissionStatus:()=>{},setIsSubmittingAiComplaint:gl,setAiComplaintSubmissionStatus:()=>{},setIsUpdatingCaseSummary:xl,setAiCaseSummaryUpdateStatus:()=>{},setCaseSummary:Y,setCaseSummaryUpdatedAt:ge,setIsUpdatingAiMemoryByAI:wl,setAiMemoryUpdateByAIStatus:()=>{},setFollowUpQuestion:as,setFollowUpOptions:os,setError:_e,setIsSavingAiResponse:nn,setSaveAiResponseError:()=>{},fetchPharmacyOrdersData:cn,fetchPendingLabOrdersData:un,fetchLabReportsData:An,fetchPastComplaintsData:Ka,fetchPatientDetails:ln,fetchRecurringMedicationsData:En,setClinicSettings:ti,setEditedAiMemory:ni,handleDeleteItem:Bt,setCanUndo:Ga,onAiActionSuccess:G,addMessage:Xr,onPrintLabBill:h=>{vl(h),_a(!0)},onPrintPharmacyBill:zl,onPrintCustomBill:Bl}),i.jsx(Vg,{isOpen:jl,onClose:()=>_a(!1),billData:_l}),i.jsx(Wg,{isOpen:Sl,onClose:()=>va(!1),billData:Cl}),i.jsx(Jg,{isOpen:Tl,onClose:()=>Sa(!1),billData:Il}),d&&p&&i.jsxs(i.Fragment,{children:[i.jsx(vc,{isOpen:Ll,onClose:()=>lr(!1),patientId:d,patientName:p.name,onRecordPayment:()=>{lr(!1),Ha(!0)}}),i.jsx(Sc,{isOpen:$l,onClose:()=>Ha(!1),patientId:d,patientName:p.name,currentDebt:or||0,onPaymentSuccess:()=>{o.invalidateQueries({queryKey:pt.patientDebts.balance(d)}),lr(!0)}})]}),Ol&&p&&i.jsx(Cc,{onClose:()=>ei(!1),patientData:pc(),tokenNumber:p.patient_token_number?String(p.patient_token_number):null,onAiSummaryChange:h=>{h&&(c(h),Qt(h),ei(!1))}}),i.jsxs("div",{className:"edit-complaint-header",children:[i.jsx("div",{className:"header-left",children:i.jsx("button",{onClick:()=>s(-1),disabled:Lt,className:"back-button",title:"Go Back",children:i.jsx(Pc,{size:20})})}),i.jsx("span",{ref:Ye,style:{position:"absolute",visibility:"hidden",height:"auto",width:"auto",whiteSpace:"nowrap"}}),!p&&zt&&i.jsx("div",{className:"patient-header-details",children:i.jsxs("div",{className:"patient-info-display skeleton",children:[i.jsx(Ie,{width:"120px",height:"18px"}),i.jsx(Ie,{width:"60px",height:"16px"}),i.jsx(Ie,{width:"80px",height:"16px"}),i.jsx(Ie,{width:"90px",height:"16px"})]})}),p&&i.jsx("div",{className:"patient-header-details",children:El?i.jsxs("div",{className:"patient-details-edit-form",children:[i.jsx("input",{type:"text",value:Br,onChange:h=>Mr(h.target.value),placeholder:"Name",className:"edit-input",disabled:Et}),i.jsx("input",{type:"number",value:qr??"",onChange:h=>Ur(h.target.value?parseInt(h.target.value):null),placeholder:"Age",className:"edit-input age",disabled:Et}),i.jsxs("select",{value:Hr??"",onChange:h=>Vr(h.target.value||null),className:"edit-input gender",disabled:Et,children:[i.jsx("option",{value:"",children:"Gender"}),i.jsx("option",{value:"M",children:"M"}),i.jsx("option",{value:"F",children:"F"}),i.jsx("option",{value:"O",children:"O"})]}),i.jsx("input",{type:"text",value:Wr??"",onChange:h=>Jr(h.target.value||null),placeholder:"Phone",className:"edit-input phone",disabled:Et}),i.jsxs("div",{className:"edit-form-actions",children:[i.jsx("button",{onClick:()=>{tr(!1),Jt(null)},className:"cancel-btn",disabled:Et,children:"Cancel"}),i.jsx("button",{onClick:uc,className:"save-btn",disabled:Et,children:Et?"...":"Save"})]}),Da&&i.jsx("div",{className:"error-note",children:Da})]}):i.jsxs("div",{className:"patient-info-display",children:[i.jsx("button",{onClick:()=>{tr(!0),Mr(p.name||""),Ur(p.age),Vr(p.gender),Jr(p.phone),Jt(null)},className:"patient-edit-trigger",title:"Edit Patient Details",disabled:Et,children:i.jsx(xt,{size:14})}),i.jsxs("div",{className:"patient-ident-group",children:[i.jsx("span",{className:"patient-name",children:p.name??"N/A"}),i.jsxs("span",{className:"patient-id-badge",children:["#",p.patient_token_number??"N/A"]}),i.jsxs("span",{className:"patient-demographics",children:[p.age??"N/A"," / ",p.gender??"N/A"]}),i.jsx("div",{className:`patient-color-indicator status-color-${p.color_code||"none"}`,onClick:h=>dc(h,p.id,p.color_code),title:"Click to cycle status color"}),p.phone&&i.jsxs("span",{className:"patient-phone-display",children:["(",p.phone,")"]}),or!==null&&or>0&&i.jsxs("div",{className:"patient-debt-indicator",onClick:()=>lr(!0),title:"Manage Debts",style:{cursor:"pointer"},children:["₹",or.toFixed(2)]})]}),i.jsxs("div",{className:"patient-action-group",children:[i.jsxs("button",{onClick:ii,className:"action-icon-btn indigo",title:"Dental Overview",children:[i.jsx(Tc,{toothNumber:30,style:{width:"14px",height:"14px"}}),i.jsx("span",{className:"btn-label",children:"Dental"})]}),i.jsxs("button",{onClick:ql,className:"action-icon-btn indigo",title:"Medical Procedures",children:[i.jsx(Ic,{size:14}),i.jsx("span",{className:"btn-label",children:"Medical"})]}),i.jsxs("button",{onClick:()=>{p&&s("/dashboard/files",{state:{patient:{id:p.id,name:p.name,token:p.patient_token_number,age:p.age,gender:p.gender,phone:p.phone}}})},className:"action-icon-btn indigo",title:"Files",children:[i.jsx(hi,{size:14}),i.jsx("span",{className:"btn-label",children:"Files"})]}),i.jsxs("button",{onClick:()=>{p&&s(`/patient/${p.id}/bills`)},className:"action-icon-btn indigo",title:"Billing History",children:[i.jsx(mi,{size:14}),i.jsx("span",{className:"btn-label",children:"Bills"})]}),i.jsxs("button",{onClick:h=>{h.stopPropagation(),ms()},disabled:!fr,className:"action-icon-btn gray",title:"Print Summary",children:[i.jsx(zn,{size:14}),i.jsx("span",{className:"btn-label",children:"Print"})]})]})]})}),!p&&$!==void 0&&D!==void 0&&i.jsx("div",{className:"patient-header-details",children:i.jsxs("div",{className:"patient-info-display",children:[i.jsxs("span",{className:"patient-demographics",children:[$??"N/A"," / ",D??"N/A"]}),i.jsx("button",{onClick:h=>{h.stopPropagation(),ms()},disabled:!fr,className:"action-icon-btn gray",title:"Print Summary",children:i.jsx(zn,{size:14})})]})}),i.jsx("div",{className:"header-right",children:i.jsx("button",{onClick:e,className:"icon-button small text-gray-600 hover:text-gray-900 bg-gray-100 hover:bg-gray-200",title:"Open Command Bar (Ctrl+K)",style:{padding:"0.2rem",borderRadius:"8px"},children:i.jsx(Ac,{size:24})})})]}),i.jsxs("div",{className:"edit-complaint-content-area",ref:J,children:[Fa.length>0&&i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"edit-complaint-chat-column",style:{width:"30%",minWidth:"320px",maxWidth:"40%",flexShrink:0},children:i.jsx(Qg,{messages:Fa})}),i.jsx("div",{className:"draggable-divider",onMouseDown:()=>{}})]}),i.jsxs("div",{ref:B,className:"edit-complaint-main-column",style:{flex:1,minWidth:0},children:[ze&&i.jsxs("div",{className:"general-error-message",children:["Error: ",ze]}),ct&&i.jsxs("div",{className:"ai-response-container",style:{padding:"16px"},children:[i.jsx(Ie,{width:"100%",height:"18px",style:{marginBottom:"10px"}}),i.jsx(Ie,{width:"95%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Ie,{width:"85%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Ie,{width:"90%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Ie,{width:"70%",height:"16px"})]}),!ct&&(Ue||Ge)&&i.jsxs("div",{ref:Be,className:`${Ge?"ai-function-call-block":"ai-response-container"} group`,children:[Ue&&i.jsx(Yt,{remarkPlugins:[jt],children:Ue}),Ge&&i.jsxs("div",{className:"ai-json-details-container",children:[i.jsxs("button",{onClick:()=>lt(!it),className:"ai-json-toggle-button",children:[it?i.jsx(xs,{size:14,className:"mr-1"}):i.jsx(bs,{size:14,className:"mr-1"}),it?"Hide":"Show"," AI Function Call Details"]}),it&&i.jsx("pre",{className:"ai-json-pre",children:i.jsx("code",{children:JSON.stringify(JSON.parse(Ge),null,2)})})]}),i.jsxs("div",{className:"ai-response-actions",children:[i.jsx("button",{onClick:()=>rc(b),disabled:!b,title:"Copy Full AI Response",children:i.jsx(Ec,{size:12})}),i.jsx("button",{onClick:ic,disabled:!b,title:"Print AI Response",children:i.jsx(zn,{size:12})})]})]})]}),i.jsx("div",{className:"draggable-divider",onMouseDown:Xl}),i.jsx("div",{ref:he,className:"edit-complaint-context-column",style:{flexBasis:`calc(${100-Ne}% - 5px)`},children:i.jsxs("div",{className:"ai-context-container",children:[i.jsxs("h3",{className:"ai-context-header",children:[i.jsx("span",{children:"AI Context:"}),(p==null?void 0:p.insurance_type)&&i.jsx("div",{className:"insurance-type-container mt-2",children:i.jsxs("select",{ref:Fe,value:p.insurance_type,onChange:h=>Ml(p.id,h.target.value),className:"insurance-type-select",children:[i.jsx("option",{value:"cash",children:"Cash"}),i.jsx("option",{value:"insurance",children:"Insurance"}),i.jsx("option",{value:"no_cash_insurance",children:"No Cash Insurance"})]})})]}),Q.length>0&&i.jsxs("div",{className:"ai-context-section",children:[i.jsx("div",{className:"flex justify-between items-center mb-2",children:i.jsx("h4",{className:"ai-context-section-title mb-0",children:"Dental Overview"})}),i.jsx("div",{onClick:ii,style:{cursor:"pointer",transform:"scale(0.8)",transformOrigin:"top left",width:"125%",height:"350px",overflow:"hidden",pointerEvents:"auto"},title:"Click to open full Dental Page",children:i.jsx(Dc,{selectedTeeth:[],onToothClick:()=>ii(),toothConditions:dr,toothDetails:pr,numberingSystem:localStorage.getItem("dentalNumberingSystem")||"universal"})})]}),i.jsxs("div",{ref:He,className:"ai-context-section",children:[i.jsx("h4",{className:"ai-context-section-title",children:"Admission Status"}),zt?i.jsxs("div",{className:"space-y-2",children:[i.jsx(Ie,{width:"60%",height:"1.2em"}),i.jsx(Ie,{width:"50%",height:"1.2em"}),i.jsx(Ie,{width:"40%",height:"1.2em"}),i.jsxs("div",{className:"flex space-x-2 mt-2",children:[i.jsx(Ie,{width:"80px",height:"30px"}),i.jsx(Ie,{width:"100px",height:"30px"})]})]}):i.jsxs(i.Fragment,{children:[(p==null?void 0:p.admission_date)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Admitted:"})," ",new Date(p.admission_date).toLocaleDateString()]}),(p==null?void 0:p.discharge_date)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Discharged:"})," ",new Date(p.discharge_date).toLocaleDateString()]}),(p==null?void 0:p.current_status)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Current Status:"})," ",i.jsx("span",{className:"font-semibold",children:p.current_status})]}),i.jsxs("div",{className:"flex space-x-2 mt-2",children:[i.jsx("button",{onClick:oc,className:`admit-discharge-button ${er?"discharge":"admit"}`,title:er?"Discharge Patient":"Admit Patient",disabled:!d||Lr||$r,children:Lr?"Admitting...":$r?"Discharging...":er?"Discharge":"Admit"}),i.jsxs("button",{onClick:()=>s(`/patient/${encodeURIComponent(d??"")}/admission-billing`),className:"queue-status-button",style:{backgroundColor:"#e0f2fe",color:"#0369a1",border:"1px solid #bae6fd",display:"flex",alignItems:"center",gap:"4px"},title:"Go to Admission Billing",disabled:!d,children:[i.jsx(mi,{size:14})," Billing"]}),i.jsx("button",{onClick:Zn?cc:()=>lc("doctor"),className:Zn?"complete-consultation-button":"queue-status-button add-to-queue",title:Zn?"Mark Consultation as Complete":"Add Patient to Doctor Queue",disabled:!d||Rr||Fr,children:Rr?"Adding...":Fr?"Completing...":Zn?"Complete Consultation":"Add to Queue"})]})]})]}),i.jsx("div",{ref:re,children:i.jsx(Si,{title:"Pharmacy Order History",headerAction:Kl,items:kt,isLoading:R||zt,loadingText:"Loading...",noDataText:"No orders.",renderItemContent:Jl})}),i.jsxs("div",{ref:dn,className:"ai-context-section mt-4",children:[i.jsxs("div",{className:"flex justify-between items-center mb-2",children:[i.jsx("h4",{className:"ai-context-section-title mb-0",children:"Recurring Medications"}),i.jsxs("button",{onClick:()=>{jn([]),Yn(!0)},className:"text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded flex items-center gap-1",children:[i.jsx(Nr,{size:12})," Add"]})]}),wt.length>0?i.jsx("div",{className:"overflow-x-auto",children:i.jsxs("table",{className:"w-full text-xs text-left",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b",children:[i.jsx("th",{className:"py-1 px-2",children:"#"}),i.jsx("th",{className:"py-1 px-2",children:"Medication"}),i.jsx("th",{className:"py-1 px-2",children:"Qty"}),i.jsx("th",{className:"py-1 px-2",children:"Frequency"}),i.jsx("th",{className:"py-1 px-2",children:"Next Delivery"}),i.jsx("th",{className:"py-1 px-2",children:"Status"}),i.jsx("th",{className:"py-1 px-2"})]})}),i.jsx("tbody",{children:wt.map((h,g)=>i.jsxs("tr",{className:"border-b last:border-0 hover:bg-gray-50",children:[i.jsx("td",{className:"py-1 px-2 font-medium text-gray-500",children:g+1}),i.jsxs("td",{className:"py-1 px-2 font-medium",children:[h.medicationName,i.jsxs("div",{className:"text-[10px] text-gray-500 font-normal",children:[h.tabletsPerDay?`${h.tabletsPerDay} tabs/day`:"",h.tabletsPerDay&&h.numberOfDays?" • ":"",h.numberOfDays?`${h.numberOfDays} days`:"",h.directions?` • ${h.directions}`:""]})]}),i.jsx("td",{className:"py-1 px-2",children:h.quantity}),i.jsxs("td",{className:"py-1 px-2",children:[h.frequencyDays," days"]}),i.jsx("td",{className:"py-1 px-2",children:new Date(h.nextDeliveryDate).toLocaleDateString()}),i.jsx("td",{className:"py-1 px-2",children:i.jsx("span",{className:`px-1.5 py-0.5 rounded-full text-[10px] ${h.status==="active"?"bg-green-100 text-green-800":h.status==="paused"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:h.status})}),i.jsx("td",{className:"py-1 px-2 text-right",children:i.jsx("button",{onClick:()=>{Xn(h),Dr(!0)},className:"text-gray-400 hover:text-blue-600 p-1",title:"Edit",children:i.jsx(xt,{size:12})})})]},h.id))})]})}):R||zt?i.jsx("div",{style:{marginTop:"8px"},children:[1,2,3].map(h=>i.jsxs("div",{style:{display:"flex",gap:"12px",marginBottom:"10px"},children:[i.jsx(Ie,{width:"30px",height:"14px"}),i.jsx(Ie,{width:"120px",height:"14px"}),i.jsx(Ie,{width:"40px",height:"14px"}),i.jsx(Ie,{width:"60px",height:"14px"}),i.jsx(Ie,{width:"80px",height:"14px"})]},h))}):i.jsx("p",{className:"text-gray-500 text-sm italic",children:"No recurring medications."})]}),ya&&i.jsx(qg,{isOpen:ya,onClose:()=>xa(!1),patientId:d,pharmacyInventory:ce,fetchPharmacyOrdersData:cn,isLoadingInventory:Ze}),i.jsxs("div",{ref:v,children:[i.jsx(Si,{title:"Lab History (Orders & Reports)",headerAction:Yl,items:qt,onDeleteItem:void 0,onEditLabOrder:void 0,onSaveLabOrder:Wl,onCancelEditLabOrder:Ul,onLabOrderTestChange:Hl,onLabOrderStatusChange:Vl,onBillLabOrder:void 0,onUpdateLabOrderStatus:void 0,onEnterLabReport:void 0,labInventory:Ae,isSavingLabOrder:yt,isLoading:kn||Qe||zt,loadingText:"Loading...",noDataText:"No lab Hx.",expandedLabReports:Nn,toggleLabReport:ui,renderItemContent:Ql}),i.jsx(Kh,{isOpen:Nl,onClose:()=>ga(!1),patientId:d,labInventory:Ae,fetchPendingLabOrdersData:un,isLoadingInventory:Ze}),i.jsx("div",{ref:L,children:i.jsx(Si,{title:"Complaints History",items:Mt,isLoading:H||zt,loadingText:"Loading...",noDataText:"No past Hx.",renderItemContent:Gl,onDeleteItem:Bt})}),i.jsxs("div",{className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsxs("h4",{className:"ai-context-section-title",children:[i.jsx(Oc,{size:16,className:"text-purple-600"})," Clinic-wide System Prompt"]}),!ri&&i.jsx("button",{onClick:hs,className:"edit-button",title:"Edit System Prompt",disabled:Va||sn||on,children:i.jsx(xt,{size:14})})]}),ri&&Oe?i.jsxs("div",{className:"mt-2",children:[i.jsx("textarea",{value:Pn,onChange:h=>Tn(h.target.value),className:"context-edit-textarea",placeholder:"Enter clinic system prompt...",disabled:sn||on}),i.jsxs("div",{className:"context-edit-actions",children:[i.jsx("button",{onClick:nc,disabled:sn||on,className:"button-secondary",children:"Cancel"}),i.jsxs("button",{onClick:tc,disabled:sn||on||cr===Oe.aiMemory&&Pn===Oe.clinicWideSystemPrompt,className:"button-primary purple",children:[i.jsx(oo,{size:14,className:"mr-1"}),on||sn?"Saving...":"Save Settings"]})]})]}):i.jsx("div",{className:"ai-context-text whitespace-pre-wrap mt-1 prose prose-sm max-w-none cursor-pointer hover:bg-gray-50 rounded p-1 -m-1 transition-colors",onClick:hs,title:"Click to edit system prompt",children:Va?i.jsxs("div",{style:{marginTop:"4px"},children:[i.jsx(Ie,{width:"100%",height:"14px",style:{marginBottom:"6px"}}),i.jsx(Ie,{width:"90%",height:"14px",style:{marginBottom:"6px"}}),i.jsx(Ie,{width:"70%",height:"14px"})]}):Oe!=null&&Oe.clinicWideSystemPrompt?i.jsx(Yt,{remarkPlugins:[jt],children:Oe.clinicWideSystemPrompt}):i.jsx("span",{className:"italic text-gray-400",children:"N/A - Click to add."})}),!ri&&(Oe==null?void 0:Oe.clinicWideSystemPromptUpdatedAt)&&i.jsxs("p",{className:"ai-context-text text-gray-400 mt-1",style:{fontSize:"0.625rem"},children:["Prompt Last Updated: ",new Date(Oe.clinicWideSystemPromptUpdatedAt).toLocaleDateString()]})]}),i.jsxs("div",{ref:C,className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsx("h4",{className:"ai-context-section-title",children:"Case Summary"}),!M&&i.jsx("button",{onClick:ps,className:"edit-button",title:"Edit Case Summary",disabled:R||se,children:i.jsx(xt,{size:14})})]}),M?i.jsxs("div",{className:"mt-2",children:[i.jsx("textarea",{value:ee,onChange:h=>je(h.target.value),className:"context-edit-textarea",rows:4,placeholder:"Enter case summary...",disabled:se}),U&&i.jsx("p",{className:"text-red-500 text-xs mt-1",children:U}),i.jsxs("div",{className:"context-edit-actions",children:[i.jsx("button",{onClick:Zl,disabled:se,className:"button-secondary",children:"Cancel"}),i.jsx("button",{onClick:ec,disabled:se||ee===z,className:"button-primary blue",children:se?"Saving...":"Save"})]})]}):i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"ai-context-text whitespace-pre-wrap mt-1 prose prose-sm max-w-none cursor-pointer hover:bg-gray-50 rounded p-1 -m-1 transition-colors",onClick:ps,title:"Click to edit case summary",children:R?i.jsxs("div",{style:{marginTop:"8px"},children:[i.jsx(Ie,{width:"100%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Ie,{width:"85%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Ie,{width:"65%",height:"16px"})]}):z?i.jsx(Yt,{remarkPlugins:[jt],components:{},children:z}):i.jsx("span",{className:"italic text-gray-400",children:"N/A - Click to add."})}),E&&i.jsxs("p",{className:"ai-context-text text-gray-400 mt-1",style:{fontSize:"0.625rem"},children:["Last Edited: ",new Date(E).toLocaleDateString()]})]})]}),Mt.length===0&&qt.length===0&&kt.length===0&&!(H||kn||Qe)&&i.jsx("p",{className:"ai-context-text italic mt-4",children:"No recent history for this patient."}),Kn&&i.jsx("p",{className:"text-yellow-600 text-xs mt-2 ai-context-text",children:"Deleting..."}),ma&&i.jsx("p",{className:"text-red-600 text-xs mt-2 ai-context-text",children:ma})]})]})})]}),i.jsxs("div",{className:"edit-complaint-input-area",children:[i.jsxs("div",{className:"status-messages-container",children:[Rt&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:Rt}),ye&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:ye}),pa&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:pa}),It&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:It})]}),r&&!le&&i.jsxs(x.Fragment,{children:[is&&i.jsxs("div",{className:`follow-up-question-container ${mr?"collapsed":""}`,children:[i.jsxs("div",{className:"follow-up-header",onClick:()=>ls(h=>!h),children:[i.jsx("p",{className:"question-text",children:is}),i.jsx("button",{className:"follow-up-toggle-btn",onClick:h=>{h.stopPropagation(),ls(g=>!g)},title:mr?"Expand options":"Collapse options",type:"button",children:i.jsx("span",{className:"follow-up-toggle-icon",children:mr?"▸":"▾"})})]}),!mr&&ss.length>0&&i.jsx("div",{className:"options-grid",children:ss.map((h,g)=>i.jsx("button",{onClick:()=>ac(h),className:"option-button",children:h},g))})]}),Ra&&i.jsx("div",{className:"speech-error-display",children:Ra}),Ba&&i.jsx("div",{className:"selected-file-display",children:i.jsx("span",{children:"Uploading image..."})}),Zr&&!Ba&&i.jsxs("div",{className:"selected-file-display",children:[i.jsxs("span",{children:["Selected: ",Zr.name]}),i.jsx("button",{onClick:()=>{za(null),ir.current&&(ir.current.value="")},className:"remove-file-button",title:"Remove image",children:"×"})]}),i.jsxs("div",{className:"input-section-selector",children:[i.jsx("button",{onClick:()=>$n("response"),className:`selector-button ${Ln==="response"?"active":""}`,children:"AI"}),i.jsx("button",{onClick:()=>$n("meds"),className:`selector-button ${Ln==="meds"?"active":""}`,children:"Meds"}),i.jsx("button",{onClick:()=>$n("labs"),className:`selector-button ${Ln==="labs"?"active":""}`,children:"Labs"}),i.jsx("button",{onClick:()=>$n("history"),className:`selector-button ${Ln==="history"?"active":""}`,children:"Hx"}),i.jsx("button",{onClick:()=>$n("summary"),className:`selector-button ${Ln==="summary"?"active":""}`,children:"Sum"})]}),i.jsx("div",{className:"input-wrapper",children:i.jsxs("div",{className:"main-input-container",children:[i.jsx("input",{type:"file",ref:ir,onChange:fc,accept:"image/*",className:"hidden"}),i.jsx("textarea",{ref:Ke,className:"complaint-textarea",value:u,onChange:h=>c(h.target.value),onKeyDown:sc,placeholder:"Name, Age, Sex... Chat with Patient Manager AI",disabled:Lt||!r||Cn}),i.jsxs("div",{className:"chat-input-actions-container",children:[i.jsx("button",{type:"button",onClick:mc,disabled:Lt||!r||Cn,className:"icon-button",title:"Attach Image",children:i.jsx(Lc,{size:14})}),i.jsx("button",{type:"button",onClick:hc,disabled:Lt||!r||!rr.current,className:`mic-button ${Cn?"listening":""}`,title:Cn?"Stop":"Mic",children:i.jsx($c,{size:14})}),i.jsx("button",{onClick:()=>Qt(),disabled:Lt||!u.trim()||!r||Cn,className:"send-button",title:Lt?"Processing...":"Save & Ask AI",children:Lt?i.jsx("div",{className:"custom-loader-circle",role:"status","aria-label":"loading"}):i.jsx(Rc,{size:14})}),Rl&&i.jsx("button",{type:"button",onClick:Fl,disabled:Lt,className:"icon-button text-red-500",title:"Undo Last AI Actions",children:i.jsx(bt,{size:14})})]})]})})]})]}),ka&&d&&i.jsx(Ug,{isOpen:ka,onClose:()=>Yn(!1),onSuccess:()=>{d&&En(d),Yn(!1),jn([])},patientId:d,initialItems:ja}),Na&&Or&&i.jsx(Hg,{isOpen:Na,onClose:()=>Dr(!1),onSuccess:()=>{d&&En(d),Dr(!1),Xn(void 0)},medication:Or}),ba&&i.jsx(Fc,{isOpen:ba,onClose:()=>{wa(!1),Xn(void 0),jn([])},onSuccess:()=>{d&&En(d),wa(!1),Xn(void 0),jn([])},initialItems:ja,medication:Or,initialPatient:p?{id:p.id,name:p.name,phone:p.phone||"",patient_token_number:String(p.patient_token_number||"")}:void 0})]})};export{Xg as default};
