import{f as P,j as e,W as Y}from"./index-B0SGsixC.js";import{r as n,j as G,u as H}from"./react-vendor-Cc0P4_ZX.js";import{aO as M,X as L,aM as $,ab as B,e as J,W as Q,f as V}from"./ui-vendor-CZgqa0n4.js";/* empty css                         */import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const Z=({isOpen:j,onClose:y,onConfirm:S})=>{const[u,w]=n.useState({}),[c,v]=n.useState(""),[l,p]=n.useState(""),[m,C]=n.useState([]),[r,T]=n.useState([]),[W,f]=n.useState(!1);n.useEffect(()=>{j&&t()},[j]);const t=async()=>{f(!0);try{const s=await P("/api/dashboards/table-relations");if(s.ok){const i=await s.json();w(i);const k=Object.keys(i);k.length>0&&v(k[0])}}catch(s){console.error("Error fetching table relations:",s)}finally{f(!1)}},h=s=>{v(s),p(""),C([]),T([])},d=s=>{p(s),T([])},b=(s,i,k)=>{s.includes(k)?i(s.filter(R=>R!==k)):i([...s,k])},D=()=>{var s,i;if(!c||!l){alert("Please select both primary and related tables");return}if(m.length===0&&r.length===0){alert("Please select at least one column");return}S({primary:c,related:l,primaryColumns:m,relatedColumns:r,primaryLabel:((s=u[c])==null?void 0:s.label)||c,relatedLabel:((i=u[l])==null?void 0:i.label)||l}),y()};if(!j)return null;const x=u[c],N=(x==null?void 0:x.relations)||{},g=u[l];return e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal-content",style:{maxWidth:"600px"},children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h3",{children:[e.jsx(M,{size:18})," Join Tables Builder"]}),e.jsx("button",{onClick:y,className:"close-button",children:e.jsx(L,{size:20})})]}),W?e.jsx("div",{children:"Loading tables..."}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"20px",padding:"20px"},children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:[e.jsx("strong",{children:"Step 1:"})," Select Primary Table"]}),e.jsx("select",{value:c,onChange:s=>h(s.target.value),style:{width:"100%",padding:"8px"},children:Object.entries(u).filter(([s,i])=>Object.keys(i.relations).length>0).map(([s,i])=>e.jsx("option",{value:s,children:i.label},s))})]}),c&&Object.keys(N).length>0&&e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:[e.jsx("strong",{children:"Step 2:"})," Select Related Table"]}),e.jsxs("select",{value:l,onChange:s=>d(s.target.value),style:{width:"100%",padding:"8px"},children:[e.jsx("option",{value:"",children:"-- Select --"}),Object.entries(N).map(([s,i])=>e.jsxs("option",{value:s,children:[i.label," (via ",i.foreignKey,")"]},s))]})]}),c&&x&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:e.jsxs("strong",{children:["Columns from ",x.label,":"]})}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px",marginTop:"8px"},children:x.columns.map(s=>e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer",background:m.includes(s)?"#e0f0ff":"#f0f0f0",padding:"4px 8px",borderRadius:"4px"},children:[e.jsx("input",{type:"checkbox",checked:m.includes(s),onChange:()=>b(m,C,s)}),s]},s))})]}),l&&g&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:e.jsxs("strong",{children:["Columns from ",g.label,":"]})}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px",marginTop:"8px"},children:g.columns.map(s=>e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer",background:r.includes(s)?"#e0ffe0":"#f0f0f0",padding:"4px 8px",borderRadius:"4px"},children:[e.jsx("input",{type:"checkbox",checked:r.includes(s),onChange:()=>b(r,T,s)}),s]},s))})]}),m.length>0||r.length>0?e.jsxs("div",{style:{background:"#f8f9fa",padding:"10px",borderRadius:"4px"},children:[e.jsx("strong",{children:"Preview Columns:"}),e.jsxs("div",{style:{marginTop:"5px",fontSize:"0.9em"},children:[m.map(s=>e.jsxs("span",{style:{marginRight:"8px",color:"#0066cc"},children:[x==null?void 0:x.label,".",s]},s)),r.map(s=>e.jsxs("span",{style:{marginRight:"8px",color:"#009900"},children:[g==null?void 0:g.label,".",s]},s))]})]}):null]}),e.jsxs("div",{className:"modal-actions",style:{padding:"15px",borderTop:"1px solid #eee"},children:[e.jsx("button",{onClick:y,children:"Cancel"}),e.jsx("button",{className:"primary-button",onClick:D,disabled:!l,children:"Create Joined Widget"})]})]})})},I=({isOpen:j,onClose:y,onCreated:S})=>{const[u,w]=n.useState(""),[c,v]=n.useState(""),[l,p]=n.useState([{key:"name",label:"Name",type:"text"}]),[m,C]=n.useState(!1),r=()=>{p([...l,{key:"",label:"",type:"text"}])},T=t=>{p(l.filter((h,d)=>d!==t))},W=(t,h,d)=>{const b=[...l];b[t]={...b[t],[h]:d},h==="label"&&!b[t].key&&(b[t].key=d.toLowerCase().replace(/\s+/g,"_")),p(b)},f=async()=>{if(!u.trim()){alert("Table name is required");return}if(l.length===0||l.some(t=>!t.key||!t.label)){alert("All columns must have a key and label");return}C(!0);try{(await P("/api/custom-tables",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:u,description:c,columns:l})})).ok?(S(),y(),w(""),v(""),p([{key:"name",label:"Name",type:"text"}])):alert("Failed to create table")}catch(t){console.error("Error creating table:",t),alert("Error creating table")}finally{C(!1)}};return j?e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal-content create-table-modal-content",children:[e.jsxs("div",{className:"create-table-header",children:[e.jsxs("h3",{children:[e.jsx($,{size:20})," Create Custom Table"]}),e.jsx("button",{onClick:y,className:"close-btn",children:e.jsx(L,{size:20})})]}),e.jsxs("div",{className:"form-content",children:[e.jsxs("div",{className:"form-field-group",children:[e.jsx("label",{children:"Table Name *"}),e.jsx("input",{type:"text",value:u,onChange:t=>w(t.target.value),placeholder:"e.g., Patient Notes, Appointments",className:"modal-input"})]}),e.jsxs("div",{className:"form-field-group",children:[e.jsx("label",{children:"Description"}),e.jsx("input",{type:"text",value:c,onChange:t=>v(t.target.value),placeholder:"Optional description",className:"modal-input"})]}),e.jsxs("div",{className:"form-field-group",children:[e.jsx("label",{children:"Columns"}),e.jsx("div",{className:"columns-container",children:l.map((t,h)=>e.jsxs("div",{className:"column-row",children:[e.jsx("input",{type:"text",value:t.label,onChange:d=>W(h,"label",d.target.value),placeholder:"Column label",className:"modal-input column-label-input"}),e.jsx("input",{type:"text",value:t.key,onChange:d=>W(h,"key",d.target.value),placeholder:"key",className:"modal-input column-key-input"}),e.jsxs("select",{value:t.type,onChange:d=>W(h,"type",d.target.value),className:"column-type-select",children:[e.jsx("option",{value:"text",children:"Text"}),e.jsx("option",{value:"number",children:"Number"}),e.jsx("option",{value:"date",children:"Date"}),e.jsx("option",{value:"boolean",children:"Yes/No"})]}),e.jsx("button",{onClick:()=>T(h),className:"remove-col-btn",disabled:l.length<=1,children:e.jsx(B,{size:16})})]},h))}),e.jsxs("button",{onClick:r,className:"add-col-btn",children:[e.jsx(J,{size:14})," Add Column"]})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{onClick:y,className:"cancel-button",children:"Cancel"}),e.jsx("button",{onClick:f,disabled:m,className:"create-button",children:m?"Creating...":"Create Table"})]})]})}):null},re=()=>{const{id:j}=G(),y=H(),S=!!j,[u,w]=n.useState(""),[c,v]=n.useState(""),[l,p]=n.useState([]),[m,C]=n.useState(!1),[r,T]=n.useState([]),[W,f]=n.useState(!1),[t,h]=n.useState("stat"),[d,b]=n.useState(""),[D,x]=n.useState("api:patients"),[N,g]=n.useState([]),[s,i]=n.useState(!1),[k,R]=n.useState(!1);n.useEffect(()=>{O(),S&&F()},[j]);const O=async()=>{try{const a=await P("/api/dashboards/data-sources");if(a.ok){const o=await a.json();T(o),o.length>0&&x(o[0].key)}}catch(a){console.error("Error fetching data sources:",a)}},F=async()=>{try{const a=await P(`/api/dashboards/${j}`);if(a.ok){const o=await a.json();w(o.name),v(o.description),p(o.widgets||[])}}catch(a){console.error("Error fetching dashboard:",a)}},_=async()=>{if(!u.trim())return alert("Name is required");C(!0);try{const a={name:u,description:c,widgets:l},o=S?`/api/dashboards/${j}`:"/api/dashboards";(await P(o,{method:S?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok?y("/dashboards"):alert("Failed to save dashboard")}catch(a){console.error("Error saving dashboard:",a)}finally{C(!1)}},q=()=>{var A;const a=r.find(E=>E.key===D),o={id:Date.now().toString(),type:t,title:d||(a==null?void 0:a.label)||"New Widget",dataSource:D,config:{columns:N.length>0?N:((A=a==null?void 0:a.columns)==null?void 0:A.slice(0,3))||[]}};p([...l,o]),f(!1),b(""),g([])},K=a=>{p(l.filter(o=>o.id!==a))},U=a=>{x(a),g([])},z=r.find(a=>a.key===D),X=a=>{const o={id:Date.now().toString(),type:"table",title:`${a.primaryLabel} + ${a.relatedLabel}`,dataSource:`dynamic:${a.primary}:${a.related}`,config:{primaryColumns:a.primaryColumns,relatedColumns:a.relatedColumns}};p([...l,o])};return e.jsxs("div",{className:"dashboard-builder-container",children:[e.jsxs("div",{className:"builder-header",children:[e.jsxs("button",{className:"back-btn",onClick:()=>y("/dashboards"),children:[e.jsx(Q,{size:16})," Back"]}),e.jsxs("div",{className:"title-inputs",children:[e.jsx("input",{type:"text",placeholder:"Dashboard Name",value:u,onChange:a=>w(a.target.value),className:"dashboard-name-input"}),e.jsx("input",{type:"text",placeholder:"Description (Optional)",value:c,onChange:a=>v(a.target.value),className:"dashboard-desc-input"})]}),e.jsxs("button",{className:"primary-button",onClick:_,disabled:m,children:[e.jsx(V,{size:16})," ",m?"Saving...":"Save Dashboard"]})]}),e.jsx("div",{className:"widgets-area",children:l.length===0?e.jsxs("div",{className:"empty-canvas",children:[e.jsx("p",{children:"Canvas is empty. Add a widget to start."}),e.jsxs("div",{style:{display:"flex",gap:"10px",flexWrap:"wrap",justifyContent:"center"},children:[e.jsxs("button",{onClick:()=>f(!0),className:"add-widget-btn",children:[e.jsx(J,{size:16})," Add Widget"]}),e.jsxs("button",{onClick:()=>i(!0),className:"add-widget-btn",style:{background:"#2196F3"},children:[e.jsx(M,{size:16})," Create Joined Widget"]}),e.jsxs("button",{onClick:()=>R(!0),className:"add-widget-btn",style:{background:"#4CAF50"},children:[e.jsx($,{size:16})," Create Custom Table"]})]})]}):e.jsxs("div",{className:"widgets-grid",children:[l.map(a=>e.jsxs("div",{className:"widget-wrapper",children:[e.jsx("div",{className:"widget-actions-overlay",children:e.jsx("button",{onClick:()=>K(a.id),className:"remove-widget-btn",children:e.jsx(B,{size:14})})}),e.jsx(Y,{widget:a})]},a.id)),e.jsxs("div",{className:"add-more-card",onClick:()=>f(!0),children:[e.jsx(J,{size:24}),e.jsx("span",{children:"Add Widget"})]})]})}),W&&e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal-content",children:[e.jsx("h3",{children:"Add Widget"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Title (Optional)"}),e.jsx("input",{type:"text",placeholder:"Leave blank for auto-title",value:d,onChange:a=>b(a.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Type"}),e.jsxs("select",{value:t,onChange:a=>h(a.target.value),children:[e.jsx("option",{value:"stat",children:"Statistic (Count)"}),e.jsx("option",{value:"table",children:"Table (List)"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Data Source"}),e.jsxs("select",{value:D,onChange:a=>U(a.target.value),children:[e.jsx("optgroup",{label:"Single Tables",children:r.filter(a=>!a.isCustom&&!a.isJoin).map(a=>e.jsx("option",{value:a.key,children:a.label},a.key))}),r.some(a=>a.isJoin)&&e.jsx("optgroup",{label:"Joined Tables (Multi-Table)",children:r.filter(a=>a.isJoin).map(a=>e.jsx("option",{value:a.key,children:a.label},a.key))}),r.some(a=>a.isCustom)&&e.jsx("optgroup",{label:"Custom Tables",children:r.filter(a=>a.isCustom).map(a=>e.jsx("option",{value:a.key,children:a.label},a.key))})]}),z&&e.jsx("small",{style:{color:"#666"},children:z.description})]}),t==="table"&&(z==null?void 0:z.columns)&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Columns to Display (select multiple)"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px"},children:z.columns.map(a=>e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:N.includes(a),onChange:o=>{o.target.checked?g([...N,a]):g(N.filter(A=>A!==a))}}),a]},a))})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{onClick:()=>f(!1),children:"Cancel"}),e.jsx("button",{className:"primary-button",onClick:q,children:"Add"})]})]})}),e.jsx(Z,{isOpen:s,onClose:()=>i(!1),onConfirm:X}),e.jsx(I,{isOpen:k,onClose:()=>R(!1),onCreated:()=>O()})]})};export{re as default};
