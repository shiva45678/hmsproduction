import{f as y,j as e,S as J}from"./index-B0SGsixC.js";import{r as a,u as Ye,f as Ze}from"./react-vendor-Cc0P4_ZX.js";import{Q as $e}from"./index-CZ6CIOFr.js";import{_ as Ee,u as Re,af as Ae,s as et,ak as tt,X as st,al as nt,f as at,am as ze,W as it,a9 as lt,F as rt,an as ot}from"./ui-vendor-CZgqa0n4.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const ct=i=>{if(i===0)return"Zero";const S=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],C=["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"],w=F=>F===0?"":F<20?S[F]:F<100?C[Math.floor(F/10)]+(F%10?" "+S[F%10]:""):S[Math.floor(F/100)]+" Hundred"+(F%100?" and "+w(F%100):""),f=Math.floor(i),D=Math.round((i-f)*100);let m="";return f>=1e7&&(m+=w(Math.floor(f/1e7))+" Crore "),f>=1e5&&(m+=w(Math.floor(f%1e7/1e5))+" Lakh "),f>=1e3&&(m+=w(Math.floor(f%1e5/1e3))+" Thousand "),f>=100&&(m+=w(Math.floor(f%1e3/100))+" Hundred "),f%100&&(m+=(m?"and ":"")+w(f%100)),m=m.trim()+" Rupees",D>0&&(m+=" and "+w(D)+" Paise"),m+" Only"},dt=i=>{const S=typeof i=="string"?parseInt(i,10):i;return`INV-${String(S).padStart(6,"0")}`},we=500,Be="defaultConsultationFee",ut=({patientId:i,billId:S,queueId:C,onBillCreated:w,onBillUpdated:f,initialItems:D=[],billType:m="other",relatedId:F,initialStatus:M="pending",initialDiscountPercentage:O=0,readOnlyMode:I=!1,doctorId:T,labOrderId:P,patientInsuranceType:L})=>{const[u,R]=a.useState(null),[b,z]=a.useState([]),G=a.useRef([]),[Z,Q]=a.useState(""),[se,H]=a.useState(""),[ee,K]=a.useState(1),[k,U]=a.useState(O),[B,W]=a.useState("cash"),[oe,V]=a.useState(!1),[X,o]=a.useState(null),[ne,v]=a.useState(!1),[ae,ce]=a.useState(!1),[fe,de]=a.useState(!1),[g,N]=a.useState(null),[,$]=a.useState([]),[c,q]=a.useState(null),[A,ie]=a.useState(""),[Y,te]=a.useState("cash"),[j,h]=a.useState(!1),[l,_]=a.useState(null),[ue,ve]=a.useState(!1),[Se,Fe]=a.useState(we),[Pe,_e]=a.useState(we.toString()),[ge,Oe]=a.useState(""),[le,Le]=a.useState(""),[je,qe]=a.useState(""),[ye,Me]=a.useState(""),[he,Ce]=a.useState(""),p=S?"view_pay":"create";a.useEffect(()=>{const t=localStorage.getItem(Be),n=t?parseFloat(t):we;isNaN(n)||(Fe(n),_e(n.toString()))},[]);const De=D.length===0;a.useEffect(()=>{i?(async()=>{V(!0),o(null);try{const n=await y(`/api/patients/${i}`);if(!n.ok){const r=await n.json().catch(()=>({}));throw new Error(r.message||"Failed to fetch patient details")}const s=await n.json();R(s)}catch(n){o(`Failed to load patient details: ${n.message}`),R(null)}finally{V(!1)}})():R(null)},[i]),a.useEffect(()=>{S?(async()=>{de(!0),o(null),N(null),$([]),q(null);try{const n=await y(`/api/bills/${S}`);if(!n.ok){const r=await n.json().catch(()=>({}));throw new Error(r.message||"Failed to fetch bill details")}const s=await n.json();if(!s.bill||!s.payments||!s.calculated)throw new Error("Invalid bill details structure.");N(s.bill),$(s.payments),q(s.calculated),U(s.bill.discount_percentage!==void 0&&s.bill.discount_percentage!==null?parseFloat(s.bill.discount_percentage.toString()):0),s.bill.payment_mode&&W(s.bill.payment_mode),!u&&s.bill.patient_id&&Ue(s.bill.patient_id.toString())}catch(n){o(`Failed to load bill details: ${n.message}`),N(null),$([]),q(null)}finally{de(!1)}})():(N(null),$([]),q(null))},[S]),a.useEffect(()=>{(async()=>{try{const n=await y("/api/clinics/settings");if(!n.ok)throw new Error("Failed to fetch clinic settings");const s=await n.json();Oe(s.upi_id||""),Le(s.name||""),qe(s.address||""),Me(s.notes||"")}catch(n){console.error("Error fetching clinic settings:",n)}})()},[]);const Ue=async t=>{V(!0);try{const n=await y(`/api/patients/${t}`);if(!n.ok)throw new Error("Failed to fetch patient");const s=await n.json();R(s)}catch(n){console.error("Error fetching patient details:",n),R(null)}finally{V(!1)}},be=a.useCallback(async t=>{ce(!0),o(null);const n=t.filter(s=>s.drug_id!=null).map(async s=>{try{const r=await y(`/api/drugs/${s.drug_id}`);if(!r.ok)throw new Error(`Drug ${s.drug_id} not found.`);const d=await r.json();return{...s,price:d.price,total:d.price*s.quantity}}catch{return o(d=>`${d?d+"; ":""}Failed to fetch price for ${s.name}`),s}});try{const s=await Promise.all(n);z(r=>{const d=new Map(s.map(x=>[x.id,x]));return r.map(x=>d.get(x.id)||x)})}catch{}finally{ce(!1)}},[y]);a.useEffect(()=>{if(S){z([]),G.current=[];return}JSON.stringify(D)===JSON.stringify(G.current)||(async()=>{let s=[];if(D&&D.length>0)s=D.map((r,d)=>({...r,id:`initial-${d}-${Date.now()}`})),W(M==="paid"?"cash":L==="no_cash_insurance"?"no_cash_insurance":"cash"),U(O),m==="pharmacy"&&!I&&await be(s);else if(i&&De&&m==="consultation"){let r=Se;if(T)try{const d=await y(`/api/staff/${T}`);if(!d.ok){const re=await d.json().catch(()=>({}));throw new Error(re.message||"Doctor not found or error fetching fee")}const x=await d.json();x.opd_fee!=null&&!isNaN(parseFloat(String(x.opd_fee)))&&parseFloat(String(x.opd_fee))>=0&&(r=parseFloat(String(x.opd_fee)))}catch(d){o(x=>`${x?x+"; ":""}Could not fetch doctor's fee, using default. (${d.message})`)}s=[{id:Date.now(),name:"Consultation Fee",price:r,quantity:1,total:r*1,drug_id:null}],W(L==="no_cash_insurance"?"no_cash_insurance":"cash")}else s=[],W(L==="no_cash_insurance"?"no_cash_insurance":"cash");z(s),G.current=D})()},[S,i,T,D,m,Se,De,M,I,be,O,L]);const We=()=>{const t=parseFloat(se);if(!I)if(Z&&!isNaN(t)&&t>=0&&ee>0){if(Z.trim().toLowerCase()==="consultation fee"&&b.some(s=>s.name.toLowerCase()==="consultation fee")){alert("Consultation Fee already added.");return}const n={id:Date.now(),name:Z.trim(),price:t,quantity:ee,total:t*ee,drug_id:null};z([...b,n]),Q(""),H(""),K(1)}else alert("Invalid item details.")},Je=t=>{I||z(b.filter(n=>n.id!==t))},E=a.useMemo(()=>{let t=b.reduce((n,s)=>n+s.total,0);return p==="create"&&k>0&&(t=t*(1-k/100)),(c==null?void 0:c.totalDue)!==void 0&&(c==null?void 0:c.totalDue)!==null?c.totalDue:t},[b,c,k,p]),me=a.useMemo(()=>b.reduce((t,n)=>t+n.total,0),[b]),Ie=a.useMemo(()=>me*(k/100),[me,k]),Ne=a.useMemo(()=>(c==null?void 0:c.totalPaid)??0,[c]),ke=a.useMemo(()=>(c==null?void 0:c.balance)!==void 0&&(c==null?void 0:c.balance)!==null?c.balance:E-Ne,[c,E,Ne]);a.useEffect(()=>{if(E>0&&ge){const t=`upi://pay?pa=${ge}&pn=${encodeURIComponent(le)}&am=${E.toFixed(2)}&cu=INR`;Ce(t)}else Ce("")},[E,ge,le]),a.useEffect(()=>{(async()=>{if(B==="credit"&&i){ve(!0);try{const n=await y(`/api/patient-debts/${i}/balance`);if(n.ok){const s=await n.json();_(s.netDebt||0)}else _(0)}catch(n){console.error("Error fetching patient debt:",n),_(0)}finally{ve(!1)}}})()},[B,i]);const Ge=()=>{const t=parseFloat(Pe);!isNaN(t)&&t>=0?(Fe(t),localStorage.setItem(Be,t.toString())):alert("Invalid fee amount.")},Qe=async(t,n)=>{v(!0),o(null);try{const s=await y("/api/payment/create-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:n,billId:t})}),r=await s.json();if(!s.ok||!r.order)throw new Error(r.message||"Failed to create Razorpay order.");const{key_id:d,order:x}=r,re={key:d,amount:x.amount,currency:x.currency,name:"Newtons Ai HMS Clinic",description:`Bill Payment for Patient ID: ${i}`,order_id:x.id,handler:async function(pe){try{const xe=await y("/api/payment/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({razorpay_payment_id:pe.razorpay_payment_id,razorpay_order_id:pe.razorpay_order_id,razorpay_signature:pe.razorpay_signature,billId:t})}),Te=await xe.json();if(xe.ok&&Te.success)w&&w(t),f&&f(),setTimeout(()=>window.print(),200);else throw new Error(Te.message||"Payment verification failed.")}catch(xe){o(`Payment verification failed: ${xe.message}. Contact support.`)}finally{v(!1)}},prefill:{name:(u==null?void 0:u.name)||""},notes:{bill_id:t,patient_id:i},theme:{color:"#3399cc"},modal:{ondismiss:function(){o("Payment cancelled."),v(!1)}}};if(window.Razorpay)new window.Razorpay(re).open();else throw new Error("Razorpay SDK not loaded.")}catch(s){o(`Failed to initiate online payment: ${s.message}`),v(!1)}},He=async()=>{if(!S){o("Bill ID is missing.");return}if(!A||isNaN(parseFloat(A))||parseFloat(A)<=0){o("Please enter a valid positive payment amount.");return}h(!0),o(null);const t={amount_paid:parseFloat(A),payment_mode:Y};try{const n=await y(`/api/bills/${S}/payments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),s=await n.json();if(!n.ok)throw new Error(s.message||`Failed to record payment (Status: ${n.status})`);ie(""),f?f():console.log("Payment recorded.")}catch(n){o(`Failed to record payment: ${n.message}`)}finally{h(!1)}},Ke=async()=>{if(p==="view_pay")return;if(!i){o("Patient ID is missing for creating a bill.");return}if(b.length===0){o("Cannot finalize an empty bill.");return}v(!0),o(null);const t=E,n=b.map(({id:s,...r})=>r);if(B==="online"){const s={patientId:i,queueId:C||null,items:n,amount:t,paymentMode:"online",type:m,related_id:F||P||null,status:"pending",discountPercentage:k,labOrderId:P||null};try{const r=await y("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),d=await r.json();if(!r.ok)throw new Error(d.message||"Failed to create pending bill.");Qe(d.id,Math.round(t*100))}catch(r){o(`Failed to create pending bill: ${r.message}`),v(!1)}}else{const s="paid";if(!B){o("Payment mode required."),v(!1);return}const r={patientId:i,queueId:C||null,items:n,amount:t,paymentMode:B,type:m,related_id:F||P||null,status:s,discountPercentage:k,labOrderId:P||null};setTimeout(()=>window.print(),200);try{const d=await y("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),x=await d.json();if(!d.ok)throw new Error(x.message||"Failed to create bill.");if(B==="credit"&&i)try{await y(`/api/patient-debts/${i}/debts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction_date:new Date().toISOString().split("T")[0],debt_value:t,related_bill_id:x.id,notes:`Bill #${x.id}`})})}catch(re){console.error("Failed to create debt entry:",re)}w&&w(x.id),v(!1)}catch(d){o(`Failed to process bill: ${d.message}`),v(!1)}}},Ve=(g==null?void 0:g.status)??M,Xe=p==="view_pay"&&g&&Ve==="pending";return!i&&!S?e.jsx("div",{className:"p-6 bg-white rounded-lg shadow text-gray-500",children:"Select patient or provide Bill ID."}):oe||p==="view_pay"&&fe?e.jsx("div",{className:"p-6 bg-white rounded-lg shadow",children:"Loading..."}):p==="view_pay"&&!g&&!fe&&X?e.jsxs("div",{className:"p-6 bg-white rounded-lg shadow text-red-600",children:["Error loading bill: ",X]}):p==="create"&&!u&&!oe&&X?e.jsxs("div",{className:"p-6 bg-white rounded-lg shadow text-red-600",children:["Error loading patient: ",X]}):e.jsxs("div",{className:"pharmacy-billing-page",children:[" ",e.jsxs("div",{className:"billing-container printable-section",children:[e.jsxs("div",{className:"billing-header print-only",children:[e.jsx("div",{className:"clinic-header-left",children:e.jsx("div",{className:"clinic-info-print",children:e.jsxs("div",{className:"clinic-name-and-details-print",children:[e.jsx("h1",{className:"bill-title",children:"TAX INVOICE"}),e.jsx("h2",{className:"clinic-name-print",children:le?`${le}`:"Bill"}),(je||ye)&&e.jsxs("div",{className:"clinic-details-print",children:[je&&e.jsx("span",{className:"small-text clinic-address",children:je}),ye&&e.jsx("span",{className:"small-text clinic-notes",children:ye})]})]})})}),e.jsxs("div",{className:"patient-info-grid print-only-patient-details",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Ee,{size:16})," Patient"]})," ",(u==null?void 0:u.name)||"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Re,{size:16})," Date"]})," ",new Date().toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"})]}),g&&e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"# Invoice"})," ",dt(g.id)]})]})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("section",{className:"order-details-card no-print",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Patient Information"})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Ee,{size:16})," Patient Name"]})," ",u==null?void 0:u.name]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Ae,{size:16})," ID"]})," ",u==null?void 0:u.id]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Re,{size:16})," Age/Gender"]})," ",(u==null?void 0:u.age)??"N/A"," / ",(u==null?void 0:u.gender)??"N/A"]}),p==="view_pay"&&g&&e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(et,{size:16})," Bill ID"]})," ",g.id]})]})]}),e.jsxs("section",{className:"medications-card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h2",{children:"Bill Items"}),p==="create"&&m==="pharmacy"&&!I&&b.some(t=>t.drug_id!=null)&&e.jsxs("button",{onClick:()=>be(b),disabled:ae,className:"refresh-prices-button",title:"Refresh item prices from inventory",children:[e.jsx(tt,{size:14,className:`lucide ${ae?"animate-spin":""}`}),ae?"Refreshing...":"Refresh"]})]}),e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"S.No."}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Price"}),e.jsx("th",{children:"Total"}),p==="create"&&!I&&e.jsx("th",{className:"no-print",children:"Action"})]})}),e.jsxs("tbody",{children:[p==="create"&&b.map((t,n)=>e.jsxs("tr",{children:[e.jsx("td",{children:n+1}),e.jsx("td",{children:t.name}),e.jsx("td",{children:t.quantity}),e.jsxs("td",{children:["₹",t.price.toFixed(2)]}),e.jsxs("td",{children:["₹",t.total.toFixed(2)]}),!I&&e.jsx("td",{className:"no-print",children:typeof t.id=="number"&&t.name!=="Consultation Fee"?e.jsxs("button",{onClick:()=>Je(t.id),className:"remove-item-button",title:"Remove",children:[" ",e.jsx(st,{size:16})," "]}):e.jsxs("span",{className:"lock-icon",title:"Cannot remove",children:[" ",e.jsx(nt,{size:14})," "]})})]},t.id)),p==="view_pay"&&g&&g.items.map((t,n)=>e.jsxs("tr",{children:[e.jsx("td",{children:n+1}),e.jsx("td",{children:t.name}),e.jsx("td",{children:t.quantity}),e.jsxs("td",{children:["₹",t.price.toFixed(2)]}),e.jsxs("td",{children:["₹",(t.total??t.price*t.quantity).toFixed(2)]})]},n)),(p==="create"&&b.length===0||p==="view_pay"&&(g==null?void 0:g.items.length)===0)&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,style:{textAlign:"center",padding:"20px"},children:"No items added."})})]})]}),p==="create"&&!I&&e.jsxs("div",{className:"add-item-form no-print",style:{padding:"15px",borderTop:"1px solid #eee"},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Item Description"}),e.jsx("input",{type:"text",value:Z,onChange:t=>Q(t.target.value),placeholder:"Service Name",className:"custom-text-input"})]}),e.jsxs("div",{className:"form-group",style:{maxWidth:"80px"},children:[e.jsx("label",{children:"Qty"}),e.jsx("input",{type:"number",min:"1",value:ee,onChange:t=>K(parseInt(t.target.value)||1),placeholder:"1",className:"custom-text-input"})]}),e.jsxs("div",{className:"form-group",style:{maxWidth:"100px"},children:[e.jsx("label",{children:"Price (₹)"}),e.jsx("input",{type:"number",value:se,onChange:t=>H(t.target.value),placeholder:"0.00",className:"custom-text-input"})]}),e.jsx("button",{onClick:We,className:"add-item-button",children:"Add Item"}),m==="consultation"&&e.jsxs("div",{className:"default-fee-section",style:{marginLeft:"auto",display:"flex",alignItems:"flex-end",gap:"5px"},children:[e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsx("label",{children:"Default Fee"}),e.jsx("input",{type:"number",value:Pe,onChange:t=>_e(t.target.value),style:{width:"80px",padding:"10px",borderRadius:"6px",border:"1px solid #ccc"}})]}),e.jsx("button",{onClick:Ge,className:"secondary-button",style:{padding:"10px"},children:e.jsx(at,{size:16})})]})]})]}),e.jsxs("div",{className:"bill-summary-print print-only",children:[e.jsxs("div",{className:"bill-summary-details",children:[e.jsxs("div",{className:"summary-row-print",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",me.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row-print",children:[e.jsxs("span",{children:["Discount (",k,"%)"]}),e.jsxs("span",{children:["- ₹",Ie.toFixed(2)]})]}),e.jsx("div",{className:"print-only-total",children:e.jsxs("strong",{children:["Grand Total: ₹",E.toFixed(2)]})})]}),he&&e.jsxs("div",{className:"qr-code-container qr-code-printable-section",children:[e.jsx($e,{value:he,size:100}),e.jsx("p",{className:"print-only-upi-text",children:"Scan to pay using UPI"})]})]})]}),e.jsx("aside",{className:"billing-sidebar no-print",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Billing Summary"})}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",me.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Discount"}),p==="create"&&!I?e.jsxs("div",{className:"discount-input-wrapper",children:[e.jsx("input",{type:"number",value:k,onChange:t=>U(parseFloat(t.target.value)||0),min:"0",max:"100",className:"discount-input-total"}),"%"]}):e.jsxs("span",{children:[k,"%"]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Discount Amount"}),e.jsxs("span",{children:["- ₹",Ie.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row grand-total-row",children:[e.jsx("strong",{children:"Grand Total"}),e.jsxs("strong",{children:["₹",E.toFixed(2)]})]}),p==="view_pay"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"summary-row",style:{color:"green"},children:[e.jsx("span",{children:"Total Paid"}),e.jsxs("span",{children:["₹",Ne.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",style:{color:"red",fontWeight:"bold"},children:[e.jsx("span",{children:"Balance Due"}),e.jsxs("span",{children:["₹",ke.toFixed(2)]})]})]}),e.jsx("div",{className:"qr-code-container",children:he?e.jsxs(e.Fragment,{children:[e.jsx($e,{value:he,size:128}),e.jsx("p",{children:"Scan to pay using UPI"})]}):e.jsx("p",{children:"UPI QR code not available."})}),p==="create"&&e.jsxs("div",{className:"payment-mode-section",children:[e.jsx("label",{htmlFor:"paymentMode",className:"info-item",children:e.jsx("strong",{children:"Payment Mode"})}),e.jsxs("select",{id:"paymentMode",value:B,onChange:t=>W(t.target.value),className:"payment-mode-select",disabled:I||ne,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"no_cash_insurance",children:"No Cash Insurance"}),e.jsx("option",{value:"credit",children:"Credit (Debt to Patient)"}),e.jsx("option",{value:"online",children:"Online (Razorpay)"})]})]}),p==="create"&&B==="credit"&&e.jsxs("div",{className:"debt-info-section",style:{marginTop:"10px",padding:"12px",backgroundColor:"rgba(220, 53, 69, 0.1)",borderRadius:"8px",border:"1px solid rgba(220, 53, 69, 0.3)"},children:[e.jsx("div",{style:{fontWeight:"bold",color:"#dc3545",marginBottom:"8px"},children:"⚠️ Debt to Patient"}),ue?e.jsx("div",{style:{fontSize:"0.9em",color:"#666"},children:"Loading debt info..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"Current Debt:"}),e.jsxs("strong",{style:{color:l&&l>0?"#dc3545":"#28a745"},children:["₹",(l||0).toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"This Bill:"}),e.jsxs("strong",{children:["+ ₹",E.toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",borderTop:"1px solid rgba(220, 53, 69, 0.3)",paddingTop:"8px",marginTop:"8px"},children:[e.jsx("span",{children:e.jsx("strong",{children:"New Total Debt:"})}),e.jsxs("strong",{style:{color:"#dc3545"},children:["₹",((l||0)+E).toFixed(2)]})]})]})]}),p==="create"&&!I&&e.jsx("div",{className:"bill-actions",children:e.jsx("button",{onClick:Ke,className:"primary-button",disabled:ne||b.length===0,children:ne?"Processing...":"Finalise and Bill"})}),p==="view_pay"&&e.jsxs("div",{className:"bill-actions",children:[e.jsx("button",{onClick:()=>window.print(),className:"secondary-button",children:"Print Bill"}),Xe&&ke>0&&e.jsxs("div",{className:"payment-recording-section",style:{marginTop:"20px",borderTop:"1px dashed #ccc",paddingTop:"15px"},children:[e.jsx("h3",{style:{fontSize:"1em",marginBottom:"10px"},children:"Record Payment"}),e.jsxs("div",{style:{display:"flex",gap:"5px",marginBottom:"10px"},children:[e.jsx("input",{type:"number",value:A,onChange:t=>ie(t.target.value),placeholder:"Amount",className:"custom-text-input",style:{flex:1}}),e.jsxs("select",{value:Y,onChange:t=>te(t.target.value),className:"custom-select-input",style:{width:"auto"},children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"no_cash_insurance",children:"Insurance"}),e.jsx("option",{value:"credit",children:"Credit"})]})]}),e.jsx("button",{onClick:He,disabled:j,className:"primary-button",style:{width:"100%",fontSize:"0.9em"},children:j?"Recording...":"Record Payment"})]})]})]})})]}),e.jsxs("div",{className:"amount-in-words-print print-only",children:[e.jsx("strong",{children:"Amount in Words:"})," ",ct(p==="view_pay"&&g?g.amount:E)]}),e.jsxs("div",{className:"terms-conditions-print print-only",children:[e.jsx("h4",{children:"Terms & Conditions"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Goods once sold will not be taken back or exchanged."}),e.jsx("li",{children:"All disputes are subject to local jurisdiction."}),e.jsx("li",{children:"Please retain this bill for future reference."})]})]}),e.jsxs("div",{className:"signature-section-print print-only",children:[e.jsx("div",{className:"receiver-sign",children:e.jsx("div",{className:"sign-line",children:"Receiver's Signature"})}),e.jsxs("div",{className:"authorized-sign",children:[e.jsxs("div",{className:"for-clinic",children:["For ",le||"Clinic"]}),e.jsx("div",{className:"sign-line",children:"Authorised Signatory"})]})]}),e.jsxs("footer",{className:"billing-footer print-only",children:[e.jsx("p",{className:"thank-you",children:"Thank you for your visit!"}),e.jsx("p",{className:"computer-generated",children:"This is a computer generated invoice and does not require a physical signature."})]})]})]})},yt=()=>{const i=Ye(),S=Ze(),{patientId:C,queueId:w,patientName:f,initialItems:D,billType:m,relatedId:F,initialStatus:M,initialDiscountPercentage:O,doctorId:I,billId:T,labOrderId:P}=S.state||{},[L,u]=a.useState(null),[R,b]=a.useState(null),[z,G]=a.useState(null),[Z,Q]=a.useState(null),[se,H]=a.useState(null),[ee,K]=a.useState(null),[k,U]=a.useState(null),[B,W]=a.useState(null),[oe,V]=a.useState(!0),[X,o]=a.useState(null),[ne,v]=a.useState(f||"");a.useEffect(()=>{if(!C){console.error("BillingPage loaded without required patientId in location state."),i("/");return}(async()=>{V(!0),o(null);try{let N=C,$=D||null,c=M||null,q=m||null,A=F||null,ie=O!==void 0?parseFloat(O):null,Y=f||null,te=null;if(T){console.log(`Fetching details for Bill ID: ${T}`);const j=await y(`/api/bills/${T}`);if(!j.ok){const l=await j.json().catch(()=>({message:`Failed to fetch bill details for ID ${T}`}));throw new Error(l.message||`Failed to fetch bill details (Status: ${j.status})`)}const h=await j.json();if(console.log("Fetched Bill Data:",h),$=h.bill.items||[],c=h.bill.status||"pending",q=h.bill.type||null,A=h.bill.related_id||null,ie=h.bill.discount_percentage!==void 0&&h.bill.discount_percentage!==null?parseFloat(h.bill.discount_percentage):0,N=h.bill.patient_id,Q($),H(c),K(q),U(A),W(ie),N){const l=await y(`/api/patients/${N}`);if(l.ok){const _=await l.json();Y=_.name,te=_.phone??null,G(_.insurance_type??null),v(Y),b(te)}else console.warn(`Could not fetch patient details for ID ${N} from bill.`),v("Patient (Not Found)")}else console.warn(`Bill ${T} does not have an associated patient_id.`),v("Patient (Unknown)")}else if(P){console.log(`Fetching details for Lab Order ID: ${P}`);const j=await y(`/api/lab/${P}`);if(!j.ok){let l=`Failed to fetch lab order details (Status: ${j.status} ${j.statusText})`;try{l=(await j.json()).message||l}catch{console.error("Response was not valid JSON:",await j.text())}throw new Error(l)}const h=await j.json();if(console.log("Fetched Lab Order Data:",JSON.stringify(h,null,2)),$=(h.tests||[]).filter(l=>l&&typeof l.name=="string"&&l.price!==void 0&&l.id!==void 0).map(l=>{const _=parseFloat(l.price||"0"),ue=!isNaN(_)&&isFinite(_)?_:0;return{item_id:l.id,name:l.name,price:ue,quantity:1,total:ue*1,type:"lab_test"}}),$&&$.length===0&&(h.tests||[]).length>0&&(console.warn("Warning: Some tests from the lab order were filtered out due to missing id, name, or price.",h.tests),o(l=>`${l?l+"; ":""}Warning: Some lab items could not be added to the bill due to missing details.`)),c="pending",q="lab",A=P,N=h.patient_id,Q($),H(c),K(q),U(A),N){const l=await y(`/api/patients/${N}`);if(l.ok){const _=await l.json();Y=_.name,te=_.phone??null,G(_.insurance_type??null),v(Y),b(te)}else console.warn(`Could not fetch patient details for ID ${N} from lab order.`),v("Patient (Not Found)")}else console.warn(`Lab Order ${P} does not have an associated patient_id.`),v("Patient (Unknown)")}else if(Q(D||null),H(M||null),K(m||null),U(F||null),W(O!==void 0?parseFloat(O):null),v(f||`ID ${C}`),N){const j=await y(`/api/patients/${N}`);if(j.ok){const h=await j.json();b(h.phone??null),G(h.insurance_type??null)}else console.warn(`Could not fetch patient details for ID ${N}.`)}if(w){const j=await y(`/api/queue/${w}`);if(j.ok){const h=await j.json();u(h.token_number)}else console.warn(`Could not fetch queue details for ID ${w}.`)}}catch(N){console.error("Error fetching billing page details:",N),o(`Failed to load details: ${N.message}`),Q(null),H(null),K(null),U(null),v(f||""),b(null),u(null)}finally{V(!1)}})()},[C,T,P,w,i]);const ae=g=>{console.log(`Billing process completed for patient ID ${C}. New Bill ID: ${g}`),i(-1)},ce=()=>{console.log(`Bill updated for patient ID ${C}.`),i(-1)};if(!C)return e.jsxs("div",{className:"min-h-screen bg-neutral-light flex flex-col items-center justify-center text-gray-600",children:[e.jsx(ze,{size:48,className:"mb-4 text-red-500"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:"Missing Patient Information"}),e.jsx("p",{className:"text-sm",children:"Cannot load the billing page without a patient ID."}),e.jsx("button",{onClick:()=>i("/"),className:"mt-4 px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700",children:"Go to Dashboard"})]});if(oe)return e.jsxs("div",{className:"billing-page-container",children:[e.jsx("div",{className:"back-button-container",children:e.jsx(J,{width:80,height:32})}),e.jsxs("div",{className:"billing-content-wrapper",children:[e.jsx("div",{className:"flex items-center gap-4 mb-4",children:e.jsx(J,{width:300,height:32})}),e.jsxs("div",{className:"patient-info-bar mb-6",style:{display:"flex",gap:"1rem",padding:"10px",background:"#f9fafb",borderRadius:"8px"},children:[e.jsx(J,{width:100,height:20}),e.jsx(J,{width:120,height:20}),e.jsx(J,{width:140,height:20})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"md:col-span-2 space-y-4",children:[e.jsx(J,{width:"100%",height:200,className:"rounded-lg"}),e.jsx(J,{width:"100%",height:150,className:"rounded-lg"})]}),e.jsx("div",{className:"space-y-4",children:e.jsx(J,{width:"100%",height:300,className:"rounded-lg"})})]})]})]});if(X)return e.jsxs("div",{className:"min-h-screen bg-neutral-light flex flex-col items-center justify-center text-red-600 p-4",children:[e.jsx(ze,{size:48,className:"mb-4"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:"Error Loading Billing Details"}),e.jsx("p",{className:"text-sm text-center mb-4",children:X}),e.jsx("button",{onClick:()=>window.location.reload(),className:"mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Retry"}),e.jsx("button",{onClick:()=>i(-1),className:"mt-2 text-sm text-gray-600 hover:text-teal-700",children:"Go Back"})]});const de=(se??M)==="paid";return e.jsxs("div",{className:"billing-page-container",children:[e.jsx("div",{className:"back-button-container",children:e.jsx("button",{onClick:()=>i(-1),className:"back-button",title:"Go Back",children:e.jsx(it,{size:20,className:"lucide"})})}),e.jsxs("div",{className:"billing-content-wrapper",children:[e.jsxs("h3",{className:"billing-page-title",children:[T?"Bill Details":P?"Create Lab Bill":"Create Bill"," for Patient: ",ne||`ID ${C}`]}),e.jsxs("div",{className:"patient-info-bar",children:[L!==null&&e.jsxs("span",{children:[e.jsx(Ae,{size:14,className:"lucide"})," Token: ",L]}),R&&e.jsxs("span",{children:[e.jsx(lt,{size:14,className:"lucide"})," Phone: ",R]}),P&&e.jsxs("span",{className:"lab-order-info",children:[e.jsx(rt,{size:14,className:"lucide"})," Lab Order: ",P.substring(0,8),"..."]}),!R&&L===null&&!P&&e.jsx("span",{className:"placeholder-text",children:"(Token/Phone not available)"}),z&&e.jsxs("span",{className:"insurance-info",children:[e.jsx(ot,{size:14,className:"lucide"})," Insurance: ",z.replace(/_/g," ").replace(/\b\w/g,g=>g.toUpperCase())]}),!R&&L===null&&!P&&!z&&e.jsx("span",{className:"placeholder-text",children:"(Token/Phone not available)"})]}),e.jsx(ut,{patientId:C,labOrderId:P,queueId:w,onBillCreated:ae,onBillUpdated:ce,initialItems:Z??D,billType:ee??m,relatedId:k??F,initialStatus:se??M,initialDiscountPercentage:B??O,readOnlyMode:de,doctorId:I,patientInsuranceType:z??void 0})]})]})};export{yt as default};
