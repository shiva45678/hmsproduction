import{j as i,S as Ce,p as Hs,f as K,w as Jl,M as Qt,o as gt,e as Ql,q as Dt,u as Gl,d as Yl,g as Kl}from"./index-DCOSVs-d.js";import{g as Xl,b as _i,r as w,a as Ws,j as Zl,u as ec,f as tc}from"./react-vendor-Cc0P4_ZX.js";/* empty css                   *//* empty css                           */import{ab as pt,ac as Vs,ad as ln,aa as ht,f as Js,X as pn,ae as Qs,u as yr,e as pr,a7 as Gs,af as Ys,v as Xa,a4 as Za,z as es,ag as nc,C as ts,g as ns,W as rc,i as ic,ah as ac,ai as sc,Q as oc,o as lc,a as cc,aj as uc}from"./ui-vendor-SmiJk_kJ.js";import{u as Ks}from"./useAutoFocusSingleInput-6a_v4dYJ.js";import{f as At}from"./fuzzyMatch-BaTsC35g.js";import{G as dc}from"./ai-vendor-CB5T-uN5.js";import{A as pc}from"./AddRecurringMedicationModal-DkUDw__4.js";import{Q as Xs}from"./index-CZ6CIOFr.js";/* empty css                            */import"./utils-vendor-azd6ta8e.js";import"./chart-vendor-BcjzKorn.js";const hc={};function Li(e,n){const t=hc,r=typeof t.includeImageAlt=="boolean"?t.includeImageAlt:!0,s=typeof t.includeHtml=="boolean"?t.includeHtml:!0;return Zs(e,r,s)}function Zs(e,n,t){if(mc(e)){if("value"in e)return e.type==="html"&&!t?"":e.value;if(n&&"alt"in e&&e.alt)return e.alt;if("children"in e)return rs(e.children,n,t)}return Array.isArray(e)?rs(e,n,t):""}function rs(e,n,t){const r=[];let s=-1;for(;++s<e.length;)r[s]=Zs(e[s],n,t);return r.join("")}function mc(e){return!!(e&&typeof e=="object")}const is=document.createElement("i");function Ri(e){const n="&"+e+";";is.innerHTML=n;const t=is.textContent;return t.charCodeAt(t.length-1)===59&&e!=="semi"||t===n?!1:t}function bt(e,n,t,r){const s=e.length;let a=0,o;if(n<0?n=-n>s?0:s+n:n=n>s?s:n,t=t>0?t:0,r.length<1e4)o=Array.from(r),o.unshift(n,t),e.splice(...o);else for(t&&e.splice(n,t);a<r.length;)o=r.slice(a,a+1e4),o.unshift(n,0),e.splice(...o),a+=1e4,n+=1e4}function ot(e,n){return e.length>0?(bt(e,e.length,0,n),e):n}const as={}.hasOwnProperty;function fc(e){const n={};let t=-1;for(;++t<e.length;)gc(n,e[t]);return n}function gc(e,n){let t;for(t in n){const s=(as.call(e,t)?e[t]:void 0)||(e[t]={}),a=n[t];let o;if(a)for(o in a){as.call(s,o)||(s[o]=[]);const l=a[o];yc(s[o],Array.isArray(l)?l:l?[l]:[])}}}function yc(e,n){let t=-1;const r=[];for(;++t<n.length;)(n[t].add==="after"?e:r).push(n[t]);bt(e,0,0,r)}function eo(e,n){const t=Number.parseInt(e,n);return t<9||t===11||t>13&&t<32||t>126&&t<160||t>55295&&t<57344||t>64975&&t<65008||(t&65535)===65535||(t&65535)===65534||t>1114111?"�":String.fromCodePoint(t)}function cn(e){return e.replace(/[\t\n\r ]+/g," ").replace(/^ | $/g,"").toLowerCase().toUpperCase()}const xt=Mt(/[A-Za-z]/),it=Mt(/[\dA-Za-z]/),xc=Mt(/[#-'*+\--9=?A-Z^-~]/);function Ni(e){return e!==null&&(e<32||e===127)}const vi=Mt(/\d/),bc=Mt(/[\dA-Fa-f]/),wc=Mt(/[!-/:-@[-`{-~]/);function fe(e){return e!==null&&e<-2}function Xe(e){return e!==null&&(e<0||e===32)}function Te(e){return e===-2||e===-1||e===32}const kc=Mt(new RegExp("\\p{P}|\\p{S}","u")),_c=Mt(/\s/);function Mt(e){return n;function n(t){return t!==null&&t>-1&&e.test(String.fromCharCode(t))}}function hn(e){const n=[];let t=-1,r=0,s=0;for(;++t<e.length;){const a=e.charCodeAt(t);let o="";if(a===37&&it(e.charCodeAt(t+1))&&it(e.charCodeAt(t+2)))s=2;else if(a<128)/[!#$&-;=?-Z_a-z~]/.test(String.fromCharCode(a))||(o=String.fromCharCode(a));else if(a>55295&&a<57344){const l=e.charCodeAt(t+1);a<56320&&l>56319&&l<57344?(o=String.fromCharCode(a,l),s=1):o="�"}else o=String.fromCharCode(a);o&&(n.push(e.slice(r,t),encodeURIComponent(o)),r=t+s+1,o=""),s&&(t+=s,s=0)}return n.join("")+e.slice(r)}function Ie(e,n,t,r){const s=r?r-1:Number.POSITIVE_INFINITY;let a=0;return o;function o(c){return Te(c)?(e.enter(t),l(c)):n(c)}function l(c){return Te(c)&&a++<s?(e.consume(c),l):(e.exit(t),n(c))}}const Nc={tokenize:vc};function vc(e){const n=e.attempt(this.parser.constructs.contentInitial,r,s);let t;return n;function r(l){if(l===null){e.consume(l);return}return e.enter("lineEnding"),e.consume(l),e.exit("lineEnding"),Ie(e,n,"linePrefix")}function s(l){return e.enter("paragraph"),a(l)}function a(l){const c=e.enter("chunkText",{contentType:"text",previous:t});return t&&(t.next=c),t=c,o(l)}function o(l){if(l===null){e.exit("chunkText"),e.exit("paragraph"),e.consume(l);return}return fe(l)?(e.consume(l),e.exit("chunkText"),a):(e.consume(l),o)}}const jc={tokenize:Cc},ss={tokenize:Sc};function Cc(e){const n=this,t=[];let r=0,s,a,o;return l;function l(L){if(r<t.length){const W=t[r];return n.containerState=W[1],e.attempt(W[0].continuation,c,u)(L)}return u(L)}function c(L){if(r++,n.containerState._closeFlow){n.containerState._closeFlow=void 0,s&&H();const W=n.events.length;let F=W,j;for(;F--;)if(n.events[F][0]==="exit"&&n.events[F][1].type==="chunkFlow"){j=n.events[F][1].end;break}O(r);let X=W;for(;X<n.events.length;)n.events[X][1].end={...j},X++;return bt(n.events,F+1,0,n.events.slice(W)),n.events.length=X,u(L)}return l(L)}function u(L){if(r===t.length){if(!s)return y(L);if(s.currentConstruct&&s.currentConstruct.concrete)return D(L);n.interrupt=!!(s.currentConstruct&&!s._gfmTableDynamicInterruptHack)}return n.containerState={},e.check(ss,m,d)(L)}function m(L){return s&&H(),O(r),y(L)}function d(L){return n.parser.lazy[n.now().line]=r!==t.length,o=n.now().offset,D(L)}function y(L){return n.containerState={},e.attempt(ss,h,D)(L)}function h(L){return r++,t.push([n.currentConstruct,n.containerState]),y(L)}function D(L){if(L===null){s&&H(),O(0),e.consume(L);return}return s=s||n.parser.flow(n.now()),e.enter("chunkFlow",{_tokenizer:s,contentType:"flow",previous:a}),q(L)}function q(L){if(L===null){Y(e.exit("chunkFlow"),!0),O(0),e.consume(L);return}return fe(L)?(e.consume(L),Y(e.exit("chunkFlow")),r=0,n.interrupt=void 0,l):(e.consume(L),q)}function Y(L,W){const F=n.sliceStream(L);if(W&&F.push(null),L.previous=a,a&&(a.next=L),a=L,s.defineSkip(L.start),s.write(F),n.parser.lazy[L.start.line]){let j=s.events.length;for(;j--;)if(s.events[j][1].start.offset<o&&(!s.events[j][1].end||s.events[j][1].end.offset>o))return;const X=n.events.length;let le=X,ne,oe;for(;le--;)if(n.events[le][0]==="exit"&&n.events[le][1].type==="chunkFlow"){if(ne){oe=n.events[le][1].end;break}ne=!0}for(O(r),j=X;j<n.events.length;)n.events[j][1].end={...oe},j++;bt(n.events,le+1,0,n.events.slice(X)),n.events.length=j}}function O(L){let W=t.length;for(;W-- >L;){const F=t[W];n.containerState=F[1],F[0].exit.call(n,e)}t.length=L}function H(){s.write([null]),a=void 0,s=void 0,n.containerState._closeFlow=void 0}}function Sc(e,n,t){return Ie(e,e.attempt(this.parser.constructs.document,n,t),"linePrefix",this.parser.constructs.disable.null.includes("codeIndented")?void 0:4)}function mr(e){if(e===null||Xe(e)||_c(e))return 1;if(kc(e))return 2}function Fi(e,n,t){const r=[];let s=-1;for(;++s<e.length;){const a=e[s].resolveAll;a&&!r.includes(a)&&(n=a(n,t),r.push(a))}return n}const ji={name:"attention",resolveAll:Pc,tokenize:Tc};function Pc(e,n){let t=-1,r,s,a,o,l,c,u,m;for(;++t<e.length;)if(e[t][0]==="enter"&&e[t][1].type==="attentionSequence"&&e[t][1]._close){for(r=t;r--;)if(e[r][0]==="exit"&&e[r][1].type==="attentionSequence"&&e[r][1]._open&&n.sliceSerialize(e[r][1]).charCodeAt(0)===n.sliceSerialize(e[t][1]).charCodeAt(0)){if((e[r][1]._close||e[t][1]._open)&&(e[t][1].end.offset-e[t][1].start.offset)%3&&!((e[r][1].end.offset-e[r][1].start.offset+e[t][1].end.offset-e[t][1].start.offset)%3))continue;c=e[r][1].end.offset-e[r][1].start.offset>1&&e[t][1].end.offset-e[t][1].start.offset>1?2:1;const d={...e[r][1].end},y={...e[t][1].start};os(d,-c),os(y,c),o={type:c>1?"strongSequence":"emphasisSequence",start:d,end:{...e[r][1].end}},l={type:c>1?"strongSequence":"emphasisSequence",start:{...e[t][1].start},end:y},a={type:c>1?"strongText":"emphasisText",start:{...e[r][1].end},end:{...e[t][1].start}},s={type:c>1?"strong":"emphasis",start:{...o.start},end:{...l.end}},e[r][1].end={...o.start},e[t][1].start={...l.end},u=[],e[r][1].end.offset-e[r][1].start.offset&&(u=ot(u,[["enter",e[r][1],n],["exit",e[r][1],n]])),u=ot(u,[["enter",s,n],["enter",o,n],["exit",o,n],["enter",a,n]]),u=ot(u,Fi(n.parser.constructs.insideSpan.null,e.slice(r+1,t),n)),u=ot(u,[["exit",a,n],["enter",l,n],["exit",l,n],["exit",s,n]]),e[t][1].end.offset-e[t][1].start.offset?(m=2,u=ot(u,[["enter",e[t][1],n],["exit",e[t][1],n]])):m=0,bt(e,r-1,t-r+3,u),t=r+u.length-m-2;break}}for(t=-1;++t<e.length;)e[t][1].type==="attentionSequence"&&(e[t][1].type="data");return e}function Tc(e,n){const t=this.parser.constructs.attentionMarkers.null,r=this.previous,s=mr(r);let a;return o;function o(c){return a=c,e.enter("attentionSequence"),l(c)}function l(c){if(c===a)return e.consume(c),l;const u=e.exit("attentionSequence"),m=mr(c),d=!m||m===2&&s||t.includes(c),y=!s||s===2&&m||t.includes(r);return u._open=!!(a===42?d:d&&(s||!y)),u._close=!!(a===42?y:y&&(m||!d)),n(c)}}function os(e,n){e.column+=n,e.offset+=n,e._bufferIndex+=n}const Ec={name:"autolink",tokenize:Ac};function Ac(e,n,t){let r=0;return s;function s(h){return e.enter("autolink"),e.enter("autolinkMarker"),e.consume(h),e.exit("autolinkMarker"),e.enter("autolinkProtocol"),a}function a(h){return xt(h)?(e.consume(h),o):h===64?t(h):u(h)}function o(h){return h===43||h===45||h===46||it(h)?(r=1,l(h)):u(h)}function l(h){return h===58?(e.consume(h),r=0,c):(h===43||h===45||h===46||it(h))&&r++<32?(e.consume(h),l):(r=0,u(h))}function c(h){return h===62?(e.exit("autolinkProtocol"),e.enter("autolinkMarker"),e.consume(h),e.exit("autolinkMarker"),e.exit("autolink"),n):h===null||h===32||h===60||Ni(h)?t(h):(e.consume(h),c)}function u(h){return h===64?(e.consume(h),m):xc(h)?(e.consume(h),u):t(h)}function m(h){return it(h)?d(h):t(h)}function d(h){return h===46?(e.consume(h),r=0,m):h===62?(e.exit("autolinkProtocol").type="autolinkEmail",e.enter("autolinkMarker"),e.consume(h),e.exit("autolinkMarker"),e.exit("autolink"),n):y(h)}function y(h){if((h===45||it(h))&&r++<63){const D=h===45?y:d;return e.consume(h),D}return t(h)}}const xr={partial:!0,tokenize:Dc};function Dc(e,n,t){return r;function r(a){return Te(a)?Ie(e,s,"linePrefix")(a):s(a)}function s(a){return a===null||fe(a)?n(a):t(a)}}const to={continuation:{tokenize:Oc},exit:$c,name:"blockQuote",tokenize:Ic};function Ic(e,n,t){const r=this;return s;function s(o){if(o===62){const l=r.containerState;return l.open||(e.enter("blockQuote",{_container:!0}),l.open=!0),e.enter("blockQuotePrefix"),e.enter("blockQuoteMarker"),e.consume(o),e.exit("blockQuoteMarker"),a}return t(o)}function a(o){return Te(o)?(e.enter("blockQuotePrefixWhitespace"),e.consume(o),e.exit("blockQuotePrefixWhitespace"),e.exit("blockQuotePrefix"),n):(e.exit("blockQuotePrefix"),n(o))}}function Oc(e,n,t){const r=this;return s;function s(o){return Te(o)?Ie(e,a,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(o):a(o)}function a(o){return e.attempt(to,n,t)(o)}}function $c(e){e.exit("blockQuote")}const no={name:"characterEscape",tokenize:Lc};function Lc(e,n,t){return r;function r(a){return e.enter("characterEscape"),e.enter("escapeMarker"),e.consume(a),e.exit("escapeMarker"),s}function s(a){return wc(a)?(e.enter("characterEscapeValue"),e.consume(a),e.exit("characterEscapeValue"),e.exit("characterEscape"),n):t(a)}}const ro={name:"characterReference",tokenize:Rc};function Rc(e,n,t){const r=this;let s=0,a,o;return l;function l(d){return e.enter("characterReference"),e.enter("characterReferenceMarker"),e.consume(d),e.exit("characterReferenceMarker"),c}function c(d){return d===35?(e.enter("characterReferenceMarkerNumeric"),e.consume(d),e.exit("characterReferenceMarkerNumeric"),u):(e.enter("characterReferenceValue"),a=31,o=it,m(d))}function u(d){return d===88||d===120?(e.enter("characterReferenceMarkerHexadecimal"),e.consume(d),e.exit("characterReferenceMarkerHexadecimal"),e.enter("characterReferenceValue"),a=6,o=bc,m):(e.enter("characterReferenceValue"),a=7,o=vi,m(d))}function m(d){if(d===59&&s){const y=e.exit("characterReferenceValue");return o===it&&!Ri(r.sliceSerialize(y))?t(d):(e.enter("characterReferenceMarker"),e.consume(d),e.exit("characterReferenceMarker"),e.exit("characterReference"),n)}return o(d)&&s++<a?(e.consume(d),m):t(d)}}const ls={partial:!0,tokenize:zc},cs={concrete:!0,name:"codeFenced",tokenize:Fc};function Fc(e,n,t){const r=this,s={partial:!0,tokenize:F};let a=0,o=0,l;return c;function c(j){return u(j)}function u(j){const X=r.events[r.events.length-1];return a=X&&X[1].type==="linePrefix"?X[2].sliceSerialize(X[1],!0).length:0,l=j,e.enter("codeFenced"),e.enter("codeFencedFence"),e.enter("codeFencedFenceSequence"),m(j)}function m(j){return j===l?(o++,e.consume(j),m):o<3?t(j):(e.exit("codeFencedFenceSequence"),Te(j)?Ie(e,d,"whitespace")(j):d(j))}function d(j){return j===null||fe(j)?(e.exit("codeFencedFence"),r.interrupt?n(j):e.check(ls,q,W)(j)):(e.enter("codeFencedFenceInfo"),e.enter("chunkString",{contentType:"string"}),y(j))}function y(j){return j===null||fe(j)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),d(j)):Te(j)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),Ie(e,h,"whitespace")(j)):j===96&&j===l?t(j):(e.consume(j),y)}function h(j){return j===null||fe(j)?d(j):(e.enter("codeFencedFenceMeta"),e.enter("chunkString",{contentType:"string"}),D(j))}function D(j){return j===null||fe(j)?(e.exit("chunkString"),e.exit("codeFencedFenceMeta"),d(j)):j===96&&j===l?t(j):(e.consume(j),D)}function q(j){return e.attempt(s,W,Y)(j)}function Y(j){return e.enter("lineEnding"),e.consume(j),e.exit("lineEnding"),O}function O(j){return a>0&&Te(j)?Ie(e,H,"linePrefix",a+1)(j):H(j)}function H(j){return j===null||fe(j)?e.check(ls,q,W)(j):(e.enter("codeFlowValue"),L(j))}function L(j){return j===null||fe(j)?(e.exit("codeFlowValue"),H(j)):(e.consume(j),L)}function W(j){return e.exit("codeFenced"),n(j)}function F(j,X,le){let ne=0;return oe;function oe(A){return j.enter("lineEnding"),j.consume(A),j.exit("lineEnding"),V}function V(A){return j.enter("codeFencedFence"),Te(A)?Ie(j,k,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(A):k(A)}function k(A){return A===l?(j.enter("codeFencedFenceSequence"),C(A)):le(A)}function C(A){return A===l?(ne++,j.consume(A),C):ne>=o?(j.exit("codeFencedFenceSequence"),Te(A)?Ie(j,G,"whitespace")(A):G(A)):le(A)}function G(A){return A===null||fe(A)?(j.exit("codeFencedFence"),X(A)):le(A)}}}function zc(e,n,t){const r=this;return s;function s(o){return o===null?t(o):(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),a)}function a(o){return r.parser.lazy[r.now().line]?t(o):n(o)}}const ri={name:"codeIndented",tokenize:Bc},qc={partial:!0,tokenize:Uc};function Bc(e,n,t){const r=this;return s;function s(u){return e.enter("codeIndented"),Ie(e,a,"linePrefix",5)(u)}function a(u){const m=r.events[r.events.length-1];return m&&m[1].type==="linePrefix"&&m[2].sliceSerialize(m[1],!0).length>=4?o(u):t(u)}function o(u){return u===null?c(u):fe(u)?e.attempt(qc,o,c)(u):(e.enter("codeFlowValue"),l(u))}function l(u){return u===null||fe(u)?(e.exit("codeFlowValue"),o(u)):(e.consume(u),l)}function c(u){return e.exit("codeIndented"),n(u)}}function Uc(e,n,t){const r=this;return s;function s(o){return r.parser.lazy[r.now().line]?t(o):fe(o)?(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),s):Ie(e,a,"linePrefix",5)(o)}function a(o){const l=r.events[r.events.length-1];return l&&l[1].type==="linePrefix"&&l[2].sliceSerialize(l[1],!0).length>=4?n(o):fe(o)?s(o):t(o)}}const Mc={name:"codeText",previous:Wc,resolve:Hc,tokenize:Vc};function Hc(e){let n=e.length-4,t=3,r,s;if((e[t][1].type==="lineEnding"||e[t][1].type==="space")&&(e[n][1].type==="lineEnding"||e[n][1].type==="space")){for(r=t;++r<n;)if(e[r][1].type==="codeTextData"){e[t][1].type="codeTextPadding",e[n][1].type="codeTextPadding",t+=2,n-=2;break}}for(r=t-1,n++;++r<=n;)s===void 0?r!==n&&e[r][1].type!=="lineEnding"&&(s=r):(r===n||e[r][1].type==="lineEnding")&&(e[s][1].type="codeTextData",r!==s+2&&(e[s][1].end=e[r-1][1].end,e.splice(s+2,r-s-2),n-=r-s-2,r=s+2),s=void 0);return e}function Wc(e){return e!==96||this.events[this.events.length-1][1].type==="characterEscape"}function Vc(e,n,t){let r=0,s,a;return o;function o(d){return e.enter("codeText"),e.enter("codeTextSequence"),l(d)}function l(d){return d===96?(e.consume(d),r++,l):(e.exit("codeTextSequence"),c(d))}function c(d){return d===null?t(d):d===32?(e.enter("space"),e.consume(d),e.exit("space"),c):d===96?(a=e.enter("codeTextSequence"),s=0,m(d)):fe(d)?(e.enter("lineEnding"),e.consume(d),e.exit("lineEnding"),c):(e.enter("codeTextData"),u(d))}function u(d){return d===null||d===32||d===96||fe(d)?(e.exit("codeTextData"),c(d)):(e.consume(d),u)}function m(d){return d===96?(e.consume(d),s++,m):s===r?(e.exit("codeTextSequence"),e.exit("codeText"),n(d)):(a.type="codeTextData",u(d))}}class Jc{constructor(n){this.left=n?[...n]:[],this.right=[]}get(n){if(n<0||n>=this.left.length+this.right.length)throw new RangeError("Cannot access index `"+n+"` in a splice buffer of size `"+(this.left.length+this.right.length)+"`");return n<this.left.length?this.left[n]:this.right[this.right.length-n+this.left.length-1]}get length(){return this.left.length+this.right.length}shift(){return this.setCursor(0),this.right.pop()}slice(n,t){const r=t??Number.POSITIVE_INFINITY;return r<this.left.length?this.left.slice(n,r):n>this.left.length?this.right.slice(this.right.length-r+this.left.length,this.right.length-n+this.left.length).reverse():this.left.slice(n).concat(this.right.slice(this.right.length-r+this.left.length).reverse())}splice(n,t,r){const s=t||0;this.setCursor(Math.trunc(n));const a=this.right.splice(this.right.length-s,Number.POSITIVE_INFINITY);return r&&Ln(this.left,r),a.reverse()}pop(){return this.setCursor(Number.POSITIVE_INFINITY),this.left.pop()}push(n){this.setCursor(Number.POSITIVE_INFINITY),this.left.push(n)}pushMany(n){this.setCursor(Number.POSITIVE_INFINITY),Ln(this.left,n)}unshift(n){this.setCursor(0),this.right.push(n)}unshiftMany(n){this.setCursor(0),Ln(this.right,n.reverse())}setCursor(n){if(!(n===this.left.length||n>this.left.length&&this.right.length===0||n<0&&this.left.length===0))if(n<this.left.length){const t=this.left.splice(n,Number.POSITIVE_INFINITY);Ln(this.right,t.reverse())}else{const t=this.right.splice(this.left.length+this.right.length-n,Number.POSITIVE_INFINITY);Ln(this.left,t.reverse())}}}function Ln(e,n){let t=0;if(n.length<1e4)e.push(...n);else for(;t<n.length;)e.push(...n.slice(t,t+1e4)),t+=1e4}function io(e){const n={};let t=-1,r,s,a,o,l,c,u;const m=new Jc(e);for(;++t<m.length;){for(;t in n;)t=n[t];if(r=m.get(t),t&&r[1].type==="chunkFlow"&&m.get(t-1)[1].type==="listItemPrefix"&&(c=r[1]._tokenizer.events,a=0,a<c.length&&c[a][1].type==="lineEndingBlank"&&(a+=2),a<c.length&&c[a][1].type==="content"))for(;++a<c.length&&c[a][1].type!=="content";)c[a][1].type==="chunkText"&&(c[a][1]._isInFirstContentOfListItem=!0,a++);if(r[0]==="enter")r[1].contentType&&(Object.assign(n,Qc(m,t)),t=n[t],u=!0);else if(r[1]._container){for(a=t,s=void 0;a--;)if(o=m.get(a),o[1].type==="lineEnding"||o[1].type==="lineEndingBlank")o[0]==="enter"&&(s&&(m.get(s)[1].type="lineEndingBlank"),o[1].type="lineEnding",s=a);else if(!(o[1].type==="linePrefix"||o[1].type==="listItemIndent"))break;s&&(r[1].end={...m.get(s)[1].start},l=m.slice(s,t),l.unshift(r),m.splice(s,t-s+1,l))}}return bt(e,0,Number.POSITIVE_INFINITY,m.slice(0)),!u}function Qc(e,n){const t=e.get(n)[1],r=e.get(n)[2];let s=n-1;const a=[];let o=t._tokenizer;o||(o=r.parser[t.contentType](t.start),t._contentTypeTextTrailing&&(o._contentTypeTextTrailing=!0));const l=o.events,c=[],u={};let m,d,y=-1,h=t,D=0,q=0;const Y=[q];for(;h;){for(;e.get(++s)[1]!==h;);a.push(s),h._tokenizer||(m=r.sliceStream(h),h.next||m.push(null),d&&o.defineSkip(h.start),h._isInFirstContentOfListItem&&(o._gfmTasklistFirstContentOfListItem=!0),o.write(m),h._isInFirstContentOfListItem&&(o._gfmTasklistFirstContentOfListItem=void 0)),d=h,h=h.next}for(h=t;++y<l.length;)l[y][0]==="exit"&&l[y-1][0]==="enter"&&l[y][1].type===l[y-1][1].type&&l[y][1].start.line!==l[y][1].end.line&&(q=y+1,Y.push(q),h._tokenizer=void 0,h.previous=void 0,h=h.next);for(o.events=[],h?(h._tokenizer=void 0,h.previous=void 0):Y.pop(),y=Y.length;y--;){const O=l.slice(Y[y],Y[y+1]),H=a.pop();c.push([H,H+O.length-1]),e.splice(H,2,O)}for(c.reverse(),y=-1;++y<c.length;)u[D+c[y][0]]=D+c[y][1],D+=c[y][1]-c[y][0]-1;return u}const Gc={resolve:Kc,tokenize:Xc},Yc={partial:!0,tokenize:Zc};function Kc(e){return io(e),e}function Xc(e,n){let t;return r;function r(l){return e.enter("content"),t=e.enter("chunkContent",{contentType:"content"}),s(l)}function s(l){return l===null?a(l):fe(l)?e.check(Yc,o,a)(l):(e.consume(l),s)}function a(l){return e.exit("chunkContent"),e.exit("content"),n(l)}function o(l){return e.consume(l),e.exit("chunkContent"),t.next=e.enter("chunkContent",{contentType:"content",previous:t}),t=t.next,s}}function Zc(e,n,t){const r=this;return s;function s(o){return e.exit("chunkContent"),e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),Ie(e,a,"linePrefix")}function a(o){if(o===null||fe(o))return t(o);const l=r.events[r.events.length-1];return!r.parser.constructs.disable.null.includes("codeIndented")&&l&&l[1].type==="linePrefix"&&l[2].sliceSerialize(l[1],!0).length>=4?n(o):e.interrupt(r.parser.constructs.flow,t,n)(o)}}function ao(e,n,t,r,s,a,o,l,c){const u=c||Number.POSITIVE_INFINITY;let m=0;return d;function d(O){return O===60?(e.enter(r),e.enter(s),e.enter(a),e.consume(O),e.exit(a),y):O===null||O===32||O===41||Ni(O)?t(O):(e.enter(r),e.enter(o),e.enter(l),e.enter("chunkString",{contentType:"string"}),q(O))}function y(O){return O===62?(e.enter(a),e.consume(O),e.exit(a),e.exit(s),e.exit(r),n):(e.enter(l),e.enter("chunkString",{contentType:"string"}),h(O))}function h(O){return O===62?(e.exit("chunkString"),e.exit(l),y(O)):O===null||O===60||fe(O)?t(O):(e.consume(O),O===92?D:h)}function D(O){return O===60||O===62||O===92?(e.consume(O),h):h(O)}function q(O){return!m&&(O===null||O===41||Xe(O))?(e.exit("chunkString"),e.exit(l),e.exit(o),e.exit(r),n(O)):m<u&&O===40?(e.consume(O),m++,q):O===41?(e.consume(O),m--,q):O===null||O===32||O===40||Ni(O)?t(O):(e.consume(O),O===92?Y:q)}function Y(O){return O===40||O===41||O===92?(e.consume(O),q):q(O)}}function so(e,n,t,r,s,a){const o=this;let l=0,c;return u;function u(h){return e.enter(r),e.enter(s),e.consume(h),e.exit(s),e.enter(a),m}function m(h){return l>999||h===null||h===91||h===93&&!c||h===94&&!l&&"_hiddenFootnoteSupport"in o.parser.constructs?t(h):h===93?(e.exit(a),e.enter(s),e.consume(h),e.exit(s),e.exit(r),n):fe(h)?(e.enter("lineEnding"),e.consume(h),e.exit("lineEnding"),m):(e.enter("chunkString",{contentType:"string"}),d(h))}function d(h){return h===null||h===91||h===93||fe(h)||l++>999?(e.exit("chunkString"),m(h)):(e.consume(h),c||(c=!Te(h)),h===92?y:d)}function y(h){return h===91||h===92||h===93?(e.consume(h),l++,d):d(h)}}function oo(e,n,t,r,s,a){let o;return l;function l(y){return y===34||y===39||y===40?(e.enter(r),e.enter(s),e.consume(y),e.exit(s),o=y===40?41:y,c):t(y)}function c(y){return y===o?(e.enter(s),e.consume(y),e.exit(s),e.exit(r),n):(e.enter(a),u(y))}function u(y){return y===o?(e.exit(a),c(o)):y===null?t(y):fe(y)?(e.enter("lineEnding"),e.consume(y),e.exit("lineEnding"),Ie(e,u,"linePrefix")):(e.enter("chunkString",{contentType:"string"}),m(y))}function m(y){return y===o||y===null||fe(y)?(e.exit("chunkString"),u(y)):(e.consume(y),y===92?d:m)}function d(y){return y===o||y===92?(e.consume(y),m):m(y)}}function Fn(e,n){let t;return r;function r(s){return fe(s)?(e.enter("lineEnding"),e.consume(s),e.exit("lineEnding"),t=!0,r):Te(s)?Ie(e,r,t?"linePrefix":"lineSuffix")(s):n(s)}}const eu={name:"definition",tokenize:nu},tu={partial:!0,tokenize:ru};function nu(e,n,t){const r=this;let s;return a;function a(h){return e.enter("definition"),o(h)}function o(h){return so.call(r,e,l,t,"definitionLabel","definitionLabelMarker","definitionLabelString")(h)}function l(h){return s=cn(r.sliceSerialize(r.events[r.events.length-1][1]).slice(1,-1)),h===58?(e.enter("definitionMarker"),e.consume(h),e.exit("definitionMarker"),c):t(h)}function c(h){return Xe(h)?Fn(e,u)(h):u(h)}function u(h){return ao(e,m,t,"definitionDestination","definitionDestinationLiteral","definitionDestinationLiteralMarker","definitionDestinationRaw","definitionDestinationString")(h)}function m(h){return e.attempt(tu,d,d)(h)}function d(h){return Te(h)?Ie(e,y,"whitespace")(h):y(h)}function y(h){return h===null||fe(h)?(e.exit("definition"),r.parser.defined.push(s),n(h)):t(h)}}function ru(e,n,t){return r;function r(l){return Xe(l)?Fn(e,s)(l):t(l)}function s(l){return oo(e,a,t,"definitionTitle","definitionTitleMarker","definitionTitleString")(l)}function a(l){return Te(l)?Ie(e,o,"whitespace")(l):o(l)}function o(l){return l===null||fe(l)?n(l):t(l)}}const iu={name:"hardBreakEscape",tokenize:au};function au(e,n,t){return r;function r(a){return e.enter("hardBreakEscape"),e.consume(a),s}function s(a){return fe(a)?(e.exit("hardBreakEscape"),n(a)):t(a)}}const su={name:"headingAtx",resolve:ou,tokenize:lu};function ou(e,n){let t=e.length-2,r=3,s,a;return e[r][1].type==="whitespace"&&(r+=2),t-2>r&&e[t][1].type==="whitespace"&&(t-=2),e[t][1].type==="atxHeadingSequence"&&(r===t-1||t-4>r&&e[t-2][1].type==="whitespace")&&(t-=r+1===t?2:4),t>r&&(s={type:"atxHeadingText",start:e[r][1].start,end:e[t][1].end},a={type:"chunkText",start:e[r][1].start,end:e[t][1].end,contentType:"text"},bt(e,r,t-r+1,[["enter",s,n],["enter",a,n],["exit",a,n],["exit",s,n]])),e}function lu(e,n,t){let r=0;return s;function s(m){return e.enter("atxHeading"),a(m)}function a(m){return e.enter("atxHeadingSequence"),o(m)}function o(m){return m===35&&r++<6?(e.consume(m),o):m===null||Xe(m)?(e.exit("atxHeadingSequence"),l(m)):t(m)}function l(m){return m===35?(e.enter("atxHeadingSequence"),c(m)):m===null||fe(m)?(e.exit("atxHeading"),n(m)):Te(m)?Ie(e,l,"whitespace")(m):(e.enter("atxHeadingText"),u(m))}function c(m){return m===35?(e.consume(m),c):(e.exit("atxHeadingSequence"),l(m))}function u(m){return m===null||m===35||Xe(m)?(e.exit("atxHeadingText"),l(m)):(e.consume(m),u)}}const cu=["address","article","aside","base","basefont","blockquote","body","caption","center","col","colgroup","dd","details","dialog","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hr","html","iframe","legend","li","link","main","menu","menuitem","nav","noframes","ol","optgroup","option","p","param","search","section","summary","table","tbody","td","tfoot","th","thead","title","tr","track","ul"],us=["pre","script","style","textarea"],uu={concrete:!0,name:"htmlFlow",resolveTo:hu,tokenize:mu},du={partial:!0,tokenize:gu},pu={partial:!0,tokenize:fu};function hu(e){let n=e.length;for(;n--&&!(e[n][0]==="enter"&&e[n][1].type==="htmlFlow"););return n>1&&e[n-2][1].type==="linePrefix"&&(e[n][1].start=e[n-2][1].start,e[n+1][1].start=e[n-2][1].start,e.splice(n-2,2)),e}function mu(e,n,t){const r=this;let s,a,o,l,c;return u;function u(b){return m(b)}function m(b){return e.enter("htmlFlow"),e.enter("htmlFlowData"),e.consume(b),d}function d(b){return b===33?(e.consume(b),y):b===47?(e.consume(b),a=!0,q):b===63?(e.consume(b),s=3,r.interrupt?n:x):xt(b)?(e.consume(b),o=String.fromCharCode(b),Y):t(b)}function y(b){return b===45?(e.consume(b),s=2,h):b===91?(e.consume(b),s=5,l=0,D):xt(b)?(e.consume(b),s=4,r.interrupt?n:x):t(b)}function h(b){return b===45?(e.consume(b),r.interrupt?n:x):t(b)}function D(b){const Ne="CDATA[";return b===Ne.charCodeAt(l++)?(e.consume(b),l===Ne.length?r.interrupt?n:k:D):t(b)}function q(b){return xt(b)?(e.consume(b),o=String.fromCharCode(b),Y):t(b)}function Y(b){if(b===null||b===47||b===62||Xe(b)){const Ne=b===47,Me=o.toLowerCase();return!Ne&&!a&&us.includes(Me)?(s=1,r.interrupt?n(b):k(b)):cu.includes(o.toLowerCase())?(s=6,Ne?(e.consume(b),O):r.interrupt?n(b):k(b)):(s=7,r.interrupt&&!r.parser.lazy[r.now().line]?t(b):a?H(b):L(b))}return b===45||it(b)?(e.consume(b),o+=String.fromCharCode(b),Y):t(b)}function O(b){return b===62?(e.consume(b),r.interrupt?n:k):t(b)}function H(b){return Te(b)?(e.consume(b),H):oe(b)}function L(b){return b===47?(e.consume(b),oe):b===58||b===95||xt(b)?(e.consume(b),W):Te(b)?(e.consume(b),L):oe(b)}function W(b){return b===45||b===46||b===58||b===95||it(b)?(e.consume(b),W):F(b)}function F(b){return b===61?(e.consume(b),j):Te(b)?(e.consume(b),F):L(b)}function j(b){return b===null||b===60||b===61||b===62||b===96?t(b):b===34||b===39?(e.consume(b),c=b,X):Te(b)?(e.consume(b),j):le(b)}function X(b){return b===c?(e.consume(b),c=null,ne):b===null||fe(b)?t(b):(e.consume(b),X)}function le(b){return b===null||b===34||b===39||b===47||b===60||b===61||b===62||b===96||Xe(b)?F(b):(e.consume(b),le)}function ne(b){return b===47||b===62||Te(b)?L(b):t(b)}function oe(b){return b===62?(e.consume(b),V):t(b)}function V(b){return b===null||fe(b)?k(b):Te(b)?(e.consume(b),V):t(b)}function k(b){return b===45&&s===2?(e.consume(b),M):b===60&&s===1?(e.consume(b),J):b===62&&s===4?(e.consume(b),Oe):b===63&&s===3?(e.consume(b),x):b===93&&s===5?(e.consume(b),pe):fe(b)&&(s===6||s===7)?(e.exit("htmlFlowData"),e.check(du,Fe,C)(b)):b===null||fe(b)?(e.exit("htmlFlowData"),C(b)):(e.consume(b),k)}function C(b){return e.check(pu,G,Fe)(b)}function G(b){return e.enter("lineEnding"),e.consume(b),e.exit("lineEnding"),A}function A(b){return b===null||fe(b)?C(b):(e.enter("htmlFlowData"),k(b))}function M(b){return b===45?(e.consume(b),x):k(b)}function J(b){return b===47?(e.consume(b),o="",je):k(b)}function je(b){if(b===62){const Ne=o.toLowerCase();return us.includes(Ne)?(e.consume(b),Oe):k(b)}return xt(b)&&o.length<8?(e.consume(b),o+=String.fromCharCode(b),je):k(b)}function pe(b){return b===93?(e.consume(b),x):k(b)}function x(b){return b===62?(e.consume(b),Oe):b===45&&s===2?(e.consume(b),x):k(b)}function Oe(b){return b===null||fe(b)?(e.exit("htmlFlowData"),Fe(b)):(e.consume(b),Oe)}function Fe(b){return e.exit("htmlFlow"),n(b)}}function fu(e,n,t){const r=this;return s;function s(o){return fe(o)?(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),a):t(o)}function a(o){return r.parser.lazy[r.now().line]?t(o):n(o)}}function gu(e,n,t){return r;function r(s){return e.enter("lineEnding"),e.consume(s),e.exit("lineEnding"),e.attempt(xr,n,t)}}const yu={name:"htmlText",tokenize:xu};function xu(e,n,t){const r=this;let s,a,o;return l;function l(x){return e.enter("htmlText"),e.enter("htmlTextData"),e.consume(x),c}function c(x){return x===33?(e.consume(x),u):x===47?(e.consume(x),F):x===63?(e.consume(x),L):xt(x)?(e.consume(x),le):t(x)}function u(x){return x===45?(e.consume(x),m):x===91?(e.consume(x),a=0,D):xt(x)?(e.consume(x),H):t(x)}function m(x){return x===45?(e.consume(x),h):t(x)}function d(x){return x===null?t(x):x===45?(e.consume(x),y):fe(x)?(o=d,J(x)):(e.consume(x),d)}function y(x){return x===45?(e.consume(x),h):d(x)}function h(x){return x===62?M(x):x===45?y(x):d(x)}function D(x){const Oe="CDATA[";return x===Oe.charCodeAt(a++)?(e.consume(x),a===Oe.length?q:D):t(x)}function q(x){return x===null?t(x):x===93?(e.consume(x),Y):fe(x)?(o=q,J(x)):(e.consume(x),q)}function Y(x){return x===93?(e.consume(x),O):q(x)}function O(x){return x===62?M(x):x===93?(e.consume(x),O):q(x)}function H(x){return x===null||x===62?M(x):fe(x)?(o=H,J(x)):(e.consume(x),H)}function L(x){return x===null?t(x):x===63?(e.consume(x),W):fe(x)?(o=L,J(x)):(e.consume(x),L)}function W(x){return x===62?M(x):L(x)}function F(x){return xt(x)?(e.consume(x),j):t(x)}function j(x){return x===45||it(x)?(e.consume(x),j):X(x)}function X(x){return fe(x)?(o=X,J(x)):Te(x)?(e.consume(x),X):M(x)}function le(x){return x===45||it(x)?(e.consume(x),le):x===47||x===62||Xe(x)?ne(x):t(x)}function ne(x){return x===47?(e.consume(x),M):x===58||x===95||xt(x)?(e.consume(x),oe):fe(x)?(o=ne,J(x)):Te(x)?(e.consume(x),ne):M(x)}function oe(x){return x===45||x===46||x===58||x===95||it(x)?(e.consume(x),oe):V(x)}function V(x){return x===61?(e.consume(x),k):fe(x)?(o=V,J(x)):Te(x)?(e.consume(x),V):ne(x)}function k(x){return x===null||x===60||x===61||x===62||x===96?t(x):x===34||x===39?(e.consume(x),s=x,C):fe(x)?(o=k,J(x)):Te(x)?(e.consume(x),k):(e.consume(x),G)}function C(x){return x===s?(e.consume(x),s=void 0,A):x===null?t(x):fe(x)?(o=C,J(x)):(e.consume(x),C)}function G(x){return x===null||x===34||x===39||x===60||x===61||x===96?t(x):x===47||x===62||Xe(x)?ne(x):(e.consume(x),G)}function A(x){return x===47||x===62||Xe(x)?ne(x):t(x)}function M(x){return x===62?(e.consume(x),e.exit("htmlTextData"),e.exit("htmlText"),n):t(x)}function J(x){return e.exit("htmlTextData"),e.enter("lineEnding"),e.consume(x),e.exit("lineEnding"),je}function je(x){return Te(x)?Ie(e,pe,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(x):pe(x)}function pe(x){return e.enter("htmlTextData"),o(x)}}const zi={name:"labelEnd",resolveAll:_u,resolveTo:Nu,tokenize:vu},bu={tokenize:ju},wu={tokenize:Cu},ku={tokenize:Su};function _u(e){let n=-1;const t=[];for(;++n<e.length;){const r=e[n][1];if(t.push(e[n]),r.type==="labelImage"||r.type==="labelLink"||r.type==="labelEnd"){const s=r.type==="labelImage"?4:2;r.type="data",n+=s}}return e.length!==t.length&&bt(e,0,e.length,t),e}function Nu(e,n){let t=e.length,r=0,s,a,o,l;for(;t--;)if(s=e[t][1],a){if(s.type==="link"||s.type==="labelLink"&&s._inactive)break;e[t][0]==="enter"&&s.type==="labelLink"&&(s._inactive=!0)}else if(o){if(e[t][0]==="enter"&&(s.type==="labelImage"||s.type==="labelLink")&&!s._balanced&&(a=t,s.type!=="labelLink")){r=2;break}}else s.type==="labelEnd"&&(o=t);const c={type:e[a][1].type==="labelLink"?"link":"image",start:{...e[a][1].start},end:{...e[e.length-1][1].end}},u={type:"label",start:{...e[a][1].start},end:{...e[o][1].end}},m={type:"labelText",start:{...e[a+r+2][1].end},end:{...e[o-2][1].start}};return l=[["enter",c,n],["enter",u,n]],l=ot(l,e.slice(a+1,a+r+3)),l=ot(l,[["enter",m,n]]),l=ot(l,Fi(n.parser.constructs.insideSpan.null,e.slice(a+r+4,o-3),n)),l=ot(l,[["exit",m,n],e[o-2],e[o-1],["exit",u,n]]),l=ot(l,e.slice(o+1)),l=ot(l,[["exit",c,n]]),bt(e,a,e.length,l),e}function vu(e,n,t){const r=this;let s=r.events.length,a,o;for(;s--;)if((r.events[s][1].type==="labelImage"||r.events[s][1].type==="labelLink")&&!r.events[s][1]._balanced){a=r.events[s][1];break}return l;function l(y){return a?a._inactive?d(y):(o=r.parser.defined.includes(cn(r.sliceSerialize({start:a.end,end:r.now()}))),e.enter("labelEnd"),e.enter("labelMarker"),e.consume(y),e.exit("labelMarker"),e.exit("labelEnd"),c):t(y)}function c(y){return y===40?e.attempt(bu,m,o?m:d)(y):y===91?e.attempt(wu,m,o?u:d)(y):o?m(y):d(y)}function u(y){return e.attempt(ku,m,d)(y)}function m(y){return n(y)}function d(y){return a._balanced=!0,t(y)}}function ju(e,n,t){return r;function r(d){return e.enter("resource"),e.enter("resourceMarker"),e.consume(d),e.exit("resourceMarker"),s}function s(d){return Xe(d)?Fn(e,a)(d):a(d)}function a(d){return d===41?m(d):ao(e,o,l,"resourceDestination","resourceDestinationLiteral","resourceDestinationLiteralMarker","resourceDestinationRaw","resourceDestinationString",32)(d)}function o(d){return Xe(d)?Fn(e,c)(d):m(d)}function l(d){return t(d)}function c(d){return d===34||d===39||d===40?oo(e,u,t,"resourceTitle","resourceTitleMarker","resourceTitleString")(d):m(d)}function u(d){return Xe(d)?Fn(e,m)(d):m(d)}function m(d){return d===41?(e.enter("resourceMarker"),e.consume(d),e.exit("resourceMarker"),e.exit("resource"),n):t(d)}}function Cu(e,n,t){const r=this;return s;function s(l){return so.call(r,e,a,o,"reference","referenceMarker","referenceString")(l)}function a(l){return r.parser.defined.includes(cn(r.sliceSerialize(r.events[r.events.length-1][1]).slice(1,-1)))?n(l):t(l)}function o(l){return t(l)}}function Su(e,n,t){return r;function r(a){return e.enter("reference"),e.enter("referenceMarker"),e.consume(a),e.exit("referenceMarker"),s}function s(a){return a===93?(e.enter("referenceMarker"),e.consume(a),e.exit("referenceMarker"),e.exit("reference"),n):t(a)}}const Pu={name:"labelStartImage",resolveAll:zi.resolveAll,tokenize:Tu};function Tu(e,n,t){const r=this;return s;function s(l){return e.enter("labelImage"),e.enter("labelImageMarker"),e.consume(l),e.exit("labelImageMarker"),a}function a(l){return l===91?(e.enter("labelMarker"),e.consume(l),e.exit("labelMarker"),e.exit("labelImage"),o):t(l)}function o(l){return l===94&&"_hiddenFootnoteSupport"in r.parser.constructs?t(l):n(l)}}const Eu={name:"labelStartLink",resolveAll:zi.resolveAll,tokenize:Au};function Au(e,n,t){const r=this;return s;function s(o){return e.enter("labelLink"),e.enter("labelMarker"),e.consume(o),e.exit("labelMarker"),e.exit("labelLink"),a}function a(o){return o===94&&"_hiddenFootnoteSupport"in r.parser.constructs?t(o):n(o)}}const ii={name:"lineEnding",tokenize:Du};function Du(e,n){return t;function t(r){return e.enter("lineEnding"),e.consume(r),e.exit("lineEnding"),Ie(e,n,"linePrefix")}}const hr={name:"thematicBreak",tokenize:Iu};function Iu(e,n,t){let r=0,s;return a;function a(u){return e.enter("thematicBreak"),o(u)}function o(u){return s=u,l(u)}function l(u){return u===s?(e.enter("thematicBreakSequence"),c(u)):r>=3&&(u===null||fe(u))?(e.exit("thematicBreak"),n(u)):t(u)}function c(u){return u===s?(e.consume(u),r++,c):(e.exit("thematicBreakSequence"),Te(u)?Ie(e,l,"whitespace")(u):l(u))}}const Ke={continuation:{tokenize:Ru},exit:zu,name:"list",tokenize:Lu},Ou={partial:!0,tokenize:qu},$u={partial:!0,tokenize:Fu};function Lu(e,n,t){const r=this,s=r.events[r.events.length-1];let a=s&&s[1].type==="linePrefix"?s[2].sliceSerialize(s[1],!0).length:0,o=0;return l;function l(h){const D=r.containerState.type||(h===42||h===43||h===45?"listUnordered":"listOrdered");if(D==="listUnordered"?!r.containerState.marker||h===r.containerState.marker:vi(h)){if(r.containerState.type||(r.containerState.type=D,e.enter(D,{_container:!0})),D==="listUnordered")return e.enter("listItemPrefix"),h===42||h===45?e.check(hr,t,u)(h):u(h);if(!r.interrupt||h===49)return e.enter("listItemPrefix"),e.enter("listItemValue"),c(h)}return t(h)}function c(h){return vi(h)&&++o<10?(e.consume(h),c):(!r.interrupt||o<2)&&(r.containerState.marker?h===r.containerState.marker:h===41||h===46)?(e.exit("listItemValue"),u(h)):t(h)}function u(h){return e.enter("listItemMarker"),e.consume(h),e.exit("listItemMarker"),r.containerState.marker=r.containerState.marker||h,e.check(xr,r.interrupt?t:m,e.attempt(Ou,y,d))}function m(h){return r.containerState.initialBlankLine=!0,a++,y(h)}function d(h){return Te(h)?(e.enter("listItemPrefixWhitespace"),e.consume(h),e.exit("listItemPrefixWhitespace"),y):t(h)}function y(h){return r.containerState.size=a+r.sliceSerialize(e.exit("listItemPrefix"),!0).length,n(h)}}function Ru(e,n,t){const r=this;return r.containerState._closeFlow=void 0,e.check(xr,s,a);function s(l){return r.containerState.furtherBlankLines=r.containerState.furtherBlankLines||r.containerState.initialBlankLine,Ie(e,n,"listItemIndent",r.containerState.size+1)(l)}function a(l){return r.containerState.furtherBlankLines||!Te(l)?(r.containerState.furtherBlankLines=void 0,r.containerState.initialBlankLine=void 0,o(l)):(r.containerState.furtherBlankLines=void 0,r.containerState.initialBlankLine=void 0,e.attempt($u,n,o)(l))}function o(l){return r.containerState._closeFlow=!0,r.interrupt=void 0,Ie(e,e.attempt(Ke,n,t),"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(l)}}function Fu(e,n,t){const r=this;return Ie(e,s,"listItemIndent",r.containerState.size+1);function s(a){const o=r.events[r.events.length-1];return o&&o[1].type==="listItemIndent"&&o[2].sliceSerialize(o[1],!0).length===r.containerState.size?n(a):t(a)}}function zu(e){e.exit(this.containerState.type)}function qu(e,n,t){const r=this;return Ie(e,s,"listItemPrefixWhitespace",r.parser.constructs.disable.null.includes("codeIndented")?void 0:5);function s(a){const o=r.events[r.events.length-1];return!Te(a)&&o&&o[1].type==="listItemPrefixWhitespace"?n(a):t(a)}}const ds={name:"setextUnderline",resolveTo:Bu,tokenize:Uu};function Bu(e,n){let t=e.length,r,s,a;for(;t--;)if(e[t][0]==="enter"){if(e[t][1].type==="content"){r=t;break}e[t][1].type==="paragraph"&&(s=t)}else e[t][1].type==="content"&&e.splice(t,1),!a&&e[t][1].type==="definition"&&(a=t);const o={type:"setextHeading",start:{...e[r][1].start},end:{...e[e.length-1][1].end}};return e[s][1].type="setextHeadingText",a?(e.splice(s,0,["enter",o,n]),e.splice(a+1,0,["exit",e[r][1],n]),e[r][1].end={...e[a][1].end}):e[r][1]=o,e.push(["exit",o,n]),e}function Uu(e,n,t){const r=this;let s;return a;function a(u){let m=r.events.length,d;for(;m--;)if(r.events[m][1].type!=="lineEnding"&&r.events[m][1].type!=="linePrefix"&&r.events[m][1].type!=="content"){d=r.events[m][1].type==="paragraph";break}return!r.parser.lazy[r.now().line]&&(r.interrupt||d)?(e.enter("setextHeadingLine"),s=u,o(u)):t(u)}function o(u){return e.enter("setextHeadingLineSequence"),l(u)}function l(u){return u===s?(e.consume(u),l):(e.exit("setextHeadingLineSequence"),Te(u)?Ie(e,c,"lineSuffix")(u):c(u))}function c(u){return u===null||fe(u)?(e.exit("setextHeadingLine"),n(u)):t(u)}}const Mu={tokenize:Hu};function Hu(e){const n=this,t=e.attempt(xr,r,e.attempt(this.parser.constructs.flowInitial,s,Ie(e,e.attempt(this.parser.constructs.flow,s,e.attempt(Gc,s)),"linePrefix")));return t;function r(a){if(a===null){e.consume(a);return}return e.enter("lineEndingBlank"),e.consume(a),e.exit("lineEndingBlank"),n.currentConstruct=void 0,t}function s(a){if(a===null){e.consume(a);return}return e.enter("lineEnding"),e.consume(a),e.exit("lineEnding"),n.currentConstruct=void 0,t}}const Wu={resolveAll:co()},Vu=lo("string"),Ju=lo("text");function lo(e){return{resolveAll:co(e==="text"?Qu:void 0),tokenize:n};function n(t){const r=this,s=this.parser.constructs[e],a=t.attempt(s,o,l);return o;function o(m){return u(m)?a(m):l(m)}function l(m){if(m===null){t.consume(m);return}return t.enter("data"),t.consume(m),c}function c(m){return u(m)?(t.exit("data"),a(m)):(t.consume(m),c)}function u(m){if(m===null)return!0;const d=s[m];let y=-1;if(d)for(;++y<d.length;){const h=d[y];if(!h.previous||h.previous.call(r,r.previous))return!0}return!1}}}function co(e){return n;function n(t,r){let s=-1,a;for(;++s<=t.length;)a===void 0?t[s]&&t[s][1].type==="data"&&(a=s,s++):(!t[s]||t[s][1].type!=="data")&&(s!==a+2&&(t[a][1].end=t[s-1][1].end,t.splice(a+2,s-a-2),s=a+2),a=void 0);return e?e(t,r):t}}function Qu(e,n){let t=0;for(;++t<=e.length;)if((t===e.length||e[t][1].type==="lineEnding")&&e[t-1][1].type==="data"){const r=e[t-1][1],s=n.sliceStream(r);let a=s.length,o=-1,l=0,c;for(;a--;){const u=s[a];if(typeof u=="string"){for(o=u.length;u.charCodeAt(o-1)===32;)l++,o--;if(o)break;o=-1}else if(u===-2)c=!0,l++;else if(u!==-1){a++;break}}if(n._contentTypeTextTrailing&&t===e.length&&(l=0),l){const u={type:t===e.length||c||l<2?"lineSuffix":"hardBreakTrailing",start:{_bufferIndex:a?o:r.start._bufferIndex+o,_index:r.start._index+a,line:r.end.line,column:r.end.column-l,offset:r.end.offset-l},end:{...r.end}};r.end={...u.start},r.start.offset===r.end.offset?Object.assign(r,u):(e.splice(t,0,["enter",u,n],["exit",u,n]),t+=2)}t++}return e}const Gu={42:Ke,43:Ke,45:Ke,48:Ke,49:Ke,50:Ke,51:Ke,52:Ke,53:Ke,54:Ke,55:Ke,56:Ke,57:Ke,62:to},Yu={91:eu},Ku={[-2]:ri,[-1]:ri,32:ri},Xu={35:su,42:hr,45:[ds,hr],60:uu,61:ds,95:hr,96:cs,126:cs},Zu={38:ro,92:no},ed={[-5]:ii,[-4]:ii,[-3]:ii,33:Pu,38:ro,42:ji,60:[Ec,yu],91:Eu,92:[iu,no],93:zi,95:ji,96:Mc},td={null:[ji,Wu]},nd={null:[42,95]},rd={null:[]},id=Object.freeze(Object.defineProperty({__proto__:null,attentionMarkers:nd,contentInitial:Yu,disable:rd,document:Gu,flow:Xu,flowInitial:Ku,insideSpan:td,string:Zu,text:ed},Symbol.toStringTag,{value:"Module"}));function ad(e,n,t){let r={_bufferIndex:-1,_index:0,line:t&&t.line||1,column:t&&t.column||1,offset:t&&t.offset||0};const s={},a=[];let o=[],l=[];const c={attempt:X(F),check:X(j),consume:H,enter:L,exit:W,interrupt:X(j,{interrupt:!0})},u={code:null,containerState:{},defineSkip:q,events:[],now:D,parser:e,previous:null,sliceSerialize:y,sliceStream:h,write:d};let m=n.tokenize.call(u,c);return n.resolveAll&&a.push(n),u;function d(V){return o=ot(o,V),Y(),o[o.length-1]!==null?[]:(le(n,0),u.events=Fi(a,u.events,u),u.events)}function y(V,k){return od(h(V),k)}function h(V){return sd(o,V)}function D(){const{_bufferIndex:V,_index:k,line:C,column:G,offset:A}=r;return{_bufferIndex:V,_index:k,line:C,column:G,offset:A}}function q(V){s[V.line]=V.column,oe()}function Y(){let V;for(;r._index<o.length;){const k=o[r._index];if(typeof k=="string")for(V=r._index,r._bufferIndex<0&&(r._bufferIndex=0);r._index===V&&r._bufferIndex<k.length;)O(k.charCodeAt(r._bufferIndex));else O(k)}}function O(V){m=m(V)}function H(V){fe(V)?(r.line++,r.column=1,r.offset+=V===-3?2:1,oe()):V!==-1&&(r.column++,r.offset++),r._bufferIndex<0?r._index++:(r._bufferIndex++,r._bufferIndex===o[r._index].length&&(r._bufferIndex=-1,r._index++)),u.previous=V}function L(V,k){const C=k||{};return C.type=V,C.start=D(),u.events.push(["enter",C,u]),l.push(C),C}function W(V){const k=l.pop();return k.end=D(),u.events.push(["exit",k,u]),k}function F(V,k){le(V,k.from)}function j(V,k){k.restore()}function X(V,k){return C;function C(G,A,M){let J,je,pe,x;return Array.isArray(G)?Fe(G):"tokenize"in G?Fe([G]):Oe(G);function Oe(be){return at;function at(Qe){const Ge=Qe!==null&&be[Qe],lt=Qe!==null&&be.null,wt=[...Array.isArray(Ge)?Ge:Ge?[Ge]:[],...Array.isArray(lt)?lt:lt?[lt]:[]];return Fe(wt)(Qe)}}function Fe(be){return J=be,je=0,be.length===0?M:b(be[je])}function b(be){return at;function at(Qe){return x=ne(),pe=be,be.partial||(u.currentConstruct=be),be.name&&u.parser.constructs.disable.null.includes(be.name)?Me():be.tokenize.call(k?Object.assign(Object.create(u),k):u,c,Ne,Me)(Qe)}}function Ne(be){return V(pe,x),A}function Me(be){return x.restore(),++je<J.length?b(J[je]):M}}}function le(V,k){V.resolveAll&&!a.includes(V)&&a.push(V),V.resolve&&bt(u.events,k,u.events.length-k,V.resolve(u.events.slice(k),u)),V.resolveTo&&(u.events=V.resolveTo(u.events,u))}function ne(){const V=D(),k=u.previous,C=u.currentConstruct,G=u.events.length,A=Array.from(l);return{from:G,restore:M};function M(){r=V,u.previous=k,u.currentConstruct=C,u.events.length=G,l=A,oe()}}function oe(){r.line in s&&r.column<2&&(r.column=s[r.line],r.offset+=s[r.line]-1)}}function sd(e,n){const t=n.start._index,r=n.start._bufferIndex,s=n.end._index,a=n.end._bufferIndex;let o;if(t===s)o=[e[t].slice(r,a)];else{if(o=e.slice(t,s),r>-1){const l=o[0];typeof l=="string"?o[0]=l.slice(r):o.shift()}a>0&&o.push(e[s].slice(0,a))}return o}function od(e,n){let t=-1;const r=[];let s;for(;++t<e.length;){const a=e[t];let o;if(typeof a=="string")o=a;else switch(a){case-5:{o="\r";break}case-4:{o=`
`;break}case-3:{o=`\r
`;break}case-2:{o=n?" ":"	";break}case-1:{if(!n&&s)continue;o=" ";break}default:o=String.fromCharCode(a)}s=a===-2,r.push(o)}return r.join("")}function ld(e){const r={constructs:fc([id,...(e||{}).extensions||[]]),content:s(Nc),defined:[],document:s(jc),flow:s(Mu),lazy:{},string:s(Vu),text:s(Ju)};return r;function s(a){return o;function o(l){return ad(r,a,l)}}}function cd(e){for(;!io(e););return e}const ps=/[\0\t\n\r]/g;function ud(){let e=1,n="",t=!0,r;return s;function s(a,o,l){const c=[];let u,m,d,y,h;for(a=n+(typeof a=="string"?a.toString():new TextDecoder(o||void 0).decode(a)),d=0,n="",t&&(a.charCodeAt(0)===65279&&d++,t=void 0);d<a.length;){if(ps.lastIndex=d,u=ps.exec(a),y=u&&u.index!==void 0?u.index:a.length,h=a.charCodeAt(y),!u){n=a.slice(d);break}if(h===10&&d===y&&r)c.push(-3),r=void 0;else switch(r&&(c.push(-5),r=void 0),d<y&&(c.push(a.slice(d,y)),e+=y-d),h){case 0:{c.push(65533),e++;break}case 9:{for(m=Math.ceil(e/4)*4,c.push(-2);e++<m;)c.push(-1);break}case 10:{c.push(-4),e=1;break}default:r=!0,e=1}d=y+1}return l&&(r&&c.push(-5),n&&c.push(n),c.push(null)),c}}const dd=/\\([!-/:-@[-`{-~])|&(#(?:\d{1,7}|x[\da-f]{1,6})|[\da-z]{1,31});/gi;function uo(e){return e.replace(dd,pd)}function pd(e,n,t){if(n)return n;if(t.charCodeAt(0)===35){const s=t.charCodeAt(1),a=s===120||s===88;return eo(t.slice(a?2:1),a?16:10)}return Ri(t)||e}function zn(e){return!e||typeof e!="object"?"":"position"in e||"type"in e?hs(e.position):"start"in e||"end"in e?hs(e):"line"in e||"column"in e?Ci(e):""}function Ci(e){return ms(e&&e.line)+":"+ms(e&&e.column)}function hs(e){return Ci(e&&e.start)+"-"+Ci(e&&e.end)}function ms(e){return e&&typeof e=="number"?e:1}const po={}.hasOwnProperty;function hd(e,n,t){return typeof n!="string"&&(t=n,n=void 0),md(t)(cd(ld(t).document().write(ud()(e,n,!0))))}function md(e){const n={transforms:[],canContainEols:["emphasis","fragment","heading","paragraph","strong"],enter:{autolink:a(_t),autolinkProtocol:ne,autolinkEmail:ne,atxHeading:a(ct),blockQuote:a(lt),characterEscape:ne,characterReference:ne,codeFenced:a(wt),codeFencedFenceInfo:o,codeFencedFenceMeta:o,codeIndented:a(wt,o),codeText:a(Yt,o),codeTextData:ne,data:ne,codeFlowValue:ne,definition:a(v),definitionDestinationString:o,definitionLabelString:o,definitionTitleString:o,emphasis:a(It),hardBreakEscape:a(kt),hardBreakTrailing:a(kt),htmlFlow:a(We,o),htmlFlowData:ne,htmlText:a(We,o),htmlTextData:ne,image:a(Ot),label:o,link:a(_t),listItem:a(Ue),listItemValue:y,listOrdered:a(Nt,d),listUnordered:a(Nt),paragraph:a(vt),reference:b,referenceString:o,resourceDestinationString:o,resourceTitleString:o,setextHeading:a(ct),strong:a(mt),thematicBreak:a(Le)},exit:{atxHeading:c(),atxHeadingSequence:F,autolink:c(),autolinkEmail:Ge,autolinkProtocol:Qe,blockQuote:c(),characterEscapeValue:oe,characterReferenceMarkerHexadecimal:Me,characterReferenceMarkerNumeric:Me,characterReferenceValue:be,characterReference:at,codeFenced:c(Y),codeFencedFence:q,codeFencedFenceInfo:h,codeFencedFenceMeta:D,codeFlowValue:oe,codeIndented:c(O),codeText:c(A),codeTextData:oe,data:oe,definition:c(),definitionDestinationString:W,definitionLabelString:H,definitionTitleString:L,emphasis:c(),hardBreakEscape:c(k),hardBreakTrailing:c(k),htmlFlow:c(C),htmlFlowData:oe,htmlText:c(G),htmlTextData:oe,image:c(J),label:pe,labelText:je,lineEnding:V,link:c(M),listItem:c(),listOrdered:c(),listUnordered:c(),paragraph:c(),referenceString:Ne,resourceDestinationString:x,resourceTitleString:Oe,resource:Fe,setextHeading:c(le),setextHeadingLineSequence:X,setextHeadingText:j,strong:c(),thematicBreak:c()}};ho(n,(e||{}).mdastExtensions||[]);const t={};return r;function r(S){let T={type:"root",children:[]};const P={stack:[T],tokenStack:[],config:n,enter:l,exit:u,buffer:o,resume:m,data:t},te=[];let ce=-1;for(;++ce<S.length;)if(S[ce][1].type==="listOrdered"||S[ce][1].type==="listUnordered")if(S[ce][0]==="enter")te.push(ce);else{const $e=te.pop();ce=s(S,$e,ce)}for(ce=-1;++ce<S.length;){const $e=n[S[ce][0]];po.call($e,S[ce][1].type)&&$e[S[ce][1].type].call(Object.assign({sliceSerialize:S[ce][2].sliceSerialize},P),S[ce][1])}if(P.tokenStack.length>0){const $e=P.tokenStack[P.tokenStack.length-1];($e[1]||fs).call(P,void 0,$e[0])}for(T.position={start:qt(S.length>0?S[0][1].start:{line:1,column:1,offset:0}),end:qt(S.length>0?S[S.length-2][1].end:{line:1,column:1,offset:0})},ce=-1;++ce<n.transforms.length;)T=n.transforms[ce](T)||T;return T}function s(S,T,P){let te=T-1,ce=-1,$e=!1,He,ke,Ve,tt;for(;++te<=P;){const Re=S[te];switch(Re[1].type){case"listUnordered":case"listOrdered":case"blockQuote":{Re[0]==="enter"?ce++:ce--,tt=void 0;break}case"lineEndingBlank":{Re[0]==="enter"&&(He&&!tt&&!ce&&!Ve&&(Ve=te),tt=void 0);break}case"linePrefix":case"listItemValue":case"listItemMarker":case"listItemPrefix":case"listItemPrefixWhitespace":break;default:tt=void 0}if(!ce&&Re[0]==="enter"&&Re[1].type==="listItemPrefix"||ce===-1&&Re[0]==="exit"&&(Re[1].type==="listUnordered"||Re[1].type==="listOrdered")){if(He){let Z=te;for(ke=void 0;Z--;){const E=S[Z];if(E[1].type==="lineEnding"||E[1].type==="lineEndingBlank"){if(E[0]==="exit")continue;ke&&(S[ke][1].type="lineEndingBlank",$e=!0),E[1].type="lineEnding",ke=Z}else if(!(E[1].type==="linePrefix"||E[1].type==="blockQuotePrefix"||E[1].type==="blockQuotePrefixWhitespace"||E[1].type==="blockQuoteMarker"||E[1].type==="listItemIndent"))break}Ve&&(!ke||Ve<ke)&&(He._spread=!0),He.end=Object.assign({},ke?S[ke][1].start:Re[1].end),S.splice(ke||te,0,["exit",He,Re[2]]),te++,P++}if(Re[1].type==="listItemPrefix"){const Z={type:"listItem",_spread:!1,start:Object.assign({},Re[1].start),end:void 0};He=Z,S.splice(te,0,["enter",Z,Re[2]]),te++,P++,Ve=void 0,tt=!0}}}return S[T][1]._spread=$e,P}function a(S,T){return P;function P(te){l.call(this,S(te),te),T&&T.call(this,te)}}function o(){this.stack.push({type:"fragment",children:[]})}function l(S,T,P){this.stack[this.stack.length-1].children.push(S),this.stack.push(S),this.tokenStack.push([T,P||void 0]),S.position={start:qt(T.start),end:void 0}}function c(S){return T;function T(P){S&&S.call(this,P),u.call(this,P)}}function u(S,T){const P=this.stack.pop(),te=this.tokenStack.pop();if(te)te[0].type!==S.type&&(T?T.call(this,S,te[0]):(te[1]||fs).call(this,S,te[0]));else throw new Error("Cannot close `"+S.type+"` ("+zn({start:S.start,end:S.end})+"): it’s not open");P.position.end=qt(S.end)}function m(){return Li(this.stack.pop())}function d(){this.data.expectingFirstListItemValue=!0}function y(S){if(this.data.expectingFirstListItemValue){const T=this.stack[this.stack.length-2];T.start=Number.parseInt(this.sliceSerialize(S),10),this.data.expectingFirstListItemValue=void 0}}function h(){const S=this.resume(),T=this.stack[this.stack.length-1];T.lang=S}function D(){const S=this.resume(),T=this.stack[this.stack.length-1];T.meta=S}function q(){this.data.flowCodeInside||(this.buffer(),this.data.flowCodeInside=!0)}function Y(){const S=this.resume(),T=this.stack[this.stack.length-1];T.value=S.replace(/^(\r?\n|\r)|(\r?\n|\r)$/g,""),this.data.flowCodeInside=void 0}function O(){const S=this.resume(),T=this.stack[this.stack.length-1];T.value=S.replace(/(\r?\n|\r)$/g,"")}function H(S){const T=this.resume(),P=this.stack[this.stack.length-1];P.label=T,P.identifier=cn(this.sliceSerialize(S)).toLowerCase()}function L(){const S=this.resume(),T=this.stack[this.stack.length-1];T.title=S}function W(){const S=this.resume(),T=this.stack[this.stack.length-1];T.url=S}function F(S){const T=this.stack[this.stack.length-1];if(!T.depth){const P=this.sliceSerialize(S).length;T.depth=P}}function j(){this.data.setextHeadingSlurpLineEnding=!0}function X(S){const T=this.stack[this.stack.length-1];T.depth=this.sliceSerialize(S).codePointAt(0)===61?1:2}function le(){this.data.setextHeadingSlurpLineEnding=void 0}function ne(S){const P=this.stack[this.stack.length-1].children;let te=P[P.length-1];(!te||te.type!=="text")&&(te=fn(),te.position={start:qt(S.start),end:void 0},P.push(te)),this.stack.push(te)}function oe(S){const T=this.stack.pop();T.value+=this.sliceSerialize(S),T.position.end=qt(S.end)}function V(S){const T=this.stack[this.stack.length-1];if(this.data.atHardBreak){const P=T.children[T.children.length-1];P.position.end=qt(S.end),this.data.atHardBreak=void 0;return}!this.data.setextHeadingSlurpLineEnding&&n.canContainEols.includes(T.type)&&(ne.call(this,S),oe.call(this,S))}function k(){this.data.atHardBreak=!0}function C(){const S=this.resume(),T=this.stack[this.stack.length-1];T.value=S}function G(){const S=this.resume(),T=this.stack[this.stack.length-1];T.value=S}function A(){const S=this.resume(),T=this.stack[this.stack.length-1];T.value=S}function M(){const S=this.stack[this.stack.length-1];if(this.data.inReference){const T=this.data.referenceType||"shortcut";S.type+="Reference",S.referenceType=T,delete S.url,delete S.title}else delete S.identifier,delete S.label;this.data.referenceType=void 0}function J(){const S=this.stack[this.stack.length-1];if(this.data.inReference){const T=this.data.referenceType||"shortcut";S.type+="Reference",S.referenceType=T,delete S.url,delete S.title}else delete S.identifier,delete S.label;this.data.referenceType=void 0}function je(S){const T=this.sliceSerialize(S),P=this.stack[this.stack.length-2];P.label=uo(T),P.identifier=cn(T).toLowerCase()}function pe(){const S=this.stack[this.stack.length-1],T=this.resume(),P=this.stack[this.stack.length-1];if(this.data.inReference=!0,P.type==="link"){const te=S.children;P.children=te}else P.alt=T}function x(){const S=this.resume(),T=this.stack[this.stack.length-1];T.url=S}function Oe(){const S=this.resume(),T=this.stack[this.stack.length-1];T.title=S}function Fe(){this.data.inReference=void 0}function b(){this.data.referenceType="collapsed"}function Ne(S){const T=this.resume(),P=this.stack[this.stack.length-1];P.label=T,P.identifier=cn(this.sliceSerialize(S)).toLowerCase(),this.data.referenceType="full"}function Me(S){this.data.characterReferenceType=S.type}function be(S){const T=this.sliceSerialize(S),P=this.data.characterReferenceType;let te;P?(te=eo(T,P==="characterReferenceMarkerNumeric"?10:16),this.data.characterReferenceType=void 0):te=Ri(T);const ce=this.stack[this.stack.length-1];ce.value+=te}function at(S){const T=this.stack.pop();T.position.end=qt(S.end)}function Qe(S){oe.call(this,S);const T=this.stack[this.stack.length-1];T.url=this.sliceSerialize(S)}function Ge(S){oe.call(this,S);const T=this.stack[this.stack.length-1];T.url="mailto:"+this.sliceSerialize(S)}function lt(){return{type:"blockquote",children:[]}}function wt(){return{type:"code",lang:null,meta:null,value:""}}function Yt(){return{type:"inlineCode",value:""}}function v(){return{type:"definition",identifier:"",label:null,title:null,url:""}}function It(){return{type:"emphasis",children:[]}}function ct(){return{type:"heading",depth:0,children:[]}}function kt(){return{type:"break"}}function We(){return{type:"html",value:""}}function Ot(){return{type:"image",title:null,url:"",alt:null}}function _t(){return{type:"link",title:null,url:"",children:[]}}function Nt(S){return{type:"list",ordered:S.type==="listOrdered",start:null,spread:S._spread,children:[]}}function Ue(S){return{type:"listItem",spread:S._spread,checked:null,children:[]}}function vt(){return{type:"paragraph",children:[]}}function mt(){return{type:"strong",children:[]}}function fn(){return{type:"text",value:""}}function Le(){return{type:"thematicBreak"}}}function qt(e){return{line:e.line,column:e.column,offset:e.offset}}function ho(e,n){let t=-1;for(;++t<n.length;){const r=n[t];Array.isArray(r)?ho(e,r):fd(e,r)}}function fd(e,n){let t;for(t in n)if(po.call(n,t))switch(t){case"canContainEols":{const r=n[t];r&&e[t].push(...r);break}case"transforms":{const r=n[t];r&&e[t].push(...r);break}case"enter":case"exit":{const r=n[t];r&&Object.assign(e[t],r);break}}}function fs(e,n){throw e?new Error("Cannot close `"+e.type+"` ("+zn({start:e.start,end:e.end})+"): a different token (`"+n.type+"`, "+zn({start:n.start,end:n.end})+") is open"):new Error("Cannot close document, a token (`"+n.type+"`, "+zn({start:n.start,end:n.end})+") is still open")}function gd(e){const n=this;n.parser=t;function t(r){return hd(r,{...n.data("settings"),...e,extensions:n.data("micromarkExtensions")||[],mdastExtensions:n.data("fromMarkdownExtensions")||[]})}}const gs={}.hasOwnProperty;function mo(e,n){const t=n||{};function r(s,...a){let o=r.invalid;const l=r.handlers;if(s&&gs.call(s,e)){const c=String(s[e]);o=gs.call(l,c)?l[c]:r.unknown}if(o)return o.call(this,s,...a)}return r.handlers=t.handlers||{},r.invalid=t.invalid,r.unknown=t.unknown,r}const yd={}.hasOwnProperty;function fo(e,n){let t=-1,r;if(n.extensions)for(;++t<n.extensions.length;)fo(e,n.extensions[t]);for(r in n)if(yd.call(n,r))switch(r){case"extensions":break;case"unsafe":{ys(e[r],n[r]);break}case"join":{ys(e[r],n[r]);break}case"handlers":{xd(e[r],n[r]);break}default:e.options[r]=n[r]}return e}function ys(e,n){n&&e.push(...n)}function xd(e,n){n&&Object.assign(e,n)}function bd(e,n,t,r){const s=t.enter("blockquote"),a=t.createTracker(r);a.move("> "),a.shift(2);const o=t.indentLines(t.containerFlow(e,a.current()),wd);return s(),o}function wd(e,n,t){return">"+(t?"":" ")+e}function go(e,n){return xs(e,n.inConstruct,!0)&&!xs(e,n.notInConstruct,!1)}function xs(e,n,t){if(typeof n=="string"&&(n=[n]),!n||n.length===0)return t;let r=-1;for(;++r<n.length;)if(e.includes(n[r]))return!0;return!1}function bs(e,n,t,r){let s=-1;for(;++s<t.unsafe.length;)if(t.unsafe[s].character===`
`&&go(t.stack,t.unsafe[s]))return/[ \t]/.test(r.before)?"":" ";return`\\
`}function kd(e,n){const t=String(e);let r=t.indexOf(n),s=r,a=0,o=0;if(typeof n!="string")throw new TypeError("Expected substring");for(;r!==-1;)r===s?++a>o&&(o=a):a=1,s=r+n.length,r=t.indexOf(n,s);return o}function Si(e,n){return!!(n.options.fences===!1&&e.value&&!e.lang&&/[^ \r\n]/.test(e.value)&&!/^[\t ]*(?:[\r\n]|$)|(?:^|[\r\n])[\t ]*$/.test(e.value))}function _d(e){const n=e.options.fence||"`";if(n!=="`"&&n!=="~")throw new Error("Cannot serialize code with `"+n+"` for `options.fence`, expected `` ` `` or `~`");return n}function Nd(e,n,t,r){const s=_d(t),a=e.value||"",o=s==="`"?"GraveAccent":"Tilde";if(Si(e,t)){const d=t.enter("codeIndented"),y=t.indentLines(a,vd);return d(),y}const l=t.createTracker(r),c=s.repeat(Math.max(kd(a,s)+1,3)),u=t.enter("codeFenced");let m=l.move(c);if(e.lang){const d=t.enter(`codeFencedLang${o}`);m+=l.move(t.safe(e.lang,{before:m,after:" ",encode:["`"],...l.current()})),d()}if(e.lang&&e.meta){const d=t.enter(`codeFencedMeta${o}`);m+=l.move(" "),m+=l.move(t.safe(e.meta,{before:m,after:`
`,encode:["`"],...l.current()})),d()}return m+=l.move(`
`),a&&(m+=l.move(a+`
`)),m+=l.move(c),u(),m}function vd(e,n,t){return(t?"":"    ")+e}function qi(e){const n=e.options.quote||'"';if(n!=='"'&&n!=="'")throw new Error("Cannot serialize title with `"+n+"` for `options.quote`, expected `\"`, or `'`");return n}function jd(e,n,t,r){const s=qi(t),a=s==='"'?"Quote":"Apostrophe",o=t.enter("definition");let l=t.enter("label");const c=t.createTracker(r);let u=c.move("[");return u+=c.move(t.safe(t.associationId(e),{before:u,after:"]",...c.current()})),u+=c.move("]: "),l(),!e.url||/[\0- \u007F]/.test(e.url)?(l=t.enter("destinationLiteral"),u+=c.move("<"),u+=c.move(t.safe(e.url,{before:u,after:">",...c.current()})),u+=c.move(">")):(l=t.enter("destinationRaw"),u+=c.move(t.safe(e.url,{before:u,after:e.title?" ":`
`,...c.current()}))),l(),e.title&&(l=t.enter(`title${a}`),u+=c.move(" "+s),u+=c.move(t.safe(e.title,{before:u,after:s,...c.current()})),u+=c.move(s),l()),o(),u}function Cd(e){const n=e.options.emphasis||"*";if(n!=="*"&&n!=="_")throw new Error("Cannot serialize emphasis with `"+n+"` for `options.emphasis`, expected `*`, or `_`");return n}function Ut(e){return"&#x"+e.toString(16).toUpperCase()+";"}function fr(e,n,t){const r=mr(e),s=mr(n);return r===void 0?s===void 0?t==="_"?{inside:!0,outside:!0}:{inside:!1,outside:!1}:s===1?{inside:!0,outside:!0}:{inside:!1,outside:!0}:r===1?s===void 0?{inside:!1,outside:!1}:s===1?{inside:!0,outside:!0}:{inside:!1,outside:!1}:s===void 0?{inside:!1,outside:!1}:s===1?{inside:!0,outside:!1}:{inside:!1,outside:!1}}yo.peek=Sd;function yo(e,n,t,r){const s=Cd(t),a=t.enter("emphasis"),o=t.createTracker(r),l=o.move(s);let c=o.move(t.containerPhrasing(e,{after:s,before:l,...o.current()}));const u=c.charCodeAt(0),m=fr(r.before.charCodeAt(r.before.length-1),u,s);m.inside&&(c=Ut(u)+c.slice(1));const d=c.charCodeAt(c.length-1),y=fr(r.after.charCodeAt(0),d,s);y.inside&&(c=c.slice(0,-1)+Ut(d));const h=o.move(s);return a(),t.attentionEncodeSurroundingInfo={after:y.outside,before:m.outside},l+c+h}function Sd(e,n,t){return t.options.emphasis||"*"}const Bi=function(e){if(e==null)return Ad;if(typeof e=="function")return br(e);if(typeof e=="object")return Array.isArray(e)?Pd(e):Td(e);if(typeof e=="string")return Ed(e);throw new Error("Expected function, string, or object as test")};function Pd(e){const n=[];let t=-1;for(;++t<e.length;)n[t]=Bi(e[t]);return br(r);function r(...s){let a=-1;for(;++a<n.length;)if(n[a].apply(this,s))return!0;return!1}}function Td(e){const n=e;return br(t);function t(r){const s=r;let a;for(a in e)if(s[a]!==n[a])return!1;return!0}}function Ed(e){return br(n);function n(t){return t&&t.type===e}}function br(e){return n;function n(t,r,s){return!!(Dd(t)&&e.call(this,t,typeof r=="number"?r:void 0,s||void 0))}}function Ad(){return!0}function Dd(e){return e!==null&&typeof e=="object"&&"type"in e}const xo=[],Id=!0,Pi=!1,Od="skip";function $d(e,n,t,r){let s;typeof n=="function"&&typeof t!="function"?(r=t,t=n):s=n;const a=Bi(s),o=r?-1:1;l(e,void 0,[])();function l(c,u,m){const d=c&&typeof c=="object"?c:{};if(typeof d.type=="string"){const h=typeof d.tagName=="string"?d.tagName:typeof d.name=="string"?d.name:void 0;Object.defineProperty(y,"name",{value:"node ("+(c.type+(h?"<"+h+">":""))+")"})}return y;function y(){let h=xo,D,q,Y;if((!n||a(c,u,m[m.length-1]||void 0))&&(h=Ld(t(c,m)),h[0]===Pi))return h;if("children"in c&&c.children){const O=c;if(O.children&&h[0]!==Od)for(q=(r?O.children.length:-1)+o,Y=m.concat(O);q>-1&&q<O.children.length;){const H=O.children[q];if(D=l(H,q,Y)(),D[0]===Pi)return D;q=typeof D[1]=="number"?D[1]:q+o}}return h}}}function Ld(e){return Array.isArray(e)?e:typeof e=="number"?[Id,e]:e==null?xo:[e]}function bo(e,n,t,r){let s,a,o;typeof n=="function"?(a=void 0,o=n,s=t):(a=n,o=t,s=r),$d(e,a,l,s);function l(c,u){const m=u[u.length-1],d=m?m.children.indexOf(c):void 0;return o(c,d,m)}}function wo(e,n){let t=!1;return bo(e,function(r){if("value"in r&&/\r?\n|\r/.test(r.value)||r.type==="break")return t=!0,Pi}),!!((!e.depth||e.depth<3)&&Li(e)&&(n.options.setext||t))}function Rd(e,n,t,r){const s=Math.max(Math.min(6,e.depth||1),1),a=t.createTracker(r);if(wo(e,t)){const m=t.enter("headingSetext"),d=t.enter("phrasing"),y=t.containerPhrasing(e,{...a.current(),before:`
`,after:`
`});return d(),m(),y+`
`+(s===1?"=":"-").repeat(y.length-(Math.max(y.lastIndexOf("\r"),y.lastIndexOf(`
`))+1))}const o="#".repeat(s),l=t.enter("headingAtx"),c=t.enter("phrasing");a.move(o+" ");let u=t.containerPhrasing(e,{before:"# ",after:`
`,...a.current()});return/^[\t ]/.test(u)&&(u=Ut(u.charCodeAt(0))+u.slice(1)),u=u?o+" "+u:o,t.options.closeAtx&&(u+=" "+o),c(),l(),u}ko.peek=Fd;function ko(e){return e.value||""}function Fd(){return"<"}_o.peek=zd;function _o(e,n,t,r){const s=qi(t),a=s==='"'?"Quote":"Apostrophe",o=t.enter("image");let l=t.enter("label");const c=t.createTracker(r);let u=c.move("![");return u+=c.move(t.safe(e.alt,{before:u,after:"]",...c.current()})),u+=c.move("]("),l(),!e.url&&e.title||/[\0- \u007F]/.test(e.url)?(l=t.enter("destinationLiteral"),u+=c.move("<"),u+=c.move(t.safe(e.url,{before:u,after:">",...c.current()})),u+=c.move(">")):(l=t.enter("destinationRaw"),u+=c.move(t.safe(e.url,{before:u,after:e.title?" ":")",...c.current()}))),l(),e.title&&(l=t.enter(`title${a}`),u+=c.move(" "+s),u+=c.move(t.safe(e.title,{before:u,after:s,...c.current()})),u+=c.move(s),l()),u+=c.move(")"),o(),u}function zd(){return"!"}No.peek=qd;function No(e,n,t,r){const s=e.referenceType,a=t.enter("imageReference");let o=t.enter("label");const l=t.createTracker(r);let c=l.move("![");const u=t.safe(e.alt,{before:c,after:"]",...l.current()});c+=l.move(u+"]["),o();const m=t.stack;t.stack=[],o=t.enter("reference");const d=t.safe(t.associationId(e),{before:c,after:"]",...l.current()});return o(),t.stack=m,a(),s==="full"||!u||u!==d?c+=l.move(d+"]"):s==="shortcut"?c=c.slice(0,-1):c+=l.move("]"),c}function qd(){return"!"}vo.peek=Bd;function vo(e,n,t){let r=e.value||"",s="`",a=-1;for(;new RegExp("(^|[^`])"+s+"([^`]|$)").test(r);)s+="`";for(/[^ \r\n]/.test(r)&&(/^[ \r\n]/.test(r)&&/[ \r\n]$/.test(r)||/^`|`$/.test(r))&&(r=" "+r+" ");++a<t.unsafe.length;){const o=t.unsafe[a],l=t.compilePattern(o);let c;if(o.atBreak)for(;c=l.exec(r);){let u=c.index;r.charCodeAt(u)===10&&r.charCodeAt(u-1)===13&&u--,r=r.slice(0,u)+" "+r.slice(c.index+1)}}return s+r+s}function Bd(){return"`"}function jo(e,n){const t=Li(e);return!!(!n.options.resourceLink&&e.url&&!e.title&&e.children&&e.children.length===1&&e.children[0].type==="text"&&(t===e.url||"mailto:"+t===e.url)&&/^[a-z][a-z+.-]+:/i.test(e.url)&&!/[\0- <>\u007F]/.test(e.url))}Co.peek=Ud;function Co(e,n,t,r){const s=qi(t),a=s==='"'?"Quote":"Apostrophe",o=t.createTracker(r);let l,c;if(jo(e,t)){const m=t.stack;t.stack=[],l=t.enter("autolink");let d=o.move("<");return d+=o.move(t.containerPhrasing(e,{before:d,after:">",...o.current()})),d+=o.move(">"),l(),t.stack=m,d}l=t.enter("link"),c=t.enter("label");let u=o.move("[");return u+=o.move(t.containerPhrasing(e,{before:u,after:"](",...o.current()})),u+=o.move("]("),c(),!e.url&&e.title||/[\0- \u007F]/.test(e.url)?(c=t.enter("destinationLiteral"),u+=o.move("<"),u+=o.move(t.safe(e.url,{before:u,after:">",...o.current()})),u+=o.move(">")):(c=t.enter("destinationRaw"),u+=o.move(t.safe(e.url,{before:u,after:e.title?" ":")",...o.current()}))),c(),e.title&&(c=t.enter(`title${a}`),u+=o.move(" "+s),u+=o.move(t.safe(e.title,{before:u,after:s,...o.current()})),u+=o.move(s),c()),u+=o.move(")"),l(),u}function Ud(e,n,t){return jo(e,t)?"<":"["}So.peek=Md;function So(e,n,t,r){const s=e.referenceType,a=t.enter("linkReference");let o=t.enter("label");const l=t.createTracker(r);let c=l.move("[");const u=t.containerPhrasing(e,{before:c,after:"]",...l.current()});c+=l.move(u+"]["),o();const m=t.stack;t.stack=[],o=t.enter("reference");const d=t.safe(t.associationId(e),{before:c,after:"]",...l.current()});return o(),t.stack=m,a(),s==="full"||!u||u!==d?c+=l.move(d+"]"):s==="shortcut"?c=c.slice(0,-1):c+=l.move("]"),c}function Md(){return"["}function Ui(e){const n=e.options.bullet||"*";if(n!=="*"&&n!=="+"&&n!=="-")throw new Error("Cannot serialize items with `"+n+"` for `options.bullet`, expected `*`, `+`, or `-`");return n}function Hd(e){const n=Ui(e),t=e.options.bulletOther;if(!t)return n==="*"?"-":"*";if(t!=="*"&&t!=="+"&&t!=="-")throw new Error("Cannot serialize items with `"+t+"` for `options.bulletOther`, expected `*`, `+`, or `-`");if(t===n)throw new Error("Expected `bullet` (`"+n+"`) and `bulletOther` (`"+t+"`) to be different");return t}function Wd(e){const n=e.options.bulletOrdered||".";if(n!=="."&&n!==")")throw new Error("Cannot serialize items with `"+n+"` for `options.bulletOrdered`, expected `.` or `)`");return n}function Po(e){const n=e.options.rule||"*";if(n!=="*"&&n!=="-"&&n!=="_")throw new Error("Cannot serialize rules with `"+n+"` for `options.rule`, expected `*`, `-`, or `_`");return n}function Vd(e,n,t,r){const s=t.enter("list"),a=t.bulletCurrent;let o=e.ordered?Wd(t):Ui(t);const l=e.ordered?o==="."?")":".":Hd(t);let c=n&&t.bulletLastUsed?o===t.bulletLastUsed:!1;if(!e.ordered){const m=e.children?e.children[0]:void 0;if((o==="*"||o==="-")&&m&&(!m.children||!m.children[0])&&t.stack[t.stack.length-1]==="list"&&t.stack[t.stack.length-2]==="listItem"&&t.stack[t.stack.length-3]==="list"&&t.stack[t.stack.length-4]==="listItem"&&t.indexStack[t.indexStack.length-1]===0&&t.indexStack[t.indexStack.length-2]===0&&t.indexStack[t.indexStack.length-3]===0&&(c=!0),Po(t)===o&&m){let d=-1;for(;++d<e.children.length;){const y=e.children[d];if(y&&y.type==="listItem"&&y.children&&y.children[0]&&y.children[0].type==="thematicBreak"){c=!0;break}}}}c&&(o=l),t.bulletCurrent=o;const u=t.containerFlow(e,r);return t.bulletLastUsed=o,t.bulletCurrent=a,s(),u}function Jd(e){const n=e.options.listItemIndent||"one";if(n!=="tab"&&n!=="one"&&n!=="mixed")throw new Error("Cannot serialize items with `"+n+"` for `options.listItemIndent`, expected `tab`, `one`, or `mixed`");return n}function Qd(e,n,t,r){const s=Jd(t);let a=t.bulletCurrent||Ui(t);n&&n.type==="list"&&n.ordered&&(a=(typeof n.start=="number"&&n.start>-1?n.start:1)+(t.options.incrementListMarker===!1?0:n.children.indexOf(e))+a);let o=a.length+1;(s==="tab"||s==="mixed"&&(n&&n.type==="list"&&n.spread||e.spread))&&(o=Math.ceil(o/4)*4);const l=t.createTracker(r);l.move(a+" ".repeat(o-a.length)),l.shift(o);const c=t.enter("listItem"),u=t.indentLines(t.containerFlow(e,l.current()),m);return c(),u;function m(d,y,h){return y?(h?"":" ".repeat(o))+d:(h?a:a+" ".repeat(o-a.length))+d}}function Gd(e,n,t,r){const s=t.enter("paragraph"),a=t.enter("phrasing"),o=t.containerPhrasing(e,r);return a(),s(),o}const Yd=Bi(["break","delete","emphasis","footnote","footnoteReference","image","imageReference","inlineCode","inlineMath","link","linkReference","mdxJsxTextElement","mdxTextExpression","strong","text","textDirective"]);function Kd(e,n,t,r){return(e.children.some(function(o){return Yd(o)})?t.containerPhrasing:t.containerFlow).call(t,e,r)}function Xd(e){const n=e.options.strong||"*";if(n!=="*"&&n!=="_")throw new Error("Cannot serialize strong with `"+n+"` for `options.strong`, expected `*`, or `_`");return n}To.peek=Zd;function To(e,n,t,r){const s=Xd(t),a=t.enter("strong"),o=t.createTracker(r),l=o.move(s+s);let c=o.move(t.containerPhrasing(e,{after:s,before:l,...o.current()}));const u=c.charCodeAt(0),m=fr(r.before.charCodeAt(r.before.length-1),u,s);m.inside&&(c=Ut(u)+c.slice(1));const d=c.charCodeAt(c.length-1),y=fr(r.after.charCodeAt(0),d,s);y.inside&&(c=c.slice(0,-1)+Ut(d));const h=o.move(s+s);return a(),t.attentionEncodeSurroundingInfo={after:y.outside,before:m.outside},l+c+h}function Zd(e,n,t){return t.options.strong||"*"}function ep(e,n,t,r){return t.safe(e.value,r)}function tp(e){const n=e.options.ruleRepetition||3;if(n<3)throw new Error("Cannot serialize rules with repetition `"+n+"` for `options.ruleRepetition`, expected `3` or more");return n}function np(e,n,t){const r=(Po(t)+(t.options.ruleSpaces?" ":"")).repeat(tp(t));return t.options.ruleSpaces?r.slice(0,-1):r}const rp={blockquote:bd,break:bs,code:Nd,definition:jd,emphasis:yo,hardBreak:bs,heading:Rd,html:ko,image:_o,imageReference:No,inlineCode:vo,link:Co,linkReference:So,list:Vd,listItem:Qd,paragraph:Gd,root:Kd,strong:To,text:ep,thematicBreak:np},ip=[ap];function ap(e,n,t,r){if(n.type==="code"&&Si(n,r)&&(e.type==="list"||e.type===n.type&&Si(e,r)))return!1;if("spread"in t&&typeof t.spread=="boolean")return e.type==="paragraph"&&(e.type===n.type||n.type==="definition"||n.type==="heading"&&wo(n,r))?void 0:t.spread?1:0}const Vt=["autolink","destinationLiteral","destinationRaw","reference","titleQuote","titleApostrophe"],sp=[{character:"	",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",before:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"\r",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:`
`,inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:" ",after:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",before:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"!",after:"\\[",inConstruct:"phrasing",notInConstruct:Vt},{character:'"',inConstruct:"titleQuote"},{atBreak:!0,character:"#"},{character:"#",inConstruct:"headingAtx",after:`(?:[\r
]|$)`},{character:"&",after:"[#A-Za-z]",inConstruct:"phrasing"},{character:"'",inConstruct:"titleApostrophe"},{character:"(",inConstruct:"destinationRaw"},{before:"\\]",character:"(",inConstruct:"phrasing",notInConstruct:Vt},{atBreak:!0,before:"\\d+",character:")"},{character:")",inConstruct:"destinationRaw"},{atBreak:!0,character:"*",after:`(?:[ 	\r
*])`},{character:"*",inConstruct:"phrasing",notInConstruct:Vt},{atBreak:!0,character:"+",after:`(?:[ 	\r
])`},{atBreak:!0,character:"-",after:`(?:[ 	\r
-])`},{atBreak:!0,before:"\\d+",character:".",after:`(?:[ 	\r
]|$)`},{atBreak:!0,character:"<",after:"[!/?A-Za-z]"},{character:"<",after:"[!/?A-Za-z]",inConstruct:"phrasing",notInConstruct:Vt},{character:"<",inConstruct:"destinationLiteral"},{atBreak:!0,character:"="},{atBreak:!0,character:">"},{character:">",inConstruct:"destinationLiteral"},{atBreak:!0,character:"["},{character:"[",inConstruct:"phrasing",notInConstruct:Vt},{character:"[",inConstruct:["label","reference"]},{character:"\\",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"]",inConstruct:["label","reference"]},{atBreak:!0,character:"_"},{character:"_",inConstruct:"phrasing",notInConstruct:Vt},{atBreak:!0,character:"`"},{character:"`",inConstruct:["codeFencedLangGraveAccent","codeFencedMetaGraveAccent"]},{character:"`",inConstruct:"phrasing",notInConstruct:Vt},{atBreak:!0,character:"~"}];function op(e){return e.label||!e.identifier?e.label||"":uo(e.identifier)}function lp(e){if(!e._compiled){const n=(e.atBreak?"[\\r\\n][\\t ]*":"")+(e.before?"(?:"+e.before+")":"");e._compiled=new RegExp((n?"("+n+")":"")+(/[|\\{}()[\]^$+*?.-]/.test(e.character)?"\\":"")+e.character+(e.after?"(?:"+e.after+")":""),"g")}return e._compiled}function cp(e,n,t){const r=n.indexStack,s=e.children||[],a=[];let o=-1,l=t.before,c;r.push(-1);let u=n.createTracker(t);for(;++o<s.length;){const m=s[o];let d;if(r[r.length-1]=o,o+1<s.length){let D=n.handle.handlers[s[o+1].type];D&&D.peek&&(D=D.peek),d=D?D(s[o+1],e,n,{before:"",after:"",...u.current()}).charAt(0):""}else d=t.after;a.length>0&&(l==="\r"||l===`
`)&&m.type==="html"&&(a[a.length-1]=a[a.length-1].replace(/(\r?\n|\r)$/," "),l=" ",u=n.createTracker(t),u.move(a.join("")));let y=n.handle(m,e,n,{...u.current(),after:d,before:l});c&&c===y.slice(0,1)&&(y=Ut(c.charCodeAt(0))+y.slice(1));const h=n.attentionEncodeSurroundingInfo;n.attentionEncodeSurroundingInfo=void 0,c=void 0,h&&(a.length>0&&h.before&&l===a[a.length-1].slice(-1)&&(a[a.length-1]=a[a.length-1].slice(0,-1)+Ut(l.charCodeAt(0))),h.after&&(c=d)),u.move(y),a.push(y),l=y.slice(-1)}return r.pop(),a.join("")}function up(e,n,t){const r=n.indexStack,s=e.children||[],a=n.createTracker(t),o=[];let l=-1;for(r.push(-1);++l<s.length;){const c=s[l];r[r.length-1]=l,o.push(a.move(n.handle(c,e,n,{before:`
`,after:`
`,...a.current()}))),c.type!=="list"&&(n.bulletLastUsed=void 0),l<s.length-1&&o.push(a.move(dp(c,s[l+1],e,n)))}return r.pop(),o.join("")}function dp(e,n,t,r){let s=r.join.length;for(;s--;){const a=r.join[s](e,n,t,r);if(a===!0||a===1)break;if(typeof a=="number")return`
`.repeat(1+a);if(a===!1)return`

<!---->

`}return`

`}const pp=/\r?\n|\r/g;function hp(e,n){const t=[];let r=0,s=0,a;for(;a=pp.exec(e);)o(e.slice(r,a.index)),t.push(a[0]),r=a.index+a[0].length,s++;return o(e.slice(r)),t.join("");function o(l){t.push(n(l,s,!l))}}function mp(e,n,t){const r=(t.before||"")+(n||"")+(t.after||""),s=[],a=[],o={};let l=-1;for(;++l<e.unsafe.length;){const m=e.unsafe[l];if(!go(e.stack,m))continue;const d=e.compilePattern(m);let y;for(;y=d.exec(r);){const h="before"in m||!!m.atBreak,D="after"in m,q=y.index+(h?y[1].length:0);s.includes(q)?(o[q].before&&!h&&(o[q].before=!1),o[q].after&&!D&&(o[q].after=!1)):(s.push(q),o[q]={before:h,after:D})}}s.sort(fp);let c=t.before?t.before.length:0;const u=r.length-(t.after?t.after.length:0);for(l=-1;++l<s.length;){const m=s[l];m<c||m>=u||m+1<u&&s[l+1]===m+1&&o[m].after&&!o[m+1].before&&!o[m+1].after||s[l-1]===m-1&&o[m].before&&!o[m-1].before&&!o[m-1].after||(c!==m&&a.push(ws(r.slice(c,m),"\\")),c=m,/[!-/:-@[-`{-~]/.test(r.charAt(m))&&(!t.encode||!t.encode.includes(r.charAt(m)))?a.push("\\"):(a.push(Ut(r.charCodeAt(m))),c++))}return a.push(ws(r.slice(c,u),t.after)),a.join("")}function fp(e,n){return e-n}function ws(e,n){const t=/\\(?=[!-/:-@[-`{-~])/g,r=[],s=[],a=e+n;let o=-1,l=0,c;for(;c=t.exec(a);)r.push(c.index);for(;++o<r.length;)l!==r[o]&&s.push(e.slice(l,r[o])),s.push("\\"),l=r[o];return s.push(e.slice(l)),s.join("")}function gp(e){const n=e||{},t=n.now||{};let r=n.lineShift||0,s=t.line||1,a=t.column||1;return{move:c,current:o,shift:l};function o(){return{now:{line:s,column:a},lineShift:r}}function l(u){r+=u}function c(u){const m=u||"",d=m.split(/\r?\n|\r/g),y=d[d.length-1];return s+=d.length-1,a=d.length===1?a+y.length:1+y.length+r,m}}function yp(e,n){const t=n||{},r={associationId:op,containerPhrasing:kp,containerFlow:_p,createTracker:gp,compilePattern:lp,enter:a,handlers:{...rp},handle:void 0,indentLines:hp,indexStack:[],join:[...ip],options:{},safe:Np,stack:[],unsafe:[...sp]};fo(r,t),r.options.tightDefinitions&&r.join.push(wp),r.handle=mo("type",{invalid:xp,unknown:bp,handlers:r.handlers});let s=r.handle(e,void 0,r,{before:`
`,after:`
`,now:{line:1,column:1},lineShift:0});return s&&s.charCodeAt(s.length-1)!==10&&s.charCodeAt(s.length-1)!==13&&(s+=`
`),s;function a(o){return r.stack.push(o),l;function l(){r.stack.pop()}}}function xp(e){throw new Error("Cannot handle value `"+e+"`, expected node")}function bp(e){const n=e;throw new Error("Cannot handle unknown node `"+n.type+"`")}function wp(e,n){if(e.type==="definition"&&e.type===n.type)return 0}function kp(e,n){return cp(e,this,n)}function _p(e,n){return up(e,this,n)}function Np(e,n){return mp(this,e,n)}function vp(e){const n=this;n.compiler=t;function t(r){return yp(r,{...n.data("settings"),...e,extensions:n.data("toMarkdownExtensions")||[]})}}function ks(e){if(e)throw e}var ai,_s;function jp(){if(_s)return ai;_s=1;var e=Object.prototype.hasOwnProperty,n=Object.prototype.toString,t=Object.defineProperty,r=Object.getOwnPropertyDescriptor,s=function(u){return typeof Array.isArray=="function"?Array.isArray(u):n.call(u)==="[object Array]"},a=function(u){if(!u||n.call(u)!=="[object Object]")return!1;var m=e.call(u,"constructor"),d=u.constructor&&u.constructor.prototype&&e.call(u.constructor.prototype,"isPrototypeOf");if(u.constructor&&!m&&!d)return!1;var y;for(y in u);return typeof y>"u"||e.call(u,y)},o=function(u,m){t&&m.name==="__proto__"?t(u,m.name,{enumerable:!0,configurable:!0,value:m.newValue,writable:!0}):u[m.name]=m.newValue},l=function(u,m){if(m==="__proto__")if(e.call(u,m)){if(r)return r(u,m).value}else return;return u[m]};return ai=function c(){var u,m,d,y,h,D,q=arguments[0],Y=1,O=arguments.length,H=!1;for(typeof q=="boolean"&&(H=q,q=arguments[1]||{},Y=2),(q==null||typeof q!="object"&&typeof q!="function")&&(q={});Y<O;++Y)if(u=arguments[Y],u!=null)for(m in u)d=l(q,m),y=l(u,m),q!==y&&(H&&y&&(a(y)||(h=s(y)))?(h?(h=!1,D=d&&s(d)?d:[]):D=d&&a(d)?d:{},o(q,{name:m,newValue:c(H,D,y)})):typeof y<"u"&&o(q,{name:m,newValue:y}));return q},ai}var Cp=jp();const si=Xl(Cp);function Ti(e){if(typeof e!="object"||e===null)return!1;const n=Object.getPrototypeOf(e);return(n===null||n===Object.prototype||Object.getPrototypeOf(n)===null)&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)}function Sp(){const e=[],n={run:t,use:r};return n;function t(...s){let a=-1;const o=s.pop();if(typeof o!="function")throw new TypeError("Expected function as last argument, not "+o);l(null,...s);function l(c,...u){const m=e[++a];let d=-1;if(c){o(c);return}for(;++d<s.length;)(u[d]===null||u[d]===void 0)&&(u[d]=s[d]);s=u,m?Pp(m,l)(...u):o(null,...u)}}function r(s){if(typeof s!="function")throw new TypeError("Expected `middelware` to be a function, not "+s);return e.push(s),n}}function Pp(e,n){let t;return r;function r(...o){const l=e.length>o.length;let c;l&&o.push(s);try{c=e.apply(this,o)}catch(u){const m=u;if(l&&t)throw m;return s(m)}l||(c&&c.then&&typeof c.then=="function"?c.then(a,s):c instanceof Error?s(c):a(c))}function s(o,...l){t||(t=!0,n(o,...l))}function a(o){s(null,o)}}class Ze extends Error{constructor(n,t,r){super(),typeof t=="string"&&(r=t,t=void 0);let s="",a={},o=!1;if(t&&("line"in t&&"column"in t?a={place:t}:"start"in t&&"end"in t?a={place:t}:"type"in t?a={ancestors:[t],place:t.position}:a={...t}),typeof n=="string"?s=n:!a.cause&&n&&(o=!0,s=n.message,a.cause=n),!a.ruleId&&!a.source&&typeof r=="string"){const c=r.indexOf(":");c===-1?a.ruleId=r:(a.source=r.slice(0,c),a.ruleId=r.slice(c+1))}if(!a.place&&a.ancestors&&a.ancestors){const c=a.ancestors[a.ancestors.length-1];c&&(a.place=c.position)}const l=a.place&&"start"in a.place?a.place.start:a.place;this.ancestors=a.ancestors||void 0,this.cause=a.cause||void 0,this.column=l?l.column:void 0,this.fatal=void 0,this.file="",this.message=s,this.line=l?l.line:void 0,this.name=zn(a.place)||"1:1",this.place=a.place||void 0,this.reason=this.message,this.ruleId=a.ruleId||void 0,this.source=a.source||void 0,this.stack=o&&a.cause&&typeof a.cause.stack=="string"?a.cause.stack:"",this.actual=void 0,this.expected=void 0,this.note=void 0,this.url=void 0}}Ze.prototype.file="";Ze.prototype.name="";Ze.prototype.reason="";Ze.prototype.message="";Ze.prototype.stack="";Ze.prototype.column=void 0;Ze.prototype.line=void 0;Ze.prototype.ancestors=void 0;Ze.prototype.cause=void 0;Ze.prototype.fatal=void 0;Ze.prototype.place=void 0;Ze.prototype.ruleId=void 0;Ze.prototype.source=void 0;const yt={basename:Tp,dirname:Ep,extname:Ap,join:Dp,sep:"/"};function Tp(e,n){if(n!==void 0&&typeof n!="string")throw new TypeError('"ext" argument must be a string');Un(e);let t=0,r=-1,s=e.length,a;if(n===void 0||n.length===0||n.length>e.length){for(;s--;)if(e.codePointAt(s)===47){if(a){t=s+1;break}}else r<0&&(a=!0,r=s+1);return r<0?"":e.slice(t,r)}if(n===e)return"";let o=-1,l=n.length-1;for(;s--;)if(e.codePointAt(s)===47){if(a){t=s+1;break}}else o<0&&(a=!0,o=s+1),l>-1&&(e.codePointAt(s)===n.codePointAt(l--)?l<0&&(r=s):(l=-1,r=o));return t===r?r=o:r<0&&(r=e.length),e.slice(t,r)}function Ep(e){if(Un(e),e.length===0)return".";let n=-1,t=e.length,r;for(;--t;)if(e.codePointAt(t)===47){if(r){n=t;break}}else r||(r=!0);return n<0?e.codePointAt(0)===47?"/":".":n===1&&e.codePointAt(0)===47?"//":e.slice(0,n)}function Ap(e){Un(e);let n=e.length,t=-1,r=0,s=-1,a=0,o;for(;n--;){const l=e.codePointAt(n);if(l===47){if(o){r=n+1;break}continue}t<0&&(o=!0,t=n+1),l===46?s<0?s=n:a!==1&&(a=1):s>-1&&(a=-1)}return s<0||t<0||a===0||a===1&&s===t-1&&s===r+1?"":e.slice(s,t)}function Dp(...e){let n=-1,t;for(;++n<e.length;)Un(e[n]),e[n]&&(t=t===void 0?e[n]:t+"/"+e[n]);return t===void 0?".":Ip(t)}function Ip(e){Un(e);const n=e.codePointAt(0)===47;let t=Op(e,!n);return t.length===0&&!n&&(t="."),t.length>0&&e.codePointAt(e.length-1)===47&&(t+="/"),n?"/"+t:t}function Op(e,n){let t="",r=0,s=-1,a=0,o=-1,l,c;for(;++o<=e.length;){if(o<e.length)l=e.codePointAt(o);else{if(l===47)break;l=47}if(l===47){if(!(s===o-1||a===1))if(s!==o-1&&a===2){if(t.length<2||r!==2||t.codePointAt(t.length-1)!==46||t.codePointAt(t.length-2)!==46){if(t.length>2){if(c=t.lastIndexOf("/"),c!==t.length-1){c<0?(t="",r=0):(t=t.slice(0,c),r=t.length-1-t.lastIndexOf("/")),s=o,a=0;continue}}else if(t.length>0){t="",r=0,s=o,a=0;continue}}n&&(t=t.length>0?t+"/..":"..",r=2)}else t.length>0?t+="/"+e.slice(s+1,o):t=e.slice(s+1,o),r=o-s-1;s=o,a=0}else l===46&&a>-1?a++:a=-1}return t}function Un(e){if(typeof e!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}const $p={cwd:Lp};function Lp(){return"/"}function Ei(e){return!!(e!==null&&typeof e=="object"&&"href"in e&&e.href&&"protocol"in e&&e.protocol&&e.auth===void 0)}function Rp(e){if(typeof e=="string")e=new URL(e);else if(!Ei(e)){const n=new TypeError('The "path" argument must be of type string or an instance of URL. Received `'+e+"`");throw n.code="ERR_INVALID_ARG_TYPE",n}if(e.protocol!=="file:"){const n=new TypeError("The URL must be of scheme file");throw n.code="ERR_INVALID_URL_SCHEME",n}return Fp(e)}function Fp(e){if(e.hostname!==""){const r=new TypeError('File URL host must be "localhost" or empty on darwin');throw r.code="ERR_INVALID_FILE_URL_HOST",r}const n=e.pathname;let t=-1;for(;++t<n.length;)if(n.codePointAt(t)===37&&n.codePointAt(t+1)===50){const r=n.codePointAt(t+2);if(r===70||r===102){const s=new TypeError("File URL path must not include encoded / characters");throw s.code="ERR_INVALID_FILE_URL_PATH",s}}return decodeURIComponent(n)}const oi=["history","path","basename","stem","extname","dirname"];class zp{constructor(n){let t;n?Ei(n)?t={path:n}:typeof n=="string"||qp(n)?t={value:n}:t=n:t={},this.cwd="cwd"in t?"":$p.cwd(),this.data={},this.history=[],this.messages=[],this.value,this.map,this.result,this.stored;let r=-1;for(;++r<oi.length;){const a=oi[r];a in t&&t[a]!==void 0&&t[a]!==null&&(this[a]=a==="history"?[...t[a]]:t[a])}let s;for(s in t)oi.includes(s)||(this[s]=t[s])}get basename(){return typeof this.path=="string"?yt.basename(this.path):void 0}set basename(n){ci(n,"basename"),li(n,"basename"),this.path=yt.join(this.dirname||"",n)}get dirname(){return typeof this.path=="string"?yt.dirname(this.path):void 0}set dirname(n){Ns(this.basename,"dirname"),this.path=yt.join(n||"",this.basename)}get extname(){return typeof this.path=="string"?yt.extname(this.path):void 0}set extname(n){if(li(n,"extname"),Ns(this.dirname,"extname"),n){if(n.codePointAt(0)!==46)throw new Error("`extname` must start with `.`");if(n.includes(".",1))throw new Error("`extname` cannot contain multiple dots")}this.path=yt.join(this.dirname,this.stem+(n||""))}get path(){return this.history[this.history.length-1]}set path(n){Ei(n)&&(n=Rp(n)),ci(n,"path"),this.path!==n&&this.history.push(n)}get stem(){return typeof this.path=="string"?yt.basename(this.path,this.extname):void 0}set stem(n){ci(n,"stem"),li(n,"stem"),this.path=yt.join(this.dirname||"",n+(this.extname||""))}fail(n,t,r){const s=this.message(n,t,r);throw s.fatal=!0,s}info(n,t,r){const s=this.message(n,t,r);return s.fatal=void 0,s}message(n,t,r){const s=new Ze(n,t,r);return this.path&&(s.name=this.path+":"+s.name,s.file=this.path),s.fatal=!1,this.messages.push(s),s}toString(n){return this.value===void 0?"":typeof this.value=="string"?this.value:new TextDecoder(n||void 0).decode(this.value)}}function li(e,n){if(e&&e.includes(yt.sep))throw new Error("`"+n+"` cannot be a path: did not expect `"+yt.sep+"`")}function ci(e,n){if(!e)throw new Error("`"+n+"` cannot be empty")}function Ns(e,n){if(!e)throw new Error("Setting `"+n+"` requires `path` to be set too")}function qp(e){return!!(e&&typeof e=="object"&&"byteLength"in e&&"byteOffset"in e)}const Bp=function(e){const r=this.constructor.prototype,s=r[e],a=function(){return s.apply(a,arguments)};return Object.setPrototypeOf(a,r),a},Up={}.hasOwnProperty;class Mi extends Bp{constructor(){super("copy"),this.Compiler=void 0,this.Parser=void 0,this.attachers=[],this.compiler=void 0,this.freezeIndex=-1,this.frozen=void 0,this.namespace={},this.parser=void 0,this.transformers=Sp()}copy(){const n=new Mi;let t=-1;for(;++t<this.attachers.length;){const r=this.attachers[t];n.use(...r)}return n.data(si(!0,{},this.namespace)),n}data(n,t){return typeof n=="string"?arguments.length===2?(pi("data",this.frozen),this.namespace[n]=t,this):Up.call(this.namespace,n)&&this.namespace[n]||void 0:n?(pi("data",this.frozen),this.namespace=n,this):this.namespace}freeze(){if(this.frozen)return this;const n=this;for(;++this.freezeIndex<this.attachers.length;){const[t,...r]=this.attachers[this.freezeIndex];if(r[0]===!1)continue;r[0]===!0&&(r[0]=void 0);const s=t.call(n,...r);typeof s=="function"&&this.transformers.use(s)}return this.frozen=!0,this.freezeIndex=Number.POSITIVE_INFINITY,this}parse(n){this.freeze();const t=or(n),r=this.parser||this.Parser;return ui("parse",r),r(String(t),t)}process(n,t){const r=this;return this.freeze(),ui("process",this.parser||this.Parser),di("process",this.compiler||this.Compiler),t?s(void 0,t):new Promise(s);function s(a,o){const l=or(n),c=r.parse(l);r.run(c,l,function(m,d,y){if(m||!d||!y)return u(m);const h=d,D=r.stringify(h,y);Wp(D)?y.value=D:y.result=D,u(m,y)});function u(m,d){m||!d?o(m):a?a(d):t(void 0,d)}}}processSync(n){let t=!1,r;return this.freeze(),ui("processSync",this.parser||this.Parser),di("processSync",this.compiler||this.Compiler),this.process(n,s),js("processSync","process",t),r;function s(a,o){t=!0,ks(a),r=o}}run(n,t,r){vs(n),this.freeze();const s=this.transformers;return!r&&typeof t=="function"&&(r=t,t=void 0),r?a(void 0,r):new Promise(a);function a(o,l){const c=or(t);s.run(n,c,u);function u(m,d,y){const h=d||n;m?l(m):o?o(h):r(void 0,h,y)}}}runSync(n,t){let r=!1,s;return this.run(n,t,a),js("runSync","run",r),s;function a(o,l){ks(o),s=l,r=!0}}stringify(n,t){this.freeze();const r=or(t),s=this.compiler||this.Compiler;return di("stringify",s),vs(n),s(n,r)}use(n,...t){const r=this.attachers,s=this.namespace;if(pi("use",this.frozen),n!=null)if(typeof n=="function")c(n,t);else if(typeof n=="object")Array.isArray(n)?l(n):o(n);else throw new TypeError("Expected usable value, not `"+n+"`");return this;function a(u){if(typeof u=="function")c(u,[]);else if(typeof u=="object")if(Array.isArray(u)){const[m,...d]=u;c(m,d)}else o(u);else throw new TypeError("Expected usable value, not `"+u+"`")}function o(u){if(!("plugins"in u)&&!("settings"in u))throw new Error("Expected usable value but received an empty preset, which is probably a mistake: presets typically come with `plugins` and sometimes with `settings`, but this has neither");l(u.plugins),u.settings&&(s.settings=si(!0,s.settings,u.settings))}function l(u){let m=-1;if(u!=null)if(Array.isArray(u))for(;++m<u.length;){const d=u[m];a(d)}else throw new TypeError("Expected a list of plugins, not `"+u+"`")}function c(u,m){let d=-1,y=-1;for(;++d<r.length;)if(r[d][0]===u){y=d;break}if(y===-1)r.push([u,...m]);else if(m.length>0){let[h,...D]=m;const q=r[y][1];Ti(q)&&Ti(h)&&(h=si(!0,q,h)),r[y]=[u,h,...D]}}}}const Mp=new Mi().freeze();function ui(e,n){if(typeof n!="function")throw new TypeError("Cannot `"+e+"` without `parser`")}function di(e,n){if(typeof n!="function")throw new TypeError("Cannot `"+e+"` without `compiler`")}function pi(e,n){if(n)throw new Error("Cannot call `"+e+"` on a frozen processor.\nCreate a new processor first, by calling it: use `processor()` instead of `processor`.")}function vs(e){if(!Ti(e)||typeof e.type!="string")throw new TypeError("Expected node, got `"+e+"`")}function js(e,n,t){if(!t)throw new Error("`"+e+"` finished async. Use `"+n+"` instead")}function or(e){return Hp(e)?e:new zp(e)}function Hp(e){return!!(e&&typeof e=="object"&&"message"in e&&"messages"in e)}function Wp(e){return typeof e=="string"||Vp(e)}function Vp(e){return!!(e&&typeof e=="object"&&"byteLength"in e&&"byteOffset"in e)}const hi=Mp().use(gd).use(vp).freeze(),Jp=e=>{if(!e)return"Unknown Date";try{return new Date(e).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}catch{return"Invalid Date"}},Qp=e=>{switch(e){case"pending":return{text:"Billing Pending",className:"status-badge status-pending"};case"billed":return{text:"Sample Pending",className:"status-badge status-billed"};case"collected":return{text:"Sample Collected",className:"status-badge status-collected"};case"processing":return{text:"Processing",className:"status-badge status-processing"};case"report_ready":return{text:"Report Ready",className:"status-badge status-report_ready"};case"reported":return{text:"Reported",className:"status-badge status-reported"};case"completed":return{text:"Completed",className:"status-badge status-completed"};case"cancelled":return{text:"Cancelled",className:"status-badge status-cancelled"};default:return{text:e,className:"status-badge"}}},Gp=({title:e,items:n,renderItemContent:t,headerAction:r,isLoading:s,loadingText:a,noDataText:o,onDeleteItem:l,onEditLabOrder:c,onSaveLabOrder:u,onCancelEditLabOrder:m,onLabOrderTestChange:d,onLabOrderStatusChange:y,onEditPharmacyOrder:h,onPrintUnavailablePrescription:D,onBillLabOrder:q,onUpdateLabOrderStatus:Y,onEnterLabReport:O,labInventory:H=[],isSavingLabOrder:L=!1,expandedLabReports:W={},toggleLabReport:F=()=>{},selectionEnabled:j=!1,selectedIds:X=new Set,onSelectionChange:le})=>{const ne=w.useMemo(()=>{const V={};n.forEach(C=>{if(isNaN(C.date.getTime())){V["Unknown Date"]||(V["Unknown Date"]=[]),V["Unknown Date"].push(C);return}const G=Jp(C.originalDateString);V[G]||(V[G]=[]),V[G].push(C)});const k=Object.keys(V);return k.sort((C,G)=>{if(C==="Unknown Date")return 1;if(G==="Unknown Date")return-1;try{const A=new Date(C.split(" ").reverse().join(" ")),M=new Date(G.split(" ").reverse().join(" "));if(!isNaN(A.getTime())&&!isNaN(M.getTime()))return M.getTime()-A.getTime()}catch{}return G.localeCompare(C)}),k.map(C=>({date:C,items:V[C]}))},[n]),oe=["pending","billed","collected","processing","report_ready","completed","cancelled","reported"];return i.jsxs("div",{className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsx("h4",{className:"ai-context-section-title mb-2 pb-1",children:e}),r]}),s&&i.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(V=>i.jsxs("div",{style:{padding:"10px",background:"var(--glass-light)",borderRadius:"8px",marginBottom:"8px"},children:[i.jsx(Ce,{width:"80px",height:"14px",style:{marginBottom:"10px"}}),i.jsx(Ce,{width:"100%",height:"16px",style:{marginBottom:"6px"}}),i.jsx(Ce,{width:"70%",height:"14px"})]},V))}),!s&&n.length===0&&i.jsx("p",{className:"ai-context-text italic",children:o}),!s&&n.length>0&&i.jsx("div",{className:"space-y-3",children:ne.map(({date:V,items:k})=>i.jsxs("div",{children:[i.jsx("h5",{className:"grouped-history-date",children:V}),i.jsx("div",{className:"space-y-1 grouped-history-item-container",children:k.map((C,G)=>i.jsxs("div",{className:"grouped-history-item ai-context-item flex flex-col",children:[!(C.type==="Lab Order"&&C.data.isEditing)&&i.jsxs("div",{className:"flex justify-between items-center w-full",children:[j&&le&&C.type==="Pharmacy Order"&&i.jsx("div",{className:"mr-2",children:i.jsx("input",{type:"checkbox",checked:X.has(C.data.id),onChange:A=>le(C.data.id,A.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),i.jsx("div",{className:"flex-grow mr-2 ai-context-text",children:t(C,G,W,F)}),i.jsxs("div",{className:"flex items-center space-x-1",children:[C.type==="Lab Order"&&!C.data.isEditing&&c&&i.jsx("button",{onClick:()=>c(C.data.id),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400",title:"Edit this lab order",disabled:L,children:i.jsx(pt,{size:14})}),C.type==="Lab Order"&&C.data.isEditing&&i.jsx(i.Fragment,{}),C.type==="Lab Order"&&i.jsxs("div",{className:"lab-table-actions",children:[C.data.status==="pending"&&q&&(()=>{const A=C.data.tests.reduce((M,J)=>M+(Number(J.price)||0),0).toFixed(2);return i.jsx("button",{onClick:()=>q(C.data),className:"text-green-600 hover:text-green-800 p-1 rounded hover:bg-green-100 focus:outline-none focus:ring-1 focus:ring-green-400",title:`Pay total of ₹${A}`,disabled:L,children:i.jsx(Vs,{size:14})})})(),C.data.status==="billed"&&Y&&i.jsx("button",{onClick:()=>Y(C.data.id,"collected"),className:"lab-action-button btn-collect",title:"Collect Sample",children:"Collect"}),C.data.status==="collected"&&Y&&i.jsx("button",{onClick:()=>Y(C.data.id,"processing"),className:"lab-action-button btn-process",title:"Mark Processing",children:"Process"}),["pending","billed","collected","processing","report_ready","reported","completed"].includes(C.data.status)&&O&&i.jsx("button",{onClick:()=>O(C.data),className:"lab-action-button btn-enter-report",title:"Enter Report",children:"Enter Report"}),(C.data.status==="report_ready"||C.data.status==="reported")&&Y&&i.jsx("button",{onClick:()=>Y(C.data.id,"completed"),className:"lab-action-button btn-complete",title:"Mark Completed",children:"Complete"})]}),C.type==="Pharmacy Order"&&C.data.status==="pending"&&h&&i.jsx("button",{onClick:()=>h(C.data.id),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400",title:"Edit this pharmacy order",disabled:L,children:i.jsx(pt,{size:14})}),C.type==="Pharmacy Order"&&C.data.prescriptionForUnavailableDrugs&&D&&i.jsx("button",{onClick:()=>D(C.data.prescriptionForUnavailableDrugs,`Prescription for Order ${C.data.id}`),className:"text-purple-600 hover:text-purple-800 p-1 rounded hover:bg-purple-100 focus:outline-none focus:ring-1 focus:ring-purple-400",title:"Print Prescription for Unavailable Drugs",disabled:L,children:i.jsx(ln,{size:14})}),C.type==="Pharmacy Order"&&C.data.status==="pending"&&l&&i.jsx("button",{onClick:()=>l({type:C.type,data:C.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400",title:"Delete this pending pharmacy order",disabled:L,children:i.jsx(ht,{size:14})}),l&&["Complaint","Lab Order","Lab Report"].includes(C.type)&&i.jsx("button",{onClick:()=>l({type:C.type,data:C.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400",title:`Delete this ${C.type.toLowerCase()}`,disabled:L,children:i.jsx(ht,{size:14})})]})]}),C.type==="Lab Order"&&C.data.isEditing&&i.jsxs("div",{className:"lab-order-edit-form w-full bg-gray-50 border rounded-md p-3",children:[i.jsxs("div",{className:"flex justify-between items-center mb-3",children:[i.jsx("h6",{className:"text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Edit Order"}),i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Status:"}),i.jsx("select",{value:C.data.editedStatus||C.data.status,onChange:A=>y&&y(C.data.id,A.target.value),className:"form-select text-xs py-1 pl-2 pr-6 rounded border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50",disabled:L,children:oe.map(A=>i.jsx("option",{value:A,children:A.replace(/_/g," ")},A))})]})]}),i.jsx("div",{className:"overflow-hidden border rounded-md bg-white mb-3",children:i.jsxs("table",{className:"w-full text-xs text-left",children:[i.jsx("thead",{className:"bg-gray-100 border-b",children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-2 px-3 font-medium text-gray-600",children:"Test Name"}),i.jsx("th",{className:"py-2 px-3 text-right font-medium text-gray-600 w-20",children:"Price"}),i.jsx("th",{className:"py-2 px-3 w-10"})]})}),i.jsxs("tbody",{className:"divide-y divide-gray-100",children:[C.data.editedTests.map((A,M)=>i.jsxs("tr",{className:"hover:bg-gray-50",children:[i.jsx("td",{className:"py-1 px-3",children:i.jsxs("select",{value:A.id,onChange:J=>{const je=H.find(pe=>String(pe.id)===J.target.value);je&&(d&&d(C.data.id,M,"id",je.id),d&&d(C.data.id,M,"name",je.name),d&&d(C.data.id,M,"price",je.price))},className:"form-select w-full text-xs border-0 bg-transparent focus:ring-0 p-0",disabled:L,children:[i.jsx("option",{value:"",children:"Select Test"}),H.map(J=>i.jsx("option",{value:J.id,children:J.name},J.id))]})}),i.jsxs("td",{className:"py-1 px-3 text-right text-gray-700",children:["₹",A.price]}),i.jsx("td",{className:"py-1 px-3 text-center",children:i.jsx("button",{onClick:()=>{const J=C.data.editedTests.filter((je,pe)=>pe!==M);d&&d(C.data.id,-1,"remove",J)},className:"text-red-400 hover:text-red-600 focus:outline-none",title:"Remove test",disabled:L,children:i.jsx(ht,{size:12})})})]},M)),C.data.editedTests.length===0&&i.jsx("tr",{children:i.jsx("td",{colSpan:3,className:"py-2 px-3 text-center italic text-gray-400",children:"No tests selected"})})]}),i.jsx("tfoot",{className:"bg-gray-50 border-t",children:i.jsx("tr",{children:i.jsx("td",{colSpan:3,className:"py-1 px-3",children:i.jsx("button",{onClick:()=>{d&&d(C.data.id,-1,"add",{id:"",name:"",price:0})},className:"text-blue-600 hover:text-blue-800 text-xs font-medium flex items-center py-1",disabled:L,children:"+ Add Test"})})})})]})}),i.jsxs("div",{className:"flex justify-end space-x-2 border-t border-gray-200 pt-3 mt-1",children:[i.jsx("button",{onClick:()=>m&&m(C.data.id),className:"px-3 py-1.5 rounded text-xs text-gray-600 hover:bg-white hover:text-gray-800 border border-transparent hover:border-gray-200 transition-colors",disabled:L,children:"Cancel"}),i.jsx("button",{onClick:()=>u&&u(C.data.id,C.data.editedTests,C.data.editedStatus),className:"px-3 py-1.5 rounded text-xs bg-blue-600 text-white hover:bg-blue-700 shadow-sm flex items-center space-x-1 transition-colors",disabled:L,children:L?i.jsx("span",{children:"Saving..."}):i.jsxs(i.Fragment,{children:[i.jsx(Js,{size:12}),i.jsx("span",{children:"Save Changes"})]})})]})]})]},`${C.type}-${C.originalDateString}-${G}`))})]},V))})]})},mi=_i.memo(Gp),Yp="_modalOverlay_eh310_3",Kp="_modalContent_eh310_29",Xp="_modalHeader_eh310_61",Zp="_modalTitle_eh310_79",eh="_modalCloseButton_eh310_91",th="_modalBody_eh310_119",nh="_errorText_eh310_137",rh="_formGroup_eh310_155",ih="_inputField_eh310_179",ah="_searchResultsCard_eh310_221",sh="_searchResultsList_eh310_249",oh="_searchResultItem_eh310_261",lh="_searchResultPrice_eh310_297",ch="_selectedTestsCard_eh310_307",uh="_selectedTestsHeader_eh310_327",dh="_noTestsMessage_eh310_343",ph="_selectedTestsList_eh310_359",hh="_selectedTestItem_eh310_371",mh="_selectedTestName_eh310_395",fh="_selectedTestPrice_eh310_407",gh="_removeTestButton_eh310_419",yh="_totalAmount_eh310_445",xh="_modalFooter_eh310_463",bh="_button_eh310_489",wh="_buttonPrimary_eh310_507",kh="_buttonSecondary_eh310_529",se={modalOverlay:Yp,modalContent:Kp,modalHeader:Xp,modalTitle:Zp,modalCloseButton:eh,modalBody:th,errorText:nh,formGroup:rh,inputField:ih,searchResultsCard:ah,searchResultsList:sh,searchResultItem:oh,searchResultPrice:lh,selectedTestsCard:ch,selectedTestsHeader:uh,noTestsMessage:dh,selectedTestsList:ph,selectedTestItem:hh,selectedTestName:mh,selectedTestPrice:fh,removeTestButton:gh,totalAmount:yh,modalFooter:xh,button:bh,buttonPrimary:wh,buttonSecondary:kh},_h=({isOpen:e,onClose:n,patientId:t,labInventory:r,fetchPendingLabOrdersData:s,isLoadingInventory:a=!1})=>{const[o,l]=w.useState([]),[c,u]=w.useState(""),[m,d]=w.useState([]),[y,h]=w.useState(null),[D,q]=w.useState(!1);Ks(void 0,e?200:99999);const Y=w.useMemo(()=>new Hs(r,{keys:["name","description"],threshold:.3}),[r]);w.useEffect(()=>{if(!c){d([]);return}const W=Y.search(c).map(F=>F.item);d(W.slice(0,10))},[c,Y]);const O=async()=>{if(!t){h("Patient ID is missing.");return}if(o.length===0){h("Please select at least one lab test.");return}q(!0),h(null);try{const W={patient_id:t,tests:o.map(j=>({id:j.id,name:j.name,price:j.price}))},F=await K("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(W)});if(!F.ok){const j=await F.json().catch(()=>({}));throw new Error(j.message||`Failed to create lab order: ${F.statusText}`)}await F.json(),s(t),n(),l([]),u("")}catch(W){h(`Lab Order Creation Error: ${W.message}`)}finally{q(!1)}},H=W=>{if(o.some(F=>F.id===W.id)){h(`${W.name} is already in the order.`),setTimeout(()=>h(null),3e3),u(""),d([]);return}l(F=>[...F,{...W}]),u(""),d([])},L=W=>{l(F=>F.filter(j=>j.id!==W))};return e?i.jsx("div",{className:se.modalOverlay,children:i.jsxs("div",{className:se.modalContent,children:[i.jsxs("div",{className:se.modalHeader,children:[i.jsx("h3",{className:se.modalTitle,children:"Create New Lab Order"}),i.jsx("button",{onClick:n,className:se.modalCloseButton,children:i.jsx(pn,{size:20})})]}),i.jsxs("div",{className:se.modalBody,children:[y&&i.jsx("div",{className:se.errorText,children:y}),i.jsxs("div",{className:se.formGroup,style:{position:"relative"},children:[i.jsx("label",{htmlFor:"lab-test-search",children:"Add Lab Test"}),i.jsx("input",{type:"text",id:"lab-test-search",placeholder:"Search available lab tests...",value:c,onChange:W=>u(W.target.value),className:se.inputField}),c&&i.jsx("div",{className:se.searchResultsCard,children:a?i.jsx("div",{className:"p-2 space-y-2",children:[1,2,3].map(W=>i.jsxs("div",{className:"flex justify-between items-center py-2 px-3",children:[i.jsx(Ce,{width:"60%",height:20}),i.jsx(Ce,{width:"20%",height:20})]},W))}):m.length>0?i.jsx("ul",{className:se.searchResultsList,children:m.map(W=>i.jsxs("li",{onClick:()=>H(W),className:se.searchResultItem,children:[i.jsx("span",{children:W.name}),i.jsxs("span",{className:se.searchResultPrice,children:["(₹",parseFloat(String(W.price)).toFixed(2),")"]})]},W.id))}):i.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No tests found."})})]}),i.jsxs("div",{className:se.selectedTestsCard,children:[i.jsx("h4",{className:se.selectedTestsHeader,children:"Selected Tests"}),o.length===0?i.jsx("p",{className:se.noTestsMessage,children:"No tests added yet."}):i.jsx("ul",{className:se.selectedTestsList,children:o.map(W=>i.jsxs("li",{className:se.selectedTestItem,children:[i.jsx("span",{className:se.selectedTestName,children:W.name}),i.jsxs("span",{className:se.selectedTestPrice,children:["₹",parseFloat(String(W.price)).toFixed(2)]}),i.jsx("button",{type:"button",onClick:()=>L(String(W.id)),className:se.removeTestButton,title:"Remove Test",children:i.jsx(ht,{size:16})})]},W.id))})]}),o.length>0&&i.jsxs("div",{className:se.totalAmount,children:["Total: ₹",o.reduce((W,F)=>W+parseFloat(String(F.price)),0).toFixed(2)]})]}),i.jsxs("div",{className:se.modalFooter,children:[i.jsx("button",{type:"button",onClick:n,className:`${se.button} ${se.buttonSecondary}`,children:" Cancel "}),i.jsxs("button",{type:"button",onClick:O,disabled:o.length===0||D,className:`${se.button} ${se.buttonPrimary} ${o.length===0||D?se.buttonDisabled:""}`,children:[" ",D?"Saving...":"Create Lab Order"," "]})]})]})}):null},Nh=`You are an expert OPD (Outpatient Department) medical assistant for a Doctor in a clinic in India. You will receive all the medical data of the patient including complaints (history), labs, pharmacy orders, etc., along with their date and time. Your primary goal is to assist the doctor and analyze patient chief complaints (Co), provide a structured clinical assessment including lab test suggestions (Lx), differential diagnoses (Dx), and a treatment plan (Tx). You have access to tools (actions) to order lab tests and pharmacy items, and update patient details.



**1. Definitions:**
   - Co: Chief complaints
   - Pt: Patient (assume living in India)
   - Lx: Laboratory tests
   - Dx: Differential Diagnosis
   - Tx: Treatment Plan

**2. Workflow:**
   - Analyze Co, generate Lx, Dx, and Tx sections as described below.
   - **Prioritization for Orders:** Always prioritize using \`edit_pharmacy_order\` or \`edit_lab_order\` if there are existing pending orders for the patient, before considering \`create_pharmacy_order\` or \`create_lab_order\`.
   - using edit_lab_order edits the lab order with the given serial numnber use to add new tests to the existing order or remove the tests from existing order, marking the status affects all tests in the order not only the test,always use this tool if there are pending lab orders instead of creating new orders.
   - using edit_pharmacy_order edits the pharmacy order with the given serial numnber to add new items to the existing order, update existing items, or remove items (either by \`items_to_remove\` or by setting \`quantity\` to 0). Always use this tool if there are pending pharmacy orders instead of creating new orders.
   - using bill_lab_order will navigate the user to the billing page for the specific lab order. Use this when the user expresses intent to bill a lab order.
   - using create_and_bill_lab_order will create a new lab order and immediately bill it (navigating to the print/bill screen). Use this when the user says "create and bill", "order and bill", or similar for NEW tests.
   - using bill_pharmacy_order will bill an existing pharmacy order (identified by serial number).
   - using create_and_bill_pharmacy_order will create a new pharmacy order and immediately bill it. Use this when the user says "prescribe and bill", "order and bill meds", etc.
   - If your Lx section suggests tests from the inventory, use the \`create_lab_order\` action, but only for tests that are both clinically required and have not already been ordered or are still pending. Skip tests that are already ordered and in pending.
   - If your Tx section prescribes medications, use the \`create_pharmacy_order\` action — but only for medications that are clinically required and have not already been prescribed or are still pending. Skip medications that are already dispensed or already ordered.
   - If your Tx section prescribes medications that are *not* available in the inventory, use the \`prescription_for_unavailable_drugs\` parameter within the \`create_pharmacy_order\` action to specify the prescription details. **IMPORTANT:** This string MUST be a **Markdown table** with columns: 'Drug Name', 'Quantity', 'Dosage', 'Directions'. Do not use plain text.
   - When ordering pharmacy items, specify both \`pack_quantity\` (number of full packs) and \`loose_quantity\` (number of individual units). The system will handle the conversion based on the drug's pack size.
   - **Patient Details Management:** Always store or update patient name, age, sex, and phone number using the \`update_patient_details\` action. If patient name, age, or sex is received as 'New Patient - Direct Entry', 'N/A', or blank, treat it as missing data; if the user input provides anything resembling a name, age, or sex (e.g., shiva 25m, robin 50m, priya 19f), update them using the \`update_patient_details\` action. If details are missing, you can ask the user for the missing details using the \`ask_followup_question\` action.
   - Always update new complaints of the patient using the \`add_complaint_history\` action.
   - If you generate a concise summary of the patient's current situation based on the interaction and history, use the \`update_case_summary\` action to save it.
   - Remember, when you use \`update_case_summary\`, the previous case summary will be replaced by the new one, so you can use it like a short-term memory to store other stuff that **keeps changing**, like the current treatment plan, plan of action, active problems, or current vitals, etc.
   - When you use \`add_complaint_history\`, it will add the complaint to the previous ones. You will be given all the previous complaints back in every query, so you can use it to store other long-term facts that do **not change**, like the history of a chronic illness, surgical history, allergies, or social history, etc.
   - while placing or editing a pharmacy order make sure to set the \`pack_quantity\` and \`loose_quantity\` right.
   - Use the \`update_clinic_ai_memory\` action to store or update **various types of clinic-wide persistent information in a concise way**. This can include 'summaries of common patient encounters'+'summeries of previous **Clinic-wide AI Memory**'(e.g., 'Patient X, 50m, chronic gastritis, last visit YYYY-MM-DD, prescribed Z, follow-up in N days'+'**Clinic-wide AI Memory** summary'), notes on local health trends, common diagnostic patterns observed in the clinic, specific operational protocols. This memory is shared across all interactions for the clinic and helps tailor responses to its specific context over time.
    -   **Recurring Medications:**
        -   Use \`create_recurring_medication_order\` to add a new recurring medication.
        -   Use \`edit_recurring_medication_order\` to edit an existing recurring medication (using its serial number).
        -   Recurring medications are long-term prescriptions (e.g., for chronic conditions) that automatically re-order or remind.
    -   **Important: Preventing Loops** If you determine that no further actions are needed (e.g., you have already performed necessary actions, or the user's input does not require any specific action), you **MUST** use the \`end_task\` action. This explicitly signals that your task is complete and prevents the system from re-prompting you unnecessarily.
**3.**Multiple Actions:** You can perform multiple actions (like ordering labs AND meds, adding complaints, updating patient information, and asking a follow-up question) in a single response by including multiple action objects within the main JSON array.


**4. Chief Complaints (Co):**
   - Analyze the provided chief complaints.
   - Present them in a table with two columns: 'Relevant Complaint (Score 8-10)' and 'Irrelevant Complaint (Score 0-7)', based on clinical relevance.

**5. Lab Tests (Lx):**
   - Suggest the most probable basic lab tests based on the clinical picture, ordered by likelihood.
   - If a basic test is positive/abnormal, suggest relevant advanced tests.
   - **Inventory Check:** Compare suggested tests against the provided inventory list.
   - **Table 1: Available Lab Tests:** Present tests *available* in the inventory in a table with columns: '**Clinical Importance (High/Medium/Low)**', 'Lab Test'. If suggesting tests from this table, prepare to use the \`create_lab_order\` tool in your response.
   - **Table 2: Unavailable Lab Tests:** Present tests *not available* in the inventory in a separate table with columns: '**Clinical Importance (High/Medium/Low)**', 'Unavailable Basic Test'. Clearly state these are not orderable via the tool (generate Table 2 only when required tests are unavailable).

**6. Differential Diagnosis (Dx):**
   - List potential differential diagnoses.
   - Provide a confidence score (0-10) for each.
   - Present in a table with columns: 'Differential Diagnosis' and 'Confidence Score (0-10)'.

**7. Treatment Plan (Tx):**
   - Create a structured treatment plan including ideal medications based on the diagnosis.
   - **Inventory Check:** Compare prescribed medications against the provided inventory list.
   - **Table 1: Available Medications:** Present medications *available* in the inventory in a table with columns: 'Time Frame' (from and to dates), 'Treatment Goal', 'Intervention', 'Medication Type', 'Drug Form', 'Drug Name', 'Regimen (Dose, Freq)', 'Duration'. Before using the \`create_pharmacy_order\` tool, check if an order for the same drug has already been placed for this patient today. If an order already exists for today, do *not* create a duplicate order. If no order exists for today, prepare to use the \`create_pharmacy_order\` tool in your response.
   - **Table 2: Unavailable Medications:** Present medications *not available* in the inventory in a separate table with columns: 'Unavailable Drug Name', 'Ideal Regimen', 'Reasoning/Indication', '**Clinical Importance (High/Medium/Low)**', 'Suggested Available Substitute (from inventory, if possible)'. Clearly state these are not orderable via the tool (generate Table 2 only when required medications are unavailable in the inventory).

**8. Tools / Actions:**
   When you need to perform actions like ordering tests/meds, updating patient info, or adding history, use the following JSON array format. The response should ONLY contain this JSON array, nothing else.

   ****STRICT JSON****>>>>>>\`\`\`json
[
  { "action": "create_pharmacy_order", "items": [ { "name": "Drug Name", "pack_quantity": number, "loose_quantity": number, "tabletsPerDay": number | null, "numberOfDays": number | null, "directions_to_use": "string | null" } ], "prescription_for_unavailable_drugs": "string | null" },
  { "action": "edit_pharmacy_order", "serialNumber": number, "items": [ { "name": "Drug Name", "pack_quantity": number, "loose_quantity": number, "tabletsPerDay": number | null, "numberOfDays": number | null, "directions_to_use": "string | null" } ], "items_to_remove": [ { "drug_id": number | null, "name": "Drug Name" } ], "status": "pending" | "billed" | "dispensed" | "cancelled", "prescription_for_unavailable_drugs": "string | null" },
  { "action": "bill_pharmacy_order", "serialNumber": number },
  { "action": "create_and_bill_pharmacy_order", "items": [ { "name": "Drug Name", "pack_quantity": number, "loose_quantity": number, "tabletsPerDay": number | null, "numberOfDays": number | null, "directions_to_use": "string | null" } ], "prescription_for_unavailable_drugs": "string | null" },
  { "action": "create_lab_order", "tests": [ { "name": "Test Name" } ] },
  { "action": "edit_lab_order", "serialNumber": number, "tests": [ { "name": "Test Name" } ], "items_to_remove": [ { "id": number | string | null, "name": "Test Name" } ], "status": "pending" | "billed" | "collected" | "processing" | "report_ready" | "completed" | "cancelled" | "reported" },
  { "action": "create_lab_report", "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "edit_lab_report", "serialNumber": number, "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "create_lab_report", "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "edit_lab_report", "serialNumber": number, "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "edit_lab_order_and_create_report", "serialNumber": number, "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ], "items_to_remove": [ { "id": number | string | null, "name": "Test Name" } ] },
  { "action": "create_and_bill_lab_order", "tests": [ { "name": "Test Name" } ] },
  { "action": "add_complaint_history", "complaint": "Specific past complaint text..." },
  { "action": "update_patient_details", "name": "New Name (optional)", "age": number (optional), "gender": "M" | "F" | "O" | null (optional), "phone_number": "string (optional)" },
  { "action": "update_case_summary", "summary": "Concise summary text..." },
  { "action": "update_clinic_ai_memory", "memory_content": "New clinic-wide AI memory content..." },
  { "action": "create_recurring_medication_order", "items": [ { "medication_name": "Drug Name", "drug_id": "string | null", "quantity": number, "frequency_days": number, "next_delivery_date": "YYYY-MM-DD", "tablets_per_day": number | null, "number_of_days": number | null, "directions": "string | null", "notes": "string | null" } ] },
  { "action": "edit_recurring_medication_order", "serialNumber": number, "updates": { "medication_name": "string (opt)", "quantity": number, "frequency_days": number, "status": "active" | "paused" | "stopped", "next_delivery_date": "YYYY-MM-DD", "number_of_days": number, "tablets_per_day": number, "directions": "string" } },
  { "action": "end_task" }
]
\`\`\`

   - **Multiple Actions in One Response:** You can include multiple action objects within this single JSON array if several actions are required based on your analysis (e.g., adding history AND ordering labs).
   - **Prioritization Within the Array:** If including multiple actions, order them within the array according to this priority:
     1. \`add_complaint_history\`
     2. \`update_patient_details\`
     3. \`update_case_summary\`
     4. \`update_clinic_ai_memory\`
     5. \`create_lab_order\`
     6. \`edit_lab_order\`
     7. \`create_pharmacy_order\`
     8. \`edit_pharmacy_order\`
     9. \`bill_lab_order\`
   - **Structure:**
     The AI response can be a flat array of actions OR a list of "function call" objects containing grouped actions.
     **Option 1: Flat Array (Simple)**
     \`\`\`json
     [
       { "action": "add_complaint_history", ... },
       { "action": "create_lab_order", ... }
     ]
     \`\`\`
     **Option 2: Grouped Function Calls (Complex)**
     You can group actions under logical "function calls" if needed.
     \`\`\`json
     [
       {
         "function_call": "assess_patient",
         "actions": [
           { "action": "ask_followup_question", "question": "..." }
         ]
       },
       {
         "function_call": "prescribe_treatment",
         "actions": [
            { "action": "create_pharmacy_order", "items": [...] },
            { "action": "create_lab_order", "tests": [...] }
         ]
       }
     ]
     \`\`\`

   - **Example (Multiple Actions):**
     \`\`\`json
     [
       { "action": "add_complaint_history", "complaint": "Patient also reports mild fever since yesterday." },
       { "action": "create_lab_order", "tests": [ { "name": "CBC" } ] }
     ]
     \`\`\`

   - **\`ask_followup_question\`**: Use this action (either standalone or inside a group) only when you need clarification.
     \`\`\`json
     {
       "action": "ask_followup_question",
       "question": "Your clear, specific question here.",
       "options": ["Optional Answer 1", "Optional Answer 2"]
     }
     \`\`\`
     *Description:* Ask the user a question to gather additional information needed to complete the task. This tool should be used when you encounter ambiguities, need clarification, or require more details to proceed effectively. It allows for interactive problem-solving by enabling direct communication with the user. Use this tool judiciously to maintain a balance between gathering necessary information and avoiding excessive back-and-forth.
     *Parameters:*
       - question: (required) The question to ask the user. This should be a clear, specific question that addresses the information you need.
       - options: (optional) An array of 2-5 options for the user to choose from. Each option should be a string describing a possible answer. You may not always need to provide options, but it may be helpful in many cases where it can save the user from having to type out a response manually.
   - **\`bill_lab_order\`**: Use this action when the intention is to proceed to billing for a specific lab order.
     \`\`\`json
     { "action": "bill_lab_order", "serialNumber": number }
     \`\`\`
     *Description:* Initiates the billing process for a specific lab order, helping the user navigate to the billing screen.
     *Parameters:*
       - serialNumber: (required) The serial number of the lab order to bill.


**Important:**
- Ensure all tables are clearly formatted using Markdown.
- Strictly adhere to the inventory constraints for labs and medications when deciding whether to use \`create_lab_order\` or \`create_pharmacy_order\`.
- When using actions, provide ONLY the JSON array (or the single JSON object for \`ask_followup_question\`) as the *very last* part of your response, after all other content including tables. Do not include any other text after the JSON.

**Plan Mode:**
When the user asks a question about a patient's condition or general medical topics (not entering new medical data), respond in PLAN MODE. In this mode, focus on answering the user's inquiry, clarifying their request, brainstorming ideas, or architecting a solution (like exploring treatment options). Ask clarifying questions if needed. Present detailed plans or explanations **using clear table formats and markdown (like bolding) for easy readability**. Engage in back-and-back discussion to finalize details. Do not use action tools (\`create_lab_order\`, \`create_pharmacy_order\`, \`add_complaint_history\`, \`update_patient_details\`) while in PLAN MODE).`,Cs="AIzaSyBEt7v-LxBxAKwpTCtkI-3IshYxdnEqbes",vh="models/gemini-3-flash-preview";async function jh(){if(!Jl())return console.warn("No auth token found, using default Gemini API key."),Cs;let n=null;try{const t=await K("/api/clinics/settings");if(t.ok){const r=await t.json();r.gemini_api_key&&r.gemini_api_key.trim()!==""&&(n=r.gemini_api_key.trim())}}catch(t){console.warn("Could not fetch clinic settings (or key missing), proceeding to global fallback.",t)}if(n)return n;try{const t=await K("/api/global-settings/app_gemini_api_key");if(t.ok){const s=(await t.json()).value;if(s&&s.trim()!=="")return s.trim()}}catch(t){console.warn("Could not fetch global API key.",t)}return console.warn("Clinic-specific and global Gemini API keys not found, using default env var."),Cs}let fi=null;async function Ch(){if(!fi){const e=await jh();fi=new dc({apiKey:e})}return fi}async function Sh(e,n){const{query:t,currentDateTime:r,patientName:s,patientAge:a,patientGender:o,case_summary:l,case_summary_last_updated:c,clinic_ai_memory:u,clinic_ai_memory_last_updated:m,clinic_wide_system_prompt:d,labHistory:y,pharmacyOrders:h,pastComplaints:D,pharmacyInventory:q,labInventory:Y,recurringMedications:O}=e;let H=`Patient Complaint: ${t}`;if(l&&(H+=`

--- Case Summary (Provided by Doctor) ---
${l}`,c))try{const k=new Date(c).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"});H+=`
(Last Updated: ${k})`}catch{console.warn(`Could not format case_summary_last_updated: ${c}`),H+=`
(Last Updated: ${c})`}if(s&&(H+=`

Patient Name: ${s}`),a!=null&&(H+=`
Patient Age: ${a}`),o&&(H+=`
Patient Gender: ${o}`),r)try{const k=new Date(r).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"});H+=`

Current Interaction Time: ${k}`}catch{console.warn(`Could not format currentDateTime: ${r}`),H+=`

Current Interaction Time: ${r}`}if(u&&(H+=`

--- Clinic-wide AI Memory/Context ---
${u}`,m))try{const k=new Date(m).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"});H+=`
(Last Updated: ${k})`}catch{console.warn(`Could not format clinic_ai_memory_last_updated: ${m}`),H+=`
(Last Updated: ${m})`}let L="";y&&Array.isArray(y)&&y.length>0&&(L=`

--- Lab History (Orders & Reports) ---
`,y.forEach(k=>{let C="Unknown Date";try{C=new Date(k.orderDate).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date for lab order: ${k.orderDate}`)}if(L+=`
Order #${k.serialNumber} Date: ${C} (Status: ${k.status})
`,L+=`Tests: ${k.tests.map(G=>G.name).join(", ")}
`,k.report){let G="Unknown Date";try{G=new Date(k.report.reportDate).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date for lab report: ${k.report.reportDate}`)}L+=`  -> Report Date: ${G}
`,k.report.tests&&Array.isArray(k.report.tests)?(L+=`     Findings:
`,k.report.tests.forEach(A=>{L+=`       - Test: ${A.testName}
`,A.parameters&&Array.isArray(A.parameters)&&A.parameters.forEach(M=>{L+=`         - ${M.name}: ${M.value} (Normal: ${M.normal_range})
`})})):(L+=`     Findings: ${k.report.reportContent||"N/A"}
`,k.report.error&&(L+=`     Note: ${k.report.error}
`))}L+=`---
`}),H+=L);let W="";h&&Array.isArray(h)&&h.length>0&&(W=`

--- Recent Pharmacy Orders ---
`,h.forEach(k=>{let C="Unknown Date/Time";try{C=new Date(k.date).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date/time for pharmacy order: ${k.date}`)}W+=`
Order #${k.serialNumber} Date/Time: ${C} (Status: ${k.status})
`,W+=`Prescribed By: ${k.prescribedBy||"N/A"}
`,k.dispensedBy&&(W+=`Dispensed By: ${k.dispensedBy}
`),W+=`Medications:
`,k.medications.forEach(G=>{W+=`  - ${G.name} (Qty: ${G.quantity}`,G.tabletsPerDay&&(W+=`, ${G.tabletsPerDay}/day`),G.numberOfDays&&(W+=` for ${G.numberOfDays} days`),W+=`)
`}),k.prescriptionForUnavailableDrugs&&(W+=`  Prescription for Unavailable Drugs: ${k.prescriptionForUnavailableDrugs}
`),W+=`---
`}),H+=W);let F="";O&&Array.isArray(O)&&O.length>0&&(F=`

--- Recurring Medications (Active) ---
`,O.forEach((k,C)=>{let G=`${C+1}. ${k.medicationName} (${k.frequencyDays} days)`;if(k.tabletsPerDay&&(G+=` - ${k.tabletsPerDay} tabs/day`),k.numberOfDays&&(G+=` for ${k.numberOfDays} days`),G+=` [Status: ${k.status}]`,k.nextDeliveryDate)try{const A=new Date(k.nextDeliveryDate).toLocaleDateString();G+=` (Next: ${A})`}catch{}F+=`${G}
`}),H+=F);let j="";D&&Array.isArray(D)&&D.length>0&&(j=`

--- Past Complaints History ---
`,D.forEach(k=>{let C="Unknown Date/Time";try{C=new Date(k.createdAt).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date/time for past complaint: ${k.createdAt}`)}j+=`
Date/Time: ${C}
Complaint: ${k.complaint||"N/A"}
---
`}),H+=j);let X="";q&&Array.isArray(q)&&q.length>0&&(X=`

--- Current Pharmacy Inventory (Stock Levels) ---
`,q.forEach(k=>{let C=`${k.stock??0} packs`;k.loose!==void 0&&k.loose!==null&&k.loose>0&&(C+=`, ${k.loose} loose`);let G=`- ${k.name} (Pack: ${k.pack??"N/A"}): ${C}`;const A=[];k.brand_name&&A.push(`Brand: ${k.brand_name}`),k.batch&&A.push(`Batch: ${k.batch}`),k.expiry_date&&A.push(`Exp: ${k.expiry_date}`),A.length>0&&(G+=` [${A.join(", ")}]`),X+=`${G}
`}),H+=X);let le="";Y&&Array.isArray(Y)&&Y.length>0&&(le=`

--- Available Lab Tests (with Parameters) ---
`,Y.forEach(k=>{le+=`- ${k.name} (Price: ${k.price??"N/A"})
`,k.default_parameters&&Array.isArray(k.default_parameters)&&k.default_parameters.length>0&&k.default_parameters.forEach(C=>{let G=`    * ${C.name}`;C.unit&&(G+=` (${C.unit})`),C.normal_range?G+=` [Normal: ${C.normal_range}]`:C.lower_limit!==void 0&&C.upper_limit!==void 0&&C.lower_limit!==null&&C.upper_limit!==null&&(G+=` [Normal: ${C.lower_limit} - ${C.upper_limit}]`),le+=`${G}
`})}),H+=le);const ne=[{text:Nh}];d&&d.trim()!==""&&ne.push({text:`--- Additional Clinic-Specific Instructions ---
${d}`});const oe=[{text:H}];if(n){const k=new FileReader,C=await new Promise((G,A)=>{k.onloadend=()=>{typeof k.result=="string"?G(k.result.split(",")[1]):A(new Error("Failed to read image file as base64."))},k.onerror=A,k.readAsDataURL(n)});oe.push({inlineData:{mimeType:n.type,data:C}})}const V=[];ne.length>0&&V.push({role:"user",parts:ne}),V.push({role:"user",parts:oe});try{const k={model:vh,contents:V,generationConfig:{temperature:.7,maxOutputTokens:1024,responseMimeType:"text/plain"}},G=await(await Ch()).models.generateContentStream(k);let A="";for await(const M of G)if(M&&typeof M.text=="function"){const J=M.text;J&&(A+=J)}else M&&M.candidates&&M.candidates[0]&&M.candidates[0].content&&M.candidates[0].content.parts&&M.candidates[0].content.parts[0]&&M.candidates[0].content.parts[0].text&&(A+=M.candidates[0].content.parts[0].text);if(A&&A.trim()!=="")return A.trim();throw console.error("Empty or invalid response received from Gemini API stream."),new Error("Failed to get suggestion from AI (Gemini). Empty or invalid stream response.")}catch(k){console.error("Error calling Gemini API:",k);let C="Failed to get suggestion from Gemini.";throw k.message&&(C=`Error processing Gemini request: ${k.message}`),new Error(C)}}const gi=e=>{if(!e)return 1;const n=e.match(/(?:\d+x)?(\d+)(?:s|tabs)?/i);return n?parseInt(n[1],10):1},Ph=w.forwardRef(({recordId:e,patientId:n,patientDetails:t,caseSummary:r,caseSummaryUpdatedAt:s,clinicSettings:a,userMessages:o,selectedImageFile:l,pendingLabOrders:c,labReports:u,pastComplaints:m,pharmacyOrders:d,pharmacyInventory:y,labInventory:h,recurringMedications:D,currentComplaint:q,setCurrentComplaint:Y,setAiResponse:O,setAiResponseText:H,setAiResponseJsonString:L,setShowAiJsonDetails:W,setIsLoadingAi:F,setAiError:j,setIsSubmittingAiOrder:X,setAiOrderSubmissionStatus:le,setIsSubmittingAiLabOrder:ne,setAiLabOrderSubmissionStatus:oe,setIsSubmittingAiComplaint:V,setAiComplaintSubmissionStatus:k,setIsUpdatingCaseSummary:C,setAiCaseSummaryUpdateStatus:G,setCaseSummary:A,setIsUpdatingAiMemoryByAI:M,setAiMemoryUpdateByAIStatus:J,setFollowUpQuestion:je,setFollowUpOptions:pe,setError:x,setIsSavingAiResponse:Oe,setSaveAiResponseError:Fe,fetchPharmacyOrdersData:b,fetchPendingLabOrdersData:Ne,fetchLabReportsData:Me,fetchRecurringMedicationsData:be,fetchPastComplaintsData:at,fetchPatientDetails:Qe,setClinicSettings:Ge,setEditedAiMemory:lt,setCanUndo:wt,onAiActionSuccess:Yt,addMessage:v,onPrintLabBill:It,onPrintPharmacyBill:ct},kt)=>{const[We,Ot]=_i.useState(null);_i.useEffect(()=>{wt(!!We)},[We,wt]);let _t;const Nt=async(Le,S,T,P=0)=>{let te;const $e=["AI response did not contain a recognized function call","AI response did not result in a recognized or performed function call"].some(He=>{var ke;return(ke=S.message)==null?void 0:ke.includes(He)});T&&$e?te=`AI Error: ${S.message}

${T}`:(te=`I encountered a frontend error while trying to execute the '${Le}' function. The error message is: "${S.message}". Based on this error, please analyze what went wrong and either correct the function call and try again, or explain the problem.`,(Le==="create_pharmacy_order"||Le==="edit_pharmacy_order")&&(te+=`

IMPORTANT: When ordering medication, please first check if the medication ordered matches the exact name given in the inventory. If the name itself is not given in the inventory, you can use 'prescription_for_unavailable_drugs' to write a prescription. **NOTE:** This field MUST be formatted as a Markdown table (columns: Drug Name, Quantity, Dosage, Directions).`),T&&(te+=`

The original AI response that caused the error was:
\`\`\`
${T}
\`\`\``)),v==null||v({role:"system",type:"error",content:`AI Error: ${S.message}. Retrying...`}),await _t(te,P+1)},Ue=async Le=>{console.log("Executing Rollback for actions:",Le);for(const S of Le){const{actionType:T,undoData:P}=S;if(console.log(`Attempting to rollback ${T}`,P),!P){console.warn(`No undoData found for action ${T}, skipping.`);continue}try{if(T==="create_pharmacy_order")P!=null&&P.orderId?(console.log(`Deleting pharmacy order ${P.orderId}`),await K(`/api/pharmacy-orders/${P.orderId}`,{method:"DELETE"}),b(n)):console.error("Missing orderId for create_pharmacy_order rollback");else if(T==="create_lab_order")P!=null&&P.orderId?(console.log(`Deleting lab order ${P.orderId}`),await K(`/api/lab/orders/${P.orderId}`,{method:"DELETE"}),Ne(n)):console.error("Missing orderId for create_lab_order rollback");else if(T==="update_patient_details")if(P!=null&&P.patientId&&(P!=null&&P.originalDetails)){console.log(`Reverting patient details for ${P.patientId}`);const te=P.originalDetails,ce={name:te.name,age:te.age,gender:te.gender,phone:te.phone,ai_response:te.ai_response};await K(`/api/patients/${P.patientId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ce)}),Qe(P.patientId)}else console.error("Missing patientId or originalDetails for update_patient_details rollback");else if(T==="add_complaint_history")P!=null&&P.recordId?(console.log(`Reverting complaint history for ${P.recordId}`),await K(`/api/queue/doctor/complaint/${P.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:P.originalComplaint||""})}),Y(P.originalComplaint||"")):console.error("Missing recordId for add_complaint_history rollback");else if(T==="update_case_summary")P!=null&&P.recordId?(console.log(`Reverting case summary for ${P.recordId}`),await K(`/api/queue/doctor/complaint/${P.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({case_summary:P.originalSummary||""})}),A(P.originalSummary||"")):console.error("Missing recordId for update_case_summary rollback");else if(T==="update_clinic_ai_memory")(P==null?void 0:P.originalMemory)!==void 0?(console.log("Reverting AI memory"),await K("/api/clinics/settings",{method:"PUT",body:JSON.stringify({...a,aiMemory:P.originalMemory})}),lt(P.originalMemory)):console.error("Missing originalMemory for update_clinic_ai_memory rollback");else if(T==="edit_pharmacy_order")if(P!=null&&P.orderId&&(P!=null&&P.originalState)){console.log(`Reverting pharmacy order ${P.orderId}`);const te={items:P.originalState.medications||[],status:P.originalState.status,prescription_for_unavailable_drugs:P.originalState.prescription_for_unavailable_drugs,order_total:P.originalState.order_total};await K(`/api/pharmacy-orders/${P.orderId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(te)}),b(n)}else console.error("Missing orderId or originalState for edit_pharmacy_order rollback");else if(T==="edit_lab_order")if(P!=null&&P.orderId&&(P!=null&&P.originalState)){console.log(`Reverting lab order ${P.orderId}`);const te={tests:P.originalState.tests,status:P.originalState.status};await K(`/api/lab/orders/${P.orderId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(te)}),Ne(n)}else console.error("Missing orderId or originalState for edit_lab_order rollback");else if(T==="create_recurring_medication_order")if(P!=null&&P.createdIds&&P.createdIds.length>0){console.log(`Deleting recurring medications: ${P.createdIds.join(", ")}`);for(const te of P.createdIds)await K(`/api/recurring-medications/${te}`,{method:"DELETE"});n&&be&&be(n)}else console.error("Missing createdIds for create_recurring_medication_order rollback");else T==="edit_recurring_medication_order"?P!=null&&P.medicationId&&(P!=null&&P.originalState)?(console.log(`Reverting recurring medication ${P.medicationId}`),await K(`/api/recurring-medications/${P.medicationId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(P.originalState)}),n&&be&&be(n)):console.error("Missing medicationId or originalState for edit_recurring_medication_order rollback"):console.warn(`Unknown action type for rollback: ${T}`)}catch(te){console.error(`Failed to rollback ${T}:`,te)}}},vt=async()=>{!We||!window.confirm("Are you sure you want to undo the last AI actions?")||(F(!0),await Ue([...We].reverse()),Ot(null),F(!1),j("Last actions undone successfully."))},mt=async(Le,S)=>{Ot(null),le(null),oe(null),k(null),G(null),J(null),je(null),pe([]),x(null);let T=null;const P=/```json\s*([\s\S]*?)\s*```/,te=Le.match(P);if(te&&te[1])T=te[1];else{const ce=Le.trim();if(ce.startsWith("{")&&ce.endsWith("}"))T=ce;else if(ce.startsWith("[")&&ce.endsWith("]"))T=ce;else throw new Error("AI response did not contain a recognized function call.")}if(T)try{const ce=JSON.parse(T),$e=E=>{const z=[],I=Array.isArray(E)?E:[E];for(const $ of I)$&&($.actions&&Array.isArray($.actions)?z.push(...$e($.actions)):$.sub_actions&&Array.isArray($.sub_actions)?z.push(...$e($.sub_actions)):$.function_calls&&Array.isArray($.function_calls)?z.push(...$e($.function_calls)):typeof $.action=="string"&&z.push($));return z},He=$e(ce),ke=[];let Ve=null,tt=!1;for(const E of He){if(E.action==="ask_followup_question"){Ve=E,tt=!0;continue}tt=!0;const z=E.action;if(z==="update_clinic_ai_memory"&&typeof E.memory_content=="string")ke.push((async()=>{M(!0),J("Processing AI mem..."),v==null||v({role:"system",type:"loading",content:"Processing AI memory..."});const I=(a==null?void 0:a.aiMemory)||"";try{if(!a)throw new Error("Clinic settings not loaded.");const $={...a,aiMemory:E.memory_content.trim(),admissionCharge:a.admissionCharge,perDayCharge:a.perDayCharge,otherCharges:a.otherCharges,clinicWideSystemPrompt:a.clinicWideSystemPrompt},ae=await K("/api/clinics/settings",{method:"PUT",body:JSON.stringify($)});if(!ae.ok){const R=await ae.json().catch(()=>({}));throw new Error(R.message||`AI-triggered clinic memory update failed: ${ae.statusText}`)}const re=await ae.json();return Ge(R=>R?{...R,aiMemory:re.settings.aiMemory}:null),lt(re.settings.aiMemory||""),J("AI mem updated!"),v==null||v({role:"system",type:"success",content:"AI memory updated successfully."}),{success:!0,actionType:z,undoData:{originalMemory:I}}}catch($){return J("Failed"),{success:!1,actionType:z,error:$,originalActionPayload:E}}finally{M(!1)}})());else if(z==="create_pharmacy_order")ke.push((async()=>{var I,$;X(!0),le("Processing order..."),v==null||v({role:"system",type:"loading",content:"Processing pharmacy order..."});try{if(!n)throw new Error("Missing patient ID.");const ae=[];let re=null;if(Array.isArray(E.items))for(const ie of E.items){let de;if(ie.drug_id?de=y.find(Se=>Se.id===ie.drug_id):ie.name&&(de=At(ie.name,y)),!de){re=`Drug "${ie.name||ie.drug_id}" not found.`;break}const he=gi(de.pack),B=Number(de.mrp),Q=B,ye=he>0?B/he:0,qe=Number(ie.pack_quantity)||0,ue=Number(ie.loose_quantity)||0,_e=qe*Q+ue*ye;ae.push({drug_id:String(de.id),name:de.name,pack_quantity:qe,loose_quantity:ue,tabletsPerDay:ie.tabletsPerDay,numberOfDays:ie.numberOfDays,directions_to_use:ie.directions_to_use,group_id:ie.group_id,pack_price:Q,loose_price:ye,total_price:_e,price:B,isLoose:ie.isLoose,unit:de.pack})}if(re)throw new Error(re);const R=ae.reduce((ie,de)=>ie+de.total_price,0),me={patient_id:n,items:ae,prescription_for_unavailable_drugs:E.prescription_for_unavailable_drugs,order_total:parseFloat(R.toFixed(2))},ve=await K("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(me)});if(!ve.ok){const ie=await ve.json().catch(()=>({}));throw new Error(ie.message||"Order creation failed.")}const ge=await ve.json();return le("Order created!"),b(n),v==null||v({role:"system",type:"success",content:"Pharmacy order created successfully."}),{success:!0,actionType:z,data:ge,undoData:{orderId:(($=(I=ge.orders)==null?void 0:I[0])==null?void 0:$.id)||ge.id}}}catch(ae){return v==null||v({role:"system",type:"error",content:`Pharmacy order failed: ${ae.message}`}),{success:!1,actionType:z,error:ae,originalActionPayload:E}}finally{X(!1)}})());else if(z==="bill_pharmacy_order")ke.push((async()=>{X(!0),le("Billing Pharmacy Order...");try{const I=E.serialNumber;if(!I)throw new Error("Missing serial number for billing.");if(!n)throw new Error("Missing patient ID.");const $=new Map;(d??[]).forEach(B=>$.set(B.id,{...B}));const ae=Array.from($.values()).sort((B,Q)=>new Date(Q.date).getTime()-new Date(B.date).getTime()),re=ae.length-I,R=ae[re];if(!R)throw new Error(`Pharmacy order #${I} not found.`);if(R.status==="billed"||R.status==="dispensed")throw new Error(`Order #${I} is already billed.`);const me=R.medications.map(B=>{let Q;B.drug_id?Q=y.find(Ye=>String(Ye.id)===String(B.drug_id)):Q=y.find(Ye=>Ye.name.toLowerCase()===B.name.toLowerCase());const ye=Number(B.pack_price)||Number(Q==null?void 0:Q.mrp)||0,qe=gi(B.unit||(Q==null?void 0:Q.pack)),ue=Number(B.loose_price)||(qe>0?ye/qe:0),_e=(B.pack_quantity||0)*qe+(B.loose_quantity||0);let Se=Number(B.total_price);return Se||(Se=_e*ue),{...B,price:Se,mrp:ye,pack_quantity:B.pack_quantity,loose_quantity:B.loose_quantity,expiry_date:B.expiry_date||(Q==null?void 0:Q.expiry_date),batch:B.batch||(Q==null?void 0:Q.box_number)}}),ve=me.reduce((B,Q)=>B+Q.price,0),ge=ve,ie={patientId:n,queueId:R.id,items:me.map(B=>({name:B.name,pack_quantity:B.pack_quantity,loose_quantity:B.loose_quantity,price:B.mrp,pack_price:B.mrp,loose_price:B.loose_price,total:B.price,drug_id:B.drug_id,discount_percentage:0,batch:B.batch,expiry_date:B.expiry_date})),amount:ge,paymentMode:"cash",type:"pharmacy",related_id:R.id,status:"paid",discountPercentage:0},de=await K("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ie)}),he=await de.json();if(!de.ok)throw new Error(he.message||"Failed to create pharmacy bill");return await K(`/api/pharmacy-orders/${R.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:he.id,medications:me})}),le("Billed Successfully!"),b(n),ct&&ct({billId:he.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:R.date,items:me,subtotal:ve,totalDiscount:0,grandTotal:ge,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||""}),v==null||v({role:"system",type:"success",content:`Pharmacy order #${R.id} billed.`}),{success:!0,actionType:z,data:he}}catch(I){return v==null||v({role:"system",type:"error",content:`Billing failed: ${I.message}`}),{success:!1,actionType:z,error:I,originalActionPayload:E}}finally{X(!1)}})());else if(z==="create_and_bill_pharmacy_order")ke.push((async()=>{X(!0),le("Processing & Billing..."),v==null||v({role:"system",type:"loading",content:"Prescribing and billing..."});let I=null;try{if(!n)throw new Error("Missing patient ID.");const $=[];let ae=null;if(Array.isArray(E.items))for(const Q of E.items){let ye;if(Q.drug_id?ye=y.find(jt=>jt.id===Q.drug_id):Q.name&&(ye=At(Q.name,y)),!ye){ae=`Drug "${Q.name}" not found.`;break}const qe=gi(ye.pack),ue=Number(ye.mrp),_e=ue,Se=qe>0?ue/qe:0,Ye=Number(Q.pack_quantity)||0,Je=Number(Q.loose_quantity)||0,ut=Ye*_e+Je*Se;$.push({drug_id:String(ye.id),name:ye.name,pack_quantity:Ye,loose_quantity:Je,tabletsPerDay:Q.tabletsPerDay,numberOfDays:Q.numberOfDays,directions_to_use:Q.directions_to_use,group_id:Q.group_id,pack_price:_e,loose_price:Se,total_price:ut,price:ue,mrp:ue,isLoose:Q.isLoose,unit:ye.pack,batch:ye.box_number,expiry_date:ye.expiry_date})}if(ae)throw new Error(ae);const re=$.reduce((Q,ye)=>Q+ye.total_price,0),R={patient_id:n,items:$,prescription_for_unavailable_drugs:E.prescription_for_unavailable_drugs,order_total:parseFloat(re.toFixed(2))},me=await K("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(R)});if(!me.ok)throw new Error("Order creation failed.");const ve=await me.json(),ge=ve.orders?ve.orders[0]:ve;I=ge.id;const ie=re,de={patientId:n,queueId:ge.id,items:$.map(Q=>({name:Q.name,pack_quantity:Q.pack_quantity,loose_quantity:Q.loose_quantity,price:Q.mrp,pack_price:Q.mrp,loose_price:Q.loose_price,total:Q.total_price,drug_id:Q.drug_id,discount_percentage:0,batch:Q.batch,expiry_date:Q.expiry_date})),amount:ie,paymentMode:"cash",type:"pharmacy",related_id:ge.id,status:"paid",discountPercentage:0},he=await K("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(de)}),B=await he.json();if(!he.ok)throw new Error("Billing failed.");return await K(`/api/pharmacy-orders/${ge.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:B.id,medications:$})}),le("Ordered & Billed!"),b(n),ct&&ct({billId:B.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:new Date().toISOString(),items:$.map(Q=>({...Q,price:Q.total_price})),subtotal:ie,totalDiscount:0,grandTotal:ie,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||""}),v==null||v({role:"system",type:"success",content:`Pharmacy order #${ge.id} created and billed.`}),{success:!0,actionType:z,data:ge,undoData:{orderId:ge.id}}}catch($){return v==null||v({role:"system",type:"error",content:`Create & Bill failed: ${$.message}`}),{success:!1,actionType:z,error:$,originalActionPayload:E,undoData:I?{orderId:I}:void 0}}finally{X(!1)}})());else if(z==="update_patient_details")ke.push((async()=>{F(!0),v==null||v({role:"system",type:"loading",content:"Updating patient details..."});const I={...t};try{if(!n)throw new Error("Missing patient ID.");const $={};if(E.name&&($.name=E.name),E.age&&($.age=E.age),E.gender&&($.gender=E.gender),E.phone_number!==void 0&&($.phone_number=E.phone_number),!(await K(`/api/patients/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify($)})).ok)throw new Error("Patient update failed.");return Qe(n),v==null||v({role:"system",type:"success",content:"Patient details updated."}),{success:!0,actionType:z,undoData:{patientId:n,originalDetails:I}}}catch($){return{success:!1,actionType:z,error:$,originalActionPayload:E}}finally{F(!1)}})());else if(z==="create_lab_order")ke.push((async()=>{ne(!0),oe("Processing lab..."),v==null||v({role:"system",type:"loading",content:"Processing lab order..."});try{if(!n)throw new Error("Missing patient ID.");const I=[];for(const re of E.tests||[]){let R;if(re.id?R=h.find(me=>String(me.id)===String(re.id)):re.name&&(R=At(re.name,h)),!R)throw new Error(`Lab test "${re.name}" not found.`);I.push({id:R.id,name:R.name,price:Number(R.price)})}const $=await K("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,tests:I})});if(!$.ok)throw new Error("Lab order creation failed.");const ae=await $.json();return oe("Success!"),Ne(n),v==null||v({role:"system",type:"success",content:"Lab order created."}),{success:!0,actionType:z,data:ae.labOrder,undoData:{orderId:ae.labOrder.id}}}catch(I){return v==null||v({role:"system",type:"error",content:`Lab order failed: ${I.message}`}),{success:!1,actionType:z,error:I,originalActionPayload:E}}finally{ne(!1)}})());else if(z==="create_and_bill_lab_order")ke.push((async()=>{ne(!0),oe("Processing & Billing..."),v==null||v({role:"system",type:"loading",content:"Creating and billing lab order..."});let I=null;try{if(!n)throw new Error("Missing patient ID.");const $=[];for(const B of E.tests||[]){let Q;if(B.id?Q=h.find(ye=>String(ye.id)===String(B.id)):B.name&&(Q=At(B.name,h)),!Q)throw new Error(`Lab test "${B.name}" not found.`);$.push({id:Q.id,name:Q.name,price:Number(Q.price)})}const ae=await K("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,tests:$})});if(!ae.ok)throw new Error("Lab order creation failed.");const R=(await ae.json()).labOrder;I=R.id,v==null||v({role:"system",type:"loading",content:`Order #${R.id} created. Generating bill...`});const me=$.map(B=>({name:B.name,price:typeof B.price=="string"?parseFloat(B.price):B.price||0,discount_percentage:0,quantity:1,item_id:B.id,type:"lab_test"})),ve=me.reduce((B,Q)=>B+Q.price,0),ge=ve,ie={patientId:n,items:me.map(B=>({...B,total:B.price})),amount:ge,paymentMode:"cash",type:"lab",related_id:R.id,status:"paid",discountPercentage:0},de=await K("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ie)}),he=await de.json();if(!de.ok)throw new Error(he.message||"Failed to create bill");return await K(`/api/lab/${R.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:he.id})}),oe("Success & Billed!"),Ne(n),It&&It({billId:he.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:R.createdAt,items:me,subtotal:ve,totalDiscount:0,grandTotal:ge,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||"",labLetterheadUrl:a==null?void 0:a.labLetterheadUrl}),v==null||v({role:"system",type:"success",content:`Lab order #${R.id} created and billed. Opening print dialog.`}),{success:!0,actionType:z,data:R,undoData:{orderId:R.id}}}catch($){return v==null||v({role:"system",type:"error",content:`Create and Bill failed: ${$.message}`}),{success:!1,actionType:z,error:$,originalActionPayload:E,undoData:I?{orderId:I}:void 0}}finally{ne(!1)}})());else if(z==="create_lab_report")ke.push((async()=>{ne(!0),oe("Creating Report..."),v==null||v({role:"system",type:"loading",content:"Creating lab report..."});try{if(!n)throw new Error("Missing patient ID.");const I=[],$=E.tests||[];for(const ge of $){let ie;if(ge.id?ie=h.find(de=>String(de.id)===String(ge.id)):ge.name&&(ie=At(ge.name,h)),!ie)throw new Error(`Lab test "${ge.name}" not found.`);ge._matchedTest=ie,I.push({id:ie.id,name:ie.name,price:Number(ie.price)})}const ae=await K("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,tests:I,status:"reported"})});if(!ae.ok)throw new Error("Lab order creation failed during report generation.");const re=await ae.json(),R=re.labOrder.id,me={};if($.forEach(ge=>{const ie=ge._matchedTest,de=ie.id,he=ge.parameters||[],B={},Q=ie.default_parameters||[];for(const ye of Q){const qe=he.find(ue=>{if(!ue.name)return!1;if(ue.name.toLowerCase()===ye.name.toLowerCase())return!0;const _e=ue.name.toLowerCase(),Se=ye.name.toLowerCase();return _e.includes(Se)||Se.includes(_e)});qe&&qe.value!==void 0?B[ye.name]=qe.value:ye.defaultValue!==void 0&&ye.defaultValue!==null&&(B[ye.name]=ye.defaultValue)}me[de]=B}),!(await K(`/api/lab/${R}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(me)})})).ok)throw new Error("Report submission failed.");return oe("Report Created!"),Ne(n),Me(n),v==null||v({role:"system",type:"success",content:"Lab report created successfully."}),{success:!0,actionType:z,data:re.labOrder,undoData:{orderId:R}}}catch(I){return v==null||v({role:"system",type:"error",content:`Lab report failed: ${I.message}`}),{success:!1,actionType:z,error:I,originalActionPayload:E}}finally{ne(!1)}})());else if(z==="edit_lab_report")ke.push((async()=>{ne(!0),oe("Updating Report...");try{const I=E.serialNumber;if(!I)throw new Error("Missing serial number for lab report edit.");const $=new Map;(c??[]).forEach(he=>$.set(he.id,{...he})),(u??[]).forEach(he=>{if($.has(he.id)){const B=$.get(he.id);B.report=he,B.status=he.status}else $.set(he.id,{...he,createdAt:he.createdAt})});const ae=Array.from($.values());ae.sort((he,B)=>new Date(B.createdAt).getTime()-new Date(he.createdAt).getTime());const re=ae.length-I,R=ae[re];if(!R)throw new Error(`Lab report #${I} not found.`);const me=R.id;let ve={};if(R.report&&R.report.report_content)try{ve=typeof R.report.report_content=="string"?JSON.parse(R.report.report_content):R.report.report_content}catch{}const ge={...ve};if((E.tests||[]).forEach(he=>{let Q=(R.tests||[]).find(Se=>Se.name.toLowerCase()===he.name.toLowerCase());if(!Q)return;const ye=Q.id,qe=he.parameters||[],ue=h.find(Se=>String(Se.id)===String(ye)),_e=(ue==null?void 0:ue.default_parameters)||[];ge[ye]||(ge[ye]={});for(const Se of _e){const Ye=qe.find(Je=>{if(!Je.name)return!1;if(Je.name.toLowerCase()===Se.name.toLowerCase())return!0;const ut=Je.name.toLowerCase(),jt=Se.name.toLowerCase();return ut.includes(jt)||jt.includes(ut)});Ye&&Ye.value!==void 0&&(ge[ye][Se.name]=Ye.value)}}),!(await K(`/api/lab/${me}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(ge)})})).ok)throw new Error("Report update failed.");return oe("Report Updated!"),Ne(n),Me(n),v==null||v({role:"system",type:"success",content:"Lab report updated successfully."}),{success:!0,actionType:z,data:{orderId:me},undoData:{orderId:me}}}catch(I){return v==null||v({role:"system",type:"error",content:`Update report failed: ${I.message}`}),{success:!1,actionType:z,error:I,originalActionPayload:E}}finally{ne(!1)}})());else if(z==="edit_lab_order_and_create_report")ke.push((async()=>{ne(!0),oe("Updating Order & Report..."),v==null||v({role:"system",type:"loading",content:"Updating lab order and report..."});try{const I=E.serialNumber;if(!I)throw new Error("Missing serial number.");const $=new Map;(c??[]).forEach(ue=>$.set(ue.id,{...ue})),(u??[]).forEach(ue=>{if($.has(ue.id)){const _e=$.get(ue.id);_e.report=ue,_e.status=ue.status}else $.set(ue.id,{...ue,createdAt:ue.createdAt})});const ae=Array.from($.values());ae.sort((ue,_e)=>new Date(_e.createdAt).getTime()-new Date(ue.createdAt).getTime());const re=ae.length-I,R=ae[re];if(!R)throw new Error(`Lab order #${I} not found.`);const me=R.id,ve=JSON.parse(JSON.stringify(R));let ge=[];for(const ue of R.tests||[]){const _e=h.find(Se=>String(Se.id)===String(ue.id));_e?ge.push({id:_e.id,name:_e.name,price:Number(_e.price)}):ge.push({id:ue.id,name:ue.name,price:Number(ue.price)||0})}if(E.items_to_remove&&Array.isArray(E.items_to_remove)){const ue=E.items_to_remove;ge=ge.filter(_e=>!ue.some(Se=>Se.id&&String(Se.id)===String(_e.id)||Se.name&&_e.name.toLowerCase()===Se.name.toLowerCase()))}const ie=E.tests||[],de={};for(const ue of ie){let _e;if(ue.id?_e=h.find(nt=>String(nt.id)===String(ue.id)):ue.name&&(_e=At(ue.name,h)),!_e)throw new Error(`Lab test "${ue.name}" not found.`);ge.findIndex(nt=>String(nt.id)===String(_e.id))===-1&&ge.push({id:_e.id,name:_e.name,price:Number(_e.price)});const Ye=_e.id,Je=ue.parameters||[],ut={},jt=_e.default_parameters||[];for(const nt of jt){const gn=Je.find(yn=>{if(!yn.name)return!1;if(yn.name.toLowerCase()===nt.name.toLowerCase())return!0;const Wn=yn.name.toLowerCase(),Vn=nt.name.toLowerCase();return Wn.includes(Vn)||Vn.includes(Wn)});gn&&gn.value!==void 0?ut[nt.name]=gn.value:nt.defaultValue!==void 0&&(ut[nt.name]=nt.defaultValue)}de[Ye]=ut}const he={tests:ge};console.log("[DEBUG] edit_lab_order_and_create_report - Order Update Payload:",JSON.stringify(he,null,2)),console.log("[DEBUG] Items to remove:",E.items_to_remove),console.log("[DEBUG] Original tests:",R.tests);const B=await K(`/api/lab/orders/${me}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(he)});if(console.log("[DEBUG] Order update response status:",B.status),!B.ok){const ue=await B.json().catch(()=>({}));throw console.error("[DEBUG] Order update failed:",ue),new Error(`Failed to update lab order tests: ${ue.message||B.statusText}`)}let Q={};if(R.report&&R.report.report_content)try{Q=typeof R.report.report_content=="string"?JSON.parse(R.report.report_content):R.report.report_content}catch{}const ye={...Q,...de};if(!(await K(`/api/lab/${me}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(ye)})})).ok)throw new Error("Failed to create/update lab report.");return oe("Order & Report Updated!"),Ne(n),Me(n),v==null||v({role:"system",type:"success",content:"Lab order and report updated successfully."}),{success:!0,actionType:z,undoData:{orderId:me,originalState:ve}}}catch(I){return v==null||v({role:"system",type:"error",content:`Failed to edit order and report: ${I.message}`}),{success:!1,actionType:z,error:I,originalActionPayload:E}}finally{ne(!1)}})());else if(z==="edit_pharmacy_order")ke.push((async()=>{X(!0);try{const I=E.serialNumber;let $;if(I?$=[...d].sort((de,he)=>new Date(de.date).getTime()-new Date(he.date).getTime())[I-1]:$=d.find(ie=>ie.status==="pending"),!$)throw new Error("Order to edit not found.");const ae=JSON.parse(JSON.stringify($));let re=[...$.medications];const R=E.items_to_remove,me=E.items;if(Array.isArray(R)&&(re=re.filter(ie=>!R.some(de=>de.drug_id&&String(ie.drug_id)===String(de.drug_id)||de.name&&ie.name.toLowerCase()===de.name.toLowerCase()))),Array.isArray(me))for(const ie of me){let de;if(ie.drug_id?de=y.find(Q=>String(Q.id)===String(ie.drug_id)):ie.name&&(de=At(ie.name,y)),!de)throw new Error(`Drug ${ie.name} not found.`);const he=re.findIndex(Q=>Q.drug_id===String(de==null?void 0:de.id)),B={drug_id:String(de.id),name:de.name,pack_quantity:ie.pack_quantity||0,loose_quantity:ie.loose_quantity||0,pack_price:Number(de.mrp),loose_price:0,total_price:0,price:Number(de.mrp)};he>=0?re[he]={...re[he],...B}:re.push(B)}const ve={items:re,status:E.status,prescription_for_unavailable_drugs:E.prescription_for_unavailable_drugs,order_total:0};if(!(await K(`/api/pharmacy-orders/${$.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ve)})).ok)throw new Error("Order edit failed.");return b(n),{success:!0,actionType:z,undoData:{orderId:$.id,originalState:ae}}}catch(I){return{success:!1,actionType:z,error:I,originalActionPayload:E}}finally{X(!1)}})());else if(z==="edit_lab_order")ke.push((async()=>{ne(!0);try{const I=c.sort((R,me)=>new Date(me.createdAt).getTime()-new Date(R.createdAt).getTime()).find(R=>R.status==="pending");if(!I)throw new Error("No pending lab order to edit.");const $=JSON.parse(JSON.stringify(I)),ae={tests:[],status:E.status};if(!(await K(`/api/lab/orders/${I.id}`,{method:"PUT",body:JSON.stringify(ae),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Lab edit failed.");return Ne(n),{success:!0,actionType:z,undoData:{orderId:I.id,originalState:$}}}catch(I){return{success:!1,actionType:z,error:I,originalActionPayload:E}}finally{ne(!1)}})());else if(z==="add_complaint_history")ke.push((async()=>{V(!0),v==null||v({role:"system",type:"loading",content:"Updating complaint history..."});const I=q;try{if(!e)throw new Error("No record ID.");if(!(await K(`/api/queue/doctor/complaint/${e}`,{method:"PUT",body:JSON.stringify({complaint:E.complaint}),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Complaint update failed.");return Y(E.complaint),n&&at(n),v==null||v({role:"system",type:"success",content:"Complaint history updated."}),{success:!0,actionType:z,undoData:{recordId:e,originalComplaint:I}}}catch($){return v==null||v({role:"system",type:"error",content:`Complaint history update failed: ${$.message}`}),{success:!1,actionType:z,error:$,originalActionPayload:E}}finally{V(!1)}})());else if(z==="update_case_summary")ke.push((async()=>{C(!0),v==null||v({role:"system",type:"loading",content:"Updating case summary..."});const I=r;try{if(!e)throw new Error("No record ID.");const $=await K(`/api/queue/doctor/complaint/${e}`,{method:"PUT",body:JSON.stringify({case_summary:E.summary}),headers:{"Content-Type":"application/json"}});if(!$.ok)throw new Error("Summary update failed.");const ae=await $.json();return A(ae.case_summary),v==null||v({role:"system",type:"success",content:"Case summary updated."}),{success:!0,actionType:z,undoData:{recordId:e,originalSummary:I}}}catch($){return v==null||v({role:"system",type:"error",content:`Case summary update failed: ${$.message}`}),{success:!1,actionType:z,error:$,originalActionPayload:E}}finally{C(!1)}})());else if(z==="create_recurring_medication_order")ke.push((async()=>{X(!0),le("Creating recurring medication(s)..."),v==null||v({role:"system",type:"loading",content:"Creating recurring medication(s)..."});try{if(!n)throw new Error("Missing patient ID.");if(!E.items||!Array.isArray(E.items))throw new Error("No items provided for recurring medication order.");const I=await Promise.all(E.items.map(async R=>{let me=R.drug_id;if(!me){const ve=At(R.medication_name,y);me=ve?ve.id:null}if(!me)throw new Error(`Drug "${R.medication_name}" not found in inventory for recurring medication.`);return{...R,drug_id:me}})),$=await K("/api/recurring-medications",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,items:I})});if(!$.ok){const R=await $.json().catch(()=>({}));throw new Error(R.message||"Failed to create recurring medication order")}const ae=await $.json(),re=ae.map(R=>R.id);return n&&be&&be(n),le("Recurring medication(s) created."),v==null||v({role:"system",type:"success",content:`Successfully created ${re.length} recurring medication(s).`}),{success:!0,actionType:z,data:ae,undoData:{createdIds:re}}}catch(I){return v==null||v({role:"system",type:"error",content:`Error creating recurring medication: ${I.message}`}),{success:!1,actionType:z,error:I,originalActionPayload:E}}finally{X(!1)}})());else if(z==="edit_recurring_medication_order")ke.push((async()=>{X(!0),le("Updating recurring medication..."),v==null||v({role:"system",type:"loading",content:"Updating recurring medication..."});try{if(!n)throw new Error("Missing patient ID.");if(!E.serialNumber||!E.updates)throw new Error("Missing serialNumber or updates for recurring medication edit.");if(!D||D.length===0)throw new Error("No recurring medications found to edit.");const I=E.serialNumber-1;if(I<0||I>=D.length)throw new Error(`Recurring medication with serial number ${E.serialNumber} not found.`);const $=D[I],ae=JSON.parse(JSON.stringify($));if(E.updates.drug_id===null||E.updates.medication_name){let R=E.updates.drug_id;if(!R&&E.updates.medication_name){const me=At(E.updates.medication_name,y);R=me?me.id:null}if(!R&&E.updates.medication_name)throw new Error(`Drug "${E.updates.medication_name}" not found in inventory for update.`);E.updates.drug_id=R}const re=await K(`/api/recurring-medications/${$.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(E.updates)});if(!re.ok){const R=await re.json().catch(()=>({}));throw new Error(R.message||"Failed to update recurring medication")}return n&&be&&be(n),le("Recurring medication updated."),v==null||v({role:"system",type:"success",content:`Successfully updated recurring medication #${E.serialNumber}.`}),{success:!0,actionType:z,data:{id:$.id,...E.updates},undoData:{medicationId:$.id,originalState:ae}}}catch(I){return v==null||v({role:"system",type:"error",content:`Error updating recurring medication: ${I.message}`}),{success:!1,actionType:z,error:I,originalActionPayload:E}}finally{X(!1)}})());else if(z==="end_task")ke.push((async()=>(v==null||v({role:"system",type:"success",content:"Task completed."}),{success:!0,actionType:z}))());else{if(z==="bill_lab_order")continue;console.warn(`Unknown action ${z}`),ke.push(Promise.resolve({success:!1,actionType:z,error:new Error(`Unknown action: ${z}`),originalActionPayload:E}))}}const Re=await Promise.all(ke),Z=Re.filter(E=>!E.success);if(Z.length>0){console.log("AI Actions Failed. Initiating Rollback...",Z);const E=Re.filter(re=>re.success),z=[...E].reverse();await Ue(z);const I=Z.map(re=>{var R;return`${re.actionType}: ${(R=re.error)==null?void 0:R.message}`}).join("; "),$=E.length>0?` I successfully rolled back ${E.length} other actions that succeeded.`:"",ae=`One or more actions failed: [${I}].${$} Please analyze the failure and try again.`;await Nt("multiple_actions",{message:ae},Le,S)}else{const E=Re.filter(I=>I.success);E.length>0&&(Ot(E),Yt&&E.forEach(I=>Yt(I.actionType)));const z=He.find(I=>I.action==="bill_lab_order");if(z&&z.serialNumber){const I=new Map;(c??[]).forEach(R=>I.set(R.id,{...R}));const $=Array.from(I.values());$.sort((R,me)=>new Date(me.createdAt).getTime()-new Date(R.createdAt).getTime());const ae=$.length-z.serialNumber,re=$[ae];if(re&&re.id){v==null||v({role:"system",type:"success",content:`Processing billing for Lab Order #${z.serialNumber}...`});try{const R=re.tests.map(B=>({name:B.test_name||B.name,price:typeof B.price=="string"?parseFloat(B.price):B.price||0,discount_percentage:0,quantity:1,item_id:B.test_id||B.id,type:"lab_test"})),me=R.reduce((B,Q)=>B+Q.price,0),ve=0,ge=me,ie={patientId:re.patient_id,items:R.map(B=>({...B,total:B.price})),amount:ge,paymentMode:"cash",type:"lab",related_id:re.id,status:"paid",discountPercentage:0},de=await K("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ie)}),he=await de.json();if(!de.ok)throw new Error(he.message||"Failed to create bill");await K(`/api/lab/${re.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:he.id})}),n&&Ne(n),It&&(It({billId:he.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:re.createdAt,items:R,subtotal:me,totalDiscount:ve,grandTotal:ge,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||"",labLetterheadUrl:a==null?void 0:a.labLetterheadUrl}),v==null||v({role:"system",type:"success",content:`Bill #${he.id} created. Opening print dialog.`}))}catch(R){console.error("Auto-billing failed:",R),v==null||v({role:"system",type:"error",content:`Billing failed: ${R.message}`})}}else console.warn(`Could not find lab order with serialNumber ${z.serialNumber} to bill.`),v==null||v({role:"system",type:"error",content:`Could not find lab order #${z.serialNumber} to bill.`})}if(Ve&&typeof Ve.question=="string")je(Ve.question),pe(Array.isArray(Ve.options)?Ve.options:[]);else if(E.length===0&&!z&&!tt)throw new Error("AI response did not result in a recognized or performed function call.")}}catch(ce){await Nt("parse_json_actions",ce,Le,S)}else throw new Error("AI response did not contain a recognized function call.")};_t=async(Le,S=0)=>{if(S>1){j("AI call failed after multiple retries. Please try a different prompt."),F(!1);return}F(!0),j(null);let T;const te=[...o,Le].join(`

`);try{const ce=new Map;(c??[]).forEach(Z=>{ce.set(Z.id,{...Z})}),(u??[]).forEach(Z=>{if(!ce.has(Z.id))ce.set(Z.id,{id:Z.id,patient_id:Z.patient_id,tests:Z.tests,status:Z.status,createdAt:Z.createdAt,report:Z});else{const E=ce.get(Z.id);E&&(E.report=Z,E.status=Z.status)}});const $e=Array.from(ce.values());$e.sort((Z,E)=>new Date(E.createdAt).getTime()-new Date(Z.createdAt).getTime());const He=$e.map((Z,E)=>{let z=null;if(Z.report)try{const I=typeof Z.report.report_content=="string"?Z.report.report_content:JSON.stringify(Z.report.report_content||{}),$=JSON.parse(I||"{}"),ae=re=>{const R=$[re.id]||{},me=ve=>({name:ve.name,value:R[ve.name]!==void 0?String(R[ve.name]):String(ve.defaultValue),normal_range:ve.normal_range||"N/A"});return{testId:re.id,testName:re.name,parameters:(re.default_parameters||[]).map(me)}};z={reportId:Z.report.reportId,reportDate:Z.report.report_date,tests:(Z.tests||[]).map(ae)}}catch{z={reportId:Z.report.reportId,reportDate:Z.report.report_date,reportContent:typeof Z.report.report_content=="string"?Z.report.report_content:JSON.stringify(Z.report.report_content),error:"Failed to parse report content JSON."}}return{serialNumber:$e.length-E,orderId:Z.id,orderDate:isNaN(new Date(Z.createdAt).getTime())?Z.createdAt:new Date(Z.createdAt).toISOString(),tests:Z.tests.map(I=>({id:I.id,name:I.name,price:I.price})),status:Z.status,report:z}}),ke=m.map(Z=>{try{return{...Z,createdAt:isNaN(new Date(Z.createdAt).getTime())?Z.createdAt:new Date(Z.createdAt).toISOString()}}catch{return Z}}),tt=[...d].sort((Z,E)=>{const z=new Date(Z.date).getTime(),I=new Date(E.date).getTime();return z-I}).map((Z,E)=>{try{return{serialNumber:E+1,...Z,date:Z.date&&!isNaN(new Date(Z.date).getTime())?new Date(Z.date).toISOString():Z.date}}catch{return{serialNumber:E+1,...Z}}}),Re={query:te,currentDateTime:new Date().toISOString(),patientName:(t==null?void 0:t.name)||"",patientAge:(t==null?void 0:t.age)||void 0,patientGender:(t==null?void 0:t.gender)||void 0,case_summary:r||"",case_summary_last_updated:s?new Date(s).toISOString():void 0,clinic_ai_memory:(a==null?void 0:a.aiMemory)||"",clinic_ai_memory_last_updated:a!=null&&a.aiMemoryUpdatedAt?new Date(a.aiMemoryUpdatedAt).toISOString():void 0,clinic_wide_system_prompt:(a==null?void 0:a.clinicWideSystemPrompt)||"",labHistory:He,pharmacyOrders:tt,pastComplaints:ke,pharmacyInventory:y,labInventory:h,recurringMedications:D};if(console.log("DEBUG: Payload before sending to Gemini API:",JSON.stringify(Re,null,2)),T=await Sh(Re,l),T){O(T),v==null||v({role:"ai",content:T});const Z=/```json\s*([\s\S]*?)\s*```/,E=T.match(Z);if(E&&E[1])H(T.replace(Z,"").trim()),L(E[1].trim());else{const z=T.trim();if(z.startsWith("{")&&z.endsWith("}"))try{JSON.parse(z),H(""),L(z)}catch{H(z),L(null)}else if(z.startsWith("[")&&z.endsWith("]"))try{JSON.parse(z),H(""),L(z)}catch{H(z),L(null)}else H(z),L(null)}W(!1),n&&T&&await fn(n,T),await mt(T,S),Y("")}else throw new Error("Invalid AI response format.")}catch(ce){await Nt("call_generative_api",ce,T,S)}finally{F(!1)}};const fn=async(Le,S)=>{Oe(!0),Fe(null);try{const T={ai_response:S},P=await K(`/api/patients/${Le}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)});if(!P.ok){const te=await P.json().catch(()=>({}));throw new Error(te.message||`Failed to save AI response to patient: ${P.statusText}`)}}catch(T){Fe(`AI Response Save Error: ${T.message}`),v==null||v({role:"system",type:"error",content:`AI Response Save Error: ${T.message}`})}finally{Oe(!1)}};return w.useImperativeHandle(kt,()=>({callGenerativeApi:_t,undoLastAction:vt})),null}),Eo=-1,wr=0,qn=1,gr=2,Hi=3,Wi=4,Vi=5,Ji=6,Ao=7,Do=8,Ss=typeof self=="object"?self:globalThis,Th=(e,n)=>{const t=(s,a)=>(e.set(a,s),s),r=s=>{if(e.has(s))return e.get(s);const[a,o]=n[s];switch(a){case wr:case Eo:return t(o,s);case qn:{const l=t([],s);for(const c of o)l.push(r(c));return l}case gr:{const l=t({},s);for(const[c,u]of o)l[r(c)]=r(u);return l}case Hi:return t(new Date(o),s);case Wi:{const{source:l,flags:c}=o;return t(new RegExp(l,c),s)}case Vi:{const l=t(new Map,s);for(const[c,u]of o)l.set(r(c),r(u));return l}case Ji:{const l=t(new Set,s);for(const c of o)l.add(r(c));return l}case Ao:{const{name:l,message:c}=o;return t(new Ss[l](c),s)}case Do:return t(BigInt(o),s);case"BigInt":return t(Object(BigInt(o)),s);case"ArrayBuffer":return t(new Uint8Array(o).buffer,o);case"DataView":{const{buffer:l}=new Uint8Array(o);return t(new DataView(l),o)}}return t(new Ss[a](o),s)};return r},Ps=e=>Th(new Map,e)(0),on="",{toString:Eh}={},{keys:Ah}=Object,Rn=e=>{const n=typeof e;if(n!=="object"||!e)return[wr,n];const t=Eh.call(e).slice(8,-1);switch(t){case"Array":return[qn,on];case"Object":return[gr,on];case"Date":return[Hi,on];case"RegExp":return[Wi,on];case"Map":return[Vi,on];case"Set":return[Ji,on];case"DataView":return[qn,t]}return t.includes("Array")?[qn,t]:t.includes("Error")?[Ao,t]:[gr,t]},lr=([e,n])=>e===wr&&(n==="function"||n==="symbol"),Dh=(e,n,t,r)=>{const s=(o,l)=>{const c=r.push(o)-1;return t.set(l,c),c},a=o=>{if(t.has(o))return t.get(o);let[l,c]=Rn(o);switch(l){case wr:{let m=o;switch(c){case"bigint":l=Do,m=o.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+c);m=null;break;case"undefined":return s([Eo],o)}return s([l,m],o)}case qn:{if(c){let y=o;return c==="DataView"?y=new Uint8Array(o.buffer):c==="ArrayBuffer"&&(y=new Uint8Array(o)),s([c,[...y]],o)}const m=[],d=s([l,m],o);for(const y of o)m.push(a(y));return d}case gr:{if(c)switch(c){case"BigInt":return s([c,o.toString()],o);case"Boolean":case"Number":case"String":return s([c,o.valueOf()],o)}if(n&&"toJSON"in o)return a(o.toJSON());const m=[],d=s([l,m],o);for(const y of Ah(o))(e||!lr(Rn(o[y])))&&m.push([a(y),a(o[y])]);return d}case Hi:return s([l,o.toISOString()],o);case Wi:{const{source:m,flags:d}=o;return s([l,{source:m,flags:d}],o)}case Vi:{const m=[],d=s([l,m],o);for(const[y,h]of o)(e||!(lr(Rn(y))||lr(Rn(h))))&&m.push([a(y),a(h)]);return d}case Ji:{const m=[],d=s([l,m],o);for(const y of o)(e||!lr(Rn(y)))&&m.push(a(y));return d}}const{message:u}=o;return s([l,{name:c,message:u}],o)};return a},Ts=(e,{json:n,lossy:t}={})=>{const r=[];return Dh(!(n||t),!!n,new Map,r)(e),r},Bn=typeof structuredClone=="function"?(e,n)=>n&&("json"in n||"lossy"in n)?Ps(Ts(e,n)):structuredClone(e):(e,n)=>Ps(Ts(e,n)),Io=$o("end"),Oo=$o("start");function $o(e){return n;function n(t){const r=t&&t.position&&t.position[e]||{};if(typeof r.line=="number"&&r.line>0&&typeof r.column=="number"&&r.column>0)return{line:r.line,column:r.column,offset:typeof r.offset=="number"&&r.offset>-1?r.offset:void 0}}}function Lo(e){const n=Oo(e),t=Io(e);if(n&&t)return{start:n,end:t}}const Jt=["ariaDescribedBy","ariaLabel","ariaLabelledBy"],Es={ancestors:{tbody:["table"],td:["table"],th:["table"],thead:["table"],tfoot:["table"],tr:["table"]},attributes:{a:[...Jt,"dataFootnoteBackref","dataFootnoteRef",["className","data-footnote-backref"],"href"],blockquote:["cite"],code:[["className",/^language-./]],del:["cite"],div:["itemScope","itemType"],dl:[...Jt],h2:[["className","sr-only"]],img:[...Jt,"longDesc","src"],input:[["disabled",!0],["type","checkbox"]],ins:["cite"],li:[["className","task-list-item"]],ol:[...Jt,["className","contains-task-list"]],q:["cite"],section:["dataFootnotes",["className","footnotes"]],source:["srcSet"],summary:[...Jt],table:[...Jt],ul:[...Jt,["className","contains-task-list"]],"*":["abbr","accept","acceptCharset","accessKey","action","align","alt","axis","border","cellPadding","cellSpacing","char","charOff","charSet","checked","clear","colSpan","color","cols","compact","coords","dateTime","dir","encType","frame","hSpace","headers","height","hrefLang","htmlFor","id","isMap","itemProp","label","lang","maxLength","media","method","multiple","name","noHref","noShade","noWrap","open","prompt","readOnly","rev","rowSpan","rows","rules","scope","selected","shape","size","span","start","summary","tabIndex","title","useMap","vAlign","value","width"]},clobber:["ariaDescribedBy","ariaLabelledBy","id","name"],clobberPrefix:"user-content-",protocols:{cite:["http","https"],href:["http","https","irc","ircs","mailto","xmpp"],longDesc:["http","https"],src:["http","https"]},required:{input:{disabled:!0,type:"checkbox"}},strip:["script"],tagNames:["a","b","blockquote","br","code","dd","del","details","div","dl","dt","em","h1","h2","h3","h4","h5","h6","hr","i","img","input","ins","kbd","li","ol","p","picture","pre","q","rp","rt","ruby","s","samp","section","source","span","strike","strong","sub","summary","sup","table","tbody","td","tfoot","th","thead","tr","tt","ul","var"]},Bt={}.hasOwnProperty;function Ih(e,n){let t={type:"root",children:[]};const r={schema:n?{...Es,...n}:Es,stack:[]},s=Ro(r,e);return s&&(Array.isArray(s)?s.length===1?t=s[0]:t.children=s:t=s),t}function Ro(e,n){if(n&&typeof n=="object"){const t=n;switch(typeof t.type=="string"?t.type:""){case"comment":return Oh(e,t);case"doctype":return $h(e,t);case"element":return Lh(e,t);case"root":return Rh(e,t);case"text":return Fh(e,t)}}}function Oh(e,n){if(e.schema.allowComments){const t=typeof n.value=="string"?n.value:"",r=t.indexOf("-->"),a={type:"comment",value:r<0?t:t.slice(0,r)};return Mn(a,n),a}}function $h(e,n){if(e.schema.allowDoctypes){const t={type:"doctype"};return Mn(t,n),t}}function Lh(e,n){const t=typeof n.tagName=="string"?n.tagName:"";e.stack.push(t);const r=Fo(e,n.children),s=zh(e,n.properties);e.stack.pop();let a=!1;if(t&&t!=="*"&&(!e.schema.tagNames||e.schema.tagNames.includes(t))&&(a=!0,e.schema.ancestors&&Bt.call(e.schema.ancestors,t))){const l=e.schema.ancestors[t];let c=-1;for(a=!1;++c<l.length;)e.stack.includes(l[c])&&(a=!0)}if(!a)return e.schema.strip&&!e.schema.strip.includes(t)?r:void 0;const o={type:"element",tagName:t,properties:s,children:r};return Mn(o,n),o}function Rh(e,n){const r={type:"root",children:Fo(e,n.children)};return Mn(r,n),r}function Fh(e,n){const r={type:"text",value:typeof n.value=="string"?n.value:""};return Mn(r,n),r}function Fo(e,n){const t=[];if(Array.isArray(n)){const r=n;let s=-1;for(;++s<r.length;){const a=Ro(e,r[s]);a&&(Array.isArray(a)?t.push(...a):t.push(a))}}return t}function zh(e,n){const t=e.stack[e.stack.length-1],r=e.schema.attributes,s=e.schema.required,a=r&&Bt.call(r,t)?r[t]:void 0,o=r&&Bt.call(r,"*")?r["*"]:void 0,l=n&&typeof n=="object"?n:{},c={};let u;for(u in l)if(Bt.call(l,u)){const m=l[u];let d=As(e,Ds(a,u),u,m);d==null&&(d=As(e,Ds(o,u),u,m)),d!=null&&(c[u]=d)}if(s&&Bt.call(s,t)){const m=s[t];for(u in m)Bt.call(m,u)&&!Bt.call(c,u)&&(c[u]=m[u])}return c}function As(e,n,t,r){return n?Array.isArray(r)?qh(e,n,t,r):zo(e,n,t,r):void 0}function qh(e,n,t,r){let s=-1;const a=[];for(;++s<r.length;){const o=zo(e,n,t,r[s]);(typeof o=="number"||typeof o=="string")&&a.push(o)}return a}function zo(e,n,t,r){if(!(typeof r!="boolean"&&typeof r!="number"&&typeof r!="string")&&Bh(e,t,r)){if(typeof n=="object"&&n.length>1){let s=!1,a=0;for(;++a<n.length;){const o=n[a];if(o&&typeof o=="object"&&"flags"in o){if(o.test(String(r))){s=!0;break}}else if(o===r){s=!0;break}}if(!s)return}return e.schema.clobber&&e.schema.clobberPrefix&&e.schema.clobber.includes(t)?e.schema.clobberPrefix+r:r}}function Bh(e,n,t){const r=e.schema.protocols&&Bt.call(e.schema.protocols,n)?e.schema.protocols[n]:void 0;if(!r||r.length===0)return!0;const s=String(t),a=s.indexOf(":"),o=s.indexOf("?"),l=s.indexOf("#"),c=s.indexOf("/");if(a<0||c>-1&&a>c||o>-1&&a>o||l>-1&&a>l)return!0;let u=-1;for(;++u<r.length;){const m=r[u];if(a===m.length&&s.slice(0,m.length)===m)return!0}return!1}function Mn(e,n){const t=Lo(n);n.data&&(e.data=Bn(n.data)),t&&(e.position=t)}function Ds(e,n){let t,r=-1;if(e)for(;++r<e.length;){const s=e[r],a=typeof s=="string"?s:s[0];if(a===n)return s;a==="data*"&&(t=s)}if(n.length>4&&n.slice(0,4).toLowerCase()==="data")return t}function Uh(e,n){const t={type:"element",tagName:"blockquote",properties:{},children:e.wrap(e.all(n),!0)};return e.patch(n,t),e.applyData(n,t)}function Mh(e,n){const t={type:"element",tagName:"br",properties:{},children:[]};return e.patch(n,t),[e.applyData(n,t),{type:"text",value:`
`}]}function Hh(e,n){const t=n.value?n.value+`
`:"",r={};n.lang&&(r.className=["language-"+n.lang]);let s={type:"element",tagName:"code",properties:r,children:[{type:"text",value:t}]};return n.meta&&(s.data={meta:n.meta}),e.patch(n,s),s=e.applyData(n,s),s={type:"element",tagName:"pre",properties:{},children:[s]},e.patch(n,s),s}function Wh(e,n){const t={type:"element",tagName:"del",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function Vh(e,n){const t={type:"element",tagName:"em",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function Jh(e,n){const t=typeof e.options.clobberPrefix=="string"?e.options.clobberPrefix:"user-content-",r=String(n.identifier).toUpperCase(),s=hn(r.toLowerCase()),a=e.footnoteOrder.indexOf(r);let o,l=e.footnoteCounts.get(r);l===void 0?(l=0,e.footnoteOrder.push(r),o=e.footnoteOrder.length):o=a+1,l+=1,e.footnoteCounts.set(r,l);const c={type:"element",tagName:"a",properties:{href:"#"+t+"fn-"+s,id:t+"fnref-"+s+(l>1?"-"+l:""),dataFootnoteRef:!0,ariaDescribedBy:["footnote-label"]},children:[{type:"text",value:String(o)}]};e.patch(n,c);const u={type:"element",tagName:"sup",properties:{},children:[c]};return e.patch(n,u),e.applyData(n,u)}function Qh(e,n){const t={type:"element",tagName:"h"+n.depth,properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function Gh(e,n){if(e.options.allowDangerousHtml){const t={type:"raw",value:n.value};return e.patch(n,t),e.applyData(n,t)}}function qo(e,n){const t=n.referenceType;let r="]";if(t==="collapsed"?r+="[]":t==="full"&&(r+="["+(n.label||n.identifier)+"]"),n.type==="imageReference")return[{type:"text",value:"!["+n.alt+r}];const s=e.all(n),a=s[0];a&&a.type==="text"?a.value="["+a.value:s.unshift({type:"text",value:"["});const o=s[s.length-1];return o&&o.type==="text"?o.value+=r:s.push({type:"text",value:r}),s}function Yh(e,n){const t=String(n.identifier).toUpperCase(),r=e.definitionById.get(t);if(!r)return qo(e,n);const s={src:hn(r.url||""),alt:n.alt};r.title!==null&&r.title!==void 0&&(s.title=r.title);const a={type:"element",tagName:"img",properties:s,children:[]};return e.patch(n,a),e.applyData(n,a)}function Kh(e,n){const t={src:hn(n.url)};n.alt!==null&&n.alt!==void 0&&(t.alt=n.alt),n.title!==null&&n.title!==void 0&&(t.title=n.title);const r={type:"element",tagName:"img",properties:t,children:[]};return e.patch(n,r),e.applyData(n,r)}function Xh(e,n){const t={type:"text",value:n.value.replace(/\r?\n|\r/g," ")};e.patch(n,t);const r={type:"element",tagName:"code",properties:{},children:[t]};return e.patch(n,r),e.applyData(n,r)}function Zh(e,n){const t=String(n.identifier).toUpperCase(),r=e.definitionById.get(t);if(!r)return qo(e,n);const s={href:hn(r.url||"")};r.title!==null&&r.title!==void 0&&(s.title=r.title);const a={type:"element",tagName:"a",properties:s,children:e.all(n)};return e.patch(n,a),e.applyData(n,a)}function em(e,n){const t={href:hn(n.url)};n.title!==null&&n.title!==void 0&&(t.title=n.title);const r={type:"element",tagName:"a",properties:t,children:e.all(n)};return e.patch(n,r),e.applyData(n,r)}function tm(e,n,t){const r=e.all(n),s=t?nm(t):Bo(n),a={},o=[];if(typeof n.checked=="boolean"){const m=r[0];let d;m&&m.type==="element"&&m.tagName==="p"?d=m:(d={type:"element",tagName:"p",properties:{},children:[]},r.unshift(d)),d.children.length>0&&d.children.unshift({type:"text",value:" "}),d.children.unshift({type:"element",tagName:"input",properties:{type:"checkbox",checked:n.checked,disabled:!0},children:[]}),a.className=["task-list-item"]}let l=-1;for(;++l<r.length;){const m=r[l];(s||l!==0||m.type!=="element"||m.tagName!=="p")&&o.push({type:"text",value:`
`}),m.type==="element"&&m.tagName==="p"&&!s?o.push(...m.children):o.push(m)}const c=r[r.length-1];c&&(s||c.type!=="element"||c.tagName!=="p")&&o.push({type:"text",value:`
`});const u={type:"element",tagName:"li",properties:a,children:o};return e.patch(n,u),e.applyData(n,u)}function nm(e){let n=!1;if(e.type==="list"){n=e.spread||!1;const t=e.children;let r=-1;for(;!n&&++r<t.length;)n=Bo(t[r])}return n}function Bo(e){const n=e.spread;return n??e.children.length>1}function rm(e,n){const t={},r=e.all(n);let s=-1;for(typeof n.start=="number"&&n.start!==1&&(t.start=n.start);++s<r.length;){const o=r[s];if(o.type==="element"&&o.tagName==="li"&&o.properties&&Array.isArray(o.properties.className)&&o.properties.className.includes("task-list-item")){t.className=["contains-task-list"];break}}const a={type:"element",tagName:n.ordered?"ol":"ul",properties:t,children:e.wrap(r,!0)};return e.patch(n,a),e.applyData(n,a)}function im(e,n){const t={type:"element",tagName:"p",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function am(e,n){const t={type:"root",children:e.wrap(e.all(n))};return e.patch(n,t),e.applyData(n,t)}function sm(e,n){const t={type:"element",tagName:"strong",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function om(e,n){const t=e.all(n),r=t.shift(),s=[];if(r){const o={type:"element",tagName:"thead",properties:{},children:e.wrap([r],!0)};e.patch(n.children[0],o),s.push(o)}if(t.length>0){const o={type:"element",tagName:"tbody",properties:{},children:e.wrap(t,!0)},l=Oo(n.children[1]),c=Io(n.children[n.children.length-1]);l&&c&&(o.position={start:l,end:c}),s.push(o)}const a={type:"element",tagName:"table",properties:{},children:e.wrap(s,!0)};return e.patch(n,a),e.applyData(n,a)}function lm(e,n,t){const r=t?t.children:void 0,a=(r?r.indexOf(n):1)===0?"th":"td",o=t&&t.type==="table"?t.align:void 0,l=o?o.length:n.children.length;let c=-1;const u=[];for(;++c<l;){const d=n.children[c],y={},h=o?o[c]:void 0;h&&(y.align=h);let D={type:"element",tagName:a,properties:y,children:[]};d&&(D.children=e.all(d),e.patch(d,D),D=e.applyData(d,D)),u.push(D)}const m={type:"element",tagName:"tr",properties:{},children:e.wrap(u,!0)};return e.patch(n,m),e.applyData(n,m)}function cm(e,n){const t={type:"element",tagName:"td",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}const Is=9,Os=32;function um(e){const n=String(e),t=/\r?\n|\r/g;let r=t.exec(n),s=0;const a=[];for(;r;)a.push($s(n.slice(s,r.index),s>0,!0),r[0]),s=r.index+r[0].length,r=t.exec(n);return a.push($s(n.slice(s),s>0,!1)),a.join("")}function $s(e,n,t){let r=0,s=e.length;if(n){let a=e.codePointAt(r);for(;a===Is||a===Os;)r++,a=e.codePointAt(r)}if(t){let a=e.codePointAt(s-1);for(;a===Is||a===Os;)s--,a=e.codePointAt(s-1)}return s>r?e.slice(r,s):""}function dm(e,n){const t={type:"text",value:um(String(n.value))};return e.patch(n,t),e.applyData(n,t)}function pm(e,n){const t={type:"element",tagName:"hr",properties:{},children:[]};return e.patch(n,t),e.applyData(n,t)}const hm={blockquote:Uh,break:Mh,code:Hh,delete:Wh,emphasis:Vh,footnoteReference:Jh,heading:Qh,html:Gh,imageReference:Yh,image:Kh,inlineCode:Xh,linkReference:Zh,link:em,listItem:tm,list:rm,paragraph:im,root:am,strong:sm,table:om,tableCell:cm,tableRow:lm,text:dm,thematicBreak:pm,toml:cr,yaml:cr,definition:cr,footnoteDefinition:cr};function cr(){}function mm(e,n){const t=[{type:"text",value:"↩"}];return n>1&&t.push({type:"element",tagName:"sup",properties:{},children:[{type:"text",value:String(n)}]}),t}function fm(e,n){return"Back to reference "+(e+1)+(n>1?"-"+n:"")}function gm(e){const n=typeof e.options.clobberPrefix=="string"?e.options.clobberPrefix:"user-content-",t=e.options.footnoteBackContent||mm,r=e.options.footnoteBackLabel||fm,s=e.options.footnoteLabel||"Footnotes",a=e.options.footnoteLabelTagName||"h2",o=e.options.footnoteLabelProperties||{className:["sr-only"]},l=[];let c=-1;for(;++c<e.footnoteOrder.length;){const u=e.footnoteById.get(e.footnoteOrder[c]);if(!u)continue;const m=e.all(u),d=String(u.identifier).toUpperCase(),y=hn(d.toLowerCase());let h=0;const D=[],q=e.footnoteCounts.get(d);for(;q!==void 0&&++h<=q;){D.length>0&&D.push({type:"text",value:" "});let H=typeof t=="string"?t:t(c,h);typeof H=="string"&&(H={type:"text",value:H}),D.push({type:"element",tagName:"a",properties:{href:"#"+n+"fnref-"+y+(h>1?"-"+h:""),dataFootnoteBackref:"",ariaLabel:typeof r=="string"?r:r(c,h),className:["data-footnote-backref"]},children:Array.isArray(H)?H:[H]})}const Y=m[m.length-1];if(Y&&Y.type==="element"&&Y.tagName==="p"){const H=Y.children[Y.children.length-1];H&&H.type==="text"?H.value+=" ":Y.children.push({type:"text",value:" "}),Y.children.push(...D)}else m.push(...D);const O={type:"element",tagName:"li",properties:{id:n+"fn-"+y},children:e.wrap(m,!0)};e.patch(u,O),l.push(O)}if(l.length!==0)return{type:"element",tagName:"section",properties:{dataFootnotes:!0,className:["footnotes"]},children:[{type:"element",tagName:a,properties:{...Bn(o),id:"footnote-label"},children:[{type:"text",value:s}]},{type:"text",value:`
`},{type:"element",tagName:"ol",properties:{},children:e.wrap(l,!0)},{type:"text",value:`
`}]}}const Ai={}.hasOwnProperty,ym={};function xm(e,n){const t=n||ym,r=new Map,s=new Map,a=new Map,o={...hm,...t.handlers},l={all:u,applyData:wm,definitionById:r,footnoteById:s,footnoteCounts:a,footnoteOrder:[],handlers:o,one:c,options:t,patch:bm,wrap:_m};return bo(e,function(m){if(m.type==="definition"||m.type==="footnoteDefinition"){const d=m.type==="definition"?r:s,y=String(m.identifier).toUpperCase();d.has(y)||d.set(y,m)}}),l;function c(m,d){const y=m.type,h=l.handlers[y];if(Ai.call(l.handlers,y)&&h)return h(l,m,d);if(l.options.passThrough&&l.options.passThrough.includes(y)){if("children"in m){const{children:q,...Y}=m,O=Bn(Y);return O.children=l.all(m),O}return Bn(m)}return(l.options.unknownHandler||km)(l,m,d)}function u(m){const d=[];if("children"in m){const y=m.children;let h=-1;for(;++h<y.length;){const D=l.one(y[h],m);if(D){if(h&&y[h-1].type==="break"&&(!Array.isArray(D)&&D.type==="text"&&(D.value=Ls(D.value)),!Array.isArray(D)&&D.type==="element")){const q=D.children[0];q&&q.type==="text"&&(q.value=Ls(q.value))}Array.isArray(D)?d.push(...D):d.push(D)}}}return d}}function bm(e,n){e.position&&(n.position=Lo(e))}function wm(e,n){let t=n;if(e&&e.data){const r=e.data.hName,s=e.data.hChildren,a=e.data.hProperties;if(typeof r=="string")if(t.type==="element")t.tagName=r;else{const o="children"in t?t.children:[t];t={type:"element",tagName:r,properties:{},children:o}}t.type==="element"&&a&&Object.assign(t.properties,Bn(a)),"children"in t&&t.children&&s!==null&&s!==void 0&&(t.children=s)}return t}function km(e,n){const t=n.data||{},r="value"in n&&!(Ai.call(t,"hProperties")||Ai.call(t,"hChildren"))?{type:"text",value:n.value}:{type:"element",tagName:"div",properties:{},children:e.all(n)};return e.patch(n,r),e.applyData(n,r)}function _m(e,n){const t=[];let r=-1;for(n&&t.push({type:"text",value:`
`});++r<e.length;)r&&t.push({type:"text",value:`
`}),t.push(e[r]);return n&&e.length>0&&t.push({type:"text",value:`
`}),t}function Ls(e){let n=0,t=e.charCodeAt(n);for(;t===9||t===32;)n++,t=e.charCodeAt(n);return e.slice(n)}function Nm(e,n){const t=xm(e,n),r=t.one(e,void 0),s=gm(t),a=Array.isArray(r)?{type:"root",children:r}:r||{type:"root",children:[]};return s&&a.children.push({type:"text",value:`
`},s),a}const vm=["area","base","basefont","bgsound","br","col","command","embed","frame","hr","image","img","input","keygen","link","meta","param","source","track","wbr"];class Hn{constructor(n,t,r){this.normal=t,this.property=n,r&&(this.space=r)}}Hn.prototype.normal={};Hn.prototype.property={};Hn.prototype.space=void 0;function Uo(e,n){const t={},r={};for(const s of e)Object.assign(t,s.property),Object.assign(r,s.normal);return new Hn(t,r,n)}function Di(e){return e.toLowerCase()}class et{constructor(n,t){this.attribute=t,this.property=n}}et.prototype.attribute="";et.prototype.booleanish=!1;et.prototype.boolean=!1;et.prototype.commaOrSpaceSeparated=!1;et.prototype.commaSeparated=!1;et.prototype.defined=!1;et.prototype.mustUseProperty=!1;et.prototype.number=!1;et.prototype.overloadedBoolean=!1;et.prototype.property="";et.prototype.spaceSeparated=!1;et.prototype.space=void 0;let jm=0;const xe=Gt(),ze=Gt(),Ii=Gt(),U=Gt(),De=Gt(),un=Gt(),rt=Gt();function Gt(){return 2**++jm}const Oi=Object.freeze(Object.defineProperty({__proto__:null,boolean:xe,booleanish:ze,commaOrSpaceSeparated:rt,commaSeparated:un,number:U,overloadedBoolean:Ii,spaceSeparated:De},Symbol.toStringTag,{value:"Module"})),yi=Object.keys(Oi);class Qi extends et{constructor(n,t,r,s){let a=-1;if(super(n,t),Rs(this,"space",s),typeof r=="number")for(;++a<yi.length;){const o=yi[a];Rs(this,yi[a],(r&Oi[o])===Oi[o])}}}Qi.prototype.defined=!0;function Rs(e,n,t){t&&(e[n]=t)}function mn(e){const n={},t={};for(const[r,s]of Object.entries(e.properties)){const a=new Qi(r,e.transform(e.attributes||{},r),s,e.space);e.mustUseProperty&&e.mustUseProperty.includes(r)&&(a.mustUseProperty=!0),n[r]=a,t[Di(r)]=r,t[Di(a.attribute)]=r}return new Hn(n,t,e.space)}const Mo=mn({properties:{ariaActiveDescendant:null,ariaAtomic:ze,ariaAutoComplete:null,ariaBusy:ze,ariaChecked:ze,ariaColCount:U,ariaColIndex:U,ariaColSpan:U,ariaControls:De,ariaCurrent:null,ariaDescribedBy:De,ariaDetails:null,ariaDisabled:ze,ariaDropEffect:De,ariaErrorMessage:null,ariaExpanded:ze,ariaFlowTo:De,ariaGrabbed:ze,ariaHasPopup:null,ariaHidden:ze,ariaInvalid:null,ariaKeyShortcuts:null,ariaLabel:null,ariaLabelledBy:De,ariaLevel:U,ariaLive:null,ariaModal:ze,ariaMultiLine:ze,ariaMultiSelectable:ze,ariaOrientation:null,ariaOwns:De,ariaPlaceholder:null,ariaPosInSet:U,ariaPressed:ze,ariaReadOnly:ze,ariaRelevant:null,ariaRequired:ze,ariaRoleDescription:De,ariaRowCount:U,ariaRowIndex:U,ariaRowSpan:U,ariaSelected:ze,ariaSetSize:U,ariaSort:null,ariaValueMax:U,ariaValueMin:U,ariaValueNow:U,ariaValueText:null,role:null},transform(e,n){return n==="role"?n:"aria-"+n.slice(4).toLowerCase()}});function Ho(e,n){return n in e?e[n]:n}function Wo(e,n){return Ho(e,n.toLowerCase())}const Cm=mn({attributes:{acceptcharset:"accept-charset",classname:"class",htmlfor:"for",httpequiv:"http-equiv"},mustUseProperty:["checked","multiple","muted","selected"],properties:{abbr:null,accept:un,acceptCharset:De,accessKey:De,action:null,allow:null,allowFullScreen:xe,allowPaymentRequest:xe,allowUserMedia:xe,alt:null,as:null,async:xe,autoCapitalize:null,autoComplete:De,autoFocus:xe,autoPlay:xe,blocking:De,capture:null,charSet:null,checked:xe,cite:null,className:De,cols:U,colSpan:null,content:null,contentEditable:ze,controls:xe,controlsList:De,coords:U|un,crossOrigin:null,data:null,dateTime:null,decoding:null,default:xe,defer:xe,dir:null,dirName:null,disabled:xe,download:Ii,draggable:ze,encType:null,enterKeyHint:null,fetchPriority:null,form:null,formAction:null,formEncType:null,formMethod:null,formNoValidate:xe,formTarget:null,headers:De,height:U,hidden:Ii,high:U,href:null,hrefLang:null,htmlFor:De,httpEquiv:De,id:null,imageSizes:null,imageSrcSet:null,inert:xe,inputMode:null,integrity:null,is:null,isMap:xe,itemId:null,itemProp:De,itemRef:De,itemScope:xe,itemType:De,kind:null,label:null,lang:null,language:null,list:null,loading:null,loop:xe,low:U,manifest:null,max:null,maxLength:U,media:null,method:null,min:null,minLength:U,multiple:xe,muted:xe,name:null,nonce:null,noModule:xe,noValidate:xe,onAbort:null,onAfterPrint:null,onAuxClick:null,onBeforeMatch:null,onBeforePrint:null,onBeforeToggle:null,onBeforeUnload:null,onBlur:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onContextLost:null,onContextMenu:null,onContextRestored:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnded:null,onError:null,onFocus:null,onFormData:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLanguageChange:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadEnd:null,onLoadStart:null,onMessage:null,onMessageError:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRejectionHandled:null,onReset:null,onResize:null,onScroll:null,onScrollEnd:null,onSecurityPolicyViolation:null,onSeeked:null,onSeeking:null,onSelect:null,onSlotChange:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnhandledRejection:null,onUnload:null,onVolumeChange:null,onWaiting:null,onWheel:null,open:xe,optimum:U,pattern:null,ping:De,placeholder:null,playsInline:xe,popover:null,popoverTarget:null,popoverTargetAction:null,poster:null,preload:null,readOnly:xe,referrerPolicy:null,rel:De,required:xe,reversed:xe,rows:U,rowSpan:U,sandbox:De,scope:null,scoped:xe,seamless:xe,selected:xe,shadowRootClonable:xe,shadowRootDelegatesFocus:xe,shadowRootMode:null,shape:null,size:U,sizes:null,slot:null,span:U,spellCheck:ze,src:null,srcDoc:null,srcLang:null,srcSet:null,start:U,step:null,style:null,tabIndex:U,target:null,title:null,translate:null,type:null,typeMustMatch:xe,useMap:null,value:ze,width:U,wrap:null,writingSuggestions:null,align:null,aLink:null,archive:De,axis:null,background:null,bgColor:null,border:U,borderColor:null,bottomMargin:U,cellPadding:null,cellSpacing:null,char:null,charOff:null,classId:null,clear:null,code:null,codeBase:null,codeType:null,color:null,compact:xe,declare:xe,event:null,face:null,frame:null,frameBorder:null,hSpace:U,leftMargin:U,link:null,longDesc:null,lowSrc:null,marginHeight:U,marginWidth:U,noResize:xe,noHref:xe,noShade:xe,noWrap:xe,object:null,profile:null,prompt:null,rev:null,rightMargin:U,rules:null,scheme:null,scrolling:ze,standby:null,summary:null,text:null,topMargin:U,valueType:null,version:null,vAlign:null,vLink:null,vSpace:U,allowTransparency:null,autoCorrect:null,autoSave:null,disablePictureInPicture:xe,disableRemotePlayback:xe,prefix:null,property:null,results:U,security:null,unselectable:null},space:"html",transform:Wo}),Sm=mn({attributes:{accentHeight:"accent-height",alignmentBaseline:"alignment-baseline",arabicForm:"arabic-form",baselineShift:"baseline-shift",capHeight:"cap-height",className:"class",clipPath:"clip-path",clipRule:"clip-rule",colorInterpolation:"color-interpolation",colorInterpolationFilters:"color-interpolation-filters",colorProfile:"color-profile",colorRendering:"color-rendering",crossOrigin:"crossorigin",dataType:"datatype",dominantBaseline:"dominant-baseline",enableBackground:"enable-background",fillOpacity:"fill-opacity",fillRule:"fill-rule",floodColor:"flood-color",floodOpacity:"flood-opacity",fontFamily:"font-family",fontSize:"font-size",fontSizeAdjust:"font-size-adjust",fontStretch:"font-stretch",fontStyle:"font-style",fontVariant:"font-variant",fontWeight:"font-weight",glyphName:"glyph-name",glyphOrientationHorizontal:"glyph-orientation-horizontal",glyphOrientationVertical:"glyph-orientation-vertical",hrefLang:"hreflang",horizAdvX:"horiz-adv-x",horizOriginX:"horiz-origin-x",horizOriginY:"horiz-origin-y",imageRendering:"image-rendering",letterSpacing:"letter-spacing",lightingColor:"lighting-color",markerEnd:"marker-end",markerMid:"marker-mid",markerStart:"marker-start",navDown:"nav-down",navDownLeft:"nav-down-left",navDownRight:"nav-down-right",navLeft:"nav-left",navNext:"nav-next",navPrev:"nav-prev",navRight:"nav-right",navUp:"nav-up",navUpLeft:"nav-up-left",navUpRight:"nav-up-right",onAbort:"onabort",onActivate:"onactivate",onAfterPrint:"onafterprint",onBeforePrint:"onbeforeprint",onBegin:"onbegin",onCancel:"oncancel",onCanPlay:"oncanplay",onCanPlayThrough:"oncanplaythrough",onChange:"onchange",onClick:"onclick",onClose:"onclose",onCopy:"oncopy",onCueChange:"oncuechange",onCut:"oncut",onDblClick:"ondblclick",onDrag:"ondrag",onDragEnd:"ondragend",onDragEnter:"ondragenter",onDragExit:"ondragexit",onDragLeave:"ondragleave",onDragOver:"ondragover",onDragStart:"ondragstart",onDrop:"ondrop",onDurationChange:"ondurationchange",onEmptied:"onemptied",onEnd:"onend",onEnded:"onended",onError:"onerror",onFocus:"onfocus",onFocusIn:"onfocusin",onFocusOut:"onfocusout",onHashChange:"onhashchange",onInput:"oninput",onInvalid:"oninvalid",onKeyDown:"onkeydown",onKeyPress:"onkeypress",onKeyUp:"onkeyup",onLoad:"onload",onLoadedData:"onloadeddata",onLoadedMetadata:"onloadedmetadata",onLoadStart:"onloadstart",onMessage:"onmessage",onMouseDown:"onmousedown",onMouseEnter:"onmouseenter",onMouseLeave:"onmouseleave",onMouseMove:"onmousemove",onMouseOut:"onmouseout",onMouseOver:"onmouseover",onMouseUp:"onmouseup",onMouseWheel:"onmousewheel",onOffline:"onoffline",onOnline:"ononline",onPageHide:"onpagehide",onPageShow:"onpageshow",onPaste:"onpaste",onPause:"onpause",onPlay:"onplay",onPlaying:"onplaying",onPopState:"onpopstate",onProgress:"onprogress",onRateChange:"onratechange",onRepeat:"onrepeat",onReset:"onreset",onResize:"onresize",onScroll:"onscroll",onSeeked:"onseeked",onSeeking:"onseeking",onSelect:"onselect",onShow:"onshow",onStalled:"onstalled",onStorage:"onstorage",onSubmit:"onsubmit",onSuspend:"onsuspend",onTimeUpdate:"ontimeupdate",onToggle:"ontoggle",onUnload:"onunload",onVolumeChange:"onvolumechange",onWaiting:"onwaiting",onZoom:"onzoom",overlinePosition:"overline-position",overlineThickness:"overline-thickness",paintOrder:"paint-order",panose1:"panose-1",pointerEvents:"pointer-events",referrerPolicy:"referrerpolicy",renderingIntent:"rendering-intent",shapeRendering:"shape-rendering",stopColor:"stop-color",stopOpacity:"stop-opacity",strikethroughPosition:"strikethrough-position",strikethroughThickness:"strikethrough-thickness",strokeDashArray:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",strokeLineCap:"stroke-linecap",strokeLineJoin:"stroke-linejoin",strokeMiterLimit:"stroke-miterlimit",strokeOpacity:"stroke-opacity",strokeWidth:"stroke-width",tabIndex:"tabindex",textAnchor:"text-anchor",textDecoration:"text-decoration",textRendering:"text-rendering",transformOrigin:"transform-origin",typeOf:"typeof",underlinePosition:"underline-position",underlineThickness:"underline-thickness",unicodeBidi:"unicode-bidi",unicodeRange:"unicode-range",unitsPerEm:"units-per-em",vAlphabetic:"v-alphabetic",vHanging:"v-hanging",vIdeographic:"v-ideographic",vMathematical:"v-mathematical",vectorEffect:"vector-effect",vertAdvY:"vert-adv-y",vertOriginX:"vert-origin-x",vertOriginY:"vert-origin-y",wordSpacing:"word-spacing",writingMode:"writing-mode",xHeight:"x-height",playbackOrder:"playbackorder",timelineBegin:"timelinebegin"},properties:{about:rt,accentHeight:U,accumulate:null,additive:null,alignmentBaseline:null,alphabetic:U,amplitude:U,arabicForm:null,ascent:U,attributeName:null,attributeType:null,azimuth:U,bandwidth:null,baselineShift:null,baseFrequency:null,baseProfile:null,bbox:null,begin:null,bias:U,by:null,calcMode:null,capHeight:U,className:De,clip:null,clipPath:null,clipPathUnits:null,clipRule:null,color:null,colorInterpolation:null,colorInterpolationFilters:null,colorProfile:null,colorRendering:null,content:null,contentScriptType:null,contentStyleType:null,crossOrigin:null,cursor:null,cx:null,cy:null,d:null,dataType:null,defaultAction:null,descent:U,diffuseConstant:U,direction:null,display:null,dur:null,divisor:U,dominantBaseline:null,download:xe,dx:null,dy:null,edgeMode:null,editable:null,elevation:U,enableBackground:null,end:null,event:null,exponent:U,externalResourcesRequired:null,fill:null,fillOpacity:U,fillRule:null,filter:null,filterRes:null,filterUnits:null,floodColor:null,floodOpacity:null,focusable:null,focusHighlight:null,fontFamily:null,fontSize:null,fontSizeAdjust:null,fontStretch:null,fontStyle:null,fontVariant:null,fontWeight:null,format:null,fr:null,from:null,fx:null,fy:null,g1:un,g2:un,glyphName:un,glyphOrientationHorizontal:null,glyphOrientationVertical:null,glyphRef:null,gradientTransform:null,gradientUnits:null,handler:null,hanging:U,hatchContentUnits:null,hatchUnits:null,height:null,href:null,hrefLang:null,horizAdvX:U,horizOriginX:U,horizOriginY:U,id:null,ideographic:U,imageRendering:null,initialVisibility:null,in:null,in2:null,intercept:U,k:U,k1:U,k2:U,k3:U,k4:U,kernelMatrix:rt,kernelUnitLength:null,keyPoints:null,keySplines:null,keyTimes:null,kerning:null,lang:null,lengthAdjust:null,letterSpacing:null,lightingColor:null,limitingConeAngle:U,local:null,markerEnd:null,markerMid:null,markerStart:null,markerHeight:null,markerUnits:null,markerWidth:null,mask:null,maskContentUnits:null,maskUnits:null,mathematical:null,max:null,media:null,mediaCharacterEncoding:null,mediaContentEncodings:null,mediaSize:U,mediaTime:null,method:null,min:null,mode:null,name:null,navDown:null,navDownLeft:null,navDownRight:null,navLeft:null,navNext:null,navPrev:null,navRight:null,navUp:null,navUpLeft:null,navUpRight:null,numOctaves:null,observer:null,offset:null,onAbort:null,onActivate:null,onAfterPrint:null,onBeforePrint:null,onBegin:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnd:null,onEnded:null,onError:null,onFocus:null,onFocusIn:null,onFocusOut:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadStart:null,onMessage:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onMouseWheel:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRepeat:null,onReset:null,onResize:null,onScroll:null,onSeeked:null,onSeeking:null,onSelect:null,onShow:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnload:null,onVolumeChange:null,onWaiting:null,onZoom:null,opacity:null,operator:null,order:null,orient:null,orientation:null,origin:null,overflow:null,overlay:null,overlinePosition:U,overlineThickness:U,paintOrder:null,panose1:null,path:null,pathLength:U,patternContentUnits:null,patternTransform:null,patternUnits:null,phase:null,ping:De,pitch:null,playbackOrder:null,pointerEvents:null,points:null,pointsAtX:U,pointsAtY:U,pointsAtZ:U,preserveAlpha:null,preserveAspectRatio:null,primitiveUnits:null,propagate:null,property:rt,r:null,radius:null,referrerPolicy:null,refX:null,refY:null,rel:rt,rev:rt,renderingIntent:null,repeatCount:null,repeatDur:null,requiredExtensions:rt,requiredFeatures:rt,requiredFonts:rt,requiredFormats:rt,resource:null,restart:null,result:null,rotate:null,rx:null,ry:null,scale:null,seed:null,shapeRendering:null,side:null,slope:null,snapshotTime:null,specularConstant:U,specularExponent:U,spreadMethod:null,spacing:null,startOffset:null,stdDeviation:null,stemh:null,stemv:null,stitchTiles:null,stopColor:null,stopOpacity:null,strikethroughPosition:U,strikethroughThickness:U,string:null,stroke:null,strokeDashArray:rt,strokeDashOffset:null,strokeLineCap:null,strokeLineJoin:null,strokeMiterLimit:U,strokeOpacity:U,strokeWidth:null,style:null,surfaceScale:U,syncBehavior:null,syncBehaviorDefault:null,syncMaster:null,syncTolerance:null,syncToleranceDefault:null,systemLanguage:rt,tabIndex:U,tableValues:null,target:null,targetX:U,targetY:U,textAnchor:null,textDecoration:null,textRendering:null,textLength:null,timelineBegin:null,title:null,transformBehavior:null,type:null,typeOf:rt,to:null,transform:null,transformOrigin:null,u1:null,u2:null,underlinePosition:U,underlineThickness:U,unicode:null,unicodeBidi:null,unicodeRange:null,unitsPerEm:U,values:null,vAlphabetic:U,vMathematical:U,vectorEffect:null,vHanging:U,vIdeographic:U,version:null,vertAdvY:U,vertOriginX:U,vertOriginY:U,viewBox:null,viewTarget:null,visibility:null,width:null,widths:null,wordSpacing:null,writingMode:null,x:null,x1:null,x2:null,xChannelSelector:null,xHeight:U,y:null,y1:null,y2:null,yChannelSelector:null,z:null,zoomAndPan:null},space:"svg",transform:Ho}),Vo=mn({properties:{xLinkActuate:null,xLinkArcRole:null,xLinkHref:null,xLinkRole:null,xLinkShow:null,xLinkTitle:null,xLinkType:null},space:"xlink",transform(e,n){return"xlink:"+n.slice(5).toLowerCase()}}),Jo=mn({attributes:{xmlnsxlink:"xmlns:xlink"},properties:{xmlnsXLink:null,xmlns:null},space:"xmlns",transform:Wo}),Qo=mn({properties:{xmlBase:null,xmlLang:null,xmlSpace:null},space:"xml",transform(e,n){return"xml:"+n.slice(3).toLowerCase()}}),Pm=/[A-Z]/g,Fs=/-[a-z]/g,Tm=/^data[-\w.:]+$/i;function Em(e,n){const t=Di(n);let r=n,s=et;if(t in e.normal)return e.property[e.normal[t]];if(t.length>4&&t.slice(0,4)==="data"&&Tm.test(n)){if(n.charAt(4)==="-"){const a=n.slice(5).replace(Fs,Dm);r="data"+a.charAt(0).toUpperCase()+a.slice(1)}else{const a=n.slice(4);if(!Fs.test(a)){let o=a.replace(Pm,Am);o.charAt(0)!=="-"&&(o="-"+o),n="data"+o}}s=Qi}return new s(r,n)}function Am(e){return"-"+e.toLowerCase()}function Dm(e){return e.charAt(1).toUpperCase()}const Im=Uo([Mo,Cm,Vo,Jo,Qo],"html"),Go=Uo([Mo,Sm,Vo,Jo,Qo],"svg"),Om=/["&'<>`]/g,$m=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,Lm=/[\x01-\t\v\f\x0E-\x1F\x7F\x81\x8D\x8F\x90\x9D\xA0-\uFFFF]/g,Rm=/[|\\{}()[\]^$+*?.]/g,zs=new WeakMap;function Fm(e,n){if(e=e.replace(n.subset?zm(n.subset):Om,r),n.subset||n.escapeOnly)return e;return e.replace($m,t).replace(Lm,r);function t(s,a,o){return n.format((s.charCodeAt(0)-55296)*1024+s.charCodeAt(1)-56320+65536,o.charCodeAt(a+2),n)}function r(s,a,o){return n.format(s.charCodeAt(0),o.charCodeAt(a+1),n)}}function zm(e){let n=zs.get(e);return n||(n=qm(e),zs.set(e,n)),n}function qm(e){const n=[];let t=-1;for(;++t<e.length;)n.push(e[t].replace(Rm,"\\$&"));return new RegExp("(?:"+n.join("|")+")","g")}const Bm=/[\dA-Fa-f]/;function Um(e,n,t){const r="&#x"+e.toString(16).toUpperCase();return t&&n&&!Bm.test(String.fromCharCode(n))?r:r+";"}const Mm=/\d/;function Hm(e,n,t){const r="&#"+String(e);return t&&n&&!Mm.test(String.fromCharCode(n))?r:r+";"}const Wm=["AElig","AMP","Aacute","Acirc","Agrave","Aring","Atilde","Auml","COPY","Ccedil","ETH","Eacute","Ecirc","Egrave","Euml","GT","Iacute","Icirc","Igrave","Iuml","LT","Ntilde","Oacute","Ocirc","Ograve","Oslash","Otilde","Ouml","QUOT","REG","THORN","Uacute","Ucirc","Ugrave","Uuml","Yacute","aacute","acirc","acute","aelig","agrave","amp","aring","atilde","auml","brvbar","ccedil","cedil","cent","copy","curren","deg","divide","eacute","ecirc","egrave","eth","euml","frac12","frac14","frac34","gt","iacute","icirc","iexcl","igrave","iquest","iuml","laquo","lt","macr","micro","middot","nbsp","not","ntilde","oacute","ocirc","ograve","ordf","ordm","oslash","otilde","ouml","para","plusmn","pound","quot","raquo","reg","sect","shy","sup1","sup2","sup3","szlig","thorn","times","uacute","ucirc","ugrave","uml","uuml","yacute","yen","yuml"],xi={nbsp:" ",iexcl:"¡",cent:"¢",pound:"£",curren:"¤",yen:"¥",brvbar:"¦",sect:"§",uml:"¨",copy:"©",ordf:"ª",laquo:"«",not:"¬",shy:"­",reg:"®",macr:"¯",deg:"°",plusmn:"±",sup2:"²",sup3:"³",acute:"´",micro:"µ",para:"¶",middot:"·",cedil:"¸",sup1:"¹",ordm:"º",raquo:"»",frac14:"¼",frac12:"½",frac34:"¾",iquest:"¿",Agrave:"À",Aacute:"Á",Acirc:"Â",Atilde:"Ã",Auml:"Ä",Aring:"Å",AElig:"Æ",Ccedil:"Ç",Egrave:"È",Eacute:"É",Ecirc:"Ê",Euml:"Ë",Igrave:"Ì",Iacute:"Í",Icirc:"Î",Iuml:"Ï",ETH:"Ð",Ntilde:"Ñ",Ograve:"Ò",Oacute:"Ó",Ocirc:"Ô",Otilde:"Õ",Ouml:"Ö",times:"×",Oslash:"Ø",Ugrave:"Ù",Uacute:"Ú",Ucirc:"Û",Uuml:"Ü",Yacute:"Ý",THORN:"Þ",szlig:"ß",agrave:"à",aacute:"á",acirc:"â",atilde:"ã",auml:"ä",aring:"å",aelig:"æ",ccedil:"ç",egrave:"è",eacute:"é",ecirc:"ê",euml:"ë",igrave:"ì",iacute:"í",icirc:"î",iuml:"ï",eth:"ð",ntilde:"ñ",ograve:"ò",oacute:"ó",ocirc:"ô",otilde:"õ",ouml:"ö",divide:"÷",oslash:"ø",ugrave:"ù",uacute:"ú",ucirc:"û",uuml:"ü",yacute:"ý",thorn:"þ",yuml:"ÿ",fnof:"ƒ",Alpha:"Α",Beta:"Β",Gamma:"Γ",Delta:"Δ",Epsilon:"Ε",Zeta:"Ζ",Eta:"Η",Theta:"Θ",Iota:"Ι",Kappa:"Κ",Lambda:"Λ",Mu:"Μ",Nu:"Ν",Xi:"Ξ",Omicron:"Ο",Pi:"Π",Rho:"Ρ",Sigma:"Σ",Tau:"Τ",Upsilon:"Υ",Phi:"Φ",Chi:"Χ",Psi:"Ψ",Omega:"Ω",alpha:"α",beta:"β",gamma:"γ",delta:"δ",epsilon:"ε",zeta:"ζ",eta:"η",theta:"θ",iota:"ι",kappa:"κ",lambda:"λ",mu:"μ",nu:"ν",xi:"ξ",omicron:"ο",pi:"π",rho:"ρ",sigmaf:"ς",sigma:"σ",tau:"τ",upsilon:"υ",phi:"φ",chi:"χ",psi:"ψ",omega:"ω",thetasym:"ϑ",upsih:"ϒ",piv:"ϖ",bull:"•",hellip:"…",prime:"′",Prime:"″",oline:"‾",frasl:"⁄",weierp:"℘",image:"ℑ",real:"ℜ",trade:"™",alefsym:"ℵ",larr:"←",uarr:"↑",rarr:"→",darr:"↓",harr:"↔",crarr:"↵",lArr:"⇐",uArr:"⇑",rArr:"⇒",dArr:"⇓",hArr:"⇔",forall:"∀",part:"∂",exist:"∃",empty:"∅",nabla:"∇",isin:"∈",notin:"∉",ni:"∋",prod:"∏",sum:"∑",minus:"−",lowast:"∗",radic:"√",prop:"∝",infin:"∞",ang:"∠",and:"∧",or:"∨",cap:"∩",cup:"∪",int:"∫",there4:"∴",sim:"∼",cong:"≅",asymp:"≈",ne:"≠",equiv:"≡",le:"≤",ge:"≥",sub:"⊂",sup:"⊃",nsub:"⊄",sube:"⊆",supe:"⊇",oplus:"⊕",otimes:"⊗",perp:"⊥",sdot:"⋅",lceil:"⌈",rceil:"⌉",lfloor:"⌊",rfloor:"⌋",lang:"〈",rang:"〉",loz:"◊",spades:"♠",clubs:"♣",hearts:"♥",diams:"♦",quot:'"',amp:"&",lt:"<",gt:">",OElig:"Œ",oelig:"œ",Scaron:"Š",scaron:"š",Yuml:"Ÿ",circ:"ˆ",tilde:"˜",ensp:" ",emsp:" ",thinsp:" ",zwnj:"‌",zwj:"‍",lrm:"‎",rlm:"‏",ndash:"–",mdash:"—",lsquo:"‘",rsquo:"’",sbquo:"‚",ldquo:"“",rdquo:"”",bdquo:"„",dagger:"†",Dagger:"‡",permil:"‰",lsaquo:"‹",rsaquo:"›",euro:"€"},Vm=["cent","copy","divide","gt","lt","not","para","times"],Yo={}.hasOwnProperty,$i={};let ur;for(ur in xi)Yo.call(xi,ur)&&($i[xi[ur]]=ur);const Jm=/[^\dA-Za-z]/;function Qm(e,n,t,r){const s=String.fromCharCode(e);if(Yo.call($i,s)){const a=$i[s],o="&"+a;return t&&Wm.includes(a)&&!Vm.includes(a)&&(!r||n&&n!==61&&Jm.test(String.fromCharCode(n)))?o:o+";"}return""}function Gm(e,n,t){let r=Um(e,n,t.omitOptionalSemicolons),s;if((t.useNamedReferences||t.useShortestReferences)&&(s=Qm(e,n,t.omitOptionalSemicolons,t.attribute)),(t.useShortestReferences||!s)&&t.useShortestReferences){const a=Hm(e,n,t.omitOptionalSemicolons);a.length<r.length&&(r=a)}return s&&(!t.useShortestReferences||s.length<r.length)?s:r}function dn(e,n){return Fm(e,Object.assign({format:Gm},n))}const Ym=/^>|^->|<!--|-->|--!>|<!-$/g,Km=[">"],Xm=["<",">"];function Zm(e,n,t,r){return r.settings.bogusComments?"<?"+dn(e.value,Object.assign({},r.settings.characterReferences,{subset:Km}))+">":"<!--"+e.value.replace(Ym,s)+"-->";function s(a){return dn(a,Object.assign({},r.settings.characterReferences,{subset:Xm}))}}function ef(e,n,t,r){return"<!"+(r.settings.upperDoctype?"DOCTYPE":"doctype")+(r.settings.tightDoctype?"":" ")+"html>"}function qs(e,n){const t=String(e);if(typeof n!="string")throw new TypeError("Expected character");let r=0,s=t.indexOf(n);for(;s!==-1;)r++,s=t.indexOf(n,s+n.length);return r}function tf(e,n){const t=n||{};return(e[e.length-1]===""?[...e,""]:e).join((t.padRight?" ":"")+","+(t.padLeft===!1?"":" ")).trim()}function nf(e){return e.join(" ").trim()}const rf=/[ \t\n\f\r]/g;function Gi(e){return typeof e=="object"?e.type==="text"?Bs(e.value):!1:Bs(e)}function Bs(e){return e.replace(rf,"")===""}const Be=Xo(1),Ko=Xo(-1),af=[];function Xo(e){return n;function n(t,r,s){const a=t?t.children:af;let o=(r||0)+e,l=a[o];if(!s)for(;l&&Gi(l);)o+=e,l=a[o];return l}}const sf={}.hasOwnProperty;function Zo(e){return n;function n(t,r,s){return sf.call(e,t.tagName)&&e[t.tagName](t,r,s)}}const Yi=Zo({body:lf,caption:bi,colgroup:bi,dd:pf,dt:df,head:bi,html:of,li:uf,optgroup:hf,option:mf,p:cf,rp:Us,rt:Us,tbody:gf,td:Ms,tfoot:yf,th:Ms,thead:ff,tr:xf});function bi(e,n,t){const r=Be(t,n,!0);return!r||r.type!=="comment"&&!(r.type==="text"&&Gi(r.value.charAt(0)))}function of(e,n,t){const r=Be(t,n);return!r||r.type!=="comment"}function lf(e,n,t){const r=Be(t,n);return!r||r.type!=="comment"}function cf(e,n,t){const r=Be(t,n);return r?r.type==="element"&&(r.tagName==="address"||r.tagName==="article"||r.tagName==="aside"||r.tagName==="blockquote"||r.tagName==="details"||r.tagName==="div"||r.tagName==="dl"||r.tagName==="fieldset"||r.tagName==="figcaption"||r.tagName==="figure"||r.tagName==="footer"||r.tagName==="form"||r.tagName==="h1"||r.tagName==="h2"||r.tagName==="h3"||r.tagName==="h4"||r.tagName==="h5"||r.tagName==="h6"||r.tagName==="header"||r.tagName==="hgroup"||r.tagName==="hr"||r.tagName==="main"||r.tagName==="menu"||r.tagName==="nav"||r.tagName==="ol"||r.tagName==="p"||r.tagName==="pre"||r.tagName==="section"||r.tagName==="table"||r.tagName==="ul"):!t||!(t.type==="element"&&(t.tagName==="a"||t.tagName==="audio"||t.tagName==="del"||t.tagName==="ins"||t.tagName==="map"||t.tagName==="noscript"||t.tagName==="video"))}function uf(e,n,t){const r=Be(t,n);return!r||r.type==="element"&&r.tagName==="li"}function df(e,n,t){const r=Be(t,n);return!!(r&&r.type==="element"&&(r.tagName==="dt"||r.tagName==="dd"))}function pf(e,n,t){const r=Be(t,n);return!r||r.type==="element"&&(r.tagName==="dt"||r.tagName==="dd")}function Us(e,n,t){const r=Be(t,n);return!r||r.type==="element"&&(r.tagName==="rp"||r.tagName==="rt")}function hf(e,n,t){const r=Be(t,n);return!r||r.type==="element"&&r.tagName==="optgroup"}function mf(e,n,t){const r=Be(t,n);return!r||r.type==="element"&&(r.tagName==="option"||r.tagName==="optgroup")}function ff(e,n,t){const r=Be(t,n);return!!(r&&r.type==="element"&&(r.tagName==="tbody"||r.tagName==="tfoot"))}function gf(e,n,t){const r=Be(t,n);return!r||r.type==="element"&&(r.tagName==="tbody"||r.tagName==="tfoot")}function yf(e,n,t){return!Be(t,n)}function xf(e,n,t){const r=Be(t,n);return!r||r.type==="element"&&r.tagName==="tr"}function Ms(e,n,t){const r=Be(t,n);return!r||r.type==="element"&&(r.tagName==="td"||r.tagName==="th")}const bf=Zo({body:_f,colgroup:Nf,head:kf,html:wf,tbody:vf});function wf(e){const n=Be(e,-1);return!n||n.type!=="comment"}function kf(e){const n=new Set;for(const r of e.children)if(r.type==="element"&&(r.tagName==="base"||r.tagName==="title")){if(n.has(r.tagName))return!1;n.add(r.tagName)}const t=e.children[0];return!t||t.type==="element"}function _f(e){const n=Be(e,-1,!0);return!n||n.type!=="comment"&&!(n.type==="text"&&Gi(n.value.charAt(0)))&&!(n.type==="element"&&(n.tagName==="meta"||n.tagName==="link"||n.tagName==="script"||n.tagName==="style"||n.tagName==="template"))}function Nf(e,n,t){const r=Ko(t,n),s=Be(e,-1,!0);return t&&r&&r.type==="element"&&r.tagName==="colgroup"&&Yi(r,t.children.indexOf(r),t)?!1:!!(s&&s.type==="element"&&s.tagName==="col")}function vf(e,n,t){const r=Ko(t,n),s=Be(e,-1);return t&&r&&r.type==="element"&&(r.tagName==="thead"||r.tagName==="tbody")&&Yi(r,t.children.indexOf(r),t)?!1:!!(s&&s.type==="element"&&s.tagName==="tr")}const dr={name:[[`	
\f\r &/=>`.split(""),`	
\f\r "&'/=>\``.split("")],[`\0	
\f\r "&'/<=>`.split(""),`\0	
\f\r "&'/<=>\``.split("")]],unquoted:[[`	
\f\r &>`.split(""),`\0	
\f\r "&'<=>\``.split("")],[`\0	
\f\r "&'<=>\``.split(""),`\0	
\f\r "&'<=>\``.split("")]],single:[["&'".split(""),"\"&'`".split("")],["\0&'".split(""),"\0\"&'`".split("")]],double:[['"&'.split(""),"\"&'`".split("")],['\0"&'.split(""),"\0\"&'`".split("")]]};function jf(e,n,t,r){const s=r.schema,a=s.space==="svg"?!1:r.settings.omitOptionalTags;let o=s.space==="svg"?r.settings.closeEmptyElements:r.settings.voids.includes(e.tagName.toLowerCase());const l=[];let c;s.space==="html"&&e.tagName==="svg"&&(r.schema=Go);const u=Cf(r,e.properties),m=r.all(s.space==="html"&&e.tagName==="template"?e.content:e);return r.schema=s,m&&(o=!1),(u||!a||!bf(e,n,t))&&(l.push("<",e.tagName,u?" "+u:""),o&&(s.space==="svg"||r.settings.closeSelfClosing)&&(c=u.charAt(u.length-1),(!r.settings.tightSelfClosing||c==="/"||c&&c!=='"'&&c!=="'")&&l.push(" "),l.push("/")),l.push(">")),l.push(m),!o&&(!a||!Yi(e,n,t))&&l.push("</"+e.tagName+">"),l.join("")}function Cf(e,n){const t=[];let r=-1,s;if(n){for(s in n)if(n[s]!==null&&n[s]!==void 0){const a=Sf(e,s,n[s]);a&&t.push(a)}}for(;++r<t.length;){const a=e.settings.tightAttributes?t[r].charAt(t[r].length-1):void 0;r!==t.length-1&&a!=='"'&&a!=="'"&&(t[r]+=" ")}return t.join("")}function Sf(e,n,t){const r=Em(e.schema,n),s=e.settings.allowParseErrors&&e.schema.space==="html"?0:1,a=e.settings.allowDangerousCharacters?0:1;let o=e.quote,l;if(r.overloadedBoolean&&(t===r.attribute||t==="")?t=!0:(r.boolean||r.overloadedBoolean)&&(typeof t!="string"||t===r.attribute||t==="")&&(t=!!t),t==null||t===!1||typeof t=="number"&&Number.isNaN(t))return"";const c=dn(r.attribute,Object.assign({},e.settings.characterReferences,{subset:dr.name[s][a]}));return t===!0||(t=Array.isArray(t)?(r.commaSeparated?tf:nf)(t,{padLeft:!e.settings.tightCommaSeparatedLists}):String(t),e.settings.collapseEmptyAttributes&&!t)?c:(e.settings.preferUnquoted&&(l=dn(t,Object.assign({},e.settings.characterReferences,{attribute:!0,subset:dr.unquoted[s][a]}))),l!==t&&(e.settings.quoteSmart&&qs(t,o)>qs(t,e.alternative)&&(o=e.alternative),l=o+dn(t,Object.assign({},e.settings.characterReferences,{subset:(o==="'"?dr.single:dr.double)[s][a],attribute:!0}))+o),c+(l&&"="+l))}const Pf=["<","&"];function el(e,n,t,r){return t&&t.type==="element"&&(t.tagName==="script"||t.tagName==="style")?e.value:dn(e.value,Object.assign({},r.settings.characterReferences,{subset:Pf}))}function Tf(e,n,t,r){return r.settings.allowDangerousHtml?e.value:el(e,n,t,r)}function Ef(e,n,t,r){return r.all(e)}const Af=mo("type",{invalid:Df,unknown:If,handlers:{comment:Zm,doctype:ef,element:jf,raw:Tf,root:Ef,text:el}});function Df(e){throw new Error("Expected node, not `"+e+"`")}function If(e){const n=e;throw new Error("Cannot compile unknown node `"+n.type+"`")}const Of={},$f={},Lf=[];function Rf(e,n){const t=n||Of,r=t.quote||'"',s=r==='"'?"'":'"';if(r!=='"'&&r!=="'")throw new Error("Invalid quote `"+r+"`, expected `'` or `\"`");return{one:Ff,all:zf,settings:{omitOptionalTags:t.omitOptionalTags||!1,allowParseErrors:t.allowParseErrors||!1,allowDangerousCharacters:t.allowDangerousCharacters||!1,quoteSmart:t.quoteSmart||!1,preferUnquoted:t.preferUnquoted||!1,tightAttributes:t.tightAttributes||!1,upperDoctype:t.upperDoctype||!1,tightDoctype:t.tightDoctype||!1,bogusComments:t.bogusComments||!1,tightCommaSeparatedLists:t.tightCommaSeparatedLists||!1,tightSelfClosing:t.tightSelfClosing||!1,collapseEmptyAttributes:t.collapseEmptyAttributes||!1,allowDangerousHtml:t.allowDangerousHtml||!1,voids:t.voids||vm,characterReferences:t.characterReferences||$f,closeSelfClosing:t.closeSelfClosing||!1,closeEmptyElements:t.closeEmptyElements||!1},schema:t.space==="svg"?Go:Im,quote:r,alternative:s}.one(Array.isArray(e)?{type:"root",children:e}:e,void 0,void 0)}function Ff(e,n,t){return Af(e,n,t,this)}function zf(e){const n=[],t=e&&e.children||Lf;let r=-1;for(;++r<t.length;)n[r]=this.one(t[r],r,e);return n.join("")}const qf={};function wi(e){const n=this,{handlers:t,sanitize:r,...s}=e||qf;let a=!1,o;typeof r=="boolean"?a=!r:r&&(o=r),n.compiler=l;function l(c,u){const m=Nm(c,{handlers:t,allowDangerousHtml:a}),d=a?m:Ih(m,o),y=Rf(d,{...s,allowDangerousHtml:a});return u.extname&&(u.extname=".html"),c&&c.type==="root"&&y&&/[^\r\n]/.test(y.charAt(y.length-1))?y+`
`:y}}const Bf=({isOpen:e,onClose:n,patientId:t,pharmacyInventory:r,fetchPharmacyOrdersData:s,isLoadingInventory:a=!1})=>{const[o,l]=w.useState([]),[c,u]=w.useState(""),[m,d]=w.useState([]),[y,h]=w.useState(null),[D,q]=w.useState(!1);Ks(void 0,e?200:99999);const Y=w.useMemo(()=>new Hs(r,{keys:["name"],threshold:.3}),[r]);w.useEffect(()=>{if(!c){d([]);return}const F=Y.search(c).map(j=>j.item);d(F.slice(0,10))},[c,Y]);const O=async()=>{if(!t){h("Patient ID is missing.");return}if(o.length===0){h("Please select at least one drug.");return}for(const F of o)if(F.selected_pack_quantity===0&&F.selected_loose_quantity===0){h(`Please specify a quantity for ${F.name}.`);return}q(!0),h(null);try{const F={patient_id:t,items:o.map(X=>({drug_id:X.id,name:X.name,pack_quantity:X.selected_pack_quantity,loose_quantity:X.selected_loose_quantity,pack_price:0,loose_price:0,total_price:0,tabletsPerDay:1,numberOfDays:1,directions_to_use:"As directed"})),order_total:0,prescription_for_unavailable_drugs:""},j=await K("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(F)});if(!j.ok){const X=await j.json().catch(()=>({}));throw new Error(X.message||`Failed to create pharmacy order: ${j.statusText} `)}await j.json(),s(t),n(),l([]),u("")}catch(F){h(`Order Creation Error: ${F.message} `)}finally{q(!1)}},H=F=>{if(o.some(j=>j.id===F.id)){h(`${F.name} is already in the order.`),setTimeout(()=>h(null),3e3),u(""),d([]);return}l(j=>[...j,{...F,selected_pack_quantity:0,selected_loose_quantity:0}]),u(""),d([])},L=F=>{l(j=>j.filter(X=>X.id!==F))},W=(F,j,X)=>{const le=parseInt(X)||0;l(ne=>ne.map(oe=>oe.id===F?{...oe,[j==="pack"?"selected_pack_quantity":"selected_loose_quantity"]:le}:oe))};return e?i.jsx("div",{className:se.modalOverlay,children:i.jsxs("div",{className:se.modalContent,children:[i.jsxs("div",{className:se.modalHeader,children:[i.jsx("h3",{className:se.modalTitle,children:"Create Pharmacy Order"}),i.jsx("button",{onClick:n,className:se.modalCloseButton,children:i.jsx(pn,{size:20})})]}),i.jsxs("div",{className:se.modalBody,children:[y&&i.jsx("div",{className:se.errorText,children:y}),i.jsxs("div",{className:se.formGroup,style:{position:"relative"},children:[i.jsx("label",{htmlFor:"drug-search",children:"Add Drug"}),i.jsx("input",{type:"text",id:"drug-search",placeholder:"Search available drugs...",value:c,onChange:F=>u(F.target.value),className:se.inputField,autoComplete:"off"}),c&&i.jsx("div",{className:se.searchResultsCard,children:a?i.jsx("div",{className:"p-2 space-y-2",children:[1,2,3].map(F=>i.jsxs("div",{className:"flex justify-between items-center py-2 px-3",children:[i.jsx(Ce,{width:"60%",height:20}),i.jsx(Ce,{width:"30%",height:20})]},F))}):m.length>0?i.jsx("ul",{className:se.searchResultsList,children:m.map(F=>i.jsx("li",{onClick:()=>H(F),className:se.searchResultItem,children:i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"},children:[i.jsx("span",{children:F.name}),i.jsxs("span",{className:se.searchResultPrice,children:["Stock: ",F.stock," (Box) / ",F.loose||0," (Loose)"]})]})},F.id))}):i.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No drugs found."})})]}),i.jsxs("div",{className:se.selectedTestsCard,children:[" ",i.jsx("h4",{className:se.selectedTestsHeader,children:"Selected Drugs"}),o.length===0?i.jsx("p",{className:se.noTestsMessage,children:"No drugs added yet."}):i.jsx("ul",{className:se.selectedTestsList,children:o.map(F=>i.jsxs("li",{className:se.selectedTestItem,style:{flexDirection:"column",alignItems:"flex-start",gap:"8px"},children:[i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",width:"100%",alignItems:"center"},children:[i.jsx("span",{className:se.selectedTestName,style:{fontWeight:"bold"},children:F.name}),i.jsx("button",{type:"button",onClick:()=>L(String(F.id)),className:se.removeTestButton,title:"Remove Drug",children:i.jsx(ht,{size:16})})]}),i.jsxs("div",{style:{display:"flex",gap:"10px",alignItems:"center",width:"100%"},children:[i.jsxs("div",{style:{flex:1},children:[i.jsx("label",{style:{fontSize:"0.75rem",color:"#666"},children:"Packs"}),i.jsx("input",{type:"number",min:"0",className:se.inputField,style:{padding:"4px 8px"},value:F.selected_pack_quantity||"",onChange:j=>W(F.id,"pack",j.target.value),placeholder:"0"})]}),i.jsxs("div",{style:{flex:1},children:[i.jsx("label",{style:{fontSize:"0.75rem",color:"#666"},children:"Loose"}),i.jsx("input",{type:"number",min:"0",className:se.inputField,style:{padding:"4px 8px"},value:F.selected_loose_quantity||"",onChange:j=>W(F.id,"loose",j.target.value),placeholder:"0"})]})]})]},F.id))})]})]}),i.jsxs("div",{className:se.modalFooter,children:[i.jsx("button",{type:"button",onClick:n,className:`${se.button} ${se.buttonSecondary} `,children:" Cancel "}),i.jsxs("button",{type:"button",onClick:O,disabled:o.length===0||D,className:`${se.button} ${se.buttonPrimary} ${o.length===0||D?se.buttonDisabled:""} `,children:[" ",D?"Creating...":"Create Order"," "]})]})]})}):null},Uf=({isOpen:e,onClose:n,onSuccess:t,patientId:r,initialItems:s})=>{const[a,o]=w.useState([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:"",packs:0,loose:0,pack_size:1}]),[l,c]=w.useState(30),[u,m]=w.useState(""),[d,y]=w.useState(null),[h,D]=w.useState(""),[q,Y]=w.useState([]),[O,H]=w.useState(!1),[L,W]=w.useState(!1),[F,j]=w.useState(null),X=w.useRef(null);w.useEffect(()=>{if(e){s&&s.length>0?o(s):o([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:"",packs:0,loose:0,pack_size:1}]);const A=new Date;A.setDate(A.getDate()+30),m(A.toISOString().split("T")[0]),c(30)}},[e,s]);const le=w.useCallback(async A=>{if(!A.trim()){Y([]);return}H(!0);try{const M=await K(`/api/drugs?search=${encodeURIComponent(A)}&limit=10`);if(M.ok){const J=await M.json();Y(J.drugs||[])}}catch(M){console.error("Error searching drugs:",M)}finally{H(!1)}},[]);w.useEffect(()=>{X.current&&clearTimeout(X.current),h&&d!==null?X.current=setTimeout(()=>le(h),300):Y([])},[h,d,le]);const ne=A=>{if(!A)return 1;const M=A.match(/(?:\d+x)?(\d+)(?:s|tabs)?/i);return M?parseInt(M[1],10):1},oe=(A,M)=>{const J=[...a];J[M]={...J[M],medication_name:A.name,drug_id:A.id,pack_size:ne(A.pack),packs:0,loose:0,quantity:0},o(J),y(null),D(""),Y([])},V=(A,M,J)=>{const je=[...a],pe={...je[A]},x=pe.pack_size||1;if(M==="packs"||M==="loose"){const Oe=parseInt(J)||0;M==="packs"&&(pe.packs=Oe),M==="loose"&&(pe.loose=Oe);const Fe=pe.packs||0,b=pe.loose||0;pe.quantity=Fe*x+b}else if(M==="tablets_per_day"||M==="number_of_days"){M==="tablets_per_day"&&(pe.tablets_per_day=J),M==="number_of_days"&&(pe.number_of_days=J);const Oe=parseFloat(pe.tablets_per_day.toString())||0,Fe=parseInt(pe.number_of_days.toString())||0,b=Math.ceil(Oe*Fe);pe.quantity=b,pe.packs=Math.floor(b/x),pe.loose=b%x}else pe[M]=J;je[A]=pe,o(je)},k=()=>{o([...a,{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:l,directions:"",notes:"",packs:0,loose:0,pack_size:1}])},C=A=>{a.length>1&&o(a.filter((M,J)=>J!==A))},G=async A=>{if(A.preventDefault(),j(null),!r){j("Patient ID is missing.");return}if(a.some(J=>!J.medication_name||J.quantity<=0)){j("Please ensure all items have a medication name and valid quantity.");return}W(!0);try{const J={patient_id:r,items:a.map(pe=>({medication_name:pe.medication_name,drug_id:pe.drug_id,quantity:pe.quantity,tablets_per_day:pe.tablets_per_day,number_of_days:pe.number_of_days,directions:pe.directions,notes:pe.notes,frequency_days:l,next_delivery_date:u}))},je=await K("/api/recurring-medications",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(J)});if(!je.ok){const pe=await je.json();throw new Error(pe.message+(pe.error?": "+pe.error:"")||"Failed to create recurring medication.")}t(),n()}catch(J){j(J.message)}finally{W(!1)}};return e?i.jsx("div",{className:"modal-overlay",children:i.jsxs("div",{className:"add-recurring-modal",style:{maxWidth:"800px",width:"95%"},children:[i.jsxs("div",{className:"modal-header",children:[i.jsx("h3",{children:"Add Recurring Medications"}),i.jsx("button",{className:"close-btn",onClick:n,children:i.jsx(pn,{size:20})})]}),i.jsxs("div",{className:"modal-body",children:[F&&i.jsx("div",{className:"error-message",children:F}),i.jsxs("form",{onSubmit:G,className:"recurring-form",children:[i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsxs("label",{children:[i.jsx(Qs,{size:16})," Frequency"]}),i.jsxs("select",{value:l,onChange:A=>{const M=parseInt(A.target.value);c(M);const J=new Date;J.setDate(J.getDate()+M),m(J.toISOString().split("T")[0]);const je=a.map(pe=>({...pe,number_of_days:M}));o(je)},children:[i.jsx("option",{value:15,children:"Every 15 Days"}),i.jsx("option",{value:30,children:"Every 30 Days"}),i.jsx("option",{value:60,children:"Every 60 Days"}),i.jsx("option",{value:90,children:"Every 90 Days"})]})]}),i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsxs("label",{children:[i.jsx(yr,{size:16})," Next Delivery"]}),i.jsx("input",{type:"date",value:u,onChange:A=>m(A.target.value)})]})]}),i.jsx("hr",{className:"divider"}),i.jsxs("div",{className:"items-header",children:[i.jsx("h4",{children:"Medications"}),i.jsxs("button",{type:"button",className:"add-item-btn",onClick:k,children:[i.jsx(pr,{size:14})," Add Drug"]})]}),i.jsx("div",{className:"items-list",children:a.map((A,M)=>i.jsxs("div",{className:"medication-item-row",children:[i.jsxs("div",{className:"row-top",children:[i.jsxs("div",{className:"form-group med-search-group",children:[i.jsx("label",{children:"Drug Name"}),i.jsxs("div",{className:"search-wrapper",children:[i.jsx("input",{type:"text",placeholder:"Search drug...",value:d===M?h:A.medication_name,onFocus:()=>{y(M),D(A.medication_name)},onChange:J=>{D(J.target.value),V(M,"medication_name",J.target.value)}}),d===M&&O&&i.jsx("span",{className:"spinner",children:"..."}),d===M&&h&&q.length>0&&i.jsx("ul",{className:"suggestions-list",children:q.map(J=>i.jsxs("li",{onClick:()=>oe(J,M),children:[i.jsx("div",{className:"suggestion-name",children:J.name}),i.jsxs("div",{className:"suggestion-details",children:["Stock: ",J.stock]})]},J.id))})]})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Tabs/Day"}),i.jsx("input",{type:"number",min:"0.5",step:"0.5",value:A.tablets_per_day,onChange:J=>V(M,"tablets_per_day",J.target.value)})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Days"}),i.jsx("input",{type:"number",min:"1",value:A.number_of_days,onChange:J=>V(M,"number_of_days",J.target.value)})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Packs"}),i.jsx("input",{type:"number",min:"0",value:A.packs||"",onChange:J=>V(M,"packs",J.target.value),placeholder:"0"})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Loose"}),i.jsx("input",{type:"number",min:"0",value:A.loose||"",onChange:J=>V(M,"loose",J.target.value),placeholder:"0"})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Total"}),i.jsx("input",{type:"number",value:A.quantity,disabled:!0,style:{backgroundColor:"#f5f5f5",cursor:"not-allowed"}})]}),i.jsx("button",{type:"button",className:"remove-btn",onClick:()=>C(M),disabled:a.length===1,children:i.jsx(ht,{size:16})})]}),i.jsxs("div",{className:"row-bottom",children:[i.jsx("div",{className:"form-group",style:{flex:1},children:i.jsx("input",{type:"text",placeholder:"Directions (e.g. 1-0-1 after food)",value:A.directions,onChange:J=>V(M,"directions",J.target.value)})}),i.jsx("div",{className:"form-group",style:{flex:1},children:i.jsx("input",{type:"text",placeholder:"Notes",value:A.notes,onChange:J=>V(M,"notes",J.target.value)})})]})]},A.id))}),i.jsxs("div",{className:"modal-actions",children:[i.jsx("button",{type:"button",className:"btn-cancel",onClick:n,children:"Cancel"}),i.jsx("button",{type:"submit",className:"btn-submit",disabled:L,children:L?"Creating...":"Create Recurring Order"})]})]})]})]})}):null},Mf=({isOpen:e,onClose:n,onSuccess:t,medication:r})=>{const[s,a]=w.useState(""),[o,l]=w.useState(0),[c,u]=w.useState(1),[m,d]=w.useState(30),[y,h]=w.useState(""),[D,q]=w.useState(""),[Y,O]=w.useState(30),[H,L]=w.useState(""),[W,F]=w.useState("active"),[j,X]=w.useState(!1),[le,ne]=w.useState(null);w.useEffect(()=>{if(e&&r){a(r.medicationName),l(r.quantity),u(r.tabletsPerDay||1),d(r.numberOfDays||30),h(r.directions||""),q(r.notes||""),O(r.frequencyDays),F(r.status);try{const k=new Date(r.nextDeliveryDate);isNaN(k.getTime())||L(k.toISOString().split("T")[0])}catch(k){console.error("Error parsing date",k)}}},[e,r]);const oe=async k=>{if(k.preventDefault(),ne(null),!s||o<=0){ne("Please provide a valid medication name and quantity.");return}X(!0);try{const C={medication_name:s,quantity:o,tablets_per_day:c,number_of_days:m,directions:y,notes:D,frequency_days:Y,next_delivery_date:H,status:W},G=await K(`/api/recurring-medications/${r.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(C)});if(!G.ok){const A=await G.json();throw new Error(A.message||"Failed to update recurring medication.")}t(),n()}catch(C){ne(C.message)}finally{X(!1)}},V=async()=>{if(window.confirm("Are you sure you want to delete this recurring medication?")){X(!0);try{if(!(await K(`/api/recurring-medications/${r.id}`,{method:"DELETE"})).ok)throw new Error("Failed to delete recurring medication.");t(),n()}catch(k){ne(k.message)}finally{X(!1)}}};return e?i.jsx("div",{className:"modal-overlay",children:i.jsxs("div",{className:"add-recurring-modal",style:{maxWidth:"600px",width:"90%"},children:[i.jsxs("div",{className:"modal-header",children:[i.jsx("h3",{children:"Edit Recurring Medication"}),i.jsx("button",{className:"close-btn",onClick:n,children:i.jsx(pn,{size:20})})]}),i.jsxs("div",{className:"modal-body",children:[le&&i.jsx("div",{className:"error-message",children:le}),i.jsxs("form",{onSubmit:oe,className:"recurring-form",children:[i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Medication Name"}),i.jsx("input",{type:"text",value:s,onChange:k=>a(k.target.value)})]}),i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsxs("label",{children:[i.jsx(Qs,{size:16})," Frequency"]}),i.jsxs("select",{value:Y,onChange:k=>O(parseInt(k.target.value)),children:[i.jsx("option",{value:15,children:"Every 15 Days"}),i.jsx("option",{value:30,children:"Every 30 Days"}),i.jsx("option",{value:60,children:"Every 60 Days"}),i.jsx("option",{value:90,children:"Every 90 Days"})]})]}),i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsxs("label",{children:[i.jsx(yr,{size:16})," Next Delivery"]}),i.jsx("input",{type:"date",value:H,onChange:k=>L(k.target.value)})]})]}),i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsx("label",{children:"Tabs/Day"}),i.jsx("input",{type:"number",min:"0.5",step:"0.5",value:c,onChange:k=>u(parseFloat(k.target.value))})]}),i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsx("label",{children:"Days"}),i.jsx("input",{type:"number",min:"1",value:m,onChange:k=>d(parseInt(k.target.value))})]}),i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsx("label",{children:"Total Qty"}),i.jsx("input",{type:"number",min:"1",value:o,onChange:k=>l(parseInt(k.target.value))})]})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Directions"}),i.jsx("input",{type:"text",value:y,onChange:k=>h(k.target.value)})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Notes"}),i.jsx("input",{type:"text",value:D,onChange:k=>q(k.target.value)})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Status"}),i.jsxs("select",{value:W,onChange:k=>F(k.target.value),children:[i.jsx("option",{value:"active",children:"Active"}),i.jsx("option",{value:"paused",children:"Paused"}),i.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),i.jsxs("div",{className:"modal-actions",style:{justifyContent:"space-between"},children:[i.jsxs("button",{type:"button",className:"btn-cancel text-red-600 hover:bg-red-50",onClick:V,style:{color:"#dc3545"},children:[i.jsx(ht,{size:16,style:{marginRight:"5px"}})," Delete"]}),i.jsxs("div",{style:{display:"flex",gap:"10px"},children:[i.jsx("button",{type:"button",className:"btn-cancel",onClick:n,children:"Cancel"}),i.jsx("button",{type:"submit",className:"btn-submit",disabled:j,children:j?"Saving...":"Save Changes"})]})]})]})]})]})}):null},Hf=({isOpen:e,onClose:n,billData:t})=>{if(w.useEffect(()=>{if(e&&t){const a=setTimeout(()=>{window.print()},500);return()=>clearTimeout(a)}},[e,t]),!e||!t)return null;const r=t.clinicUpiId&&t.grandTotal>0?`upi://pay?pa=${t.clinicUpiId}&pn=${encodeURIComponent(t.clinicName)}&am=${t.grandTotal.toFixed(2)}&cu=INR`:"",s=i.jsxs("div",{id:"print-modal-root",className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 print:bg-white print:static print:block",children:[i.jsxs("div",{className:"bg-white w-full max-w-4xl h-[90vh] overflow-y-auto rounded-lg shadow-xl print:shadow-none print:w-full print:max-w-none print:h-auto print:overflow-visible relative",children:[i.jsx("button",{onClick:n,className:"absolute top-4 right-4 z-50 p-2 bg-gray-100 hover:bg-gray-200 rounded-full no-print",children:i.jsx(pn,{size:24})}),i.jsx("div",{className:"pharmacy-billing-page",style:{padding:0,minHeight:"auto",background:"white"},children:i.jsx("div",{className:"billing-container printable-section",style:{border:"none",boxShadow:"none",maxWidth:"100%",margin:0},children:i.jsxs("div",{className:"p-8 print:p-0",children:[t.labLetterheadUrl&&i.jsx("div",{className:"print-letterhead-container mb-4",children:i.jsx("img",{src:t.labLetterheadUrl,alt:"Lab Letterhead",className:"print-letterhead-image w-full object-contain max-h-[150px]"})}),i.jsxs("div",{className:"billing-header print-only",children:[i.jsx("div",{className:"clinic-header-left",children:i.jsx("div",{className:"clinic-info-print",children:i.jsxs("div",{className:"clinic-name-and-details-print",children:[i.jsx("h1",{className:"bill-title",children:"INVOICE"}),i.jsx("h2",{className:"clinic-name-print",children:t.clinicName?`${t.clinicName} Lab`:"Lab Bill"}),(t.clinicAddress||t.clinicNotes)&&i.jsxs("div",{className:"clinic-details-print",children:[t.clinicAddress&&i.jsx("span",{className:"small-text clinic-address",children:t.clinicAddress}),t.clinicNotes&&i.jsx("span",{className:"small-text clinic-notes",children:t.clinicNotes})]})]})})}),i.jsxs("div",{className:"patient-info-grid print-only-patient-details mt-4 text-sm",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem"},children:[i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Gs,{size:16})," Patient Name"]}),t.patientName]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Ys,{size:16})," Token"]}),t.patientToken||"N/A"]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(yr,{size:16})," Order Date"]}),new Date(t.orderDate).toLocaleDateString()]})]})]}),i.jsx("div",{className:"medications-card mb-6",style:{border:"none",boxShadow:"none"},children:i.jsxs("table",{className:"medications-table w-full text-left collapse",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b-2 border-gray-300",children:[i.jsx("th",{className:"py-2",children:"S.No."}),i.jsx("th",{className:"py-2",children:"TEST DESCRIPTION"}),i.jsx("th",{className:"py-2 text-right",children:"PRICE"}),i.jsx("th",{className:"py-2 text-right",children:"DIS %"}),i.jsx("th",{className:"py-2 text-right",children:"AMT"})]})}),i.jsx("tbody",{children:t.items.map((a,o)=>{const l=a.price??0,c=l*(a.discount_percentage??0)/100,u=l-c;return i.jsxs("tr",{className:"border-b border-gray-100",children:[i.jsx("td",{className:"py-2",children:o+1}),i.jsx("td",{className:"py-2 font-medium",children:a.name}),i.jsx("td",{className:"py-2 text-right",children:a.price.toFixed(2)}),i.jsxs("td",{className:"py-2 text-right",children:[a.discount_percentage??0,"%"]}),i.jsx("td",{className:"py-2 text-right font-bold",children:u.toFixed(2)})]},o)})})]})}),i.jsx("div",{className:"bill-summary-print flex justify-end",children:i.jsxs("div",{className:"bill-summary-details w-1/3 bg-gray-50 p-4 rounded print:w-1/2 print:bg-transparent print:p-0",children:[i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Subtotal"}),i.jsxs("span",{children:["₹",t.subtotal.toFixed(2)]})]}),i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Total Discount"}),i.jsxs("span",{children:["- ₹",t.totalDiscount.toFixed(2)]})]}),i.jsxs("div",{className:"print-only-total flex justify-between font-bold text-lg border-t pt-2 mt-2",children:[i.jsx("span",{children:"Grand Total:"}),i.jsxs("span",{children:["₹",t.grandTotal.toFixed(2)]})]}),r&&i.jsxs("div",{className:"qr-code-container mt-4 flex flex-col items-center",style:{boxShadow:"none",background:"transparent"},children:[i.jsx(Xs,{value:r,size:80}),i.jsx("p",{className:"text-xs mt-1 text-center text-gray-500",children:"Scan to pay"})]})]})}),i.jsxs("footer",{className:"billing-footer mt-8 text-center text-xs text-gray-500 print:absolute print:bottom-0 print:w-full",children:[i.jsx("p",{children:"Thank you for your business!"}),i.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})})})]}),i.jsx("style",{children:`
                @media print {
                    /* Hide EVERYTHING in body */
                    body > * {
                        display: none !important;
                    }
                    
                    /* Explicitly hide #root to override any other styles */
                    #root {
                        display: none !important;
                    }

                    /* Show ONLY our portal root */
                    #print-modal-root {
                        display: block !important;
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        background: white !important;
                        z-index: 99999 !important;
                    }

                     /* Reset visibility for children of the portal */
                    #print-modal-root * {
                        visibility: visible !important;
                    }
                    
                    /* IMPORTANT: Prevent style tags from being displayed by the wildcard above */
                    #print-modal-root style {
                        display: none !important;
                    }
                    
                     /* Specifically restore display for key layout containers that rely on Flex */
                    .flex { display: flex !important; }
                    .grid { display: grid !important; }
                    .table { display: table !important; }
                    tr { display: table-row !important; }
                    td, th { display: table-cell !important; }

                    /* Ensure no scrollbars in print */
                    .overflow-y-auto {
                        overflow: visible !important;
                        height: auto !important;
                    }

                    /* 
                       CRITICAL: Hide elements explicitly marked with no-print class 
                       Must be at the END to override any restoration rules above.
                    */
                    #print-modal-root .no-print, .no-print {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                    }
                }
            `})]});return Ws.createPortal(s,document.body)},Wf=({isOpen:e,onClose:n,billData:t})=>{if(w.useEffect(()=>{if(e&&t){const a=setTimeout(()=>{window.print()},500);return()=>clearTimeout(a)}},[e,t]),!e||!t)return null;const r=t.clinicUpiId&&t.grandTotal>0?`upi://pay?pa=${t.clinicUpiId}&pn=${encodeURIComponent(t.clinicName)}&am=${t.grandTotal.toFixed(2)}&cu=INR`:"",s=i.jsxs("div",{id:"print-pharmacy-modal-root",className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 print:bg-white print:static print:block",children:[i.jsxs("div",{className:"bg-white w-full max-w-4xl h-[90vh] overflow-y-auto rounded-lg shadow-xl print:shadow-none print:w-full print:max-w-none print:h-auto print:overflow-visible relative",children:[i.jsx("button",{onClick:n,className:"absolute top-4 right-4 z-50 p-2 bg-gray-100 hover:bg-gray-200 rounded-full no-print",children:i.jsx(pn,{size:24})}),i.jsx("div",{className:"pharmacy-billing-page",style:{padding:0,minHeight:"auto",background:"white"},children:i.jsx("div",{className:"billing-container printable-section",style:{border:"none",boxShadow:"none",maxWidth:"100%",margin:0},children:i.jsxs("div",{className:"p-8 print:p-0",children:[i.jsxs("div",{className:"billing-header print-only",children:[i.jsx("div",{className:"clinic-header-left",children:i.jsx("div",{className:"clinic-info-print",children:i.jsxs("div",{className:"clinic-name-and-details-print",children:[i.jsx("h1",{className:"bill-title",children:"INVOICE"}),i.jsx("h2",{className:"clinic-name-print",children:t.clinicName?`${t.clinicName} Pharmacy`:"Pharmacy Bill"}),(t.clinicAddress||t.clinicNotes)&&i.jsxs("div",{className:"clinic-details-print",children:[t.clinicAddress&&i.jsx("span",{className:"small-text clinic-address",children:t.clinicAddress}),t.clinicNotes&&i.jsx("span",{className:"small-text clinic-notes",children:t.clinicNotes})]})]})})}),i.jsxs("div",{className:"patient-info-grid print-only-patient-details mt-4 text-sm",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem"},children:[i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Gs,{size:16})," Patient Name"]}),t.patientName]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Ys,{size:16})," Token"]}),t.patientToken||"N/A"]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(yr,{size:16})," Order Date"]}),new Date(t.orderDate).toLocaleDateString()]})]})]}),i.jsx("div",{className:"medications-card mb-6",style:{border:"none",boxShadow:"none"},children:i.jsxs("table",{className:"medications-table w-full text-left collapse",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b-2 border-gray-300",children:[i.jsx("th",{className:"py-2",children:"S.No."}),i.jsx("th",{className:"py-2",children:"DESCRIPTION"}),i.jsx("th",{className:"py-2",children:"BATCH"}),i.jsx("th",{className:"py-2",children:"EXPIRY"}),i.jsx("th",{className:"py-2",children:"QTY"}),i.jsx("th",{className:"py-2 text-right",children:"MRP"}),i.jsx("th",{className:"py-2 text-right",children:"DIS %"}),i.jsx("th",{className:"py-2 text-right",children:"AMT"})]})}),i.jsx("tbody",{children:t.items.map((a,o)=>i.jsxs("tr",{className:"border-b border-gray-100",children:[i.jsx("td",{className:"py-2",children:o+1}),i.jsx("td",{className:"py-2 font-medium",children:a.name}),i.jsx("td",{className:"py-2",children:a.batch||"-"}),i.jsx("td",{className:"py-2",children:a.expiry_date?new Date(a.expiry_date).toLocaleDateString():"-"}),i.jsxs("td",{className:"py-2",children:[a.pack_quantity?`${a.pack_quantity} Pkts `:"",a.loose_quantity?`${a.loose_quantity} Loose`:""]}),i.jsx("td",{className:"py-2 text-right",children:a.mrp.toFixed(2)}),i.jsxs("td",{className:"py-2 text-right",children:[a.discount_percentage??0,"%"]}),i.jsx("td",{className:"py-2 text-right font-bold",children:a.price.toFixed(2)})]},o))})]})}),i.jsx("div",{className:"bill-summary-print flex justify-end",children:i.jsxs("div",{className:"bill-summary-details w-1/3 bg-gray-50 p-4 rounded print:w-1/2 print:bg-transparent print:p-0",children:[i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Subtotal"}),i.jsxs("span",{children:["₹",t.subtotal.toFixed(2)]})]}),i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Total Discount"}),i.jsxs("span",{children:["- ₹",t.totalDiscount.toFixed(2)]})]}),i.jsxs("div",{className:"print-only-total flex justify-between font-bold text-lg border-t pt-2 mt-2",children:[i.jsx("span",{children:"Grand Total:"}),i.jsxs("span",{children:["₹",t.grandTotal.toFixed(2)]})]}),r&&i.jsxs("div",{className:"qr-code-container mt-4 flex flex-col items-center",style:{boxShadow:"none",background:"transparent"},children:[i.jsx(Xs,{value:r,size:80}),i.jsx("p",{className:"text-xs mt-1 text-center text-gray-500",children:"Scan to pay"})]})]})}),i.jsxs("footer",{className:"billing-footer mt-8 text-center text-xs text-gray-500 print:absolute print:bottom-0 print:w-full",children:[i.jsx("p",{children:"Thank you for your business!"}),i.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})})})]}),i.jsx("style",{children:`
                @media print {
                    body > * { display: none !important; }
                    #root { display: none !important; }
                    #print-pharmacy-modal-root {
                        display: block !important;
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        background: white !important;
                        z-index: 99999 !important;
                    }
                    #print-pharmacy-modal-root * { visibility: visible !important; }
                    #print-pharmacy-modal-root style { display: none !important; }
                    
                    .flex { display: flex !important; }
                    .grid { display: grid !important; }
                    .table { display: table !important; }
                    tr { display: table-row !important; }
                    td, th { display: table-cell !important; }

                    .overflow-y-auto { overflow: visible !important; height: auto !important; }
                    #print-pharmacy-modal-root .no-print, .no-print {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                    }
                }
            `})]});return Ws.createPortal(s,document.body)},Vf=({messages:e})=>{const n=w.useRef(null);return w.useEffect(()=>{n.current&&(n.current.scrollTop=n.current.scrollHeight)},[e]),i.jsxs("div",{className:"conversation-panel",children:[i.jsxs("div",{className:"conversation-header",children:[i.jsx("div",{className:"conversation-title",children:i.jsx("h3",{children:"Conversation"})}),i.jsxs("span",{className:"conversation-count",children:[e.length," messages"]})]}),i.jsxs("div",{ref:n,className:"message-list custom-scrollbar",children:[e.length===0&&i.jsx("div",{className:"empty-state",children:"Start talking to the AI..."}),e.map(t=>i.jsxs("div",{className:`message-wrapper ${t.role}`,children:[i.jsx("div",{className:`message-bubble ${t.role} ${t.role==="system"?t.type||"info":""}`,children:t.role==="ai"||t.role==="system"&&t.type==="loading"?i.jsx("div",{className:"prose prose-sm max-w-none",children:t.role==="system"&&t.type==="loading"?i.jsxs("div",{className:"typing-indicator",children:[i.jsx("span",{className:"dot"}),i.jsx("span",{className:"dot"}),i.jsx("span",{className:"dot"})]}):i.jsx(Qt,{remarkPlugins:[gt],children:t.content})}):i.jsx("div",{className:"whitespace-pre-wrap",children:t.content})}),t.role!=="system"&&i.jsx("span",{className:"message-timestamp",children:t.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]},t.id))]})]})},Jf=e=>Ql({queryKey:Dt.patients.context(e||""),queryFn:async()=>{if(!e)throw new Error("Patient ID is required");const n=await K(`/api/patients/${e}/context`);if(!n.ok)throw new Error("Failed to fetch patient context");return n.json()},enabled:!!e,staleTime:5*60*1e3}),ki=e=>{if(!e)return"";const n=new Date(e);if(isNaN(n.getTime()))return"";const t=n.getTimezoneOffset()*6e4;return new Date(n.getTime()-t).toISOString().slice(0,16)},og=()=>{var Ya,Ka;const{openCommandBar:e}=Gl(),{recordId:n,patientId:t}=Zl(),[r,s]=w.useState(n||void 0),a=ec(),o=Yl(),l=tc(),[c,u]=w.useState(""),[m]=w.useState([]),[d,y]=w.useState(null),[h,D]=w.useState(null),[q,Y]=w.useState(void 0),[O,H]=w.useState(void 0),[L,W]=w.useState(null),[F,j]=w.useState(!1),[X,le]=w.useState(""),[ne,oe]=w.useState(!1),[V,k]=w.useState(null),[C,G]=w.useState(null),[A,M]=w.useState(!1),[J,je]=w.useState(!1),[pe,x]=w.useState(null),[Oe,Fe]=w.useState(""),[b,Ne]=w.useState(""),[Me,be]=w.useState(null),[at,Qe]=w.useState(!1),[Ge,lt]=w.useState(!1),[wt,Yt]=w.useState(!1),[v,It]=w.useState(window.innerHeight),[ct,kt]=w.useState([]),[We,Ot]=w.useState(!1),[_t,Nt]=w.useState(null),[Ue,vt]=w.useState([]),[mt,fn]=w.useState([]),[Le,S]=w.useState([]),[T,P]=w.useState(!1),[te,ce]=w.useState(null),$e=w.useRef(null),He=w.useRef(null),ke=w.useRef(!1),Ve=w.useRef(null),tt=w.useRef(null),Re=w.useRef(null),Z=w.useRef(null),E=w.useRef(null),z=w.useRef(null),I=w.useRef(null),[$,ae]=w.useState([]),[re,R]=w.useState(!1);w.useEffect(()=>{(async()=>{if($.length>0&&!re){R(!0);const g=$[0];g.current&&(g.current.scrollIntoView({behavior:"smooth",block:"center"}),g.current.classList.add("ai-glow"),await new Promise(f=>setTimeout(f,2e3)),g.current&&g.current.classList.remove("ai-glow")),ae(f=>f.slice(1)),R(!1)}})()},[$,re]);const me=p=>{let g=null;switch(p){case"update_patient_details":g=Re;break;case"create_pharmacy_order":case"edit_pharmacy_order":g=Z;break;case"create_lab_order":case"edit_lab_order":g=E;break;case"add_complaint_history":g=z;break;case"update_case_summary":g=I;break}g&&ae(f=>[...f,g])},[ve,ge]=w.useState(55),[ie,de]=w.useState(!1),he=w.useRef(null),B=w.useRef(null),Q=w.useRef(null),ye=w.useRef(null),qe=150,[ue,_e]=w.useState([]),[Se,Ye]=w.useState([]),[Je,ut]=w.useState(!0),[jt,nt]=w.useState(null),[gn,yn]=w.useState(!1),[Wn,Vn]=w.useState(!1),[tl,nl]=w.useState(!1),[rl,il]=w.useState(!1),[al,sl]=w.useState(!1),[kr,Ct]=w.useState([]),[xn,Ki]=w.useState(!1),[Xi,Zi]=w.useState(null),[Jn,_r]=w.useState(!1),[ea,ta]=w.useState(null),[bn,ol]=w.useState({}),[ll,na]=w.useState(!1),[ra,ia]=w.useState(!1),[aa,sa]=w.useState(!1),[oa,Qn]=w.useState(!1),[la,Nr]=w.useState(!1),[ca,wn]=w.useState([]),[vr,Gn]=w.useState(void 0),[cl,ua]=w.useState(!1),[ul,dl]=w.useState(null),[pl,da]=w.useState(!1),[hl,ml]=w.useState(null),[dt,pa]=w.useState(!1),[jr,ha]=w.useState(!1),[Cr,ma]=w.useState(!1),[Sr,fa]=w.useState(!1),[Pr,ga]=w.useState(!1),[Yn,kn]=w.useState(!1),Kn=w.useMemo(()=>(h==null?void 0:h.admission_date)&&!(h!=null&&h.discharge_date),[h]),[ya,Xn]=w.useState(!1),[xa,Tr]=w.useState(null),[Er,Ar]=w.useState(""),[Dr,Ir]=w.useState(void 0),[Or,$r]=w.useState(void 0),[Lr,Rr]=w.useState(void 0),[St,Fr]=w.useState(!1),[ba,Ht]=w.useState(null),[wa,zr]=w.useState(null),[ka,qr]=w.useState(null),[_a,_n]=w.useState(null),[Pt,Kt]=w.useState(""),[Nn,Zn]=w.useState(!1),[vn,fl]=w.useState(!1),er=w.useRef(null),[Na,Br]=w.useState(null),[va,Xt]=w.useState([]),Ur=w.useCallback(p=>{Xt(g=>[...g,{id:Math.random().toString(36).substr(2,9),timestamp:new Date,role:"system",content:"",...p}])},[]),[Mr,ja]=w.useState(null),tr=w.useRef(null),nr=w.useRef(null),[gl,Hr]=w.useState(!1),[rr,Ca]=w.useState(!1),[Wr,Sa]=w.useState(null),[Ae,Vr]=w.useState(null),[ir,Jr]=w.useState(""),[jn,Cn]=w.useState(""),[Pa,Ta]=w.useState(!0),[Zt,Ea]=w.useState(!1),[Qr,ar]=w.useState(!1),[en,Aa]=w.useState(!1),[yl,Da]=w.useState(!1),Sn=w.useRef(null),xl=async()=>{Sn.current&&(await Sn.current.undoLastAction(),Da(!1))},bl=p=>{ml(p),da(!0)},tn=async p=>{try{const g=await K(`/api/patients/${p}`);if(!g.ok){const _=await g.json().catch(()=>({}));throw new Error(_.message||`Failed to fetch patient details: ${g.status}`)}const f=await g.json();if(D(f),Y(f.age),H(f.gender),Fe(f.ai_response||""),D(_=>_?{..._,current_status:f.current_status,admission_date:f.admission_date,discharge_date:f.discharge_date}:{...f,current_status:f.current_status,admission_date:f.admission_date,discharge_date:f.discharge_date}),f.insurance_type&&D(_=>_?{..._,insurance_type:f.insurance_type}:{...f}),Gr(p),f.ai_response){const _=/```json\s*([\s\S]*?)\s*```/,N=f.ai_response.match(_);if(N&&N[1])Ne(f.ai_response.replace(_,"").trim()),be(N[1].trim());else{const ee=f.ai_response.trim();if(ee.startsWith("{")&&ee.endsWith("}"))try{JSON.parse(ee),Ne(""),be(ee)}catch{Ne(ee),be(null)}else if(ee.startsWith("[")&&ee.endsWith("]"))try{JSON.parse(ee),Ne(""),be(ee)}catch{Ne(ee),be(null)}else Ne(ee),be(null)}}else Ne(""),be(null)}catch{D(null),Fe(""),Ne(""),be(null)}},wl=async(p,g)=>{D(f=>f?{...f,insurance_type:g}:null);try{const f=await K(`/api/patients/${p}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({insurance_type:g})});if(!f.ok){const _=await f.json();throw new Error(_.message||"Failed to update insurance type")}}catch(f){console.error("Error updating insurance type:",f),p&&tn(p)}},Ia=async p=>{P(!0),ce(null),S([]);try{const g=await K(`/api/queue/patient/${p}/complaints`);if(!g.ok){const _=await g.json().catch(()=>({}));throw new Error(_.message||`HTTP error! status: ${g.status}`)}const f=await g.json();S(f||[])}catch(g){ce(`Past complaints error: ${g.message}`)}finally{P(!1)}},nn=async p=>{vt([]);try{const g=await K(`/api/pharmacy-orders/patient/${p}`);if(!g.ok){const _=await g.json().catch(()=>({}));throw new Error(_.message||`HTTP error! status: ${g.status}`)}const f=await g.json();vt(f||[])}catch{}},rn=async p=>{Ki(!0),Zi(null),Ct([]);try{const g=await K(`/api/lab/orders/patient/${p}`);if(!g.ok){const _=await g.json().catch(()=>({}));throw new Error(_.message||`HTTP error! status: ${g.status}`)}const f=await g.json();Ct(f||[])}catch(g){Zi(`Pending labs error: ${g.message}`)}finally{Ki(!1)}},Pn=async p=>{Ot(!0),Nt(null),kt([]);try{const g=await K(`/api/lab/patient/${p}`);if(!g.ok){const N=await g.json().catch(()=>({}));throw new Error(N.message||`HTTP error! status: ${g.status}`)}const _=(await g.json()||[]).map(N=>({...N.report,id:N.id,patient_id:N.patient_id,createdAt:N.createdAt,tests:N.tests,status:N.status}));kt(_)}catch(g){Nt(`Lab reports error: ${g.message}`)}finally{Ot(!1)}},{data:Tt,isLoading:$t}=Jf(d),Tn=w.useCallback(async p=>{p===d?await o.invalidateQueries({queryKey:Dt.patients.context(p)}):y(p)},[d,o]);w.useEffect(()=>{if(Tt){console.log("EditComplaintPage: Syncing data from useQuery cache");const p=Tt.patient;if(p){if(D(p),Y(p.age),H(p.gender),Fe(p.ai_response||""),p.ai_response){const g=/```json\s*([\s\S]*?)\s*```/,f=p.ai_response.match(g);if(f&&f[1])Ne(p.ai_response.replace(g,"").trim()),be(f[1].trim());else{const _=p.ai_response.trim();_.startsWith("{")||_.startsWith("[")?(Ne(""),be(_)):(Ne(_),be(null))}}kn(p.current_status==="In Doctor Queue"||p.current_status==="In Consultation")}if(S(Tt.history||[]),vt(Tt.pharmacyOrders||[]),Tt.labOrders){Ct(Tt.labOrders.filter(f=>!f.report));const g=Tt.labOrders.filter(f=>f.report).map(f=>({...f.report,id:f.id,patient_id:f.patient_id,createdAt:f.createdAt,tests:f.tests}));kt(g)}fn(Tt.recurringMedications||[])}},[Tt]),w.useEffect(()=>{(async()=>{if(d)try{const g=await o.fetchQuery({queryKey:Dt.patientDebts.balance(d),queryFn:async()=>{const f=await K(`/api/patient-debts/${d}/balance`);return f.ok?f.json():{netDebt:0}},staleTime:6e4});Sa(g.netDebt||0)}catch(g){console.error("Error fetching patient debt:",g),Sa(0)}})()},[d,o]);const Gr=async p=>{try{const g=await o.fetchQuery({queryKey:Dt.queue.latest(p),queryFn:async()=>{const f=await K(`/api/queue/patient/${p}/latest`);if(!f.ok)throw new Error("Failed");return f.json()},staleTime:5e3});if(g){const f=new Date(g.createdAt),_=new Date,N=f.getDate()===_.getDate()&&f.getMonth()===_.getMonth()&&f.getFullYear()===_.getFullYear(),ee=["waiting","consulting"].includes(g.status);kn(N&&ee)}else kn(!1)}catch(g){console.error("Error checking patient queue status:",g),kn(!1)}},Yr=w.useCallback(async(p,g)=>{try{if(!(await K(`/api/pharmacy-orders/${p}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:g})})).ok)throw new Error("Failed to update pharmacy order date");d&&nn(d)}catch(f){console.error("Error updating pharmacy order date:",f),x("Failed to update pharmacy order date")}},[d]),En=w.useCallback(async(p,g,f)=>{try{const _={};if(g==="order"?_.date=f:g==="report"&&(_.reportDate=f),!(await K(`/api/lab/orders/${p}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(_)})).ok)throw new Error("Failed to update lab date");d&&(rn(d),Pn(d))}catch(_){console.error("Error updating lab order date:",_),x("Failed to update lab order date")}},[d]),Kr=w.useCallback(p=>{a(`/dashboard/edit-pharmacy-order/${p}`)},[a]),Oa=w.useCallback(p=>{const g=p.medications.map((f,_)=>({id:Date.now()+_,medication_name:f.name,drug_id:f.drug_id?String(f.drug_id):null,quantity:(f.pack_quantity||0)*(f.pack_size||1)+(f.loose_quantity||0),tablets_per_day:f.tabletsPerDay||1,number_of_days:f.numberOfDays||30,directions:f.directions_to_use||"",notes:"",packs:f.pack_quantity,loose:f.loose_quantity,pack_size:f.pack_size}));wn(g),Qn(!0)},[]),$a=w.useCallback(p=>{x(null),console.log(`Preparing billing navigation for order: ${p}`);const g=Ue.find(f=>f.id===p);if(g){const f=g.medications.map(_=>{const N=_.price??0;return(_.price===void 0||_.price===null)&&console.warn(`Medication "${_.name}" in order ${p} is missing a price. Defaulting to 0.`),{name:_.name,pack_quantity:_.pack_quantity,loose_quantity:_.loose_quantity,price:N,pack_price:_.pack_price,loose_price:_.loose_price,total_price:Number(_.total_price)||0,isLoose:_.isLoose,unit:_.unit,drug_id:_.drug_id?String(_.drug_id):null,tabletsPerDay:_.tabletsPerDay,numberOfDays:_.numberOfDays,directions_to_use:_.directions_to_use,discount_percentage:_.discount_percentage??0,batch:_.batch,expiry_date:_.expiry_date}});console.log("Navigating to /dashboard/pharmacy-billing with state:",{initialItems:f}),a(`/dashboard/pharmacy-billing/${p}`,{state:{initialItems:f}})}else console.error(`Order with ID ${p} not found.`),x(`Order with ID ${p} not found.`),alert(`Error: Could not find order ${p} to bill.`)},[Ue,a]),La=w.useCallback(async(p,g)=>{x(null);const f=Ue.find(N=>N.id===p);if(!f){x(`Order with ID ${p} not found.`);return}const _={status:g,medications:f.medications};try{const N=await K(`/api/pharmacy-orders/${p}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(_)});if(!N.ok){const we=await N.text();throw new Error(`Failed to update status: ${N.statusText} (${N.status}) - ${we}`)}const ee=await N.json();vt(we=>we.map(Ee=>Ee.id===ee.id?{...Ee,status:ee.status}:Ee)),d&&nn(d)}catch(N){console.error("Failed to update order status:",N),x(N.message||`Failed to update status for order ${p}.`),alert(`Error updating status for order ${p}: ${N.message||"Please try again."}`)}},[Ue,d]),Xr=w.useCallback(p=>{Ct(g=>g.map(f=>f.id===p?{...f,isEditing:!0,editedTests:[...f.tests],editedStatus:f.status}:{...f,isEditing:!1}))},[]),kl=w.useCallback(p=>{Ct(g=>g.map(f=>f.id===p?{...f,isEditing:!1,editedTests:void 0,editedStatus:void 0}:f))},[]),_l=w.useCallback((p,g,f,_)=>{Ct(N=>N.map(ee=>{if(ee.id===p){const we=ee.editedTests?[...ee.editedTests]:[...ee.tests];if(f==="add")return{...ee,editedTests:[...we,{id:"",name:"",price:0}]};if(f==="remove")return{...ee,editedTests:_};if(g!==-1){const Ee={...we[g],[f]:_};return we[g]=Ee,{...ee,editedTests:we}}}return ee}))},[]),Nl=w.useCallback((p,g)=>{Ct(f=>f.map(_=>_.id===p?{..._,editedStatus:g}:_))},[]),Ra=w.useCallback(async p=>{if(!p){console.error("Cannot navigate to billing: Lab Order data is missing."),alert("Could not open billing page: Lab Order information is missing.");return}a(`/dashboard/lab-billing/${p.id}`)},[a]),Fa=w.useCallback(async(p,g)=>{console.log(`Updating lab order ${p} to status ${g}`);try{const f=await K(`/api/lab/${p}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:g})});if(!f.ok){const _=await f.json();throw new Error(_.message||`Failed to update lab order status: ${f.status}`)}d&&(rn(d),Pn(d)),console.log(`Lab Order ${p} status updated to ${g}, refetching data.`)}catch(f){console.error("Error updating lab order status:",f),alert(`Failed to update lab order status: ${f instanceof Error?f.message:"Unknown error"}`)}},[d]),sr=w.useCallback(p=>{p&&p.id?a(`/lab/report/${p.id}`):(console.error("Cannot navigate: Lab Order or Lab Order ID is missing."),alert("Could not open the report entry page: Lab Order information is missing."))},[a]),vl=w.useCallback(async(p,g,f)=>{pa(!0),x(null);try{if(!g||g.length===0)throw new Error("Lab order must have at least one test.");for(const ee of g)if(!ee.id||!ee.name||isNaN(ee.price)||ee.price<0)throw new Error(`Invalid test data: ${JSON.stringify(ee)}. Each test must have id, name, and a valid price.`);const _={tests:g,status:f},N=await K(`/api/lab/orders/${p}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(_)});if(!N.ok){const ee=await N.json().catch(()=>({}));throw new Error(ee.message||`Failed to update lab order: ${N.statusText}`)}d&&rn(d),Ct(ee=>ee.map(we=>we.id===p?{...we,isEditing:!1,editedTests:void 0,editedStatus:void 0}:we))}catch(_){x(`Lab Order Save Error: ${_.message}`)}finally{pa(!1)}},[d]),Lt=w.useCallback(async p=>{if(!window.confirm(`Are you sure you want to delete this ${p.type.toLowerCase()} record? This action cannot be undone.`))return;_r(!0),ta(null);let f=null,_;const N=p.type;try{switch(N){case"Complaint":if(_=p.data.id,!_)throw new Error("Complaint ID is missing.");f=`/api/patients/complaints/${_}`;break;case"Lab Order":if(_=p.data.id,!_)throw new Error("Lab Order ID is missing.");f=`/api/lab/orders/${_}`;break;case"Lab Report":if(_=p.data.reportId,!_)throw new Error("Lab Report ID is missing.");f=`/api/lab/reports/${_}`;break;case"Pharmacy Order":if(_=p.data.id,!_)throw new Error("Pharmacy Order ID is missing.");f=`/api/pharmacy-orders/${_}`;break;default:throw new Error(`Deletion not supported for item type: ${N}`)}if(!f)throw new Error(`Could not determine delete URL for type: ${N}`);const ee=await K(f,{method:"DELETE"});if(!ee.ok){const we=await ee.json().catch(()=>({}));throw new Error(we.message||`Failed to delete ${N}: ${ee.statusText}`)}d&&(N==="Complaint"?Ia(d):N==="Lab Order"?(rn(d),Pn(d)):N==="Lab Report"?Pn(d):N==="Pharmacy Order"&&nn(d))}catch(ee){ta(`Delete Error (${N}): ${ee.message}`),Jn&&_r(!1)}finally{_r(!1)}},[d,Jn]),za=w.useCallback(async()=>{if(!d)return;if(Ue.filter(g=>g.status==="pending").length<2){alert("You need at least two pending orders to merge.");return}Ca(!0);try{const g=await K(`/api/pharmacy-orders/patient/${d}/merge-pending`,{method:"POST"});if(!g.ok){const f=await g.json().catch(()=>({}));throw new Error(f.message||"Failed to merge orders")}nn(d)}catch(g){x(`Merge Error: ${g.message}`)}finally{Ca(!1)}},[d,Ue]),Rt=w.useMemo(()=>{if(!d||!Le)return[];const p=Le.map(g=>({date:new Date(g.createdAt),type:"Complaint",data:g,originalDateString:g.createdAt})).filter(g=>!isNaN(g.date.getTime()));return p.sort((g,f)=>f.date.getTime()-g.date.getTime()),p},[d,Le]),Ft=w.useMemo(()=>{if(!d)return[];const p=new Map;(kr??[]).forEach(f=>{p.set(f.id,{...f})}),(ct??[]).forEach(f=>{if(!p.has(f.id))p.set(f.id,{id:f.id,patient_id:f.patient_id,tests:f.tests,status:f.status,createdAt:f.createdAt,report:f});else{const _=p.get(f.id);_&&(_.report=f,_.status=f.status)}});let g=Array.from(p.values());return g.sort((f,_)=>new Date(f.createdAt).getTime()-new Date(_.createdAt).getTime()),g=g.map((f,_)=>({...f,serialNumber:_+1})),g.map(f=>({date:new Date(f.createdAt),type:"Lab Order",data:f,originalDateString:f.createdAt}))},[d,kr,ct]),Wt=w.useCallback(async p=>{const g=p??c;if(!g.trim())return;nr.current&&(clearTimeout(nr.current),nr.current=null),Ur({role:"user",content:g});const f=Math.random().toString(36).substr(2,9);Xt(_=>[..._,{id:f,role:"system",type:"loading",content:"",timestamp:new Date}]),Sn.current?(await Sn.current.callGenerativeApi(g),Xt(_=>_.filter(N=>N.id!==f)),nr.current=setTimeout(()=>{Xt([])},1e4)):Xt(_=>_.filter(N=>N.id!==f))},[c,Ur,Xt]),qa=w.useCallback(()=>{const p="reports came,please anaylse";u(p),setTimeout(()=>{Wt(p)},0)},[Wt,u]),Zr=w.useCallback(p=>{ol(g=>({...g,[p]:!g[p]}))},[]),ft=w.useMemo(()=>{if(!d||!Ue)return[];const p=Ue.map(g=>({date:new Date(g.date),type:"Pharmacy Order",data:g,originalDateString:g.date})).filter(g=>!isNaN(g.date.getTime()));return p.sort((g,f)=>f.date.getTime()-g.date.getTime()),p},[d,Ue]),jl=w.useCallback((p,g)=>i.jsxs("div",{className:"flex flex-col w-full",children:[i.jsxs("span",{className:"ai-context-text flex items-center",children:[ft.length-g,". Order Status: (",p.data.status,")",i.jsx("span",{className:"text-gray-400 ml-1 flex items-center",children:xa===p.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",children:i.jsx("input",{type:"datetime-local",defaultValue:ki(p.originalDateString),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:f=>{f.target.value&&Yr(p.data.id,f.target.value),Tr(null)},onKeyDown:f=>{if(f.key==="Enter"){const _=f.target;_.value&&Yr(p.data.id,_.value),Tr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/date ml-1",onClick:()=>Tr(p.data.id),title:"Click to edit date",children:["(",new Date(p.originalDateString).toLocaleDateString(),")",i.jsx(pt,{size:14,className:"ml-1 text-gray-500 hover:text-gray-700"})]})}),i.jsxs("div",{className:"inline-flex space-x-2 ml-2",children:[i.jsx("button",{onClick:()=>Kr(p.data.id),className:"icon-button small",title:"Edit Pharmacy Order",children:i.jsx(pt,{size:12})}),p.data.prescriptionForUnavailableDrugs&&i.jsx("button",{onClick:()=>{const f=hi().use(gt).use(wi).processSync(p.data.prescriptionForUnavailableDrugs).toString();ei(f,"Unavailable Drugs Prescription")},className:"icon-button small",title:"Print Unavailable Drugs Prescription",children:i.jsx(ln,{size:12})}),p.data.status==="dispensed"||p.data.status==="billed"?i.jsx("button",{onClick:()=>a(`/dashboard/pharmacy-billing/${p.data.id}`),className:"icon-button small text-blue-600",title:"View Pharmacy Bill",children:i.jsx(Xa,{size:12})}):i.jsx("button",{onClick:()=>Lt({type:"Pharmacy Order",data:p.data}),className:"icon-button small text-red-500",title:"Delete Pharmacy Order",children:i.jsx(ht,{size:12})}),p.data.status==="pending"&&i.jsx("button",{onClick:()=>$a(p.data.id),className:"icon-button small",title:"Bill this pharmacy order",disabled:dt,children:i.jsx(Za,{size:12})}),p.data.status==="billed"&&i.jsx("button",{onClick:()=>La(p.data.id,"dispensed"),className:"icon-button small",title:"Dispense this pharmacy order",disabled:dt,children:i.jsx(es,{size:12})}),i.jsx("button",{onClick:()=>Oa(p.data),className:"icon-button small group-hover:block",title:"Add to Recurring Medications",children:i.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-repeat",children:[i.jsx("path",{d:"m17 2 4 4-4 4"}),i.jsx("path",{d:"M3 11v-1a4 4 0 0 1 4-4h14"}),i.jsx("path",{d:"m7 22-4-4 4-4"}),i.jsx("path",{d:"M21 13v1a4 4 0 0 1-4 4H3"})]})})]})]}),i.jsx("div",{className:"pharmacy-order-drugs-table-container mobile-edge-to-edge-table-container mt-2 cursor-pointer hover:bg-gray-50 transition-colors rounded p-1",onClick:()=>Kr(p.data.id),title:"Click to edit order",children:i.jsxs("table",{className:"pharmacy-order-drugs-table mobile-edge-to-edge-table w-full text-xs",children:[i.jsx("thead",{children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-1 px-2 text-left",children:"Drug Name"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Quantity"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Dosage"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Directions"})]})}),i.jsx("tbody",{children:p.data.medications.map((f,_)=>i.jsxs("tr",{children:[i.jsx("td",{className:"py-1 px-2",children:i.jsx("strong",{children:f.name})}),i.jsxs("td",{className:"py-1 px-2",children:[f.pack_quantity!==void 0&&f.pack_quantity>0&&`Packs: ${f.pack_quantity}`,f.pack_quantity!==void 0&&f.pack_quantity>0&&f.loose_quantity!==void 0&&f.loose_quantity>0&&", ",f.loose_quantity!==void 0&&f.loose_quantity>0&&`Loose: ${f.loose_quantity}`]}),i.jsx("td",{className:"py-1 px-2",children:f.tabletsPerDay&&f.numberOfDays?`${f.tabletsPerDay} tab/day for ${f.numberOfDays} days`:"N/A"}),i.jsx("td",{className:"py-1 px-2",children:f.directions_to_use||"N/A"})]},f.drug_id||f.name||_))})]})}),p.data.prescriptionForUnavailableDrugs&&i.jsxs("div",{className:"unavailable-drugs-markdown mt-2",children:[i.jsx("span",{className:"font-semibold text-xs text-gray-600 block mb-1",children:"Prescription for Unavailable Drugs:"}),i.jsx(Qt,{remarkPlugins:[gt],children:p.data.prescriptionForUnavailableDrugs})]})]}),[ft,xa,Yr,Kr,$a,La,Oa,Lt,dt,a]),Cl=w.useCallback((p,g)=>{const f=Qp(p.data.report?p.data.report.status:p.data.status),_=(p.data.tests||[]).reduce((N,ee)=>N+(Number(ee.price)||0),0).toFixed(2);return i.jsxs("div",{className:"flex flex-col w-full",children:[i.jsxs("div",{className:"flex justify-between items-start mb-2",children:[i.jsxs("div",{className:"ai-context-text flex items-center flex-wrap",children:[i.jsxs("span",{className:"font-medium cursor-pointer hover:text-blue-600 transition-colors mr-2",onClick:()=>sr(p.data),title:"Click to enter report",children:["#",p.data.serialNumber," [Order]"]}),i.jsx("span",{className:`mr-2 ${f.className}`,children:f.text}),i.jsx("span",{className:"text-gray-400 inline-flex items-center",children:wa===p.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",onClick:N=>N.stopPropagation(),children:i.jsx("input",{type:"datetime-local",defaultValue:ki(p.originalDateString),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:N=>{N.target.value&&En(p.data.id,"order",N.target.value),zr(null)},onKeyDown:N=>{if(N.key==="Enter"){const ee=N.target;ee.value&&En(p.data.id,"order",ee.value),zr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/date ml-1",onClick:N=>{N.stopPropagation(),zr(p.data.id)},title:"Click to edit order date",children:["(",new Date(p.originalDateString).toLocaleDateString(),")",i.jsx(pt,{size:14,className:"ml-1 text-gray-500 hover:text-gray-700"})]})})]}),!p.data.isEditing&&i.jsxs("div",{className:"flex space-x-1 items-center",children:[i.jsx("button",{onClick:()=>Xr(p.data.id),className:"icon-button small",title:"Edit",disabled:dt,children:i.jsx(pt,{size:12})}),p.data.status==="pending"?i.jsx("button",{onClick:()=>Ra(p.data),className:"icon-button small font-medium text-green-600 w-auto px-1",title:`Pay total of ₹${_}`,disabled:dt,children:i.jsx(Vs,{size:12})}):i.jsx("button",{onClick:()=>a(`/dashboard/lab-billing/${p.data.id}`),className:"icon-button small text-blue-600",title:"View Lab Bill",children:i.jsx(nc,{size:12})}),["pending","billed","collected","processing","report_ready","reported","completed"].includes(p.data.status)&&i.jsx("button",{onClick:()=>sr(p.data),className:"icon-button small text-indigo-600",title:"Enter Report",disabled:dt,children:i.jsx(Xa,{size:12})}),(p.data.status==="report_ready"||p.data.status==="reported")&&i.jsx("button",{onClick:()=>Fa(p.data.id,"completed"),className:"icon-button small text-green-600",title:"Mark Completed",disabled:dt,children:i.jsx(es,{size:12})}),i.jsx("button",{onClick:()=>Lt({type:"Lab Order",data:p.data}),className:"icon-button small text-red-500",title:"Delete",disabled:dt,children:i.jsx(ht,{size:12})})]})]}),i.jsx("div",{className:"lab-order-tests-table-container mobile-edge-to-edge-table-container mt-1 mb-2 cursor-pointer hover:bg-gray-50 transition-colors rounded p-1 border border-gray-100",onClick:()=>{p.data.status==="pending"?Xr(p.data.id):sr(p.data)},title:p.data.status==="pending"?"Click to edit order":"Click to enter report",children:i.jsxs("table",{className:"lab-order-tests-table mobile-edge-to-edge-table w-full text-xs text-left",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b bg-gray-50",children:[i.jsx("th",{className:"py-1 px-2 font-medium text-gray-600",children:"Test Name"}),i.jsx("th",{className:"py-1 px-2 text-right font-medium text-gray-600",children:"Price"})]})}),i.jsxs("tbody",{children:[p.data.tests&&p.data.tests.length>0?p.data.tests.map(N=>i.jsxs("tr",{className:"border-b last:border-0 hover:bg-gray-100",children:[i.jsx("td",{className:"py-1 px-2",children:N.name}),i.jsxs("td",{className:"py-1 px-2 text-right",children:["₹",N.price]})]},N.id||N.name)):i.jsx("tr",{children:i.jsx("td",{colSpan:2,className:"py-1 px-2 italic text-gray-500",children:"No tests specified"})}),i.jsxs("tr",{className:"bg-gray-50 font-semibold",children:[i.jsx("td",{className:"py-1 px-2 text-right text-gray-700",children:"Total:"}),i.jsxs("td",{className:"py-1 px-2 text-right text-gray-900",children:["₹",_]})]})]})]})}),p.data.report&&i.jsxs("div",{className:"ml-4 mt-1 p-2 border-l-2 border-gray-200",children:[i.jsxs("div",{className:"flex justify-between items-center mb-2",children:[i.jsx("span",{className:"font-medium text-sm text-gray-700",children:"[Report]"}),i.jsxs("div",{className:"flex items-center",children:[i.jsx("span",{className:"text-gray-400 ml-1 flex items-center text-xs",children:ka===p.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",onClick:N=>N.stopPropagation(),children:i.jsx("input",{type:"datetime-local",defaultValue:ki(p.data.report.report_date),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:N=>{N.target.value&&En(p.data.id,"report",N.target.value),qr(null)},onKeyDown:N=>{if(N.key==="Enter"){const ee=N.target;ee.value&&En(p.data.id,"report",ee.value),qr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/reportDate ml-1",onClick:N=>{N.stopPropagation(),qr(p.data.id)},title:"Click to edit report date",children:["(",new Date(p.data.report.report_date).toLocaleDateString(),")",i.jsx(pt,{size:12,className:"ml-1 text-gray-500 hover:text-gray-700"})]})}),i.jsx("button",{onClick:()=>Zr(p.data.report.reportId),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400 ml-2",title:bn[p.data.report.reportId]?"Collapse Report":"Expand Report",children:bn[p.data.report.reportId]?i.jsx(ts,{size:14}):i.jsx(ns,{size:14})}),i.jsx("button",{onClick:()=>Lt({type:"Lab Report",data:p.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400 ml-1",title:"Delete Report",children:i.jsx(ht,{size:12})})]})]}),bn[p.data.report.reportId]&&(()=>{try{const N=JSON.parse(p.data.report.report_content||"{}");return typeof N=="object"&&N!==null&&p.data.report.tests?p.data.report.tests.map(ee=>i.jsxs("div",{style:{marginBottom:"10px"},children:[i.jsx("h5",{className:"font-semibold text-xs mt-2 mb-1 text-gray-700",children:ee.name}),N[ee.id]?i.jsx("div",{className:"mobile-edge-to-edge-table-container",children:i.jsxs("table",{className:"lab-inventory-table mobile-edge-to-edge-table w-full text-xs",children:[i.jsx("thead",{children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Parameter"}),i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Value"}),i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Normal Range"})]})}),i.jsx("tbody",{children:Object.entries(N[ee.id]).map(([we,Ee])=>{var $n;const Pe=($n=ee.default_parameters)==null?void 0:$n.find(zt=>zt.name===we);return i.jsxs("tr",{className:"border-b last:border-0",children:[i.jsx("td",{className:"py-1 px-2",children:we}),i.jsxs("td",{className:"py-1 px-2",children:[String(Ee)," ",(Pe==null?void 0:Pe.unit)||""]}),i.jsx("td",{className:"py-1 px-2 text-gray-500",children:(()=>{if(Pe&&Pe.type==="number"&&(Pe.lower_limit!=null||Pe.upper_limit!=null)){let zt="";return Pe.lower_limit!=null&&(zt+=` > ${Pe.lower_limit}`),Pe.lower_limit!=null&&Pe.upper_limit!=null&&(zt+=" - "),Pe.upper_limit!=null&&(zt+=` < ${Pe.upper_limit}`),zt.trim()||"N/A"}else if((Pe==null?void 0:Pe.type)==="boolean")return"N/A";return(Pe==null?void 0:Pe.normal_range)||"N/A"})()})]},we)})})]})}):i.jsx("p",{className:"italic text-gray-500 text-xs",children:"No parameters reported for this test."})]},ee.id)):i.jsx("div",{className:"text-xs prose",children:i.jsx(Qt,{remarkPlugins:[gt],children:p.data.report.report_content})})}catch{return i.jsx("div",{className:"text-xs prose",children:i.jsx(Qt,{remarkPlugins:[gt],children:p.data.report.report_content||"*No findings recorded.*"})})}})()]})]})},[wa,sr,En,Xr,dt,Ra,a,Lt,ka,bn,Zr,Fa]),Sl=w.useCallback((p,g)=>i.jsx("div",{className:"ai-context-text w-full",children:_a===p.data.id?i.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[i.jsx("input",{type:"text",value:Pt,onChange:f=>Kt(f.target.value),className:"border rounded px-2 py-1 text-sm w-full",autoFocus:!0,onKeyDown:async f=>{if(f.key==="Enter"&&Pt.trim()){Zn(!0);try{await K(`/api/patients/complaints/${p.data.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:Pt.trim()})}),p.data.complaint=Pt.trim(),_n(null),Kt("")}catch(_){console.error("Error updating complaint:",_)}Zn(!1)}f.key==="Escape"&&(_n(null),Kt(""))},disabled:Nn}),i.jsxs("div",{className:"flex gap-1",children:[i.jsx("button",{onClick:async()=>{if(Pt.trim()){Zn(!0);try{await K(`/api/patients/complaints/${p.data.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:Pt.trim()})}),p.data.complaint=Pt.trim(),_n(null),Kt("")}catch(f){console.error("Error updating complaint:",f)}Zn(!1)}},className:"text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600",disabled:Nn||!Pt.trim(),children:Nn?"Saving...":"Save"}),i.jsx("button",{onClick:()=>{_n(null),Kt("")},className:"text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300",disabled:Nn,children:"Cancel"})]})]}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 rounded px-1 -mx-1 transition-colors inline-block",onClick:()=>{_n(p.data.id),Kt(p.data.complaint)},title:"Click to edit",children:[p.data.complaint,i.jsxs("span",{className:"text-gray-400 ml-1",children:["(",new Date(p.originalDateString).toLocaleDateString(),")"]})]})}),[_a,Pt,Nn,Lt]),Pl=w.useMemo(()=>i.jsxs("div",{className:"flex space-x-2",children:[i.jsx("button",{onClick:za,className:"button-primary blue text-xs px-2 py-1",disabled:rr||Ue.filter(p=>p.status==="pending").length<2,title:"Merge all pending orders into one",children:rr?"Merging...":"Merge Orders"}),i.jsxs("button",{onClick:()=>ia(!0),className:"button-primary green text-xs px-2 py-1",title:"Manually create a new pharmacy order",disabled:!d,children:[i.jsx(pr,{size:12,className:"mr-1"})," Create Order"]})]}),[za,rr,Ue,d]),Tl=w.useMemo(()=>i.jsxs("div",{className:"flex space-x-2",children:[i.jsx("button",{onClick:qa,className:"button-primary blue text-xs px-2 py-1",title:"Tell AI to analyse the reports",disabled:A||Ge||$t||We,children:"Analyse Reports"}),i.jsxs("button",{onClick:()=>na(!0),className:"button-primary green text-xs px-2 py-1",title:"Manually create a new lab order",disabled:!d,children:[i.jsx(pr,{size:12,className:"mr-1"})," Create Lab Order"]})]}),[qa,A,Ge,$t,We,d]),[Ba,Ua]=w.useState(null),[Ma,Ha]=w.useState([]),[An,Wa]=w.useState(""),Va=(p,g)=>{if(!p||!p.report_content||!g)return"";try{const f=JSON.parse(p.report_content||"{}");if(typeof f!="object"||f===null)return`<p class="italic text-gray-500 text-xs">Report content is not structured data.</p><pre>${p.report_content}</pre>`;let _="";return g.forEach(N=>{f[N.id]?(_+=`<h5 class="font-semibold text-sm mt-2 mb-1">${N.name}</h5>`,_+='<table class="lab-report-print-table"><thead><tr><th>Parameter</th><th>Value</th><th>Normal Range</th></tr></thead><tbody>',Object.entries(f[N.id]).map(([ee,we])=>{var $n;const Ee=($n=N.default_parameters)==null?void 0:$n.find(zt=>zt.name===ee);let Pe="N/A";Ee&&Ee.type==="number"&&(Ee.lower_limit!=null||Ee.upper_limit!=null)?(Pe="",Ee.lower_limit!=null&&(Pe+=` > ${Ee.lower_limit}`),Ee.lower_limit!=null&&Ee.upper_limit!=null&&(Pe+=" - "),Ee.upper_limit!=null&&(Pe+=` < ${Ee.upper_limit}`),Pe=Pe.trim()||"N/A"):(Ee==null?void 0:Ee.type)==="boolean"?Pe="N/A":Ee!=null&&Ee.normal_range&&(Pe=Ee.normal_range),_+=`<tr><td>${ee}</td><td>${String(we)} ${(Ee==null?void 0:Ee.unit)||""}</td><td>${Pe}</td></tr>`}),_+="</tbody></table>"):_+=`<p class="italic text-gray-500 text-xs">No parameters reported for ${N.name}.</p>`}),_}catch{return`<p class="italic text-gray-500 text-xs">Error parsing report content.</p><pre>${p.report_content}</pre>`}};w.useEffect(()=>{const p=()=>{It(window.innerHeight)};return window.addEventListener("resize",p),p(),()=>window.removeEventListener("resize",p)},[]),w.useEffect(()=>{const p=f=>{if(!ie||!ye.current||!Q.current)return;const _=Q.current.getBoundingClientRect(),ee=f.clientX-ye.current.x;let we=ye.current.initialWidth+ee;const Ee=_.width-qe-10;we=Math.max(qe,we),we=Math.min(we,Ee);const Pe=we/_.width*100;ge(Pe)},g=()=>{de(!1),ye.current=null,document.body.style.cursor="",document.body.style.userSelect=""};return ie&&(window.addEventListener("mousemove",p),window.addEventListener("mouseup",g),document.body.style.cursor="col-resize",document.body.style.userSelect="none"),()=>{window.removeEventListener("mousemove",p),window.removeEventListener("mouseup",g),document.body.style.cursor="",document.body.style.userSelect=""}},[ie]);const El=p=>{if(!Q.current)return;p.preventDefault();const g=Q.current.querySelector(".edit-complaint-context-column");g&&(ye.current={x:p.clientX,initialWidth:g.offsetWidth},de(!0))},Ja=w.useCallback(async()=>{je(!0),x(null);try{const p=await K("/api/queue/doctor/new",{method:"POST"});if(!p.ok){const f=await p.json().catch(()=>({}));throw new Error(f.message||`Failed to create record: ${p.statusText}`)}const g=await p.json();if(!g.recordId)throw new Error("New record ID not received from server.");a(`/edit-complaint/${g.recordId}`,{replace:!0})}catch(p){x(`Failed to create new complaint record: ${p.message}`)}finally{je(!1)}},[a]);w.useEffect(()=>{(async()=>{Ta(!0);try{const g=await o.fetchQuery({queryKey:Dt.clinicSettings,queryFn:async()=>{const f=await K("/api/clinics/settings");if(!f.ok)throw new Error("Failed to fetch clinic settings.");return f.json()},staleTime:18e5});Vr({admissionCharge:parseFloat(g.admissionCharge||0).toFixed(2),perDayCharge:parseFloat(g.perDayCharge||0).toFixed(2),otherCharges:parseFloat(g.otherCharges||0).toFixed(2),aiMemory:g.aiMemory||"",aiMemoryUpdatedAt:g.aiMemoryUpdatedAt||null,clinicWideSystemPrompt:g.clinicWideSystemPrompt||"",clinicWideSystemPromptUpdatedAt:g.clinicWideSystemPromptUpdatedAt||null,gemini_api_key:g.gemini_api_key||""}),Jr(g.aiMemory||""),Cn(g.clinicWideSystemPrompt||"")}catch{}finally{Ta(!1)}})()},[]),w.useEffect(()=>{var g;(g=l.state)!=null&&g.initialComplaint&&u(l.state.initialComplaint);const p=async f=>{M(!0),x(null);try{const _=await o.fetchQuery({queryKey:Dt.queue.entry(f),queryFn:async()=>{const N=await K(`/api/queue/doctor/complaint/${f}`);if(!N.ok){const ee=await N.json().catch(()=>({}));throw new Error(ee.message||`HTTP error! status: ${N.status}`)}return N.json()},staleTime:6e4});y(_.patientId),Y(_.age),H(_.gender),W(_.case_summary||null),G(_.updatedAt||null)}catch{x("Failed to load current complaint details."),y(null),Y(void 0),H(void 0),W(null),G(null)}finally{M(!1)}};if(r)p(r);else if(t){const f=t;f&&(y(f),(async()=>{try{let N;try{N=await o.fetchQuery({queryKey:Dt.queue.latest(f),queryFn:async()=>{const we=await K(`/api/queue/patient/${f}/latest`);if(!we.ok)throw new Error("Failed");return we.json()},staleTime:5e3})}catch{}if(N!=null&&N._id){s(N._id),p(N._id);return}const ee=await K("/api/queue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:f,complaint:"Visit Initiated"})});if(ee.ok){const we=await ee.json();if(we!=null&&we.id){s(we.id),p(we.id);return}}}catch(N){console.error("Background queue resolution failed",N),x("Failed to initialize visit record.")}})())}else Ja()},[r,Ja,(Ya=l.state)==null?void 0:Ya.initialComplaint,t]),w.useEffect(()=>{d?Tn(d):(D(null),S([]),vt([]),Ct([]),kt([]),G(null),kn(!1))},[d]),w.useEffect(()=>{var f;const p=(f=l.state)==null?void 0:f.initialComplaint;p&&r&&(!A&&!T&&!xn&&!We&&!Je)&&!ke.current&&c===p&&(ke.current=!0,Wt(),a(l.pathname,{replace:!0,state:{}}))},[(Ka=l.state)==null?void 0:Ka.initialComplaint,r,c,A,T,xn,We,Je,a]);const Qa=()=>{le(L||""),j(!0),k(null)},Al=()=>{j(!1),le(""),k(null)},Dl=async()=>{if(!r){k("Missing Record ID.");return}oe(!0),k(null);try{const p=await K(`/api/queue/doctor/complaint/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({case_summary:X.trim()})});if(!p.ok){const f=await p.json().catch(()=>({}));throw new Error(f.message||`Failed to save case summary: ${p.statusText}`)}const g=await p.json();W(g.case_summary||X.trim()),G(g.updatedAt||null),j(!1)}catch(p){k(`Save Error: ${p.message}`)}finally{oe(!1)}};w.useEffect(()=>{(async()=>{ut(!0),nt(null);try{const[g,f]=await Promise.all([o.fetchQuery({queryKey:Dt.drugs.all,queryFn:async()=>{const _=await K("/api/drugs");if(!_.ok)throw new Error(`Pharmacy inventory error! status: ${_.status}`);const N=await _.json();return N.drugs||N},staleTime:6e5}),o.fetchQuery({queryKey:Dt.labTests.all,queryFn:async()=>{const _=await K("/api/lab-tests");if(!_.ok)throw new Error(`Lab inventory error! status: ${_.status}`);return _.json()},staleTime:6e5})]);_e(g),Ye(f||[])}catch(g){nt(g.message)}finally{ut(!1)}})()},[]);const Il=async()=>{if(!Ae)return;if(ir===Ae.aiMemory&&jn===Ae.clinicWideSystemPrompt){ar(!1);return}const p=ir!==Ae.aiMemory,g=jn!==Ae.clinicWideSystemPrompt;p&&Ea(!0),g&&Aa(!0);try{const f={...Ae};p&&(f.aiMemory=ir),g&&(f.clinicWideSystemPrompt=jn);const _=await K("/api/clinics/settings",{method:"PUT",body:JSON.stringify(f)});if(!_.ok){const ee=await _.json().catch(()=>({}));throw new Error(ee.message||"Failed to update clinic settings.")}const N=await _.json();Vr({admissionCharge:parseFloat(N.settings.admissionCharge).toFixed(2),perDayCharge:parseFloat(N.settings.perDayCharge).toFixed(2),otherCharges:parseFloat(N.settings.otherCharges).toFixed(2),aiMemory:N.settings.aiMemory||"",aiMemoryUpdatedAt:N.settings.aiMemoryUpdatedAt||(Ae==null?void 0:Ae.aiMemoryUpdatedAt)||null,clinicWideSystemPrompt:N.settings.clinicWideSystemPrompt||"",clinicWideSystemPromptUpdatedAt:N.settings.clinicWideSystemPromptUpdatedAt||(Ae==null?void 0:Ae.clinicWideSystemPromptUpdatedAt)||null}),p&&Jr(N.settings.aiMemory||""),g&&(Cn(N.settings.clinicWideSystemPrompt||""),ar(!1))}catch{}finally{p&&Ea(!1),g&&Aa(!1)}},Ga=()=>{Ae&&(Cn(Ae.clinicWideSystemPrompt||""),ar(!0))},Ol=()=>{ar(!1),Ae&&Cn(Ae.clinicWideSystemPrompt||"")},$l=p=>{navigator.clipboard.writeText(p).then(()=>{}).catch(g=>{console.error("Failed to copy text: ",g)})},ei=(p,g)=>{const f=window.open("","_blank");f&&(f.document.write(`
        <html>
          <head>
            <title>${g}</title>
            <style>
              body { font-family: sans-serif; margin: 20px; }
              h2 { text-align: center; margin-bottom: 20px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              pre { white-space: pre-wrap; word-wrap: break-word; }
              .ai-context-section { margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 5px; }
              .ai-context-section-title { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; color: #333; }
              .ai-context-text { margin-bottom: 5px; }
              .text-gray-400 { color: #999; }
              .font-semibold { font-weight: 600; }
              .italic { font-style: italic; }
              .mt-2 { margin-top: 8px; }
              .ml-1 { margin-left: 4px; }
              .ml-2 { margin-left: 8px; }
              .flex { display: flex; }
              .flex-col { flex-direction: column; }
              .w-full { width: 100%; }
              .text-xs { font-size: 0.75rem; }
              .text-sm { font-size: 0.875rem; }
              .prose { max-width: 65ch; }
              .prose table { display: table; } /* Ensure tables in markdown render correctly */
            </style>
          </head>
          <body>
            <h2>${g}</h2>
            <div id="print-content">${p}</div>
          </body>
        </html>
      `),f.document.close(),f.print())},Ll=()=>{if(Oe){const p=hi().use(gt).use(wi).processSync(b).toString();ei(`<div class="prose">${p}</div>`,"Summary")}};w.useEffect(()=>{if(h){let p=`
        <div class="print-section">
          <h3>Patient Details</h3>
          <p><strong>Name:</strong> ${h.name||"N/A"}</p>
          <p><strong>Token:</strong> ${h.patient_token_number||"N/A"}</p>
          <p><strong>Age:</strong> ${h.age||"N/A"}</p>
          <p><strong>Gender:</strong> ${h.gender||"N/A"}</p>
          <p><strong>Phone:</strong> ${h.phone||"N/A"}</p>
          <p><strong>Insurance:</strong> ${h.insurance_type||"N/A"}</p>
          <p><strong>Status:</strong> ${h.current_status||"N/A"}</p>
          <p><strong>Admitted:</strong> ${h.admission_date?new Date(h.admission_date).toLocaleDateString():"N/A"}</p>
          <p><strong>Discharged:</strong> ${h.discharge_date?new Date(h.discharge_date).toLocaleDateString():"N/A"}</p>
        </div>
        <div class="print-section">
          <h3>Case Summary</h3>
          <p>${L||"No summary available."}</p>
        </div>
        <div class="print-section">
          <h3>Complaints History</h3>
          ${Rt.length>0?`
            <ul>
              ${Rt.map(g=>`<li>${new Date(g.originalDateString).toLocaleDateString()}: ${g.data.complaint}</li>`).join("")}
            </ul>
          `:"<p>No past complaints.</p>"}
        </div>
        <div class="print-section">
          <h3>Pharmacy Orders</h3>
          ${ft.length>0?`
            <table class="print-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Drug Name</th>
                  <th>Quantity</th>
                  <th>Dosage</th>
                  <th>Directions</th>
                </tr>
              </thead>
              <tbody>
                ${ft.map(g=>{const f=g.data.medications.map((N,ee)=>`
                    <tr>
                      ${ee===0?`<td rowspan="${g.data.medications.length+(g.data.prescriptionForUnavailableDrugs?1:0)}">${new Date(g.originalDateString).toLocaleDateString()}</td>`:""}
                      ${ee===0?`<td rowspan="${g.data.medications.length+(g.data.prescriptionForUnavailableDrugs?1:0)}">${g.data.status}</td>`:""}
                      <td><strong>${N.name}</strong></td>
                      <td>
                        ${N.pack_quantity!==void 0&&N.pack_quantity>0?`Packs: ${N.pack_quantity}`:""}
                        ${N.pack_quantity!==void 0&&N.pack_quantity>0&&N.loose_quantity!==void 0&&N.loose_quantity>0?", ":""}
                        ${N.loose_quantity!==void 0&&N.loose_quantity>0?`Loose: ${N.loose_quantity}`:""}
                      </td>
                      <td>${N.tabletsPerDay&&N.numberOfDays?`${N.tabletsPerDay} tab/day for ${N.numberOfDays} days`:"N/A"}</td>
                      <td>${N.directions_to_use||"N/A"}</td>
                    </tr>
                  `).join("");let _="";return g.data.prescriptionForUnavailableDrugs&&(_=`
                      <tr>
                        <td colspan="4" style="background-color: #f9f9f9; padding: 10px;">
                          <div style="font-style: italic; margin-bottom: 5px; font-weight: 600;">Prescription for Unavailable Drugs:</div>
                          <div class="prose" style="font-size: 0.9em;">${hi().use(gt).use(wi).processSync(g.data.prescriptionForUnavailableDrugs).toString()}</div>
                        </td>
                      </tr>
                    `),f+_}).join("")}
              </tbody>
            </table>
          `:"<p>No pharmacy orders.</p>"}
        </div>
        <div class="print-section">
          <h3>Lab History (Orders & Reports)</h3>
          ${Ft.length>0?`
            ${Ft.map(g=>{const f=g.data.tests.map(N=>N.name).join(", ");let _="";return g.data.report&&(_=`
                  <div class="lab-report-print-container">
                    <h4>Lab Report (${new Date(g.data.report.report_date).toLocaleDateString()})</h4>
                    ${Va(g.data.report,g.data.report.tests)}
                  </div>
                `),`
                <div class="lab-history-item">
                  <p><strong>Order Date:</strong> ${new Date(g.originalDateString).toLocaleDateString()}</p>
                  <p><strong>Status:</strong> ${g.data.status}</p>
                  <p><strong>Tests:</strong> ${f}</p>
                  ${_}
                </div>
              `}).join("")}
          `:"<p>No lab history.</p>"}
        </div>
      `;Wa(p)}else Wa("")},[h,L,Rt,ft,Ft,Va]);const ti=()=>{An&&ei(An,`Patient Details - ${h==null?void 0:h.name}`)},Rl=p=>{u(p),Ua(null),Ha([]),setTimeout(()=>{Wt(p)},0)},Et=A||Ge||wt||We||T||Je||xn||J||gn||Wn||tl||rl||al||dt||St||Zt||en||rr||Jn||jr||Cr||Sr||Pr||ne,Fl=p=>{p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),!Et&&c.trim()&&r&&Wt())};w.useEffect(()=>{const p=window.SpeechRecognition||window.webkitSpeechRecognition;if(!p){Br("Speech recognition not supported in this browser.");return}const g=new p;return g.continuous=!0,g.interimResults=!0,g.lang="en-US",g.onresult=f=>{let _="";for(let N=f.resultIndex;N<f.results.length;++N)f.results[N].isFinal&&(_+=f.results[N][0].transcript);_&&u(N=>N+(N.endsWith(" ")||N===""?"":" ")+_)},g.onerror=f=>{Br(`Speech error: ${f.error}`),fl(!1)},g.onend=()=>{},er.current=g,()=>{er.current&&er.current.stop()}},[]);const zl=async()=>{if(d)if(Kn){ma(!0);try{const p=await K(`/api/patients/${d}/discharge`,{method:"POST"});if(!p.ok){const g=await p.json().catch(()=>({}));throw new Error(g.message||`Failed to discharge patient: ${p.status}`)}tn(d)}catch(p){x(`Discharge Error: ${p.message}`)}finally{ma(!1)}}else{ha(!0);try{const p=await K(`/api/patients/${d}/admit`,{method:"POST"});if(!p.ok){const g=await p.json().catch(()=>({}));throw new Error(g.message||`Failed to admit patient: ${p.status}`)}tn(d)}catch(p){x(`Admit Error: ${p.message}`)}finally{ha(!1)}}},ql=async p=>{if(d){fa(!0);try{const f=await K("/api/queue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:d})});if(!f.ok){const _=await f.json().catch(()=>({}));throw new Error(_.message||`Failed to add patient to ${p} queue: ${f.status}`)}alert(`Patient added to ${p} queue successfully!`),d&&(tn(d),Gr(d))}catch(g){x(`Add to Queue Error: ${g.message}`)}finally{fa(!1)}}},Bl=async()=>{if(r){ga(!0),x(null);try{const p=await K(`/api/queue/${r}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"seen"})});if(!p.ok){const g=await p.json().catch(()=>({}));throw new Error(g.message||"Failed to complete consultation")}alert("Consultation completed successfully!"),d&&(tn(d),Gr(d))}catch(p){x(`Error completing consultation: ${p.message}`)}finally{ga(!1)}}},Ul=async()=>{if(!d){Ht("Missing Patient ID.");return}if(!h){Ht("Patient details not loaded.");return}Fr(!0),Ht(null);try{const p={};let g=!1;if(Er!==h.name&&(p.name=Er,g=!0),Dr!==h.age&&(p.age=Dr,g=!0),Or!==h.gender&&(p.gender=Or,g=!0),Lr!==h.phone&&(p.phone=Lr,g=!0),!g){Ht("No changes detected."),Fr(!1),Xn(!1);return}const f=await K(`/api/patients/${d}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(!f.ok){const N=await f.json().catch(()=>({}));throw new Error(N.message||`Failed to update patient details: ${f.statusText}`)}const _=await f.json();D(_),Y(_.age),H(_.gender),Ar(_.name),Ir(_.age),$r(_.gender),Rr(_.phone),Xn(!1)}catch(p){Ht(`Save Error: ${p.message}`)}finally{Fr(!1)}},Ml=w.useCallback(()=>{if(!h)return null;const p={token_number:h.patient_token_number||"N/A",name:h.name||"N/A",age:h.age||"N/A",gender:h.gender||"N/A",phone:h.phone||"N/A"};return Rt.length>0?p.complaints_history=Rt.map(g=>`${g.data.complaint} (${new Date(g.originalDateString).toLocaleDateString()})`).join("; "):p.complaints_history="No past complaints.",ft.length>0?p.pharmacy_orders_history=ft.map(g=>`Order: ${g.data.medications.map(_=>{let N=`${_.name}`;return _.pack_quantity!==void 0&&_.pack_quantity>0&&(N+=` Packs: ${_.pack_quantity}`),_.loose_quantity!==void 0&&_.loose_quantity>0&&(N+=` Loose: ${_.loose_quantity}`),N}).join(", ")} (${g.data.status}, ${new Date(g.originalDateString).toLocaleDateString()})`).join("; "):p.pharmacy_orders_history="No pharmacy orders.",Ft.length>0?p.lab_orders_history=Ft.map(g=>{let _=`Lab Order: ${g.data.tests.map(N=>N.name).join(", ")} (${g.data.status}, ${new Date(g.originalDateString).toLocaleDateString()})`;return g.data.report&&(_+=` - Report: ${g.data.report.report_content} (${new Date(g.data.report.report_date).toLocaleDateString()})`),_}).join("; "):p.lab_orders_history="No lab history.",mt.length>0?p.recurring_medications=mt.map((g,f)=>{let _=`${f+1}. ${g.medicationName} (${g.frequencyDays} days, ${g.status})`;return g.tabletsPerDay&&(_+=` - ${g.tabletsPerDay} tabs/day`),g.numberOfDays&&(_+=` for ${g.numberOfDays} days`),_}).join("; "):p.recurring_medications="No recurring medications.",p},[h,Rt,ft,Ft,mt]),Hl=()=>{if(!h){Br("Patient details are required to use the Live API.");return}Hr(!0)},Wl=()=>{var p;(p=tr.current)==null||p.click()},Vl=p=>{var f;const g=(f=p.target.files)==null?void 0:f[0];g&&ja(g)},ni=w.useRef(!1),Dn=w.useRef(null),an=w.useRef(null),st=w.useRef({response:!0,pharmacy:!1,recurring:!1,labs:!1,history:!1,summary:!1}),[In,sn]=w.useState("response"),On=p=>{ni.current=!0,sn(p),Dn.current&&clearTimeout(Dn.current),Dn.current=setTimeout(()=>{ni.current=!1},1e3);const g={behavior:"smooth",block:"start"};p==="response"&&B.current?B.current.scrollIntoView(g):p==="meds"?Z.current?Z.current.scrollIntoView(g):an.current&&an.current.scrollIntoView(g):p==="labs"&&E.current?E.current.scrollIntoView(g):p==="history"&&z.current?z.current.scrollIntoView(g):p==="summary"&&I.current&&I.current.scrollIntoView(g)};return w.useEffect(()=>{const p=new IntersectionObserver(g=>{ni.current||(g.forEach(f=>{f.target===B.current?st.current.response=f.isIntersecting:f.target===Z.current?st.current.pharmacy=f.isIntersecting:f.target===an.current?st.current.recurring=f.isIntersecting:f.target===E.current?st.current.labs=f.isIntersecting:f.target===z.current?st.current.history=f.isIntersecting:f.target===I.current&&(st.current.summary=f.isIntersecting)}),st.current.response?sn("response"):st.current.pharmacy||st.current.recurring?sn("meds"):st.current.labs?sn("labs"):st.current.history?sn("history"):st.current.summary&&sn("summary"))},{root:null,threshold:0,rootMargin:"-10% 0px -50% 0px"});return B.current&&p.observe(B.current),Z.current&&p.observe(Z.current),E.current&&p.observe(E.current),z.current&&p.observe(z.current),I.current&&p.observe(I.current),an.current&&p.observe(an.current),()=>{p.disconnect(),Dn.current&&clearTimeout(Dn.current)}},[]),i.jsxs("div",{className:"edit-complaint-page",style:{height:`${v}px`},children:[i.jsx(Ph,{ref:Sn,recordId:r,patientId:d,patientDetails:h,caseSummary:L,caseSummaryUpdatedAt:C,clinicSettings:Ae,userMessages:m,selectedImageFile:Mr,pendingLabOrders:kr,labReports:ct,pastComplaints:Le,pharmacyOrders:Ue,pharmacyInventory:ue,labInventory:Se,recurringMedications:mt,currentComplaint:c,setCurrentComplaint:u,setAiResponse:Fe,setAiResponseText:Ne,setAiResponseJsonString:be,setShowAiJsonDetails:Qe,setIsLoadingAi:lt,setAiError:()=>{},setIsSubmittingAiOrder:yn,setAiOrderSubmissionStatus:()=>{},setIsSubmittingAiLabOrder:Vn,setAiLabOrderSubmissionStatus:()=>{},setIsSubmittingAiComplaint:nl,setAiComplaintSubmissionStatus:()=>{},setIsUpdatingCaseSummary:il,setAiCaseSummaryUpdateStatus:()=>{},setCaseSummary:W,setCaseSummaryUpdatedAt:G,setIsUpdatingAiMemoryByAI:sl,setAiMemoryUpdateByAIStatus:()=>{},setFollowUpQuestion:Ua,setFollowUpOptions:Ha,setError:x,setIsSavingAiResponse:Yt,setSaveAiResponseError:()=>{},fetchPharmacyOrdersData:nn,fetchPendingLabOrdersData:rn,fetchLabReportsData:Pn,fetchPastComplaintsData:Ia,fetchPatientDetails:tn,fetchRecurringMedicationsData:Tn,setClinicSettings:Vr,setEditedAiMemory:Jr,handleDeleteItem:Lt,setCanUndo:Da,onAiActionSuccess:me,addMessage:Ur,onPrintLabBill:p=>{dl(p),ua(!0)},onPrintPharmacyBill:bl}),i.jsx(Hf,{isOpen:cl,onClose:()=>ua(!1),billData:ul}),i.jsx(Wf,{isOpen:pl,onClose:()=>da(!1),billData:hl}),gl&&h&&i.jsx(Kl,{onClose:()=>Hr(!1),patientData:Ml(),tokenNumber:h.patient_token_number?String(h.patient_token_number):null,onAiSummaryChange:p=>{p&&(u(p),Wt(p),Hr(!1))}}),i.jsxs("div",{className:"edit-complaint-header",children:[i.jsx("button",{onClick:()=>a(-1),disabled:Et,className:"back-button",title:"Go Back",children:i.jsx(rc,{size:20})}),i.jsx("span",{ref:tt,style:{position:"absolute",visibility:"hidden",height:"auto",width:"auto",whiteSpace:"nowrap"}}),!h&&$t&&i.jsxs("div",{className:"edit-complaint-patient-details",style:{display:"flex",alignItems:"center",gap:"12px",padding:"8px 12px"},children:[i.jsx(Ce,{width:"120px",height:"18px",style:{marginRight:"8px"}}),i.jsx(Ce,{width:"60px",height:"16px"}),i.jsx(Ce,{width:"80px",height:"16px"}),i.jsx(Ce,{width:"90px",height:"16px"})]}),h&&i.jsx("div",{className:"edit-complaint-patient-details",children:h&&!ya?i.jsx(i.Fragment,{children:i.jsxs(i.Fragment,{children:[i.jsx("button",{onClick:()=>{Xn(!0),Ar(h.name||""),Ir(h.age),$r(h.gender),Rr(h.phone),Ht(null)},className:"edit-button mr-2",title:"Edit Patient Details",disabled:St,children:i.jsx(pt,{size:14})}),i.jsxs("div",{className:"patient-info-text-wrapper",children:[i.jsx("span",{className:"patient-name",children:h.name??"N/A"}),i.jsxs("span",{className:"patient-meta",children:[h.patient_token_number!==null&&h.patient_token_number!==void 0&&` (#${h.patient_token_number})`," - ",h.age??"N/A"," / ",h.gender??"N/A"]}),h.phone&&i.jsxs("span",{className:"patient-phone",children:[" / ",h.phone]}),Wr!==null&&Wr>0&&i.jsxs("span",{className:"patient-debt-badge",style:{marginLeft:"8px",padding:"2px 8px",backgroundColor:"rgba(220, 53, 69, 0.15)",color:"#dc3545",borderRadius:"12px",fontSize:"0.75em",fontWeight:"bold",border:"1px solid rgba(220, 53, 69, 0.3)",cursor:"pointer"},onClick:()=>a("/dashboard/patient-debts"),title:"Click to manage patient debts",children:["Debt: ₹",Wr.toFixed(2)]})]}),i.jsx("button",{onClick:p=>{p.stopPropagation(),ti()},disabled:!An,title:"Print Patient Details",className:"icon-button small ml-2 text-gray-600 hover:text-gray-900 flex-shrink-0",children:i.jsx(ln,{size:14})})]})}):h&&ya?i.jsxs("div",{className:"patient-details-edit-form",children:[i.jsx("input",{type:"text",value:Er,onChange:p=>Ar(p.target.value),placeholder:"Name",className:"edit-input",disabled:St}),i.jsx("input",{type:"number",value:Dr??"",onChange:p=>Ir(p.target.value?parseInt(p.target.value):null),placeholder:"Age",className:"edit-input",disabled:St}),i.jsxs("select",{value:Or??"",onChange:p=>$r(p.target.value||null),className:"edit-input",disabled:St,children:[i.jsx("option",{value:"",children:"Select Gender"}),i.jsx("option",{value:"M",children:"Male"}),i.jsx("option",{value:"F",children:"Female"}),i.jsx("option",{value:"O",children:"Other"})]}),i.jsx("input",{type:"text",value:Lr??"",onChange:p=>Rr(p.target.value||null),placeholder:"Phone Number",className:"edit-input",disabled:St}),i.jsxs("div",{className:"edit-actions",children:[i.jsx("button",{onClick:()=>{Xn(!1),Ht(null)},className:"button-secondary",disabled:St,children:"Cancel"}),i.jsx("button",{onClick:Ul,className:"button-primary blue",disabled:St,children:St?"Saving...":"Save"})]}),ba&&i.jsx("p",{className:"text-red-500 text-xs mt-1",children:ba})]}):i.jsxs("div",{className:"edit-complaint-patient-details",children:[q??"N/A"," / ",O??"N/A",i.jsx("button",{onClick:p=>{p.stopPropagation(),ti()},disabled:!An,title:"Print Patient Details",className:"icon-button small ml-2 text-gray-600 hover:text-gray-900",children:i.jsx(ln,{size:14})})]})}),!h&&q!==void 0&&O!==void 0&&i.jsxs("div",{className:"edit-complaint-patient-details",children:[q??"N/A"," / ",O??"N/A",i.jsx("button",{onClick:p=>{p.stopPropagation(),ti()},disabled:!An,title:"Print Patient Details",className:"icon-button small ml-2 text-gray-600 hover:text-gray-900",children:i.jsx(ln,{size:14})})]}),i.jsx("div",{style:{minWidth:"64px",display:"flex",justifyContent:"flex-end"},children:i.jsx("button",{onClick:e,className:"icon-button small text-gray-600 hover:text-gray-900 bg-gray-100 hover:bg-gray-200",title:"Open Command Bar (Ctrl+K)",style:{padding:"0.2rem",borderRadius:"8px"},children:i.jsx(ic,{size:24})})})]}),i.jsxs("div",{className:"edit-complaint-content-area",ref:Q,children:[va.length>0&&i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"edit-complaint-chat-column",style:{width:"30%",minWidth:"320px",maxWidth:"40%",flexShrink:0},children:i.jsx(Vf,{messages:va})}),i.jsx("div",{className:"draggable-divider",onMouseDown:()=>{}})]}),i.jsxs("div",{ref:B,className:"edit-complaint-main-column",style:{flex:1,minWidth:0},children:[pe&&i.jsxs("div",{className:"general-error-message",children:["Error: ",pe]}),Ge&&i.jsxs("div",{className:"ai-response-container",style:{padding:"16px"},children:[i.jsx(Ce,{width:"100%",height:"18px",style:{marginBottom:"10px"}}),i.jsx(Ce,{width:"95%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Ce,{width:"85%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Ce,{width:"90%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Ce,{width:"70%",height:"16px"})]}),!Ge&&(b||Me)&&i.jsxs("div",{ref:$e,className:`${Me?"ai-function-call-block":"ai-response-container"} group`,children:[b&&i.jsx(Qt,{remarkPlugins:[gt],children:b}),Me&&i.jsxs("div",{className:"ai-json-details-container",children:[i.jsxs("button",{onClick:()=>Qe(!at),className:"ai-json-toggle-button",children:[at?i.jsx(ts,{size:14,className:"mr-1"}):i.jsx(ns,{size:14,className:"mr-1"}),at?"Hide":"Show"," AI Function Call Details"]}),at&&i.jsx("pre",{className:"ai-json-pre",children:i.jsx("code",{children:JSON.stringify(JSON.parse(Me),null,2)})})]}),i.jsxs("div",{className:"ai-response-actions",children:[i.jsx("button",{onClick:()=>$l(Oe),disabled:!Oe,title:"Copy Full AI Response",children:i.jsx(ac,{size:12})}),i.jsx("button",{onClick:Ll,disabled:!Oe,title:"Print AI Response",children:i.jsx(ln,{size:12})})]})]})]}),i.jsx("div",{className:"draggable-divider",onMouseDown:El}),i.jsx("div",{ref:he,className:"edit-complaint-context-column",style:{flexBasis:`calc(${100-ve}% - 5px)`},children:i.jsxs("div",{className:"ai-context-container",children:[i.jsxs("h3",{className:"ai-context-header",children:[i.jsx("span",{children:"AI Context:"}),(h==null?void 0:h.insurance_type)&&i.jsx("div",{className:"insurance-type-container mt-2",children:i.jsxs("select",{ref:Ve,value:h.insurance_type,onChange:p=>wl(h.id,p.target.value),className:"insurance-type-select",children:[i.jsx("option",{value:"cash",children:"Cash"}),i.jsx("option",{value:"insurance",children:"Insurance"}),i.jsx("option",{value:"no_cash_insurance",children:"No Cash Insurance"})]})})]}),i.jsxs("div",{ref:Re,className:"ai-context-section",children:[i.jsx("h4",{className:"ai-context-section-title",children:"Admission Status"}),$t?i.jsxs("div",{className:"space-y-2",children:[i.jsx(Ce,{width:"60%",height:"1.2em"}),i.jsx(Ce,{width:"50%",height:"1.2em"}),i.jsx(Ce,{width:"40%",height:"1.2em"}),i.jsxs("div",{className:"flex space-x-2 mt-2",children:[i.jsx(Ce,{width:"80px",height:"30px"}),i.jsx(Ce,{width:"100px",height:"30px"})]})]}):i.jsxs(i.Fragment,{children:[(h==null?void 0:h.admission_date)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Admitted:"})," ",new Date(h.admission_date).toLocaleDateString()]}),(h==null?void 0:h.discharge_date)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Discharged:"})," ",new Date(h.discharge_date).toLocaleDateString()]}),(h==null?void 0:h.current_status)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Current Status:"})," ",i.jsx("span",{className:"font-semibold",children:h.current_status})]}),i.jsxs("div",{className:"flex space-x-2 mt-2",children:[i.jsx("button",{onClick:zl,className:`admit-discharge-button ${Kn?"discharge":"admit"}`,title:Kn?"Discharge Patient":"Admit Patient",disabled:!d||jr||Cr,children:jr?"Admitting...":Cr?"Discharging...":Kn?"Discharge":"Admit"}),i.jsxs("button",{onClick:()=>a(`/patient/${encodeURIComponent(d??"")}/admission-billing`),className:"queue-status-button",style:{backgroundColor:"#e0f2fe",color:"#0369a1",border:"1px solid #bae6fd",display:"flex",alignItems:"center",gap:"4px"},title:"Go to Admission Billing",disabled:!d,children:[i.jsx(Za,{size:14})," Billing"]}),i.jsx("button",{onClick:()=>ql("doctor"),className:`queue-status-button ${Yn?"in-queue":"add-to-queue"}`,title:Yn?"Patient is in Doctor Queue":"Add Patient to Doctor Queue",disabled:!d||Sr||Yn,children:Sr?"Adding...":Yn?"In Queue":"Add to Queue"}),i.jsx("button",{onClick:Bl,className:"complete-consultation-button",title:"Mark Consultation as Complete",disabled:Pr,children:Pr?"Completing...":"Complete Consultation"})]})]})]}),i.jsx("div",{ref:Z,children:i.jsx(mi,{title:"Pharmacy Order History",headerAction:Pl,items:ft,isLoading:A||$t,loadingText:"Loading...",noDataText:"No orders.",renderItemContent:jl})}),i.jsxs("div",{ref:an,className:"ai-context-section mt-4",children:[i.jsxs("div",{className:"flex justify-between items-center mb-2",children:[i.jsx("h4",{className:"ai-context-section-title mb-0",children:"Recurring Medications"}),i.jsxs("button",{onClick:()=>{wn([]),Qn(!0)},className:"text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded flex items-center gap-1",children:[i.jsx(pr,{size:12})," Add"]})]}),mt.length>0?i.jsx("div",{className:"overflow-x-auto",children:i.jsxs("table",{className:"w-full text-xs text-left",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b",children:[i.jsx("th",{className:"py-1 px-2",children:"#"}),i.jsx("th",{className:"py-1 px-2",children:"Medication"}),i.jsx("th",{className:"py-1 px-2",children:"Qty"}),i.jsx("th",{className:"py-1 px-2",children:"Frequency"}),i.jsx("th",{className:"py-1 px-2",children:"Next Delivery"}),i.jsx("th",{className:"py-1 px-2",children:"Status"}),i.jsx("th",{className:"py-1 px-2"})]})}),i.jsx("tbody",{children:mt.map((p,g)=>i.jsxs("tr",{className:"border-b last:border-0 hover:bg-gray-50",children:[i.jsx("td",{className:"py-1 px-2 font-medium text-gray-500",children:g+1}),i.jsxs("td",{className:"py-1 px-2 font-medium",children:[p.medicationName,i.jsxs("div",{className:"text-[10px] text-gray-500 font-normal",children:[p.tabletsPerDay?`${p.tabletsPerDay} tabs/day`:"",p.tabletsPerDay&&p.numberOfDays?" • ":"",p.numberOfDays?`${p.numberOfDays} days`:"",p.directions?` • ${p.directions}`:""]})]}),i.jsx("td",{className:"py-1 px-2",children:p.quantity}),i.jsxs("td",{className:"py-1 px-2",children:[p.frequencyDays," days"]}),i.jsx("td",{className:"py-1 px-2",children:new Date(p.nextDeliveryDate).toLocaleDateString()}),i.jsx("td",{className:"py-1 px-2",children:i.jsx("span",{className:`px-1.5 py-0.5 rounded-full text-[10px] ${p.status==="active"?"bg-green-100 text-green-800":p.status==="paused"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:p.status})}),i.jsx("td",{className:"py-1 px-2 text-right",children:i.jsx("button",{onClick:()=>{Gn(p),Nr(!0)},className:"text-gray-400 hover:text-blue-600 p-1",title:"Edit",children:i.jsx(pt,{size:12})})})]},p.id))})]})}):A||$t?i.jsx("div",{style:{marginTop:"8px"},children:[1,2,3].map(p=>i.jsxs("div",{style:{display:"flex",gap:"12px",marginBottom:"10px"},children:[i.jsx(Ce,{width:"30px",height:"14px"}),i.jsx(Ce,{width:"120px",height:"14px"}),i.jsx(Ce,{width:"40px",height:"14px"}),i.jsx(Ce,{width:"60px",height:"14px"}),i.jsx(Ce,{width:"80px",height:"14px"})]},p))}):i.jsx("p",{className:"text-gray-500 text-sm italic",children:"No recurring medications."})]}),ra&&i.jsx(Bf,{isOpen:ra,onClose:()=>ia(!1),patientId:d,pharmacyInventory:ue,fetchPharmacyOrdersData:nn,isLoadingInventory:Je}),i.jsxs("div",{ref:E,children:[i.jsx(mi,{title:"Lab History (Orders & Reports)",headerAction:Tl,items:Ft,onDeleteItem:void 0,onEditLabOrder:void 0,onSaveLabOrder:vl,onCancelEditLabOrder:kl,onLabOrderTestChange:_l,onLabOrderStatusChange:Nl,onBillLabOrder:void 0,onUpdateLabOrderStatus:void 0,onEnterLabReport:void 0,labInventory:Se,isSavingLabOrder:dt,isLoading:xn||We||$t,loadingText:"Loading...",noDataText:"No lab Hx.",expandedLabReports:bn,toggleLabReport:Zr,renderItemContent:Cl}),i.jsx(_h,{isOpen:ll,onClose:()=>na(!1),patientId:d,labInventory:Se,fetchPendingLabOrdersData:rn,isLoadingInventory:Je}),i.jsx("div",{ref:z,children:i.jsx(mi,{title:"Complaints History",items:Rt,isLoading:T||$t,loadingText:"Loading...",noDataText:"No past Hx.",renderItemContent:Sl,onDeleteItem:Lt})}),i.jsxs("div",{className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsxs("h4",{className:"ai-context-section-title",children:[i.jsx(sc,{size:16,className:"text-purple-600"})," Clinic-wide System Prompt"]}),!Qr&&i.jsx("button",{onClick:Ga,className:"edit-button",title:"Edit System Prompt",disabled:Pa||Zt||en,children:i.jsx(pt,{size:14})})]}),Qr&&Ae?i.jsxs("div",{className:"mt-2",children:[i.jsx("textarea",{value:jn,onChange:p=>Cn(p.target.value),className:"context-edit-textarea",placeholder:"Enter clinic system prompt...",disabled:Zt||en}),i.jsxs("div",{className:"context-edit-actions",children:[i.jsx("button",{onClick:Ol,disabled:Zt||en,className:"button-secondary",children:"Cancel"}),i.jsxs("button",{onClick:Il,disabled:Zt||en||ir===Ae.aiMemory&&jn===Ae.clinicWideSystemPrompt,className:"button-primary purple",children:[i.jsx(Js,{size:14,className:"mr-1"}),en||Zt?"Saving...":"Save Settings"]})]})]}):i.jsx("div",{className:"ai-context-text whitespace-pre-wrap mt-1 prose prose-sm max-w-none cursor-pointer hover:bg-gray-50 rounded p-1 -m-1 transition-colors",onClick:Ga,title:"Click to edit system prompt",children:Pa?i.jsxs("div",{style:{marginTop:"4px"},children:[i.jsx(Ce,{width:"100%",height:"14px",style:{marginBottom:"6px"}}),i.jsx(Ce,{width:"90%",height:"14px",style:{marginBottom:"6px"}}),i.jsx(Ce,{width:"70%",height:"14px"})]}):Ae!=null&&Ae.clinicWideSystemPrompt?i.jsx(Qt,{remarkPlugins:[gt],children:Ae.clinicWideSystemPrompt}):i.jsx("span",{className:"italic text-gray-400",children:"N/A - Click to add."})}),!Qr&&(Ae==null?void 0:Ae.clinicWideSystemPromptUpdatedAt)&&i.jsxs("p",{className:"ai-context-text text-gray-400 mt-1",style:{fontSize:"0.625rem"},children:["Prompt Last Updated: ",new Date(Ae.clinicWideSystemPromptUpdatedAt).toLocaleDateString()]})]}),i.jsxs("div",{ref:I,className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsx("h4",{className:"ai-context-section-title",children:"Case Summary"}),!F&&i.jsx("button",{onClick:Qa,className:"edit-button",title:"Edit Case Summary",disabled:A||ne,children:i.jsx(pt,{size:14})})]}),F?i.jsxs("div",{className:"mt-2",children:[i.jsx("textarea",{value:X,onChange:p=>le(p.target.value),className:"context-edit-textarea",rows:4,placeholder:"Enter case summary...",disabled:ne}),V&&i.jsx("p",{className:"text-red-500 text-xs mt-1",children:V}),i.jsxs("div",{className:"context-edit-actions",children:[i.jsx("button",{onClick:Al,disabled:ne,className:"button-secondary",children:"Cancel"}),i.jsx("button",{onClick:Dl,disabled:ne||X===L,className:"button-primary blue",children:ne?"Saving...":"Save"})]})]}):i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"ai-context-text whitespace-pre-wrap mt-1 prose prose-sm max-w-none cursor-pointer hover:bg-gray-50 rounded p-1 -m-1 transition-colors",onClick:Qa,title:"Click to edit case summary",children:A?i.jsxs("div",{style:{marginTop:"8px"},children:[i.jsx(Ce,{width:"100%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Ce,{width:"85%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Ce,{width:"65%",height:"16px"})]}):L?i.jsx(Qt,{remarkPlugins:[gt],components:{},children:L}):i.jsx("span",{className:"italic text-gray-400",children:"N/A - Click to add."})}),C&&i.jsxs("p",{className:"ai-context-text text-gray-400 mt-1",style:{fontSize:"0.625rem"},children:["Last Edited: ",new Date(C).toLocaleDateString()]})]})]}),Rt.length===0&&Ft.length===0&&ft.length===0&&!(T||xn||We)&&i.jsx("p",{className:"ai-context-text italic mt-4",children:"No recent history for this patient."}),Jn&&i.jsx("p",{className:"text-yellow-600 text-xs mt-2 ai-context-text",children:"Deleting..."}),ea&&i.jsx("p",{className:"text-red-600 text-xs mt-2 ai-context-text",children:ea})]})]})})]}),i.jsxs("div",{className:"edit-complaint-input-area",children:[i.jsxs("div",{className:"status-messages-container",children:[_t&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:_t}),te&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:te}),Xi&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:Xi}),jt&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:jt})]}),r&&!J&&i.jsxs(w.Fragment,{children:[Ba&&i.jsxs("div",{className:"follow-up-question-container",children:[i.jsx("p",{className:"question-text",children:Ba}),Ma.length>0&&i.jsx("div",{className:"options-grid",children:Ma.map((p,g)=>i.jsx("button",{onClick:()=>Rl(p),className:"option-button",children:p},g))})]}),Na&&i.jsx("div",{className:"speech-error-display",children:Na}),Mr&&i.jsxs("div",{className:"selected-file-display",children:[i.jsxs("span",{children:["Selected: ",Mr.name]}),i.jsx("button",{onClick:()=>{ja(null),tr.current&&(tr.current.value="")},className:"remove-file-button",title:"Remove image",children:"×"})]}),i.jsxs("div",{className:"input-section-selector",children:[i.jsx("button",{onClick:()=>On("response"),className:`selector-button ${In==="response"?"active":""}`,children:"AI"}),i.jsx("button",{onClick:()=>On("meds"),className:`selector-button ${In==="meds"?"active":""}`,children:"Meds"}),i.jsx("button",{onClick:()=>On("labs"),className:`selector-button ${In==="labs"?"active":""}`,children:"Labs"}),i.jsx("button",{onClick:()=>On("history"),className:`selector-button ${In==="history"?"active":""}`,children:"Hx"}),i.jsx("button",{onClick:()=>On("summary"),className:`selector-button ${In==="summary"?"active":""}`,children:"Sum"})]}),i.jsx("div",{className:"input-wrapper",children:i.jsxs("div",{className:"main-input-container",children:[i.jsx("input",{type:"file",ref:tr,onChange:Vl,accept:"image/*",className:"hidden"}),i.jsx("textarea",{ref:He,className:"complaint-textarea",value:c,onChange:p=>u(p.target.value),onKeyDown:Fl,placeholder:"Name, Age, Sex... Chat with Patient Manager AI",disabled:Et||!r||vn}),i.jsxs("div",{className:"chat-input-actions-container",children:[d&&i.jsx("button",{onClick:()=>a("/inventory"),disabled:Je,className:"icon-button",title:"View Inventory",children:i.jsx(oc,{size:14})}),i.jsx("button",{type:"button",onClick:Wl,disabled:Et||!r||vn,className:"icon-button",title:"Attach Image",children:i.jsx(lc,{size:14})}),i.jsx("button",{type:"button",onClick:Hl,disabled:Et||!r||!er.current,className:`mic-button ${vn?"listening":""}`,title:vn?"Stop":"Mic",children:i.jsx(cc,{size:14})}),i.jsx("button",{onClick:()=>Wt(),disabled:Et||!c.trim()||!r||vn,className:"send-button",title:Et?"Processing...":"Save & Ask AI",children:Et?i.jsx("div",{className:"custom-loader-circle",role:"status","aria-label":"loading"}):i.jsx(uc,{size:14})}),yl&&i.jsx("button",{type:"button",onClick:xl,disabled:Et,className:"icon-button text-red-500",title:"Undo Last AI Actions",children:i.jsx(ht,{size:14})})]})]})})]})]}),oa&&d&&i.jsx(Uf,{isOpen:oa,onClose:()=>Qn(!1),onSuccess:()=>{d&&Tn(d),Qn(!1),wn([])},patientId:d,initialItems:ca}),la&&vr&&i.jsx(Mf,{isOpen:la,onClose:()=>Nr(!1),onSuccess:()=>{d&&Tn(d),Nr(!1),Gn(void 0)},medication:vr}),aa&&i.jsx(pc,{isOpen:aa,onClose:()=>{sa(!1),Gn(void 0),wn([])},onSuccess:()=>{d&&Tn(d),sa(!1),Gn(void 0),wn([])},initialItems:ca,medication:vr,initialPatient:h?{id:h.id,name:h.name,phone:h.phone||"",patient_token_number:String(h.patient_token_number||"")}:void 0})]})};export{og as default};
