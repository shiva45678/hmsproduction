import{d as se,f as p,j as e,S as x,q as _}from"./index-DE8wu5Ou.js";import{r,j as ne,u as ie}from"./react-vendor-Cc0P4_ZX.js";import{N as re,O as ce,v as K,F as W,Q as J,W as V,p as de}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const w=s=>{if(!s)return"N/A";try{return new Date(s).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})}catch{return"Invalid Date"}},le=s=>{if(!s)return"Unknown Date";try{return new Date(s).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}catch{return"Invalid Date"}},O=({title:s,icon:P,items:y,renderItemContent:N,isLoading:k,noDataText:f})=>{const C=r.useMemo(()=>{const c={};y.forEach(i=>{if(isNaN(i.date.getTime())){c["Unknown Date"]||(c["Unknown Date"]=[]),c["Unknown Date"].push(i);return}const h=le(i.originalDateString);c[h]||(c[h]=[]),c[h].push(i)});const d=Object.keys(c);return d.sort((i,h)=>{if(i==="Unknown Date")return 1;if(h==="Unknown Date")return-1;try{const D=o=>{const u=o.split(" ");if(u.length===3){const j=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].indexOf(u[1]);if(j!==-1)return new Date(parseInt(u[2]),j,parseInt(u[0]))}return new Date(o)},l=D(i),v=D(h);if(!isNaN(l.getTime())&&!isNaN(v.getTime()))return v.getTime()-l.getTime()}catch(D){console.error("Error parsing date for sorting:",D)}return h.localeCompare(i)}),d.map(i=>({date:i,items:c[i]}))},[y]);return e.jsxs("div",{className:"dcp-group-card",children:[e.jsxs("h4",{className:"dcp-group-header",children:[P&&e.jsx(P,{size:14,className:"dcp-group-icon"}),s]}),e.jsxs("div",{className:"dcp-group-content",children:[k&&e.jsx("div",{className:"dcp-history-items",children:[1,2].map(c=>e.jsxs("div",{className:"dcp-history-item",style:{border:"none"},children:[e.jsx(x,{width:"60%",height:16,style:{marginBottom:"8px"}}),e.jsx(x,{width:"30%",height:12})]},c))}),!k&&y.length===0&&e.jsx("p",{className:"dcp-history-empty",children:f}),!k&&y.length>0&&e.jsx("div",{children:C.map(({date:c,items:d})=>e.jsxs("div",{className:"dcp-date-group",children:[e.jsx("h5",{className:"dcp-date-label",children:c}),e.jsx("div",{className:"dcp-date-items",children:d.map((i,h)=>e.jsx("div",{className:"dcp-history-item",children:N(i)},`${i.type}-${i.originalDateString}-${h}`))})]},c))})]})]})},ge=()=>{var B,G;const[s,P]=r.useState({currentPatient:null,nextPatient:null,waitingCount:0}),[y,N]=r.useState(!0),[k,f]=r.useState(null),[C,c]=r.useState(null),[d,i]=r.useState(null),[h,D]=r.useState(null),[l,v]=r.useState({pastComplaints:[],labReports:[],pendingLabOrders:[],pharmacyOrders:[]}),[o,u]=r.useState(!1),[$,j]=r.useState(null),{patientId:g}=ne(),S=ie(),q=se(),M=a=>{a&&(q.prefetchQuery({queryKey:_.patients.context(a),queryFn:async()=>{const t=await p(`/api/patients/${a}/context`);if(!t.ok)throw new Error("Failed to fetch patient context");return t.json()},staleTime:5*60*1e3}),q.prefetchQuery({queryKey:_.patientDebts.balance(a),queryFn:async()=>{const t=await p(`/api/patient-debts/${a}/balance`);return t.ok?t.json():{netDebt:0}},staleTime:1*60*1e3}),q.prefetchQuery({queryKey:_.queue.latest(a),queryFn:async()=>{const t=await p(`/api/queue/patient/${a}/latest`);if(!t.ok)throw new Error("Failed to fetch latest queue status");const n=await t.json();return n!=null&&n._id&&q.prefetchQuery({queryKey:_.queue.entry(n._id),queryFn:async()=>{const m=await p(`/api/queue/doctor/complaint/${n._id}`);if(!m.ok)throw new Error("Failed to fetch complaint record");return m.json()},staleTime:1*60*1e3}),n},staleTime:5e3}))},z=r.useCallback(async a=>{D(null),c(null),i(null),u(!0),j(null),v({pastComplaints:[],labReports:[],pendingLabOrders:[],pharmacyOrders:[]});try{const t=await p(`/api/patients/${a}`);if(!t.ok)throw new Error(`Patient details fetch failed (${t.status})`);const n=await t.json();c(n);const m=await p(`/api/queue/patient/${a}/latest`);if(!m.ok&&m.status!==404)throw new Error(`Queue entry fetch failed (${m.status})`);if(m.ok){const A=await m.json();i(A)}await Q(a)}catch(t){console.error("Error fetching specific patient data:",t),D(t.message||"Failed to load patient data."),j(t.message||"Failed to load patient history.")}finally{u(!1)}},[]),Q=r.useCallback(async a=>{u(!0),j(null);try{const[t,n,m,A]=await Promise.all([p(`/api/queue/patient/${a}/complaints`),p(`/api/lab/patient/${a}`),p(`/api/lab/orders/patient/${a}?status=pending`),p(`/api/pharmacy-orders/patient/${a}`)]),Z=t.ok?await t.json():[],ee=n.ok?await n.json():[],te=m.ok?await m.json():[],ae=A.ok?await A.json():[];v({pastComplaints:Z||[],labReports:ee||[],pendingLabOrders:te||[],pharmacyOrders:ae||[]})}catch(t){console.error("Error fetching patient history:",t),j(t.message||"Failed to load patient history."),v({pastComplaints:[],labReports:[],pendingLabOrders:[],pharmacyOrders:[]})}finally{u(!1)}},[]),E=r.useCallback(async()=>{N(!0),f(null);try{const a=await p("/api/queue/doctor");if(!a.ok){const n=await a.text();throw new Error(`API Error (${a.status}): ${n||a.statusText}`)}const t=await a.json();if(t===null||typeof t!="object"||typeof t.waitingCount!="number")throw console.error("Invalid queue data format:",t),new Error("Invalid queue data format received");P({currentPatient:t.currentPatient||null,nextPatient:t.nextPatient||null,waitingCount:t.waitingCount})}catch(a){console.error("Error fetching queue data:",a),f(a.message||"Failed to fetch queue data.")}finally{N(!1)}},[]);r.useEffect(()=>{let a=null;return g?(z(g),P({currentPatient:null,nextPatient:null,waitingCount:0})):(E(),a=setInterval(E,1e4),c(null),i(null)),()=>{a&&clearInterval(a)}},[g,z,E]),r.useEffect(()=>{var a;!g&&((a=s.currentPatient)!=null&&a.patientId)?Q(s.currentPatient.patientId):!g&&!s.currentPatient&&(v({pastComplaints:[],labReports:[],pendingLabOrders:[],pharmacyOrders:[]}),u(!1),j(null))},[g,(B=s.currentPatient)==null?void 0:B.patientId,Q]);const T=((G=s.currentPatient)==null?void 0:G.patientId)||(g?parseInt(g,10):null),L=r.useMemo(()=>{if(!T||!l.pastComplaints)return[];const a=l.pastComplaints.map(t=>({date:new Date(t.createdAt),type:"Complaint",data:t,originalDateString:t.createdAt})).filter(t=>!isNaN(t.date.getTime()));return a.sort((t,n)=>n.date.getTime()-t.date.getTime()),a},[T,l.pastComplaints]),F=r.useMemo(()=>{if(!T)return[];const a=[];return(l.pendingLabOrders??[]).forEach(t=>{const n=new Date(t.createdAt);isNaN(n.getTime())||a.push({date:n,type:"Lab Order (Pending)",data:t,originalDateString:t.createdAt})}),(l.labReports??[]).forEach(t=>{const n=t.reportCreatedAt?new Date(t.reportCreatedAt):null;n&&!isNaN(n.getTime())&&a.push({date:n,type:"Lab Report",data:t,originalDateString:t.reportCreatedAt})}),a.sort((t,n)=>n.date.getTime()-t.date.getTime()),a},[T,l.pendingLabOrders,l.labReports]),R=r.useMemo(()=>{if(!T||!l.pharmacyOrders)return[];const a=l.pharmacyOrders.map(t=>({date:new Date(t.date),type:"Pharmacy Order",data:t,originalDateString:t.date})).filter(t=>!isNaN(t.date.getTime()));return a.sort((t,n)=>n.date.getTime()-t.date.getTime()),a},[T,l.pharmacyOrders]),Y=async()=>{N(!0),f(null);try{await p("/api/queue/doctor/next",{method:"POST"}),await E()}catch(a){console.error("Error calling next patient:",a),f(a.message||"Failed to call next patient.")}finally{N(!1)}},X=async()=>{if(!(!s.currentPatient||g)){N(!0),f(null);try{await p(`/api/queue/doctor/complete/${s.currentPatient._id}`,{method:"POST"}),await E(),v({pastComplaints:[],labReports:[],pendingLabOrders:[],pharmacyOrders:[]}),u(!1),j(null)}catch(a){console.error("Error completing consultation:",a),f(a.message||"Failed to complete consultation.")}finally{N(!1)}}},H=a=>{switch(a){case"waiting":return"Waiting";case"consulting":return"Consulting";case"seen":return"Seen";case"cancelled":return"Cancelled";default:return a}},[b,I]=r.useState("info");let U=null;if(s.currentPatient){const a=t=>{switch(t){case"consulting":return"dcp-status-consulting";case"waiting":return"dcp-status-waiting";case"seen":return"dcp-status-seen";case"cancelled":return"dcp-status-cancelled";default:return""}};U=e.jsx("div",{className:"dcp-card dcp-card-teal",children:e.jsxs("div",{className:"dcp-card-content",children:[e.jsxs("div",{className:"dcp-mobile-tabs",children:[e.jsx("button",{className:`dcp-mobile-tab ${b==="info"?"active":""}`,onClick:()=>I("info"),children:"Patient Details"}),e.jsx("button",{className:`dcp-mobile-tab ${b==="history"?"active":""}`,onClick:()=>I("history"),children:"History"})]}),e.jsxs("div",{className:"dcp-flex-split",children:[e.jsxs("div",{className:`dcp-flex-half dcp-tab-info ${b==="info"?"":"hidden"}`,children:[e.jsxs("div",{className:"dcp-section-header dcp-section-header-teal",children:["NOW SEEING",e.jsxs("span",{className:"dcp-live-badge",children:[e.jsx("span",{className:"dcp-live-dot"}),"Live"]})]}),e.jsxs("div",{className:"dcp-patient-main",children:[e.jsxs("div",{children:[e.jsx("div",{className:"dcp-patient-name",children:s.currentPatient.name}),e.jsxs("div",{className:"dcp-patient-meta",children:[e.jsxs("span",{className:"dcp-patient-badge",children:[s.currentPatient.age," Yrs"]}),e.jsx("span",{className:"dcp-patient-badge",children:s.currentPatient.gender})]})]}),e.jsxs("div",{className:"dcp-patient-token",children:[e.jsxs("div",{className:"dcp-token-number",children:["#",s.currentPatient.token]}),e.jsx("span",{className:`dcp-status ${a(s.currentPatient.status)}`,children:H(s.currentPatient.status)})]})]}),s.currentPatient.case_summary&&e.jsxs("div",{className:"dcp-ai-summary",children:[e.jsx("div",{className:"dcp-ai-label",children:"✨ AI Brief"}),e.jsx("p",{className:"dcp-ai-text",children:s.currentPatient.case_summary})]}),e.jsxs("div",{className:"dcp-actions",children:[e.jsxs("button",{onClick:()=>{var n;const t=(n=s.currentPatient)==null?void 0:n._id;t&&S(`/dashboard/edit-complaint/${t}`)},onMouseEnter:()=>{var t;return((t=s.currentPatient)==null?void 0:t.patientId)&&M(String(s.currentPatient.patientId))},disabled:y||!s.currentPatient||s.currentPatient.status!=="consulting",className:"dcp-btn dcp-btn-primary",children:[e.jsx(re,{size:16})," Open Consultation"]}),e.jsxs("button",{onClick:X,disabled:y||!s.currentPatient||s.currentPatient.status!=="consulting",className:"dcp-btn dcp-btn-green",children:[e.jsx(ce,{size:16})," Complete"]})]})]}),e.jsxs("div",{className:`dcp-flex-half dcp-history-section dcp-tab-history ${b==="history"?"":"hidden"} dcp-desktop-only`,children:[e.jsxs("div",{className:"dcp-history-header",children:[e.jsx("span",{className:"dcp-history-title",children:"History & Context"}),o&&e.jsx(x,{width:60,height:14})]}),$&&e.jsx("div",{className:"dcp-error",children:$}),e.jsxs("div",{className:"dcp-history-scroll dcp-scrollbar",children:[e.jsx(O,{title:"Past Complaints",icon:K,items:L,isLoading:o,noDataText:"No past complaints.",renderItemContent:t=>e.jsxs("div",{children:[t.data.complaint,e.jsx("div",{className:"dcp-history-timestamp",children:w(t.originalDateString)})]})}),e.jsx(O,{title:"Lab Reports & Orders",icon:W,items:F,isLoading:o,noDataText:"No lab history.",renderItemContent:t=>t.type==="Lab Order (Pending)"?e.jsxs("div",{children:[e.jsx("span",{className:"dcp-type-pending",children:"Pending Order"}),e.jsx("div",{children:t.data.tests.map(n=>n.name).join(", ")}),e.jsx("div",{className:"dcp-history-timestamp",children:w(t.originalDateString)})]}):e.jsxs("div",{children:[e.jsxs("span",{className:"dcp-type-report",children:["Report: ",t.data.testName]}),e.jsxs("div",{style:{fontStyle:"italic"},children:['"',t.data.reportFindings.substring(0,50),t.data.reportFindings.length>50?"...":"",'"']}),e.jsx("div",{className:"dcp-history-timestamp",children:w(t.originalDateString)})]})}),e.jsx(O,{title:"Medications",icon:J,items:R,isLoading:o,noDataText:"No medication history.",renderItemContent:t=>e.jsxs("div",{children:[t.data.medications.map(n=>`${n.name} (${n.pack_quantity||0}p ${n.loose_quantity||0}l)`).join(", "),e.jsxs("div",{className:"dcp-history-timestamp",children:[w(t.originalDateString)," • ",e.jsx("span",{style:{textTransform:"capitalize"},children:t.data.status})]})]})}),L.length===0&&F.length===0&&R.length===0&&!o&&e.jsx("div",{className:"dcp-empty-state",children:"No history records found for this patient."})]})]})]})]})})}return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"dcp-container",children:[e.jsxs("div",{className:"dcp-header-row",children:[e.jsx("button",{onClick:()=>S(-1),className:"dcp-back-btn",children:e.jsx(V,{size:20})}),e.jsx("h1",{className:"dcp-title",children:"Doctor Consultation Panel"})]}),g?e.jsxs(e.Fragment,{children:[h&&e.jsx("div",{className:"dcp-error",children:h}),C&&e.jsx("div",{className:"dcp-card dcp-card-violet",children:e.jsxs("div",{className:"dcp-card-content",children:[e.jsxs("div",{className:"dcp-mobile-tabs",children:[e.jsx("button",{className:`dcp-mobile-tab ${b==="info"?"active":""}`,onClick:()=>I("info"),children:"Patient Record"}),e.jsx("button",{className:`dcp-mobile-tab ${b==="history"?"active":""}`,onClick:()=>I("history"),children:"History"})]}),e.jsxs("div",{className:"dcp-flex-split",children:[e.jsxs("div",{className:`dcp-flex-half dcp-tab-info ${b==="info"?"":"hidden"}`,children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"},children:[e.jsx("div",{className:"dcp-section-header dcp-section-header-violet",children:"Patient Record"}),e.jsxs("button",{onClick:()=>S("/dashboard/doctor"),className:"dcp-btn dcp-btn-outline",style:{padding:"4px 10px",fontSize:"0.75rem"},children:[e.jsx(V,{size:12})," Back to Queue"]})]}),e.jsx("div",{className:"dcp-patient-name dcp-patient-name-gradient",children:C.name}),e.jsxs("div",{className:"dcp-patient-meta",style:{marginBottom:"12px"},children:[e.jsxs("span",{className:"dcp-patient-badge",children:[C.age||"N/A"," Yrs"]}),e.jsx("span",{className:"dcp-patient-badge",children:C.gender||"N/A"})]}),e.jsxs("div",{className:"dcp-activity-box",children:[e.jsx("div",{className:"dcp-activity-label",children:"Latest Activity"}),d?e.jsxs("div",{children:[e.jsxs("div",{className:"dcp-activity-content",children:[e.jsx("strong",{children:"Complaint:"})," ",d.complaint||e.jsx("span",{style:{color:"var(--dcp-text-muted)",fontStyle:"italic"},children:"None"})]}),e.jsxs("div",{style:{marginTop:"8px"},children:[e.jsx("span",{className:`dcp-status ${d.status==="consulting"?"dcp-status-consulting":d.status==="seen"?"dcp-status-seen":d.status==="waiting"?"dcp-status-waiting":""}`,children:H(d.status)}),d.status==="consulting"&&d._id&&e.jsx("button",{onClick:()=>S(`/dashboard/edit-complaint/${d._id}`),onMouseEnter:()=>M(String(C.id)),className:"dcp-btn dcp-btn-primary",style:{marginLeft:"10px",padding:"4px 12px"},children:"Resume"})]}),d.case_summary&&e.jsxs("div",{className:"dcp-ai-summary",style:{marginTop:"10px"},children:[e.jsx("div",{className:"dcp-ai-label",children:"✨ AI Summary"}),e.jsx("p",{className:"dcp-ai-text",children:d.case_summary})]})]}):e.jsx("p",{style:{color:"var(--dcp-text-muted)",fontStyle:"italic"},children:"No queue entry found for this patient today."})]})]}),e.jsxs("div",{className:`dcp-flex-half dcp-history-section dcp-tab-history ${b==="history"?"":"hidden"} dcp-desktop-only`,children:[e.jsxs("div",{className:"dcp-history-header",children:[e.jsx("span",{className:"dcp-history-title",children:"Patient History"}),o&&e.jsx(x,{width:60,height:14})]}),$&&e.jsx("div",{className:"dcp-error",children:$}),e.jsxs("div",{className:"dcp-history-scroll dcp-scrollbar",children:[e.jsx(O,{title:"Past Complaints",icon:K,items:L,isLoading:o,noDataText:"No past complaints.",renderItemContent:a=>e.jsxs("div",{children:[a.data.complaint,e.jsx("div",{className:"dcp-history-timestamp",children:w(a.originalDateString)})]})}),e.jsx(O,{title:"Lab Reports",icon:W,items:F,isLoading:o,noDataText:"No lab history.",renderItemContent:a=>a.type==="Lab Order (Pending)"?e.jsxs("div",{children:[e.jsx("span",{className:"dcp-type-pending",children:"Pending Order"}),e.jsx("div",{children:a.data.tests.map(t=>t.name).join(", ")}),e.jsx("div",{className:"dcp-history-timestamp",children:w(a.originalDateString)})]}):e.jsxs("div",{children:[e.jsxs("span",{className:"dcp-type-report",children:["Report: ",a.data.testName]}),e.jsxs("div",{style:{fontStyle:"italic"},children:['"',a.data.reportFindings.substring(0,50),a.data.reportFindings.length>50?"...":"",'"']}),e.jsx("div",{className:"dcp-history-timestamp",children:w(a.originalDateString)})]})}),e.jsx(O,{title:"Medications",icon:J,items:R,isLoading:o,noDataText:"No pharmacy history.",renderItemContent:a=>e.jsxs("div",{children:[a.data.medications.map(t=>`${t.name} (${t.pack_quantity||0}p ${t.loose_quantity||0}l)`).join(", "),e.jsxs("div",{className:"dcp-history-timestamp",children:[w(a.originalDateString)," • ",e.jsx("span",{style:{textTransform:"capitalize"},children:a.data.status})]})]})}),L.length===0&&F.length===0&&R.length===0&&!o&&e.jsx("div",{className:"dcp-empty-state",children:"No history records found."})]})]})]})]})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"dcp-action-bar",children:[e.jsxs("button",{onClick:()=>S("/dashboard/add-patient"),className:"dcp-btn dcp-btn-green",children:[e.jsx(de,{size:16})," Add Patient"]}),e.jsx("button",{onClick:()=>S("/search-patient"),className:"dcp-btn dcp-btn-primary",children:"Search Patient"})]}),k&&e.jsx("div",{className:"dcp-error",children:k}),y&&!s.currentPatient&&e.jsxs("div",{className:"dcp-card",style:{padding:"2rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx(x,{width:"40%",height:32}),e.jsx(x,{width:80,height:24,style:{borderRadius:"12px"}})]}),e.jsxs("div",{style:{marginTop:"1rem"},children:[e.jsx(x,{width:"60%",height:24}),e.jsx(x,{width:"40%",height:16,style:{marginTop:"8px"}})]}),e.jsx("div",{style:{marginTop:"2rem"},children:e.jsx(x,{width:"100%",height:80,style:{borderRadius:"12px"}})}),e.jsxs("div",{style:{display:"flex",gap:"1rem",marginTop:"2rem"},children:[e.jsx(x,{width:180,height:40}),e.jsx(x,{width:120,height:40})]})]}),e.jsx("div",{style:{marginBottom:"16px"},children:U||e.jsx("div",{className:"dcp-empty-state",children:"No patient currently being seen. Use 'Call Next' or search for a patient record."})}),e.jsxs("div",{className:"dcp-next-section",children:[e.jsx("div",{className:"dcp-next-title",children:"NEXT IN QUEUE"}),s.nextPatient?e.jsxs("div",{className:"dcp-next-card",children:[e.jsxs("div",{className:"dcp-next-info",children:[e.jsxs("span",{className:"dcp-next-token",children:["Token #",s.nextPatient.token]}),e.jsx("span",{className:`dcp-status ${s.nextPatient.status==="waiting"?"dcp-status-waiting":""}`,children:H(s.nextPatient.status)})]}),e.jsx("div",{className:"dcp-next-name",children:s.nextPatient.name}),e.jsxs("div",{className:"dcp-next-meta",children:["Age: ",s.nextPatient.age," | ",s.nextPatient.gender]}),(s.nextPatient.complaint||s.nextPatient.case_summary)&&e.jsxs("div",{className:"dcp-next-complaint",children:[s.nextPatient.complaint&&e.jsxs("div",{children:[e.jsx("strong",{children:"Complaint:"})," ",s.nextPatient.complaint]}),s.nextPatient.case_summary&&e.jsxs("div",{className:"dcp-ai-summary",style:{marginTop:"8px"},children:[e.jsx("div",{className:"dcp-ai-label",children:"✨ AI Summary"}),e.jsx("p",{className:"dcp-ai-text",children:s.nextPatient.case_summary})]})]})]}):e.jsx("div",{className:"dcp-empty-state",children:"No patient waiting next in the queue."})]}),e.jsxs("div",{className:"dcp-bottom-bar",children:[e.jsx("button",{onClick:Y,disabled:y||!s.nextPatient||!!s.currentPatient,className:"dcp-btn dcp-btn-teal",children:"Call Next Patient"}),e.jsxs("div",{className:"dcp-waiting-count",children:[s.waitingCount," patients waiting"]})]})]})]})})};export{ge as default};
