import{j as e,S as $,f as N}from"./index-DCOSVs-d.js";import{u as q,r}from"./react-vendor-Cc0P4_ZX.js";import{u as C}from"./useAutoFocusSingleInput-6a_v4dYJ.js";import{W as O,p as R,a6 as k}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const W=()=>{const m=q(),[t,f]=r.useState({name:"",age:"",gender:"",phone:"",complaint:"",doctorId:""}),[n,b]=r.useState(!1),[v,u]=r.useState(null),[w,x]=r.useState(null),[g,S]=r.useState([]),[h,y]=r.useState(!0);C(),r.useEffect(()=>{(async()=>{y(!0);try{const a=await N("/api/staff?role=doctor");if(!a.ok)throw new Error("Failed to fetch doctors");const s=await a.json();S(s),s.length>0&&f(i=>({...i,doctorId:""}))}catch(a){console.error("Error fetching doctors:",a),u(`Failed to load doctors: ${a.message}`)}finally{y(!1)}})()},[]);const d=l=>{const{name:a,value:s}=l.target;f(i=>({...i,[a]:s}))},I=async l=>{var a;l.preventDefault(),u(null),x(null),b(!0);try{let s,i;console.log("Registering new patient...");const p=await N("/api/patients",{method:"POST",body:JSON.stringify({name:t.name,age:t.age?parseInt(t.age,10):null,gender:t.gender||null,phone:t.phone||null})});if(!p.ok){const o=await p.json();if(p.status===403&&o.message.includes("Patient limit")){m("/start-clinic-subscription",{state:{errorMessage:o.message}});return}throw new Error(o.message||"Failed to register patient")}const P=await p.json();s=P.id,i=P.name,console.log(`New patient ${s} registered.`);const c=t.doctorId||null;console.log(`Adding patient ${s} to queue for doctor ${c||"Unassigned"}`);const j=await N("/api/queue",{method:"POST",body:JSON.stringify({patientId:s,complaint:t.complaint||null,doctorId:c})});if(!j.ok){const o=await j.json();throw new Error(o.message||"Failed to add patient to queue")}const D=await j.json();if(console.log(`Patient added to queue, entry ID: ${D.id}`),f({name:"",age:"",gender:"",phone:"",complaint:"",doctorId:""}),c){const o=((a=g.find(E=>E.id===c))==null?void 0:a.name)||"Selected Doctor",A=`Patient "${i}" registered and added to queue for Dr. ${o}. Redirecting to billing...`;x(A),m("/billing",{state:{patientId:s,queueId:D.id,patientName:i,doctorId:c,billType:"consultation"}})}else{const o=`Patient "${i}" registered and added to the general queue.`;x(o)}}catch(s){console.error("Error in add/queue process:",s),s.message.includes("Patient limit")?(u(`Operation failed: ${s.message}. Please upgrade your plan.`),m("/start-clinic-subscription")):u(`Operation failed: ${s.message}`)}finally{b(!1)}};return e.jsxs("div",{className:"add-patient-page-container flex flex-col items-center justify-start",children:[e.jsxs("div",{className:"w-full max-w-3xl mb-2 flex justify-start",children:[" ",e.jsx("button",{onClick:()=>m(-1),className:"back-button",title:"Back to Previous Page",children:e.jsx(O,{size:20,className:"btn-icon"})})]}),e.jsxs("div",{className:"add-patient-card",children:[e.jsxs("h3",{className:"add-patient-title",children:[e.jsx(R,{size:28})," ","Register New Patient & Add to Queue"]}),v&&e.jsxs("div",{className:"alert alert-danger",role:"alert",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:v})]}),w&&e.jsxs("div",{className:"alert alert-success",role:"alert",children:[e.jsx("strong",{children:"Success: "}),e.jsx("span",{children:w})]}),e.jsxs("form",{onSubmit:I,className:"space-y-5",children:[" ",e.jsxs("fieldset",{className:"form-fieldset",children:[e.jsx("legend",{children:"New Patient Details"}),e.jsxs("div",{className:"form-grid form-grid-cols-2",children:[" ",e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Full Name *"}),e.jsx("input",{type:"text",name:"name",value:t.name,onChange:d,className:"form-input",required:!0,disabled:n})]}),e.jsxs("div",{className:"form-grid form-grid-cols-2",children:[" ",e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Age"}),e.jsx("input",{type:"number",name:"age",value:t.age,onChange:d,className:"form-input",min:"0",disabled:n})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Gender"}),e.jsxs("select",{name:"gender",value:t.gender,onChange:d,className:"form-select",disabled:n,children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"M",children:"Male"}),e.jsx("option",{value:"F",children:"Female"}),e.jsx("option",{value:"O",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Phone"}),e.jsx("input",{type:"tel",name:"phone",value:t.phone,onChange:d,className:"form-input",disabled:n})]})]})]}),e.jsxs("fieldset",{className:"form-fieldset",children:[e.jsx("legend",{children:"Visit Details"}),e.jsxs("div",{className:"form-grid form-grid-cols-2",children:[" ",e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Assign Doctor (Optional)"}),h?e.jsx($,{width:"100%",height:40,style:{borderRadius:"8px"}}):e.jsxs("select",{name:"doctorId",value:t.doctorId,onChange:d,className:"form-select",disabled:n,children:[e.jsx("option",{value:"",children:g.length===0?"No doctors available":"-- No Doctor (Add to General Queue) --"}),g.map(l=>e.jsx("option",{value:l.id,children:l.name},l.id))]}),g.length===0&&!h&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Please add doctors via the Admin Panel."})]}),e.jsxs("div",{className:"form-grid-col-span-2",children:[" ",e.jsx("label",{className:"form-label",children:"Patient Data / Reason"}),e.jsx("textarea",{name:"complaint",value:t.complaint,onChange:d,rows:2,className:"form-textarea",disabled:n})]})]})]}),e.jsxs("div",{className:"flex justify-end pt-2",children:[" ",e.jsxs("button",{type:"submit",className:`btn btn-primary ${n||h?"disabled":""}`,disabled:n||h,children:[e.jsx(k,{size:18,className:"btn-icon"}),n?"Processing...":"Register & Add to Queue"]})]})]})]})]})};export{W as default};
