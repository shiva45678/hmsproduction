import{j as e,f as R,S,t as De}from"./index-DCOSVs-d.js";import{r as i,b as be,u as Le}from"./react-vendor-Cc0P4_ZX.js";import{X as K,f as Pe,ad as Fe,ar as ve,aa as ze,e as ke,i as Te,a7 as fe,af as Ne,u as we,v as ye,aq as Me}from"./ui-vendor-SmiJk_kJ.js";import{Q as Ce}from"./index-CZ6CIOFr.js";/* empty css                            */import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const Ee=({patient:N,onClose:x,onSave:D})=>{const[b,r]=i.useState({name:N.name,age:N.age,gender:N.gender,phone:N.phone||""}),[F,h]=i.useState(!1),c=async u=>{u.preventDefault(),h(!0);try{await D({...b,phone:b.phone||void 0}),x()}catch(z){console.error(z),alert("Failed to update patient")}finally{h(!1)}};return e.jsx("div",{className:"modal-overlay",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{className:"modal-content",style:{backgroundColor:"white",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 4px 20px rgba(0,0,0,0.15)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx("h3",{style:{margin:0,fontSize:"1.2rem",color:"#333"},children:"Edit Patient Details"}),e.jsx("button",{onClick:x,style:{border:"none",background:"none",cursor:"pointer",color:"#666"},children:e.jsx(K,{size:20})})]}),e.jsxs("form",{onSubmit:c,style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"0.9rem",color:"#555"},children:"Name"}),e.jsx("input",{type:"text",value:b.name,onChange:u=>r({...b,name:u.target.value}),className:"dental-search-input",style:{padding:"10px",fontSize:"0.95rem"},required:!0})]}),e.jsxs("div",{style:{display:"flex",gap:"16px"},children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"0.9rem",color:"#555"},children:"Age"}),e.jsx("input",{type:"number",value:b.age||"",onChange:u=>r({...b,age:parseInt(u.target.value)||0}),className:"dental-search-input",style:{padding:"10px",fontSize:"0.95rem"}})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"0.9rem",color:"#555"},children:"Gender"}),e.jsxs("select",{value:b.gender||"",onChange:u=>r({...b,gender:u.target.value}),className:"dental-search-input",style:{padding:"10px",fontSize:"0.95rem",width:"100%"},children:[e.jsx("option",{value:"M",children:"Male"}),e.jsx("option",{value:"F",children:"Female"}),e.jsx("option",{value:"O",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"0.9rem",color:"#555"},children:"Phone"}),e.jsx("input",{type:"tel",value:b.phone,onChange:u=>r({...b,phone:u.target.value}),className:"dental-search-input",style:{padding:"10px",fontSize:"0.95rem"},placeholder:"Optional"})]}),e.jsx("button",{type:"submit",className:"save-btn",style:{marginTop:"8px",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},disabled:F,children:F?"Saving...":e.jsxs(e.Fragment,{children:[e.jsx(Pe,{size:18})," Save Changes"]})})]})]})})},Re=N=>[1,2,3,14,15,16,17,18,19,30,31,32].includes(N)?{type:"molar",roots:2}:[4,5,12,13,20,21,28,29].includes(N)?{type:"premolar",roots:1}:[6,11,22,27].includes(N)?{type:"canine",roots:1}:{type:"incisor",roots:1},Y=({toothNumber:N,conditions:x=[],className:D,style:b,isSelected:r,bridgeConnectPrevious:F})=>{const{type:h}=Re(N),c=N<=16,u="M5,20 Q5,5 18,5 Q31,5 31,20 L29,25 Q18,28 7,25 Z",z="M7,25 Q5,40 10,44 Q14,40 14,26",G="M29,25 Q31,40 26,44 Q22,40 22,26",k="M8,20 Q8,8 18,8 Q28,8 28,20 L26,24 Q18,27 10,24 Z",a="M10,24 Q16,44 18,45 Q20,44 26,24",m="M8,22 Q18,2 28,22 L26,25 Q18,28 10,25 Z",y="M10,25 Q18,48 26,25",v="M10,22 L10,12 Q18,12 26,12 L26,22 L24,25 Q18,27 12,25 Z",w="M12,25 Q18,46 24,25";let L=u,T=[z,G];h==="incisor"?(L=v,T=[w]):h==="canine"?(L=m,T=[y]):h==="premolar"&&(L=k,T=[a]);const t=x.includes("condition-rct"),g=x.includes("condition-filling"),W=x.includes("condition-crown"),O=x.includes("condition-bridge"),X=x.includes("condition-extraction"),U=x.includes("condition-implant"),ee=t?"#e9d5ff":"#f3f4f6",J=X?"#fee2e2":"#ffffff",B=X?"#ef4444":O?"#0891b2":U?"#475569":W?"#b45309":r?"#3b82f6":"#6b7280",H=r||O||W||U?2:1.5,$=c?"M20,15 L56,15 L56,22 L20,22 Z":"M16,15 L-20,15 L-20,22 L16,22 Z";return e.jsxs("svg",{viewBox:"0 0 36 50",className:D,style:{width:"100%",height:"100%",overflow:"visible",...b},children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"goldGradient",x1:"0",x2:"1",y1:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:"#fcd34d"}),e.jsx("stop",{offset:"100%",stopColor:"#d97706"})]}),e.jsxs("linearGradient",{id:"bridgeGradient",x1:"0",x2:"1",y1:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:"#22d3ee"}),e.jsx("stop",{offset:"100%",stopColor:"#0891b2"})]}),e.jsxs("linearGradient",{id:"titaniumGradient",x1:"0",x2:"1",y1:"0",y2:"0",children:[e.jsx("stop",{offset:"0%",stopColor:"#475569"}),e.jsx("stop",{offset:"30%",stopColor:"#94a3b8"}),e.jsx("stop",{offset:"50%",stopColor:"#f8fafc"}),e.jsx("stop",{offset:"70%",stopColor:"#94a3b8"}),e.jsx("stop",{offset:"100%",stopColor:"#475569"})]})]}),F&&e.jsx("path",{d:$,fill:"url(#bridgeGradient)",stroke:"#0891b2",strokeWidth:"1.5"}),U?e.jsxs("g",{children:[e.jsx("path",{d:"M13,25 L23,25 L22,28 L23,29 L22,30 L22,33 L23,34 L22,35 L22,38 L23,39 L22,40 L19,46 Q18,48 17,46 L14,40 L13,39 L14,38 L14,35 L13,34 L14,33 L14,30 L13,29 L14,28 Z",fill:"url(#titaniumGradient)",stroke:B,strokeWidth:"1"}),e.jsxs("g",{stroke:"rgba(255,255,255,0.4)",strokeWidth:"0.5",children:[e.jsx("line",{x1:"14",y1:"29",x2:"22",y2:"29"}),e.jsx("line",{x1:"14",y1:"34",x2:"22",y2:"34"}),e.jsx("line",{x1:"14",y1:"39",x2:"22",y2:"39"})]}),e.jsx("rect",{x:"15",y:"22",width:"6",height:"4",fill:"#64748b",stroke:B,strokeWidth:"1",rx:"1"})]}):e.jsx("g",{fill:ee,stroke:B,strokeWidth:H,strokeLinejoin:"round",children:T.map((se,re)=>e.jsx("path",{d:se},re))}),t&&!U&&e.jsx("g",{fill:"none",stroke:"#9333ea",strokeWidth:"2.5",strokeLinecap:"round",children:h==="molar"?e.jsxs(e.Fragment,{children:[e.jsx("path",{d:"M12,28 L11,42"}),e.jsx("path",{d:"M24,28 L25,42"})]}):e.jsx("path",{d:"M18,25 L18,44"})}),e.jsx("path",{d:L,fill:O?"url(#bridgeGradient)":W?"url(#goldGradient)":J,stroke:B,strokeWidth:H,strokeLinejoin:"round"}),g&&!W&&!O&&!U&&e.jsx("circle",{cx:"18",cy:"16",r:"4",fill:"#3b82f6",stroke:"#1d4ed8",strokeWidth:"1"}),X&&e.jsxs("g",{stroke:"#ef4444",strokeWidth:"3",strokeLinecap:"round",children:[e.jsx("line",{x1:"8",y1:"8",x2:"28",y2:"42"}),e.jsx("line",{x1:"28",y1:"8",x2:"8",y2:"42"})]})]})},Ae=({selectedTeeth:N,toothConditions:x={},toothDetails:D={},onToothClick:b,onEditPastRecord:r,onPrint:F})=>{const h=Array.from({length:16},(a,m)=>m+1),c=Array.from({length:16},(a,m)=>32-m),[u,z]=be.useState(null),G=a=>{const m=x[a]||[],y=N.includes(a);let v=[],w="#9ca3af",L;const T=m.includes("condition-extraction");return y&&(w="#3b82f6"),m.includes("condition-filling")&&v.push("#60a5fa"),m.includes("condition-rct")&&v.push("#c084fc"),m.includes("condition-crown")&&(v.push("#fcd34d"),w="#d97706"),m.includes("condition-bridge")&&(v.push("#22d3ee"),w="#0891b2"),m.includes("condition-implant")&&(v.push("#94a3b8"),w="#475569"),m.includes("condition-extraction")&&(v.push("#fee2e2"),w="#ef4444"),v.length===0&&y&&v.push("#eff6ff"),v.length===0&&v.push("#ffffff"),{fillColors:v,borderColor:w,overlayColor:L,isSelected:y,hasExtraction:T}},k=a=>{const{isSelected:m}=G(a),y=x[a]||[],v=D[a],w=a<=16,L=y.includes("condition-bridge");let T=!1;if(L){let t=null;w?a>1&&(t=a-1):a<32&&(t=a+1),t!==null&&(x[t]||[]).includes("condition-bridge")&&(T=!0)}return e.jsxs("div",{onClick:()=>b(a),onMouseEnter:()=>z(a),onMouseLeave:()=>z(null),className:`tooth-item-container ${m?"selected":""}`,title:"",children:[e.jsx("div",{className:"tooth-number-label",children:a}),e.jsx("div",{className:"tooth-svg-wrapper",style:{transform:w?"rotate(180deg)":"none"},children:e.jsx(Y,{toothNumber:a,conditions:y,isSelected:m,bridgeConnectPrevious:T})}),u===a&&v&&v.length>0&&e.jsxs("div",{className:"tooth-tooltip-window",children:[e.jsxs("div",{className:"tooltip-header",children:["Tooth ",a]}),e.jsx("ul",{className:"tooltip-list",children:v.map((t,g)=>e.jsxs("li",{className:"tooltip-detail-item",children:[e.jsxs("span",{className:"detail-text",children:[t.name," ",e.jsxs("small",{children:["(",t.date,")"]})]}),t.isPast&&r&&e.jsx("button",{className:"tooltip-edit-btn",onClick:W=>{W.stopPropagation(),r(t.recordId)},title:"Edit this record",children:e.jsx(ve,{size:12})})]},g))})]})]},a)};return e.jsxs("div",{className:"chart-container-inner",style:{position:"relative"},children:[F&&e.jsxs("button",{onClick:a=>{a.stopPropagation(),F()},className:"chart-print-btn no-print",title:"Print Report",children:[e.jsx(Fe,{size:16}),e.jsx("span",{children:"Print Report"})]}),e.jsx("div",{className:"arch-label",children:"Maxillary (Upper)"}),e.jsxs("div",{className:"arch-row",children:[e.jsx("div",{className:"quadrant",children:h.slice(0,8).map(a=>k(a))}),e.jsx("div",{className:"quadrant",children:h.slice(8).map(a=>k(a))})]}),e.jsxs("div",{className:"midline-divider",children:[e.jsx("div",{className:"divider-line"}),e.jsx("span",{className:"chart-label",children:"Midline"}),e.jsx("div",{className:"divider-line"})]}),e.jsxs("div",{className:"arch-row",children:[e.jsx("div",{className:"quadrant",children:c.slice(0,8).map(a=>k(a))}),e.jsx("div",{className:"quadrant",children:c.slice(8).map(a=>k(a))})]}),e.jsx("div",{className:"arch-label",children:"Mandibular (Lower)"}),e.jsxs("div",{className:"chart-legend",children:[e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(Y,{toothNumber:1,conditions:[],style:{width:16,height:22}})}),e.jsx("span",{children:"Healthy"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(Y,{toothNumber:1,conditions:["condition-filling"],style:{width:16,height:22}})}),e.jsx("span",{children:"Filling (Dot)"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(Y,{toothNumber:1,conditions:["condition-rct"],style:{width:16,height:22}})}),e.jsx("span",{children:"RCT (Root Lines)"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(Y,{toothNumber:1,conditions:["condition-crown"],style:{width:16,height:22}})}),e.jsx("span",{children:"Crown"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(Y,{toothNumber:1,conditions:["condition-bridge"],style:{width:16,height:22}})}),e.jsx("span",{children:"Bridge"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(Y,{toothNumber:1,conditions:["condition-implant"],style:{width:16,height:22}})}),e.jsx("span",{children:"Implant"})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-preview-mini",children:e.jsx(Y,{toothNumber:1,conditions:["condition-extraction"],style:{width:16,height:22}})}),e.jsx("span",{children:"Extraction (X)"})]})]}),e.jsxs("div",{className:"print-only-details-summary print-only",children:[e.jsx("h3",{children:"Tooth Procedure Details"}),Object.keys(D).length===0?e.jsx("p",{className:"no-details",children:"No specific tooth procedures recorded."}):e.jsxs("table",{className:"print-details-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Tooth"}),e.jsx("th",{children:"Procedure"}),e.jsx("th",{children:"Date"})]})}),e.jsx("tbody",{children:Object.entries(D).sort(([a],[m])=>parseInt(a)-parseInt(m)).map(([a,m])=>e.jsx(be.Fragment,{children:m.map((y,v)=>e.jsxs("tr",{children:[v===0?e.jsxs("td",{rowSpan:m.length,className:"tooth-cell",children:["Tooth ",a]}):null,e.jsx("td",{children:y.name}),e.jsx("td",{children:y.date})]},`${a}-${v}`))},a))})]})]})]})},Be=({onClose:N,onUpdate:x})=>{const[D,b]=i.useState([]),[r,F]=i.useState(!0),[h,c]=i.useState(null),[u,z]=i.useState({}),[G,k]=i.useState(!1),[a,m]=i.useState({name:"",cost:0,type:"general"});i.useEffect(()=>{y()},[]);const y=async()=>{F(!0);try{const t=await R("/api/dental/procedures");if(t.ok){const g=await t.json();b(g)}}catch(t){console.error(t)}finally{F(!1)}},v=async()=>{if(!(!a.name||!a.cost))try{(await R("/api/dental/procedures",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok&&(k(!1),m({name:"",cost:0,type:"general"}),y(),x())}catch(t){console.error(t)}},w=async t=>{try{(await R(`/api/dental/procedures/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)})).ok&&(c(null),z({}),y(),x())}catch(g){console.error(g)}},L=async t=>{if(window.confirm("Are you sure you want to delete this procedure?"))try{(await R(`/api/dental/procedures/${t}`,{method:"DELETE"})).ok&&(y(),x())}catch(g){console.error(g)}},T=t=>{c(t.id),z({name:t.name,cost:t.cost,type:t.type})};return e.jsx("div",{className:"manage-procedures-modal-overlay",children:e.jsxs("div",{className:"manage-procedures-modal-content",children:[e.jsxs("div",{className:"manage-procedures-modal-header",children:[e.jsx("h2",{className:"manage-procedures-modal-title",children:"Manage Procedures"}),e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[e.jsx("button",{onClick:async()=>{if(window.confirm("Import missing default procedures?"))try{await R("/api/dental/procedures/import-defaults",{method:"POST"}),y(),x()}catch(t){console.error(t)}},className:"btn-secondary",style:{padding:"6px 12px",fontSize:"0.8rem"},children:"Import Defaults"}),e.jsx("button",{onClick:N,className:"manage-procedures-close-btn",children:e.jsx(K,{size:20})})]})]}),e.jsx("div",{className:"manage-procedures-list-container",children:r?e.jsx("div",{style:{padding:"20px",textAlign:"center"},children:"Loading procedures..."}):e.jsxs("table",{className:"manage-procedures-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"40%"},children:"Name"}),e.jsx("th",{style:{width:"20%"},children:"Type"}),e.jsx("th",{style:{width:"20%"},children:"Cost (₹)"}),e.jsx("th",{style:{width:"20%"},children:"Actions"})]})}),e.jsx("tbody",{children:D.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,style:{textAlign:"center",padding:"20px",color:"#888"},children:"No procedures found. Add one below."})}):D.map(t=>e.jsx("tr",{children:h===t.id?e.jsxs(e.Fragment,{children:[e.jsx("td",{children:e.jsx("input",{type:"text",className:"edit-input",value:u.name||"",onChange:g=>z({...u,name:g.target.value}),placeholder:"Procedure Name"})}),e.jsx("td",{children:e.jsxs("select",{className:"edit-select",value:u.type||"general",onChange:g=>z({...u,type:g.target.value}),children:[e.jsx("option",{value:"general",children:"General"}),e.jsx("option",{value:"filling",children:"Filling"}),e.jsx("option",{value:"rct",children:"RCT"}),e.jsx("option",{value:"extraction",children:"Extraction"}),e.jsx("option",{value:"crown",children:"Crown"}),e.jsx("option",{value:"bridge",children:"Bridge"}),e.jsx("option",{value:"implant",children:"Implant"})]})}),e.jsx("td",{children:e.jsx("input",{type:"number",className:"edit-input",value:u.cost||0,onChange:g=>z({...u,cost:parseFloat(g.target.value)}),placeholder:"Cost"})}),e.jsxs("td",{children:[e.jsx("button",{onClick:()=>w(t.id),className:"action-btn btn-save",title:"Save",children:e.jsx(Pe,{size:18})}),e.jsx("button",{onClick:()=>c(null),className:"action-btn btn-cancel",title:"Cancel",children:e.jsx(K,{size:18})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{children:t.name}),e.jsx("td",{children:e.jsx("span",{className:`procedure-badge badge-${t.type}`,children:t.type})}),e.jsxs("td",{style:{fontWeight:500},children:["₹",t.cost]}),e.jsxs("td",{children:[e.jsx("button",{onClick:()=>T(t),className:"action-btn btn-edit",title:"Edit",children:e.jsx(ve,{size:18})}),e.jsx("button",{onClick:()=>L(t.id),className:"action-btn btn-delete",title:"Delete",children:e.jsx(ze,{size:18})})]})]})},t.id))})]})}),e.jsx("div",{className:"add-procedure-section",children:G?e.jsxs("div",{className:"add-procedure-card",children:[e.jsx("h4",{className:"add-procedure-title",children:"Add New Procedure"}),e.jsxs("div",{className:"add-form-grid",children:[e.jsx("input",{type:"text",className:"form-input",placeholder:"Procedure Name",value:a.name||"",onChange:t=>m({...a,name:t.target.value})}),e.jsxs("select",{className:"form-select",value:a.type||"general",onChange:t=>m({...a,type:t.target.value}),children:[e.jsx("option",{value:"general",children:"General"}),e.jsx("option",{value:"filling",children:"Filling"}),e.jsx("option",{value:"rct",children:"RCT"}),e.jsx("option",{value:"extraction",children:"Extraction"}),e.jsx("option",{value:"crown",children:"Crown"}),e.jsx("option",{value:"bridge",children:"Bridge"}),e.jsx("option",{value:"implant",children:"Implant"})]}),e.jsx("input",{type:"number",className:"form-input",placeholder:"Cost",value:a.cost||"",onChange:t=>m({...a,cost:parseFloat(t.target.value)})}),e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{onClick:v,className:"btn-primary",children:"Save"}),e.jsx("button",{onClick:()=>k(!1),className:"btn-secondary",children:"Cancel"})]})]})]}):e.jsxs("button",{onClick:()=>k(!0),className:"add-trigger-btn",children:[e.jsx(ke,{size:18})," Add New Procedure"]})})]})})},_e=({toothNumber:N,procedures:x,onSelect:D,onClose:b})=>{const[r,F]=i.useState(""),h=i.useMemo(()=>x.filter(c=>c.name.toLowerCase().includes(r.toLowerCase())),[x,r]);return e.jsxs("div",{className:"modal-overlay",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,backdropFilter:"blur(2px)"},children:[e.jsxs("div",{className:"modal-content",style:{backgroundColor:"var(--dp-card-bg)",borderRadius:"12px",width:"100%",maxWidth:"400px",boxShadow:"0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",overflow:"hidden",animation:"scaleUp 0.2s ease-out"},children:[e.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid var(--dp-border)",display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"var(--dp-bg)"},children:[e.jsxs("h3",{style:{margin:0,color:"var(--dp-text)",fontSize:"1.1rem"},children:["Tooth ",N," Procedures"]}),e.jsx("button",{onClick:b,style:{background:"none",border:"none",color:"var(--dp-text-sec)",cursor:"pointer",padding:"4px"},children:e.jsx(K,{size:20})})]}),e.jsx("div",{style:{padding:"12px 16px",borderBottom:"1px solid var(--dp-border)"},children:e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center"},children:[e.jsx(Te,{size:16,style:{position:"absolute",left:"12px",color:"var(--dp-text-sec)"}}),e.jsx("input",{type:"text",placeholder:"Search procedures...",value:r,onChange:c=>F(c.target.value),style:{width:"100%",padding:"8px 12px 8px 36px",borderRadius:"8px",border:"1px solid var(--dp-border)",backgroundColor:"var(--dp-bg)",color:"var(--dp-text)",fontSize:"0.9rem",outline:"none"},autoFocus:!0})]})}),e.jsx("div",{style:{maxHeight:"400px",overflowY:"auto"},children:h.length===0?e.jsx("div",{style:{padding:"24px",textAlign:"center",color:"var(--dp-text-sec)",fontSize:"0.9rem"},children:"No procedures found."}):e.jsx("div",{style:{display:"flex",flexDirection:"column"},children:h.map(c=>e.jsxs("button",{onClick:()=>D(c),style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 16px",border:"none",background:"transparent",borderBottom:"1px solid var(--dp-border)",cursor:"pointer",textAlign:"left",transition:"background-color 0.1s"},className:"procedure-modal-item",onMouseOver:u=>u.currentTarget.style.backgroundColor="var(--dp-bg)",onMouseOut:u=>u.currentTarget.style.backgroundColor="transparent",children:[e.jsxs("div",{children:[e.jsx("div",{style:{color:"var(--dp-text)",fontWeight:500,fontSize:"0.95rem"},children:c.name}),e.jsx("div",{style:{color:"var(--dp-text-sec)",fontSize:"0.8rem",textTransform:"capitalize"},children:c.type})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"var(--dp-primary)",fontWeight:600,fontSize:"0.9rem"},children:[e.jsxs("span",{children:["₹",c.cost]}),e.jsx(ke,{size:16})]})]},c.id))})})]}),e.jsx("style",{children:`
                @keyframes scaleUp {
                    from { transform: scale(0.95); opacity: 0; }
                    to { transform: scale(1); opacity: 1; }
                }
            `})]})},Oe=({isOpen:N,onClose:x,recordId:D,onBillingComplete:b})=>{var de,he,xe,Z,ie;const[r,F]=i.useState(null),[h,c]=i.useState([]),[u,z]=i.useState(!0),[G,k]=i.useState(null),[a,m]=i.useState(!1),[y,v]=i.useState("cash"),[w,L]=i.useState(""),[T,t]=i.useState(""),[g,W]=i.useState(""),[O,X]=i.useState(""),[U,ee]=i.useState(""),[J,B]=i.useState(0),H=i.useRef(!1),[$,se]=i.useState(null),[re,le]=i.useState(!1),me=d=>{const f=Math.max(0,Math.min(100,isNaN(d)?0:d));H.current=!0,B(f);const C=h.map(j=>({...j,discount_percentage:f}));c(C)},oe=(d,f)=>{const C=[...h];C[d].discount_percentage=isNaN(f)?0:f,c(C)};i.useEffect(()=>{if(H.current){H.current=!1;return}const d=h.reduce((j,_)=>j+(_.price??0),0);if(d===0){B(0);return}const C=h.reduce((j,_)=>{const V=(_.price??0)*((_.discount_percentage??0)/100);return j+V},0)/d*100;B(j=>Math.abs(j-C)>.01?C:j)},[h]);const ue=async()=>{if(!r)return k("No record data available to bill."),null;if(h.length===0)return k("Cannot bill an empty procedure list."),null;m(!0),k(null);try{const d=h.map(M=>{const V=M.price,Q=V*((M.discount_percentage??0)/100),je=V-Q;return{name:M.name,price:M.price,quantity:1,total:je,item_id:M.id||`proc_${Date.now()}`,type:"service",discount_percentage:M.discount_percentage??0}}),f={patientId:r.patientId.id,items:d,amount:q,paymentMode:y,type:"dental",related_id:r.id,status:"paid",discountPercentage:J},C=await R("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)}),j=await C.json();if(!C.ok||!j.id)throw new Error(j.message||"Failed to create bill.");if((await R(`/api/dental/${r.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",billId:j.id})})).ok||console.error("Failed to update dental record status"),F(M=>M?{...M,status:"billed",billId:j.id}:null),y==="credit")try{await R(`/api/patient-debts/${r.patientId.id}/debts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction_date:new Date().toISOString().split("T")[0],debt_value:q,related_bill_id:j.id,notes:`Dental Bill #${j.id}`})})}catch(M){console.error("Failed to create debt entry:",M)}return alert(`Dental bill created (ID: ${j.id}).`),b&&b(),j.id}catch(d){return console.error("Billing process failed:",d),k(d.message||"Failed to create bill."),null}finally{m(!1)}},ce=()=>{window.print()},pe=async()=>{await ue()&&setTimeout(()=>window.print(),800)};i.useEffect(()=>{N&&D&&(async()=>{z(!0);try{const[f,C]=await Promise.all([R(`/api/dental/${D}`),R("/api/clinics/settings").catch(()=>({ok:!1,json:async()=>({})}))]);if(!f.ok)throw new Error("Failed to fetch dental record");const j=await f.json(),_={...j,patientId:j.Patient||j.patientId};if(F(_),C.ok){const Q=await C.json();t(Q.upi_id||""),W(Q.name||""),X(Q.address||""),ee(Q.notes||"")}const V=(_.selected_procedures||_.selectedProcedures||[]).map(Q=>({...Q,price:Q.cost,discount_percentage:0}));c(V)}catch(f){console.error("Failed to fetch data:",f),k(f.message)}finally{z(!1)}})()},[N,D]);const te=i.useMemo(()=>h.reduce((d,f)=>d+(f.price??0),0),[h]),ne=i.useMemo(()=>h.reduce((d,f)=>{const j=(f.price??0)*(f.discount_percentage??0)/100;return d+j},0),[h]),q=i.useMemo(()=>te-ne,[te,ne]);return i.useEffect(()=>{if(q>0&&T){const d=`upi://pay?pa=${T}&pn=${encodeURIComponent(g)}&am=${q.toFixed(2)}&cu=INR`;L(d)}else L("")},[q,T,g]),i.useEffect(()=>{(async()=>{var f;if(y==="credit"&&((f=r==null?void 0:r.patientId)!=null&&f.id)){le(!0);try{const C=await R(`/api/patient-debts/${r.patientId.id}/balance`);if(C.ok){const j=await C.json();se(j.netDebt||0)}else se(0)}catch{se(0)}finally{le(!1)}}})()},[y,(de=r==null?void 0:r.patientId)==null?void 0:de.id]),N?e.jsx("div",{className:"dental-billing-modal-overlay",children:e.jsxs("div",{className:"dental-billing-modal-content",children:[e.jsxs("header",{className:"dental-billing-modal-header no-print",children:[e.jsx("h2",{children:"Dental Invoice"}),e.jsx("button",{onClick:x,className:"close-modal-btn",children:e.jsx(K,{size:20})})]}),e.jsx("div",{className:"dental-billing-modal-body",children:u?e.jsx("div",{className:"pharmacy-billing-page",children:e.jsx("div",{className:"billing-container",children:e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("div",{className:"order-details-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(S,{width:150,height:24})})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsx("div",{className:"info-item",children:e.jsx(S,{width:200,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(S,{width:150,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(S,{width:180,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(S,{width:150,height:20})})]})]}),e.jsxs("div",{className:"medications-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(S,{width:120,height:24})})}),e.jsx("div",{className:"p-4",children:e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx(S,{width:30,height:20})}),e.jsx("th",{children:e.jsx(S,{width:150,height:20})}),e.jsx("th",{children:e.jsx(S,{width:80,height:20})}),e.jsx("th",{children:e.jsx(S,{width:80,height:20})}),e.jsx("th",{children:e.jsx(S,{width:100,height:20})})]})}),e.jsx("tbody",{children:[1,2,3].map(d=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(S,{width:20,height:20})}),e.jsx("td",{children:e.jsx(S,{width:180,height:20})}),e.jsx("td",{children:e.jsx(S,{width:70,height:20})}),e.jsx("td",{children:e.jsx(S,{width:70,height:20})}),e.jsx("td",{children:e.jsx(S,{width:90,height:20})})]},d))})]})})]})]}),e.jsx("aside",{className:"billing-sidebar",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(S,{width:160,height:24})})}),e.jsxs("div",{className:"space-y-4 p-5",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(S,{width:100,height:20}),e.jsx(S,{width:80,height:20})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(S,{width:100,height:20}),e.jsx(S,{width:80,height:20})]}),e.jsx("hr",{}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(S,{width:120,height:28}),e.jsx(S,{width:100,height:28})]})]})]})})]})})}):G?e.jsxs("div",{className:"error-message-box",children:["Error: ",G]}):r?e.jsx("div",{className:"pharmacy-billing-page",children:e.jsxs("div",{className:"billing-container printable-section",children:[e.jsxs("div",{className:"billing-header print-only",children:[e.jsx("div",{className:"clinic-header-left",children:e.jsx("div",{className:"clinic-info-print",children:e.jsxs("div",{className:"clinic-name-and-details-print",children:[e.jsx("h1",{className:"bill-title",children:"DENTAL INVOICE"}),e.jsx("h2",{className:"clinic-name-print",children:g||"Clinic Name"}),(O||U)&&e.jsxs("div",{className:"clinic-details-print",children:[O&&e.jsx("span",{className:"small-text clinic-address",children:O}),U&&e.jsx("span",{className:"small-text clinic-notes",children:U})]})]})})}),e.jsxs("div",{className:"patient-info-grid print-only-patient-details",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(fe,{size:16})," Patient Name"]})," ",((he=r.patientId)==null?void 0:he.name)||"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Ne,{size:16})," Token"]})," ",((xe=r.patientId)==null?void 0:xe.patient_token_number)??"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(we,{size:16})," Date"]})," ",new Date(r.date||r.createdAt).toLocaleDateString()]})]})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("section",{className:"order-details-card no-print",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Patient Information"})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(fe,{size:16})," Patient Name"]})," ",((Z=r.patientId)==null?void 0:Z.name)||"N/A"," "]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Ne,{size:16})," Token"]})," ",((ie=r.patientId)==null?void 0:ie.patient_token_number)??"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(ye,{size:16})," Record ID"]})," ",r.id.substring(r.id.length-6)]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(we,{size:16})," Date"]})," ",new Date(r.createdAt).toLocaleDateString()]})]})]}),e.jsxs("section",{className:"medications-card",children:[e.jsx("div",{className:"card-header no-print",children:e.jsx("h2",{children:"Procedures"})}),h.length>0?e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"S.No."}),e.jsx("th",{children:"PROCEDURE"}),e.jsx("th",{children:"PRICE"}),e.jsx("th",{children:"DIS %"}),e.jsx("th",{children:"AMT"})]})}),e.jsx("tbody",{children:h.map((d,f)=>{const C=d.price??0,j=C*(d.discount_percentage??0)/100,_=C-j;return e.jsxs("tr",{children:[e.jsx("td",{children:f+1}),e.jsx("td",{children:d.name}),e.jsx("td",{children:d.price.toFixed(2)}),e.jsxs("td",{children:[e.jsx("input",{type:"number",value:d.discount_percentage===0?"":d.discount_percentage,onChange:M=>oe(f,parseFloat(M.target.value)),min:"0",max:"100",className:"discount-input-table"}),"%"]}),e.jsx("td",{children:_.toFixed(2)})]},f)})})]}):e.jsx("p",{className:"p-4 text-gray-500",children:"No procedures selected."})]}),e.jsxs("div",{className:"bill-summary-print print-only",children:[e.jsxs("div",{className:"bill-summary-details",children:[e.jsxs("div",{className:"summary-row-print",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",te.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row-print",children:[e.jsxs("span",{children:["Discount (",J.toFixed(2),"%)"]}),e.jsxs("span",{children:["- ₹",ne.toFixed(2)]})]}),e.jsx("div",{className:"print-only-total",children:e.jsxs("strong",{children:["Grand Total: ₹",q.toFixed(2)]})})]}),w&&e.jsxs("div",{className:`qr-code-container qr-code-printable-section ${y!=="upi"?"hide-on-screen":""}`,children:[e.jsx(Ce,{value:w,size:80}),e.jsx("p",{className:"print-only-upi-text",children:"Scan to pay"})]})]})]}),e.jsx("aside",{className:"billing-sidebar no-print",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Billing Summary"})}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",te.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Total Discount"}),e.jsxs("span",{children:["- ₹",ne.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Discount Percentage"}),e.jsxs("div",{className:"discount-input-wrapper",children:[e.jsx("input",{type:"number",value:J===0?"":J,onChange:d=>me(parseFloat(d.target.value)),min:"0",max:"100",className:"discount-input-total",disabled:a||r.status==="billed"}),"%"]})]}),e.jsxs("div",{className:"summary-row grand-total-row",children:[e.jsx("strong",{children:"Grand Total"}),e.jsxs("strong",{children:["₹",q.toFixed(2)]})]}),e.jsx("div",{className:"qr-code-container",children:w?e.jsxs(e.Fragment,{children:[e.jsx(Ce,{value:w,size:128}),e.jsx("p",{children:"Scan to pay using UPI"})]}):e.jsx("p",{className:"text-sm text-gray-500",children:"UPI QR code not available."})}),e.jsxs("div",{className:"payment-mode-section",children:[e.jsx("label",{className:"info-item",children:e.jsx("strong",{children:"Payment Mode"})}),e.jsxs("select",{value:y,onChange:d=>v(d.target.value),className:"payment-mode-select",disabled:a||r.status==="billed",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"no_cash_insurance",children:"Insurance"}),e.jsx("option",{value:"credit",children:"Credit (Debt)"})]})]}),y==="credit"&&e.jsxs("div",{className:"debt-info-section",style:{marginTop:"10px",padding:"12px",backgroundColor:"rgba(220, 53, 69, 0.1)",borderRadius:"8px",border:"1px solid rgba(220, 53, 69, 0.3)"},children:[e.jsx("div",{style:{fontWeight:"bold",color:"#dc3545",marginBottom:"8px"},children:"⚠️ Debt to Patient"}),re?e.jsx("div",{style:{fontSize:"0.9em",color:"#666"},children:"Loading debt info..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"Current Debt:"}),e.jsxs("strong",{style:{color:$&&$>0?"#dc3545":"#28a745"},children:["₹",($||0).toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"This Bill:"}),e.jsxs("strong",{children:["+ ₹",q.toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",borderTop:"1px solid rgba(220, 53, 69, 0.3)",paddingTop:"8px",marginTop:"8px"},children:[e.jsx("span",{children:e.jsx("strong",{children:"New Total Debt:"})}),e.jsxs("strong",{style:{color:"#dc3545"},children:["₹",(($||0)+q).toFixed(2)]})]})]})]}),e.jsx("div",{className:"bill-actions mt-6 flex flex-col gap-3",children:r.status!=="billed"?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:ce,className:"secondary-button print-preview-button no-print",disabled:a,children:"Print Preview"}),e.jsx("button",{onClick:pe,className:"primary-button",disabled:a,children:a?"Processing...":"Finalise and Bill"})]}):e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"p-3 bg-green-50 text-green-700 text-center rounded-lg font-medium border border-green-100 flex items-center justify-center gap-2",children:[e.jsx(Me,{size:20})," Bill Generated"]}),e.jsx("button",{onClick:ce,className:"secondary-button print-preview-button no-print",children:"Print Preview"})]})})]})})]}),e.jsx("footer",{className:"billing-footer print-only",children:e.jsx("p",{children:"Computer generated invoice."})})]})}):e.jsx("div",{className:"error-message-box",children:"No record found."})})]})}):null},Se=/^\+?[0-9\s\-().]{7,20}$/,Ue=/^[a-zA-Z\s'-]{2,}$/,Ve=()=>{const N=Le(),[x,D]=i.useState(""),[b,r]=i.useState([]),[F,h]=i.useState(!1),[c,u]=i.useState(null),[z,G]=i.useState(!1),[k,a]=i.useState(!1),[m,y]=i.useState(!1),[v,w]=i.useState([]),[L,T]=i.useState([]),[t,g]=i.useState({}),[W,O]=i.useState(""),[X,U]=i.useState(!1),[ee,J]=i.useState("plan"),[B,H]=i.useState([]),[$,se]=i.useState([]),[re,le]=i.useState(!1),[me,oe]=i.useState(!1),[ue,ce]=i.useState(null);i.useEffect(()=>{pe()},[]);const pe=async()=>{try{const s=await R("/api/dental/procedures");if(s.ok){const n=await s.json();se(n)}}catch(s){console.error("Error fetching procedures",s)}};i.useEffect(()=>{(async()=>{if(!c){H([]);return}try{const n=await R(`/api/dental/patient/${c.id}`);if(n.ok){const o=await n.json();H(o)}}catch(n){console.error("Error fetching history",n)}})()},[c]);const te=i.useMemo(()=>De(async s=>{if(!s.trim()||s.length<2){r([]),h(!1);return}h(!0);try{const n=await R(`/api/patients?search=${encodeURIComponent(s)}&limit=10`);if(n.ok){const o=await n.json();r(o.patients||[])}}catch(n){console.error("Search error:",n)}finally{h(!1)}},300),[]);i.useEffect(()=>{te(x)},[x,te]);const ne=s=>{const n=s.target.value;D(n),a(Se.test(n)),y(Ue.test(n)&&!Se.test(n))},q=async s=>{if(!(!x||s==="phone"&&!k||s==="name"&&!m)){h(!0);try{const o=await R("/api/patients",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s==="name"?x:"direct dental",phone:s==="phone"?x:null,age:null,gender:null,token:null})});if(o.ok){const p=await o.json();de({id:p.id,name:p.name,token:p.token??null,age:p.age??null,gender:p.gender??null,phone:p.phone})}else alert("Failed to create patient")}catch(n){console.error("Error creating patient:",n),alert("Error creating patient")}finally{h(!1)}}},de=s=>{u(s),D(""),r([])},he=()=>{u(null),w([]),T([]),g({}),O("")},xe=async s=>{if(!c)return;const n=await R(`/api/patients/${c.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(n.ok)await n.json(),u(o=>o?{...o,...s}:null);else throw new Error("Failed to update")},[Z,ie]=i.useState(null),d=s=>{ie(s)},f=s=>{if(!Z)return;const n={instanceId:crypto.randomUUID(),procedureId:s.id,name:s.name,price:s.cost,type:s.type};g(o=>{const p=o[Z]||[];return{...o,[Z]:[...p,n]}}),w(o=>o.includes(Z)?o:[...o,Z]),ie(null)},C=()=>{const s={},n={},o=(l,P)=>{s[l]||(s[l]=[]);const A=`condition-${P}`;s[l].includes(A)||s[l].push(A)},p=(l,P)=>{n[l]||(n[l]=[]),n[l].push(P)};return[...B].sort((l,P)=>new Date(l.date).getTime()-new Date(P.date).getTime()).forEach(l=>{l.teeth&&Array.isArray(l.teeth)&&l.teeth.forEach(P=>{P.procedures.forEach(A=>{var ae;let E=(ae=l.selected_procedures)==null?void 0:ae.find(ge=>ge.id===A);E||(E=$.find(ge=>ge.id===A)),E&&E.type!=="general"?(o(P.toothNumber,E.type),p(P.toothNumber,{name:E.name,date:new Date(l.date||l.createdAt||0).toLocaleDateString(),recordId:l.id,isPast:!0})):A&&p(P.toothNumber,{name:`Procedure: ${A}`,date:new Date(l.date||l.createdAt||0).toLocaleDateString(),recordId:l.id,isPast:!0})})})}),Object.keys(t).forEach(l=>{const P=parseInt(l),A=t[P];A&&A.length>0&&A.forEach(E=>{E.type!=="general"&&(o(P,E.type),p(P,{name:E.name,date:"Current",isPast:!1}))})}),{conditions:s,details:n}},{conditions:j,details:_}=i.useMemo(()=>C(),[B,t,$]),M=s=>{const n=B.find(l=>l.id===s);if(!n)return;O(n.notes||"");const o=n.selected_procedures.filter(l=>!n.teeth.some(P=>P.procedures.includes(l.id)));T(o.map(l=>({instanceId:crypto.randomUUID(),procedureId:l.id,name:l.name,price:l.cost,type:l.type})));const p={},I=[];n.teeth.forEach(l=>{const P=l.procedures.map(A=>{const E=n.selected_procedures.find(ae=>ae.id===A)||$.find(ae=>ae.id===A);return{instanceId:crypto.randomUUID(),procedureId:A,name:E?E.name:A,price:E?E.cost:0,type:E?E.type:"general"}});P.length>0&&(p[l.toothNumber]=P,I.push(l.toothNumber))}),g(p),w(I),J("plan"),alert(`Loaded record from ${new Date(n.date||n.createdAt||0).toLocaleDateString()} for editing. You can modify procedures and save as a new record.`)},V=(s,n)=>{n?(g(o=>{const p={...o};return p[n]=(o[n]||[]).filter(I=>I.instanceId!==s),p[n].length===0&&delete p[n],p}),w(o=>o)):T(o=>o.filter(p=>p.instanceId!==s))},Q=(s,n,o)=>{o?g(p=>({...p,[o]:(p[o]||[]).map(I=>I.instanceId===s?{...I,price:n}:I)})):T(p=>p.map(I=>I.instanceId===s?{...I,price:n}:I))},je=()=>{window.print()},Ie=async()=>{if(c){U(!0);try{const n=[...L,...Object.values(t).flat()].map(l=>({id:l.procedureId,name:l.name,cost:l.price,type:l.type})),p=Object.keys(t).map(Number).map(l=>({toothNumber:l,procedures:(t[l]||[]).map(P=>P.procedureId),notes:""})),I=await R("/api/dental",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:c.id,teeth:p,selectedProcedures:n,notes:W})});if(I.ok){const l=await I.json();ce(l.id),oe(!0)}else alert("Failed to save dental record.")}catch(s){console.error(s),alert("Error saving record.")}finally{U(!1)}}};return e.jsxs("div",{className:"dental-page-container printable-section",children:[e.jsxs("header",{className:"dental-header",children:[e.jsxs("div",{className:"dental-title-group",children:[e.jsx(ye,{className:"dental-title-icon"}),e.jsxs("div",{children:[e.jsx("h1",{className:"dental-title",children:"Dental Procedure"}),e.jsx("p",{className:"dental-subtitle",children:"Create new dental records and bills"})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx("button",{onClick:()=>N(-1),className:"dental-back-btn no-print",children:"Back"})})]}),c?e.jsxs("div",{className:"dental-workspace",children:[e.jsxs("div",{className:"patient-header-card",children:[e.jsxs("div",{className:"patient-info-group",children:[e.jsx("div",{className:"patient-avatar",children:c.name.charAt(0).toUpperCase()}),e.jsxs("div",{className:"patient-details",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("h3",{children:c.name}),e.jsx("button",{onClick:()=>G(!0),className:"icon-button text-gray-500 hover:text-blue-600",style:{padding:0,border:"none",background:"transparent",cursor:"pointer"},children:e.jsx(ve,{size:14})})]}),e.jsxs("p",{children:[c.gender," / ",c.age," yrs • ",c.phone]})]})]}),e.jsx("button",{onClick:he,className:"close-patient-btn",title:"Change Patient",children:e.jsx(K,{size:20})})]}),e.jsxs("div",{className:"dental-grid",children:[e.jsxs("div",{className:"chart-section",children:[e.jsx("div",{className:"dental-card chart-card-scroll",children:e.jsx(Ae,{selectedTeeth:v,toothConditions:j,toothDetails:_,onToothClick:d,onEditPastRecord:M,onPrint:je})}),e.jsxs("div",{className:"dental-card notes-container",children:[e.jsx("h4",{className:"section-title-sm",children:"Clinical Notes"}),e.jsx("textarea",{className:"notes-area",placeholder:"Enter clinical findings...",value:W,onChange:s=>O(s.target.value)})]})]}),e.jsx("div",{className:"dental-card procedures-section",children:e.jsxs("div",{className:"treatment-plan-container",style:{borderTop:"none"},children:[e.jsxs("div",{className:"sidebar-tabs",children:[e.jsx("button",{onClick:()=>J("plan"),className:ee==="plan"?"active":"",children:"Treatment Plan"}),e.jsx("button",{onClick:()=>J("history"),className:ee==="history"?"active":"",children:"Visit History"})]}),e.jsx("div",{className:"treatment-plan-list custom-scrollbar",children:ee==="plan"?e.jsx(e.Fragment,{children:L.length===0&&Object.keys(t).length===0?e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"var(--dp-text-sec)",fontSize:"0.85rem"},children:"Select a tooth to add procedures."}):e.jsxs(e.Fragment,{children:[L.length>0&&e.jsxs("div",{className:"plan-group",children:[e.jsx("h4",{children:"General"}),L.map(s=>e.jsxs("div",{className:"plan-item",children:[e.jsx("span",{className:"plan-item-name",title:s.name,children:s.name}),e.jsxs("div",{style:{display:"flex",gap:"6px",alignItems:"center"},children:[e.jsx("input",{type:"number",value:s.price,onChange:n=>Q(s.instanceId,parseFloat(n.target.value)||0),className:"cost-input"}),e.jsx("button",{onClick:()=>V(s.instanceId),style:{background:"none",border:"none",color:"var(--dp-danger)",cursor:"pointer",padding:0},children:e.jsx(K,{size:14})})]})]},s.instanceId))]}),Object.entries(t).map(([s,n])=>n.length===0?null:e.jsxs("div",{className:"plan-group",children:[e.jsxs("h4",{children:["Tooth ",s]}),n.map(o=>e.jsxs("div",{className:"plan-item",children:[e.jsx("span",{className:"plan-item-name",title:o.name,children:o.name}),e.jsxs("div",{style:{display:"flex",gap:"6px",alignItems:"center"},children:[e.jsx("input",{type:"number",value:o.price,onChange:p=>Q(o.instanceId,parseFloat(p.target.value)||0,parseInt(s)),className:"cost-input"}),e.jsx("button",{onClick:()=>V(o.instanceId,parseInt(s)),style:{background:"none",border:"none",color:"var(--dp-danger)",cursor:"pointer",padding:0},children:e.jsx(K,{size:14})})]})]},o.instanceId))]},s))]})}):e.jsx("div",{className:"history-list",children:B.length===0?e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"var(--dp-text-sec)",fontSize:"0.85rem"},children:"No past visits found."}):B.map(s=>e.jsxs("div",{className:"history-record-card",children:[e.jsxs("div",{className:"history-record-header",children:[e.jsx("span",{className:"record-date",children:new Date(s.date).toLocaleDateString()}),e.jsx("span",{className:"record-status",children:s.status})]}),e.jsxs("div",{className:"history-record-body",children:[s.teeth.map(n=>e.jsxs("div",{className:"history-tooth-group",children:[e.jsxs("strong",{children:["Tooth ",n.toothNumber,":"]})," ",n.procedures.map(o=>{const p=s.selected_procedures.find(I=>I.id===o)||$.find(I=>I.id===o);return p?p.name:o}).join(", ")]},n.toothNumber)),s.notes&&e.jsx("p",{className:"history-notes",children:e.jsxs("em",{children:["Notes: ",s.notes]})}),s.status==="billed"&&e.jsx("div",{className:"history-record-actions mt-3",children:e.jsxs("button",{onClick:()=>{ce(s.id),oe(!0)},className:"view-bill-btn",children:[e.jsx(ye,{size:14})," View Bill"]})})]})]},s.id))})}),e.jsx("div",{className:"action-footer",children:e.jsx("button",{onClick:Ie,className:"save-btn",disabled:X||L.length===0&&Object.keys(t).length===0,children:X?"Saving...":"Save & Bill"})})]})})]})]}):e.jsxs("div",{className:"patient-search-container",children:[e.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:700,marginBottom:"24px",color:"var(--dp-text)"},children:"Who is this for?"}),e.jsxs("div",{className:"search-input-wrapper",children:[e.jsx(Te,{className:"search-icon-overlay",size:20}),e.jsx("input",{type:"text",placeholder:"Search by name or phone...",className:"dental-search-input",value:x,onChange:ne,autoFocus:!0}),F&&e.jsx("div",{className:"search-spinner"})]}),b.length>0&&e.jsx("div",{className:"search-results-dropdown",children:b.map(s=>e.jsxs("div",{onClick:()=>de(s),className:"search-result-item",children:[e.jsxs("div",{children:[e.jsx("span",{className:"patient-name-highlight",children:s.name}),e.jsxs("div",{className:"patient-meta",children:[s.age," yrs / ",s.gender," • ",s.phone]})]}),e.jsx(fe,{size:18,color:"var(--dp-text-sec)"})]},s.id))}),x.length>=2&&!F&&b.length===0&&e.jsxs("div",{style:{textAlign:"center",marginTop:"20px"},children:[e.jsxs("p",{style:{color:"var(--dp-text-sec)",marginBottom:"15px"},children:['No patients found matching "',x,'".']}),e.jsx("div",{style:{display:"flex",justifyContent:"center",gap:"15px"},children:(k||m)&&e.jsxs("button",{type:"button",onClick:()=>q(k?"phone":"name"),className:"register-new-btn",style:{backgroundColor:"var(--dp-card-bg)",border:"1px solid var(--dp-primary)",padding:"8px 16px",borderRadius:"8px"},children:['Create "',x,'"']})})]}),e.jsx("div",{style:{marginTop:"32px"},children:e.jsx("button",{onClick:()=>le(!0),className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:"Manage Procedures"})})]}),z&&c&&e.jsx(Ee,{patient:c,onClose:()=>G(!1),onSave:xe}),re&&e.jsx(Be,{onClose:()=>le(!1),onUpdate:pe}),Z!==null&&e.jsx(_e,{toothNumber:Z,procedures:$,onSelect:f,onClose:()=>ie(null)}),e.jsx(Oe,{isOpen:me,recordId:ue,onClose:()=>{oe(!1),he()},onBillingComplete:()=>{}})]})};export{Ve as default};
