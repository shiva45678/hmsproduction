import{c as Js,g as ic,R as vi,r as b,j as i,S as Te,P as Ln,T as ft,d as Qs,a as Gs,F as Ys,X as fn,f as G,G as ac,e as sc,h as At,C as Ks,i as yr,k as pr,l as Xs,H as Zs,Q as eo,m as to,M as Qt,n as bt,o as no,q as ht,p as oc,s as lc,u as cc,t as uc,v as dc,w as ii,D as ns,x as rs,E as pc,y as is,z as as,L as hc,A as mc,B as fc,I as gc,J as yc,K as xc,N as bc,O as wc,V as kc,W as _c,Y as Nc}from"./index-CpxTVu-I.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vc=[["path",{d:"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z",key:"3c2336"}],["path",{d:"M8 8h8",key:"1bis0t"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"m13 17-5-1h1a4 4 0 0 0 0-8",key:"nu2bwa"}]],ro=Js("badge-indian-rupee",vc);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jc=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],mt=Js("pencil",jc),Cc={};function Fi(e,n){const t=Cc,r=typeof t.includeImageAlt=="boolean"?t.includeImageAlt:!0,s=typeof t.includeHtml=="boolean"?t.includeHtml:!0;return io(e,r,s)}function io(e,n,t){if(Sc(e)){if("value"in e)return e.type==="html"&&!t?"":e.value;if(n&&"alt"in e&&e.alt)return e.alt;if("children"in e)return ss(e.children,n,t)}return Array.isArray(e)?ss(e,n,t):""}function ss(e,n,t){const r=[];let s=-1;for(;++s<e.length;)r[s]=io(e[s],n,t);return r.join("")}function Sc(e){return!!(e&&typeof e=="object")}const os=document.createElement("i");function zi(e){const n="&"+e+";";os.innerHTML=n;const t=os.textContent;return t.charCodeAt(t.length-1)===59&&e!=="semi"||t===n?!1:t}function _t(e,n,t,r){const s=e.length;let a=0,o;if(n<0?n=-n>s?0:s+n:n=n>s?s:n,t=t>0?t:0,r.length<1e4)o=Array.from(r),o.unshift(n,t),e.splice(...o);else for(t&&e.splice(n,t);a<r.length;)o=r.slice(a,a+1e4),o.unshift(n,0),e.splice(...o),a+=1e4,n+=1e4}function ut(e,n){return e.length>0?(_t(e,e.length,0,n),e):n}const ls={}.hasOwnProperty;function Tc(e){const n={};let t=-1;for(;++t<e.length;)Pc(n,e[t]);return n}function Pc(e,n){let t;for(t in n){const s=(ls.call(e,t)?e[t]:void 0)||(e[t]={}),a=n[t];let o;if(a)for(o in a){ls.call(s,o)||(s[o]=[]);const l=a[o];Ec(s[o],Array.isArray(l)?l:l?[l]:[])}}}function Ec(e,n){let t=-1;const r=[];for(;++t<n.length;)(n[t].add==="after"?e:r).push(n[t]);_t(e,0,0,r)}function ao(e,n){const t=Number.parseInt(e,n);return t<9||t===11||t>13&&t<32||t>126&&t<160||t>55295&&t<57344||t>64975&&t<65008||(t&65535)===65535||(t&65535)===65534||t>1114111?"�":String.fromCodePoint(t)}function pn(e){return e.replace(/[\t\n\r ]+/g," ").replace(/^ | $/g,"").toLowerCase().toUpperCase()}const kt=Bt(/[A-Za-z]/),it=Bt(/[\dA-Za-z]/),Ac=Bt(/[#-'*+\--9=?A-Z^-~]/);function ji(e){return e!==null&&(e<32||e===127)}const Ci=Bt(/\d/),Dc=Bt(/[\dA-Fa-f]/),Ic=Bt(/[!-/:-@[-`{-~]/);function ge(e){return e!==null&&e<-2}function Ke(e){return e!==null&&(e<0||e===32)}function Pe(e){return e===-2||e===-1||e===32}const Oc=Bt(new RegExp("\\p{P}|\\p{S}","u")),$c=Bt(/\s/);function Bt(e){return n;function n(t){return t!==null&&t>-1&&e.test(String.fromCharCode(t))}}function gn(e){const n=[];let t=-1,r=0,s=0;for(;++t<e.length;){const a=e.charCodeAt(t);let o="";if(a===37&&it(e.charCodeAt(t+1))&&it(e.charCodeAt(t+2)))s=2;else if(a<128)/[!#$&-;=?-Z_a-z~]/.test(String.fromCharCode(a))||(o=String.fromCharCode(a));else if(a>55295&&a<57344){const l=e.charCodeAt(t+1);a<56320&&l>56319&&l<57344?(o=String.fromCharCode(a,l),s=1):o="�"}else o=String.fromCharCode(a);o&&(n.push(e.slice(r,t),encodeURIComponent(o)),r=t+s+1,o=""),s&&(t+=s,s=0)}return n.join("")+e.slice(r)}function Oe(e,n,t,r){const s=r?r-1:Number.POSITIVE_INFINITY;let a=0;return o;function o(c){return Pe(c)?(e.enter(t),l(c)):n(c)}function l(c){return Pe(c)&&a++<s?(e.consume(c),l):(e.exit(t),n(c))}}const Lc={tokenize:Rc};function Rc(e){const n=e.attempt(this.parser.constructs.contentInitial,r,s);let t;return n;function r(l){if(l===null){e.consume(l);return}return e.enter("lineEnding"),e.consume(l),e.exit("lineEnding"),Oe(e,n,"linePrefix")}function s(l){return e.enter("paragraph"),a(l)}function a(l){const c=e.enter("chunkText",{contentType:"text",previous:t});return t&&(t.next=c),t=c,o(l)}function o(l){if(l===null){e.exit("chunkText"),e.exit("paragraph"),e.consume(l);return}return ge(l)?(e.consume(l),e.exit("chunkText"),a):(e.consume(l),o)}}const Fc={tokenize:zc},cs={tokenize:qc};function zc(e){const n=this,t=[];let r=0,s,a,o;return l;function l(L){if(r<t.length){const W=t[r];return n.containerState=W[1],e.attempt(W[0].continuation,c,u)(L)}return u(L)}function c(L){if(r++,n.containerState._closeFlow){n.containerState._closeFlow=void 0,s&&H();const W=n.events.length;let F=W,j;for(;F--;)if(n.events[F][0]==="exit"&&n.events[F][1].type==="chunkFlow"){j=n.events[F][1].end;break}$(r);let Z=W;for(;Z<n.events.length;)n.events[Z][1].end={...j},Z++;return _t(n.events,F+1,0,n.events.slice(W)),n.events.length=Z,u(L)}return l(L)}function u(L){if(r===t.length){if(!s)return y(L);if(s.currentConstruct&&s.currentConstruct.concrete)return A(L);n.interrupt=!!(s.currentConstruct&&!s._gfmTableDynamicInterruptHack)}return n.containerState={},e.check(cs,m,d)(L)}function m(L){return s&&H(),$(r),y(L)}function d(L){return n.parser.lazy[n.now().line]=r!==t.length,o=n.now().offset,A(L)}function y(L){return n.containerState={},e.attempt(cs,p,A)(L)}function p(L){return r++,t.push([n.currentConstruct,n.containerState]),y(L)}function A(L){if(L===null){s&&H(),$(0),e.consume(L);return}return s=s||n.parser.flow(n.now()),e.enter("chunkFlow",{_tokenizer:s,contentType:"flow",previous:a}),q(L)}function q(L){if(L===null){K(e.exit("chunkFlow"),!0),$(0),e.consume(L);return}return ge(L)?(e.consume(L),K(e.exit("chunkFlow")),r=0,n.interrupt=void 0,l):(e.consume(L),q)}function K(L,W){const F=n.sliceStream(L);if(W&&F.push(null),L.previous=a,a&&(a.next=L),a=L,s.defineSkip(L.start),s.write(F),n.parser.lazy[L.start.line]){let j=s.events.length;for(;j--;)if(s.events[j][1].start.offset<o&&(!s.events[j][1].end||s.events[j][1].end.offset>o))return;const Z=n.events.length;let ce=Z,ne,le;for(;ce--;)if(n.events[ce][0]==="exit"&&n.events[ce][1].type==="chunkFlow"){if(ne){le=n.events[ce][1].end;break}ne=!0}for($(r),j=Z;j<n.events.length;)n.events[j][1].end={...le},j++;_t(n.events,ce+1,0,n.events.slice(Z)),n.events.length=j}}function $(L){let W=t.length;for(;W-- >L;){const F=t[W];n.containerState=F[1],F[0].exit.call(n,e)}t.length=L}function H(){s.write([null]),a=void 0,s=void 0,n.containerState._closeFlow=void 0}}function qc(e,n,t){return Oe(e,e.attempt(this.parser.constructs.document,n,t),"linePrefix",this.parser.constructs.disable.null.includes("codeIndented")?void 0:4)}function mr(e){if(e===null||Ke(e)||$c(e))return 1;if(Oc(e))return 2}function qi(e,n,t){const r=[];let s=-1;for(;++s<e.length;){const a=e[s].resolveAll;a&&!r.includes(a)&&(n=a(n,t),r.push(a))}return n}const Si={name:"attention",resolveAll:Bc,tokenize:Uc};function Bc(e,n){let t=-1,r,s,a,o,l,c,u,m;for(;++t<e.length;)if(e[t][0]==="enter"&&e[t][1].type==="attentionSequence"&&e[t][1]._close){for(r=t;r--;)if(e[r][0]==="exit"&&e[r][1].type==="attentionSequence"&&e[r][1]._open&&n.sliceSerialize(e[r][1]).charCodeAt(0)===n.sliceSerialize(e[t][1]).charCodeAt(0)){if((e[r][1]._close||e[t][1]._open)&&(e[t][1].end.offset-e[t][1].start.offset)%3&&!((e[r][1].end.offset-e[r][1].start.offset+e[t][1].end.offset-e[t][1].start.offset)%3))continue;c=e[r][1].end.offset-e[r][1].start.offset>1&&e[t][1].end.offset-e[t][1].start.offset>1?2:1;const d={...e[r][1].end},y={...e[t][1].start};us(d,-c),us(y,c),o={type:c>1?"strongSequence":"emphasisSequence",start:d,end:{...e[r][1].end}},l={type:c>1?"strongSequence":"emphasisSequence",start:{...e[t][1].start},end:y},a={type:c>1?"strongText":"emphasisText",start:{...e[r][1].end},end:{...e[t][1].start}},s={type:c>1?"strong":"emphasis",start:{...o.start},end:{...l.end}},e[r][1].end={...o.start},e[t][1].start={...l.end},u=[],e[r][1].end.offset-e[r][1].start.offset&&(u=ut(u,[["enter",e[r][1],n],["exit",e[r][1],n]])),u=ut(u,[["enter",s,n],["enter",o,n],["exit",o,n],["enter",a,n]]),u=ut(u,qi(n.parser.constructs.insideSpan.null,e.slice(r+1,t),n)),u=ut(u,[["exit",a,n],["enter",l,n],["exit",l,n],["exit",s,n]]),e[t][1].end.offset-e[t][1].start.offset?(m=2,u=ut(u,[["enter",e[t][1],n],["exit",e[t][1],n]])):m=0,_t(e,r-1,t-r+3,u),t=r+u.length-m-2;break}}for(t=-1;++t<e.length;)e[t][1].type==="attentionSequence"&&(e[t][1].type="data");return e}function Uc(e,n){const t=this.parser.constructs.attentionMarkers.null,r=this.previous,s=mr(r);let a;return o;function o(c){return a=c,e.enter("attentionSequence"),l(c)}function l(c){if(c===a)return e.consume(c),l;const u=e.exit("attentionSequence"),m=mr(c),d=!m||m===2&&s||t.includes(c),y=!s||s===2&&m||t.includes(r);return u._open=!!(a===42?d:d&&(s||!y)),u._close=!!(a===42?y:y&&(m||!d)),n(c)}}function us(e,n){e.column+=n,e.offset+=n,e._bufferIndex+=n}const Mc={name:"autolink",tokenize:Hc};function Hc(e,n,t){let r=0;return s;function s(p){return e.enter("autolink"),e.enter("autolinkMarker"),e.consume(p),e.exit("autolinkMarker"),e.enter("autolinkProtocol"),a}function a(p){return kt(p)?(e.consume(p),o):p===64?t(p):u(p)}function o(p){return p===43||p===45||p===46||it(p)?(r=1,l(p)):u(p)}function l(p){return p===58?(e.consume(p),r=0,c):(p===43||p===45||p===46||it(p))&&r++<32?(e.consume(p),l):(r=0,u(p))}function c(p){return p===62?(e.exit("autolinkProtocol"),e.enter("autolinkMarker"),e.consume(p),e.exit("autolinkMarker"),e.exit("autolink"),n):p===null||p===32||p===60||ji(p)?t(p):(e.consume(p),c)}function u(p){return p===64?(e.consume(p),m):Ac(p)?(e.consume(p),u):t(p)}function m(p){return it(p)?d(p):t(p)}function d(p){return p===46?(e.consume(p),r=0,m):p===62?(e.exit("autolinkProtocol").type="autolinkEmail",e.enter("autolinkMarker"),e.consume(p),e.exit("autolinkMarker"),e.exit("autolink"),n):y(p)}function y(p){if((p===45||it(p))&&r++<63){const A=p===45?y:d;return e.consume(p),A}return t(p)}}const xr={partial:!0,tokenize:Wc};function Wc(e,n,t){return r;function r(a){return Pe(a)?Oe(e,s,"linePrefix")(a):s(a)}function s(a){return a===null||ge(a)?n(a):t(a)}}const so={continuation:{tokenize:Jc},exit:Qc,name:"blockQuote",tokenize:Vc};function Vc(e,n,t){const r=this;return s;function s(o){if(o===62){const l=r.containerState;return l.open||(e.enter("blockQuote",{_container:!0}),l.open=!0),e.enter("blockQuotePrefix"),e.enter("blockQuoteMarker"),e.consume(o),e.exit("blockQuoteMarker"),a}return t(o)}function a(o){return Pe(o)?(e.enter("blockQuotePrefixWhitespace"),e.consume(o),e.exit("blockQuotePrefixWhitespace"),e.exit("blockQuotePrefix"),n):(e.exit("blockQuotePrefix"),n(o))}}function Jc(e,n,t){const r=this;return s;function s(o){return Pe(o)?Oe(e,a,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(o):a(o)}function a(o){return e.attempt(so,n,t)(o)}}function Qc(e){e.exit("blockQuote")}const oo={name:"characterEscape",tokenize:Gc};function Gc(e,n,t){return r;function r(a){return e.enter("characterEscape"),e.enter("escapeMarker"),e.consume(a),e.exit("escapeMarker"),s}function s(a){return Ic(a)?(e.enter("characterEscapeValue"),e.consume(a),e.exit("characterEscapeValue"),e.exit("characterEscape"),n):t(a)}}const lo={name:"characterReference",tokenize:Yc};function Yc(e,n,t){const r=this;let s=0,a,o;return l;function l(d){return e.enter("characterReference"),e.enter("characterReferenceMarker"),e.consume(d),e.exit("characterReferenceMarker"),c}function c(d){return d===35?(e.enter("characterReferenceMarkerNumeric"),e.consume(d),e.exit("characterReferenceMarkerNumeric"),u):(e.enter("characterReferenceValue"),a=31,o=it,m(d))}function u(d){return d===88||d===120?(e.enter("characterReferenceMarkerHexadecimal"),e.consume(d),e.exit("characterReferenceMarkerHexadecimal"),e.enter("characterReferenceValue"),a=6,o=Dc,m):(e.enter("characterReferenceValue"),a=7,o=Ci,m(d))}function m(d){if(d===59&&s){const y=e.exit("characterReferenceValue");return o===it&&!zi(r.sliceSerialize(y))?t(d):(e.enter("characterReferenceMarker"),e.consume(d),e.exit("characterReferenceMarker"),e.exit("characterReference"),n)}return o(d)&&s++<a?(e.consume(d),m):t(d)}}const ds={partial:!0,tokenize:Xc},ps={concrete:!0,name:"codeFenced",tokenize:Kc};function Kc(e,n,t){const r=this,s={partial:!0,tokenize:F};let a=0,o=0,l;return c;function c(j){return u(j)}function u(j){const Z=r.events[r.events.length-1];return a=Z&&Z[1].type==="linePrefix"?Z[2].sliceSerialize(Z[1],!0).length:0,l=j,e.enter("codeFenced"),e.enter("codeFencedFence"),e.enter("codeFencedFenceSequence"),m(j)}function m(j){return j===l?(o++,e.consume(j),m):o<3?t(j):(e.exit("codeFencedFenceSequence"),Pe(j)?Oe(e,d,"whitespace")(j):d(j))}function d(j){return j===null||ge(j)?(e.exit("codeFencedFence"),r.interrupt?n(j):e.check(ds,q,W)(j)):(e.enter("codeFencedFenceInfo"),e.enter("chunkString",{contentType:"string"}),y(j))}function y(j){return j===null||ge(j)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),d(j)):Pe(j)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),Oe(e,p,"whitespace")(j)):j===96&&j===l?t(j):(e.consume(j),y)}function p(j){return j===null||ge(j)?d(j):(e.enter("codeFencedFenceMeta"),e.enter("chunkString",{contentType:"string"}),A(j))}function A(j){return j===null||ge(j)?(e.exit("chunkString"),e.exit("codeFencedFenceMeta"),d(j)):j===96&&j===l?t(j):(e.consume(j),A)}function q(j){return e.attempt(s,W,K)(j)}function K(j){return e.enter("lineEnding"),e.consume(j),e.exit("lineEnding"),$}function $(j){return a>0&&Pe(j)?Oe(e,H,"linePrefix",a+1)(j):H(j)}function H(j){return j===null||ge(j)?e.check(ds,q,W)(j):(e.enter("codeFlowValue"),L(j))}function L(j){return j===null||ge(j)?(e.exit("codeFlowValue"),H(j)):(e.consume(j),L)}function W(j){return e.exit("codeFenced"),n(j)}function F(j,Z,ce){let ne=0;return le;function le(E){return j.enter("lineEnding"),j.consume(E),j.exit("lineEnding"),V}function V(E){return j.enter("codeFencedFence"),Pe(E)?Oe(j,_,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(E):_(E)}function _(E){return E===l?(j.enter("codeFencedFenceSequence"),C(E)):ce(E)}function C(E){return E===l?(ne++,j.consume(E),C):ne>=o?(j.exit("codeFencedFenceSequence"),Pe(E)?Oe(j,Y,"whitespace")(E):Y(E)):ce(E)}function Y(E){return E===null||ge(E)?(j.exit("codeFencedFence"),Z(E)):ce(E)}}}function Xc(e,n,t){const r=this;return s;function s(o){return o===null?t(o):(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),a)}function a(o){return r.parser.lazy[r.now().line]?t(o):n(o)}}const ai={name:"codeIndented",tokenize:eu},Zc={partial:!0,tokenize:tu};function eu(e,n,t){const r=this;return s;function s(u){return e.enter("codeIndented"),Oe(e,a,"linePrefix",5)(u)}function a(u){const m=r.events[r.events.length-1];return m&&m[1].type==="linePrefix"&&m[2].sliceSerialize(m[1],!0).length>=4?o(u):t(u)}function o(u){return u===null?c(u):ge(u)?e.attempt(Zc,o,c)(u):(e.enter("codeFlowValue"),l(u))}function l(u){return u===null||ge(u)?(e.exit("codeFlowValue"),o(u)):(e.consume(u),l)}function c(u){return e.exit("codeIndented"),n(u)}}function tu(e,n,t){const r=this;return s;function s(o){return r.parser.lazy[r.now().line]?t(o):ge(o)?(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),s):Oe(e,a,"linePrefix",5)(o)}function a(o){const l=r.events[r.events.length-1];return l&&l[1].type==="linePrefix"&&l[2].sliceSerialize(l[1],!0).length>=4?n(o):ge(o)?s(o):t(o)}}const nu={name:"codeText",previous:iu,resolve:ru,tokenize:au};function ru(e){let n=e.length-4,t=3,r,s;if((e[t][1].type==="lineEnding"||e[t][1].type==="space")&&(e[n][1].type==="lineEnding"||e[n][1].type==="space")){for(r=t;++r<n;)if(e[r][1].type==="codeTextData"){e[t][1].type="codeTextPadding",e[n][1].type="codeTextPadding",t+=2,n-=2;break}}for(r=t-1,n++;++r<=n;)s===void 0?r!==n&&e[r][1].type!=="lineEnding"&&(s=r):(r===n||e[r][1].type==="lineEnding")&&(e[s][1].type="codeTextData",r!==s+2&&(e[s][1].end=e[r-1][1].end,e.splice(s+2,r-s-2),n-=r-s-2,r=s+2),s=void 0);return e}function iu(e){return e!==96||this.events[this.events.length-1][1].type==="characterEscape"}function au(e,n,t){let r=0,s,a;return o;function o(d){return e.enter("codeText"),e.enter("codeTextSequence"),l(d)}function l(d){return d===96?(e.consume(d),r++,l):(e.exit("codeTextSequence"),c(d))}function c(d){return d===null?t(d):d===32?(e.enter("space"),e.consume(d),e.exit("space"),c):d===96?(a=e.enter("codeTextSequence"),s=0,m(d)):ge(d)?(e.enter("lineEnding"),e.consume(d),e.exit("lineEnding"),c):(e.enter("codeTextData"),u(d))}function u(d){return d===null||d===32||d===96||ge(d)?(e.exit("codeTextData"),c(d)):(e.consume(d),u)}function m(d){return d===96?(e.consume(d),s++,m):s===r?(e.exit("codeTextSequence"),e.exit("codeText"),n(d)):(a.type="codeTextData",u(d))}}class su{constructor(n){this.left=n?[...n]:[],this.right=[]}get(n){if(n<0||n>=this.left.length+this.right.length)throw new RangeError("Cannot access index `"+n+"` in a splice buffer of size `"+(this.left.length+this.right.length)+"`");return n<this.left.length?this.left[n]:this.right[this.right.length-n+this.left.length-1]}get length(){return this.left.length+this.right.length}shift(){return this.setCursor(0),this.right.pop()}slice(n,t){const r=t??Number.POSITIVE_INFINITY;return r<this.left.length?this.left.slice(n,r):n>this.left.length?this.right.slice(this.right.length-r+this.left.length,this.right.length-n+this.left.length).reverse():this.left.slice(n).concat(this.right.slice(this.right.length-r+this.left.length).reverse())}splice(n,t,r){const s=t||0;this.setCursor(Math.trunc(n));const a=this.right.splice(this.right.length-s,Number.POSITIVE_INFINITY);return r&&On(this.left,r),a.reverse()}pop(){return this.setCursor(Number.POSITIVE_INFINITY),this.left.pop()}push(n){this.setCursor(Number.POSITIVE_INFINITY),this.left.push(n)}pushMany(n){this.setCursor(Number.POSITIVE_INFINITY),On(this.left,n)}unshift(n){this.setCursor(0),this.right.push(n)}unshiftMany(n){this.setCursor(0),On(this.right,n.reverse())}setCursor(n){if(!(n===this.left.length||n>this.left.length&&this.right.length===0||n<0&&this.left.length===0))if(n<this.left.length){const t=this.left.splice(n,Number.POSITIVE_INFINITY);On(this.right,t.reverse())}else{const t=this.right.splice(this.left.length+this.right.length-n,Number.POSITIVE_INFINITY);On(this.left,t.reverse())}}}function On(e,n){let t=0;if(n.length<1e4)e.push(...n);else for(;t<n.length;)e.push(...n.slice(t,t+1e4)),t+=1e4}function co(e){const n={};let t=-1,r,s,a,o,l,c,u;const m=new su(e);for(;++t<m.length;){for(;t in n;)t=n[t];if(r=m.get(t),t&&r[1].type==="chunkFlow"&&m.get(t-1)[1].type==="listItemPrefix"&&(c=r[1]._tokenizer.events,a=0,a<c.length&&c[a][1].type==="lineEndingBlank"&&(a+=2),a<c.length&&c[a][1].type==="content"))for(;++a<c.length&&c[a][1].type!=="content";)c[a][1].type==="chunkText"&&(c[a][1]._isInFirstContentOfListItem=!0,a++);if(r[0]==="enter")r[1].contentType&&(Object.assign(n,ou(m,t)),t=n[t],u=!0);else if(r[1]._container){for(a=t,s=void 0;a--;)if(o=m.get(a),o[1].type==="lineEnding"||o[1].type==="lineEndingBlank")o[0]==="enter"&&(s&&(m.get(s)[1].type="lineEndingBlank"),o[1].type="lineEnding",s=a);else if(!(o[1].type==="linePrefix"||o[1].type==="listItemIndent"))break;s&&(r[1].end={...m.get(s)[1].start},l=m.slice(s,t),l.unshift(r),m.splice(s,t-s+1,l))}}return _t(e,0,Number.POSITIVE_INFINITY,m.slice(0)),!u}function ou(e,n){const t=e.get(n)[1],r=e.get(n)[2];let s=n-1;const a=[];let o=t._tokenizer;o||(o=r.parser[t.contentType](t.start),t._contentTypeTextTrailing&&(o._contentTypeTextTrailing=!0));const l=o.events,c=[],u={};let m,d,y=-1,p=t,A=0,q=0;const K=[q];for(;p;){for(;e.get(++s)[1]!==p;);a.push(s),p._tokenizer||(m=r.sliceStream(p),p.next||m.push(null),d&&o.defineSkip(p.start),p._isInFirstContentOfListItem&&(o._gfmTasklistFirstContentOfListItem=!0),o.write(m),p._isInFirstContentOfListItem&&(o._gfmTasklistFirstContentOfListItem=void 0)),d=p,p=p.next}for(p=t;++y<l.length;)l[y][0]==="exit"&&l[y-1][0]==="enter"&&l[y][1].type===l[y-1][1].type&&l[y][1].start.line!==l[y][1].end.line&&(q=y+1,K.push(q),p._tokenizer=void 0,p.previous=void 0,p=p.next);for(o.events=[],p?(p._tokenizer=void 0,p.previous=void 0):K.pop(),y=K.length;y--;){const $=l.slice(K[y],K[y+1]),H=a.pop();c.push([H,H+$.length-1]),e.splice(H,2,$)}for(c.reverse(),y=-1;++y<c.length;)u[A+c[y][0]]=A+c[y][1],A+=c[y][1]-c[y][0]-1;return u}const lu={resolve:uu,tokenize:du},cu={partial:!0,tokenize:pu};function uu(e){return co(e),e}function du(e,n){let t;return r;function r(l){return e.enter("content"),t=e.enter("chunkContent",{contentType:"content"}),s(l)}function s(l){return l===null?a(l):ge(l)?e.check(cu,o,a)(l):(e.consume(l),s)}function a(l){return e.exit("chunkContent"),e.exit("content"),n(l)}function o(l){return e.consume(l),e.exit("chunkContent"),t.next=e.enter("chunkContent",{contentType:"content",previous:t}),t=t.next,s}}function pu(e,n,t){const r=this;return s;function s(o){return e.exit("chunkContent"),e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),Oe(e,a,"linePrefix")}function a(o){if(o===null||ge(o))return t(o);const l=r.events[r.events.length-1];return!r.parser.constructs.disable.null.includes("codeIndented")&&l&&l[1].type==="linePrefix"&&l[2].sliceSerialize(l[1],!0).length>=4?n(o):e.interrupt(r.parser.constructs.flow,t,n)(o)}}function uo(e,n,t,r,s,a,o,l,c){const u=c||Number.POSITIVE_INFINITY;let m=0;return d;function d($){return $===60?(e.enter(r),e.enter(s),e.enter(a),e.consume($),e.exit(a),y):$===null||$===32||$===41||ji($)?t($):(e.enter(r),e.enter(o),e.enter(l),e.enter("chunkString",{contentType:"string"}),q($))}function y($){return $===62?(e.enter(a),e.consume($),e.exit(a),e.exit(s),e.exit(r),n):(e.enter(l),e.enter("chunkString",{contentType:"string"}),p($))}function p($){return $===62?(e.exit("chunkString"),e.exit(l),y($)):$===null||$===60||ge($)?t($):(e.consume($),$===92?A:p)}function A($){return $===60||$===62||$===92?(e.consume($),p):p($)}function q($){return!m&&($===null||$===41||Ke($))?(e.exit("chunkString"),e.exit(l),e.exit(o),e.exit(r),n($)):m<u&&$===40?(e.consume($),m++,q):$===41?(e.consume($),m--,q):$===null||$===32||$===40||ji($)?t($):(e.consume($),$===92?K:q)}function K($){return $===40||$===41||$===92?(e.consume($),q):q($)}}function po(e,n,t,r,s,a){const o=this;let l=0,c;return u;function u(p){return e.enter(r),e.enter(s),e.consume(p),e.exit(s),e.enter(a),m}function m(p){return l>999||p===null||p===91||p===93&&!c||p===94&&!l&&"_hiddenFootnoteSupport"in o.parser.constructs?t(p):p===93?(e.exit(a),e.enter(s),e.consume(p),e.exit(s),e.exit(r),n):ge(p)?(e.enter("lineEnding"),e.consume(p),e.exit("lineEnding"),m):(e.enter("chunkString",{contentType:"string"}),d(p))}function d(p){return p===null||p===91||p===93||ge(p)||l++>999?(e.exit("chunkString"),m(p)):(e.consume(p),c||(c=!Pe(p)),p===92?y:d)}function y(p){return p===91||p===92||p===93?(e.consume(p),l++,d):d(p)}}function ho(e,n,t,r,s,a){let o;return l;function l(y){return y===34||y===39||y===40?(e.enter(r),e.enter(s),e.consume(y),e.exit(s),o=y===40?41:y,c):t(y)}function c(y){return y===o?(e.enter(s),e.consume(y),e.exit(s),e.exit(r),n):(e.enter(a),u(y))}function u(y){return y===o?(e.exit(a),c(o)):y===null?t(y):ge(y)?(e.enter("lineEnding"),e.consume(y),e.exit("lineEnding"),Oe(e,u,"linePrefix")):(e.enter("chunkString",{contentType:"string"}),m(y))}function m(y){return y===o||y===null||ge(y)?(e.exit("chunkString"),u(y)):(e.consume(y),y===92?d:m)}function d(y){return y===o||y===92?(e.consume(y),m):m(y)}}function Rn(e,n){let t;return r;function r(s){return ge(s)?(e.enter("lineEnding"),e.consume(s),e.exit("lineEnding"),t=!0,r):Pe(s)?Oe(e,r,t?"linePrefix":"lineSuffix")(s):n(s)}}const hu={name:"definition",tokenize:fu},mu={partial:!0,tokenize:gu};function fu(e,n,t){const r=this;let s;return a;function a(p){return e.enter("definition"),o(p)}function o(p){return po.call(r,e,l,t,"definitionLabel","definitionLabelMarker","definitionLabelString")(p)}function l(p){return s=pn(r.sliceSerialize(r.events[r.events.length-1][1]).slice(1,-1)),p===58?(e.enter("definitionMarker"),e.consume(p),e.exit("definitionMarker"),c):t(p)}function c(p){return Ke(p)?Rn(e,u)(p):u(p)}function u(p){return uo(e,m,t,"definitionDestination","definitionDestinationLiteral","definitionDestinationLiteralMarker","definitionDestinationRaw","definitionDestinationString")(p)}function m(p){return e.attempt(mu,d,d)(p)}function d(p){return Pe(p)?Oe(e,y,"whitespace")(p):y(p)}function y(p){return p===null||ge(p)?(e.exit("definition"),r.parser.defined.push(s),n(p)):t(p)}}function gu(e,n,t){return r;function r(l){return Ke(l)?Rn(e,s)(l):t(l)}function s(l){return ho(e,a,t,"definitionTitle","definitionTitleMarker","definitionTitleString")(l)}function a(l){return Pe(l)?Oe(e,o,"whitespace")(l):o(l)}function o(l){return l===null||ge(l)?n(l):t(l)}}const yu={name:"hardBreakEscape",tokenize:xu};function xu(e,n,t){return r;function r(a){return e.enter("hardBreakEscape"),e.consume(a),s}function s(a){return ge(a)?(e.exit("hardBreakEscape"),n(a)):t(a)}}const bu={name:"headingAtx",resolve:wu,tokenize:ku};function wu(e,n){let t=e.length-2,r=3,s,a;return e[r][1].type==="whitespace"&&(r+=2),t-2>r&&e[t][1].type==="whitespace"&&(t-=2),e[t][1].type==="atxHeadingSequence"&&(r===t-1||t-4>r&&e[t-2][1].type==="whitespace")&&(t-=r+1===t?2:4),t>r&&(s={type:"atxHeadingText",start:e[r][1].start,end:e[t][1].end},a={type:"chunkText",start:e[r][1].start,end:e[t][1].end,contentType:"text"},_t(e,r,t-r+1,[["enter",s,n],["enter",a,n],["exit",a,n],["exit",s,n]])),e}function ku(e,n,t){let r=0;return s;function s(m){return e.enter("atxHeading"),a(m)}function a(m){return e.enter("atxHeadingSequence"),o(m)}function o(m){return m===35&&r++<6?(e.consume(m),o):m===null||Ke(m)?(e.exit("atxHeadingSequence"),l(m)):t(m)}function l(m){return m===35?(e.enter("atxHeadingSequence"),c(m)):m===null||ge(m)?(e.exit("atxHeading"),n(m)):Pe(m)?Oe(e,l,"whitespace")(m):(e.enter("atxHeadingText"),u(m))}function c(m){return m===35?(e.consume(m),c):(e.exit("atxHeadingSequence"),l(m))}function u(m){return m===null||m===35||Ke(m)?(e.exit("atxHeadingText"),l(m)):(e.consume(m),u)}}const _u=["address","article","aside","base","basefont","blockquote","body","caption","center","col","colgroup","dd","details","dialog","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hr","html","iframe","legend","li","link","main","menu","menuitem","nav","noframes","ol","optgroup","option","p","param","search","section","summary","table","tbody","td","tfoot","th","thead","title","tr","track","ul"],hs=["pre","script","style","textarea"],Nu={concrete:!0,name:"htmlFlow",resolveTo:Cu,tokenize:Su},vu={partial:!0,tokenize:Pu},ju={partial:!0,tokenize:Tu};function Cu(e){let n=e.length;for(;n--&&!(e[n][0]==="enter"&&e[n][1].type==="htmlFlow"););return n>1&&e[n-2][1].type==="linePrefix"&&(e[n][1].start=e[n-2][1].start,e[n+1][1].start=e[n-2][1].start,e.splice(n-2,2)),e}function Su(e,n,t){const r=this;let s,a,o,l,c;return u;function u(x){return m(x)}function m(x){return e.enter("htmlFlow"),e.enter("htmlFlowData"),e.consume(x),d}function d(x){return x===33?(e.consume(x),y):x===47?(e.consume(x),a=!0,q):x===63?(e.consume(x),s=3,r.interrupt?n:w):kt(x)?(e.consume(x),o=String.fromCharCode(x),K):t(x)}function y(x){return x===45?(e.consume(x),s=2,p):x===91?(e.consume(x),s=5,l=0,A):kt(x)?(e.consume(x),s=4,r.interrupt?n:w):t(x)}function p(x){return x===45?(e.consume(x),r.interrupt?n:w):t(x)}function A(x){const De="CDATA[";return x===De.charCodeAt(l++)?(e.consume(x),l===De.length?r.interrupt?n:_:A):t(x)}function q(x){return kt(x)?(e.consume(x),o=String.fromCharCode(x),K):t(x)}function K(x){if(x===null||x===47||x===62||Ke(x)){const De=x===47,He=o.toLowerCase();return!De&&!a&&hs.includes(He)?(s=1,r.interrupt?n(x):_(x)):_u.includes(o.toLowerCase())?(s=6,De?(e.consume(x),$):r.interrupt?n(x):_(x)):(s=7,r.interrupt&&!r.parser.lazy[r.now().line]?t(x):a?H(x):L(x))}return x===45||it(x)?(e.consume(x),o+=String.fromCharCode(x),K):t(x)}function $(x){return x===62?(e.consume(x),r.interrupt?n:_):t(x)}function H(x){return Pe(x)?(e.consume(x),H):le(x)}function L(x){return x===47?(e.consume(x),le):x===58||x===95||kt(x)?(e.consume(x),W):Pe(x)?(e.consume(x),L):le(x)}function W(x){return x===45||x===46||x===58||x===95||it(x)?(e.consume(x),W):F(x)}function F(x){return x===61?(e.consume(x),j):Pe(x)?(e.consume(x),F):L(x)}function j(x){return x===null||x===60||x===61||x===62||x===96?t(x):x===34||x===39?(e.consume(x),c=x,Z):Pe(x)?(e.consume(x),j):ce(x)}function Z(x){return x===c?(e.consume(x),c=null,ne):x===null||ge(x)?t(x):(e.consume(x),Z)}function ce(x){return x===null||x===34||x===39||x===47||x===60||x===61||x===62||x===96||Ke(x)?F(x):(e.consume(x),ce)}function ne(x){return x===47||x===62||Pe(x)?L(x):t(x)}function le(x){return x===62?(e.consume(x),V):t(x)}function V(x){return x===null||ge(x)?_(x):Pe(x)?(e.consume(x),V):t(x)}function _(x){return x===45&&s===2?(e.consume(x),U):x===60&&s===1?(e.consume(x),J):x===62&&s===4?(e.consume(x),Fe):x===63&&s===3?(e.consume(x),w):x===93&&s===5?(e.consume(x),pe):ge(x)&&(s===6||s===7)?(e.exit("htmlFlowData"),e.check(vu,we,C)(x)):x===null||ge(x)?(e.exit("htmlFlowData"),C(x)):(e.consume(x),_)}function C(x){return e.check(ju,Y,we)(x)}function Y(x){return e.enter("lineEnding"),e.consume(x),e.exit("lineEnding"),E}function E(x){return x===null||ge(x)?C(x):(e.enter("htmlFlowData"),_(x))}function U(x){return x===45?(e.consume(x),w):_(x)}function J(x){return x===47?(e.consume(x),o="",Se):_(x)}function Se(x){if(x===62){const De=o.toLowerCase();return hs.includes(De)?(e.consume(x),Fe):_(x)}return kt(x)&&o.length<8?(e.consume(x),o+=String.fromCharCode(x),Se):_(x)}function pe(x){return x===93?(e.consume(x),w):_(x)}function w(x){return x===62?(e.consume(x),Fe):x===45&&s===2?(e.consume(x),w):_(x)}function Fe(x){return x===null||ge(x)?(e.exit("htmlFlowData"),we(x)):(e.consume(x),Fe)}function we(x){return e.exit("htmlFlow"),n(x)}}function Tu(e,n,t){const r=this;return s;function s(o){return ge(o)?(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),a):t(o)}function a(o){return r.parser.lazy[r.now().line]?t(o):n(o)}}function Pu(e,n,t){return r;function r(s){return e.enter("lineEnding"),e.consume(s),e.exit("lineEnding"),e.attempt(xr,n,t)}}const Eu={name:"htmlText",tokenize:Au};function Au(e,n,t){const r=this;let s,a,o;return l;function l(w){return e.enter("htmlText"),e.enter("htmlTextData"),e.consume(w),c}function c(w){return w===33?(e.consume(w),u):w===47?(e.consume(w),F):w===63?(e.consume(w),L):kt(w)?(e.consume(w),ce):t(w)}function u(w){return w===45?(e.consume(w),m):w===91?(e.consume(w),a=0,A):kt(w)?(e.consume(w),H):t(w)}function m(w){return w===45?(e.consume(w),p):t(w)}function d(w){return w===null?t(w):w===45?(e.consume(w),y):ge(w)?(o=d,J(w)):(e.consume(w),d)}function y(w){return w===45?(e.consume(w),p):d(w)}function p(w){return w===62?U(w):w===45?y(w):d(w)}function A(w){const Fe="CDATA[";return w===Fe.charCodeAt(a++)?(e.consume(w),a===Fe.length?q:A):t(w)}function q(w){return w===null?t(w):w===93?(e.consume(w),K):ge(w)?(o=q,J(w)):(e.consume(w),q)}function K(w){return w===93?(e.consume(w),$):q(w)}function $(w){return w===62?U(w):w===93?(e.consume(w),$):q(w)}function H(w){return w===null||w===62?U(w):ge(w)?(o=H,J(w)):(e.consume(w),H)}function L(w){return w===null?t(w):w===63?(e.consume(w),W):ge(w)?(o=L,J(w)):(e.consume(w),L)}function W(w){return w===62?U(w):L(w)}function F(w){return kt(w)?(e.consume(w),j):t(w)}function j(w){return w===45||it(w)?(e.consume(w),j):Z(w)}function Z(w){return ge(w)?(o=Z,J(w)):Pe(w)?(e.consume(w),Z):U(w)}function ce(w){return w===45||it(w)?(e.consume(w),ce):w===47||w===62||Ke(w)?ne(w):t(w)}function ne(w){return w===47?(e.consume(w),U):w===58||w===95||kt(w)?(e.consume(w),le):ge(w)?(o=ne,J(w)):Pe(w)?(e.consume(w),ne):U(w)}function le(w){return w===45||w===46||w===58||w===95||it(w)?(e.consume(w),le):V(w)}function V(w){return w===61?(e.consume(w),_):ge(w)?(o=V,J(w)):Pe(w)?(e.consume(w),V):ne(w)}function _(w){return w===null||w===60||w===61||w===62||w===96?t(w):w===34||w===39?(e.consume(w),s=w,C):ge(w)?(o=_,J(w)):Pe(w)?(e.consume(w),_):(e.consume(w),Y)}function C(w){return w===s?(e.consume(w),s=void 0,E):w===null?t(w):ge(w)?(o=C,J(w)):(e.consume(w),C)}function Y(w){return w===null||w===34||w===39||w===60||w===61||w===96?t(w):w===47||w===62||Ke(w)?ne(w):(e.consume(w),Y)}function E(w){return w===47||w===62||Ke(w)?ne(w):t(w)}function U(w){return w===62?(e.consume(w),e.exit("htmlTextData"),e.exit("htmlText"),n):t(w)}function J(w){return e.exit("htmlTextData"),e.enter("lineEnding"),e.consume(w),e.exit("lineEnding"),Se}function Se(w){return Pe(w)?Oe(e,pe,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(w):pe(w)}function pe(w){return e.enter("htmlTextData"),o(w)}}const Bi={name:"labelEnd",resolveAll:$u,resolveTo:Lu,tokenize:Ru},Du={tokenize:Fu},Iu={tokenize:zu},Ou={tokenize:qu};function $u(e){let n=-1;const t=[];for(;++n<e.length;){const r=e[n][1];if(t.push(e[n]),r.type==="labelImage"||r.type==="labelLink"||r.type==="labelEnd"){const s=r.type==="labelImage"?4:2;r.type="data",n+=s}}return e.length!==t.length&&_t(e,0,e.length,t),e}function Lu(e,n){let t=e.length,r=0,s,a,o,l;for(;t--;)if(s=e[t][1],a){if(s.type==="link"||s.type==="labelLink"&&s._inactive)break;e[t][0]==="enter"&&s.type==="labelLink"&&(s._inactive=!0)}else if(o){if(e[t][0]==="enter"&&(s.type==="labelImage"||s.type==="labelLink")&&!s._balanced&&(a=t,s.type!=="labelLink")){r=2;break}}else s.type==="labelEnd"&&(o=t);const c={type:e[a][1].type==="labelLink"?"link":"image",start:{...e[a][1].start},end:{...e[e.length-1][1].end}},u={type:"label",start:{...e[a][1].start},end:{...e[o][1].end}},m={type:"labelText",start:{...e[a+r+2][1].end},end:{...e[o-2][1].start}};return l=[["enter",c,n],["enter",u,n]],l=ut(l,e.slice(a+1,a+r+3)),l=ut(l,[["enter",m,n]]),l=ut(l,qi(n.parser.constructs.insideSpan.null,e.slice(a+r+4,o-3),n)),l=ut(l,[["exit",m,n],e[o-2],e[o-1],["exit",u,n]]),l=ut(l,e.slice(o+1)),l=ut(l,[["exit",c,n]]),_t(e,a,e.length,l),e}function Ru(e,n,t){const r=this;let s=r.events.length,a,o;for(;s--;)if((r.events[s][1].type==="labelImage"||r.events[s][1].type==="labelLink")&&!r.events[s][1]._balanced){a=r.events[s][1];break}return l;function l(y){return a?a._inactive?d(y):(o=r.parser.defined.includes(pn(r.sliceSerialize({start:a.end,end:r.now()}))),e.enter("labelEnd"),e.enter("labelMarker"),e.consume(y),e.exit("labelMarker"),e.exit("labelEnd"),c):t(y)}function c(y){return y===40?e.attempt(Du,m,o?m:d)(y):y===91?e.attempt(Iu,m,o?u:d)(y):o?m(y):d(y)}function u(y){return e.attempt(Ou,m,d)(y)}function m(y){return n(y)}function d(y){return a._balanced=!0,t(y)}}function Fu(e,n,t){return r;function r(d){return e.enter("resource"),e.enter("resourceMarker"),e.consume(d),e.exit("resourceMarker"),s}function s(d){return Ke(d)?Rn(e,a)(d):a(d)}function a(d){return d===41?m(d):uo(e,o,l,"resourceDestination","resourceDestinationLiteral","resourceDestinationLiteralMarker","resourceDestinationRaw","resourceDestinationString",32)(d)}function o(d){return Ke(d)?Rn(e,c)(d):m(d)}function l(d){return t(d)}function c(d){return d===34||d===39||d===40?ho(e,u,t,"resourceTitle","resourceTitleMarker","resourceTitleString")(d):m(d)}function u(d){return Ke(d)?Rn(e,m)(d):m(d)}function m(d){return d===41?(e.enter("resourceMarker"),e.consume(d),e.exit("resourceMarker"),e.exit("resource"),n):t(d)}}function zu(e,n,t){const r=this;return s;function s(l){return po.call(r,e,a,o,"reference","referenceMarker","referenceString")(l)}function a(l){return r.parser.defined.includes(pn(r.sliceSerialize(r.events[r.events.length-1][1]).slice(1,-1)))?n(l):t(l)}function o(l){return t(l)}}function qu(e,n,t){return r;function r(a){return e.enter("reference"),e.enter("referenceMarker"),e.consume(a),e.exit("referenceMarker"),s}function s(a){return a===93?(e.enter("referenceMarker"),e.consume(a),e.exit("referenceMarker"),e.exit("reference"),n):t(a)}}const Bu={name:"labelStartImage",resolveAll:Bi.resolveAll,tokenize:Uu};function Uu(e,n,t){const r=this;return s;function s(l){return e.enter("labelImage"),e.enter("labelImageMarker"),e.consume(l),e.exit("labelImageMarker"),a}function a(l){return l===91?(e.enter("labelMarker"),e.consume(l),e.exit("labelMarker"),e.exit("labelImage"),o):t(l)}function o(l){return l===94&&"_hiddenFootnoteSupport"in r.parser.constructs?t(l):n(l)}}const Mu={name:"labelStartLink",resolveAll:Bi.resolveAll,tokenize:Hu};function Hu(e,n,t){const r=this;return s;function s(o){return e.enter("labelLink"),e.enter("labelMarker"),e.consume(o),e.exit("labelMarker"),e.exit("labelLink"),a}function a(o){return o===94&&"_hiddenFootnoteSupport"in r.parser.constructs?t(o):n(o)}}const si={name:"lineEnding",tokenize:Wu};function Wu(e,n){return t;function t(r){return e.enter("lineEnding"),e.consume(r),e.exit("lineEnding"),Oe(e,n,"linePrefix")}}const hr={name:"thematicBreak",tokenize:Vu};function Vu(e,n,t){let r=0,s;return a;function a(u){return e.enter("thematicBreak"),o(u)}function o(u){return s=u,l(u)}function l(u){return u===s?(e.enter("thematicBreakSequence"),c(u)):r>=3&&(u===null||ge(u))?(e.exit("thematicBreak"),n(u)):t(u)}function c(u){return u===s?(e.consume(u),r++,c):(e.exit("thematicBreakSequence"),Pe(u)?Oe(e,l,"whitespace")(u):l(u))}}const Ye={continuation:{tokenize:Yu},exit:Xu,name:"list",tokenize:Gu},Ju={partial:!0,tokenize:Zu},Qu={partial:!0,tokenize:Ku};function Gu(e,n,t){const r=this,s=r.events[r.events.length-1];let a=s&&s[1].type==="linePrefix"?s[2].sliceSerialize(s[1],!0).length:0,o=0;return l;function l(p){const A=r.containerState.type||(p===42||p===43||p===45?"listUnordered":"listOrdered");if(A==="listUnordered"?!r.containerState.marker||p===r.containerState.marker:Ci(p)){if(r.containerState.type||(r.containerState.type=A,e.enter(A,{_container:!0})),A==="listUnordered")return e.enter("listItemPrefix"),p===42||p===45?e.check(hr,t,u)(p):u(p);if(!r.interrupt||p===49)return e.enter("listItemPrefix"),e.enter("listItemValue"),c(p)}return t(p)}function c(p){return Ci(p)&&++o<10?(e.consume(p),c):(!r.interrupt||o<2)&&(r.containerState.marker?p===r.containerState.marker:p===41||p===46)?(e.exit("listItemValue"),u(p)):t(p)}function u(p){return e.enter("listItemMarker"),e.consume(p),e.exit("listItemMarker"),r.containerState.marker=r.containerState.marker||p,e.check(xr,r.interrupt?t:m,e.attempt(Ju,y,d))}function m(p){return r.containerState.initialBlankLine=!0,a++,y(p)}function d(p){return Pe(p)?(e.enter("listItemPrefixWhitespace"),e.consume(p),e.exit("listItemPrefixWhitespace"),y):t(p)}function y(p){return r.containerState.size=a+r.sliceSerialize(e.exit("listItemPrefix"),!0).length,n(p)}}function Yu(e,n,t){const r=this;return r.containerState._closeFlow=void 0,e.check(xr,s,a);function s(l){return r.containerState.furtherBlankLines=r.containerState.furtherBlankLines||r.containerState.initialBlankLine,Oe(e,n,"listItemIndent",r.containerState.size+1)(l)}function a(l){return r.containerState.furtherBlankLines||!Pe(l)?(r.containerState.furtherBlankLines=void 0,r.containerState.initialBlankLine=void 0,o(l)):(r.containerState.furtherBlankLines=void 0,r.containerState.initialBlankLine=void 0,e.attempt(Qu,n,o)(l))}function o(l){return r.containerState._closeFlow=!0,r.interrupt=void 0,Oe(e,e.attempt(Ye,n,t),"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(l)}}function Ku(e,n,t){const r=this;return Oe(e,s,"listItemIndent",r.containerState.size+1);function s(a){const o=r.events[r.events.length-1];return o&&o[1].type==="listItemIndent"&&o[2].sliceSerialize(o[1],!0).length===r.containerState.size?n(a):t(a)}}function Xu(e){e.exit(this.containerState.type)}function Zu(e,n,t){const r=this;return Oe(e,s,"listItemPrefixWhitespace",r.parser.constructs.disable.null.includes("codeIndented")?void 0:5);function s(a){const o=r.events[r.events.length-1];return!Pe(a)&&o&&o[1].type==="listItemPrefixWhitespace"?n(a):t(a)}}const ms={name:"setextUnderline",resolveTo:ed,tokenize:td};function ed(e,n){let t=e.length,r,s,a;for(;t--;)if(e[t][0]==="enter"){if(e[t][1].type==="content"){r=t;break}e[t][1].type==="paragraph"&&(s=t)}else e[t][1].type==="content"&&e.splice(t,1),!a&&e[t][1].type==="definition"&&(a=t);const o={type:"setextHeading",start:{...e[r][1].start},end:{...e[e.length-1][1].end}};return e[s][1].type="setextHeadingText",a?(e.splice(s,0,["enter",o,n]),e.splice(a+1,0,["exit",e[r][1],n]),e[r][1].end={...e[a][1].end}):e[r][1]=o,e.push(["exit",o,n]),e}function td(e,n,t){const r=this;let s;return a;function a(u){let m=r.events.length,d;for(;m--;)if(r.events[m][1].type!=="lineEnding"&&r.events[m][1].type!=="linePrefix"&&r.events[m][1].type!=="content"){d=r.events[m][1].type==="paragraph";break}return!r.parser.lazy[r.now().line]&&(r.interrupt||d)?(e.enter("setextHeadingLine"),s=u,o(u)):t(u)}function o(u){return e.enter("setextHeadingLineSequence"),l(u)}function l(u){return u===s?(e.consume(u),l):(e.exit("setextHeadingLineSequence"),Pe(u)?Oe(e,c,"lineSuffix")(u):c(u))}function c(u){return u===null||ge(u)?(e.exit("setextHeadingLine"),n(u)):t(u)}}const nd={tokenize:rd};function rd(e){const n=this,t=e.attempt(xr,r,e.attempt(this.parser.constructs.flowInitial,s,Oe(e,e.attempt(this.parser.constructs.flow,s,e.attempt(lu,s)),"linePrefix")));return t;function r(a){if(a===null){e.consume(a);return}return e.enter("lineEndingBlank"),e.consume(a),e.exit("lineEndingBlank"),n.currentConstruct=void 0,t}function s(a){if(a===null){e.consume(a);return}return e.enter("lineEnding"),e.consume(a),e.exit("lineEnding"),n.currentConstruct=void 0,t}}const id={resolveAll:fo()},ad=mo("string"),sd=mo("text");function mo(e){return{resolveAll:fo(e==="text"?od:void 0),tokenize:n};function n(t){const r=this,s=this.parser.constructs[e],a=t.attempt(s,o,l);return o;function o(m){return u(m)?a(m):l(m)}function l(m){if(m===null){t.consume(m);return}return t.enter("data"),t.consume(m),c}function c(m){return u(m)?(t.exit("data"),a(m)):(t.consume(m),c)}function u(m){if(m===null)return!0;const d=s[m];let y=-1;if(d)for(;++y<d.length;){const p=d[y];if(!p.previous||p.previous.call(r,r.previous))return!0}return!1}}}function fo(e){return n;function n(t,r){let s=-1,a;for(;++s<=t.length;)a===void 0?t[s]&&t[s][1].type==="data"&&(a=s,s++):(!t[s]||t[s][1].type!=="data")&&(s!==a+2&&(t[a][1].end=t[s-1][1].end,t.splice(a+2,s-a-2),s=a+2),a=void 0);return e?e(t,r):t}}function od(e,n){let t=0;for(;++t<=e.length;)if((t===e.length||e[t][1].type==="lineEnding")&&e[t-1][1].type==="data"){const r=e[t-1][1],s=n.sliceStream(r);let a=s.length,o=-1,l=0,c;for(;a--;){const u=s[a];if(typeof u=="string"){for(o=u.length;u.charCodeAt(o-1)===32;)l++,o--;if(o)break;o=-1}else if(u===-2)c=!0,l++;else if(u!==-1){a++;break}}if(n._contentTypeTextTrailing&&t===e.length&&(l=0),l){const u={type:t===e.length||c||l<2?"lineSuffix":"hardBreakTrailing",start:{_bufferIndex:a?o:r.start._bufferIndex+o,_index:r.start._index+a,line:r.end.line,column:r.end.column-l,offset:r.end.offset-l},end:{...r.end}};r.end={...u.start},r.start.offset===r.end.offset?Object.assign(r,u):(e.splice(t,0,["enter",u,n],["exit",u,n]),t+=2)}t++}return e}const ld={42:Ye,43:Ye,45:Ye,48:Ye,49:Ye,50:Ye,51:Ye,52:Ye,53:Ye,54:Ye,55:Ye,56:Ye,57:Ye,62:so},cd={91:hu},ud={[-2]:ai,[-1]:ai,32:ai},dd={35:bu,42:hr,45:[ms,hr],60:Nu,61:ms,95:hr,96:ps,126:ps},pd={38:lo,92:oo},hd={[-5]:si,[-4]:si,[-3]:si,33:Bu,38:lo,42:Si,60:[Mc,Eu],91:Mu,92:[yu,oo],93:Bi,95:Si,96:nu},md={null:[Si,id]},fd={null:[42,95]},gd={null:[]},yd=Object.freeze(Object.defineProperty({__proto__:null,attentionMarkers:fd,contentInitial:cd,disable:gd,document:ld,flow:dd,flowInitial:ud,insideSpan:md,string:pd,text:hd},Symbol.toStringTag,{value:"Module"}));function xd(e,n,t){let r={_bufferIndex:-1,_index:0,line:t&&t.line||1,column:t&&t.column||1,offset:t&&t.offset||0};const s={},a=[];let o=[],l=[];const c={attempt:Z(F),check:Z(j),consume:H,enter:L,exit:W,interrupt:Z(j,{interrupt:!0})},u={code:null,containerState:{},defineSkip:q,events:[],now:A,parser:e,previous:null,sliceSerialize:y,sliceStream:p,write:d};let m=n.tokenize.call(u,c);return n.resolveAll&&a.push(n),u;function d(V){return o=ut(o,V),K(),o[o.length-1]!==null?[]:(ce(n,0),u.events=qi(a,u.events,u),u.events)}function y(V,_){return wd(p(V),_)}function p(V){return bd(o,V)}function A(){const{_bufferIndex:V,_index:_,line:C,column:Y,offset:E}=r;return{_bufferIndex:V,_index:_,line:C,column:Y,offset:E}}function q(V){s[V.line]=V.column,le()}function K(){let V;for(;r._index<o.length;){const _=o[r._index];if(typeof _=="string")for(V=r._index,r._bufferIndex<0&&(r._bufferIndex=0);r._index===V&&r._bufferIndex<_.length;)$(_.charCodeAt(r._bufferIndex));else $(_)}}function $(V){m=m(V)}function H(V){ge(V)?(r.line++,r.column=1,r.offset+=V===-3?2:1,le()):V!==-1&&(r.column++,r.offset++),r._bufferIndex<0?r._index++:(r._bufferIndex++,r._bufferIndex===o[r._index].length&&(r._bufferIndex=-1,r._index++)),u.previous=V}function L(V,_){const C=_||{};return C.type=V,C.start=A(),u.events.push(["enter",C,u]),l.push(C),C}function W(V){const _=l.pop();return _.end=A(),u.events.push(["exit",_,u]),_}function F(V,_){ce(V,_.from)}function j(V,_){_.restore()}function Z(V,_){return C;function C(Y,E,U){let J,Se,pe,w;return Array.isArray(Y)?we(Y):"tokenize"in Y?we([Y]):Fe(Y);function Fe(ke){return at;function at(Re){const et=Re!==null&&ke[Re],st=Re!==null&&ke.null,tt=[...Array.isArray(et)?et:et?[et]:[],...Array.isArray(st)?st:st?[st]:[]];return we(tt)(Re)}}function we(ke){return J=ke,Se=0,ke.length===0?U:x(ke[Se])}function x(ke){return at;function at(Re){return w=ne(),pe=ke,ke.partial||(u.currentConstruct=ke),ke.name&&u.parser.constructs.disable.null.includes(ke.name)?He():ke.tokenize.call(_?Object.assign(Object.create(u),_):u,c,De,He)(Re)}}function De(ke){return V(pe,w),E}function He(ke){return w.restore(),++Se<J.length?x(J[Se]):U}}}function ce(V,_){V.resolveAll&&!a.includes(V)&&a.push(V),V.resolve&&_t(u.events,_,u.events.length-_,V.resolve(u.events.slice(_),u)),V.resolveTo&&(u.events=V.resolveTo(u.events,u))}function ne(){const V=A(),_=u.previous,C=u.currentConstruct,Y=u.events.length,E=Array.from(l);return{from:Y,restore:U};function U(){r=V,u.previous=_,u.currentConstruct=C,u.events.length=Y,l=E,le()}}function le(){r.line in s&&r.column<2&&(r.column=s[r.line],r.offset+=s[r.line]-1)}}function bd(e,n){const t=n.start._index,r=n.start._bufferIndex,s=n.end._index,a=n.end._bufferIndex;let o;if(t===s)o=[e[t].slice(r,a)];else{if(o=e.slice(t,s),r>-1){const l=o[0];typeof l=="string"?o[0]=l.slice(r):o.shift()}a>0&&o.push(e[s].slice(0,a))}return o}function wd(e,n){let t=-1;const r=[];let s;for(;++t<e.length;){const a=e[t];let o;if(typeof a=="string")o=a;else switch(a){case-5:{o="\r";break}case-4:{o=`
`;break}case-3:{o=`\r
`;break}case-2:{o=n?" ":"	";break}case-1:{if(!n&&s)continue;o=" ";break}default:o=String.fromCharCode(a)}s=a===-2,r.push(o)}return r.join("")}function kd(e){const r={constructs:Tc([yd,...(e||{}).extensions||[]]),content:s(Lc),defined:[],document:s(Fc),flow:s(nd),lazy:{},string:s(ad),text:s(sd)};return r;function s(a){return o;function o(l){return xd(r,a,l)}}}function _d(e){for(;!co(e););return e}const fs=/[\0\t\n\r]/g;function Nd(){let e=1,n="",t=!0,r;return s;function s(a,o,l){const c=[];let u,m,d,y,p;for(a=n+(typeof a=="string"?a.toString():new TextDecoder(o||void 0).decode(a)),d=0,n="",t&&(a.charCodeAt(0)===65279&&d++,t=void 0);d<a.length;){if(fs.lastIndex=d,u=fs.exec(a),y=u&&u.index!==void 0?u.index:a.length,p=a.charCodeAt(y),!u){n=a.slice(d);break}if(p===10&&d===y&&r)c.push(-3),r=void 0;else switch(r&&(c.push(-5),r=void 0),d<y&&(c.push(a.slice(d,y)),e+=y-d),p){case 0:{c.push(65533),e++;break}case 9:{for(m=Math.ceil(e/4)*4,c.push(-2);e++<m;)c.push(-1);break}case 10:{c.push(-4),e=1;break}default:r=!0,e=1}d=y+1}return l&&(r&&c.push(-5),n&&c.push(n),c.push(null)),c}}const vd=/\\([!-/:-@[-`{-~])|&(#(?:\d{1,7}|x[\da-f]{1,6})|[\da-z]{1,31});/gi;function go(e){return e.replace(vd,jd)}function jd(e,n,t){if(n)return n;if(t.charCodeAt(0)===35){const s=t.charCodeAt(1),a=s===120||s===88;return ao(t.slice(a?2:1),a?16:10)}return zi(t)||e}function Fn(e){return!e||typeof e!="object"?"":"position"in e||"type"in e?gs(e.position):"start"in e||"end"in e?gs(e):"line"in e||"column"in e?Ti(e):""}function Ti(e){return ys(e&&e.line)+":"+ys(e&&e.column)}function gs(e){return Ti(e&&e.start)+"-"+Ti(e&&e.end)}function ys(e){return e&&typeof e=="number"?e:1}const yo={}.hasOwnProperty;function Cd(e,n,t){return typeof n!="string"&&(t=n,n=void 0),Sd(t)(_d(kd(t).document().write(Nd()(e,n,!0))))}function Sd(e){const n={transforms:[],canContainEols:["emphasis","fragment","heading","paragraph","strong"],enter:{autolink:a(Je),autolinkProtocol:ne,autolinkEmail:ne,atxHeading:a(Nt),blockQuote:a(st),characterEscape:ne,characterReference:ne,codeFenced:a(tt),codeFencedFenceInfo:o,codeFencedFenceMeta:o,codeIndented:a(tt,o),codeText:a(Yt,o),codeTextData:ne,data:ne,codeFlowValue:ne,definition:a(v),definitionDestinationString:o,definitionLabelString:o,definitionTitleString:o,emphasis:a(Dt),hardBreakEscape:a(Kt),hardBreakTrailing:a(Kt),htmlFlow:a(dt,o),htmlFlowData:ne,htmlText:a(dt,o),htmlTextData:ne,image:a(gt),label:o,link:a(Je),listItem:a(Ut),listItemValue:y,listOrdered:a(vt,d),listUnordered:a(vt),paragraph:a(Xt),reference:x,referenceString:o,resourceDestinationString:o,resourceTitleString:o,setextHeading:a(Nt),strong:a(We),thematicBreak:a($e)},exit:{atxHeading:c(),atxHeadingSequence:F,autolink:c(),autolinkEmail:et,autolinkProtocol:Re,blockQuote:c(),characterEscapeValue:le,characterReferenceMarkerHexadecimal:He,characterReferenceMarkerNumeric:He,characterReferenceValue:ke,characterReference:at,codeFenced:c(K),codeFencedFence:q,codeFencedFenceInfo:p,codeFencedFenceMeta:A,codeFlowValue:le,codeIndented:c($),codeText:c(E),codeTextData:le,data:le,definition:c(),definitionDestinationString:W,definitionLabelString:H,definitionTitleString:L,emphasis:c(),hardBreakEscape:c(_),hardBreakTrailing:c(_),htmlFlow:c(C),htmlFlowData:le,htmlText:c(Y),htmlTextData:le,image:c(J),label:pe,labelText:Se,lineEnding:V,link:c(U),listItem:c(),listOrdered:c(),listUnordered:c(),paragraph:c(),referenceString:De,resourceDestinationString:w,resourceTitleString:Fe,resource:we,setextHeading:c(ce),setextHeadingLineSequence:Z,setextHeadingText:j,strong:c(),thematicBreak:c()}};xo(n,(e||{}).mdastExtensions||[]);const t={};return r;function r(T){let P={type:"root",children:[]};const S={stack:[P],tokenStack:[],config:n,enter:l,exit:u,buffer:o,resume:m,data:t},ee=[];let ue=-1;for(;++ue<T.length;)if(T[ue][1].type==="listOrdered"||T[ue][1].type==="listUnordered")if(T[ue][0]==="enter")ee.push(ue);else{const Le=ee.pop();ue=s(T,Le,ue)}for(ue=-1;++ue<T.length;){const Le=n[T[ue][0]];yo.call(Le,T[ue][1].type)&&Le[T[ue][1].type].call(Object.assign({sliceSerialize:T[ue][2].sliceSerialize},S),T[ue][1])}if(S.tokenStack.length>0){const Le=S.tokenStack[S.tokenStack.length-1];(Le[1]||xs).call(S,void 0,Le[0])}for(P.position={start:Ft(T.length>0?T[0][1].start:{line:1,column:1,offset:0}),end:Ft(T.length>0?T[T.length-2][1].end:{line:1,column:1,offset:0})},ue=-1;++ue<n.transforms.length;)P=n.transforms[ue](P)||P;return P}function s(T,P,S){let ee=P-1,ue=-1,Le=!1,Me,ve,Ve,Qe;for(;++ee<=S;){const ze=T[ee];switch(ze[1].type){case"listUnordered":case"listOrdered":case"blockQuote":{ze[0]==="enter"?ue++:ue--,Qe=void 0;break}case"lineEndingBlank":{ze[0]==="enter"&&(Me&&!Qe&&!ue&&!Ve&&(Ve=ee),Qe=void 0);break}case"linePrefix":case"listItemValue":case"listItemMarker":case"listItemPrefix":case"listItemPrefixWhitespace":break;default:Qe=void 0}if(!ue&&ze[0]==="enter"&&ze[1].type==="listItemPrefix"||ue===-1&&ze[0]==="exit"&&(ze[1].type==="listUnordered"||ze[1].type==="listOrdered")){if(Me){let te=ee;for(ve=void 0;te--;){const D=T[te];if(D[1].type==="lineEnding"||D[1].type==="lineEndingBlank"){if(D[0]==="exit")continue;ve&&(T[ve][1].type="lineEndingBlank",Le=!0),D[1].type="lineEnding",ve=te}else if(!(D[1].type==="linePrefix"||D[1].type==="blockQuotePrefix"||D[1].type==="blockQuotePrefixWhitespace"||D[1].type==="blockQuoteMarker"||D[1].type==="listItemIndent"))break}Ve&&(!ve||Ve<ve)&&(Me._spread=!0),Me.end=Object.assign({},ve?T[ve][1].start:ze[1].end),T.splice(ve||ee,0,["exit",Me,ze[2]]),ee++,S++}if(ze[1].type==="listItemPrefix"){const te={type:"listItem",_spread:!1,start:Object.assign({},ze[1].start),end:void 0};Me=te,T.splice(ee,0,["enter",te,ze[2]]),ee++,S++,Ve=void 0,Qe=!0}}}return T[P][1]._spread=Le,S}function a(T,P){return S;function S(ee){l.call(this,T(ee),ee),P&&P.call(this,ee)}}function o(){this.stack.push({type:"fragment",children:[]})}function l(T,P,S){this.stack[this.stack.length-1].children.push(T),this.stack.push(T),this.tokenStack.push([P,S||void 0]),T.position={start:Ft(P.start),end:void 0}}function c(T){return P;function P(S){T&&T.call(this,S),u.call(this,S)}}function u(T,P){const S=this.stack.pop(),ee=this.tokenStack.pop();if(ee)ee[0].type!==T.type&&(P?P.call(this,T,ee[0]):(ee[1]||xs).call(this,T,ee[0]));else throw new Error("Cannot close `"+T.type+"` ("+Fn({start:T.start,end:T.end})+"): it’s not open");S.position.end=Ft(T.end)}function m(){return Fi(this.stack.pop())}function d(){this.data.expectingFirstListItemValue=!0}function y(T){if(this.data.expectingFirstListItemValue){const P=this.stack[this.stack.length-2];P.start=Number.parseInt(this.sliceSerialize(T),10),this.data.expectingFirstListItemValue=void 0}}function p(){const T=this.resume(),P=this.stack[this.stack.length-1];P.lang=T}function A(){const T=this.resume(),P=this.stack[this.stack.length-1];P.meta=T}function q(){this.data.flowCodeInside||(this.buffer(),this.data.flowCodeInside=!0)}function K(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T.replace(/^(\r?\n|\r)|(\r?\n|\r)$/g,""),this.data.flowCodeInside=void 0}function $(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T.replace(/(\r?\n|\r)$/g,"")}function H(T){const P=this.resume(),S=this.stack[this.stack.length-1];S.label=P,S.identifier=pn(this.sliceSerialize(T)).toLowerCase()}function L(){const T=this.resume(),P=this.stack[this.stack.length-1];P.title=T}function W(){const T=this.resume(),P=this.stack[this.stack.length-1];P.url=T}function F(T){const P=this.stack[this.stack.length-1];if(!P.depth){const S=this.sliceSerialize(T).length;P.depth=S}}function j(){this.data.setextHeadingSlurpLineEnding=!0}function Z(T){const P=this.stack[this.stack.length-1];P.depth=this.sliceSerialize(T).codePointAt(0)===61?1:2}function ce(){this.data.setextHeadingSlurpLineEnding=void 0}function ne(T){const S=this.stack[this.stack.length-1].children;let ee=S[S.length-1];(!ee||ee.type!=="text")&&(ee=jt(),ee.position={start:Ft(T.start),end:void 0},S.push(ee)),this.stack.push(ee)}function le(T){const P=this.stack.pop();P.value+=this.sliceSerialize(T),P.position.end=Ft(T.end)}function V(T){const P=this.stack[this.stack.length-1];if(this.data.atHardBreak){const S=P.children[P.children.length-1];S.position.end=Ft(T.end),this.data.atHardBreak=void 0;return}!this.data.setextHeadingSlurpLineEnding&&n.canContainEols.includes(P.type)&&(ne.call(this,T),le.call(this,T))}function _(){this.data.atHardBreak=!0}function C(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T}function Y(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T}function E(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T}function U(){const T=this.stack[this.stack.length-1];if(this.data.inReference){const P=this.data.referenceType||"shortcut";T.type+="Reference",T.referenceType=P,delete T.url,delete T.title}else delete T.identifier,delete T.label;this.data.referenceType=void 0}function J(){const T=this.stack[this.stack.length-1];if(this.data.inReference){const P=this.data.referenceType||"shortcut";T.type+="Reference",T.referenceType=P,delete T.url,delete T.title}else delete T.identifier,delete T.label;this.data.referenceType=void 0}function Se(T){const P=this.sliceSerialize(T),S=this.stack[this.stack.length-2];S.label=go(P),S.identifier=pn(P).toLowerCase()}function pe(){const T=this.stack[this.stack.length-1],P=this.resume(),S=this.stack[this.stack.length-1];if(this.data.inReference=!0,S.type==="link"){const ee=T.children;S.children=ee}else S.alt=P}function w(){const T=this.resume(),P=this.stack[this.stack.length-1];P.url=T}function Fe(){const T=this.resume(),P=this.stack[this.stack.length-1];P.title=T}function we(){this.data.inReference=void 0}function x(){this.data.referenceType="collapsed"}function De(T){const P=this.resume(),S=this.stack[this.stack.length-1];S.label=P,S.identifier=pn(this.sliceSerialize(T)).toLowerCase(),this.data.referenceType="full"}function He(T){this.data.characterReferenceType=T.type}function ke(T){const P=this.sliceSerialize(T),S=this.data.characterReferenceType;let ee;S?(ee=ao(P,S==="characterReferenceMarkerNumeric"?10:16),this.data.characterReferenceType=void 0):ee=zi(P);const ue=this.stack[this.stack.length-1];ue.value+=ee}function at(T){const P=this.stack.pop();P.position.end=Ft(T.end)}function Re(T){le.call(this,T);const P=this.stack[this.stack.length-1];P.url=this.sliceSerialize(T)}function et(T){le.call(this,T);const P=this.stack[this.stack.length-1];P.url="mailto:"+this.sliceSerialize(T)}function st(){return{type:"blockquote",children:[]}}function tt(){return{type:"code",lang:null,meta:null,value:""}}function Yt(){return{type:"inlineCode",value:""}}function v(){return{type:"definition",identifier:"",label:null,title:null,url:""}}function Dt(){return{type:"emphasis",children:[]}}function Nt(){return{type:"heading",depth:0,children:[]}}function Kt(){return{type:"break"}}function dt(){return{type:"html",value:""}}function gt(){return{type:"image",title:null,url:"",alt:null}}function Je(){return{type:"link",title:null,url:"",children:[]}}function vt(T){return{type:"list",ordered:T.type==="listOrdered",start:null,spread:T._spread,children:[]}}function Ut(T){return{type:"listItem",spread:T._spread,checked:null,children:[]}}function Xt(){return{type:"paragraph",children:[]}}function We(){return{type:"strong",children:[]}}function jt(){return{type:"text",value:""}}function $e(){return{type:"thematicBreak"}}}function Ft(e){return{line:e.line,column:e.column,offset:e.offset}}function xo(e,n){let t=-1;for(;++t<n.length;){const r=n[t];Array.isArray(r)?xo(e,r):Td(e,r)}}function Td(e,n){let t;for(t in n)if(yo.call(n,t))switch(t){case"canContainEols":{const r=n[t];r&&e[t].push(...r);break}case"transforms":{const r=n[t];r&&e[t].push(...r);break}case"enter":case"exit":{const r=n[t];r&&Object.assign(e[t],r);break}}}function xs(e,n){throw e?new Error("Cannot close `"+e.type+"` ("+Fn({start:e.start,end:e.end})+"): a different token (`"+n.type+"`, "+Fn({start:n.start,end:n.end})+") is open"):new Error("Cannot close document, a token (`"+n.type+"`, "+Fn({start:n.start,end:n.end})+") is still open")}function Pd(e){const n=this;n.parser=t;function t(r){return Cd(r,{...n.data("settings"),...e,extensions:n.data("micromarkExtensions")||[],mdastExtensions:n.data("fromMarkdownExtensions")||[]})}}const bs={}.hasOwnProperty;function bo(e,n){const t=n||{};function r(s,...a){let o=r.invalid;const l=r.handlers;if(s&&bs.call(s,e)){const c=String(s[e]);o=bs.call(l,c)?l[c]:r.unknown}if(o)return o.call(this,s,...a)}return r.handlers=t.handlers||{},r.invalid=t.invalid,r.unknown=t.unknown,r}const Ed={}.hasOwnProperty;function wo(e,n){let t=-1,r;if(n.extensions)for(;++t<n.extensions.length;)wo(e,n.extensions[t]);for(r in n)if(Ed.call(n,r))switch(r){case"extensions":break;case"unsafe":{ws(e[r],n[r]);break}case"join":{ws(e[r],n[r]);break}case"handlers":{Ad(e[r],n[r]);break}default:e.options[r]=n[r]}return e}function ws(e,n){n&&e.push(...n)}function Ad(e,n){n&&Object.assign(e,n)}function Dd(e,n,t,r){const s=t.enter("blockquote"),a=t.createTracker(r);a.move("> "),a.shift(2);const o=t.indentLines(t.containerFlow(e,a.current()),Id);return s(),o}function Id(e,n,t){return">"+(t?"":" ")+e}function ko(e,n){return ks(e,n.inConstruct,!0)&&!ks(e,n.notInConstruct,!1)}function ks(e,n,t){if(typeof n=="string"&&(n=[n]),!n||n.length===0)return t;let r=-1;for(;++r<n.length;)if(e.includes(n[r]))return!0;return!1}function _s(e,n,t,r){let s=-1;for(;++s<t.unsafe.length;)if(t.unsafe[s].character===`
`&&ko(t.stack,t.unsafe[s]))return/[ \t]/.test(r.before)?"":" ";return`\\
`}function Od(e,n){const t=String(e);let r=t.indexOf(n),s=r,a=0,o=0;if(typeof n!="string")throw new TypeError("Expected substring");for(;r!==-1;)r===s?++a>o&&(o=a):a=1,s=r+n.length,r=t.indexOf(n,s);return o}function Pi(e,n){return!!(n.options.fences===!1&&e.value&&!e.lang&&/[^ \r\n]/.test(e.value)&&!/^[\t ]*(?:[\r\n]|$)|(?:^|[\r\n])[\t ]*$/.test(e.value))}function $d(e){const n=e.options.fence||"`";if(n!=="`"&&n!=="~")throw new Error("Cannot serialize code with `"+n+"` for `options.fence`, expected `` ` `` or `~`");return n}function Ld(e,n,t,r){const s=$d(t),a=e.value||"",o=s==="`"?"GraveAccent":"Tilde";if(Pi(e,t)){const d=t.enter("codeIndented"),y=t.indentLines(a,Rd);return d(),y}const l=t.createTracker(r),c=s.repeat(Math.max(Od(a,s)+1,3)),u=t.enter("codeFenced");let m=l.move(c);if(e.lang){const d=t.enter(`codeFencedLang${o}`);m+=l.move(t.safe(e.lang,{before:m,after:" ",encode:["`"],...l.current()})),d()}if(e.lang&&e.meta){const d=t.enter(`codeFencedMeta${o}`);m+=l.move(" "),m+=l.move(t.safe(e.meta,{before:m,after:`
`,encode:["`"],...l.current()})),d()}return m+=l.move(`
`),a&&(m+=l.move(a+`
`)),m+=l.move(c),u(),m}function Rd(e,n,t){return(t?"":"    ")+e}function Ui(e){const n=e.options.quote||'"';if(n!=='"'&&n!=="'")throw new Error("Cannot serialize title with `"+n+"` for `options.quote`, expected `\"`, or `'`");return n}function Fd(e,n,t,r){const s=Ui(t),a=s==='"'?"Quote":"Apostrophe",o=t.enter("definition");let l=t.enter("label");const c=t.createTracker(r);let u=c.move("[");return u+=c.move(t.safe(t.associationId(e),{before:u,after:"]",...c.current()})),u+=c.move("]: "),l(),!e.url||/[\0- \u007F]/.test(e.url)?(l=t.enter("destinationLiteral"),u+=c.move("<"),u+=c.move(t.safe(e.url,{before:u,after:">",...c.current()})),u+=c.move(">")):(l=t.enter("destinationRaw"),u+=c.move(t.safe(e.url,{before:u,after:e.title?" ":`
`,...c.current()}))),l(),e.title&&(l=t.enter(`title${a}`),u+=c.move(" "+s),u+=c.move(t.safe(e.title,{before:u,after:s,...c.current()})),u+=c.move(s),l()),o(),u}function zd(e){const n=e.options.emphasis||"*";if(n!=="*"&&n!=="_")throw new Error("Cannot serialize emphasis with `"+n+"` for `options.emphasis`, expected `*`, or `_`");return n}function qt(e){return"&#x"+e.toString(16).toUpperCase()+";"}function fr(e,n,t){const r=mr(e),s=mr(n);return r===void 0?s===void 0?t==="_"?{inside:!0,outside:!0}:{inside:!1,outside:!1}:s===1?{inside:!0,outside:!0}:{inside:!1,outside:!0}:r===1?s===void 0?{inside:!1,outside:!1}:s===1?{inside:!0,outside:!0}:{inside:!1,outside:!1}:s===void 0?{inside:!1,outside:!1}:s===1?{inside:!0,outside:!1}:{inside:!1,outside:!1}}_o.peek=qd;function _o(e,n,t,r){const s=zd(t),a=t.enter("emphasis"),o=t.createTracker(r),l=o.move(s);let c=o.move(t.containerPhrasing(e,{after:s,before:l,...o.current()}));const u=c.charCodeAt(0),m=fr(r.before.charCodeAt(r.before.length-1),u,s);m.inside&&(c=qt(u)+c.slice(1));const d=c.charCodeAt(c.length-1),y=fr(r.after.charCodeAt(0),d,s);y.inside&&(c=c.slice(0,-1)+qt(d));const p=o.move(s);return a(),t.attentionEncodeSurroundingInfo={after:y.outside,before:m.outside},l+c+p}function qd(e,n,t){return t.options.emphasis||"*"}const Mi=function(e){if(e==null)return Hd;if(typeof e=="function")return br(e);if(typeof e=="object")return Array.isArray(e)?Bd(e):Ud(e);if(typeof e=="string")return Md(e);throw new Error("Expected function, string, or object as test")};function Bd(e){const n=[];let t=-1;for(;++t<e.length;)n[t]=Mi(e[t]);return br(r);function r(...s){let a=-1;for(;++a<n.length;)if(n[a].apply(this,s))return!0;return!1}}function Ud(e){const n=e;return br(t);function t(r){const s=r;let a;for(a in e)if(s[a]!==n[a])return!1;return!0}}function Md(e){return br(n);function n(t){return t&&t.type===e}}function br(e){return n;function n(t,r,s){return!!(Wd(t)&&e.call(this,t,typeof r=="number"?r:void 0,s||void 0))}}function Hd(){return!0}function Wd(e){return e!==null&&typeof e=="object"&&"type"in e}const No=[],Vd=!0,Ei=!1,Jd="skip";function Qd(e,n,t,r){let s;typeof n=="function"&&typeof t!="function"?(r=t,t=n):s=n;const a=Mi(s),o=r?-1:1;l(e,void 0,[])();function l(c,u,m){const d=c&&typeof c=="object"?c:{};if(typeof d.type=="string"){const p=typeof d.tagName=="string"?d.tagName:typeof d.name=="string"?d.name:void 0;Object.defineProperty(y,"name",{value:"node ("+(c.type+(p?"<"+p+">":""))+")"})}return y;function y(){let p=No,A,q,K;if((!n||a(c,u,m[m.length-1]||void 0))&&(p=Gd(t(c,m)),p[0]===Ei))return p;if("children"in c&&c.children){const $=c;if($.children&&p[0]!==Jd)for(q=(r?$.children.length:-1)+o,K=m.concat($);q>-1&&q<$.children.length;){const H=$.children[q];if(A=l(H,q,K)(),A[0]===Ei)return A;q=typeof A[1]=="number"?A[1]:q+o}}return p}}}function Gd(e){return Array.isArray(e)?e:typeof e=="number"?[Vd,e]:e==null?No:[e]}function vo(e,n,t,r){let s,a,o;typeof n=="function"?(a=void 0,o=n,s=t):(a=n,o=t,s=r),Qd(e,a,l,s);function l(c,u){const m=u[u.length-1],d=m?m.children.indexOf(c):void 0;return o(c,d,m)}}function jo(e,n){let t=!1;return vo(e,function(r){if("value"in r&&/\r?\n|\r/.test(r.value)||r.type==="break")return t=!0,Ei}),!!((!e.depth||e.depth<3)&&Fi(e)&&(n.options.setext||t))}function Yd(e,n,t,r){const s=Math.max(Math.min(6,e.depth||1),1),a=t.createTracker(r);if(jo(e,t)){const m=t.enter("headingSetext"),d=t.enter("phrasing"),y=t.containerPhrasing(e,{...a.current(),before:`
`,after:`
`});return d(),m(),y+`
`+(s===1?"=":"-").repeat(y.length-(Math.max(y.lastIndexOf("\r"),y.lastIndexOf(`
`))+1))}const o="#".repeat(s),l=t.enter("headingAtx"),c=t.enter("phrasing");a.move(o+" ");let u=t.containerPhrasing(e,{before:"# ",after:`
`,...a.current()});return/^[\t ]/.test(u)&&(u=qt(u.charCodeAt(0))+u.slice(1)),u=u?o+" "+u:o,t.options.closeAtx&&(u+=" "+o),c(),l(),u}Co.peek=Kd;function Co(e){return e.value||""}function Kd(){return"<"}So.peek=Xd;function So(e,n,t,r){const s=Ui(t),a=s==='"'?"Quote":"Apostrophe",o=t.enter("image");let l=t.enter("label");const c=t.createTracker(r);let u=c.move("![");return u+=c.move(t.safe(e.alt,{before:u,after:"]",...c.current()})),u+=c.move("]("),l(),!e.url&&e.title||/[\0- \u007F]/.test(e.url)?(l=t.enter("destinationLiteral"),u+=c.move("<"),u+=c.move(t.safe(e.url,{before:u,after:">",...c.current()})),u+=c.move(">")):(l=t.enter("destinationRaw"),u+=c.move(t.safe(e.url,{before:u,after:e.title?" ":")",...c.current()}))),l(),e.title&&(l=t.enter(`title${a}`),u+=c.move(" "+s),u+=c.move(t.safe(e.title,{before:u,after:s,...c.current()})),u+=c.move(s),l()),u+=c.move(")"),o(),u}function Xd(){return"!"}To.peek=Zd;function To(e,n,t,r){const s=e.referenceType,a=t.enter("imageReference");let o=t.enter("label");const l=t.createTracker(r);let c=l.move("![");const u=t.safe(e.alt,{before:c,after:"]",...l.current()});c+=l.move(u+"]["),o();const m=t.stack;t.stack=[],o=t.enter("reference");const d=t.safe(t.associationId(e),{before:c,after:"]",...l.current()});return o(),t.stack=m,a(),s==="full"||!u||u!==d?c+=l.move(d+"]"):s==="shortcut"?c=c.slice(0,-1):c+=l.move("]"),c}function Zd(){return"!"}Po.peek=ep;function Po(e,n,t){let r=e.value||"",s="`",a=-1;for(;new RegExp("(^|[^`])"+s+"([^`]|$)").test(r);)s+="`";for(/[^ \r\n]/.test(r)&&(/^[ \r\n]/.test(r)&&/[ \r\n]$/.test(r)||/^`|`$/.test(r))&&(r=" "+r+" ");++a<t.unsafe.length;){const o=t.unsafe[a],l=t.compilePattern(o);let c;if(o.atBreak)for(;c=l.exec(r);){let u=c.index;r.charCodeAt(u)===10&&r.charCodeAt(u-1)===13&&u--,r=r.slice(0,u)+" "+r.slice(c.index+1)}}return s+r+s}function ep(){return"`"}function Eo(e,n){const t=Fi(e);return!!(!n.options.resourceLink&&e.url&&!e.title&&e.children&&e.children.length===1&&e.children[0].type==="text"&&(t===e.url||"mailto:"+t===e.url)&&/^[a-z][a-z+.-]+:/i.test(e.url)&&!/[\0- <>\u007F]/.test(e.url))}Ao.peek=tp;function Ao(e,n,t,r){const s=Ui(t),a=s==='"'?"Quote":"Apostrophe",o=t.createTracker(r);let l,c;if(Eo(e,t)){const m=t.stack;t.stack=[],l=t.enter("autolink");let d=o.move("<");return d+=o.move(t.containerPhrasing(e,{before:d,after:">",...o.current()})),d+=o.move(">"),l(),t.stack=m,d}l=t.enter("link"),c=t.enter("label");let u=o.move("[");return u+=o.move(t.containerPhrasing(e,{before:u,after:"](",...o.current()})),u+=o.move("]("),c(),!e.url&&e.title||/[\0- \u007F]/.test(e.url)?(c=t.enter("destinationLiteral"),u+=o.move("<"),u+=o.move(t.safe(e.url,{before:u,after:">",...o.current()})),u+=o.move(">")):(c=t.enter("destinationRaw"),u+=o.move(t.safe(e.url,{before:u,after:e.title?" ":")",...o.current()}))),c(),e.title&&(c=t.enter(`title${a}`),u+=o.move(" "+s),u+=o.move(t.safe(e.title,{before:u,after:s,...o.current()})),u+=o.move(s),c()),u+=o.move(")"),l(),u}function tp(e,n,t){return Eo(e,t)?"<":"["}Do.peek=np;function Do(e,n,t,r){const s=e.referenceType,a=t.enter("linkReference");let o=t.enter("label");const l=t.createTracker(r);let c=l.move("[");const u=t.containerPhrasing(e,{before:c,after:"]",...l.current()});c+=l.move(u+"]["),o();const m=t.stack;t.stack=[],o=t.enter("reference");const d=t.safe(t.associationId(e),{before:c,after:"]",...l.current()});return o(),t.stack=m,a(),s==="full"||!u||u!==d?c+=l.move(d+"]"):s==="shortcut"?c=c.slice(0,-1):c+=l.move("]"),c}function np(){return"["}function Hi(e){const n=e.options.bullet||"*";if(n!=="*"&&n!=="+"&&n!=="-")throw new Error("Cannot serialize items with `"+n+"` for `options.bullet`, expected `*`, `+`, or `-`");return n}function rp(e){const n=Hi(e),t=e.options.bulletOther;if(!t)return n==="*"?"-":"*";if(t!=="*"&&t!=="+"&&t!=="-")throw new Error("Cannot serialize items with `"+t+"` for `options.bulletOther`, expected `*`, `+`, or `-`");if(t===n)throw new Error("Expected `bullet` (`"+n+"`) and `bulletOther` (`"+t+"`) to be different");return t}function ip(e){const n=e.options.bulletOrdered||".";if(n!=="."&&n!==")")throw new Error("Cannot serialize items with `"+n+"` for `options.bulletOrdered`, expected `.` or `)`");return n}function Io(e){const n=e.options.rule||"*";if(n!=="*"&&n!=="-"&&n!=="_")throw new Error("Cannot serialize rules with `"+n+"` for `options.rule`, expected `*`, `-`, or `_`");return n}function ap(e,n,t,r){const s=t.enter("list"),a=t.bulletCurrent;let o=e.ordered?ip(t):Hi(t);const l=e.ordered?o==="."?")":".":rp(t);let c=n&&t.bulletLastUsed?o===t.bulletLastUsed:!1;if(!e.ordered){const m=e.children?e.children[0]:void 0;if((o==="*"||o==="-")&&m&&(!m.children||!m.children[0])&&t.stack[t.stack.length-1]==="list"&&t.stack[t.stack.length-2]==="listItem"&&t.stack[t.stack.length-3]==="list"&&t.stack[t.stack.length-4]==="listItem"&&t.indexStack[t.indexStack.length-1]===0&&t.indexStack[t.indexStack.length-2]===0&&t.indexStack[t.indexStack.length-3]===0&&(c=!0),Io(t)===o&&m){let d=-1;for(;++d<e.children.length;){const y=e.children[d];if(y&&y.type==="listItem"&&y.children&&y.children[0]&&y.children[0].type==="thematicBreak"){c=!0;break}}}}c&&(o=l),t.bulletCurrent=o;const u=t.containerFlow(e,r);return t.bulletLastUsed=o,t.bulletCurrent=a,s(),u}function sp(e){const n=e.options.listItemIndent||"one";if(n!=="tab"&&n!=="one"&&n!=="mixed")throw new Error("Cannot serialize items with `"+n+"` for `options.listItemIndent`, expected `tab`, `one`, or `mixed`");return n}function op(e,n,t,r){const s=sp(t);let a=t.bulletCurrent||Hi(t);n&&n.type==="list"&&n.ordered&&(a=(typeof n.start=="number"&&n.start>-1?n.start:1)+(t.options.incrementListMarker===!1?0:n.children.indexOf(e))+a);let o=a.length+1;(s==="tab"||s==="mixed"&&(n&&n.type==="list"&&n.spread||e.spread))&&(o=Math.ceil(o/4)*4);const l=t.createTracker(r);l.move(a+" ".repeat(o-a.length)),l.shift(o);const c=t.enter("listItem"),u=t.indentLines(t.containerFlow(e,l.current()),m);return c(),u;function m(d,y,p){return y?(p?"":" ".repeat(o))+d:(p?a:a+" ".repeat(o-a.length))+d}}function lp(e,n,t,r){const s=t.enter("paragraph"),a=t.enter("phrasing"),o=t.containerPhrasing(e,r);return a(),s(),o}const cp=Mi(["break","delete","emphasis","footnote","footnoteReference","image","imageReference","inlineCode","inlineMath","link","linkReference","mdxJsxTextElement","mdxTextExpression","strong","text","textDirective"]);function up(e,n,t,r){return(e.children.some(function(o){return cp(o)})?t.containerPhrasing:t.containerFlow).call(t,e,r)}function dp(e){const n=e.options.strong||"*";if(n!=="*"&&n!=="_")throw new Error("Cannot serialize strong with `"+n+"` for `options.strong`, expected `*`, or `_`");return n}Oo.peek=pp;function Oo(e,n,t,r){const s=dp(t),a=t.enter("strong"),o=t.createTracker(r),l=o.move(s+s);let c=o.move(t.containerPhrasing(e,{after:s,before:l,...o.current()}));const u=c.charCodeAt(0),m=fr(r.before.charCodeAt(r.before.length-1),u,s);m.inside&&(c=qt(u)+c.slice(1));const d=c.charCodeAt(c.length-1),y=fr(r.after.charCodeAt(0),d,s);y.inside&&(c=c.slice(0,-1)+qt(d));const p=o.move(s+s);return a(),t.attentionEncodeSurroundingInfo={after:y.outside,before:m.outside},l+c+p}function pp(e,n,t){return t.options.strong||"*"}function hp(e,n,t,r){return t.safe(e.value,r)}function mp(e){const n=e.options.ruleRepetition||3;if(n<3)throw new Error("Cannot serialize rules with repetition `"+n+"` for `options.ruleRepetition`, expected `3` or more");return n}function fp(e,n,t){const r=(Io(t)+(t.options.ruleSpaces?" ":"")).repeat(mp(t));return t.options.ruleSpaces?r.slice(0,-1):r}const gp={blockquote:Dd,break:_s,code:Ld,definition:Fd,emphasis:_o,hardBreak:_s,heading:Yd,html:Co,image:So,imageReference:To,inlineCode:Po,link:Ao,linkReference:Do,list:ap,listItem:op,paragraph:lp,root:up,strong:Oo,text:hp,thematicBreak:fp},yp=[xp];function xp(e,n,t,r){if(n.type==="code"&&Pi(n,r)&&(e.type==="list"||e.type===n.type&&Pi(e,r)))return!1;if("spread"in t&&typeof t.spread=="boolean")return e.type==="paragraph"&&(e.type===n.type||n.type==="definition"||n.type==="heading"&&jo(n,r))?void 0:t.spread?1:0}const Vt=["autolink","destinationLiteral","destinationRaw","reference","titleQuote","titleApostrophe"],bp=[{character:"	",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",before:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"\r",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:`
`,inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:" ",after:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",before:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"!",after:"\\[",inConstruct:"phrasing",notInConstruct:Vt},{character:'"',inConstruct:"titleQuote"},{atBreak:!0,character:"#"},{character:"#",inConstruct:"headingAtx",after:`(?:[\r
]|$)`},{character:"&",after:"[#A-Za-z]",inConstruct:"phrasing"},{character:"'",inConstruct:"titleApostrophe"},{character:"(",inConstruct:"destinationRaw"},{before:"\\]",character:"(",inConstruct:"phrasing",notInConstruct:Vt},{atBreak:!0,before:"\\d+",character:")"},{character:")",inConstruct:"destinationRaw"},{atBreak:!0,character:"*",after:`(?:[ 	\r
*])`},{character:"*",inConstruct:"phrasing",notInConstruct:Vt},{atBreak:!0,character:"+",after:`(?:[ 	\r
])`},{atBreak:!0,character:"-",after:`(?:[ 	\r
-])`},{atBreak:!0,before:"\\d+",character:".",after:`(?:[ 	\r
]|$)`},{atBreak:!0,character:"<",after:"[!/?A-Za-z]"},{character:"<",after:"[!/?A-Za-z]",inConstruct:"phrasing",notInConstruct:Vt},{character:"<",inConstruct:"destinationLiteral"},{atBreak:!0,character:"="},{atBreak:!0,character:">"},{character:">",inConstruct:"destinationLiteral"},{atBreak:!0,character:"["},{character:"[",inConstruct:"phrasing",notInConstruct:Vt},{character:"[",inConstruct:["label","reference"]},{character:"\\",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"]",inConstruct:["label","reference"]},{atBreak:!0,character:"_"},{character:"_",inConstruct:"phrasing",notInConstruct:Vt},{atBreak:!0,character:"`"},{character:"`",inConstruct:["codeFencedLangGraveAccent","codeFencedMetaGraveAccent"]},{character:"`",inConstruct:"phrasing",notInConstruct:Vt},{atBreak:!0,character:"~"}];function wp(e){return e.label||!e.identifier?e.label||"":go(e.identifier)}function kp(e){if(!e._compiled){const n=(e.atBreak?"[\\r\\n][\\t ]*":"")+(e.before?"(?:"+e.before+")":"");e._compiled=new RegExp((n?"("+n+")":"")+(/[|\\{}()[\]^$+*?.-]/.test(e.character)?"\\":"")+e.character+(e.after?"(?:"+e.after+")":""),"g")}return e._compiled}function _p(e,n,t){const r=n.indexStack,s=e.children||[],a=[];let o=-1,l=t.before,c;r.push(-1);let u=n.createTracker(t);for(;++o<s.length;){const m=s[o];let d;if(r[r.length-1]=o,o+1<s.length){let A=n.handle.handlers[s[o+1].type];A&&A.peek&&(A=A.peek),d=A?A(s[o+1],e,n,{before:"",after:"",...u.current()}).charAt(0):""}else d=t.after;a.length>0&&(l==="\r"||l===`
`)&&m.type==="html"&&(a[a.length-1]=a[a.length-1].replace(/(\r?\n|\r)$/," "),l=" ",u=n.createTracker(t),u.move(a.join("")));let y=n.handle(m,e,n,{...u.current(),after:d,before:l});c&&c===y.slice(0,1)&&(y=qt(c.charCodeAt(0))+y.slice(1));const p=n.attentionEncodeSurroundingInfo;n.attentionEncodeSurroundingInfo=void 0,c=void 0,p&&(a.length>0&&p.before&&l===a[a.length-1].slice(-1)&&(a[a.length-1]=a[a.length-1].slice(0,-1)+qt(l.charCodeAt(0))),p.after&&(c=d)),u.move(y),a.push(y),l=y.slice(-1)}return r.pop(),a.join("")}function Np(e,n,t){const r=n.indexStack,s=e.children||[],a=n.createTracker(t),o=[];let l=-1;for(r.push(-1);++l<s.length;){const c=s[l];r[r.length-1]=l,o.push(a.move(n.handle(c,e,n,{before:`
`,after:`
`,...a.current()}))),c.type!=="list"&&(n.bulletLastUsed=void 0),l<s.length-1&&o.push(a.move(vp(c,s[l+1],e,n)))}return r.pop(),o.join("")}function vp(e,n,t,r){let s=r.join.length;for(;s--;){const a=r.join[s](e,n,t,r);if(a===!0||a===1)break;if(typeof a=="number")return`
`.repeat(1+a);if(a===!1)return`

<!---->

`}return`

`}const jp=/\r?\n|\r/g;function Cp(e,n){const t=[];let r=0,s=0,a;for(;a=jp.exec(e);)o(e.slice(r,a.index)),t.push(a[0]),r=a.index+a[0].length,s++;return o(e.slice(r)),t.join("");function o(l){t.push(n(l,s,!l))}}function Sp(e,n,t){const r=(t.before||"")+(n||"")+(t.after||""),s=[],a=[],o={};let l=-1;for(;++l<e.unsafe.length;){const m=e.unsafe[l];if(!ko(e.stack,m))continue;const d=e.compilePattern(m);let y;for(;y=d.exec(r);){const p="before"in m||!!m.atBreak,A="after"in m,q=y.index+(p?y[1].length:0);s.includes(q)?(o[q].before&&!p&&(o[q].before=!1),o[q].after&&!A&&(o[q].after=!1)):(s.push(q),o[q]={before:p,after:A})}}s.sort(Tp);let c=t.before?t.before.length:0;const u=r.length-(t.after?t.after.length:0);for(l=-1;++l<s.length;){const m=s[l];m<c||m>=u||m+1<u&&s[l+1]===m+1&&o[m].after&&!o[m+1].before&&!o[m+1].after||s[l-1]===m-1&&o[m].before&&!o[m-1].before&&!o[m-1].after||(c!==m&&a.push(Ns(r.slice(c,m),"\\")),c=m,/[!-/:-@[-`{-~]/.test(r.charAt(m))&&(!t.encode||!t.encode.includes(r.charAt(m)))?a.push("\\"):(a.push(qt(r.charCodeAt(m))),c++))}return a.push(Ns(r.slice(c,u),t.after)),a.join("")}function Tp(e,n){return e-n}function Ns(e,n){const t=/\\(?=[!-/:-@[-`{-~])/g,r=[],s=[],a=e+n;let o=-1,l=0,c;for(;c=t.exec(a);)r.push(c.index);for(;++o<r.length;)l!==r[o]&&s.push(e.slice(l,r[o])),s.push("\\"),l=r[o];return s.push(e.slice(l)),s.join("")}function Pp(e){const n=e||{},t=n.now||{};let r=n.lineShift||0,s=t.line||1,a=t.column||1;return{move:c,current:o,shift:l};function o(){return{now:{line:s,column:a},lineShift:r}}function l(u){r+=u}function c(u){const m=u||"",d=m.split(/\r?\n|\r/g),y=d[d.length-1];return s+=d.length-1,a=d.length===1?a+y.length:1+y.length+r,m}}function Ep(e,n){const t=n||{},r={associationId:wp,containerPhrasing:Op,containerFlow:$p,createTracker:Pp,compilePattern:kp,enter:a,handlers:{...gp},handle:void 0,indentLines:Cp,indexStack:[],join:[...yp],options:{},safe:Lp,stack:[],unsafe:[...bp]};wo(r,t),r.options.tightDefinitions&&r.join.push(Ip),r.handle=bo("type",{invalid:Ap,unknown:Dp,handlers:r.handlers});let s=r.handle(e,void 0,r,{before:`
`,after:`
`,now:{line:1,column:1},lineShift:0});return s&&s.charCodeAt(s.length-1)!==10&&s.charCodeAt(s.length-1)!==13&&(s+=`
`),s;function a(o){return r.stack.push(o),l;function l(){r.stack.pop()}}}function Ap(e){throw new Error("Cannot handle value `"+e+"`, expected node")}function Dp(e){const n=e;throw new Error("Cannot handle unknown node `"+n.type+"`")}function Ip(e,n){if(e.type==="definition"&&e.type===n.type)return 0}function Op(e,n){return _p(e,this,n)}function $p(e,n){return Np(e,this,n)}function Lp(e,n){return Sp(this,e,n)}function Rp(e){const n=this;n.compiler=t;function t(r){return Ep(r,{...n.data("settings"),...e,extensions:n.data("toMarkdownExtensions")||[]})}}function vs(e){if(e)throw e}var oi,js;function Fp(){if(js)return oi;js=1;var e=Object.prototype.hasOwnProperty,n=Object.prototype.toString,t=Object.defineProperty,r=Object.getOwnPropertyDescriptor,s=function(u){return typeof Array.isArray=="function"?Array.isArray(u):n.call(u)==="[object Array]"},a=function(u){if(!u||n.call(u)!=="[object Object]")return!1;var m=e.call(u,"constructor"),d=u.constructor&&u.constructor.prototype&&e.call(u.constructor.prototype,"isPrototypeOf");if(u.constructor&&!m&&!d)return!1;var y;for(y in u);return typeof y>"u"||e.call(u,y)},o=function(u,m){t&&m.name==="__proto__"?t(u,m.name,{enumerable:!0,configurable:!0,value:m.newValue,writable:!0}):u[m.name]=m.newValue},l=function(u,m){if(m==="__proto__")if(e.call(u,m)){if(r)return r(u,m).value}else return;return u[m]};return oi=function c(){var u,m,d,y,p,A,q=arguments[0],K=1,$=arguments.length,H=!1;for(typeof q=="boolean"&&(H=q,q=arguments[1]||{},K=2),(q==null||typeof q!="object"&&typeof q!="function")&&(q={});K<$;++K)if(u=arguments[K],u!=null)for(m in u)d=l(q,m),y=l(u,m),q!==y&&(H&&y&&(a(y)||(p=s(y)))?(p?(p=!1,A=d&&s(d)?d:[]):A=d&&a(d)?d:{},o(q,{name:m,newValue:c(H,A,y)})):typeof y<"u"&&o(q,{name:m,newValue:y}));return q},oi}var zp=Fp();const li=ic(zp);function Ai(e){if(typeof e!="object"||e===null)return!1;const n=Object.getPrototypeOf(e);return(n===null||n===Object.prototype||Object.getPrototypeOf(n)===null)&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)}function qp(){const e=[],n={run:t,use:r};return n;function t(...s){let a=-1;const o=s.pop();if(typeof o!="function")throw new TypeError("Expected function as last argument, not "+o);l(null,...s);function l(c,...u){const m=e[++a];let d=-1;if(c){o(c);return}for(;++d<s.length;)(u[d]===null||u[d]===void 0)&&(u[d]=s[d]);s=u,m?Bp(m,l)(...u):o(null,...u)}}function r(s){if(typeof s!="function")throw new TypeError("Expected `middelware` to be a function, not "+s);return e.push(s),n}}function Bp(e,n){let t;return r;function r(...o){const l=e.length>o.length;let c;l&&o.push(s);try{c=e.apply(this,o)}catch(u){const m=u;if(l&&t)throw m;return s(m)}l||(c&&c.then&&typeof c.then=="function"?c.then(a,s):c instanceof Error?s(c):a(c))}function s(o,...l){t||(t=!0,n(o,...l))}function a(o){s(null,o)}}class Xe extends Error{constructor(n,t,r){super(),typeof t=="string"&&(r=t,t=void 0);let s="",a={},o=!1;if(t&&("line"in t&&"column"in t?a={place:t}:"start"in t&&"end"in t?a={place:t}:"type"in t?a={ancestors:[t],place:t.position}:a={...t}),typeof n=="string"?s=n:!a.cause&&n&&(o=!0,s=n.message,a.cause=n),!a.ruleId&&!a.source&&typeof r=="string"){const c=r.indexOf(":");c===-1?a.ruleId=r:(a.source=r.slice(0,c),a.ruleId=r.slice(c+1))}if(!a.place&&a.ancestors&&a.ancestors){const c=a.ancestors[a.ancestors.length-1];c&&(a.place=c.position)}const l=a.place&&"start"in a.place?a.place.start:a.place;this.ancestors=a.ancestors||void 0,this.cause=a.cause||void 0,this.column=l?l.column:void 0,this.fatal=void 0,this.file="",this.message=s,this.line=l?l.line:void 0,this.name=Fn(a.place)||"1:1",this.place=a.place||void 0,this.reason=this.message,this.ruleId=a.ruleId||void 0,this.source=a.source||void 0,this.stack=o&&a.cause&&typeof a.cause.stack=="string"?a.cause.stack:"",this.actual=void 0,this.expected=void 0,this.note=void 0,this.url=void 0}}Xe.prototype.file="";Xe.prototype.name="";Xe.prototype.reason="";Xe.prototype.message="";Xe.prototype.stack="";Xe.prototype.column=void 0;Xe.prototype.line=void 0;Xe.prototype.ancestors=void 0;Xe.prototype.cause=void 0;Xe.prototype.fatal=void 0;Xe.prototype.place=void 0;Xe.prototype.ruleId=void 0;Xe.prototype.source=void 0;const wt={basename:Up,dirname:Mp,extname:Hp,join:Wp,sep:"/"};function Up(e,n){if(n!==void 0&&typeof n!="string")throw new TypeError('"ext" argument must be a string');Bn(e);let t=0,r=-1,s=e.length,a;if(n===void 0||n.length===0||n.length>e.length){for(;s--;)if(e.codePointAt(s)===47){if(a){t=s+1;break}}else r<0&&(a=!0,r=s+1);return r<0?"":e.slice(t,r)}if(n===e)return"";let o=-1,l=n.length-1;for(;s--;)if(e.codePointAt(s)===47){if(a){t=s+1;break}}else o<0&&(a=!0,o=s+1),l>-1&&(e.codePointAt(s)===n.codePointAt(l--)?l<0&&(r=s):(l=-1,r=o));return t===r?r=o:r<0&&(r=e.length),e.slice(t,r)}function Mp(e){if(Bn(e),e.length===0)return".";let n=-1,t=e.length,r;for(;--t;)if(e.codePointAt(t)===47){if(r){n=t;break}}else r||(r=!0);return n<0?e.codePointAt(0)===47?"/":".":n===1&&e.codePointAt(0)===47?"//":e.slice(0,n)}function Hp(e){Bn(e);let n=e.length,t=-1,r=0,s=-1,a=0,o;for(;n--;){const l=e.codePointAt(n);if(l===47){if(o){r=n+1;break}continue}t<0&&(o=!0,t=n+1),l===46?s<0?s=n:a!==1&&(a=1):s>-1&&(a=-1)}return s<0||t<0||a===0||a===1&&s===t-1&&s===r+1?"":e.slice(s,t)}function Wp(...e){let n=-1,t;for(;++n<e.length;)Bn(e[n]),e[n]&&(t=t===void 0?e[n]:t+"/"+e[n]);return t===void 0?".":Vp(t)}function Vp(e){Bn(e);const n=e.codePointAt(0)===47;let t=Jp(e,!n);return t.length===0&&!n&&(t="."),t.length>0&&e.codePointAt(e.length-1)===47&&(t+="/"),n?"/"+t:t}function Jp(e,n){let t="",r=0,s=-1,a=0,o=-1,l,c;for(;++o<=e.length;){if(o<e.length)l=e.codePointAt(o);else{if(l===47)break;l=47}if(l===47){if(!(s===o-1||a===1))if(s!==o-1&&a===2){if(t.length<2||r!==2||t.codePointAt(t.length-1)!==46||t.codePointAt(t.length-2)!==46){if(t.length>2){if(c=t.lastIndexOf("/"),c!==t.length-1){c<0?(t="",r=0):(t=t.slice(0,c),r=t.length-1-t.lastIndexOf("/")),s=o,a=0;continue}}else if(t.length>0){t="",r=0,s=o,a=0;continue}}n&&(t=t.length>0?t+"/..":"..",r=2)}else t.length>0?t+="/"+e.slice(s+1,o):t=e.slice(s+1,o),r=o-s-1;s=o,a=0}else l===46&&a>-1?a++:a=-1}return t}function Bn(e){if(typeof e!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}const Qp={cwd:Gp};function Gp(){return"/"}function Di(e){return!!(e!==null&&typeof e=="object"&&"href"in e&&e.href&&"protocol"in e&&e.protocol&&e.auth===void 0)}function Yp(e){if(typeof e=="string")e=new URL(e);else if(!Di(e)){const n=new TypeError('The "path" argument must be of type string or an instance of URL. Received `'+e+"`");throw n.code="ERR_INVALID_ARG_TYPE",n}if(e.protocol!=="file:"){const n=new TypeError("The URL must be of scheme file");throw n.code="ERR_INVALID_URL_SCHEME",n}return Kp(e)}function Kp(e){if(e.hostname!==""){const r=new TypeError('File URL host must be "localhost" or empty on darwin');throw r.code="ERR_INVALID_FILE_URL_HOST",r}const n=e.pathname;let t=-1;for(;++t<n.length;)if(n.codePointAt(t)===37&&n.codePointAt(t+1)===50){const r=n.codePointAt(t+2);if(r===70||r===102){const s=new TypeError("File URL path must not include encoded / characters");throw s.code="ERR_INVALID_FILE_URL_PATH",s}}return decodeURIComponent(n)}const ci=["history","path","basename","stem","extname","dirname"];class Xp{constructor(n){let t;n?Di(n)?t={path:n}:typeof n=="string"||Zp(n)?t={value:n}:t=n:t={},this.cwd="cwd"in t?"":Qp.cwd(),this.data={},this.history=[],this.messages=[],this.value,this.map,this.result,this.stored;let r=-1;for(;++r<ci.length;){const a=ci[r];a in t&&t[a]!==void 0&&t[a]!==null&&(this[a]=a==="history"?[...t[a]]:t[a])}let s;for(s in t)ci.includes(s)||(this[s]=t[s])}get basename(){return typeof this.path=="string"?wt.basename(this.path):void 0}set basename(n){di(n,"basename"),ui(n,"basename"),this.path=wt.join(this.dirname||"",n)}get dirname(){return typeof this.path=="string"?wt.dirname(this.path):void 0}set dirname(n){Cs(this.basename,"dirname"),this.path=wt.join(n||"",this.basename)}get extname(){return typeof this.path=="string"?wt.extname(this.path):void 0}set extname(n){if(ui(n,"extname"),Cs(this.dirname,"extname"),n){if(n.codePointAt(0)!==46)throw new Error("`extname` must start with `.`");if(n.includes(".",1))throw new Error("`extname` cannot contain multiple dots")}this.path=wt.join(this.dirname,this.stem+(n||""))}get path(){return this.history[this.history.length-1]}set path(n){Di(n)&&(n=Yp(n)),di(n,"path"),this.path!==n&&this.history.push(n)}get stem(){return typeof this.path=="string"?wt.basename(this.path,this.extname):void 0}set stem(n){di(n,"stem"),ui(n,"stem"),this.path=wt.join(this.dirname||"",n+(this.extname||""))}fail(n,t,r){const s=this.message(n,t,r);throw s.fatal=!0,s}info(n,t,r){const s=this.message(n,t,r);return s.fatal=void 0,s}message(n,t,r){const s=new Xe(n,t,r);return this.path&&(s.name=this.path+":"+s.name,s.file=this.path),s.fatal=!1,this.messages.push(s),s}toString(n){return this.value===void 0?"":typeof this.value=="string"?this.value:new TextDecoder(n||void 0).decode(this.value)}}function ui(e,n){if(e&&e.includes(wt.sep))throw new Error("`"+n+"` cannot be a path: did not expect `"+wt.sep+"`")}function di(e,n){if(!e)throw new Error("`"+n+"` cannot be empty")}function Cs(e,n){if(!e)throw new Error("Setting `"+n+"` requires `path` to be set too")}function Zp(e){return!!(e&&typeof e=="object"&&"byteLength"in e&&"byteOffset"in e)}const eh=function(e){const r=this.constructor.prototype,s=r[e],a=function(){return s.apply(a,arguments)};return Object.setPrototypeOf(a,r),a},th={}.hasOwnProperty;class Wi extends eh{constructor(){super("copy"),this.Compiler=void 0,this.Parser=void 0,this.attachers=[],this.compiler=void 0,this.freezeIndex=-1,this.frozen=void 0,this.namespace={},this.parser=void 0,this.transformers=qp()}copy(){const n=new Wi;let t=-1;for(;++t<this.attachers.length;){const r=this.attachers[t];n.use(...r)}return n.data(li(!0,{},this.namespace)),n}data(n,t){return typeof n=="string"?arguments.length===2?(mi("data",this.frozen),this.namespace[n]=t,this):th.call(this.namespace,n)&&this.namespace[n]||void 0:n?(mi("data",this.frozen),this.namespace=n,this):this.namespace}freeze(){if(this.frozen)return this;const n=this;for(;++this.freezeIndex<this.attachers.length;){const[t,...r]=this.attachers[this.freezeIndex];if(r[0]===!1)continue;r[0]===!0&&(r[0]=void 0);const s=t.call(n,...r);typeof s=="function"&&this.transformers.use(s)}return this.frozen=!0,this.freezeIndex=Number.POSITIVE_INFINITY,this}parse(n){this.freeze();const t=or(n),r=this.parser||this.Parser;return pi("parse",r),r(String(t),t)}process(n,t){const r=this;return this.freeze(),pi("process",this.parser||this.Parser),hi("process",this.compiler||this.Compiler),t?s(void 0,t):new Promise(s);function s(a,o){const l=or(n),c=r.parse(l);r.run(c,l,function(m,d,y){if(m||!d||!y)return u(m);const p=d,A=r.stringify(p,y);ih(A)?y.value=A:y.result=A,u(m,y)});function u(m,d){m||!d?o(m):a?a(d):t(void 0,d)}}}processSync(n){let t=!1,r;return this.freeze(),pi("processSync",this.parser||this.Parser),hi("processSync",this.compiler||this.Compiler),this.process(n,s),Ts("processSync","process",t),r;function s(a,o){t=!0,vs(a),r=o}}run(n,t,r){Ss(n),this.freeze();const s=this.transformers;return!r&&typeof t=="function"&&(r=t,t=void 0),r?a(void 0,r):new Promise(a);function a(o,l){const c=or(t);s.run(n,c,u);function u(m,d,y){const p=d||n;m?l(m):o?o(p):r(void 0,p,y)}}}runSync(n,t){let r=!1,s;return this.run(n,t,a),Ts("runSync","run",r),s;function a(o,l){vs(o),s=l,r=!0}}stringify(n,t){this.freeze();const r=or(t),s=this.compiler||this.Compiler;return hi("stringify",s),Ss(n),s(n,r)}use(n,...t){const r=this.attachers,s=this.namespace;if(mi("use",this.frozen),n!=null)if(typeof n=="function")c(n,t);else if(typeof n=="object")Array.isArray(n)?l(n):o(n);else throw new TypeError("Expected usable value, not `"+n+"`");return this;function a(u){if(typeof u=="function")c(u,[]);else if(typeof u=="object")if(Array.isArray(u)){const[m,...d]=u;c(m,d)}else o(u);else throw new TypeError("Expected usable value, not `"+u+"`")}function o(u){if(!("plugins"in u)&&!("settings"in u))throw new Error("Expected usable value but received an empty preset, which is probably a mistake: presets typically come with `plugins` and sometimes with `settings`, but this has neither");l(u.plugins),u.settings&&(s.settings=li(!0,s.settings,u.settings))}function l(u){let m=-1;if(u!=null)if(Array.isArray(u))for(;++m<u.length;){const d=u[m];a(d)}else throw new TypeError("Expected a list of plugins, not `"+u+"`")}function c(u,m){let d=-1,y=-1;for(;++d<r.length;)if(r[d][0]===u){y=d;break}if(y===-1)r.push([u,...m]);else if(m.length>0){let[p,...A]=m;const q=r[y][1];Ai(q)&&Ai(p)&&(p=li(!0,q,p)),r[y]=[u,p,...A]}}}}const nh=new Wi().freeze();function pi(e,n){if(typeof n!="function")throw new TypeError("Cannot `"+e+"` without `parser`")}function hi(e,n){if(typeof n!="function")throw new TypeError("Cannot `"+e+"` without `compiler`")}function mi(e,n){if(n)throw new Error("Cannot call `"+e+"` on a frozen processor.\nCreate a new processor first, by calling it: use `processor()` instead of `processor`.")}function Ss(e){if(!Ai(e)||typeof e.type!="string")throw new TypeError("Expected node, got `"+e+"`")}function Ts(e,n,t){if(!t)throw new Error("`"+e+"` finished async. Use `"+n+"` instead")}function or(e){return rh(e)?e:new Xp(e)}function rh(e){return!!(e&&typeof e=="object"&&"message"in e&&"messages"in e)}function ih(e){return typeof e=="string"||ah(e)}function ah(e){return!!(e&&typeof e=="object"&&"byteLength"in e&&"byteOffset"in e)}const fi=nh().use(Pd).use(Rp).freeze(),sh=e=>{if(!e)return"Unknown Date";try{return new Date(e).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}catch{return"Invalid Date"}},oh=e=>{switch(e){case"pending":return{text:"Billing Pending",className:"status-badge status-pending"};case"billed":return{text:"Sample Pending",className:"status-badge status-billed"};case"collected":return{text:"Sample Collected",className:"status-badge status-collected"};case"processing":return{text:"Processing",className:"status-badge status-processing"};case"report_ready":return{text:"Report Ready",className:"status-badge status-report_ready"};case"reported":return{text:"Reported",className:"status-badge status-reported"};case"completed":return{text:"Completed",className:"status-badge status-completed"};case"cancelled":return{text:"Cancelled",className:"status-badge status-cancelled"};default:return{text:e,className:"status-badge"}}},lh=({title:e,items:n,renderItemContent:t,headerAction:r,isLoading:s,loadingText:a,noDataText:o,onDeleteItem:l,onEditLabOrder:c,onSaveLabOrder:u,onCancelEditLabOrder:m,onLabOrderTestChange:d,onLabOrderStatusChange:y,onEditPharmacyOrder:p,onPrintUnavailablePrescription:A,onBillLabOrder:q,onUpdateLabOrderStatus:K,onEnterLabReport:$,labInventory:H=[],isSavingLabOrder:L=!1,expandedLabReports:W={},toggleLabReport:F=()=>{},selectionEnabled:j=!1,selectedIds:Z=new Set,onSelectionChange:ce})=>{const ne=b.useMemo(()=>{const V={};n.forEach(C=>{if(isNaN(C.date.getTime())){V["Unknown Date"]||(V["Unknown Date"]=[]),V["Unknown Date"].push(C);return}const Y=sh(C.originalDateString);V[Y]||(V[Y]=[]),V[Y].push(C)});const _=Object.keys(V);return _.sort((C,Y)=>{if(C==="Unknown Date")return 1;if(Y==="Unknown Date")return-1;try{const E=new Date(C.split(" ").reverse().join(" ")),U=new Date(Y.split(" ").reverse().join(" "));if(!isNaN(E.getTime())&&!isNaN(U.getTime()))return U.getTime()-E.getTime()}catch{}return Y.localeCompare(C)}),_.map(C=>({date:C,items:V[C]}))},[n]),le=["pending","billed","collected","processing","report_ready","completed","cancelled","reported"];return i.jsxs("div",{className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsx("h4",{className:"ai-context-section-title mb-2 pb-1",children:e}),r]}),s&&i.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(V=>i.jsxs("div",{style:{padding:"10px",background:"var(--glass-light)",borderRadius:"8px",marginBottom:"8px"},children:[i.jsx(Te,{width:"80px",height:"14px",style:{marginBottom:"10px"}}),i.jsx(Te,{width:"100%",height:"16px",style:{marginBottom:"6px"}}),i.jsx(Te,{width:"70%",height:"14px"})]},V))}),!s&&n.length===0&&i.jsx("p",{className:"ai-context-text italic",children:o}),!s&&n.length>0&&i.jsx("div",{className:"space-y-3",children:ne.map(({date:V,items:_})=>i.jsxs("div",{children:[i.jsx("h5",{className:"grouped-history-date",children:V}),i.jsx("div",{className:"space-y-1 grouped-history-item-container",children:_.map((C,Y)=>i.jsxs("div",{className:"grouped-history-item ai-context-item flex flex-col",children:[!(C.type==="Lab Order"&&C.data.isEditing)&&i.jsxs("div",{className:"flex justify-between items-center w-full",children:[j&&ce&&C.type==="Pharmacy Order"&&i.jsx("div",{className:"mr-2",children:i.jsx("input",{type:"checkbox",checked:Z.has(C.data.id),onChange:E=>ce(C.data.id,E.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),i.jsx("div",{className:"flex-grow mr-2 ai-context-text",children:t(C,Y,W,F)}),i.jsxs("div",{className:"flex items-center space-x-1",children:[C.type==="Lab Order"&&!C.data.isEditing&&c&&i.jsx("button",{onClick:()=>c(C.data.id),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400",title:"Edit this lab order",disabled:L,children:i.jsx(mt,{size:14})}),C.type==="Lab Order"&&C.data.isEditing&&i.jsx(i.Fragment,{}),C.type==="Lab Order"&&i.jsxs("div",{className:"lab-table-actions",children:[C.data.status==="pending"&&q&&(()=>{const E=C.data.tests.reduce((U,J)=>U+(Number(J.price)||0),0).toFixed(2);return i.jsx("button",{onClick:()=>q(C.data),className:"text-green-600 hover:text-green-800 p-1 rounded hover:bg-green-100 focus:outline-none focus:ring-1 focus:ring-green-400",title:`Pay total of ₹${E}`,disabled:L,children:i.jsx(ro,{size:14})})})(),C.data.status==="billed"&&K&&i.jsx("button",{onClick:()=>K(C.data.id,"collected"),className:"lab-action-button btn-collect",title:"Collect Sample",children:"Collect"}),C.data.status==="collected"&&K&&i.jsx("button",{onClick:()=>K(C.data.id,"processing"),className:"lab-action-button btn-process",title:"Mark Processing",children:"Process"}),["pending","billed","collected","processing","report_ready","reported","completed"].includes(C.data.status)&&$&&i.jsx("button",{onClick:()=>$(C.data),className:"lab-action-button btn-enter-report",title:"Enter Report",children:"Enter Report"}),(C.data.status==="report_ready"||C.data.status==="reported")&&K&&i.jsx("button",{onClick:()=>K(C.data.id,"completed"),className:"lab-action-button btn-complete",title:"Mark Completed",children:"Complete"})]}),C.type==="Pharmacy Order"&&C.data.status==="pending"&&p&&i.jsx("button",{onClick:()=>p(C.data.id),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400",title:"Edit this pharmacy order",disabled:L,children:i.jsx(mt,{size:14})}),C.type==="Pharmacy Order"&&C.data.prescriptionForUnavailableDrugs&&A&&i.jsx("button",{onClick:()=>A(C.data.prescriptionForUnavailableDrugs,`Prescription for Order ${C.data.id}`),className:"text-purple-600 hover:text-purple-800 p-1 rounded hover:bg-purple-100 focus:outline-none focus:ring-1 focus:ring-purple-400",title:"Print Prescription for Unavailable Drugs",disabled:L,children:i.jsx(Ln,{size:14})}),C.type==="Pharmacy Order"&&C.data.status==="pending"&&l&&i.jsx("button",{onClick:()=>l({type:C.type,data:C.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400",title:"Delete this pending pharmacy order",disabled:L,children:i.jsx(ft,{size:14})}),l&&["Complaint","Lab Order","Lab Report"].includes(C.type)&&i.jsx("button",{onClick:()=>l({type:C.type,data:C.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400",title:`Delete this ${C.type.toLowerCase()}`,disabled:L,children:i.jsx(ft,{size:14})})]})]}),C.type==="Lab Order"&&C.data.isEditing&&i.jsxs("div",{className:"lab-order-edit-form w-full bg-gray-50 border rounded-md p-3",children:[i.jsxs("div",{className:"flex justify-between items-center mb-3",children:[i.jsx("h6",{className:"text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Edit Order"}),i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Status:"}),i.jsx("select",{value:C.data.editedStatus||C.data.status,onChange:E=>y&&y(C.data.id,E.target.value),className:"form-select text-xs py-1 pl-2 pr-6 rounded border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50",disabled:L,children:le.map(E=>i.jsx("option",{value:E,children:E.replace(/_/g," ")},E))})]})]}),i.jsx("div",{className:"overflow-hidden border rounded-md bg-white mb-3",children:i.jsxs("table",{className:"w-full text-xs text-left",children:[i.jsx("thead",{className:"bg-gray-100 border-b",children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-2 px-3 font-medium text-gray-600",children:"Test Name"}),i.jsx("th",{className:"py-2 px-3 text-right font-medium text-gray-600 w-20",children:"Price"}),i.jsx("th",{className:"py-2 px-3 w-10"})]})}),i.jsxs("tbody",{className:"divide-y divide-gray-100",children:[C.data.editedTests.map((E,U)=>i.jsxs("tr",{className:"hover:bg-gray-50",children:[i.jsx("td",{className:"py-1 px-3",children:i.jsxs("select",{value:E.id,onChange:J=>{const Se=H.find(pe=>String(pe.id)===J.target.value);Se&&(d&&d(C.data.id,U,"id",Se.id),d&&d(C.data.id,U,"name",Se.name),d&&d(C.data.id,U,"price",Se.price))},className:"form-select w-full text-xs border-0 bg-transparent focus:ring-0 p-0",disabled:L,children:[i.jsx("option",{value:"",children:"Select Test"}),H.map(J=>i.jsx("option",{value:J.id,children:J.name},J.id))]})}),i.jsxs("td",{className:"py-1 px-3 text-right text-gray-700",children:["₹",E.price]}),i.jsx("td",{className:"py-1 px-3 text-center",children:i.jsx("button",{onClick:()=>{const J=C.data.editedTests.filter((Se,pe)=>pe!==U);d&&d(C.data.id,-1,"remove",J)},className:"text-red-400 hover:text-red-600 focus:outline-none",title:"Remove test",disabled:L,children:i.jsx(ft,{size:12})})})]},U)),C.data.editedTests.length===0&&i.jsx("tr",{children:i.jsx("td",{colSpan:3,className:"py-2 px-3 text-center italic text-gray-400",children:"No tests selected"})})]}),i.jsx("tfoot",{className:"bg-gray-50 border-t",children:i.jsx("tr",{children:i.jsx("td",{colSpan:3,className:"py-1 px-3",children:i.jsx("button",{onClick:()=>{d&&d(C.data.id,-1,"add",{id:"",name:"",price:0})},className:"text-blue-600 hover:text-blue-800 text-xs font-medium flex items-center py-1",disabled:L,children:"+ Add Test"})})})})]})}),i.jsxs("div",{className:"flex justify-end space-x-2 border-t border-gray-200 pt-3 mt-1",children:[i.jsx("button",{onClick:()=>m&&m(C.data.id),className:"px-3 py-1.5 rounded text-xs text-gray-600 hover:bg-white hover:text-gray-800 border border-transparent hover:border-gray-200 transition-colors",disabled:L,children:"Cancel"}),i.jsx("button",{onClick:()=>u&&u(C.data.id,C.data.editedTests,C.data.editedStatus),className:"px-3 py-1.5 rounded text-xs bg-blue-600 text-white hover:bg-blue-700 shadow-sm flex items-center space-x-1 transition-colors",disabled:L,children:L?i.jsx("span",{children:"Saving..."}):i.jsxs(i.Fragment,{children:[i.jsx(Qs,{size:12}),i.jsx("span",{children:"Save Changes"})]})})]})]})]},`${C.type}-${C.originalDateString}-${Y}`))})]},V))})]})},gi=vi.memo(lh),ch="_modalOverlay_eh310_3",uh="_modalContent_eh310_29",dh="_modalHeader_eh310_61",ph="_modalTitle_eh310_79",hh="_modalCloseButton_eh310_91",mh="_modalBody_eh310_119",fh="_errorText_eh310_137",gh="_formGroup_eh310_155",yh="_inputField_eh310_179",xh="_searchResultsCard_eh310_221",bh="_searchResultsList_eh310_249",wh="_searchResultItem_eh310_261",kh="_searchResultPrice_eh310_297",_h="_selectedTestsCard_eh310_307",Nh="_selectedTestsHeader_eh310_327",vh="_noTestsMessage_eh310_343",jh="_selectedTestsList_eh310_359",Ch="_selectedTestItem_eh310_371",Sh="_selectedTestName_eh310_395",Th="_selectedTestPrice_eh310_407",Ph="_removeTestButton_eh310_419",Eh="_totalAmount_eh310_445",Ah="_modalFooter_eh310_463",Dh="_button_eh310_489",Ih="_buttonPrimary_eh310_507",Oh="_buttonSecondary_eh310_529",se={modalOverlay:ch,modalContent:uh,modalHeader:dh,modalTitle:ph,modalCloseButton:hh,modalBody:mh,errorText:fh,formGroup:gh,inputField:yh,searchResultsCard:xh,searchResultsList:bh,searchResultItem:wh,searchResultPrice:kh,selectedTestsCard:_h,selectedTestsHeader:Nh,noTestsMessage:vh,selectedTestsList:jh,selectedTestItem:Ch,selectedTestName:Sh,selectedTestPrice:Th,removeTestButton:Ph,totalAmount:Eh,modalFooter:Ah,button:Dh,buttonPrimary:Ih,buttonSecondary:Oh},$h=({isOpen:e,onClose:n,patientId:t,labInventory:r,fetchPendingLabOrdersData:s,isLoadingInventory:a=!1})=>{const[o,l]=b.useState([]),[c,u]=b.useState(""),[m,d]=b.useState([]),[y,p]=b.useState(null),[A,q]=b.useState(!1);Gs(void 0,e?200:99999);const K=b.useMemo(()=>new Ys(r,{keys:["name","description"],threshold:.3}),[r]);b.useEffect(()=>{if(!c){d([]);return}const W=K.search(c).map(F=>F.item);d(W.slice(0,10))},[c,K]);const $=async()=>{if(!t){p("Patient ID is missing.");return}if(o.length===0){p("Please select at least one lab test.");return}q(!0),p(null);try{const W={patient_id:t,tests:o.map(j=>({id:j.id,name:j.name,price:j.price}))},F=await G("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(W)});if(!F.ok){const j=await F.json().catch(()=>({}));throw new Error(j.message||`Failed to create lab order: ${F.statusText}`)}await F.json(),s(t),n(),l([]),u("")}catch(W){p(`Lab Order Creation Error: ${W.message}`)}finally{q(!1)}},H=W=>{if(o.some(F=>F.id===W.id)){p(`${W.name} is already in the order.`),setTimeout(()=>p(null),3e3),u(""),d([]);return}l(F=>[...F,{...W}]),u(""),d([])},L=W=>{l(F=>F.filter(j=>j.id!==W))};return e?i.jsx("div",{className:se.modalOverlay,children:i.jsxs("div",{className:se.modalContent,children:[i.jsxs("div",{className:se.modalHeader,children:[i.jsx("h3",{className:se.modalTitle,children:"Create New Lab Order"}),i.jsx("button",{onClick:n,className:se.modalCloseButton,children:i.jsx(fn,{size:20})})]}),i.jsxs("div",{className:se.modalBody,children:[y&&i.jsx("div",{className:se.errorText,children:y}),i.jsxs("div",{className:se.formGroup,style:{position:"relative"},children:[i.jsx("label",{htmlFor:"lab-test-search",children:"Add Lab Test"}),i.jsx("input",{type:"text",id:"lab-test-search",placeholder:"Search available lab tests...",value:c,onChange:W=>u(W.target.value),className:se.inputField}),c&&i.jsx("div",{className:se.searchResultsCard,children:a?i.jsx("div",{className:"p-2 space-y-2",children:[1,2,3].map(W=>i.jsxs("div",{className:"flex justify-between items-center py-2 px-3",children:[i.jsx(Te,{width:"60%",height:20}),i.jsx(Te,{width:"20%",height:20})]},W))}):m.length>0?i.jsx("ul",{className:se.searchResultsList,children:m.map(W=>i.jsxs("li",{onClick:()=>H(W),className:se.searchResultItem,children:[i.jsx("span",{children:W.name}),i.jsxs("span",{className:se.searchResultPrice,children:["(₹",parseFloat(String(W.price)).toFixed(2),")"]})]},W.id))}):i.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No tests found."})})]}),i.jsxs("div",{className:se.selectedTestsCard,children:[i.jsx("h4",{className:se.selectedTestsHeader,children:"Selected Tests"}),o.length===0?i.jsx("p",{className:se.noTestsMessage,children:"No tests added yet."}):i.jsx("ul",{className:se.selectedTestsList,children:o.map(W=>i.jsxs("li",{className:se.selectedTestItem,children:[i.jsx("span",{className:se.selectedTestName,children:W.name}),i.jsxs("span",{className:se.selectedTestPrice,children:["₹",parseFloat(String(W.price)).toFixed(2)]}),i.jsx("button",{type:"button",onClick:()=>L(String(W.id)),className:se.removeTestButton,title:"Remove Test",children:i.jsx(ft,{size:16})})]},W.id))})]}),o.length>0&&i.jsxs("div",{className:se.totalAmount,children:["Total: ₹",o.reduce((W,F)=>W+parseFloat(String(F.price)),0).toFixed(2)]})]}),i.jsxs("div",{className:se.modalFooter,children:[i.jsx("button",{type:"button",onClick:n,className:`${se.button} ${se.buttonSecondary}`,children:" Cancel "}),i.jsxs("button",{type:"button",onClick:$,disabled:o.length===0||A,className:`${se.button} ${se.buttonPrimary} ${o.length===0||A?se.buttonDisabled:""}`,children:[" ",A?"Saving...":"Create Lab Order"," "]})]})]})}):null},Lh=`You are an expert OPD (Outpatient Department) medical assistant for a Doctor in a clinic in India. You will receive all the medical data of the patient including complaints (history), labs, pharmacy orders, etc., along with their date and time. Your primary goal is to assist the doctor and analyze patient chief complaints (Co), provide a structured clinical assessment including lab test suggestions (Lx), differential diagnoses (Dx), and a treatment plan (Tx). You have access to tools (actions) to order lab tests and pharmacy items, and update patient details.



**1. Definitions:**
   - Co: Chief complaints
   - Pt: Patient (assume living in India)
   - Lx: Laboratory tests
   - Dx: Differential Diagnosis
   - Tx: Treatment Plan

**2. Workflow:**
   - Analyze Co, generate Lx, Dx, and Tx sections as described below.
   - **Prioritization for Orders:** Always prioritize using \`edit_pharmacy_order\` or \`edit_lab_order\` if there are existing pending orders for the patient, before considering \`create_pharmacy_order\` or \`create_lab_order\`.
   - using edit_lab_order edits the lab order with the given serial numnber use to add new tests to the existing order or remove the tests from existing order, marking the status affects all tests in the order not only the test,always use this tool if there are pending lab orders instead of creating new orders.
   - using edit_pharmacy_order edits the pharmacy order with the given serial numnber to add new items to the existing order, update existing items, or remove items (either by \`items_to_remove\` or by setting \`quantity\` to 0). Always use this tool if there are pending pharmacy orders instead of creating new orders.
   - using bill_lab_order will navigate the user to the billing page for the specific lab order. Use this when the user expresses intent to bill a lab order.
   - using create_and_bill_lab_order will create a new lab order and immediately bill it (navigating to the print/bill screen). Use this when the user says "create and bill", "order and bill", or similar for NEW tests.
   - using bill_pharmacy_order will bill an existing pharmacy order (identified by serial number).
   - using create_and_bill_pharmacy_order will create a new pharmacy order and immediately bill it. Use this when the user says "prescribe and bill", "order and bill meds", etc.
   - If your Lx section suggests tests from the inventory, use the \`create_lab_order\` action, but only for tests that are both clinically required and have not already been ordered or are still pending. Skip tests that are already ordered and in pending.
   - If your Tx section prescribes medications, use the \`create_pharmacy_order\` action — but only for medications that are clinically required and have not already been prescribed or are still pending. Skip medications that are already dispensed or already ordered.
   - If your Tx section prescribes medications that are *not* available in the inventory, use the \`prescription_for_unavailable_drugs\` parameter within the \`create_pharmacy_order\` action to specify the prescription details. **IMPORTANT:** This string MUST be a **Markdown table** with columns: 'Drug Name', 'Quantity', 'Dosage', 'Directions'. Do not use plain text.
   - When ordering pharmacy items, specify both \`pack_quantity\` (number of full packs) and \`loose_quantity\` (number of individual units). The system will handle the conversion based on the drug's pack size.
   - **Patient Details Management:** Always store or update patient name, age, sex, and phone number using the \`update_patient_details\` action. If patient name, age, or sex is received as 'New Patient - Direct Entry', 'N/A', or blank, treat it as missing data; if the user input provides anything resembling a name, age, or sex (e.g., shiva 25m, robin 50m, priya 19f), update them using the \`update_patient_details\` action. If details are missing, you can ask the user for the missing details using the \`ask_followup_question\` action.
   - Always update new complaints of the patient using the \`add_complaint_history\` action.
   - If you generate a concise summary of the patient's current situation based on the interaction and history, use the \`update_case_summary\` action to save it.
   - Remember, when you use \`update_case_summary\`, the previous case summary will be replaced by the new one, so you can use it like a short-term memory to store other stuff that **keeps changing**, like the current treatment plan, plan of action, active problems, or current vitals, etc.
   - When you use \`add_complaint_history\`, it will add the complaint to the previous ones. You will be given all the previous complaints back in every query, so you can use it to store other long-term facts that do **not change**, like the history of a chronic illness, surgical history, allergies, or social history, etc.
   - while placing or editing a pharmacy order make sure to set the \`pack_quantity\` and \`loose_quantity\` right.
   - Use the \`update_clinic_ai_memory\` action to store or update **various types of clinic-wide persistent information in a concise way**. This can include 'summaries of common patient encounters'+'summeries of previous **Clinic-wide AI Memory**'(e.g., 'Patient X, 50m, chronic gastritis, last visit YYYY-MM-DD, prescribed Z, follow-up in N days'+'**Clinic-wide AI Memory** summary'), notes on local health trends, common diagnostic patterns observed in the clinic, specific operational protocols. This memory is shared across all interactions for the clinic and helps tailor responses to its specific context over time.
    -   **Recurring Medications:**
        -   Use \`create_recurring_medication_order\` to add a new recurring medication.
        -   Use \`edit_recurring_medication_order\` to edit an existing recurring medication (using its serial number).
        -   Recurring medications are long-term prescriptions (e.g., for chronic conditions) that automatically re-order or remind.
    -   **Important: Preventing Loops** If you determine that no further actions are needed (e.g., you have already performed necessary actions, or the user's input does not require any specific action), you **MUST** use the \`end_task\` action. This explicitly signals that your task is complete and prevents the system from re-prompting you unnecessarily.
**3.**Multiple Actions:** You can perform multiple actions (like ordering labs AND meds, adding complaints, updating patient information, and asking a follow-up question) in a single response by including multiple action objects within the main JSON array.


**4. Chief Complaints (Co):**
   - Analyze the provided chief complaints.
   - Present them in a table with two columns: 'Relevant Complaint (Score 8-10)' and 'Irrelevant Complaint (Score 0-7)', based on clinical relevance.

**5. Lab Tests (Lx):**
   - Suggest the most probable basic lab tests based on the clinical picture, ordered by likelihood.
   - If a basic test is positive/abnormal, suggest relevant advanced tests.
   - **Inventory Check:** Compare suggested tests against the provided inventory list.
   - **Table 1: Available Lab Tests:** Present tests *available* in the inventory in a table with columns: '**Clinical Importance (High/Medium/Low)**', 'Lab Test'. If suggesting tests from this table, prepare to use the \`create_lab_order\` tool in your response.
   - **Table 2: Unavailable Lab Tests:** Present tests *not available* in the inventory in a separate table with columns: '**Clinical Importance (High/Medium/Low)**', 'Unavailable Basic Test'. Clearly state these are not orderable via the tool (generate Table 2 only when required tests are unavailable).

**6. Differential Diagnosis (Dx):**
   - List potential differential diagnoses.
   - Provide a confidence score (0-10) for each.
   - Present in a table with columns: 'Differential Diagnosis' and 'Confidence Score (0-10)'.

**7. Treatment Plan (Tx):**
   - Create a structured treatment plan including ideal medications based on the diagnosis.
   - **Inventory Check:** Compare prescribed medications against the provided inventory list.
   - **Table 1: Available Medications:** Present medications *available* in the inventory in a table with columns: 'Time Frame' (from and to dates), 'Treatment Goal', 'Intervention', 'Medication Type', 'Drug Form', 'Drug Name', 'Regimen (Dose, Freq)', 'Duration'. Before using the \`create_pharmacy_order\` tool, check if an order for the same drug has already been placed for this patient today. If an order already exists for today, do *not* create a duplicate order. If no order exists for today, prepare to use the \`create_pharmacy_order\` tool in your response.
   - **Table 2: Unavailable Medications:** Present medications *not available* in the inventory in a separate table with columns: 'Unavailable Drug Name', 'Ideal Regimen', 'Reasoning/Indication', '**Clinical Importance (High/Medium/Low)**', 'Suggested Available Substitute (from inventory, if possible)'. Clearly state these are not orderable via the tool (generate Table 2 only when required medications are unavailable in the inventory).

**8. Tools / Actions:**
   When you need to perform actions like ordering tests/meds, updating patient info, or adding history, use the following JSON array format. The response should ONLY contain this JSON array, nothing else.

   ****STRICT JSON****>>>>>>\`\`\`json
[
  { "action": "create_pharmacy_order", "items": [ { "name": "Drug Name", "pack_quantity": number, "loose_quantity": number, "tabletsPerDay": number | null, "numberOfDays": number | null, "directions_to_use": "string | null" } ], "prescription_for_unavailable_drugs": "string | null" },
  { "action": "edit_pharmacy_order", "serialNumber": number, "items": [ { "name": "Drug Name", "pack_quantity": number, "loose_quantity": number, "tabletsPerDay": number | null, "numberOfDays": number | null, "directions_to_use": "string | null" } ], "items_to_remove": [ { "drug_id": number | null, "name": "Drug Name" } ], "status": "pending" | "billed" | "dispensed" | "cancelled", "prescription_for_unavailable_drugs": "string | null" },
  { "action": "bill_pharmacy_order", "serialNumber": number },
  { "action": "create_and_bill_pharmacy_order", "items": [ { "name": "Drug Name", "pack_quantity": number, "loose_quantity": number, "tabletsPerDay": number | null, "numberOfDays": number | null, "directions_to_use": "string | null" } ], "prescription_for_unavailable_drugs": "string | null" },
  { "action": "create_lab_order", "tests": [ { "name": "Test Name" } ] },
  { "action": "edit_lab_order", "serialNumber": number, "tests": [ { "name": "Test Name" } ], "items_to_remove": [ { "id": number | string | null, "name": "Test Name" } ], "status": "pending" | "billed" | "collected" | "processing" | "report_ready" | "completed" | "cancelled" | "reported" },
  { "action": "create_lab_report", "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "edit_lab_report", "serialNumber": number, "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "create_lab_report", "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "edit_lab_report", "serialNumber": number, "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "edit_lab_order_and_create_report", "serialNumber": number, "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ], "items_to_remove": [ { "id": number | string | null, "name": "Test Name" } ] },
  { "action": "create_and_bill_lab_order", "tests": [ { "name": "Test Name" } ] },
  { "action": "add_complaint_history", "complaint": "Specific past complaint text..." },
  { "action": "update_patient_details", "name": "New Name (optional)", "age": number (optional), "gender": "M" | "F" | "O" | null (optional), "phone_number": "string (optional)" },
  { "action": "update_case_summary", "summary": "Concise summary text..." },
  { "action": "update_clinic_ai_memory", "memory_content": "New clinic-wide AI memory content..." },
  { "action": "create_recurring_medication_order", "items": [ { "medication_name": "Drug Name", "drug_id": "string | null", "quantity": number, "frequency_days": number, "next_delivery_date": "YYYY-MM-DD", "tablets_per_day": number | null, "number_of_days": number | null, "directions": "string | null", "notes": "string | null" } ] },
  { "action": "edit_recurring_medication_order", "serialNumber": number, "updates": { "medication_name": "string (opt)", "quantity": number, "frequency_days": number, "status": "active" | "paused" | "stopped", "next_delivery_date": "YYYY-MM-DD", "number_of_days": number, "tablets_per_day": number, "directions": "string" } },
  { "action": "end_task" }
]
\`\`\`

   - **Multiple Actions in One Response:** You can include multiple action objects within this single JSON array if several actions are required based on your analysis (e.g., adding history AND ordering labs).
   - **Prioritization Within the Array:** If including multiple actions, order them within the array according to this priority:
     1. \`add_complaint_history\`
     2. \`update_patient_details\`
     3. \`update_case_summary\`
     4. \`update_clinic_ai_memory\`
     5. \`create_lab_order\`
     6. \`edit_lab_order\`
     7. \`create_pharmacy_order\`
     8. \`edit_pharmacy_order\`
     9. \`bill_lab_order\`
   - **Structure:**
     The AI response can be a flat array of actions OR a list of "function call" objects containing grouped actions.
     **Option 1: Flat Array (Simple)**
     \`\`\`json
     [
       { "action": "add_complaint_history", ... },
       { "action": "create_lab_order", ... }
     ]
     \`\`\`
     **Option 2: Grouped Function Calls (Complex)**
     You can group actions under logical "function calls" if needed.
     \`\`\`json
     [
       {
         "function_call": "assess_patient",
         "actions": [
           { "action": "ask_followup_question", "question": "..." }
         ]
       },
       {
         "function_call": "prescribe_treatment",
         "actions": [
            { "action": "create_pharmacy_order", "items": [...] },
            { "action": "create_lab_order", "tests": [...] }
         ]
       }
     ]
     \`\`\`

   - **Example (Multiple Actions):**
     \`\`\`json
     [
       { "action": "add_complaint_history", "complaint": "Patient also reports mild fever since yesterday." },
       { "action": "create_lab_order", "tests": [ { "name": "CBC" } ] }
     ]
     \`\`\`

   - **\`ask_followup_question\`**: Use this action (either standalone or inside a group) only when you need clarification.
     \`\`\`json
     {
       "action": "ask_followup_question",
       "question": "Your clear, specific question here.",
       "options": ["Optional Answer 1", "Optional Answer 2"]
     }
     \`\`\`
     *Description:* Ask the user a question to gather additional information needed to complete the task. This tool should be used when you encounter ambiguities, need clarification, or require more details to proceed effectively. It allows for interactive problem-solving by enabling direct communication with the user. Use this tool judiciously to maintain a balance between gathering necessary information and avoiding excessive back-and-forth.
     *Parameters:*
       - question: (required) The question to ask the user. This should be a clear, specific question that addresses the information you need.
       - options: (optional) An array of 2-5 options for the user to choose from. Each option should be a string describing a possible answer. You may not always need to provide options, but it may be helpful in many cases where it can save the user from having to type out a response manually.
   - **\`bill_lab_order\`**: Use this action when the intention is to proceed to billing for a specific lab order.
     \`\`\`json
     { "action": "bill_lab_order", "serialNumber": number }
     \`\`\`
     *Description:* Initiates the billing process for a specific lab order, helping the user navigate to the billing screen.
     *Parameters:*
       - serialNumber: (required) The serial number of the lab order to bill.


**Important:**
- Ensure all tables are clearly formatted using Markdown.
- Strictly adhere to the inventory constraints for labs and medications when deciding whether to use \`create_lab_order\` or \`create_pharmacy_order\`.
- When using actions, provide ONLY the JSON array (or the single JSON object for \`ask_followup_question\`) as the *very last* part of your response, after all other content including tables. Do not include any other text after the JSON.

**Plan Mode:**
When the user asks a question about a patient's condition or general medical topics (not entering new medical data), respond in PLAN MODE. In this mode, focus on answering the user's inquiry, clarifying their request, brainstorming ideas, or architecting a solution (like exploring treatment options). Ask clarifying questions if needed. Present detailed plans or explanations **using clear table formats and markdown (like bolding) for easy readability**. Engage in back-and-back discussion to finalize details. Do not use action tools (\`create_lab_order\`, \`create_pharmacy_order\`, \`add_complaint_history\`, \`update_patient_details\`) while in PLAN MODE).`,Ps="AIzaSyBEt7v-LxBxAKwpTCtkI-3IshYxdnEqbes",Rh="models/gemini-3-flash-preview";async function Fh(){if(!sc())return console.warn("No auth token found, using default Gemini API key."),Ps;let n=null;try{const t=await G("/api/clinics/settings");if(t.ok){const r=await t.json();r.gemini_api_key&&r.gemini_api_key.trim()!==""&&(n=r.gemini_api_key.trim())}}catch(t){console.warn("Could not fetch clinic settings (or key missing), proceeding to global fallback.",t)}if(n)return n;try{const t=await G("/api/global-settings/app_gemini_api_key");if(t.ok){const s=(await t.json()).value;if(s&&s.trim()!=="")return s.trim()}}catch(t){console.warn("Could not fetch global API key.",t)}return console.warn("Clinic-specific and global Gemini API keys not found, using default env var."),Ps}let yi=null;async function zh(){if(!yi){const e=await Fh();yi=new ac({apiKey:e})}return yi}async function qh(e,n){const{query:t,currentDateTime:r,patientName:s,patientAge:a,patientGender:o,case_summary:l,case_summary_last_updated:c,clinic_ai_memory:u,clinic_ai_memory_last_updated:m,clinic_wide_system_prompt:d,labHistory:y,pharmacyOrders:p,pastComplaints:A,pharmacyInventory:q,labInventory:K,recurringMedications:$}=e;let H=`Patient Complaint: ${t}`;if(l&&(H+=`

--- Case Summary (Provided by Doctor) ---
${l}`,c))try{const _=new Date(c).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"});H+=`
(Last Updated: ${_})`}catch{console.warn(`Could not format case_summary_last_updated: ${c}`),H+=`
(Last Updated: ${c})`}if(s&&(H+=`

Patient Name: ${s}`),a!=null&&(H+=`
Patient Age: ${a}`),o&&(H+=`
Patient Gender: ${o}`),r)try{const _=new Date(r).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"});H+=`

Current Interaction Time: ${_}`}catch{console.warn(`Could not format currentDateTime: ${r}`),H+=`

Current Interaction Time: ${r}`}if(u&&(H+=`

--- Clinic-wide AI Memory/Context ---
${u}`,m))try{const _=new Date(m).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"});H+=`
(Last Updated: ${_})`}catch{console.warn(`Could not format clinic_ai_memory_last_updated: ${m}`),H+=`
(Last Updated: ${m})`}let L="";y&&Array.isArray(y)&&y.length>0&&(L=`

--- Lab History (Orders & Reports) ---
`,y.forEach(_=>{let C="Unknown Date";try{C=new Date(_.orderDate).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date for lab order: ${_.orderDate}`)}if(L+=`
Order #${_.serialNumber} Date: ${C} (Status: ${_.status})
`,L+=`Tests: ${_.tests.map(Y=>Y.name).join(", ")}
`,_.report){let Y="Unknown Date";try{Y=new Date(_.report.reportDate).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date for lab report: ${_.report.reportDate}`)}L+=`  -> Report Date: ${Y}
`,_.report.tests&&Array.isArray(_.report.tests)?(L+=`     Findings:
`,_.report.tests.forEach(E=>{L+=`       - Test: ${E.testName}
`,E.parameters&&Array.isArray(E.parameters)&&E.parameters.forEach(U=>{L+=`         - ${U.name}: ${U.value} (Normal: ${U.normal_range})
`})})):(L+=`     Findings: ${_.report.reportContent||"N/A"}
`,_.report.error&&(L+=`     Note: ${_.report.error}
`))}L+=`---
`}),H+=L);let W="";p&&Array.isArray(p)&&p.length>0&&(W=`

--- Recent Pharmacy Orders ---
`,p.forEach(_=>{let C="Unknown Date/Time";try{C=new Date(_.date).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date/time for pharmacy order: ${_.date}`)}W+=`
Order #${_.serialNumber} Date/Time: ${C} (Status: ${_.status})
`,W+=`Prescribed By: ${_.prescribedBy||"N/A"}
`,_.dispensedBy&&(W+=`Dispensed By: ${_.dispensedBy}
`),W+=`Medications:
`,_.medications.forEach(Y=>{W+=`  - ${Y.name} (Qty: ${Y.quantity}`,Y.tabletsPerDay&&(W+=`, ${Y.tabletsPerDay}/day`),Y.numberOfDays&&(W+=` for ${Y.numberOfDays} days`),W+=`)
`}),_.prescriptionForUnavailableDrugs&&(W+=`  Prescription for Unavailable Drugs: ${_.prescriptionForUnavailableDrugs}
`),W+=`---
`}),H+=W);let F="";$&&Array.isArray($)&&$.length>0&&(F=`

--- Recurring Medications (Active) ---
`,$.forEach((_,C)=>{let Y=`${C+1}. ${_.medicationName} (${_.frequencyDays} days)`;if(_.tabletsPerDay&&(Y+=` - ${_.tabletsPerDay} tabs/day`),_.numberOfDays&&(Y+=` for ${_.numberOfDays} days`),Y+=` [Status: ${_.status}]`,_.nextDeliveryDate)try{const E=new Date(_.nextDeliveryDate).toLocaleDateString();Y+=` (Next: ${E})`}catch{}F+=`${Y}
`}),H+=F);let j="";A&&Array.isArray(A)&&A.length>0&&(j=`

--- Past Complaints History ---
`,A.forEach(_=>{let C="Unknown Date/Time";try{C=new Date(_.createdAt).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date/time for past complaint: ${_.createdAt}`)}j+=`
Date/Time: ${C}
Complaint: ${_.complaint||"N/A"}
---
`}),H+=j);let Z="";q&&Array.isArray(q)&&q.length>0&&(Z=`

--- Current Pharmacy Inventory (Stock Levels) ---
`,q.forEach(_=>{let C=`${_.stock??0} packs`;_.loose!==void 0&&_.loose!==null&&_.loose>0&&(C+=`, ${_.loose} loose`);let Y=`- ${_.name} (Pack: ${_.pack??"N/A"}): ${C}`;const E=[];_.brand_name&&E.push(`Brand: ${_.brand_name}`),_.batch&&E.push(`Batch: ${_.batch}`),_.expiry_date&&E.push(`Exp: ${_.expiry_date}`),E.length>0&&(Y+=` [${E.join(", ")}]`),Z+=`${Y}
`}),H+=Z);let ce="";K&&Array.isArray(K)&&K.length>0&&(ce=`

--- Available Lab Tests (with Parameters) ---
`,K.forEach(_=>{ce+=`- ${_.name} (Price: ${_.price??"N/A"})
`,_.default_parameters&&Array.isArray(_.default_parameters)&&_.default_parameters.length>0&&_.default_parameters.forEach(C=>{let Y=`    * ${C.name}`;C.unit&&(Y+=` (${C.unit})`),C.normal_range?Y+=` [Normal: ${C.normal_range}]`:C.lower_limit!==void 0&&C.upper_limit!==void 0&&C.lower_limit!==null&&C.upper_limit!==null&&(Y+=` [Normal: ${C.lower_limit} - ${C.upper_limit}]`),ce+=`${Y}
`})}),H+=ce);const ne=[{text:Lh}];d&&d.trim()!==""&&ne.push({text:`--- Additional Clinic-Specific Instructions ---
${d}`});const le=[{text:H}];if(n){const _=new FileReader,C=await new Promise((Y,E)=>{_.onloadend=()=>{typeof _.result=="string"?Y(_.result.split(",")[1]):E(new Error("Failed to read image file as base64."))},_.onerror=E,_.readAsDataURL(n)});le.push({inlineData:{mimeType:n.type,data:C}})}const V=[];ne.length>0&&V.push({role:"user",parts:ne}),V.push({role:"user",parts:le});try{const _={model:Rh,contents:V,generationConfig:{temperature:.7,maxOutputTokens:1024,responseMimeType:"text/plain"}},Y=await(await zh()).models.generateContentStream(_);let E="";for await(const U of Y)if(U&&typeof U.text=="function"){const J=U.text;J&&(E+=J)}else U&&U.candidates&&U.candidates[0]&&U.candidates[0].content&&U.candidates[0].content.parts&&U.candidates[0].content.parts[0]&&U.candidates[0].content.parts[0].text&&(E+=U.candidates[0].content.parts[0].text);if(E&&E.trim()!=="")return E.trim();throw console.error("Empty or invalid response received from Gemini API stream."),new Error("Failed to get suggestion from AI (Gemini). Empty or invalid stream response.")}catch(_){console.error("Error calling Gemini API:",_);let C="Failed to get suggestion from Gemini.";throw _.message&&(C=`Error processing Gemini request: ${_.message}`),new Error(C)}}const xi=e=>{if(!e)return 1;const n=e.match(/(?:\d+x)?(\d+)(?:s|tabs)?/i);return n?parseInt(n[1],10):1},Bh=b.forwardRef(({recordId:e,patientId:n,patientDetails:t,caseSummary:r,caseSummaryUpdatedAt:s,clinicSettings:a,userMessages:o,selectedImageFile:l,pendingLabOrders:c,labReports:u,pastComplaints:m,pharmacyOrders:d,pharmacyInventory:y,labInventory:p,recurringMedications:A,currentComplaint:q,setCurrentComplaint:K,setAiResponse:$,setAiResponseText:H,setAiResponseJsonString:L,setShowAiJsonDetails:W,setIsLoadingAi:F,setAiError:j,setIsSubmittingAiOrder:Z,setAiOrderSubmissionStatus:ce,setIsSubmittingAiLabOrder:ne,setAiLabOrderSubmissionStatus:le,setIsSubmittingAiComplaint:V,setAiComplaintSubmissionStatus:_,setIsUpdatingCaseSummary:C,setAiCaseSummaryUpdateStatus:Y,setCaseSummary:E,setIsUpdatingAiMemoryByAI:U,setAiMemoryUpdateByAIStatus:J,setFollowUpQuestion:Se,setFollowUpOptions:pe,setError:w,setIsSavingAiResponse:Fe,setSaveAiResponseError:we,fetchPharmacyOrdersData:x,fetchPendingLabOrdersData:De,fetchLabReportsData:He,fetchRecurringMedicationsData:ke,fetchPastComplaintsData:at,fetchPatientDetails:Re,setClinicSettings:et,setEditedAiMemory:st,setCanUndo:tt,onAiActionSuccess:Yt,addMessage:v,onPrintLabBill:Dt,onPrintPharmacyBill:Nt},Kt)=>{const[dt,gt]=vi.useState(null);vi.useEffect(()=>{tt(!!dt)},[dt,tt]);let Je;const vt=async($e,T,P,S=0)=>{let ee;const Le=["AI response did not contain a recognized function call","AI response did not result in a recognized or performed function call"].some(Me=>{var ve;return(ve=T.message)==null?void 0:ve.includes(Me)});P&&Le?ee=`AI Error: ${T.message}

${P}`:(ee=`I encountered a frontend error while trying to execute the '${$e}' function. The error message is: "${T.message}". Based on this error, please analyze what went wrong and either correct the function call and try again, or explain the problem.`,($e==="create_pharmacy_order"||$e==="edit_pharmacy_order")&&(ee+=`

IMPORTANT: When ordering medication, please first check if the medication ordered matches the exact name given in the inventory. If the name itself is not given in the inventory, you can use 'prescription_for_unavailable_drugs' to write a prescription. **NOTE:** This field MUST be formatted as a Markdown table (columns: Drug Name, Quantity, Dosage, Directions).`),P&&(ee+=`

The original AI response that caused the error was:
\`\`\`
${P}
\`\`\``)),v==null||v({role:"system",type:"error",content:`AI Error: ${T.message}. Retrying...`}),await Je(ee,S+1)},Ut=async $e=>{console.log("Executing Rollback for actions:",$e);for(const T of $e){const{actionType:P,undoData:S}=T;if(console.log(`Attempting to rollback ${P}`,S),!S){console.warn(`No undoData found for action ${P}, skipping.`);continue}try{if(P==="create_pharmacy_order")S!=null&&S.orderId?(console.log(`Deleting pharmacy order ${S.orderId}`),await G(`/api/pharmacy-orders/${S.orderId}`,{method:"DELETE"}),x(n)):console.error("Missing orderId for create_pharmacy_order rollback");else if(P==="create_lab_order")S!=null&&S.orderId?(console.log(`Deleting lab order ${S.orderId}`),await G(`/api/lab/orders/${S.orderId}`,{method:"DELETE"}),De(n)):console.error("Missing orderId for create_lab_order rollback");else if(P==="update_patient_details")if(S!=null&&S.patientId&&(S!=null&&S.originalDetails)){console.log(`Reverting patient details for ${S.patientId}`);const ee=S.originalDetails,ue={name:ee.name,age:ee.age,gender:ee.gender,phone:ee.phone,ai_response:ee.ai_response};await G(`/api/patients/${S.patientId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ue)}),Re(S.patientId)}else console.error("Missing patientId or originalDetails for update_patient_details rollback");else if(P==="add_complaint_history")S!=null&&S.recordId?(console.log(`Reverting complaint history for ${S.recordId}`),await G(`/api/queue/doctor/complaint/${S.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:S.originalComplaint||""})}),K(S.originalComplaint||"")):console.error("Missing recordId for add_complaint_history rollback");else if(P==="update_case_summary")S!=null&&S.recordId?(console.log(`Reverting case summary for ${S.recordId}`),await G(`/api/queue/doctor/complaint/${S.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({case_summary:S.originalSummary||""})}),E(S.originalSummary||"")):console.error("Missing recordId for update_case_summary rollback");else if(P==="update_clinic_ai_memory")(S==null?void 0:S.originalMemory)!==void 0?(console.log("Reverting AI memory"),await G("/api/clinics/settings",{method:"PUT",body:JSON.stringify({...a,aiMemory:S.originalMemory})}),st(S.originalMemory)):console.error("Missing originalMemory for update_clinic_ai_memory rollback");else if(P==="edit_pharmacy_order")if(S!=null&&S.orderId&&(S!=null&&S.originalState)){console.log(`Reverting pharmacy order ${S.orderId}`);const ee={items:S.originalState.medications||[],status:S.originalState.status,prescription_for_unavailable_drugs:S.originalState.prescription_for_unavailable_drugs,order_total:S.originalState.order_total};await G(`/api/pharmacy-orders/${S.orderId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ee)}),x(n)}else console.error("Missing orderId or originalState for edit_pharmacy_order rollback");else if(P==="edit_lab_order")if(S!=null&&S.orderId&&(S!=null&&S.originalState)){console.log(`Reverting lab order ${S.orderId}`);const ee={tests:S.originalState.tests,status:S.originalState.status};await G(`/api/lab/orders/${S.orderId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ee)}),De(n)}else console.error("Missing orderId or originalState for edit_lab_order rollback");else if(P==="create_recurring_medication_order")if(S!=null&&S.createdIds&&S.createdIds.length>0){console.log(`Deleting recurring medications: ${S.createdIds.join(", ")}`);for(const ee of S.createdIds)await G(`/api/recurring-medications/${ee}`,{method:"DELETE"});n&&ke&&ke(n)}else console.error("Missing createdIds for create_recurring_medication_order rollback");else P==="edit_recurring_medication_order"?S!=null&&S.medicationId&&(S!=null&&S.originalState)?(console.log(`Reverting recurring medication ${S.medicationId}`),await G(`/api/recurring-medications/${S.medicationId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(S.originalState)}),n&&ke&&ke(n)):console.error("Missing medicationId or originalState for edit_recurring_medication_order rollback"):console.warn(`Unknown action type for rollback: ${P}`)}catch(ee){console.error(`Failed to rollback ${P}:`,ee)}}},Xt=async()=>{!dt||!window.confirm("Are you sure you want to undo the last AI actions?")||(F(!0),await Ut([...dt].reverse()),gt(null),F(!1),j("Last actions undone successfully."))},We=async($e,T)=>{gt(null),ce(null),le(null),_(null),Y(null),J(null),Se(null),pe([]),w(null);let P=null;const S=/```json\s*([\s\S]*?)\s*```/,ee=$e.match(S);if(ee&&ee[1])P=ee[1];else{const ue=$e.trim();if(ue.startsWith("{")&&ue.endsWith("}"))P=ue;else if(ue.startsWith("[")&&ue.endsWith("]"))P=ue;else throw new Error("AI response did not contain a recognized function call.")}if(P)try{const ue=JSON.parse(P),Le=D=>{const z=[],O=Array.isArray(D)?D:[D];for(const I of O)I&&(I.actions&&Array.isArray(I.actions)?z.push(...Le(I.actions)):I.sub_actions&&Array.isArray(I.sub_actions)?z.push(...Le(I.sub_actions)):I.function_calls&&Array.isArray(I.function_calls)?z.push(...Le(I.function_calls)):typeof I.action=="string"&&z.push(I));return z},Me=Le(ue),ve=[];let Ve=null,Qe=!1;for(const D of Me){if(D.action==="ask_followup_question"){Ve=D,Qe=!0;continue}Qe=!0;const z=D.action;if(z==="update_clinic_ai_memory"&&typeof D.memory_content=="string")ve.push((async()=>{U(!0),J("Processing AI mem..."),v==null||v({role:"system",type:"loading",content:"Processing AI memory..."});const O=(a==null?void 0:a.aiMemory)||"";try{if(!a)throw new Error("Clinic settings not loaded.");const I={...a,aiMemory:D.memory_content.trim(),admissionCharge:a.admissionCharge,perDayCharge:a.perDayCharge,otherCharges:a.otherCharges,clinicWideSystemPrompt:a.clinicWideSystemPrompt},ie=await G("/api/clinics/settings",{method:"PUT",body:JSON.stringify(I)});if(!ie.ok){const R=await ie.json().catch(()=>({}));throw new Error(R.message||`AI-triggered clinic memory update failed: ${ie.statusText}`)}const re=await ie.json();return et(R=>R?{...R,aiMemory:re.settings.aiMemory}:null),st(re.settings.aiMemory||""),J("AI mem updated!"),v==null||v({role:"system",type:"success",content:"AI memory updated successfully."}),{success:!0,actionType:z,undoData:{originalMemory:O}}}catch(I){return J("Failed"),{success:!1,actionType:z,error:I,originalActionPayload:D}}finally{U(!1)}})());else if(z==="create_pharmacy_order")ve.push((async()=>{var O,I;Z(!0),ce("Processing order..."),v==null||v({role:"system",type:"loading",content:"Processing pharmacy order..."});try{if(!n)throw new Error("Missing patient ID.");const ie=[];let re=null;if(Array.isArray(D.items))for(const ae of D.items){let me;if(ae.drug_id?me=y.find(Ee=>Ee.id===ae.drug_id):ae.name&&(me=At(ae.name,y)),!me){re=`Drug "${ae.name||ae.drug_id}" not found.`;break}const de=xi(me.pack),M=Number(me.mrp),X=M,xe=de>0?M/de:0,qe=Number(ae.pack_quantity)||0,oe=Number(ae.loose_quantity)||0,Ne=qe*X+oe*xe;ie.push({drug_id:String(me.id),name:me.name,pack_quantity:qe,loose_quantity:oe,tabletsPerDay:ae.tabletsPerDay,numberOfDays:ae.numberOfDays,directions_to_use:ae.directions_to_use,group_id:ae.group_id,pack_price:X,loose_price:xe,total_price:Ne,price:M,isLoose:ae.isLoose,unit:me.pack})}if(re)throw new Error(re);const R=ie.reduce((ae,me)=>ae+me.total_price,0),he={patient_id:n,items:ie,prescription_for_unavailable_drugs:D.prescription_for_unavailable_drugs,order_total:parseFloat(R.toFixed(2))},je=await G("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(he)});if(!je.ok){const ae=await je.json().catch(()=>({}));throw new Error(ae.message||"Order creation failed.")}const ye=await je.json();return ce("Order created!"),x(n),v==null||v({role:"system",type:"success",content:"Pharmacy order created successfully."}),{success:!0,actionType:z,data:ye,undoData:{orderId:((I=(O=ye.orders)==null?void 0:O[0])==null?void 0:I.id)||ye.id}}}catch(ie){return v==null||v({role:"system",type:"error",content:`Pharmacy order failed: ${ie.message}`}),{success:!1,actionType:z,error:ie,originalActionPayload:D}}finally{Z(!1)}})());else if(z==="bill_pharmacy_order")ve.push((async()=>{Z(!0),ce("Billing Pharmacy Order...");try{const O=D.serialNumber;if(!O)throw new Error("Missing serial number for billing.");if(!n)throw new Error("Missing patient ID.");const I=new Map;(d??[]).forEach(M=>I.set(M.id,{...M}));const ie=Array.from(I.values()).sort((M,X)=>new Date(X.date).getTime()-new Date(M.date).getTime()),re=ie.length-O,R=ie[re];if(!R)throw new Error(`Pharmacy order #${O} not found.`);if(R.status==="billed"||R.status==="dispensed")throw new Error(`Order #${O} is already billed.`);const he=R.medications.map(M=>{let X;M.drug_id?X=y.find(Ge=>String(Ge.id)===String(M.drug_id)):X=y.find(Ge=>Ge.name.toLowerCase()===M.name.toLowerCase());const xe=Number(M.pack_price)||Number(X==null?void 0:X.mrp)||0,qe=xi(M.unit||(X==null?void 0:X.pack)),oe=Number(M.loose_price)||(qe>0?xe/qe:0),Ne=(M.pack_quantity||0)*qe+(M.loose_quantity||0);let Ee=Number(M.total_price);return Ee||(Ee=Ne*oe),{...M,price:Ee,mrp:xe,pack_quantity:M.pack_quantity,loose_quantity:M.loose_quantity,expiry_date:M.expiry_date||(X==null?void 0:X.expiry_date),batch:M.batch||(X==null?void 0:X.box_number)}}),je=he.reduce((M,X)=>M+X.price,0),ye=je,ae={patientId:n,queueId:R.id,items:he.map(M=>({name:M.name,pack_quantity:M.pack_quantity,loose_quantity:M.loose_quantity,price:M.mrp,pack_price:M.mrp,loose_price:M.loose_price,total:M.price,drug_id:M.drug_id,discount_percentage:0,batch:M.batch,expiry_date:M.expiry_date})),amount:ye,paymentMode:"cash",type:"pharmacy",related_id:R.id,status:"paid",discountPercentage:0},me=await G("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)}),de=await me.json();if(!me.ok)throw new Error(de.message||"Failed to create pharmacy bill");return await G(`/api/pharmacy-orders/${R.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:de.id,medications:he})}),ce("Billed Successfully!"),x(n),Nt&&Nt({billId:de.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:R.date,items:he,subtotal:je,totalDiscount:0,grandTotal:ye,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||""}),v==null||v({role:"system",type:"success",content:`Pharmacy order #${R.id} billed.`}),{success:!0,actionType:z,data:de}}catch(O){return v==null||v({role:"system",type:"error",content:`Billing failed: ${O.message}`}),{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{Z(!1)}})());else if(z==="create_and_bill_pharmacy_order")ve.push((async()=>{Z(!0),ce("Processing & Billing..."),v==null||v({role:"system",type:"loading",content:"Prescribing and billing..."});let O=null;try{if(!n)throw new Error("Missing patient ID.");const I=[];let ie=null;if(Array.isArray(D.items))for(const X of D.items){let xe;if(X.drug_id?xe=y.find(lt=>lt.id===X.drug_id):X.name&&(xe=At(X.name,y)),!xe){ie=`Drug "${X.name}" not found.`;break}const qe=xi(xe.pack),oe=Number(xe.mrp),Ne=oe,Ee=qe>0?oe/qe:0,Ge=Number(X.pack_quantity)||0,ot=Number(X.loose_quantity)||0,yt=Ge*Ne+ot*Ee;I.push({drug_id:String(xe.id),name:xe.name,pack_quantity:Ge,loose_quantity:ot,tabletsPerDay:X.tabletsPerDay,numberOfDays:X.numberOfDays,directions_to_use:X.directions_to_use,group_id:X.group_id,pack_price:Ne,loose_price:Ee,total_price:yt,price:oe,mrp:oe,isLoose:X.isLoose,unit:xe.pack,batch:xe.box_number,expiry_date:xe.expiry_date})}if(ie)throw new Error(ie);const re=I.reduce((X,xe)=>X+xe.total_price,0),R={patient_id:n,items:I,prescription_for_unavailable_drugs:D.prescription_for_unavailable_drugs,order_total:parseFloat(re.toFixed(2))},he=await G("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(R)});if(!he.ok)throw new Error("Order creation failed.");const je=await he.json(),ye=je.orders?je.orders[0]:je;O=ye.id;const ae=re,me={patientId:n,queueId:ye.id,items:I.map(X=>({name:X.name,pack_quantity:X.pack_quantity,loose_quantity:X.loose_quantity,price:X.mrp,pack_price:X.mrp,loose_price:X.loose_price,total:X.total_price,drug_id:X.drug_id,discount_percentage:0,batch:X.batch,expiry_date:X.expiry_date})),amount:ae,paymentMode:"cash",type:"pharmacy",related_id:ye.id,status:"paid",discountPercentage:0},de=await G("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(me)}),M=await de.json();if(!de.ok)throw new Error("Billing failed.");return await G(`/api/pharmacy-orders/${ye.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:M.id,medications:I})}),ce("Ordered & Billed!"),x(n),Nt&&Nt({billId:M.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:new Date().toISOString(),items:I.map(X=>({...X,price:X.total_price})),subtotal:ae,totalDiscount:0,grandTotal:ae,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||""}),v==null||v({role:"system",type:"success",content:`Pharmacy order #${ye.id} created and billed.`}),{success:!0,actionType:z,data:ye,undoData:{orderId:ye.id}}}catch(I){return v==null||v({role:"system",type:"error",content:`Create & Bill failed: ${I.message}`}),{success:!1,actionType:z,error:I,originalActionPayload:D,undoData:O?{orderId:O}:void 0}}finally{Z(!1)}})());else if(z==="update_patient_details")ve.push((async()=>{F(!0),v==null||v({role:"system",type:"loading",content:"Updating patient details..."});const O={...t};try{if(!n)throw new Error("Missing patient ID.");const I={};if(D.name&&(I.name=D.name),D.age&&(I.age=D.age),D.gender&&(I.gender=D.gender),D.phone_number!==void 0&&(I.phone_number=D.phone_number),!(await G(`/api/patients/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(I)})).ok)throw new Error("Patient update failed.");return Re(n),v==null||v({role:"system",type:"success",content:"Patient details updated."}),{success:!0,actionType:z,undoData:{patientId:n,originalDetails:O}}}catch(I){return{success:!1,actionType:z,error:I,originalActionPayload:D}}finally{F(!1)}})());else if(z==="create_lab_order")ve.push((async()=>{ne(!0),le("Processing lab..."),v==null||v({role:"system",type:"loading",content:"Processing lab order..."});try{if(!n)throw new Error("Missing patient ID.");const O=[];for(const re of D.tests||[]){let R;if(re.id?R=p.find(he=>String(he.id)===String(re.id)):re.name&&(R=At(re.name,p)),!R)throw new Error(`Lab test "${re.name}" not found.`);O.push({id:R.id,name:R.name,price:Number(R.price)})}const I=await G("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,tests:O})});if(!I.ok)throw new Error("Lab order creation failed.");const ie=await I.json();return le("Success!"),De(n),v==null||v({role:"system",type:"success",content:"Lab order created."}),{success:!0,actionType:z,data:ie.labOrder,undoData:{orderId:ie.labOrder.id}}}catch(O){return v==null||v({role:"system",type:"error",content:`Lab order failed: ${O.message}`}),{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="create_and_bill_lab_order")ve.push((async()=>{ne(!0),le("Processing & Billing..."),v==null||v({role:"system",type:"loading",content:"Creating and billing lab order..."});let O=null;try{if(!n)throw new Error("Missing patient ID.");const I=[];for(const M of D.tests||[]){let X;if(M.id?X=p.find(xe=>String(xe.id)===String(M.id)):M.name&&(X=At(M.name,p)),!X)throw new Error(`Lab test "${M.name}" not found.`);I.push({id:X.id,name:X.name,price:Number(X.price)})}const ie=await G("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,tests:I})});if(!ie.ok)throw new Error("Lab order creation failed.");const R=(await ie.json()).labOrder;O=R.id,v==null||v({role:"system",type:"loading",content:`Order #${R.id} created. Generating bill...`});const he=I.map(M=>({name:M.name,price:typeof M.price=="string"?parseFloat(M.price):M.price||0,discount_percentage:0,quantity:1,item_id:M.id,type:"lab_test"})),je=he.reduce((M,X)=>M+X.price,0),ye=je,ae={patientId:n,items:he.map(M=>({...M,total:M.price})),amount:ye,paymentMode:"cash",type:"lab",related_id:R.id,status:"paid",discountPercentage:0},me=await G("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)}),de=await me.json();if(!me.ok)throw new Error(de.message||"Failed to create bill");return await G(`/api/lab/${R.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:de.id})}),le("Success & Billed!"),De(n),Dt&&Dt({billId:de.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:R.createdAt,items:he,subtotal:je,totalDiscount:0,grandTotal:ye,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||"",labLetterheadUrl:a==null?void 0:a.labLetterheadUrl}),v==null||v({role:"system",type:"success",content:`Lab order #${R.id} created and billed. Opening print dialog.`}),{success:!0,actionType:z,data:R,undoData:{orderId:R.id}}}catch(I){return v==null||v({role:"system",type:"error",content:`Create and Bill failed: ${I.message}`}),{success:!1,actionType:z,error:I,originalActionPayload:D,undoData:O?{orderId:O}:void 0}}finally{ne(!1)}})());else if(z==="create_lab_report")ve.push((async()=>{ne(!0),le("Creating Report..."),v==null||v({role:"system",type:"loading",content:"Creating lab report..."});try{if(!n)throw new Error("Missing patient ID.");const O=[],I=D.tests||[];for(const ye of I){let ae;if(ye.id?ae=p.find(me=>String(me.id)===String(ye.id)):ye.name&&(ae=At(ye.name,p)),!ae)throw new Error(`Lab test "${ye.name}" not found.`);ye._matchedTest=ae,O.push({id:ae.id,name:ae.name,price:Number(ae.price)})}const ie=await G("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,tests:O,status:"reported"})});if(!ie.ok)throw new Error("Lab order creation failed during report generation.");const re=await ie.json(),R=re.labOrder.id,he={};if(I.forEach(ye=>{const ae=ye._matchedTest,me=ae.id,de=ye.parameters||[],M={},X=ae.default_parameters||[];for(const xe of X){const qe=de.find(oe=>{if(!oe.name)return!1;if(oe.name.toLowerCase()===xe.name.toLowerCase())return!0;const Ne=oe.name.toLowerCase(),Ee=xe.name.toLowerCase();return Ne.includes(Ee)||Ee.includes(Ne)});qe&&qe.value!==void 0?M[xe.name]=qe.value:xe.defaultValue!==void 0&&xe.defaultValue!==null&&(M[xe.name]=xe.defaultValue)}he[me]=M}),!(await G(`/api/lab/${R}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(he)})})).ok)throw new Error("Report submission failed.");return le("Report Created!"),De(n),He(n),v==null||v({role:"system",type:"success",content:"Lab report created successfully."}),{success:!0,actionType:z,data:re.labOrder,undoData:{orderId:R}}}catch(O){return v==null||v({role:"system",type:"error",content:`Lab report failed: ${O.message}`}),{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="edit_lab_report")ve.push((async()=>{ne(!0),le("Updating Report...");try{const O=D.serialNumber;if(!O)throw new Error("Missing serial number for lab report edit.");const I=new Map;(c??[]).forEach(de=>I.set(de.id,{...de})),(u??[]).forEach(de=>{if(I.has(de.id)){const M=I.get(de.id);M.report=de,M.status=de.status}else I.set(de.id,{...de,createdAt:de.createdAt})});const ie=Array.from(I.values());ie.sort((de,M)=>new Date(M.createdAt).getTime()-new Date(de.createdAt).getTime());const re=ie.length-O,R=ie[re];if(!R)throw new Error(`Lab report #${O} not found.`);const he=R.id;let je={};if(R.report&&R.report.report_content)try{je=typeof R.report.report_content=="string"?JSON.parse(R.report.report_content):R.report.report_content}catch{}const ye={...je};if((D.tests||[]).forEach(de=>{let X=(R.tests||[]).find(Ee=>Ee.name.toLowerCase()===de.name.toLowerCase());if(!X)return;const xe=X.id,qe=de.parameters||[],oe=p.find(Ee=>String(Ee.id)===String(xe)),Ne=(oe==null?void 0:oe.default_parameters)||[];ye[xe]||(ye[xe]={});for(const Ee of Ne){const Ge=qe.find(ot=>{if(!ot.name)return!1;if(ot.name.toLowerCase()===Ee.name.toLowerCase())return!0;const yt=ot.name.toLowerCase(),lt=Ee.name.toLowerCase();return yt.includes(lt)||lt.includes(yt)});Ge&&Ge.value!==void 0&&(ye[xe][Ee.name]=Ge.value)}}),!(await G(`/api/lab/${he}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(ye)})})).ok)throw new Error("Report update failed.");return le("Report Updated!"),De(n),He(n),v==null||v({role:"system",type:"success",content:"Lab report updated successfully."}),{success:!0,actionType:z,data:{orderId:he},undoData:{orderId:he}}}catch(O){return v==null||v({role:"system",type:"error",content:`Update report failed: ${O.message}`}),{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="edit_lab_order_and_create_report")ve.push((async()=>{ne(!0),le("Updating Order & Report..."),v==null||v({role:"system",type:"loading",content:"Updating lab order and report..."});try{const O=D.serialNumber;if(!O)throw new Error("Missing serial number.");const I=new Map;(c??[]).forEach(oe=>I.set(oe.id,{...oe})),(u??[]).forEach(oe=>{if(I.has(oe.id)){const Ne=I.get(oe.id);Ne.report=oe,Ne.status=oe.status}else I.set(oe.id,{...oe,createdAt:oe.createdAt})});const ie=Array.from(I.values());ie.sort((oe,Ne)=>new Date(Ne.createdAt).getTime()-new Date(oe.createdAt).getTime());const re=ie.length-O,R=ie[re];if(!R)throw new Error(`Lab order #${O} not found.`);const he=R.id,je=JSON.parse(JSON.stringify(R));let ye=[];for(const oe of R.tests||[]){const Ne=p.find(Ee=>String(Ee.id)===String(oe.id));Ne?ye.push({id:Ne.id,name:Ne.name,price:Number(Ne.price)}):ye.push({id:oe.id,name:oe.name,price:Number(oe.price)||0})}if(D.items_to_remove&&Array.isArray(D.items_to_remove)){const oe=D.items_to_remove;ye=ye.filter(Ne=>!oe.some(Ee=>Ee.id&&String(Ee.id)===String(Ne.id)||Ee.name&&Ne.name.toLowerCase()===Ee.name.toLowerCase()))}const ae=D.tests||[],me={};for(const oe of ae){let Ne;if(oe.id?Ne=p.find(nt=>String(nt.id)===String(oe.id)):oe.name&&(Ne=At(oe.name,p)),!Ne)throw new Error(`Lab test "${oe.name}" not found.`);ye.findIndex(nt=>String(nt.id)===String(Ne.id))===-1&&ye.push({id:Ne.id,name:Ne.name,price:Number(Ne.price)});const Ge=Ne.id,ot=oe.parameters||[],yt={},lt=Ne.default_parameters||[];for(const nt of lt){const Zt=ot.find(en=>{if(!en.name)return!1;if(en.name.toLowerCase()===nt.name.toLowerCase())return!0;const Hn=en.name.toLowerCase(),Wn=nt.name.toLowerCase();return Hn.includes(Wn)||Wn.includes(Hn)});Zt&&Zt.value!==void 0?yt[nt.name]=Zt.value:nt.defaultValue!==void 0&&(yt[nt.name]=nt.defaultValue)}me[Ge]=yt}const de={tests:ye};console.log("[DEBUG] edit_lab_order_and_create_report - Order Update Payload:",JSON.stringify(de,null,2)),console.log("[DEBUG] Items to remove:",D.items_to_remove),console.log("[DEBUG] Original tests:",R.tests);const M=await G(`/api/lab/orders/${he}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(de)});if(console.log("[DEBUG] Order update response status:",M.status),!M.ok){const oe=await M.json().catch(()=>({}));throw console.error("[DEBUG] Order update failed:",oe),new Error(`Failed to update lab order tests: ${oe.message||M.statusText}`)}let X={};if(R.report&&R.report.report_content)try{X=typeof R.report.report_content=="string"?JSON.parse(R.report.report_content):R.report.report_content}catch{}const xe={...X,...me};if(!(await G(`/api/lab/${he}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(xe)})})).ok)throw new Error("Failed to create/update lab report.");return le("Order & Report Updated!"),De(n),He(n),v==null||v({role:"system",type:"success",content:"Lab order and report updated successfully."}),{success:!0,actionType:z,undoData:{orderId:he,originalState:je}}}catch(O){return v==null||v({role:"system",type:"error",content:`Failed to edit order and report: ${O.message}`}),{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="edit_pharmacy_order")ve.push((async()=>{Z(!0);try{const O=D.serialNumber;let I;if(O?I=[...d].sort((me,de)=>new Date(me.date).getTime()-new Date(de.date).getTime())[O-1]:I=d.find(ae=>ae.status==="pending"),!I)throw new Error("Order to edit not found.");const ie=JSON.parse(JSON.stringify(I));let re=[...I.medications];const R=D.items_to_remove,he=D.items;if(Array.isArray(R)&&(re=re.filter(ae=>!R.some(me=>me.drug_id&&String(ae.drug_id)===String(me.drug_id)||me.name&&ae.name.toLowerCase()===me.name.toLowerCase()))),Array.isArray(he))for(const ae of he){let me;if(ae.drug_id?me=y.find(X=>String(X.id)===String(ae.drug_id)):ae.name&&(me=At(ae.name,y)),!me)throw new Error(`Drug ${ae.name} not found.`);const de=re.findIndex(X=>X.drug_id===String(me==null?void 0:me.id)),M={drug_id:String(me.id),name:me.name,pack_quantity:ae.pack_quantity||0,loose_quantity:ae.loose_quantity||0,pack_price:Number(me.mrp),loose_price:0,total_price:0,price:Number(me.mrp)};de>=0?re[de]={...re[de],...M}:re.push(M)}const je={items:re,status:D.status,prescription_for_unavailable_drugs:D.prescription_for_unavailable_drugs,order_total:0};if(!(await G(`/api/pharmacy-orders/${I.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(je)})).ok)throw new Error("Order edit failed.");return x(n),{success:!0,actionType:z,undoData:{orderId:I.id,originalState:ie}}}catch(O){return{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{Z(!1)}})());else if(z==="edit_lab_order")ve.push((async()=>{ne(!0);try{const O=c.sort((R,he)=>new Date(he.createdAt).getTime()-new Date(R.createdAt).getTime()).find(R=>R.status==="pending");if(!O)throw new Error("No pending lab order to edit.");const I=JSON.parse(JSON.stringify(O)),ie={tests:[],status:D.status};if(!(await G(`/api/lab/orders/${O.id}`,{method:"PUT",body:JSON.stringify(ie),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Lab edit failed.");return De(n),{success:!0,actionType:z,undoData:{orderId:O.id,originalState:I}}}catch(O){return{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="add_complaint_history")ve.push((async()=>{V(!0),v==null||v({role:"system",type:"loading",content:"Updating complaint history..."});const O=q;try{if(!e)throw new Error("No record ID.");if(!(await G(`/api/queue/doctor/complaint/${e}`,{method:"PUT",body:JSON.stringify({complaint:D.complaint}),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Complaint update failed.");return K(D.complaint),n&&at(n),v==null||v({role:"system",type:"success",content:"Complaint history updated."}),{success:!0,actionType:z,undoData:{recordId:e,originalComplaint:O}}}catch(I){return v==null||v({role:"system",type:"error",content:`Complaint history update failed: ${I.message}`}),{success:!1,actionType:z,error:I,originalActionPayload:D}}finally{V(!1)}})());else if(z==="update_case_summary")ve.push((async()=>{C(!0),v==null||v({role:"system",type:"loading",content:"Updating case summary..."});const O=r;try{if(!e)throw new Error("No record ID.");const I=await G(`/api/queue/doctor/complaint/${e}`,{method:"PUT",body:JSON.stringify({case_summary:D.summary}),headers:{"Content-Type":"application/json"}});if(!I.ok)throw new Error("Summary update failed.");const ie=await I.json();return E(ie.case_summary),v==null||v({role:"system",type:"success",content:"Case summary updated."}),{success:!0,actionType:z,undoData:{recordId:e,originalSummary:O}}}catch(I){return v==null||v({role:"system",type:"error",content:`Case summary update failed: ${I.message}`}),{success:!1,actionType:z,error:I,originalActionPayload:D}}finally{C(!1)}})());else if(z==="create_recurring_medication_order")ve.push((async()=>{Z(!0),ce("Creating recurring medication(s)..."),v==null||v({role:"system",type:"loading",content:"Creating recurring medication(s)..."});try{if(!n)throw new Error("Missing patient ID.");if(!D.items||!Array.isArray(D.items))throw new Error("No items provided for recurring medication order.");const O=await Promise.all(D.items.map(async R=>{let he=R.drug_id;if(!he){const je=At(R.medication_name,y);he=je?je.id:null}if(!he)throw new Error(`Drug "${R.medication_name}" not found in inventory for recurring medication.`);return{...R,drug_id:he}})),I=await G("/api/recurring-medications",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,items:O})});if(!I.ok){const R=await I.json().catch(()=>({}));throw new Error(R.message||"Failed to create recurring medication order")}const ie=await I.json(),re=ie.map(R=>R.id);return n&&ke&&ke(n),ce("Recurring medication(s) created."),v==null||v({role:"system",type:"success",content:`Successfully created ${re.length} recurring medication(s).`}),{success:!0,actionType:z,data:ie,undoData:{createdIds:re}}}catch(O){return v==null||v({role:"system",type:"error",content:`Error creating recurring medication: ${O.message}`}),{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{Z(!1)}})());else if(z==="edit_recurring_medication_order")ve.push((async()=>{Z(!0),ce("Updating recurring medication..."),v==null||v({role:"system",type:"loading",content:"Updating recurring medication..."});try{if(!n)throw new Error("Missing patient ID.");if(!D.serialNumber||!D.updates)throw new Error("Missing serialNumber or updates for recurring medication edit.");if(!A||A.length===0)throw new Error("No recurring medications found to edit.");const O=D.serialNumber-1;if(O<0||O>=A.length)throw new Error(`Recurring medication with serial number ${D.serialNumber} not found.`);const I=A[O],ie=JSON.parse(JSON.stringify(I));if(D.updates.drug_id===null||D.updates.medication_name){let R=D.updates.drug_id;if(!R&&D.updates.medication_name){const he=At(D.updates.medication_name,y);R=he?he.id:null}if(!R&&D.updates.medication_name)throw new Error(`Drug "${D.updates.medication_name}" not found in inventory for update.`);D.updates.drug_id=R}const re=await G(`/api/recurring-medications/${I.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(D.updates)});if(!re.ok){const R=await re.json().catch(()=>({}));throw new Error(R.message||"Failed to update recurring medication")}return n&&ke&&ke(n),ce("Recurring medication updated."),v==null||v({role:"system",type:"success",content:`Successfully updated recurring medication #${D.serialNumber}.`}),{success:!0,actionType:z,data:{id:I.id,...D.updates},undoData:{medicationId:I.id,originalState:ie}}}catch(O){return v==null||v({role:"system",type:"error",content:`Error updating recurring medication: ${O.message}`}),{success:!1,actionType:z,error:O,originalActionPayload:D}}finally{Z(!1)}})());else if(z==="end_task")ve.push((async()=>(v==null||v({role:"system",type:"success",content:"Task completed."}),{success:!0,actionType:z}))());else{if(z==="bill_lab_order")continue;console.warn(`Unknown action ${z}`),ve.push(Promise.resolve({success:!1,actionType:z,error:new Error(`Unknown action: ${z}`),originalActionPayload:D}))}}const ze=await Promise.all(ve),te=ze.filter(D=>!D.success);if(te.length>0){console.log("AI Actions Failed. Initiating Rollback...",te);const D=ze.filter(re=>re.success),z=[...D].reverse();await Ut(z);const O=te.map(re=>{var R;return`${re.actionType}: ${(R=re.error)==null?void 0:R.message}`}).join("; "),I=D.length>0?` I successfully rolled back ${D.length} other actions that succeeded.`:"",ie=`One or more actions failed: [${O}].${I} Please analyze the failure and try again.`;await vt("multiple_actions",{message:ie},$e,T)}else{const D=ze.filter(O=>O.success);D.length>0&&(gt(D),Yt&&D.forEach(O=>Yt(O.actionType)));const z=Me.find(O=>O.action==="bill_lab_order");if(z&&z.serialNumber){const O=new Map;(c??[]).forEach(R=>O.set(R.id,{...R}));const I=Array.from(O.values());I.sort((R,he)=>new Date(he.createdAt).getTime()-new Date(R.createdAt).getTime());const ie=I.length-z.serialNumber,re=I[ie];if(re&&re.id){v==null||v({role:"system",type:"success",content:`Processing billing for Lab Order #${z.serialNumber}...`});try{const R=re.tests.map(M=>({name:M.test_name||M.name,price:typeof M.price=="string"?parseFloat(M.price):M.price||0,discount_percentage:0,quantity:1,item_id:M.test_id||M.id,type:"lab_test"})),he=R.reduce((M,X)=>M+X.price,0),je=0,ye=he,ae={patientId:re.patient_id,items:R.map(M=>({...M,total:M.price})),amount:ye,paymentMode:"cash",type:"lab",related_id:re.id,status:"paid",discountPercentage:0},me=await G("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)}),de=await me.json();if(!me.ok)throw new Error(de.message||"Failed to create bill");await G(`/api/lab/${re.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:de.id})}),n&&De(n),Dt&&(Dt({billId:de.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:re.createdAt,items:R,subtotal:he,totalDiscount:je,grandTotal:ye,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||"",labLetterheadUrl:a==null?void 0:a.labLetterheadUrl}),v==null||v({role:"system",type:"success",content:`Bill #${de.id} created. Opening print dialog.`}))}catch(R){console.error("Auto-billing failed:",R),v==null||v({role:"system",type:"error",content:`Billing failed: ${R.message}`})}}else console.warn(`Could not find lab order with serialNumber ${z.serialNumber} to bill.`),v==null||v({role:"system",type:"error",content:`Could not find lab order #${z.serialNumber} to bill.`})}if(Ve&&typeof Ve.question=="string")Se(Ve.question),pe(Array.isArray(Ve.options)?Ve.options:[]);else if(D.length===0&&!z&&!Qe)throw new Error("AI response did not result in a recognized or performed function call.")}}catch(ue){await vt("parse_json_actions",ue,$e,T)}else throw new Error("AI response did not contain a recognized function call.")};Je=async($e,T=0)=>{if(T>1){j("AI call failed after multiple retries. Please try a different prompt."),F(!1);return}F(!0),j(null);let P;const ee=[...o,$e].join(`

`);try{const ue=new Map;(c??[]).forEach(te=>{ue.set(te.id,{...te})}),(u??[]).forEach(te=>{if(!ue.has(te.id))ue.set(te.id,{id:te.id,patient_id:te.patient_id,tests:te.tests,status:te.status,createdAt:te.createdAt,report:te});else{const D=ue.get(te.id);D&&(D.report=te,D.status=te.status)}});const Le=Array.from(ue.values());Le.sort((te,D)=>new Date(D.createdAt).getTime()-new Date(te.createdAt).getTime());const Me=Le.map((te,D)=>{let z=null;if(te.report)try{const O=typeof te.report.report_content=="string"?te.report.report_content:JSON.stringify(te.report.report_content||{}),I=JSON.parse(O||"{}"),ie=re=>{const R=I[re.id]||{},he=je=>({name:je.name,value:R[je.name]!==void 0?String(R[je.name]):String(je.defaultValue),normal_range:je.normal_range||"N/A"});return{testId:re.id,testName:re.name,parameters:(re.default_parameters||[]).map(he)}};z={reportId:te.report.reportId,reportDate:te.report.report_date,tests:(te.tests||[]).map(ie)}}catch{z={reportId:te.report.reportId,reportDate:te.report.report_date,reportContent:typeof te.report.report_content=="string"?te.report.report_content:JSON.stringify(te.report.report_content),error:"Failed to parse report content JSON."}}return{serialNumber:Le.length-D,orderId:te.id,orderDate:isNaN(new Date(te.createdAt).getTime())?te.createdAt:new Date(te.createdAt).toISOString(),tests:te.tests.map(O=>({id:O.id,name:O.name,price:O.price})),status:te.status,report:z}}),ve=m.map(te=>{try{return{...te,createdAt:isNaN(new Date(te.createdAt).getTime())?te.createdAt:new Date(te.createdAt).toISOString()}}catch{return te}}),Qe=[...d].sort((te,D)=>{const z=new Date(te.date).getTime(),O=new Date(D.date).getTime();return z-O}).map((te,D)=>{try{return{serialNumber:D+1,...te,date:te.date&&!isNaN(new Date(te.date).getTime())?new Date(te.date).toISOString():te.date}}catch{return{serialNumber:D+1,...te}}}),ze={query:ee,currentDateTime:new Date().toISOString(),patientName:(t==null?void 0:t.name)||"",patientAge:(t==null?void 0:t.age)||void 0,patientGender:(t==null?void 0:t.gender)||void 0,case_summary:r||"",case_summary_last_updated:s?new Date(s).toISOString():void 0,clinic_ai_memory:(a==null?void 0:a.aiMemory)||"",clinic_ai_memory_last_updated:a!=null&&a.aiMemoryUpdatedAt?new Date(a.aiMemoryUpdatedAt).toISOString():void 0,clinic_wide_system_prompt:(a==null?void 0:a.clinicWideSystemPrompt)||"",labHistory:Me,pharmacyOrders:Qe,pastComplaints:ve,pharmacyInventory:y,labInventory:p,recurringMedications:A};if(console.log("DEBUG: Payload before sending to Gemini API:",JSON.stringify(ze,null,2)),P=await qh(ze,l),P){$(P),v==null||v({role:"ai",content:P});const te=/```json\s*([\s\S]*?)\s*```/,D=P.match(te);if(D&&D[1])H(P.replace(te,"").trim()),L(D[1].trim());else{const z=P.trim();if(z.startsWith("{")&&z.endsWith("}"))try{JSON.parse(z),H(""),L(z)}catch{H(z),L(null)}else if(z.startsWith("[")&&z.endsWith("]"))try{JSON.parse(z),H(""),L(z)}catch{H(z),L(null)}else H(z),L(null)}W(!1),n&&P&&await jt(n,P),await We(P,T),K("")}else throw new Error("Invalid AI response format.")}catch(ue){await vt("call_generative_api",ue,P,T)}finally{F(!1)}};const jt=async($e,T)=>{Fe(!0),we(null);try{const P={ai_response:T},S=await G(`/api/patients/${$e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(P)});if(!S.ok){const ee=await S.json().catch(()=>({}));throw new Error(ee.message||`Failed to save AI response to patient: ${S.statusText}`)}}catch(P){we(`AI Response Save Error: ${P.message}`),v==null||v({role:"system",type:"error",content:`AI Response Save Error: ${P.message}`})}finally{Fe(!1)}};return b.useImperativeHandle(Kt,()=>({callGenerativeApi:Je,undoLastAction:Xt})),null}),$o=-1,wr=0,zn=1,gr=2,Vi=3,Ji=4,Qi=5,Gi=6,Lo=7,Ro=8,Es=typeof self=="object"?self:globalThis,Uh=(e,n)=>{const t=(s,a)=>(e.set(a,s),s),r=s=>{if(e.has(s))return e.get(s);const[a,o]=n[s];switch(a){case wr:case $o:return t(o,s);case zn:{const l=t([],s);for(const c of o)l.push(r(c));return l}case gr:{const l=t({},s);for(const[c,u]of o)l[r(c)]=r(u);return l}case Vi:return t(new Date(o),s);case Ji:{const{source:l,flags:c}=o;return t(new RegExp(l,c),s)}case Qi:{const l=t(new Map,s);for(const[c,u]of o)l.set(r(c),r(u));return l}case Gi:{const l=t(new Set,s);for(const c of o)l.add(r(c));return l}case Lo:{const{name:l,message:c}=o;return t(new Es[l](c),s)}case Ro:return t(BigInt(o),s);case"BigInt":return t(Object(BigInt(o)),s);case"ArrayBuffer":return t(new Uint8Array(o).buffer,o);case"DataView":{const{buffer:l}=new Uint8Array(o);return t(new DataView(l),o)}}return t(new Es[a](o),s)};return r},As=e=>Uh(new Map,e)(0),dn="",{toString:Mh}={},{keys:Hh}=Object,$n=e=>{const n=typeof e;if(n!=="object"||!e)return[wr,n];const t=Mh.call(e).slice(8,-1);switch(t){case"Array":return[zn,dn];case"Object":return[gr,dn];case"Date":return[Vi,dn];case"RegExp":return[Ji,dn];case"Map":return[Qi,dn];case"Set":return[Gi,dn];case"DataView":return[zn,t]}return t.includes("Array")?[zn,t]:t.includes("Error")?[Lo,t]:[gr,t]},lr=([e,n])=>e===wr&&(n==="function"||n==="symbol"),Wh=(e,n,t,r)=>{const s=(o,l)=>{const c=r.push(o)-1;return t.set(l,c),c},a=o=>{if(t.has(o))return t.get(o);let[l,c]=$n(o);switch(l){case wr:{let m=o;switch(c){case"bigint":l=Ro,m=o.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+c);m=null;break;case"undefined":return s([$o],o)}return s([l,m],o)}case zn:{if(c){let y=o;return c==="DataView"?y=new Uint8Array(o.buffer):c==="ArrayBuffer"&&(y=new Uint8Array(o)),s([c,[...y]],o)}const m=[],d=s([l,m],o);for(const y of o)m.push(a(y));return d}case gr:{if(c)switch(c){case"BigInt":return s([c,o.toString()],o);case"Boolean":case"Number":case"String":return s([c,o.valueOf()],o)}if(n&&"toJSON"in o)return a(o.toJSON());const m=[],d=s([l,m],o);for(const y of Hh(o))(e||!lr($n(o[y])))&&m.push([a(y),a(o[y])]);return d}case Vi:return s([l,o.toISOString()],o);case Ji:{const{source:m,flags:d}=o;return s([l,{source:m,flags:d}],o)}case Qi:{const m=[],d=s([l,m],o);for(const[y,p]of o)(e||!(lr($n(y))||lr($n(p))))&&m.push([a(y),a(p)]);return d}case Gi:{const m=[],d=s([l,m],o);for(const y of o)(e||!lr($n(y)))&&m.push(a(y));return d}}const{message:u}=o;return s([l,{name:c,message:u}],o)};return a},Ds=(e,{json:n,lossy:t}={})=>{const r=[];return Wh(!(n||t),!!n,new Map,r)(e),r},qn=typeof structuredClone=="function"?(e,n)=>n&&("json"in n||"lossy"in n)?As(Ds(e,n)):structuredClone(e):(e,n)=>As(Ds(e,n)),Fo=qo("end"),zo=qo("start");function qo(e){return n;function n(t){const r=t&&t.position&&t.position[e]||{};if(typeof r.line=="number"&&r.line>0&&typeof r.column=="number"&&r.column>0)return{line:r.line,column:r.column,offset:typeof r.offset=="number"&&r.offset>-1?r.offset:void 0}}}function Bo(e){const n=zo(e),t=Fo(e);if(n&&t)return{start:n,end:t}}const Jt=["ariaDescribedBy","ariaLabel","ariaLabelledBy"],Is={ancestors:{tbody:["table"],td:["table"],th:["table"],thead:["table"],tfoot:["table"],tr:["table"]},attributes:{a:[...Jt,"dataFootnoteBackref","dataFootnoteRef",["className","data-footnote-backref"],"href"],blockquote:["cite"],code:[["className",/^language-./]],del:["cite"],div:["itemScope","itemType"],dl:[...Jt],h2:[["className","sr-only"]],img:[...Jt,"longDesc","src"],input:[["disabled",!0],["type","checkbox"]],ins:["cite"],li:[["className","task-list-item"]],ol:[...Jt,["className","contains-task-list"]],q:["cite"],section:["dataFootnotes",["className","footnotes"]],source:["srcSet"],summary:[...Jt],table:[...Jt],ul:[...Jt,["className","contains-task-list"]],"*":["abbr","accept","acceptCharset","accessKey","action","align","alt","axis","border","cellPadding","cellSpacing","char","charOff","charSet","checked","clear","colSpan","color","cols","compact","coords","dateTime","dir","encType","frame","hSpace","headers","height","hrefLang","htmlFor","id","isMap","itemProp","label","lang","maxLength","media","method","multiple","name","noHref","noShade","noWrap","open","prompt","readOnly","rev","rowSpan","rows","rules","scope","selected","shape","size","span","start","summary","tabIndex","title","useMap","vAlign","value","width"]},clobber:["ariaDescribedBy","ariaLabelledBy","id","name"],clobberPrefix:"user-content-",protocols:{cite:["http","https"],href:["http","https","irc","ircs","mailto","xmpp"],longDesc:["http","https"],src:["http","https"]},required:{input:{disabled:!0,type:"checkbox"}},strip:["script"],tagNames:["a","b","blockquote","br","code","dd","del","details","div","dl","dt","em","h1","h2","h3","h4","h5","h6","hr","i","img","input","ins","kbd","li","ol","p","picture","pre","q","rp","rt","ruby","s","samp","section","source","span","strike","strong","sub","summary","sup","table","tbody","td","tfoot","th","thead","tr","tt","ul","var"]},zt={}.hasOwnProperty;function Vh(e,n){let t={type:"root",children:[]};const r={schema:n?{...Is,...n}:Is,stack:[]},s=Uo(r,e);return s&&(Array.isArray(s)?s.length===1?t=s[0]:t.children=s:t=s),t}function Uo(e,n){if(n&&typeof n=="object"){const t=n;switch(typeof t.type=="string"?t.type:""){case"comment":return Jh(e,t);case"doctype":return Qh(e,t);case"element":return Gh(e,t);case"root":return Yh(e,t);case"text":return Kh(e,t)}}}function Jh(e,n){if(e.schema.allowComments){const t=typeof n.value=="string"?n.value:"",r=t.indexOf("-->"),a={type:"comment",value:r<0?t:t.slice(0,r)};return Un(a,n),a}}function Qh(e,n){if(e.schema.allowDoctypes){const t={type:"doctype"};return Un(t,n),t}}function Gh(e,n){const t=typeof n.tagName=="string"?n.tagName:"";e.stack.push(t);const r=Mo(e,n.children),s=Xh(e,n.properties);e.stack.pop();let a=!1;if(t&&t!=="*"&&(!e.schema.tagNames||e.schema.tagNames.includes(t))&&(a=!0,e.schema.ancestors&&zt.call(e.schema.ancestors,t))){const l=e.schema.ancestors[t];let c=-1;for(a=!1;++c<l.length;)e.stack.includes(l[c])&&(a=!0)}if(!a)return e.schema.strip&&!e.schema.strip.includes(t)?r:void 0;const o={type:"element",tagName:t,properties:s,children:r};return Un(o,n),o}function Yh(e,n){const r={type:"root",children:Mo(e,n.children)};return Un(r,n),r}function Kh(e,n){const r={type:"text",value:typeof n.value=="string"?n.value:""};return Un(r,n),r}function Mo(e,n){const t=[];if(Array.isArray(n)){const r=n;let s=-1;for(;++s<r.length;){const a=Uo(e,r[s]);a&&(Array.isArray(a)?t.push(...a):t.push(a))}}return t}function Xh(e,n){const t=e.stack[e.stack.length-1],r=e.schema.attributes,s=e.schema.required,a=r&&zt.call(r,t)?r[t]:void 0,o=r&&zt.call(r,"*")?r["*"]:void 0,l=n&&typeof n=="object"?n:{},c={};let u;for(u in l)if(zt.call(l,u)){const m=l[u];let d=Os(e,$s(a,u),u,m);d==null&&(d=Os(e,$s(o,u),u,m)),d!=null&&(c[u]=d)}if(s&&zt.call(s,t)){const m=s[t];for(u in m)zt.call(m,u)&&!zt.call(c,u)&&(c[u]=m[u])}return c}function Os(e,n,t,r){return n?Array.isArray(r)?Zh(e,n,t,r):Ho(e,n,t,r):void 0}function Zh(e,n,t,r){let s=-1;const a=[];for(;++s<r.length;){const o=Ho(e,n,t,r[s]);(typeof o=="number"||typeof o=="string")&&a.push(o)}return a}function Ho(e,n,t,r){if(!(typeof r!="boolean"&&typeof r!="number"&&typeof r!="string")&&em(e,t,r)){if(typeof n=="object"&&n.length>1){let s=!1,a=0;for(;++a<n.length;){const o=n[a];if(o&&typeof o=="object"&&"flags"in o){if(o.test(String(r))){s=!0;break}}else if(o===r){s=!0;break}}if(!s)return}return e.schema.clobber&&e.schema.clobberPrefix&&e.schema.clobber.includes(t)?e.schema.clobberPrefix+r:r}}function em(e,n,t){const r=e.schema.protocols&&zt.call(e.schema.protocols,n)?e.schema.protocols[n]:void 0;if(!r||r.length===0)return!0;const s=String(t),a=s.indexOf(":"),o=s.indexOf("?"),l=s.indexOf("#"),c=s.indexOf("/");if(a<0||c>-1&&a>c||o>-1&&a>o||l>-1&&a>l)return!0;let u=-1;for(;++u<r.length;){const m=r[u];if(a===m.length&&s.slice(0,m.length)===m)return!0}return!1}function Un(e,n){const t=Bo(n);n.data&&(e.data=qn(n.data)),t&&(e.position=t)}function $s(e,n){let t,r=-1;if(e)for(;++r<e.length;){const s=e[r],a=typeof s=="string"?s:s[0];if(a===n)return s;a==="data*"&&(t=s)}if(n.length>4&&n.slice(0,4).toLowerCase()==="data")return t}function tm(e,n){const t={type:"element",tagName:"blockquote",properties:{},children:e.wrap(e.all(n),!0)};return e.patch(n,t),e.applyData(n,t)}function nm(e,n){const t={type:"element",tagName:"br",properties:{},children:[]};return e.patch(n,t),[e.applyData(n,t),{type:"text",value:`
`}]}function rm(e,n){const t=n.value?n.value+`
`:"",r={};n.lang&&(r.className=["language-"+n.lang]);let s={type:"element",tagName:"code",properties:r,children:[{type:"text",value:t}]};return n.meta&&(s.data={meta:n.meta}),e.patch(n,s),s=e.applyData(n,s),s={type:"element",tagName:"pre",properties:{},children:[s]},e.patch(n,s),s}function im(e,n){const t={type:"element",tagName:"del",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function am(e,n){const t={type:"element",tagName:"em",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function sm(e,n){const t=typeof e.options.clobberPrefix=="string"?e.options.clobberPrefix:"user-content-",r=String(n.identifier).toUpperCase(),s=gn(r.toLowerCase()),a=e.footnoteOrder.indexOf(r);let o,l=e.footnoteCounts.get(r);l===void 0?(l=0,e.footnoteOrder.push(r),o=e.footnoteOrder.length):o=a+1,l+=1,e.footnoteCounts.set(r,l);const c={type:"element",tagName:"a",properties:{href:"#"+t+"fn-"+s,id:t+"fnref-"+s+(l>1?"-"+l:""),dataFootnoteRef:!0,ariaDescribedBy:["footnote-label"]},children:[{type:"text",value:String(o)}]};e.patch(n,c);const u={type:"element",tagName:"sup",properties:{},children:[c]};return e.patch(n,u),e.applyData(n,u)}function om(e,n){const t={type:"element",tagName:"h"+n.depth,properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function lm(e,n){if(e.options.allowDangerousHtml){const t={type:"raw",value:n.value};return e.patch(n,t),e.applyData(n,t)}}function Wo(e,n){const t=n.referenceType;let r="]";if(t==="collapsed"?r+="[]":t==="full"&&(r+="["+(n.label||n.identifier)+"]"),n.type==="imageReference")return[{type:"text",value:"!["+n.alt+r}];const s=e.all(n),a=s[0];a&&a.type==="text"?a.value="["+a.value:s.unshift({type:"text",value:"["});const o=s[s.length-1];return o&&o.type==="text"?o.value+=r:s.push({type:"text",value:r}),s}function cm(e,n){const t=String(n.identifier).toUpperCase(),r=e.definitionById.get(t);if(!r)return Wo(e,n);const s={src:gn(r.url||""),alt:n.alt};r.title!==null&&r.title!==void 0&&(s.title=r.title);const a={type:"element",tagName:"img",properties:s,children:[]};return e.patch(n,a),e.applyData(n,a)}function um(e,n){const t={src:gn(n.url)};n.alt!==null&&n.alt!==void 0&&(t.alt=n.alt),n.title!==null&&n.title!==void 0&&(t.title=n.title);const r={type:"element",tagName:"img",properties:t,children:[]};return e.patch(n,r),e.applyData(n,r)}function dm(e,n){const t={type:"text",value:n.value.replace(/\r?\n|\r/g," ")};e.patch(n,t);const r={type:"element",tagName:"code",properties:{},children:[t]};return e.patch(n,r),e.applyData(n,r)}function pm(e,n){const t=String(n.identifier).toUpperCase(),r=e.definitionById.get(t);if(!r)return Wo(e,n);const s={href:gn(r.url||"")};r.title!==null&&r.title!==void 0&&(s.title=r.title);const a={type:"element",tagName:"a",properties:s,children:e.all(n)};return e.patch(n,a),e.applyData(n,a)}function hm(e,n){const t={href:gn(n.url)};n.title!==null&&n.title!==void 0&&(t.title=n.title);const r={type:"element",tagName:"a",properties:t,children:e.all(n)};return e.patch(n,r),e.applyData(n,r)}function mm(e,n,t){const r=e.all(n),s=t?fm(t):Vo(n),a={},o=[];if(typeof n.checked=="boolean"){const m=r[0];let d;m&&m.type==="element"&&m.tagName==="p"?d=m:(d={type:"element",tagName:"p",properties:{},children:[]},r.unshift(d)),d.children.length>0&&d.children.unshift({type:"text",value:" "}),d.children.unshift({type:"element",tagName:"input",properties:{type:"checkbox",checked:n.checked,disabled:!0},children:[]}),a.className=["task-list-item"]}let l=-1;for(;++l<r.length;){const m=r[l];(s||l!==0||m.type!=="element"||m.tagName!=="p")&&o.push({type:"text",value:`
`}),m.type==="element"&&m.tagName==="p"&&!s?o.push(...m.children):o.push(m)}const c=r[r.length-1];c&&(s||c.type!=="element"||c.tagName!=="p")&&o.push({type:"text",value:`
`});const u={type:"element",tagName:"li",properties:a,children:o};return e.patch(n,u),e.applyData(n,u)}function fm(e){let n=!1;if(e.type==="list"){n=e.spread||!1;const t=e.children;let r=-1;for(;!n&&++r<t.length;)n=Vo(t[r])}return n}function Vo(e){const n=e.spread;return n??e.children.length>1}function gm(e,n){const t={},r=e.all(n);let s=-1;for(typeof n.start=="number"&&n.start!==1&&(t.start=n.start);++s<r.length;){const o=r[s];if(o.type==="element"&&o.tagName==="li"&&o.properties&&Array.isArray(o.properties.className)&&o.properties.className.includes("task-list-item")){t.className=["contains-task-list"];break}}const a={type:"element",tagName:n.ordered?"ol":"ul",properties:t,children:e.wrap(r,!0)};return e.patch(n,a),e.applyData(n,a)}function ym(e,n){const t={type:"element",tagName:"p",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function xm(e,n){const t={type:"root",children:e.wrap(e.all(n))};return e.patch(n,t),e.applyData(n,t)}function bm(e,n){const t={type:"element",tagName:"strong",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function wm(e,n){const t=e.all(n),r=t.shift(),s=[];if(r){const o={type:"element",tagName:"thead",properties:{},children:e.wrap([r],!0)};e.patch(n.children[0],o),s.push(o)}if(t.length>0){const o={type:"element",tagName:"tbody",properties:{},children:e.wrap(t,!0)},l=zo(n.children[1]),c=Fo(n.children[n.children.length-1]);l&&c&&(o.position={start:l,end:c}),s.push(o)}const a={type:"element",tagName:"table",properties:{},children:e.wrap(s,!0)};return e.patch(n,a),e.applyData(n,a)}function km(e,n,t){const r=t?t.children:void 0,a=(r?r.indexOf(n):1)===0?"th":"td",o=t&&t.type==="table"?t.align:void 0,l=o?o.length:n.children.length;let c=-1;const u=[];for(;++c<l;){const d=n.children[c],y={},p=o?o[c]:void 0;p&&(y.align=p);let A={type:"element",tagName:a,properties:y,children:[]};d&&(A.children=e.all(d),e.patch(d,A),A=e.applyData(d,A)),u.push(A)}const m={type:"element",tagName:"tr",properties:{},children:e.wrap(u,!0)};return e.patch(n,m),e.applyData(n,m)}function _m(e,n){const t={type:"element",tagName:"td",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}const Ls=9,Rs=32;function Nm(e){const n=String(e),t=/\r?\n|\r/g;let r=t.exec(n),s=0;const a=[];for(;r;)a.push(Fs(n.slice(s,r.index),s>0,!0),r[0]),s=r.index+r[0].length,r=t.exec(n);return a.push(Fs(n.slice(s),s>0,!1)),a.join("")}function Fs(e,n,t){let r=0,s=e.length;if(n){let a=e.codePointAt(r);for(;a===Ls||a===Rs;)r++,a=e.codePointAt(r)}if(t){let a=e.codePointAt(s-1);for(;a===Ls||a===Rs;)s--,a=e.codePointAt(s-1)}return s>r?e.slice(r,s):""}function vm(e,n){const t={type:"text",value:Nm(String(n.value))};return e.patch(n,t),e.applyData(n,t)}function jm(e,n){const t={type:"element",tagName:"hr",properties:{},children:[]};return e.patch(n,t),e.applyData(n,t)}const Cm={blockquote:tm,break:nm,code:rm,delete:im,emphasis:am,footnoteReference:sm,heading:om,html:lm,imageReference:cm,image:um,inlineCode:dm,linkReference:pm,link:hm,listItem:mm,list:gm,paragraph:ym,root:xm,strong:bm,table:wm,tableCell:_m,tableRow:km,text:vm,thematicBreak:jm,toml:cr,yaml:cr,definition:cr,footnoteDefinition:cr};function cr(){}function Sm(e,n){const t=[{type:"text",value:"↩"}];return n>1&&t.push({type:"element",tagName:"sup",properties:{},children:[{type:"text",value:String(n)}]}),t}function Tm(e,n){return"Back to reference "+(e+1)+(n>1?"-"+n:"")}function Pm(e){const n=typeof e.options.clobberPrefix=="string"?e.options.clobberPrefix:"user-content-",t=e.options.footnoteBackContent||Sm,r=e.options.footnoteBackLabel||Tm,s=e.options.footnoteLabel||"Footnotes",a=e.options.footnoteLabelTagName||"h2",o=e.options.footnoteLabelProperties||{className:["sr-only"]},l=[];let c=-1;for(;++c<e.footnoteOrder.length;){const u=e.footnoteById.get(e.footnoteOrder[c]);if(!u)continue;const m=e.all(u),d=String(u.identifier).toUpperCase(),y=gn(d.toLowerCase());let p=0;const A=[],q=e.footnoteCounts.get(d);for(;q!==void 0&&++p<=q;){A.length>0&&A.push({type:"text",value:" "});let H=typeof t=="string"?t:t(c,p);typeof H=="string"&&(H={type:"text",value:H}),A.push({type:"element",tagName:"a",properties:{href:"#"+n+"fnref-"+y+(p>1?"-"+p:""),dataFootnoteBackref:"",ariaLabel:typeof r=="string"?r:r(c,p),className:["data-footnote-backref"]},children:Array.isArray(H)?H:[H]})}const K=m[m.length-1];if(K&&K.type==="element"&&K.tagName==="p"){const H=K.children[K.children.length-1];H&&H.type==="text"?H.value+=" ":K.children.push({type:"text",value:" "}),K.children.push(...A)}else m.push(...A);const $={type:"element",tagName:"li",properties:{id:n+"fn-"+y},children:e.wrap(m,!0)};e.patch(u,$),l.push($)}if(l.length!==0)return{type:"element",tagName:"section",properties:{dataFootnotes:!0,className:["footnotes"]},children:[{type:"element",tagName:a,properties:{...qn(o),id:"footnote-label"},children:[{type:"text",value:s}]},{type:"text",value:`
`},{type:"element",tagName:"ol",properties:{},children:e.wrap(l,!0)},{type:"text",value:`
`}]}}const Ii={}.hasOwnProperty,Em={};function Am(e,n){const t=n||Em,r=new Map,s=new Map,a=new Map,o={...Cm,...t.handlers},l={all:u,applyData:Im,definitionById:r,footnoteById:s,footnoteCounts:a,footnoteOrder:[],handlers:o,one:c,options:t,patch:Dm,wrap:$m};return vo(e,function(m){if(m.type==="definition"||m.type==="footnoteDefinition"){const d=m.type==="definition"?r:s,y=String(m.identifier).toUpperCase();d.has(y)||d.set(y,m)}}),l;function c(m,d){const y=m.type,p=l.handlers[y];if(Ii.call(l.handlers,y)&&p)return p(l,m,d);if(l.options.passThrough&&l.options.passThrough.includes(y)){if("children"in m){const{children:q,...K}=m,$=qn(K);return $.children=l.all(m),$}return qn(m)}return(l.options.unknownHandler||Om)(l,m,d)}function u(m){const d=[];if("children"in m){const y=m.children;let p=-1;for(;++p<y.length;){const A=l.one(y[p],m);if(A){if(p&&y[p-1].type==="break"&&(!Array.isArray(A)&&A.type==="text"&&(A.value=zs(A.value)),!Array.isArray(A)&&A.type==="element")){const q=A.children[0];q&&q.type==="text"&&(q.value=zs(q.value))}Array.isArray(A)?d.push(...A):d.push(A)}}}return d}}function Dm(e,n){e.position&&(n.position=Bo(e))}function Im(e,n){let t=n;if(e&&e.data){const r=e.data.hName,s=e.data.hChildren,a=e.data.hProperties;if(typeof r=="string")if(t.type==="element")t.tagName=r;else{const o="children"in t?t.children:[t];t={type:"element",tagName:r,properties:{},children:o}}t.type==="element"&&a&&Object.assign(t.properties,qn(a)),"children"in t&&t.children&&s!==null&&s!==void 0&&(t.children=s)}return t}function Om(e,n){const t=n.data||{},r="value"in n&&!(Ii.call(t,"hProperties")||Ii.call(t,"hChildren"))?{type:"text",value:n.value}:{type:"element",tagName:"div",properties:{},children:e.all(n)};return e.patch(n,r),e.applyData(n,r)}function $m(e,n){const t=[];let r=-1;for(n&&t.push({type:"text",value:`
`});++r<e.length;)r&&t.push({type:"text",value:`
`}),t.push(e[r]);return n&&e.length>0&&t.push({type:"text",value:`
`}),t}function zs(e){let n=0,t=e.charCodeAt(n);for(;t===9||t===32;)n++,t=e.charCodeAt(n);return e.slice(n)}function Lm(e,n){const t=Am(e,n),r=t.one(e,void 0),s=Pm(t),a=Array.isArray(r)?{type:"root",children:r}:r||{type:"root",children:[]};return s&&a.children.push({type:"text",value:`
`},s),a}const Rm=["area","base","basefont","bgsound","br","col","command","embed","frame","hr","image","img","input","keygen","link","meta","param","source","track","wbr"];class Mn{constructor(n,t,r){this.normal=t,this.property=n,r&&(this.space=r)}}Mn.prototype.normal={};Mn.prototype.property={};Mn.prototype.space=void 0;function Jo(e,n){const t={},r={};for(const s of e)Object.assign(t,s.property),Object.assign(r,s.normal);return new Mn(t,r,n)}function Oi(e){return e.toLowerCase()}class Ze{constructor(n,t){this.attribute=t,this.property=n}}Ze.prototype.attribute="";Ze.prototype.booleanish=!1;Ze.prototype.boolean=!1;Ze.prototype.commaOrSpaceSeparated=!1;Ze.prototype.commaSeparated=!1;Ze.prototype.defined=!1;Ze.prototype.mustUseProperty=!1;Ze.prototype.number=!1;Ze.prototype.overloadedBoolean=!1;Ze.prototype.property="";Ze.prototype.spaceSeparated=!1;Ze.prototype.space=void 0;let Fm=0;const be=Gt(),Be=Gt(),$i=Gt(),B=Gt(),Ie=Gt(),hn=Gt(),rt=Gt();function Gt(){return 2**++Fm}const Li=Object.freeze(Object.defineProperty({__proto__:null,boolean:be,booleanish:Be,commaOrSpaceSeparated:rt,commaSeparated:hn,number:B,overloadedBoolean:$i,spaceSeparated:Ie},Symbol.toStringTag,{value:"Module"})),bi=Object.keys(Li);class Yi extends Ze{constructor(n,t,r,s){let a=-1;if(super(n,t),qs(this,"space",s),typeof r=="number")for(;++a<bi.length;){const o=bi[a];qs(this,bi[a],(r&Li[o])===Li[o])}}}Yi.prototype.defined=!0;function qs(e,n,t){t&&(e[n]=t)}function yn(e){const n={},t={};for(const[r,s]of Object.entries(e.properties)){const a=new Yi(r,e.transform(e.attributes||{},r),s,e.space);e.mustUseProperty&&e.mustUseProperty.includes(r)&&(a.mustUseProperty=!0),n[r]=a,t[Oi(r)]=r,t[Oi(a.attribute)]=r}return new Mn(n,t,e.space)}const Qo=yn({properties:{ariaActiveDescendant:null,ariaAtomic:Be,ariaAutoComplete:null,ariaBusy:Be,ariaChecked:Be,ariaColCount:B,ariaColIndex:B,ariaColSpan:B,ariaControls:Ie,ariaCurrent:null,ariaDescribedBy:Ie,ariaDetails:null,ariaDisabled:Be,ariaDropEffect:Ie,ariaErrorMessage:null,ariaExpanded:Be,ariaFlowTo:Ie,ariaGrabbed:Be,ariaHasPopup:null,ariaHidden:Be,ariaInvalid:null,ariaKeyShortcuts:null,ariaLabel:null,ariaLabelledBy:Ie,ariaLevel:B,ariaLive:null,ariaModal:Be,ariaMultiLine:Be,ariaMultiSelectable:Be,ariaOrientation:null,ariaOwns:Ie,ariaPlaceholder:null,ariaPosInSet:B,ariaPressed:Be,ariaReadOnly:Be,ariaRelevant:null,ariaRequired:Be,ariaRoleDescription:Ie,ariaRowCount:B,ariaRowIndex:B,ariaRowSpan:B,ariaSelected:Be,ariaSetSize:B,ariaSort:null,ariaValueMax:B,ariaValueMin:B,ariaValueNow:B,ariaValueText:null,role:null},transform(e,n){return n==="role"?n:"aria-"+n.slice(4).toLowerCase()}});function Go(e,n){return n in e?e[n]:n}function Yo(e,n){return Go(e,n.toLowerCase())}const zm=yn({attributes:{acceptcharset:"accept-charset",classname:"class",htmlfor:"for",httpequiv:"http-equiv"},mustUseProperty:["checked","multiple","muted","selected"],properties:{abbr:null,accept:hn,acceptCharset:Ie,accessKey:Ie,action:null,allow:null,allowFullScreen:be,allowPaymentRequest:be,allowUserMedia:be,alt:null,as:null,async:be,autoCapitalize:null,autoComplete:Ie,autoFocus:be,autoPlay:be,blocking:Ie,capture:null,charSet:null,checked:be,cite:null,className:Ie,cols:B,colSpan:null,content:null,contentEditable:Be,controls:be,controlsList:Ie,coords:B|hn,crossOrigin:null,data:null,dateTime:null,decoding:null,default:be,defer:be,dir:null,dirName:null,disabled:be,download:$i,draggable:Be,encType:null,enterKeyHint:null,fetchPriority:null,form:null,formAction:null,formEncType:null,formMethod:null,formNoValidate:be,formTarget:null,headers:Ie,height:B,hidden:$i,high:B,href:null,hrefLang:null,htmlFor:Ie,httpEquiv:Ie,id:null,imageSizes:null,imageSrcSet:null,inert:be,inputMode:null,integrity:null,is:null,isMap:be,itemId:null,itemProp:Ie,itemRef:Ie,itemScope:be,itemType:Ie,kind:null,label:null,lang:null,language:null,list:null,loading:null,loop:be,low:B,manifest:null,max:null,maxLength:B,media:null,method:null,min:null,minLength:B,multiple:be,muted:be,name:null,nonce:null,noModule:be,noValidate:be,onAbort:null,onAfterPrint:null,onAuxClick:null,onBeforeMatch:null,onBeforePrint:null,onBeforeToggle:null,onBeforeUnload:null,onBlur:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onContextLost:null,onContextMenu:null,onContextRestored:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnded:null,onError:null,onFocus:null,onFormData:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLanguageChange:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadEnd:null,onLoadStart:null,onMessage:null,onMessageError:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRejectionHandled:null,onReset:null,onResize:null,onScroll:null,onScrollEnd:null,onSecurityPolicyViolation:null,onSeeked:null,onSeeking:null,onSelect:null,onSlotChange:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnhandledRejection:null,onUnload:null,onVolumeChange:null,onWaiting:null,onWheel:null,open:be,optimum:B,pattern:null,ping:Ie,placeholder:null,playsInline:be,popover:null,popoverTarget:null,popoverTargetAction:null,poster:null,preload:null,readOnly:be,referrerPolicy:null,rel:Ie,required:be,reversed:be,rows:B,rowSpan:B,sandbox:Ie,scope:null,scoped:be,seamless:be,selected:be,shadowRootClonable:be,shadowRootDelegatesFocus:be,shadowRootMode:null,shape:null,size:B,sizes:null,slot:null,span:B,spellCheck:Be,src:null,srcDoc:null,srcLang:null,srcSet:null,start:B,step:null,style:null,tabIndex:B,target:null,title:null,translate:null,type:null,typeMustMatch:be,useMap:null,value:Be,width:B,wrap:null,writingSuggestions:null,align:null,aLink:null,archive:Ie,axis:null,background:null,bgColor:null,border:B,borderColor:null,bottomMargin:B,cellPadding:null,cellSpacing:null,char:null,charOff:null,classId:null,clear:null,code:null,codeBase:null,codeType:null,color:null,compact:be,declare:be,event:null,face:null,frame:null,frameBorder:null,hSpace:B,leftMargin:B,link:null,longDesc:null,lowSrc:null,marginHeight:B,marginWidth:B,noResize:be,noHref:be,noShade:be,noWrap:be,object:null,profile:null,prompt:null,rev:null,rightMargin:B,rules:null,scheme:null,scrolling:Be,standby:null,summary:null,text:null,topMargin:B,valueType:null,version:null,vAlign:null,vLink:null,vSpace:B,allowTransparency:null,autoCorrect:null,autoSave:null,disablePictureInPicture:be,disableRemotePlayback:be,prefix:null,property:null,results:B,security:null,unselectable:null},space:"html",transform:Yo}),qm=yn({attributes:{accentHeight:"accent-height",alignmentBaseline:"alignment-baseline",arabicForm:"arabic-form",baselineShift:"baseline-shift",capHeight:"cap-height",className:"class",clipPath:"clip-path",clipRule:"clip-rule",colorInterpolation:"color-interpolation",colorInterpolationFilters:"color-interpolation-filters",colorProfile:"color-profile",colorRendering:"color-rendering",crossOrigin:"crossorigin",dataType:"datatype",dominantBaseline:"dominant-baseline",enableBackground:"enable-background",fillOpacity:"fill-opacity",fillRule:"fill-rule",floodColor:"flood-color",floodOpacity:"flood-opacity",fontFamily:"font-family",fontSize:"font-size",fontSizeAdjust:"font-size-adjust",fontStretch:"font-stretch",fontStyle:"font-style",fontVariant:"font-variant",fontWeight:"font-weight",glyphName:"glyph-name",glyphOrientationHorizontal:"glyph-orientation-horizontal",glyphOrientationVertical:"glyph-orientation-vertical",hrefLang:"hreflang",horizAdvX:"horiz-adv-x",horizOriginX:"horiz-origin-x",horizOriginY:"horiz-origin-y",imageRendering:"image-rendering",letterSpacing:"letter-spacing",lightingColor:"lighting-color",markerEnd:"marker-end",markerMid:"marker-mid",markerStart:"marker-start",navDown:"nav-down",navDownLeft:"nav-down-left",navDownRight:"nav-down-right",navLeft:"nav-left",navNext:"nav-next",navPrev:"nav-prev",navRight:"nav-right",navUp:"nav-up",navUpLeft:"nav-up-left",navUpRight:"nav-up-right",onAbort:"onabort",onActivate:"onactivate",onAfterPrint:"onafterprint",onBeforePrint:"onbeforeprint",onBegin:"onbegin",onCancel:"oncancel",onCanPlay:"oncanplay",onCanPlayThrough:"oncanplaythrough",onChange:"onchange",onClick:"onclick",onClose:"onclose",onCopy:"oncopy",onCueChange:"oncuechange",onCut:"oncut",onDblClick:"ondblclick",onDrag:"ondrag",onDragEnd:"ondragend",onDragEnter:"ondragenter",onDragExit:"ondragexit",onDragLeave:"ondragleave",onDragOver:"ondragover",onDragStart:"ondragstart",onDrop:"ondrop",onDurationChange:"ondurationchange",onEmptied:"onemptied",onEnd:"onend",onEnded:"onended",onError:"onerror",onFocus:"onfocus",onFocusIn:"onfocusin",onFocusOut:"onfocusout",onHashChange:"onhashchange",onInput:"oninput",onInvalid:"oninvalid",onKeyDown:"onkeydown",onKeyPress:"onkeypress",onKeyUp:"onkeyup",onLoad:"onload",onLoadedData:"onloadeddata",onLoadedMetadata:"onloadedmetadata",onLoadStart:"onloadstart",onMessage:"onmessage",onMouseDown:"onmousedown",onMouseEnter:"onmouseenter",onMouseLeave:"onmouseleave",onMouseMove:"onmousemove",onMouseOut:"onmouseout",onMouseOver:"onmouseover",onMouseUp:"onmouseup",onMouseWheel:"onmousewheel",onOffline:"onoffline",onOnline:"ononline",onPageHide:"onpagehide",onPageShow:"onpageshow",onPaste:"onpaste",onPause:"onpause",onPlay:"onplay",onPlaying:"onplaying",onPopState:"onpopstate",onProgress:"onprogress",onRateChange:"onratechange",onRepeat:"onrepeat",onReset:"onreset",onResize:"onresize",onScroll:"onscroll",onSeeked:"onseeked",onSeeking:"onseeking",onSelect:"onselect",onShow:"onshow",onStalled:"onstalled",onStorage:"onstorage",onSubmit:"onsubmit",onSuspend:"onsuspend",onTimeUpdate:"ontimeupdate",onToggle:"ontoggle",onUnload:"onunload",onVolumeChange:"onvolumechange",onWaiting:"onwaiting",onZoom:"onzoom",overlinePosition:"overline-position",overlineThickness:"overline-thickness",paintOrder:"paint-order",panose1:"panose-1",pointerEvents:"pointer-events",referrerPolicy:"referrerpolicy",renderingIntent:"rendering-intent",shapeRendering:"shape-rendering",stopColor:"stop-color",stopOpacity:"stop-opacity",strikethroughPosition:"strikethrough-position",strikethroughThickness:"strikethrough-thickness",strokeDashArray:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",strokeLineCap:"stroke-linecap",strokeLineJoin:"stroke-linejoin",strokeMiterLimit:"stroke-miterlimit",strokeOpacity:"stroke-opacity",strokeWidth:"stroke-width",tabIndex:"tabindex",textAnchor:"text-anchor",textDecoration:"text-decoration",textRendering:"text-rendering",transformOrigin:"transform-origin",typeOf:"typeof",underlinePosition:"underline-position",underlineThickness:"underline-thickness",unicodeBidi:"unicode-bidi",unicodeRange:"unicode-range",unitsPerEm:"units-per-em",vAlphabetic:"v-alphabetic",vHanging:"v-hanging",vIdeographic:"v-ideographic",vMathematical:"v-mathematical",vectorEffect:"vector-effect",vertAdvY:"vert-adv-y",vertOriginX:"vert-origin-x",vertOriginY:"vert-origin-y",wordSpacing:"word-spacing",writingMode:"writing-mode",xHeight:"x-height",playbackOrder:"playbackorder",timelineBegin:"timelinebegin"},properties:{about:rt,accentHeight:B,accumulate:null,additive:null,alignmentBaseline:null,alphabetic:B,amplitude:B,arabicForm:null,ascent:B,attributeName:null,attributeType:null,azimuth:B,bandwidth:null,baselineShift:null,baseFrequency:null,baseProfile:null,bbox:null,begin:null,bias:B,by:null,calcMode:null,capHeight:B,className:Ie,clip:null,clipPath:null,clipPathUnits:null,clipRule:null,color:null,colorInterpolation:null,colorInterpolationFilters:null,colorProfile:null,colorRendering:null,content:null,contentScriptType:null,contentStyleType:null,crossOrigin:null,cursor:null,cx:null,cy:null,d:null,dataType:null,defaultAction:null,descent:B,diffuseConstant:B,direction:null,display:null,dur:null,divisor:B,dominantBaseline:null,download:be,dx:null,dy:null,edgeMode:null,editable:null,elevation:B,enableBackground:null,end:null,event:null,exponent:B,externalResourcesRequired:null,fill:null,fillOpacity:B,fillRule:null,filter:null,filterRes:null,filterUnits:null,floodColor:null,floodOpacity:null,focusable:null,focusHighlight:null,fontFamily:null,fontSize:null,fontSizeAdjust:null,fontStretch:null,fontStyle:null,fontVariant:null,fontWeight:null,format:null,fr:null,from:null,fx:null,fy:null,g1:hn,g2:hn,glyphName:hn,glyphOrientationHorizontal:null,glyphOrientationVertical:null,glyphRef:null,gradientTransform:null,gradientUnits:null,handler:null,hanging:B,hatchContentUnits:null,hatchUnits:null,height:null,href:null,hrefLang:null,horizAdvX:B,horizOriginX:B,horizOriginY:B,id:null,ideographic:B,imageRendering:null,initialVisibility:null,in:null,in2:null,intercept:B,k:B,k1:B,k2:B,k3:B,k4:B,kernelMatrix:rt,kernelUnitLength:null,keyPoints:null,keySplines:null,keyTimes:null,kerning:null,lang:null,lengthAdjust:null,letterSpacing:null,lightingColor:null,limitingConeAngle:B,local:null,markerEnd:null,markerMid:null,markerStart:null,markerHeight:null,markerUnits:null,markerWidth:null,mask:null,maskContentUnits:null,maskUnits:null,mathematical:null,max:null,media:null,mediaCharacterEncoding:null,mediaContentEncodings:null,mediaSize:B,mediaTime:null,method:null,min:null,mode:null,name:null,navDown:null,navDownLeft:null,navDownRight:null,navLeft:null,navNext:null,navPrev:null,navRight:null,navUp:null,navUpLeft:null,navUpRight:null,numOctaves:null,observer:null,offset:null,onAbort:null,onActivate:null,onAfterPrint:null,onBeforePrint:null,onBegin:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnd:null,onEnded:null,onError:null,onFocus:null,onFocusIn:null,onFocusOut:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadStart:null,onMessage:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onMouseWheel:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRepeat:null,onReset:null,onResize:null,onScroll:null,onSeeked:null,onSeeking:null,onSelect:null,onShow:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnload:null,onVolumeChange:null,onWaiting:null,onZoom:null,opacity:null,operator:null,order:null,orient:null,orientation:null,origin:null,overflow:null,overlay:null,overlinePosition:B,overlineThickness:B,paintOrder:null,panose1:null,path:null,pathLength:B,patternContentUnits:null,patternTransform:null,patternUnits:null,phase:null,ping:Ie,pitch:null,playbackOrder:null,pointerEvents:null,points:null,pointsAtX:B,pointsAtY:B,pointsAtZ:B,preserveAlpha:null,preserveAspectRatio:null,primitiveUnits:null,propagate:null,property:rt,r:null,radius:null,referrerPolicy:null,refX:null,refY:null,rel:rt,rev:rt,renderingIntent:null,repeatCount:null,repeatDur:null,requiredExtensions:rt,requiredFeatures:rt,requiredFonts:rt,requiredFormats:rt,resource:null,restart:null,result:null,rotate:null,rx:null,ry:null,scale:null,seed:null,shapeRendering:null,side:null,slope:null,snapshotTime:null,specularConstant:B,specularExponent:B,spreadMethod:null,spacing:null,startOffset:null,stdDeviation:null,stemh:null,stemv:null,stitchTiles:null,stopColor:null,stopOpacity:null,strikethroughPosition:B,strikethroughThickness:B,string:null,stroke:null,strokeDashArray:rt,strokeDashOffset:null,strokeLineCap:null,strokeLineJoin:null,strokeMiterLimit:B,strokeOpacity:B,strokeWidth:null,style:null,surfaceScale:B,syncBehavior:null,syncBehaviorDefault:null,syncMaster:null,syncTolerance:null,syncToleranceDefault:null,systemLanguage:rt,tabIndex:B,tableValues:null,target:null,targetX:B,targetY:B,textAnchor:null,textDecoration:null,textRendering:null,textLength:null,timelineBegin:null,title:null,transformBehavior:null,type:null,typeOf:rt,to:null,transform:null,transformOrigin:null,u1:null,u2:null,underlinePosition:B,underlineThickness:B,unicode:null,unicodeBidi:null,unicodeRange:null,unitsPerEm:B,values:null,vAlphabetic:B,vMathematical:B,vectorEffect:null,vHanging:B,vIdeographic:B,version:null,vertAdvY:B,vertOriginX:B,vertOriginY:B,viewBox:null,viewTarget:null,visibility:null,width:null,widths:null,wordSpacing:null,writingMode:null,x:null,x1:null,x2:null,xChannelSelector:null,xHeight:B,y:null,y1:null,y2:null,yChannelSelector:null,z:null,zoomAndPan:null},space:"svg",transform:Go}),Ko=yn({properties:{xLinkActuate:null,xLinkArcRole:null,xLinkHref:null,xLinkRole:null,xLinkShow:null,xLinkTitle:null,xLinkType:null},space:"xlink",transform(e,n){return"xlink:"+n.slice(5).toLowerCase()}}),Xo=yn({attributes:{xmlnsxlink:"xmlns:xlink"},properties:{xmlnsXLink:null,xmlns:null},space:"xmlns",transform:Yo}),Zo=yn({properties:{xmlBase:null,xmlLang:null,xmlSpace:null},space:"xml",transform(e,n){return"xml:"+n.slice(3).toLowerCase()}}),Bm=/[A-Z]/g,Bs=/-[a-z]/g,Um=/^data[-\w.:]+$/i;function Mm(e,n){const t=Oi(n);let r=n,s=Ze;if(t in e.normal)return e.property[e.normal[t]];if(t.length>4&&t.slice(0,4)==="data"&&Um.test(n)){if(n.charAt(4)==="-"){const a=n.slice(5).replace(Bs,Wm);r="data"+a.charAt(0).toUpperCase()+a.slice(1)}else{const a=n.slice(4);if(!Bs.test(a)){let o=a.replace(Bm,Hm);o.charAt(0)!=="-"&&(o="-"+o),n="data"+o}}s=Yi}return new s(r,n)}function Hm(e){return"-"+e.toLowerCase()}function Wm(e){return e.charAt(1).toUpperCase()}const Vm=Jo([Qo,zm,Ko,Xo,Zo],"html"),el=Jo([Qo,qm,Ko,Xo,Zo],"svg"),Jm=/["&'<>`]/g,Qm=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,Gm=/[\x01-\t\v\f\x0E-\x1F\x7F\x81\x8D\x8F\x90\x9D\xA0-\uFFFF]/g,Ym=/[|\\{}()[\]^$+*?.]/g,Us=new WeakMap;function Km(e,n){if(e=e.replace(n.subset?Xm(n.subset):Jm,r),n.subset||n.escapeOnly)return e;return e.replace(Qm,t).replace(Gm,r);function t(s,a,o){return n.format((s.charCodeAt(0)-55296)*1024+s.charCodeAt(1)-56320+65536,o.charCodeAt(a+2),n)}function r(s,a,o){return n.format(s.charCodeAt(0),o.charCodeAt(a+1),n)}}function Xm(e){let n=Us.get(e);return n||(n=Zm(e),Us.set(e,n)),n}function Zm(e){const n=[];let t=-1;for(;++t<e.length;)n.push(e[t].replace(Ym,"\\$&"));return new RegExp("(?:"+n.join("|")+")","g")}const ef=/[\dA-Fa-f]/;function tf(e,n,t){const r="&#x"+e.toString(16).toUpperCase();return t&&n&&!ef.test(String.fromCharCode(n))?r:r+";"}const nf=/\d/;function rf(e,n,t){const r="&#"+String(e);return t&&n&&!nf.test(String.fromCharCode(n))?r:r+";"}const af=["AElig","AMP","Aacute","Acirc","Agrave","Aring","Atilde","Auml","COPY","Ccedil","ETH","Eacute","Ecirc","Egrave","Euml","GT","Iacute","Icirc","Igrave","Iuml","LT","Ntilde","Oacute","Ocirc","Ograve","Oslash","Otilde","Ouml","QUOT","REG","THORN","Uacute","Ucirc","Ugrave","Uuml","Yacute","aacute","acirc","acute","aelig","agrave","amp","aring","atilde","auml","brvbar","ccedil","cedil","cent","copy","curren","deg","divide","eacute","ecirc","egrave","eth","euml","frac12","frac14","frac34","gt","iacute","icirc","iexcl","igrave","iquest","iuml","laquo","lt","macr","micro","middot","nbsp","not","ntilde","oacute","ocirc","ograve","ordf","ordm","oslash","otilde","ouml","para","plusmn","pound","quot","raquo","reg","sect","shy","sup1","sup2","sup3","szlig","thorn","times","uacute","ucirc","ugrave","uml","uuml","yacute","yen","yuml"],wi={nbsp:" ",iexcl:"¡",cent:"¢",pound:"£",curren:"¤",yen:"¥",brvbar:"¦",sect:"§",uml:"¨",copy:"©",ordf:"ª",laquo:"«",not:"¬",shy:"­",reg:"®",macr:"¯",deg:"°",plusmn:"±",sup2:"²",sup3:"³",acute:"´",micro:"µ",para:"¶",middot:"·",cedil:"¸",sup1:"¹",ordm:"º",raquo:"»",frac14:"¼",frac12:"½",frac34:"¾",iquest:"¿",Agrave:"À",Aacute:"Á",Acirc:"Â",Atilde:"Ã",Auml:"Ä",Aring:"Å",AElig:"Æ",Ccedil:"Ç",Egrave:"È",Eacute:"É",Ecirc:"Ê",Euml:"Ë",Igrave:"Ì",Iacute:"Í",Icirc:"Î",Iuml:"Ï",ETH:"Ð",Ntilde:"Ñ",Ograve:"Ò",Oacute:"Ó",Ocirc:"Ô",Otilde:"Õ",Ouml:"Ö",times:"×",Oslash:"Ø",Ugrave:"Ù",Uacute:"Ú",Ucirc:"Û",Uuml:"Ü",Yacute:"Ý",THORN:"Þ",szlig:"ß",agrave:"à",aacute:"á",acirc:"â",atilde:"ã",auml:"ä",aring:"å",aelig:"æ",ccedil:"ç",egrave:"è",eacute:"é",ecirc:"ê",euml:"ë",igrave:"ì",iacute:"í",icirc:"î",iuml:"ï",eth:"ð",ntilde:"ñ",ograve:"ò",oacute:"ó",ocirc:"ô",otilde:"õ",ouml:"ö",divide:"÷",oslash:"ø",ugrave:"ù",uacute:"ú",ucirc:"û",uuml:"ü",yacute:"ý",thorn:"þ",yuml:"ÿ",fnof:"ƒ",Alpha:"Α",Beta:"Β",Gamma:"Γ",Delta:"Δ",Epsilon:"Ε",Zeta:"Ζ",Eta:"Η",Theta:"Θ",Iota:"Ι",Kappa:"Κ",Lambda:"Λ",Mu:"Μ",Nu:"Ν",Xi:"Ξ",Omicron:"Ο",Pi:"Π",Rho:"Ρ",Sigma:"Σ",Tau:"Τ",Upsilon:"Υ",Phi:"Φ",Chi:"Χ",Psi:"Ψ",Omega:"Ω",alpha:"α",beta:"β",gamma:"γ",delta:"δ",epsilon:"ε",zeta:"ζ",eta:"η",theta:"θ",iota:"ι",kappa:"κ",lambda:"λ",mu:"μ",nu:"ν",xi:"ξ",omicron:"ο",pi:"π",rho:"ρ",sigmaf:"ς",sigma:"σ",tau:"τ",upsilon:"υ",phi:"φ",chi:"χ",psi:"ψ",omega:"ω",thetasym:"ϑ",upsih:"ϒ",piv:"ϖ",bull:"•",hellip:"…",prime:"′",Prime:"″",oline:"‾",frasl:"⁄",weierp:"℘",image:"ℑ",real:"ℜ",trade:"™",alefsym:"ℵ",larr:"←",uarr:"↑",rarr:"→",darr:"↓",harr:"↔",crarr:"↵",lArr:"⇐",uArr:"⇑",rArr:"⇒",dArr:"⇓",hArr:"⇔",forall:"∀",part:"∂",exist:"∃",empty:"∅",nabla:"∇",isin:"∈",notin:"∉",ni:"∋",prod:"∏",sum:"∑",minus:"−",lowast:"∗",radic:"√",prop:"∝",infin:"∞",ang:"∠",and:"∧",or:"∨",cap:"∩",cup:"∪",int:"∫",there4:"∴",sim:"∼",cong:"≅",asymp:"≈",ne:"≠",equiv:"≡",le:"≤",ge:"≥",sub:"⊂",sup:"⊃",nsub:"⊄",sube:"⊆",supe:"⊇",oplus:"⊕",otimes:"⊗",perp:"⊥",sdot:"⋅",lceil:"⌈",rceil:"⌉",lfloor:"⌊",rfloor:"⌋",lang:"〈",rang:"〉",loz:"◊",spades:"♠",clubs:"♣",hearts:"♥",diams:"♦",quot:'"',amp:"&",lt:"<",gt:">",OElig:"Œ",oelig:"œ",Scaron:"Š",scaron:"š",Yuml:"Ÿ",circ:"ˆ",tilde:"˜",ensp:" ",emsp:" ",thinsp:" ",zwnj:"‌",zwj:"‍",lrm:"‎",rlm:"‏",ndash:"–",mdash:"—",lsquo:"‘",rsquo:"’",sbquo:"‚",ldquo:"“",rdquo:"”",bdquo:"„",dagger:"†",Dagger:"‡",permil:"‰",lsaquo:"‹",rsaquo:"›",euro:"€"},sf=["cent","copy","divide","gt","lt","not","para","times"],tl={}.hasOwnProperty,Ri={};let ur;for(ur in wi)tl.call(wi,ur)&&(Ri[wi[ur]]=ur);const of=/[^\dA-Za-z]/;function lf(e,n,t,r){const s=String.fromCharCode(e);if(tl.call(Ri,s)){const a=Ri[s],o="&"+a;return t&&af.includes(a)&&!sf.includes(a)&&(!r||n&&n!==61&&of.test(String.fromCharCode(n)))?o:o+";"}return""}function cf(e,n,t){let r=tf(e,n,t.omitOptionalSemicolons),s;if((t.useNamedReferences||t.useShortestReferences)&&(s=lf(e,n,t.omitOptionalSemicolons,t.attribute)),(t.useShortestReferences||!s)&&t.useShortestReferences){const a=rf(e,n,t.omitOptionalSemicolons);a.length<r.length&&(r=a)}return s&&(!t.useShortestReferences||s.length<r.length)?s:r}function mn(e,n){return Km(e,Object.assign({format:cf},n))}const uf=/^>|^->|<!--|-->|--!>|<!-$/g,df=[">"],pf=["<",">"];function hf(e,n,t,r){return r.settings.bogusComments?"<?"+mn(e.value,Object.assign({},r.settings.characterReferences,{subset:df}))+">":"<!--"+e.value.replace(uf,s)+"-->";function s(a){return mn(a,Object.assign({},r.settings.characterReferences,{subset:pf}))}}function mf(e,n,t,r){return"<!"+(r.settings.upperDoctype?"DOCTYPE":"doctype")+(r.settings.tightDoctype?"":" ")+"html>"}function Ms(e,n){const t=String(e);if(typeof n!="string")throw new TypeError("Expected character");let r=0,s=t.indexOf(n);for(;s!==-1;)r++,s=t.indexOf(n,s+n.length);return r}function ff(e,n){const t=n||{};return(e[e.length-1]===""?[...e,""]:e).join((t.padRight?" ":"")+","+(t.padLeft===!1?"":" ")).trim()}function gf(e){return e.join(" ").trim()}const yf=/[ \t\n\f\r]/g;function Ki(e){return typeof e=="object"?e.type==="text"?Hs(e.value):!1:Hs(e)}function Hs(e){return e.replace(yf,"")===""}const Ue=rl(1),nl=rl(-1),xf=[];function rl(e){return n;function n(t,r,s){const a=t?t.children:xf;let o=(r||0)+e,l=a[o];if(!s)for(;l&&Ki(l);)o+=e,l=a[o];return l}}const bf={}.hasOwnProperty;function il(e){return n;function n(t,r,s){return bf.call(e,t.tagName)&&e[t.tagName](t,r,s)}}const Xi=il({body:kf,caption:ki,colgroup:ki,dd:jf,dt:vf,head:ki,html:wf,li:Nf,optgroup:Cf,option:Sf,p:_f,rp:Ws,rt:Ws,tbody:Pf,td:Vs,tfoot:Ef,th:Vs,thead:Tf,tr:Af});function ki(e,n,t){const r=Ue(t,n,!0);return!r||r.type!=="comment"&&!(r.type==="text"&&Ki(r.value.charAt(0)))}function wf(e,n,t){const r=Ue(t,n);return!r||r.type!=="comment"}function kf(e,n,t){const r=Ue(t,n);return!r||r.type!=="comment"}function _f(e,n,t){const r=Ue(t,n);return r?r.type==="element"&&(r.tagName==="address"||r.tagName==="article"||r.tagName==="aside"||r.tagName==="blockquote"||r.tagName==="details"||r.tagName==="div"||r.tagName==="dl"||r.tagName==="fieldset"||r.tagName==="figcaption"||r.tagName==="figure"||r.tagName==="footer"||r.tagName==="form"||r.tagName==="h1"||r.tagName==="h2"||r.tagName==="h3"||r.tagName==="h4"||r.tagName==="h5"||r.tagName==="h6"||r.tagName==="header"||r.tagName==="hgroup"||r.tagName==="hr"||r.tagName==="main"||r.tagName==="menu"||r.tagName==="nav"||r.tagName==="ol"||r.tagName==="p"||r.tagName==="pre"||r.tagName==="section"||r.tagName==="table"||r.tagName==="ul"):!t||!(t.type==="element"&&(t.tagName==="a"||t.tagName==="audio"||t.tagName==="del"||t.tagName==="ins"||t.tagName==="map"||t.tagName==="noscript"||t.tagName==="video"))}function Nf(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&r.tagName==="li"}function vf(e,n,t){const r=Ue(t,n);return!!(r&&r.type==="element"&&(r.tagName==="dt"||r.tagName==="dd"))}function jf(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&(r.tagName==="dt"||r.tagName==="dd")}function Ws(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&(r.tagName==="rp"||r.tagName==="rt")}function Cf(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&r.tagName==="optgroup"}function Sf(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&(r.tagName==="option"||r.tagName==="optgroup")}function Tf(e,n,t){const r=Ue(t,n);return!!(r&&r.type==="element"&&(r.tagName==="tbody"||r.tagName==="tfoot"))}function Pf(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&(r.tagName==="tbody"||r.tagName==="tfoot")}function Ef(e,n,t){return!Ue(t,n)}function Af(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&r.tagName==="tr"}function Vs(e,n,t){const r=Ue(t,n);return!r||r.type==="element"&&(r.tagName==="td"||r.tagName==="th")}const Df=il({body:$f,colgroup:Lf,head:Of,html:If,tbody:Rf});function If(e){const n=Ue(e,-1);return!n||n.type!=="comment"}function Of(e){const n=new Set;for(const r of e.children)if(r.type==="element"&&(r.tagName==="base"||r.tagName==="title")){if(n.has(r.tagName))return!1;n.add(r.tagName)}const t=e.children[0];return!t||t.type==="element"}function $f(e){const n=Ue(e,-1,!0);return!n||n.type!=="comment"&&!(n.type==="text"&&Ki(n.value.charAt(0)))&&!(n.type==="element"&&(n.tagName==="meta"||n.tagName==="link"||n.tagName==="script"||n.tagName==="style"||n.tagName==="template"))}function Lf(e,n,t){const r=nl(t,n),s=Ue(e,-1,!0);return t&&r&&r.type==="element"&&r.tagName==="colgroup"&&Xi(r,t.children.indexOf(r),t)?!1:!!(s&&s.type==="element"&&s.tagName==="col")}function Rf(e,n,t){const r=nl(t,n),s=Ue(e,-1);return t&&r&&r.type==="element"&&(r.tagName==="thead"||r.tagName==="tbody")&&Xi(r,t.children.indexOf(r),t)?!1:!!(s&&s.type==="element"&&s.tagName==="tr")}const dr={name:[[`	
\f\r &/=>`.split(""),`	
\f\r "&'/=>\``.split("")],[`\0	
\f\r "&'/<=>`.split(""),`\0	
\f\r "&'/<=>\``.split("")]],unquoted:[[`	
\f\r &>`.split(""),`\0	
\f\r "&'<=>\``.split("")],[`\0	
\f\r "&'<=>\``.split(""),`\0	
\f\r "&'<=>\``.split("")]],single:[["&'".split(""),"\"&'`".split("")],["\0&'".split(""),"\0\"&'`".split("")]],double:[['"&'.split(""),"\"&'`".split("")],['\0"&'.split(""),"\0\"&'`".split("")]]};function Ff(e,n,t,r){const s=r.schema,a=s.space==="svg"?!1:r.settings.omitOptionalTags;let o=s.space==="svg"?r.settings.closeEmptyElements:r.settings.voids.includes(e.tagName.toLowerCase());const l=[];let c;s.space==="html"&&e.tagName==="svg"&&(r.schema=el);const u=zf(r,e.properties),m=r.all(s.space==="html"&&e.tagName==="template"?e.content:e);return r.schema=s,m&&(o=!1),(u||!a||!Df(e,n,t))&&(l.push("<",e.tagName,u?" "+u:""),o&&(s.space==="svg"||r.settings.closeSelfClosing)&&(c=u.charAt(u.length-1),(!r.settings.tightSelfClosing||c==="/"||c&&c!=='"'&&c!=="'")&&l.push(" "),l.push("/")),l.push(">")),l.push(m),!o&&(!a||!Xi(e,n,t))&&l.push("</"+e.tagName+">"),l.join("")}function zf(e,n){const t=[];let r=-1,s;if(n){for(s in n)if(n[s]!==null&&n[s]!==void 0){const a=qf(e,s,n[s]);a&&t.push(a)}}for(;++r<t.length;){const a=e.settings.tightAttributes?t[r].charAt(t[r].length-1):void 0;r!==t.length-1&&a!=='"'&&a!=="'"&&(t[r]+=" ")}return t.join("")}function qf(e,n,t){const r=Mm(e.schema,n),s=e.settings.allowParseErrors&&e.schema.space==="html"?0:1,a=e.settings.allowDangerousCharacters?0:1;let o=e.quote,l;if(r.overloadedBoolean&&(t===r.attribute||t==="")?t=!0:(r.boolean||r.overloadedBoolean)&&(typeof t!="string"||t===r.attribute||t==="")&&(t=!!t),t==null||t===!1||typeof t=="number"&&Number.isNaN(t))return"";const c=mn(r.attribute,Object.assign({},e.settings.characterReferences,{subset:dr.name[s][a]}));return t===!0||(t=Array.isArray(t)?(r.commaSeparated?ff:gf)(t,{padLeft:!e.settings.tightCommaSeparatedLists}):String(t),e.settings.collapseEmptyAttributes&&!t)?c:(e.settings.preferUnquoted&&(l=mn(t,Object.assign({},e.settings.characterReferences,{attribute:!0,subset:dr.unquoted[s][a]}))),l!==t&&(e.settings.quoteSmart&&Ms(t,o)>Ms(t,e.alternative)&&(o=e.alternative),l=o+mn(t,Object.assign({},e.settings.characterReferences,{subset:(o==="'"?dr.single:dr.double)[s][a],attribute:!0}))+o),c+(l&&"="+l))}const Bf=["<","&"];function al(e,n,t,r){return t&&t.type==="element"&&(t.tagName==="script"||t.tagName==="style")?e.value:mn(e.value,Object.assign({},r.settings.characterReferences,{subset:Bf}))}function Uf(e,n,t,r){return r.settings.allowDangerousHtml?e.value:al(e,n,t,r)}function Mf(e,n,t,r){return r.all(e)}const Hf=bo("type",{invalid:Wf,unknown:Vf,handlers:{comment:hf,doctype:mf,element:Ff,raw:Uf,root:Mf,text:al}});function Wf(e){throw new Error("Expected node, not `"+e+"`")}function Vf(e){const n=e;throw new Error("Cannot compile unknown node `"+n.type+"`")}const Jf={},Qf={},Gf=[];function Yf(e,n){const t=n||Jf,r=t.quote||'"',s=r==='"'?"'":'"';if(r!=='"'&&r!=="'")throw new Error("Invalid quote `"+r+"`, expected `'` or `\"`");return{one:Kf,all:Xf,settings:{omitOptionalTags:t.omitOptionalTags||!1,allowParseErrors:t.allowParseErrors||!1,allowDangerousCharacters:t.allowDangerousCharacters||!1,quoteSmart:t.quoteSmart||!1,preferUnquoted:t.preferUnquoted||!1,tightAttributes:t.tightAttributes||!1,upperDoctype:t.upperDoctype||!1,tightDoctype:t.tightDoctype||!1,bogusComments:t.bogusComments||!1,tightCommaSeparatedLists:t.tightCommaSeparatedLists||!1,tightSelfClosing:t.tightSelfClosing||!1,collapseEmptyAttributes:t.collapseEmptyAttributes||!1,allowDangerousHtml:t.allowDangerousHtml||!1,voids:t.voids||Rm,characterReferences:t.characterReferences||Qf,closeSelfClosing:t.closeSelfClosing||!1,closeEmptyElements:t.closeEmptyElements||!1},schema:t.space==="svg"?el:Vm,quote:r,alternative:s}.one(Array.isArray(e)?{type:"root",children:e}:e,void 0,void 0)}function Kf(e,n,t){return Hf(e,n,t,this)}function Xf(e){const n=[],t=e&&e.children||Gf;let r=-1;for(;++r<t.length;)n[r]=this.one(t[r],r,e);return n.join("")}const Zf={};function _i(e){const n=this,{handlers:t,sanitize:r,...s}=e||Zf;let a=!1,o;typeof r=="boolean"?a=!r:r&&(o=r),n.compiler=l;function l(c,u){const m=Lm(c,{handlers:t,allowDangerousHtml:a}),d=a?m:Vh(m,o),y=Yf(d,{...s,allowDangerousHtml:a});return u.extname&&(u.extname=".html"),c&&c.type==="root"&&y&&/[^\r\n]/.test(y.charAt(y.length-1))?y+`
`:y}}const eg=({isOpen:e,onClose:n,patientId:t,pharmacyInventory:r,fetchPharmacyOrdersData:s,isLoadingInventory:a=!1})=>{const[o,l]=b.useState([]),[c,u]=b.useState(""),[m,d]=b.useState([]),[y,p]=b.useState(null),[A,q]=b.useState(!1);Gs(void 0,e?200:99999);const K=b.useMemo(()=>new Ys(r,{keys:["name"],threshold:.3}),[r]);b.useEffect(()=>{if(!c){d([]);return}const F=K.search(c).map(j=>j.item);d(F.slice(0,10))},[c,K]);const $=async()=>{if(!t){p("Patient ID is missing.");return}if(o.length===0){p("Please select at least one drug.");return}for(const F of o)if(F.selected_pack_quantity===0&&F.selected_loose_quantity===0){p(`Please specify a quantity for ${F.name}.`);return}q(!0),p(null);try{const F={patient_id:t,items:o.map(Z=>({drug_id:Z.id,name:Z.name,pack_quantity:Z.selected_pack_quantity,loose_quantity:Z.selected_loose_quantity,pack_price:0,loose_price:0,total_price:0,tabletsPerDay:1,numberOfDays:1,directions_to_use:"As directed"})),order_total:0,prescription_for_unavailable_drugs:""},j=await G("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(F)});if(!j.ok){const Z=await j.json().catch(()=>({}));throw new Error(Z.message||`Failed to create pharmacy order: ${j.statusText} `)}await j.json(),s(t),n(),l([]),u("")}catch(F){p(`Order Creation Error: ${F.message} `)}finally{q(!1)}},H=F=>{if(o.some(j=>j.id===F.id)){p(`${F.name} is already in the order.`),setTimeout(()=>p(null),3e3),u(""),d([]);return}l(j=>[...j,{...F,selected_pack_quantity:0,selected_loose_quantity:0}]),u(""),d([])},L=F=>{l(j=>j.filter(Z=>Z.id!==F))},W=(F,j,Z)=>{const ce=parseInt(Z)||0;l(ne=>ne.map(le=>le.id===F?{...le,[j==="pack"?"selected_pack_quantity":"selected_loose_quantity"]:ce}:le))};return e?i.jsx("div",{className:se.modalOverlay,children:i.jsxs("div",{className:se.modalContent,children:[i.jsxs("div",{className:se.modalHeader,children:[i.jsx("h3",{className:se.modalTitle,children:"Create Pharmacy Order"}),i.jsx("button",{onClick:n,className:se.modalCloseButton,children:i.jsx(fn,{size:20})})]}),i.jsxs("div",{className:se.modalBody,children:[y&&i.jsx("div",{className:se.errorText,children:y}),i.jsxs("div",{className:se.formGroup,style:{position:"relative"},children:[i.jsx("label",{htmlFor:"drug-search",children:"Add Drug"}),i.jsx("input",{type:"text",id:"drug-search",placeholder:"Search available drugs...",value:c,onChange:F=>u(F.target.value),className:se.inputField,autoComplete:"off"}),c&&i.jsx("div",{className:se.searchResultsCard,children:a?i.jsx("div",{className:"p-2 space-y-2",children:[1,2,3].map(F=>i.jsxs("div",{className:"flex justify-between items-center py-2 px-3",children:[i.jsx(Te,{width:"60%",height:20}),i.jsx(Te,{width:"30%",height:20})]},F))}):m.length>0?i.jsx("ul",{className:se.searchResultsList,children:m.map(F=>i.jsx("li",{onClick:()=>H(F),className:se.searchResultItem,children:i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"},children:[i.jsx("span",{children:F.name}),i.jsxs("span",{className:se.searchResultPrice,children:["Stock: ",F.stock," (Box) / ",F.loose||0," (Loose)"]})]})},F.id))}):i.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No drugs found."})})]}),i.jsxs("div",{className:se.selectedTestsCard,children:[" ",i.jsx("h4",{className:se.selectedTestsHeader,children:"Selected Drugs"}),o.length===0?i.jsx("p",{className:se.noTestsMessage,children:"No drugs added yet."}):i.jsx("ul",{className:se.selectedTestsList,children:o.map(F=>i.jsxs("li",{className:se.selectedTestItem,style:{flexDirection:"column",alignItems:"flex-start",gap:"8px"},children:[i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",width:"100%",alignItems:"center"},children:[i.jsx("span",{className:se.selectedTestName,style:{fontWeight:"bold"},children:F.name}),i.jsx("button",{type:"button",onClick:()=>L(String(F.id)),className:se.removeTestButton,title:"Remove Drug",children:i.jsx(ft,{size:16})})]}),i.jsxs("div",{style:{display:"flex",gap:"10px",alignItems:"center",width:"100%"},children:[i.jsxs("div",{style:{flex:1},children:[i.jsx("label",{style:{fontSize:"0.75rem",color:"#666"},children:"Packs"}),i.jsx("input",{type:"number",min:"0",className:se.inputField,style:{padding:"4px 8px"},value:F.selected_pack_quantity||"",onChange:j=>W(F.id,"pack",j.target.value),placeholder:"0"})]}),i.jsxs("div",{style:{flex:1},children:[i.jsx("label",{style:{fontSize:"0.75rem",color:"#666"},children:"Loose"}),i.jsx("input",{type:"number",min:"0",className:se.inputField,style:{padding:"4px 8px"},value:F.selected_loose_quantity||"",onChange:j=>W(F.id,"loose",j.target.value),placeholder:"0"})]})]})]},F.id))})]})]}),i.jsxs("div",{className:se.modalFooter,children:[i.jsx("button",{type:"button",onClick:n,className:`${se.button} ${se.buttonSecondary} `,children:" Cancel "}),i.jsxs("button",{type:"button",onClick:$,disabled:o.length===0||A,className:`${se.button} ${se.buttonPrimary} ${o.length===0||A?se.buttonDisabled:""} `,children:[" ",A?"Creating...":"Create Order"," "]})]})]})}):null},tg=({isOpen:e,onClose:n,onSuccess:t,patientId:r,initialItems:s})=>{const[a,o]=b.useState([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:"",packs:0,loose:0,pack_size:1}]),[l,c]=b.useState(30),[u,m]=b.useState(""),[d,y]=b.useState(null),[p,A]=b.useState(""),[q,K]=b.useState([]),[$,H]=b.useState(!1),[L,W]=b.useState(!1),[F,j]=b.useState(null),Z=b.useRef(null);b.useEffect(()=>{if(e){s&&s.length>0?o(s):o([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:"",packs:0,loose:0,pack_size:1}]);const E=new Date;E.setDate(E.getDate()+30),m(E.toISOString().split("T")[0]),c(30)}},[e,s]);const ce=b.useCallback(async E=>{if(!E.trim()){K([]);return}H(!0);try{const U=await G(`/api/drugs?search=${encodeURIComponent(E)}&limit=10`);if(U.ok){const J=await U.json();K(J.drugs||[])}}catch(U){console.error("Error searching drugs:",U)}finally{H(!1)}},[]);b.useEffect(()=>{Z.current&&clearTimeout(Z.current),p&&d!==null?Z.current=setTimeout(()=>ce(p),300):K([])},[p,d,ce]);const ne=E=>{if(!E)return 1;const U=E.match(/(?:\d+x)?(\d+)(?:s|tabs)?/i);return U?parseInt(U[1],10):1},le=(E,U)=>{const J=[...a];J[U]={...J[U],medication_name:E.name,drug_id:E.id,pack_size:ne(E.pack),packs:0,loose:0,quantity:0},o(J),y(null),A(""),K([])},V=(E,U,J)=>{const Se=[...a],pe={...Se[E]},w=pe.pack_size||1;if(U==="packs"||U==="loose"){const Fe=parseInt(J)||0;U==="packs"&&(pe.packs=Fe),U==="loose"&&(pe.loose=Fe);const we=pe.packs||0,x=pe.loose||0;pe.quantity=we*w+x}else if(U==="tablets_per_day"||U==="number_of_days"){U==="tablets_per_day"&&(pe.tablets_per_day=J),U==="number_of_days"&&(pe.number_of_days=J);const Fe=parseFloat(pe.tablets_per_day.toString())||0,we=parseInt(pe.number_of_days.toString())||0,x=Math.ceil(Fe*we);pe.quantity=x,pe.packs=Math.floor(x/w),pe.loose=x%w}else pe[U]=J;Se[E]=pe,o(Se)},_=()=>{o([...a,{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:l,directions:"",notes:"",packs:0,loose:0,pack_size:1}])},C=E=>{a.length>1&&o(a.filter((U,J)=>J!==E))},Y=async E=>{if(E.preventDefault(),j(null),!r){j("Patient ID is missing.");return}if(a.some(J=>!J.medication_name||J.quantity<=0)){j("Please ensure all items have a medication name and valid quantity.");return}W(!0);try{const J={patient_id:r,items:a.map(pe=>({medication_name:pe.medication_name,drug_id:pe.drug_id,quantity:pe.quantity,tablets_per_day:pe.tablets_per_day,number_of_days:pe.number_of_days,directions:pe.directions,notes:pe.notes,frequency_days:l,next_delivery_date:u}))},Se=await G("/api/recurring-medications",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(J)});if(!Se.ok){const pe=await Se.json();throw new Error(pe.message+(pe.error?": "+pe.error:"")||"Failed to create recurring medication.")}t(),n()}catch(J){j(J.message)}finally{W(!1)}};return e?i.jsx("div",{className:"modal-overlay",children:i.jsxs("div",{className:"add-recurring-modal",style:{maxWidth:"800px",width:"95%"},children:[i.jsxs("div",{className:"modal-header",children:[i.jsx("h3",{children:"Add Recurring Medications"}),i.jsx("button",{className:"close-btn",onClick:n,children:i.jsx(fn,{size:20})})]}),i.jsxs("div",{className:"modal-body",children:[F&&i.jsx("div",{className:"error-message",children:F}),i.jsxs("form",{onSubmit:Y,className:"recurring-form",children:[i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsxs("label",{children:[i.jsx(Ks,{size:16})," Frequency"]}),i.jsxs("select",{value:l,onChange:E=>{const U=parseInt(E.target.value);c(U);const J=new Date;J.setDate(J.getDate()+U),m(J.toISOString().split("T")[0]);const Se=a.map(pe=>({...pe,number_of_days:U}));o(Se)},children:[i.jsx("option",{value:15,children:"Every 15 Days"}),i.jsx("option",{value:30,children:"Every 30 Days"}),i.jsx("option",{value:60,children:"Every 60 Days"}),i.jsx("option",{value:90,children:"Every 90 Days"})]})]}),i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsxs("label",{children:[i.jsx(yr,{size:16})," Next Delivery"]}),i.jsx("input",{type:"date",value:u,onChange:E=>m(E.target.value)})]})]}),i.jsx("hr",{className:"divider"}),i.jsxs("div",{className:"items-header",children:[i.jsx("h4",{children:"Medications"}),i.jsxs("button",{type:"button",className:"add-item-btn",onClick:_,children:[i.jsx(pr,{size:14})," Add Drug"]})]}),i.jsx("div",{className:"items-list",children:a.map((E,U)=>i.jsxs("div",{className:"medication-item-row",children:[i.jsxs("div",{className:"row-top",children:[i.jsxs("div",{className:"form-group med-search-group",children:[i.jsx("label",{children:"Drug Name"}),i.jsxs("div",{className:"search-wrapper",children:[i.jsx("input",{type:"text",placeholder:"Search drug...",value:d===U?p:E.medication_name,onFocus:()=>{y(U),A(E.medication_name)},onChange:J=>{A(J.target.value),V(U,"medication_name",J.target.value)}}),d===U&&$&&i.jsx("span",{className:"spinner",children:"..."}),d===U&&p&&q.length>0&&i.jsx("ul",{className:"suggestions-list",children:q.map(J=>i.jsxs("li",{onClick:()=>le(J,U),children:[i.jsx("div",{className:"suggestion-name",children:J.name}),i.jsxs("div",{className:"suggestion-details",children:["Stock: ",J.stock]})]},J.id))})]})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Tabs/Day"}),i.jsx("input",{type:"number",min:"0.5",step:"0.5",value:E.tablets_per_day,onChange:J=>V(U,"tablets_per_day",J.target.value)})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Days"}),i.jsx("input",{type:"number",min:"1",value:E.number_of_days,onChange:J=>V(U,"number_of_days",J.target.value)})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Packs"}),i.jsx("input",{type:"number",min:"0",value:E.packs||"",onChange:J=>V(U,"packs",J.target.value),placeholder:"0"})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Loose"}),i.jsx("input",{type:"number",min:"0",value:E.loose||"",onChange:J=>V(U,"loose",J.target.value),placeholder:"0"})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Total"}),i.jsx("input",{type:"number",value:E.quantity,disabled:!0,style:{backgroundColor:"#f5f5f5",cursor:"not-allowed"}})]}),i.jsx("button",{type:"button",className:"remove-btn",onClick:()=>C(U),disabled:a.length===1,children:i.jsx(ft,{size:16})})]}),i.jsxs("div",{className:"row-bottom",children:[i.jsx("div",{className:"form-group",style:{flex:1},children:i.jsx("input",{type:"text",placeholder:"Directions (e.g. 1-0-1 after food)",value:E.directions,onChange:J=>V(U,"directions",J.target.value)})}),i.jsx("div",{className:"form-group",style:{flex:1},children:i.jsx("input",{type:"text",placeholder:"Notes",value:E.notes,onChange:J=>V(U,"notes",J.target.value)})})]})]},E.id))}),i.jsxs("div",{className:"modal-actions",children:[i.jsx("button",{type:"button",className:"btn-cancel",onClick:n,children:"Cancel"}),i.jsx("button",{type:"submit",className:"btn-submit",disabled:L,children:L?"Creating...":"Create Recurring Order"})]})]})]})]})}):null},ng=({isOpen:e,onClose:n,onSuccess:t,medication:r})=>{const[s,a]=b.useState(""),[o,l]=b.useState(0),[c,u]=b.useState(1),[m,d]=b.useState(30),[y,p]=b.useState(""),[A,q]=b.useState(""),[K,$]=b.useState(30),[H,L]=b.useState(""),[W,F]=b.useState("active"),[j,Z]=b.useState(!1),[ce,ne]=b.useState(null);b.useEffect(()=>{if(e&&r){a(r.medicationName),l(r.quantity),u(r.tabletsPerDay||1),d(r.numberOfDays||30),p(r.directions||""),q(r.notes||""),$(r.frequencyDays),F(r.status);try{const _=new Date(r.nextDeliveryDate);isNaN(_.getTime())||L(_.toISOString().split("T")[0])}catch(_){console.error("Error parsing date",_)}}},[e,r]);const le=async _=>{if(_.preventDefault(),ne(null),!s||o<=0){ne("Please provide a valid medication name and quantity.");return}Z(!0);try{const C={medication_name:s,quantity:o,tablets_per_day:c,number_of_days:m,directions:y,notes:A,frequency_days:K,next_delivery_date:H,status:W},Y=await G(`/api/recurring-medications/${r.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(C)});if(!Y.ok){const E=await Y.json();throw new Error(E.message||"Failed to update recurring medication.")}t(),n()}catch(C){ne(C.message)}finally{Z(!1)}},V=async()=>{if(window.confirm("Are you sure you want to delete this recurring medication?")){Z(!0);try{if(!(await G(`/api/recurring-medications/${r.id}`,{method:"DELETE"})).ok)throw new Error("Failed to delete recurring medication.");t(),n()}catch(_){ne(_.message)}finally{Z(!1)}}};return e?i.jsx("div",{className:"modal-overlay",children:i.jsxs("div",{className:"add-recurring-modal",style:{maxWidth:"600px",width:"90%"},children:[i.jsxs("div",{className:"modal-header",children:[i.jsx("h3",{children:"Edit Recurring Medication"}),i.jsx("button",{className:"close-btn",onClick:n,children:i.jsx(fn,{size:20})})]}),i.jsxs("div",{className:"modal-body",children:[ce&&i.jsx("div",{className:"error-message",children:ce}),i.jsxs("form",{onSubmit:le,className:"recurring-form",children:[i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Medication Name"}),i.jsx("input",{type:"text",value:s,onChange:_=>a(_.target.value)})]}),i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsxs("label",{children:[i.jsx(Ks,{size:16})," Frequency"]}),i.jsxs("select",{value:K,onChange:_=>$(parseInt(_.target.value)),children:[i.jsx("option",{value:15,children:"Every 15 Days"}),i.jsx("option",{value:30,children:"Every 30 Days"}),i.jsx("option",{value:60,children:"Every 60 Days"}),i.jsx("option",{value:90,children:"Every 90 Days"})]})]}),i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsxs("label",{children:[i.jsx(yr,{size:16})," Next Delivery"]}),i.jsx("input",{type:"date",value:H,onChange:_=>L(_.target.value)})]})]}),i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsx("label",{children:"Tabs/Day"}),i.jsx("input",{type:"number",min:"0.5",step:"0.5",value:c,onChange:_=>u(parseFloat(_.target.value))})]}),i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsx("label",{children:"Days"}),i.jsx("input",{type:"number",min:"1",value:m,onChange:_=>d(parseInt(_.target.value))})]}),i.jsxs("div",{className:"form-group",style:{flex:1},children:[i.jsx("label",{children:"Total Qty"}),i.jsx("input",{type:"number",min:"1",value:o,onChange:_=>l(parseInt(_.target.value))})]})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Directions"}),i.jsx("input",{type:"text",value:y,onChange:_=>p(_.target.value)})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Notes"}),i.jsx("input",{type:"text",value:A,onChange:_=>q(_.target.value)})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Status"}),i.jsxs("select",{value:W,onChange:_=>F(_.target.value),children:[i.jsx("option",{value:"active",children:"Active"}),i.jsx("option",{value:"paused",children:"Paused"}),i.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),i.jsxs("div",{className:"modal-actions",style:{justifyContent:"space-between"},children:[i.jsxs("button",{type:"button",className:"btn-cancel text-red-600 hover:bg-red-50",onClick:V,style:{color:"#dc3545"},children:[i.jsx(ft,{size:16,style:{marginRight:"5px"}})," Delete"]}),i.jsxs("div",{style:{display:"flex",gap:"10px"},children:[i.jsx("button",{type:"button",className:"btn-cancel",onClick:n,children:"Cancel"}),i.jsx("button",{type:"submit",className:"btn-submit",disabled:j,children:j?"Saving...":"Save Changes"})]})]})]})]})]})}):null},rg=({isOpen:e,onClose:n,billData:t})=>{if(b.useEffect(()=>{if(e&&t){const a=setTimeout(()=>{window.print()},500);return()=>clearTimeout(a)}},[e,t]),!e||!t)return null;const r=t.clinicUpiId&&t.grandTotal>0?`upi://pay?pa=${t.clinicUpiId}&pn=${encodeURIComponent(t.clinicName)}&am=${t.grandTotal.toFixed(2)}&cu=INR`:"",s=i.jsxs("div",{id:"print-modal-root",className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 print:bg-white print:static print:block",children:[i.jsxs("div",{className:"bg-white w-full max-w-4xl h-[90vh] overflow-y-auto rounded-lg shadow-xl print:shadow-none print:w-full print:max-w-none print:h-auto print:overflow-visible relative",children:[i.jsx("button",{onClick:n,className:"absolute top-4 right-4 z-50 p-2 bg-gray-100 hover:bg-gray-200 rounded-full no-print",children:i.jsx(fn,{size:24})}),i.jsx("div",{className:"pharmacy-billing-page",style:{padding:0,minHeight:"auto",background:"white"},children:i.jsx("div",{className:"billing-container printable-section",style:{border:"none",boxShadow:"none",maxWidth:"100%",margin:0},children:i.jsxs("div",{className:"p-8 print:p-0",children:[t.labLetterheadUrl&&i.jsx("div",{className:"print-letterhead-container mb-4",children:i.jsx("img",{src:t.labLetterheadUrl,alt:"Lab Letterhead",className:"print-letterhead-image w-full object-contain max-h-[150px]"})}),i.jsxs("div",{className:"billing-header print-only",children:[i.jsx("div",{className:"clinic-header-left",children:i.jsx("div",{className:"clinic-info-print",children:i.jsxs("div",{className:"clinic-name-and-details-print",children:[i.jsx("h1",{className:"bill-title",children:"INVOICE"}),i.jsx("h2",{className:"clinic-name-print",children:t.clinicName?`${t.clinicName} Lab`:"Lab Bill"}),(t.clinicAddress||t.clinicNotes)&&i.jsxs("div",{className:"clinic-details-print",children:[t.clinicAddress&&i.jsx("span",{className:"small-text clinic-address",children:t.clinicAddress}),t.clinicNotes&&i.jsx("span",{className:"small-text clinic-notes",children:t.clinicNotes})]})]})})}),i.jsxs("div",{className:"patient-info-grid print-only-patient-details mt-4 text-sm",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem"},children:[i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Xs,{size:16})," Patient Name"]}),t.patientName]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Zs,{size:16})," Token"]}),t.patientToken||"N/A"]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(yr,{size:16})," Order Date"]}),new Date(t.orderDate).toLocaleDateString()]})]})]}),i.jsx("div",{className:"medications-card mb-6",style:{border:"none",boxShadow:"none"},children:i.jsxs("table",{className:"medications-table w-full text-left collapse",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b-2 border-gray-300",children:[i.jsx("th",{className:"py-2",children:"S.No."}),i.jsx("th",{className:"py-2",children:"TEST DESCRIPTION"}),i.jsx("th",{className:"py-2 text-right",children:"PRICE"}),i.jsx("th",{className:"py-2 text-right",children:"DIS %"}),i.jsx("th",{className:"py-2 text-right",children:"AMT"})]})}),i.jsx("tbody",{children:t.items.map((a,o)=>{const l=a.price??0,c=l*(a.discount_percentage??0)/100,u=l-c;return i.jsxs("tr",{className:"border-b border-gray-100",children:[i.jsx("td",{className:"py-2",children:o+1}),i.jsx("td",{className:"py-2 font-medium",children:a.name}),i.jsx("td",{className:"py-2 text-right",children:a.price.toFixed(2)}),i.jsxs("td",{className:"py-2 text-right",children:[a.discount_percentage??0,"%"]}),i.jsx("td",{className:"py-2 text-right font-bold",children:u.toFixed(2)})]},o)})})]})}),i.jsx("div",{className:"bill-summary-print flex justify-end",children:i.jsxs("div",{className:"bill-summary-details w-1/3 bg-gray-50 p-4 rounded print:w-1/2 print:bg-transparent print:p-0",children:[i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Subtotal"}),i.jsxs("span",{children:["₹",t.subtotal.toFixed(2)]})]}),i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Total Discount"}),i.jsxs("span",{children:["- ₹",t.totalDiscount.toFixed(2)]})]}),i.jsxs("div",{className:"print-only-total flex justify-between font-bold text-lg border-t pt-2 mt-2",children:[i.jsx("span",{children:"Grand Total:"}),i.jsxs("span",{children:["₹",t.grandTotal.toFixed(2)]})]}),r&&i.jsxs("div",{className:"qr-code-container mt-4 flex flex-col items-center",style:{boxShadow:"none",background:"transparent"},children:[i.jsx(eo,{value:r,size:80}),i.jsx("p",{className:"text-xs mt-1 text-center text-gray-500",children:"Scan to pay"})]})]})}),i.jsxs("footer",{className:"billing-footer mt-8 text-center text-xs text-gray-500 print:absolute print:bottom-0 print:w-full",children:[i.jsx("p",{children:"Thank you for your business!"}),i.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})})})]}),i.jsx("style",{children:`
                @media print {
                    /* Hide EVERYTHING in body */
                    body > * {
                        display: none !important;
                    }
                    
                    /* Explicitly hide #root to override any other styles */
                    #root {
                        display: none !important;
                    }

                    /* Show ONLY our portal root */
                    #print-modal-root {
                        display: block !important;
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        background: white !important;
                        z-index: 99999 !important;
                    }

                     /* Reset visibility for children of the portal */
                    #print-modal-root * {
                        visibility: visible !important;
                    }
                    
                    /* IMPORTANT: Prevent style tags from being displayed by the wildcard above */
                    #print-modal-root style {
                        display: none !important;
                    }
                    
                     /* Specifically restore display for key layout containers that rely on Flex */
                    .flex { display: flex !important; }
                    .grid { display: grid !important; }
                    .table { display: table !important; }
                    tr { display: table-row !important; }
                    td, th { display: table-cell !important; }

                    /* Ensure no scrollbars in print */
                    .overflow-y-auto {
                        overflow: visible !important;
                        height: auto !important;
                    }

                    /* 
                       CRITICAL: Hide elements explicitly marked with no-print class 
                       Must be at the END to override any restoration rules above.
                    */
                    #print-modal-root .no-print, .no-print {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                    }
                }
            `})]});return to.createPortal(s,document.body)},ig=({isOpen:e,onClose:n,billData:t})=>{if(b.useEffect(()=>{if(e&&t){const a=setTimeout(()=>{window.print()},500);return()=>clearTimeout(a)}},[e,t]),!e||!t)return null;const r=t.clinicUpiId&&t.grandTotal>0?`upi://pay?pa=${t.clinicUpiId}&pn=${encodeURIComponent(t.clinicName)}&am=${t.grandTotal.toFixed(2)}&cu=INR`:"",s=i.jsxs("div",{id:"print-pharmacy-modal-root",className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 print:bg-white print:static print:block",children:[i.jsxs("div",{className:"bg-white w-full max-w-4xl h-[90vh] overflow-y-auto rounded-lg shadow-xl print:shadow-none print:w-full print:max-w-none print:h-auto print:overflow-visible relative",children:[i.jsx("button",{onClick:n,className:"absolute top-4 right-4 z-50 p-2 bg-gray-100 hover:bg-gray-200 rounded-full no-print",children:i.jsx(fn,{size:24})}),i.jsx("div",{className:"pharmacy-billing-page",style:{padding:0,minHeight:"auto",background:"white"},children:i.jsx("div",{className:"billing-container printable-section",style:{border:"none",boxShadow:"none",maxWidth:"100%",margin:0},children:i.jsxs("div",{className:"p-8 print:p-0",children:[i.jsxs("div",{className:"billing-header print-only",children:[i.jsx("div",{className:"clinic-header-left",children:i.jsx("div",{className:"clinic-info-print",children:i.jsxs("div",{className:"clinic-name-and-details-print",children:[i.jsx("h1",{className:"bill-title",children:"INVOICE"}),i.jsx("h2",{className:"clinic-name-print",children:t.clinicName?`${t.clinicName} Pharmacy`:"Pharmacy Bill"}),(t.clinicAddress||t.clinicNotes)&&i.jsxs("div",{className:"clinic-details-print",children:[t.clinicAddress&&i.jsx("span",{className:"small-text clinic-address",children:t.clinicAddress}),t.clinicNotes&&i.jsx("span",{className:"small-text clinic-notes",children:t.clinicNotes})]})]})})}),i.jsxs("div",{className:"patient-info-grid print-only-patient-details mt-4 text-sm",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem"},children:[i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Xs,{size:16})," Patient Name"]}),t.patientName]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Zs,{size:16})," Token"]}),t.patientToken||"N/A"]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(yr,{size:16})," Order Date"]}),new Date(t.orderDate).toLocaleDateString()]})]})]}),i.jsx("div",{className:"medications-card mb-6",style:{border:"none",boxShadow:"none"},children:i.jsxs("table",{className:"medications-table w-full text-left collapse",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b-2 border-gray-300",children:[i.jsx("th",{className:"py-2",children:"S.No."}),i.jsx("th",{className:"py-2",children:"DESCRIPTION"}),i.jsx("th",{className:"py-2",children:"BATCH"}),i.jsx("th",{className:"py-2",children:"EXPIRY"}),i.jsx("th",{className:"py-2",children:"QTY"}),i.jsx("th",{className:"py-2 text-right",children:"MRP"}),i.jsx("th",{className:"py-2 text-right",children:"DIS %"}),i.jsx("th",{className:"py-2 text-right",children:"AMT"})]})}),i.jsx("tbody",{children:t.items.map((a,o)=>i.jsxs("tr",{className:"border-b border-gray-100",children:[i.jsx("td",{className:"py-2",children:o+1}),i.jsx("td",{className:"py-2 font-medium",children:a.name}),i.jsx("td",{className:"py-2",children:a.batch||"-"}),i.jsx("td",{className:"py-2",children:a.expiry_date?new Date(a.expiry_date).toLocaleDateString():"-"}),i.jsxs("td",{className:"py-2",children:[a.pack_quantity?`${a.pack_quantity} Pkts `:"",a.loose_quantity?`${a.loose_quantity} Loose`:""]}),i.jsx("td",{className:"py-2 text-right",children:a.mrp.toFixed(2)}),i.jsxs("td",{className:"py-2 text-right",children:[a.discount_percentage??0,"%"]}),i.jsx("td",{className:"py-2 text-right font-bold",children:a.price.toFixed(2)})]},o))})]})}),i.jsx("div",{className:"bill-summary-print flex justify-end",children:i.jsxs("div",{className:"bill-summary-details w-1/3 bg-gray-50 p-4 rounded print:w-1/2 print:bg-transparent print:p-0",children:[i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Subtotal"}),i.jsxs("span",{children:["₹",t.subtotal.toFixed(2)]})]}),i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Total Discount"}),i.jsxs("span",{children:["- ₹",t.totalDiscount.toFixed(2)]})]}),i.jsxs("div",{className:"print-only-total flex justify-between font-bold text-lg border-t pt-2 mt-2",children:[i.jsx("span",{children:"Grand Total:"}),i.jsxs("span",{children:["₹",t.grandTotal.toFixed(2)]})]}),r&&i.jsxs("div",{className:"qr-code-container mt-4 flex flex-col items-center",style:{boxShadow:"none",background:"transparent"},children:[i.jsx(eo,{value:r,size:80}),i.jsx("p",{className:"text-xs mt-1 text-center text-gray-500",children:"Scan to pay"})]})]})}),i.jsxs("footer",{className:"billing-footer mt-8 text-center text-xs text-gray-500 print:absolute print:bottom-0 print:w-full",children:[i.jsx("p",{children:"Thank you for your business!"}),i.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})})})]}),i.jsx("style",{children:`
                @media print {
                    body > * { display: none !important; }
                    #root { display: none !important; }
                    #print-pharmacy-modal-root {
                        display: block !important;
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        background: white !important;
                        z-index: 99999 !important;
                    }
                    #print-pharmacy-modal-root * { visibility: visible !important; }
                    #print-pharmacy-modal-root style { display: none !important; }
                    
                    .flex { display: flex !important; }
                    .grid { display: grid !important; }
                    .table { display: table !important; }
                    tr { display: table-row !important; }
                    td, th { display: table-cell !important; }

                    .overflow-y-auto { overflow: visible !important; height: auto !important; }
                    #print-pharmacy-modal-root .no-print, .no-print {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                    }
                }
            `})]});return to.createPortal(s,document.body)},ag=({messages:e})=>{const n=b.useRef(null);return b.useEffect(()=>{n.current&&(n.current.scrollTop=n.current.scrollHeight)},[e]),i.jsxs("div",{className:"conversation-panel",children:[i.jsxs("div",{className:"conversation-header",children:[i.jsx("div",{className:"conversation-title",children:i.jsx("h3",{children:"Conversation"})}),i.jsxs("span",{className:"conversation-count",children:[e.length," messages"]})]}),i.jsxs("div",{ref:n,className:"message-list custom-scrollbar",children:[e.length===0&&i.jsx("div",{className:"empty-state",children:"Start talking to the AI..."}),e.map(t=>i.jsxs("div",{className:`message-wrapper ${t.role}`,children:[i.jsx("div",{className:`message-bubble ${t.role} ${t.role==="system"?t.type||"info":""}`,children:t.role==="ai"||t.role==="system"&&t.type==="loading"?i.jsx("div",{className:"prose prose-sm max-w-none",children:t.role==="system"&&t.type==="loading"?i.jsxs("div",{className:"typing-indicator",children:[i.jsx("span",{className:"dot"}),i.jsx("span",{className:"dot"}),i.jsx("span",{className:"dot"})]}):i.jsx(Qt,{remarkPlugins:[bt],children:t.content})}):i.jsx("div",{className:"whitespace-pre-wrap",children:t.content})}),t.role!=="system"&&i.jsx("span",{className:"message-timestamp",children:t.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]},t.id))]})]})},sg=e=>no({queryKey:ht.patients.context(e||""),queryFn:async()=>{if(!e)throw new Error("Patient ID is required");const n=await G(`/api/patients/${e}/context`);if(!n.ok)throw new Error("Failed to fetch patient context");return n.json()},enabled:!!e,staleTime:5*60*1e3}),Ni=e=>{if(!e)return"";const n=new Date(e);if(isNaN(n.getTime()))return"";const t=n.getTimezoneOffset()*6e4;return new Date(n.getTime()-t).toISOString().slice(0,16)},lg=()=>{var es,ts;const{openCommandBar:e}=oc(),{recordId:n,patientId:t}=lc(),[r,s]=b.useState(n||void 0),a=cc(),o=uc(),l=dc(),[c,u]=b.useState(""),[m]=b.useState([]),[d,y]=b.useState(null),[p,A]=b.useState(null),[q,K]=b.useState(void 0),[$,H]=b.useState(void 0),[L,W]=b.useState(null),[F,j]=b.useState(!1),[Z,ce]=b.useState(""),[ne,le]=b.useState(!1),[V,_]=b.useState(null),[C,Y]=b.useState(null),[E,U]=b.useState(!1),[J,Se]=b.useState([]),[pe,w]=b.useState(!1),[Fe,we]=b.useState(null),[x,De]=b.useState(""),[He,ke]=b.useState(""),[at,Re]=b.useState(null),[et,st]=b.useState(!1),[tt,Yt]=b.useState(!1),[v,Dt]=b.useState(!1),[Nt,Kt]=b.useState(window.innerHeight),[dt,gt]=b.useState([]),[Je,vt]=b.useState(!1),[Ut,Xt]=b.useState(null),[We,jt]=b.useState([]),[$e,T]=b.useState([]),[P,S]=b.useState([]),[ee,ue]=b.useState(!1),[Le,Me]=b.useState(null),ve=b.useRef(null),Ve=b.useRef(null),Qe=b.useRef(!1),ze=b.useRef(null),te=b.useRef(null),D=b.useRef(null),z=b.useRef(null),O=b.useRef(null),I=b.useRef(null),ie=b.useRef(null),[re,R]=b.useState([]),[he,je]=b.useState(!1);b.useEffect(()=>{(async()=>{if(re.length>0&&!he){je(!0);const g=re[0];g.current&&(g.current.scrollIntoView({behavior:"smooth",block:"center"}),g.current.classList.add("ai-glow"),await new Promise(f=>setTimeout(f,2e3)),g.current&&g.current.classList.remove("ai-glow")),R(f=>f.slice(1)),je(!1)}})()},[re,he]);const ye=h=>{let g=null;switch(h){case"update_patient_details":g=D;break;case"create_pharmacy_order":case"edit_pharmacy_order":g=z;break;case"create_lab_order":case"edit_lab_order":g=O;break;case"add_complaint_history":g=I;break;case"update_case_summary":g=ie;break}g&&R(f=>[...f,g])},[ae,me]=b.useState(55),[de,M]=b.useState(!1),X=b.useRef(null),xe=b.useRef(null),qe=b.useRef(null),oe=b.useRef(null),Ne=150,[Ee,Ge]=b.useState([]),[ot,yt]=b.useState([]),[lt,nt]=b.useState(!0),[Zt,en]=b.useState(null),[Hn,Wn]=b.useState(!1),[sl,ol]=b.useState(!1),[ll,cl]=b.useState(!1),[ul,dl]=b.useState(!1),[pl,hl]=b.useState(!1),[kr,Ct]=b.useState([]),[xn,Zi]=b.useState(!1),[ea,ta]=b.useState(null),[Vn,_r]=b.useState(!1),[na,ra]=b.useState(null),[bn,ml]=b.useState({}),[fl,ia]=b.useState(!1),[aa,sa]=b.useState(!1),[oa,la]=b.useState(!1),[ca,Jn]=b.useState(!1),[ua,Nr]=b.useState(!1),[da,wn]=b.useState([]),[vr,Qn]=b.useState(void 0),[gl,pa]=b.useState(!1),[yl,xl]=b.useState(null),[bl,ha]=b.useState(!1),[wl,kl]=b.useState(null),[pt,ma]=b.useState(!1),[jr,fa]=b.useState(!1),[Cr,ga]=b.useState(!1),[Sr,ya]=b.useState(!1),[Tr,xa]=b.useState(!1),[Gn,kn]=b.useState(!1),Yn=b.useMemo(()=>(p==null?void 0:p.admission_date)&&!(p!=null&&p.discharge_date),[p]),[_l,Kn]=b.useState(!1),[ba,Pr]=b.useState(null),[Er,Ar]=b.useState(""),[Dr,Ir]=b.useState(void 0),[Or,$r]=b.useState(void 0),[Lr,Rr]=b.useState(void 0),[St,Fr]=b.useState(!1),[wa,Mt]=b.useState(null),[ka,zr]=b.useState(null),[_a,qr]=b.useState(null),[Na,_n]=b.useState(null),[Tt,tn]=b.useState(""),[Nn,Xn]=b.useState(!1),[vn,Nl]=b.useState(!1),Zn=b.useRef(null),[va,Br]=b.useState(null),[ja,nn]=b.useState([]),Ur=b.useCallback(h=>{nn(g=>[...g,{id:Math.random().toString(36).substr(2,9),timestamp:new Date,role:"system",content:"",...h}])},[]),[Mr,Ca]=b.useState(null),[Sa,Ta]=b.useState(!1),er=b.useRef(null),tr=b.useRef(null),[vl,Hr]=b.useState(!1),[nr,Pa]=b.useState(!1),[Wr,Ea]=b.useState(null),[Ae,Vr]=b.useState(null),[rr,Jr]=b.useState(""),[jn,Cn]=b.useState(""),[Aa,Da]=b.useState(!0),[rn,Ia]=b.useState(!1),[Qr,ir]=b.useState(!1),[an,Oa]=b.useState(!1),[jl,$a]=b.useState(!1),Sn=b.useRef(null),Cl=async()=>{Sn.current&&(await Sn.current.undoLastAction(),$a(!1))},Sl=h=>{kl(h),ha(!0)},sn=async h=>{try{const g=await G(`/api/patients/${h}`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`Failed to fetch patient details: ${g.status}`)}const f=await g.json();if(A(f),K(f.age),H(f.gender),De(f.ai_response||""),A(k=>k?{...k,current_status:f.current_status,admission_date:f.admission_date,discharge_date:f.discharge_date}:{...f,current_status:f.current_status,admission_date:f.admission_date,discharge_date:f.discharge_date}),f.insurance_type&&A(k=>k?{...k,insurance_type:f.insurance_type}:{...f}),Kr(h),f.ai_response){const k=/```json\s*([\s\S]*?)\s*```/,N=f.ai_response.match(k);if(N&&N[1])ke(f.ai_response.replace(k,"").trim()),Re(N[1].trim());else{const Q=f.ai_response.trim();if(Q.startsWith("{")&&Q.endsWith("}"))try{JSON.parse(Q),ke(""),Re(Q)}catch{ke(Q),Re(null)}else if(Q.startsWith("[")&&Q.endsWith("]"))try{JSON.parse(Q),ke(""),Re(Q)}catch{ke(Q),Re(null)}else ke(Q),Re(null)}}else ke(""),Re(null)}catch{A(null),De(""),ke(""),Re(null)}},Tl=async(h,g)=>{A(f=>f?{...f,insurance_type:g}:null);try{const f=await G(`/api/patients/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({insurance_type:g})});if(!f.ok){const k=await f.json();throw new Error(k.message||"Failed to update insurance type")}}catch(f){console.error("Error updating insurance type:",f),h&&sn(h)}},La=async h=>{ue(!0),Me(null),S([]);try{const g=await G(`/api/queue/patient/${h}/complaints`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`HTTP error! status: ${g.status}`)}const f=await g.json();S(f||[])}catch(g){Me(`Past complaints error: ${g.message}`)}finally{ue(!1)}},on=async h=>{jt([]);try{const g=await G(`/api/pharmacy-orders/patient/${h}`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`HTTP error! status: ${g.status}`)}const f=await g.json();jt(f||[])}catch{}},ln=async h=>{Zi(!0),ta(null),Ct([]);try{const g=await G(`/api/lab/orders/patient/${h}`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`HTTP error! status: ${g.status}`)}const f=await g.json();Ct(f||[])}catch(g){ta(`Pending labs error: ${g.message}`)}finally{Zi(!1)}},Tn=async h=>{vt(!0),Xt(null),gt([]);try{const g=await G(`/api/lab/patient/${h}`);if(!g.ok){const N=await g.json().catch(()=>({}));throw new Error(N.message||`HTTP error! status: ${g.status}`)}const k=(await g.json()||[]).map(N=>({...N.report,id:N.id,patient_id:N.patient_id,createdAt:N.createdAt,tests:N.tests,status:N.status}));gt(k)}catch(g){Xt(`Lab reports error: ${g.message}`)}finally{vt(!1)}},{data:Pt,isLoading:It}=sg(d),Pn=b.useCallback(async h=>{h===d?await o.invalidateQueries({queryKey:ht.patients.context(h)}):y(h)},[d,o]);b.useEffect(()=>{if(Pt){console.log("EditComplaintPage: Syncing data from useQuery cache");const h=Pt.patient;if(h){if(A(h),K(h.age),H(h.gender),De(h.ai_response||""),h.ai_response){const g=/```json\s*([\s\S]*?)\s*```/,f=h.ai_response.match(g);if(f&&f[1])ke(h.ai_response.replace(g,"").trim()),Re(f[1].trim());else{const k=h.ai_response.trim();k.startsWith("{")||k.startsWith("[")?(ke(""),Re(k)):(ke(k),Re(null))}}kn(h.current_status==="In Doctor Queue"||h.current_status==="In Consultation")}if(S(Pt.history||[]),jt(Pt.pharmacyOrders||[]),Pt.labOrders){Ct(Pt.labOrders.filter(f=>!f.report));const g=Pt.labOrders.filter(f=>f.report).map(f=>({...f.report,id:f.id,patient_id:f.patient_id,createdAt:f.createdAt,tests:f.tests}));gt(g)}T(Pt.recurringMedications||[])}},[Pt]),b.useEffect(()=>{(async()=>{if(d)try{const g=await o.fetchQuery({queryKey:ht.patientDebts.balance(d),queryFn:async()=>{const f=await G(`/api/patient-debts/${d}/balance`);return f.ok?f.json():{netDebt:0}},staleTime:6e4});Ea(g.netDebt||0)}catch(g){console.error("Error fetching patient debt:",g),Ea(0)}})()},[d,o]);const Gr=b.useCallback(()=>{if(!p)return;const h={id:p.id,token:p.patient_token_number??null,name:p.name,age:p.age??null,gender:p.gender==="M"||p.gender==="F"||p.gender==="O"?p.gender:null,phone:p.phone};a("/dashboard/dental",{state:{patient:h}})},[p,a]),{data:Yr}=no({queryKey:ht.dental.records(d),queryFn:async()=>{const h=await G(`/api/dental/patient/${d}`);if(!h.ok)throw new Error("Failed to fetch dental records");return h.json()},enabled:!!d,staleTime:5*60*1e3});b.useEffect(()=>{Se(Yr||[])},[Yr]);const{conditions:Pl,details:El}=b.useMemo(()=>{const h={},g={},f=(N,Q)=>{h[N]||(h[N]=[]);const fe=`condition-${Q}`;h[N].includes(fe)||h[N].push(fe)},k=(N,Q)=>{g[N]||(g[N]=[]),g[N].push(Q)};return J.forEach(N=>{N.teeth&&Array.isArray(N.teeth)&&N.teeth.forEach(Q=>{Q.procedures.forEach(fe=>{var Ce;let _e=(Ce=N.selected_procedures)==null?void 0:Ce.find(Wt=>Wt.id===fe);_e&&_e.type!=="general"&&(f(Q.toothNumber,_e.type),k(Q.toothNumber,{name:_e.name,date:new Date(N.date||N.createdAt||0).toLocaleDateString(),recordId:N.id,isPast:!0}))})})}),{conditions:h,details:g}},[J]),Kr=async h=>{try{const g=await o.fetchQuery({queryKey:ht.queue.latest(h),queryFn:async()=>{const f=await G(`/api/queue/patient/${h}/latest`);if(!f.ok)throw new Error("Failed");return f.json()},staleTime:5e3});if(g){const f=new Date(g.createdAt),k=new Date,N=f.getDate()===k.getDate()&&f.getMonth()===k.getMonth()&&f.getFullYear()===k.getFullYear(),Q=["waiting","consulting"].includes(g.status);kn(N&&Q)}else kn(!1)}catch(g){console.error("Error checking patient queue status:",g),kn(!1)}},Xr=b.useCallback(async(h,g)=>{try{if(!(await G(`/api/pharmacy-orders/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:g})})).ok)throw new Error("Failed to update pharmacy order date");d&&on(d)}catch(f){console.error("Error updating pharmacy order date:",f),we("Failed to update pharmacy order date")}},[d]),En=b.useCallback(async(h,g,f)=>{try{const k={};if(g==="order"?k.date=f:g==="report"&&(k.reportDate=f),!(await G(`/api/lab/orders/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)})).ok)throw new Error("Failed to update lab date");d&&(ln(d),Tn(d))}catch(k){console.error("Error updating lab order date:",k),we("Failed to update lab order date")}},[d]),Zr=b.useCallback(h=>{a(`/dashboard/edit-pharmacy-order/${h}`)},[a]),Ra=b.useCallback(h=>{const g=h.medications.map((f,k)=>({id:Date.now()+k,medication_name:f.name,drug_id:f.drug_id?String(f.drug_id):null,quantity:(f.pack_quantity||0)*(f.pack_size||1)+(f.loose_quantity||0),tablets_per_day:f.tabletsPerDay||1,number_of_days:f.numberOfDays||30,directions:f.directions_to_use||"",notes:"",packs:f.pack_quantity,loose:f.loose_quantity,pack_size:f.pack_size}));wn(g),Jn(!0)},[]),Fa=b.useCallback(h=>{we(null),console.log(`Preparing billing navigation for order: ${h}`);const g=We.find(f=>f.id===h);if(g){const f=g.medications.map(k=>{const N=k.price??0;return(k.price===void 0||k.price===null)&&console.warn(`Medication "${k.name}" in order ${h} is missing a price. Defaulting to 0.`),{name:k.name,pack_quantity:k.pack_quantity,loose_quantity:k.loose_quantity,price:N,pack_price:k.pack_price,loose_price:k.loose_price,total_price:Number(k.total_price)||0,isLoose:k.isLoose,unit:k.unit,drug_id:k.drug_id?String(k.drug_id):null,tabletsPerDay:k.tabletsPerDay,numberOfDays:k.numberOfDays,directions_to_use:k.directions_to_use,discount_percentage:k.discount_percentage??0,batch:k.batch,expiry_date:k.expiry_date}});console.log("Navigating to /dashboard/pharmacy-billing with state:",{initialItems:f}),a(`/dashboard/pharmacy-billing/${h}`,{state:{initialItems:f}})}else console.error(`Order with ID ${h} not found.`),we(`Order with ID ${h} not found.`),alert(`Error: Could not find order ${h} to bill.`)},[We,a]),za=b.useCallback(async(h,g)=>{we(null);const f=We.find(N=>N.id===h);if(!f){we(`Order with ID ${h} not found.`);return}const k={status:g,medications:f.medications};try{const N=await G(`/api/pharmacy-orders/${h}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)});if(!N.ok){const fe=await N.text();throw new Error(`Failed to update status: ${N.statusText} (${N.status}) - ${fe}`)}const Q=await N.json();jt(fe=>fe.map(_e=>_e.id===Q.id?{..._e,status:Q.status}:_e)),d&&on(d)}catch(N){console.error("Failed to update order status:",N),we(N.message||`Failed to update status for order ${h}.`),alert(`Error updating status for order ${h}: ${N.message||"Please try again."}`)}},[We,d]),ei=b.useCallback(h=>{Ct(g=>g.map(f=>f.id===h?{...f,isEditing:!0,editedTests:[...f.tests],editedStatus:f.status}:{...f,isEditing:!1}))},[]),Al=b.useCallback(h=>{Ct(g=>g.map(f=>f.id===h?{...f,isEditing:!1,editedTests:void 0,editedStatus:void 0}:f))},[]),Dl=b.useCallback((h,g,f,k)=>{Ct(N=>N.map(Q=>{if(Q.id===h){const fe=Q.editedTests?[...Q.editedTests]:[...Q.tests];if(f==="add")return{...Q,editedTests:[...fe,{id:"",name:"",price:0}]};if(f==="remove")return{...Q,editedTests:k};if(g!==-1){const _e={...fe[g],[f]:k};return fe[g]=_e,{...Q,editedTests:fe}}}return Q}))},[]),Il=b.useCallback((h,g)=>{Ct(f=>f.map(k=>k.id===h?{...k,editedStatus:g}:k))},[]),qa=b.useCallback(async h=>{if(!h){console.error("Cannot navigate to billing: Lab Order data is missing."),alert("Could not open billing page: Lab Order information is missing.");return}a(`/dashboard/lab-billing/${h.id}`)},[a]),Ba=b.useCallback(async(h,g)=>{console.log(`Updating lab order ${h} to status ${g}`);try{const f=await G(`/api/lab/${h}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:g})});if(!f.ok){const k=await f.json();throw new Error(k.message||`Failed to update lab order status: ${f.status}`)}d&&(ln(d),Tn(d)),console.log(`Lab Order ${h} status updated to ${g}, refetching data.`)}catch(f){console.error("Error updating lab order status:",f),alert(`Failed to update lab order status: ${f instanceof Error?f.message:"Unknown error"}`)}},[d]),ar=b.useCallback(h=>{h&&h.id?a(`/lab/report/${h.id}`):(console.error("Cannot navigate: Lab Order or Lab Order ID is missing."),alert("Could not open the report entry page: Lab Order information is missing."))},[a]),Ol=b.useCallback(async(h,g,f)=>{ma(!0),we(null);try{if(!g||g.length===0)throw new Error("Lab order must have at least one test.");for(const Q of g)if(!Q.id||!Q.name||isNaN(Q.price)||Q.price<0)throw new Error(`Invalid test data: ${JSON.stringify(Q)}. Each test must have id, name, and a valid price.`);const k={tests:g,status:f},N=await G(`/api/lab/orders/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)});if(!N.ok){const Q=await N.json().catch(()=>({}));throw new Error(Q.message||`Failed to update lab order: ${N.statusText}`)}d&&ln(d),Ct(Q=>Q.map(fe=>fe.id===h?{...fe,isEditing:!1,editedTests:void 0,editedStatus:void 0}:fe))}catch(k){we(`Lab Order Save Error: ${k.message}`)}finally{ma(!1)}},[d]),Ot=b.useCallback(async h=>{if(!window.confirm(`Are you sure you want to delete this ${h.type.toLowerCase()} record? This action cannot be undone.`))return;_r(!0),ra(null);let f=null,k;const N=h.type;try{switch(N){case"Complaint":if(k=h.data.id,!k)throw new Error("Complaint ID is missing.");f=`/api/patients/complaints/${k}`;break;case"Lab Order":if(k=h.data.id,!k)throw new Error("Lab Order ID is missing.");f=`/api/lab/orders/${k}`;break;case"Lab Report":if(k=h.data.reportId,!k)throw new Error("Lab Report ID is missing.");f=`/api/lab/reports/${k}`;break;case"Pharmacy Order":if(k=h.data.id,!k)throw new Error("Pharmacy Order ID is missing.");f=`/api/pharmacy-orders/${k}`;break;default:throw new Error(`Deletion not supported for item type: ${N}`)}if(!f)throw new Error(`Could not determine delete URL for type: ${N}`);const Q=await G(f,{method:"DELETE"});if(!Q.ok){const fe=await Q.json().catch(()=>({}));throw new Error(fe.message||`Failed to delete ${N}: ${Q.statusText}`)}d&&(N==="Complaint"?La(d):N==="Lab Order"?(ln(d),Tn(d)):N==="Lab Report"?Tn(d):N==="Pharmacy Order"&&on(d))}catch(Q){ra(`Delete Error (${N}): ${Q.message}`),Vn&&_r(!1)}finally{_r(!1)}},[d,Vn]),Ua=b.useCallback(async()=>{if(!d)return;if(We.filter(g=>g.status==="pending").length<2){alert("You need at least two pending orders to merge.");return}Pa(!0);try{const g=await G(`/api/pharmacy-orders/patient/${d}/merge-pending`,{method:"POST"});if(!g.ok){const f=await g.json().catch(()=>({}));throw new Error(f.message||"Failed to merge orders")}on(d)}catch(g){we(`Merge Error: ${g.message}`)}finally{Pa(!1)}},[d,We]),$t=b.useMemo(()=>{if(!d||!P)return[];const h=P.map(g=>({date:new Date(g.createdAt),type:"Complaint",data:g,originalDateString:g.createdAt})).filter(g=>!isNaN(g.date.getTime()));return h.sort((g,f)=>f.date.getTime()-g.date.getTime()),h},[d,P]),Lt=b.useMemo(()=>{if(!d)return[];const h=new Map;(kr??[]).forEach(f=>{h.set(f.id,{...f})}),(dt??[]).forEach(f=>{if(!h.has(f.id))h.set(f.id,{id:f.id,patient_id:f.patient_id,tests:f.tests,status:f.status,createdAt:f.createdAt,report:f});else{const k=h.get(f.id);k&&(k.report=f,k.status=f.status)}});let g=Array.from(h.values());return g.sort((f,k)=>new Date(f.createdAt).getTime()-new Date(k.createdAt).getTime()),g=g.map((f,k)=>({...f,serialNumber:k+1})),g.map(f=>({date:new Date(f.createdAt),type:"Lab Order",data:f,originalDateString:f.createdAt}))},[d,kr,dt]),Ht=b.useCallback(async h=>{const g=h??c;if(!g.trim())return;tr.current&&(clearTimeout(tr.current),tr.current=null),Ur({role:"user",content:g});const f=Math.random().toString(36).substr(2,9);nn(k=>[...k,{id:f,role:"system",type:"loading",content:"",timestamp:new Date}]),Sn.current?(await Sn.current.callGenerativeApi(g),nn(k=>k.filter(N=>N.id!==f)),tr.current=setTimeout(()=>{nn([])},1e4)):nn(k=>k.filter(N=>N.id!==f))},[c,Ur,nn]),Ma=b.useCallback(()=>{const h="reports came,please anaylse";u(h),setTimeout(()=>{Ht(h)},0)},[Ht,u]),ti=b.useCallback(h=>{ml(g=>({...g,[h]:!g[h]}))},[]),xt=b.useMemo(()=>{if(!d||!We)return[];const h=We.map(g=>({date:new Date(g.date),type:"Pharmacy Order",data:g,originalDateString:g.date})).filter(g=>!isNaN(g.date.getTime()));return h.sort((g,f)=>f.date.getTime()-g.date.getTime()),h},[d,We]),$l=b.useCallback((h,g)=>i.jsxs("div",{className:"flex flex-col w-full",children:[i.jsxs("span",{className:"ai-context-text flex items-center",children:[xt.length-g,". Order Status: (",h.data.status,")",i.jsx("span",{className:"text-gray-400 ml-1 flex items-center",children:ba===h.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",children:i.jsx("input",{type:"datetime-local",defaultValue:Ni(h.originalDateString),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:f=>{f.target.value&&Xr(h.data.id,f.target.value),Pr(null)},onKeyDown:f=>{if(f.key==="Enter"){const k=f.target;k.value&&Xr(h.data.id,k.value),Pr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/date ml-1",onClick:()=>Pr(h.data.id),title:"Click to edit date",children:["(",new Date(h.originalDateString).toLocaleDateString(),")",i.jsx(mt,{size:14,className:"ml-1 text-gray-500 hover:text-gray-700"})]})}),i.jsxs("div",{className:"inline-flex space-x-2 ml-2",children:[i.jsx("button",{onClick:()=>Zr(h.data.id),className:"icon-button small",title:"Edit Pharmacy Order",children:i.jsx(mt,{size:12})}),h.data.prescriptionForUnavailableDrugs&&i.jsx("button",{onClick:()=>{const f=fi().use(bt).use(_i).processSync(h.data.prescriptionForUnavailableDrugs).toString();ni(f,"Unavailable Drugs Prescription")},className:"icon-button small",title:"Print Unavailable Drugs Prescription",children:i.jsx(Ln,{size:12})}),h.data.status==="dispensed"||h.data.status==="billed"?i.jsx("button",{onClick:()=>a(`/dashboard/pharmacy-billing/${h.data.id}`),className:"icon-button small text-blue-600",title:"View Pharmacy Bill",children:i.jsx(ii,{size:12})}):i.jsx("button",{onClick:()=>Ot({type:"Pharmacy Order",data:h.data}),className:"icon-button small text-red-500",title:"Delete Pharmacy Order",children:i.jsx(ft,{size:12})}),h.data.status==="pending"&&i.jsx("button",{onClick:()=>Fa(h.data.id),className:"icon-button small",title:"Bill this pharmacy order",disabled:pt,children:i.jsx(ns,{size:12})}),h.data.status==="billed"&&i.jsx("button",{onClick:()=>za(h.data.id,"dispensed"),className:"icon-button small",title:"Dispense this pharmacy order",disabled:pt,children:i.jsx(rs,{size:12})}),i.jsx("button",{onClick:()=>Ra(h.data),className:"icon-button small group-hover:block",title:"Add to Recurring Medications",children:i.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-repeat",children:[i.jsx("path",{d:"m17 2 4 4-4 4"}),i.jsx("path",{d:"M3 11v-1a4 4 0 0 1 4-4h14"}),i.jsx("path",{d:"m7 22-4-4 4-4"}),i.jsx("path",{d:"M21 13v1a4 4 0 0 1-4 4H3"})]})})]})]}),i.jsx("div",{className:"pharmacy-order-drugs-table-container mobile-edge-to-edge-table-container mt-2 cursor-pointer hover:bg-gray-50 transition-colors rounded p-1",onClick:()=>Zr(h.data.id),title:"Click to edit order",children:i.jsxs("table",{className:"pharmacy-order-drugs-table mobile-edge-to-edge-table w-full text-xs",children:[i.jsx("thead",{children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-1 px-2 text-left",children:"Drug Name"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Quantity"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Dosage"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Directions"})]})}),i.jsx("tbody",{children:h.data.medications.map((f,k)=>i.jsxs("tr",{children:[i.jsx("td",{className:"py-1 px-2",children:i.jsx("strong",{children:f.name})}),i.jsxs("td",{className:"py-1 px-2",children:[f.pack_quantity!==void 0&&f.pack_quantity>0&&`Packs: ${f.pack_quantity}`,f.pack_quantity!==void 0&&f.pack_quantity>0&&f.loose_quantity!==void 0&&f.loose_quantity>0&&", ",f.loose_quantity!==void 0&&f.loose_quantity>0&&`Loose: ${f.loose_quantity}`]}),i.jsx("td",{className:"py-1 px-2",children:f.tabletsPerDay&&f.numberOfDays?`${f.tabletsPerDay} tab/day for ${f.numberOfDays} days`:"N/A"}),i.jsx("td",{className:"py-1 px-2",children:f.directions_to_use||"N/A"})]},f.drug_id||f.name||k))})]})}),h.data.prescriptionForUnavailableDrugs&&i.jsxs("div",{className:"unavailable-drugs-markdown mt-2",children:[i.jsx("span",{className:"font-semibold text-xs text-gray-600 block mb-1",children:"Prescription for Unavailable Drugs:"}),i.jsx(Qt,{remarkPlugins:[bt],children:h.data.prescriptionForUnavailableDrugs})]})]}),[xt,ba,Xr,Zr,Fa,za,Ra,Ot,pt,a]),Ll=b.useCallback((h,g)=>{const f=oh(h.data.report?h.data.report.status:h.data.status),k=(h.data.tests||[]).reduce((N,Q)=>N+(Number(Q.price)||0),0).toFixed(2);return i.jsxs("div",{className:"flex flex-col w-full",children:[i.jsxs("div",{className:"flex justify-between items-start mb-2",children:[i.jsxs("div",{className:"ai-context-text flex items-center flex-wrap",children:[i.jsxs("span",{className:"font-medium cursor-pointer hover:text-blue-600 transition-colors mr-2",onClick:()=>ar(h.data),title:"Click to enter report",children:["#",h.data.serialNumber," [Order]"]}),i.jsx("span",{className:`mr-2 ${f.className}`,children:f.text}),i.jsx("span",{className:"text-gray-400 inline-flex items-center",children:ka===h.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",onClick:N=>N.stopPropagation(),children:i.jsx("input",{type:"datetime-local",defaultValue:Ni(h.originalDateString),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:N=>{N.target.value&&En(h.data.id,"order",N.target.value),zr(null)},onKeyDown:N=>{if(N.key==="Enter"){const Q=N.target;Q.value&&En(h.data.id,"order",Q.value),zr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/date ml-1",onClick:N=>{N.stopPropagation(),zr(h.data.id)},title:"Click to edit order date",children:["(",new Date(h.originalDateString).toLocaleDateString(),")",i.jsx(mt,{size:14,className:"ml-1 text-gray-500 hover:text-gray-700"})]})})]}),!h.data.isEditing&&i.jsxs("div",{className:"flex space-x-1 items-center",children:[i.jsx("button",{onClick:()=>ei(h.data.id),className:"icon-button small",title:"Edit",disabled:pt,children:i.jsx(mt,{size:12})}),h.data.status==="pending"?i.jsx("button",{onClick:()=>qa(h.data),className:"icon-button small font-medium text-green-600 w-auto px-1",title:`Pay total of ₹${k}`,disabled:pt,children:i.jsx(ro,{size:12})}):i.jsx("button",{onClick:()=>a(`/dashboard/lab-billing/${h.data.id}`),className:"icon-button small text-blue-600",title:"View Lab Bill",children:i.jsx(pc,{size:12})}),["pending","billed","collected","processing","report_ready","reported","completed"].includes(h.data.status)&&i.jsx("button",{onClick:()=>ar(h.data),className:"icon-button small text-indigo-600",title:"Enter Report",disabled:pt,children:i.jsx(ii,{size:12})}),(h.data.status==="report_ready"||h.data.status==="reported")&&i.jsx("button",{onClick:()=>Ba(h.data.id,"completed"),className:"icon-button small text-green-600",title:"Mark Completed",disabled:pt,children:i.jsx(rs,{size:12})}),i.jsx("button",{onClick:()=>Ot({type:"Lab Order",data:h.data}),className:"icon-button small text-red-500",title:"Delete",disabled:pt,children:i.jsx(ft,{size:12})})]})]}),i.jsx("div",{className:"lab-order-tests-table-container mobile-edge-to-edge-table-container mt-1 mb-2 cursor-pointer hover:bg-gray-50 transition-colors rounded p-1 border border-gray-100",onClick:()=>{h.data.status==="pending"?ei(h.data.id):ar(h.data)},title:h.data.status==="pending"?"Click to edit order":"Click to enter report",children:i.jsxs("table",{className:"lab-order-tests-table mobile-edge-to-edge-table w-full text-xs text-left",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b bg-gray-50",children:[i.jsx("th",{className:"py-1 px-2 font-medium text-gray-600",children:"Test Name"}),i.jsx("th",{className:"py-1 px-2 text-right font-medium text-gray-600",children:"Price"})]})}),i.jsxs("tbody",{children:[h.data.tests&&h.data.tests.length>0?h.data.tests.map(N=>i.jsxs("tr",{className:"border-b last:border-0 hover:bg-gray-100",children:[i.jsx("td",{className:"py-1 px-2",children:N.name}),i.jsxs("td",{className:"py-1 px-2 text-right",children:["₹",N.price]})]},N.id||N.name)):i.jsx("tr",{children:i.jsx("td",{colSpan:2,className:"py-1 px-2 italic text-gray-500",children:"No tests specified"})}),i.jsxs("tr",{className:"bg-gray-50 font-semibold",children:[i.jsx("td",{className:"py-1 px-2 text-right text-gray-700",children:"Total:"}),i.jsxs("td",{className:"py-1 px-2 text-right text-gray-900",children:["₹",k]})]})]})]})}),h.data.report&&i.jsxs("div",{className:"ml-4 mt-1 p-2 border-l-2 border-gray-200",children:[i.jsxs("div",{className:"flex justify-between items-center mb-2",children:[i.jsx("span",{className:"font-medium text-sm text-gray-700",children:"[Report]"}),i.jsxs("div",{className:"flex items-center",children:[i.jsx("span",{className:"text-gray-400 ml-1 flex items-center text-xs",children:_a===h.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",onClick:N=>N.stopPropagation(),children:i.jsx("input",{type:"datetime-local",defaultValue:Ni(h.data.report.report_date),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:N=>{N.target.value&&En(h.data.id,"report",N.target.value),qr(null)},onKeyDown:N=>{if(N.key==="Enter"){const Q=N.target;Q.value&&En(h.data.id,"report",Q.value),qr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/reportDate ml-1",onClick:N=>{N.stopPropagation(),qr(h.data.id)},title:"Click to edit report date",children:["(",new Date(h.data.report.report_date).toLocaleDateString(),")",i.jsx(mt,{size:12,className:"ml-1 text-gray-500 hover:text-gray-700"})]})}),i.jsx("button",{onClick:()=>ti(h.data.report.reportId),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400 ml-2",title:bn[h.data.report.reportId]?"Collapse Report":"Expand Report",children:bn[h.data.report.reportId]?i.jsx(is,{size:14}):i.jsx(as,{size:14})}),i.jsx("button",{onClick:()=>Ot({type:"Lab Report",data:h.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400 ml-1",title:"Delete Report",children:i.jsx(ft,{size:12})})]})]}),bn[h.data.report.reportId]&&(()=>{try{const N=JSON.parse(h.data.report.report_content||"{}");return typeof N=="object"&&N!==null&&h.data.report.tests?h.data.report.tests.map(Q=>i.jsxs("div",{style:{marginBottom:"10px"},children:[i.jsx("h5",{className:"font-semibold text-xs mt-2 mb-1 text-gray-700",children:Q.name}),N[Q.id]?i.jsx("div",{className:"mobile-edge-to-edge-table-container",children:i.jsxs("table",{className:"lab-inventory-table mobile-edge-to-edge-table w-full text-xs",children:[i.jsx("thead",{children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Parameter"}),i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Value"}),i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Normal Range"})]})}),i.jsx("tbody",{children:Object.entries(N[Q.id]).map(([fe,_e])=>{var Wt;const Ce=(Wt=Q.default_parameters)==null?void 0:Wt.find(Rt=>Rt.name===fe);return i.jsxs("tr",{className:"border-b last:border-0",children:[i.jsx("td",{className:"py-1 px-2",children:fe}),i.jsxs("td",{className:"py-1 px-2",children:[String(_e)," ",(Ce==null?void 0:Ce.unit)||""]}),i.jsx("td",{className:"py-1 px-2 text-gray-500",children:(()=>{if(Ce&&Ce.type==="number"&&(Ce.lower_limit!=null||Ce.upper_limit!=null)){let Rt="";return Ce.lower_limit!=null&&(Rt+=` > ${Ce.lower_limit}`),Ce.lower_limit!=null&&Ce.upper_limit!=null&&(Rt+=" - "),Ce.upper_limit!=null&&(Rt+=` < ${Ce.upper_limit}`),Rt.trim()||"N/A"}else if((Ce==null?void 0:Ce.type)==="boolean")return"N/A";return(Ce==null?void 0:Ce.normal_range)||"N/A"})()})]},fe)})})]})}):i.jsx("p",{className:"italic text-gray-500 text-xs",children:"No parameters reported for this test."})]},Q.id)):i.jsx("div",{className:"text-xs prose",children:i.jsx(Qt,{remarkPlugins:[bt],children:h.data.report.report_content})})}catch{return i.jsx("div",{className:"text-xs prose",children:i.jsx(Qt,{remarkPlugins:[bt],children:h.data.report.report_content||"*No findings recorded.*"})})}})()]})]})},[ka,ar,En,ei,pt,qa,a,Ot,_a,bn,ti,Ba]),Rl=b.useCallback((h,g)=>i.jsx("div",{className:"ai-context-text w-full",children:Na===h.data.id?i.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[i.jsx("input",{type:"text",value:Tt,onChange:f=>tn(f.target.value),className:"border rounded px-2 py-1 text-sm w-full",autoFocus:!0,onKeyDown:async f=>{if(f.key==="Enter"&&Tt.trim()){Xn(!0);try{await G(`/api/patients/complaints/${h.data.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:Tt.trim()})}),h.data.complaint=Tt.trim(),_n(null),tn("")}catch(k){console.error("Error updating complaint:",k)}Xn(!1)}f.key==="Escape"&&(_n(null),tn(""))},disabled:Nn}),i.jsxs("div",{className:"flex gap-1",children:[i.jsx("button",{onClick:async()=>{if(Tt.trim()){Xn(!0);try{await G(`/api/patients/complaints/${h.data.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:Tt.trim()})}),h.data.complaint=Tt.trim(),_n(null),tn("")}catch(f){console.error("Error updating complaint:",f)}Xn(!1)}},className:"text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600",disabled:Nn||!Tt.trim(),children:Nn?"Saving...":"Save"}),i.jsx("button",{onClick:()=>{_n(null),tn("")},className:"text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300",disabled:Nn,children:"Cancel"})]})]}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 rounded px-1 -mx-1 transition-colors inline-block",onClick:()=>{_n(h.data.id),tn(h.data.complaint)},title:"Click to edit",children:[h.data.complaint,i.jsxs("span",{className:"text-gray-400 ml-1",children:["(",new Date(h.originalDateString).toLocaleDateString(),")"]})]})}),[Na,Tt,Nn,Ot]),Fl=b.useMemo(()=>i.jsxs("div",{className:"flex space-x-2",children:[i.jsx("button",{onClick:Ua,className:"button-primary blue text-xs px-2 py-1",disabled:nr||We.filter(h=>h.status==="pending").length<2,title:"Merge all pending orders into one",children:nr?"Merging...":"Merge Orders"}),i.jsxs("button",{onClick:()=>sa(!0),className:"button-primary green text-xs px-2 py-1",title:"Manually create a new pharmacy order",disabled:!d,children:[i.jsx(pr,{size:12,className:"mr-1"})," Create Order"]})]}),[Ua,nr,We,d]),zl=b.useMemo(()=>i.jsxs("div",{className:"flex space-x-2",children:[i.jsx("button",{onClick:Ma,className:"button-primary blue text-xs px-2 py-1",title:"Tell AI to analyse the reports",disabled:E||tt||It||Je,children:"Analyse Reports"}),i.jsxs("button",{onClick:()=>ia(!0),className:"button-primary green text-xs px-2 py-1",title:"Manually create a new lab order",disabled:!d,children:[i.jsx(pr,{size:12,className:"mr-1"})," Create Lab Order"]})]}),[Ma,E,tt,It,Je,d]),[Ha,Wa]=b.useState(null),[Va,Ja]=b.useState([]),[sr,Qa]=b.useState(""),Ga=(h,g)=>{if(!h||!h.report_content||!g)return"";try{const f=JSON.parse(h.report_content||"{}");if(typeof f!="object"||f===null)return`<p class="italic text-gray-500 text-xs">Report content is not structured data.</p><pre>${h.report_content}</pre>`;let k="";return g.forEach(N=>{f[N.id]?(k+=`<h5 class="font-semibold text-sm mt-2 mb-1">${N.name}</h5>`,k+='<table class="lab-report-print-table"><thead><tr><th>Parameter</th><th>Value</th><th>Normal Range</th></tr></thead><tbody>',Object.entries(f[N.id]).map(([Q,fe])=>{var Wt;const _e=(Wt=N.default_parameters)==null?void 0:Wt.find(Rt=>Rt.name===Q);let Ce="N/A";_e&&_e.type==="number"&&(_e.lower_limit!=null||_e.upper_limit!=null)?(Ce="",_e.lower_limit!=null&&(Ce+=` > ${_e.lower_limit}`),_e.lower_limit!=null&&_e.upper_limit!=null&&(Ce+=" - "),_e.upper_limit!=null&&(Ce+=` < ${_e.upper_limit}`),Ce=Ce.trim()||"N/A"):(_e==null?void 0:_e.type)==="boolean"?Ce="N/A":_e!=null&&_e.normal_range&&(Ce=_e.normal_range),k+=`<tr><td>${Q}</td><td>${String(fe)} ${(_e==null?void 0:_e.unit)||""}</td><td>${Ce}</td></tr>`}),k+="</tbody></table>"):k+=`<p class="italic text-gray-500 text-xs">No parameters reported for ${N.name}.</p>`}),k}catch{return`<p class="italic text-gray-500 text-xs">Error parsing report content.</p><pre>${h.report_content}</pre>`}};b.useEffect(()=>{const h=()=>{Kt(window.innerHeight)};return window.addEventListener("resize",h),h(),()=>window.removeEventListener("resize",h)},[]),b.useEffect(()=>{const h=f=>{if(!de||!oe.current||!qe.current)return;const k=qe.current.getBoundingClientRect(),Q=f.clientX-oe.current.x;let fe=oe.current.initialWidth+Q;const _e=k.width-Ne-10;fe=Math.max(Ne,fe),fe=Math.min(fe,_e);const Ce=fe/k.width*100;me(Ce)},g=()=>{M(!1),oe.current=null,document.body.style.cursor="",document.body.style.userSelect=""};return de&&(window.addEventListener("mousemove",h),window.addEventListener("mouseup",g),document.body.style.cursor="col-resize",document.body.style.userSelect="none"),()=>{window.removeEventListener("mousemove",h),window.removeEventListener("mouseup",g),document.body.style.cursor="",document.body.style.userSelect=""}},[de]);const ql=h=>{if(!qe.current)return;h.preventDefault();const g=qe.current.querySelector(".edit-complaint-context-column");g&&(oe.current={x:h.clientX,initialWidth:g.offsetWidth},M(!0))},Ya=b.useCallback(async()=>{w(!0),we(null);try{const h=await G("/api/queue/doctor/new",{method:"POST"});if(!h.ok){const f=await h.json().catch(()=>({}));throw new Error(f.message||`Failed to create record: ${h.statusText}`)}const g=await h.json();if(!g.recordId)throw new Error("New record ID not received from server.");a(`/edit-complaint/${g.recordId}`,{replace:!0})}catch(h){we(`Failed to create new complaint record: ${h.message}`)}finally{w(!1)}},[a]);b.useEffect(()=>{(async()=>{Da(!0);try{const g=await o.fetchQuery({queryKey:ht.clinicSettings,queryFn:async()=>{const f=await G("/api/clinics/settings");if(!f.ok)throw new Error("Failed to fetch clinic settings.");return f.json()},staleTime:18e5});Vr({admissionCharge:parseFloat(g.admissionCharge||0).toFixed(2),perDayCharge:parseFloat(g.perDayCharge||0).toFixed(2),otherCharges:parseFloat(g.otherCharges||0).toFixed(2),aiMemory:g.aiMemory||"",aiMemoryUpdatedAt:g.aiMemoryUpdatedAt||null,clinicWideSystemPrompt:g.clinicWideSystemPrompt||"",clinicWideSystemPromptUpdatedAt:g.clinicWideSystemPromptUpdatedAt||null,gemini_api_key:g.gemini_api_key||""}),Jr(g.aiMemory||""),Cn(g.clinicWideSystemPrompt||"")}catch{}finally{Da(!1)}})()},[]),b.useEffect(()=>{var g;(g=l.state)!=null&&g.initialComplaint&&u(l.state.initialComplaint);const h=async f=>{U(!0),we(null);try{const k=await o.fetchQuery({queryKey:ht.queue.entry(f),queryFn:async()=>{const N=await G(`/api/queue/doctor/complaint/${f}`);if(!N.ok){const Q=await N.json().catch(()=>({}));throw new Error(Q.message||`HTTP error! status: ${N.status}`)}return N.json()},staleTime:6e4});y(k.patientId),K(k.age),H(k.gender),W(k.case_summary||null),Y(k.updatedAt||null)}catch{we("Failed to load current complaint details."),y(null),K(void 0),H(void 0),W(null),Y(null)}finally{U(!1)}};if(r)h(r);else if(t){const f=t;f&&(y(f),(async()=>{try{let N;try{N=await o.fetchQuery({queryKey:ht.queue.latest(f),queryFn:async()=>{const fe=await G(`/api/queue/patient/${f}/latest`);if(!fe.ok)throw new Error("Failed");return fe.json()},staleTime:5e3})}catch{}if(N!=null&&N._id){s(N._id),h(N._id);return}const Q=await G("/api/queue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:f,complaint:"Visit Initiated"})});if(Q.ok){const fe=await Q.json();if(fe!=null&&fe.id){s(fe.id),h(fe.id);return}}}catch(N){console.error("Background queue resolution failed",N),we("Failed to initialize visit record.")}})())}else Ya()},[r,Ya,(es=l.state)==null?void 0:es.initialComplaint,t]),b.useEffect(()=>{d?Pn(d):(A(null),S([]),jt([]),Ct([]),gt([]),Y(null),kn(!1))},[d]),b.useEffect(()=>{var f;const h=(f=l.state)==null?void 0:f.initialComplaint;h&&r&&(!E&&!ee&&!xn&&!Je&&!lt)&&!Qe.current&&c===h&&(Qe.current=!0,Ht(),a(l.pathname,{replace:!0,state:{}}))},[(ts=l.state)==null?void 0:ts.initialComplaint,r,c,E,ee,xn,Je,lt,a]);const Ka=()=>{ce(L||""),j(!0),_(null)},Bl=()=>{j(!1),ce(""),_(null)},Ul=async()=>{if(!r){_("Missing Record ID.");return}le(!0),_(null);try{const h=await G(`/api/queue/doctor/complaint/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({case_summary:Z.trim()})});if(!h.ok){const f=await h.json().catch(()=>({}));throw new Error(f.message||`Failed to save case summary: ${h.statusText}`)}const g=await h.json();W(g.case_summary||Z.trim()),Y(g.updatedAt||null),j(!1)}catch(h){_(`Save Error: ${h.message}`)}finally{le(!1)}};b.useEffect(()=>{(async()=>{nt(!0),en(null);try{const[g,f]=await Promise.all([o.fetchQuery({queryKey:ht.drugs.all,queryFn:async()=>{const k=await G("/api/drugs");if(!k.ok)throw new Error(`Pharmacy inventory error! status: ${k.status}`);const N=await k.json();return N.drugs||N},staleTime:6e5}),o.fetchQuery({queryKey:ht.labTests.all,queryFn:async()=>{const k=await G("/api/lab-tests");if(!k.ok)throw new Error(`Lab inventory error! status: ${k.status}`);return k.json()},staleTime:6e5})]);Ge(g),yt(f||[])}catch(g){en(g.message)}finally{nt(!1)}})()},[]);const Ml=async()=>{if(!Ae)return;if(rr===Ae.aiMemory&&jn===Ae.clinicWideSystemPrompt){ir(!1);return}const h=rr!==Ae.aiMemory,g=jn!==Ae.clinicWideSystemPrompt;h&&Ia(!0),g&&Oa(!0);try{const f={...Ae};h&&(f.aiMemory=rr),g&&(f.clinicWideSystemPrompt=jn);const k=await G("/api/clinics/settings",{method:"PUT",body:JSON.stringify(f)});if(!k.ok){const Q=await k.json().catch(()=>({}));throw new Error(Q.message||"Failed to update clinic settings.")}const N=await k.json();Vr({admissionCharge:parseFloat(N.settings.admissionCharge).toFixed(2),perDayCharge:parseFloat(N.settings.perDayCharge).toFixed(2),otherCharges:parseFloat(N.settings.otherCharges).toFixed(2),aiMemory:N.settings.aiMemory||"",aiMemoryUpdatedAt:N.settings.aiMemoryUpdatedAt||(Ae==null?void 0:Ae.aiMemoryUpdatedAt)||null,clinicWideSystemPrompt:N.settings.clinicWideSystemPrompt||"",clinicWideSystemPromptUpdatedAt:N.settings.clinicWideSystemPromptUpdatedAt||(Ae==null?void 0:Ae.clinicWideSystemPromptUpdatedAt)||null}),h&&Jr(N.settings.aiMemory||""),g&&(Cn(N.settings.clinicWideSystemPrompt||""),ir(!1))}catch{}finally{h&&Ia(!1),g&&Oa(!1)}},Xa=()=>{Ae&&(Cn(Ae.clinicWideSystemPrompt||""),ir(!0))},Hl=()=>{ir(!1),Ae&&Cn(Ae.clinicWideSystemPrompt||"")},Wl=h=>{navigator.clipboard.writeText(h).then(()=>{}).catch(g=>{console.error("Failed to copy text: ",g)})},ni=(h,g)=>{const f=window.open("","_blank");f&&(f.document.write(`
        <html>
          <head>
            <title>${g}</title>
            <style>
              body { font-family: sans-serif; margin: 20px; }
              h2 { text-align: center; margin-bottom: 20px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              pre { white-space: pre-wrap; word-wrap: break-word; }
              .ai-context-section { margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 5px; }
              .ai-context-section-title { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; color: #333; }
              .ai-context-text { margin-bottom: 5px; }
              .text-gray-400 { color: #999; }
              .font-semibold { font-weight: 600; }
              .italic { font-style: italic; }
              .mt-2 { margin-top: 8px; }
              .ml-1 { margin-left: 4px; }
              .ml-2 { margin-left: 8px; }
              .flex { display: flex; }
              .flex-col { flex-direction: column; }
              .w-full { width: 100%; }
              .text-xs { font-size: 0.75rem; }
              .text-sm { font-size: 0.875rem; }
              .prose { max-width: 65ch; }
              .prose table { display: table; } /* Ensure tables in markdown render correctly */
            </style>
          </head>
          <body>
            <h2>${g}</h2>
            <div id="print-content">${h}</div>
          </body>
        </html>
      `),f.document.close(),f.print())},Vl=()=>{if(x){const h=fi().use(bt).use(_i).processSync(He).toString();ni(`<div class="prose">${h}</div>`,"Summary")}};b.useEffect(()=>{if(p){let h=`
        <div class="print-section">
          <h3>Patient Details</h3>
          <p><strong>Name:</strong> ${p.name||"N/A"}</p>
          <p><strong>Token:</strong> ${p.patient_token_number||"N/A"}</p>
          <p><strong>Age:</strong> ${p.age||"N/A"}</p>
          <p><strong>Gender:</strong> ${p.gender||"N/A"}</p>
          <p><strong>Phone:</strong> ${p.phone||"N/A"}</p>
          <p><strong>Insurance:</strong> ${p.insurance_type||"N/A"}</p>
          <p><strong>Status:</strong> ${p.current_status||"N/A"}</p>
          <p><strong>Admitted:</strong> ${p.admission_date?new Date(p.admission_date).toLocaleDateString():"N/A"}</p>
          <p><strong>Discharged:</strong> ${p.discharge_date?new Date(p.discharge_date).toLocaleDateString():"N/A"}</p>
        </div>
        <div class="print-section">
          <h3>Case Summary</h3>
          <p>${L||"No summary available."}</p>
        </div>
        <div class="print-section">
          <h3>Complaints History</h3>
          ${$t.length>0?`
            <ul>
              ${$t.map(g=>`<li>${new Date(g.originalDateString).toLocaleDateString()}: ${g.data.complaint}</li>`).join("")}
            </ul>
          `:"<p>No past complaints.</p>"}
        </div>
        <div class="print-section">
          <h3>Pharmacy Orders</h3>
          ${xt.length>0?`
            <table class="print-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Drug Name</th>
                  <th>Quantity</th>
                  <th>Dosage</th>
                  <th>Directions</th>
                </tr>
              </thead>
              <tbody>
                ${xt.map(g=>{const f=g.data.medications.map((N,Q)=>`
                    <tr>
                      ${Q===0?`<td rowspan="${g.data.medications.length+(g.data.prescriptionForUnavailableDrugs?1:0)}">${new Date(g.originalDateString).toLocaleDateString()}</td>`:""}
                      ${Q===0?`<td rowspan="${g.data.medications.length+(g.data.prescriptionForUnavailableDrugs?1:0)}">${g.data.status}</td>`:""}
                      <td><strong>${N.name}</strong></td>
                      <td>
                        ${N.pack_quantity!==void 0&&N.pack_quantity>0?`Packs: ${N.pack_quantity}`:""}
                        ${N.pack_quantity!==void 0&&N.pack_quantity>0&&N.loose_quantity!==void 0&&N.loose_quantity>0?", ":""}
                        ${N.loose_quantity!==void 0&&N.loose_quantity>0?`Loose: ${N.loose_quantity}`:""}
                      </td>
                      <td>${N.tabletsPerDay&&N.numberOfDays?`${N.tabletsPerDay} tab/day for ${N.numberOfDays} days`:"N/A"}</td>
                      <td>${N.directions_to_use||"N/A"}</td>
                    </tr>
                  `).join("");let k="";return g.data.prescriptionForUnavailableDrugs&&(k=`
                      <tr>
                        <td colspan="4" style="background-color: #f9f9f9; padding: 10px;">
                          <div style="font-style: italic; margin-bottom: 5px; font-weight: 600;">Prescription for Unavailable Drugs:</div>
                          <div class="prose" style="font-size: 0.9em;">${fi().use(bt).use(_i).processSync(g.data.prescriptionForUnavailableDrugs).toString()}</div>
                        </td>
                      </tr>
                    `),f+k}).join("")}
              </tbody>
            </table>
          `:"<p>No pharmacy orders.</p>"}
        </div>
        <div class="print-section">
          <h3>Lab History (Orders & Reports)</h3>
          ${Lt.length>0?`
            ${Lt.map(g=>{const f=g.data.tests.map(N=>N.name).join(", ");let k="";return g.data.report&&(k=`
                  <div class="lab-report-print-container">
                    <h4>Lab Report (${new Date(g.data.report.report_date).toLocaleDateString()})</h4>
                    ${Ga(g.data.report,g.data.report.tests)}
                  </div>
                `),`
                <div class="lab-history-item">
                  <p><strong>Order Date:</strong> ${new Date(g.originalDateString).toLocaleDateString()}</p>
                  <p><strong>Status:</strong> ${g.data.status}</p>
                  <p><strong>Tests:</strong> ${f}</p>
                  ${k}
                </div>
              `}).join("")}
          `:"<p>No lab history.</p>"}
        </div>
      `;Qa(h)}else Qa("")},[p,L,$t,xt,Lt,Ga]);const Za=()=>{sr&&ni(sr,`Patient Details - ${p==null?void 0:p.name}`)},Jl=h=>{u(h),Wa(null),Ja([]),setTimeout(()=>{Ht(h)},0)},Et=E||tt||v||Je||ee||lt||xn||pe||Hn||sl||ll||ul||pl||pt||St||rn||an||nr||Vn||jr||Cr||Sr||Tr||ne,Ql=h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),!Et&&c.trim()&&r&&Ht())};b.useEffect(()=>{const h=window.SpeechRecognition||window.webkitSpeechRecognition;if(!h){Br("Speech recognition not supported in this browser.");return}const g=new h;return g.continuous=!0,g.interimResults=!0,g.lang="en-US",g.onresult=f=>{let k="";for(let N=f.resultIndex;N<f.results.length;++N)f.results[N].isFinal&&(k+=f.results[N][0].transcript);k&&u(N=>N+(N.endsWith(" ")||N===""?"":" ")+k)},g.onerror=f=>{Br(`Speech error: ${f.error}`),Nl(!1)},g.onend=()=>{},Zn.current=g,()=>{Zn.current&&Zn.current.stop()}},[]);const Gl=async()=>{if(d)if(Yn){ga(!0);try{const h=await G(`/api/patients/${d}/discharge`,{method:"POST"});if(!h.ok){const g=await h.json().catch(()=>({}));throw new Error(g.message||`Failed to discharge patient: ${h.status}`)}sn(d)}catch(h){we(`Discharge Error: ${h.message}`)}finally{ga(!1)}}else{fa(!0);try{const h=await G(`/api/patients/${d}/admit`,{method:"POST"});if(!h.ok){const g=await h.json().catch(()=>({}));throw new Error(g.message||`Failed to admit patient: ${h.status}`)}sn(d)}catch(h){we(`Admit Error: ${h.message}`)}finally{fa(!1)}}},Yl=async h=>{if(d){ya(!0);try{const f=await G("/api/queue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:d})});if(!f.ok){const k=await f.json().catch(()=>({}));throw new Error(k.message||`Failed to add patient to ${h} queue: ${f.status}`)}d&&(sn(d),Kr(d))}catch(g){we(`Add to Queue Error: ${g.message}`)}finally{ya(!1)}}},Kl=async()=>{if(r){xa(!0),we(null);try{const h=await G(`/api/queue/${r}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"seen"})});if(!h.ok){const f=await h.json().catch(()=>({}));throw new Error(f.message||"Failed to complete consultation")}d&&(sn(d),Kr(d));const g=localStorage.getItem("currentUser");if(o.removeQueries({queryKey:ht.queue.all}),g){const f=JSON.parse(g);f.role==="receptionist"?a("/dashboard"):f.role==="doctor"||f.role==="admin"?a("/dashboard/queue"):a("/dashboard")}else a("/dashboard")}catch(h){we(`Error completing consultation: ${h.message}`)}finally{xa(!1)}}},Xl=async()=>{if(!d){Mt("Missing Patient ID.");return}if(!p){Mt("Patient details not loaded.");return}Fr(!0),Mt(null);try{const h={};let g=!1;if(Er!==p.name&&(h.name=Er,g=!0),Dr!==p.age&&(h.age=Dr,g=!0),Or!==p.gender&&(h.gender=Or,g=!0),Lr!==p.phone&&(h.phone=Lr,g=!0),!g){Mt("No changes detected."),Fr(!1),Kn(!1);return}const f=await G(`/api/patients/${d}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)});if(!f.ok){const N=await f.json().catch(()=>({}));throw new Error(N.message||`Failed to update patient details: ${f.statusText}`)}const k=await f.json();A(k),K(k.age),H(k.gender),Ar(k.name),Ir(k.age),$r(k.gender),Rr(k.phone),Kn(!1)}catch(h){Mt(`Save Error: ${h.message}`)}finally{Fr(!1)}},Zl=async(h,g,f)=>{h.stopPropagation();const k=[null,"red","green","blue"],N=k.indexOf(f||null),Q=k[(N+1)%k.length];A(fe=>fe?{...fe,color_code:Q}:null);try{await G(`/api/patients/${g}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({color_code:Q})})}catch(fe){console.error("Error updating color code:",fe),A(_e=>_e?{..._e,color_code:f||null}:null)}},ec=b.useCallback(()=>{if(!p)return null;const h={token_number:p.patient_token_number||"N/A",name:p.name||"N/A",age:p.age||"N/A",gender:p.gender||"N/A",phone:p.phone||"N/A"};return $t.length>0?h.complaints_history=$t.map(g=>`${g.data.complaint} (${new Date(g.originalDateString).toLocaleDateString()})`).join("; "):h.complaints_history="No past complaints.",xt.length>0?h.pharmacy_orders_history=xt.map(g=>`Order: ${g.data.medications.map(k=>{let N=`${k.name}`;return k.pack_quantity!==void 0&&k.pack_quantity>0&&(N+=` Packs: ${k.pack_quantity}`),k.loose_quantity!==void 0&&k.loose_quantity>0&&(N+=` Loose: ${k.loose_quantity}`),N}).join(", ")} (${g.data.status}, ${new Date(g.originalDateString).toLocaleDateString()})`).join("; "):h.pharmacy_orders_history="No pharmacy orders.",Lt.length>0?h.lab_orders_history=Lt.map(g=>{let k=`Lab Order: ${g.data.tests.map(N=>N.name).join(", ")} (${g.data.status}, ${new Date(g.originalDateString).toLocaleDateString()})`;return g.data.report&&(k+=` - Report: ${g.data.report.report_content} (${new Date(g.data.report.report_date).toLocaleDateString()})`),k}).join("; "):h.lab_orders_history="No lab history.",$e.length>0?h.recurring_medications=$e.map((g,f)=>{let k=`${f+1}. ${g.medicationName} (${g.frequencyDays} days, ${g.status})`;return g.tabletsPerDay&&(k+=` - ${g.tabletsPerDay} tabs/day`),g.numberOfDays&&(k+=` for ${g.numberOfDays} days`),k}).join("; "):h.recurring_medications="No recurring medications.",h},[p,$t,xt,Lt,$e]),tc=()=>{if(!p){Br("Patient details are required to use the Live API.");return}Hr(!0)},nc=()=>{var h;(h=er.current)==null||h.click()},rc=async h=>{var f;const g=(f=h.target.files)==null?void 0:f[0];if(g&&d){Ca(g),Ta(!0);try{const k=new FormData;k.append("files",g);const N=localStorage.getItem("authToken");(await fetch(`/api/patient-files/${d}`,{method:"POST",headers:{Authorization:`Bearer ${N}`},body:k})).ok||we("Image upload failed. Please try again.")}catch(k){console.error("Image upload error:",k),we("Image upload failed. Please try again.")}finally{Ta(!1)}}},ri=b.useRef(!1),An=b.useRef(null),cn=b.useRef(null),ct=b.useRef({response:!0,pharmacy:!1,recurring:!1,labs:!1,history:!1,summary:!1}),[Dn,un]=b.useState("response"),In=h=>{ri.current=!0,un(h),An.current&&clearTimeout(An.current),An.current=setTimeout(()=>{ri.current=!1},1e3);const g={behavior:"smooth",block:"start"};h==="response"&&xe.current?xe.current.scrollIntoView(g):h==="meds"?z.current?z.current.scrollIntoView(g):cn.current&&cn.current.scrollIntoView(g):h==="labs"&&O.current?O.current.scrollIntoView(g):h==="history"&&I.current?I.current.scrollIntoView(g):h==="summary"&&ie.current&&ie.current.scrollIntoView(g)};return b.useEffect(()=>{const h=new IntersectionObserver(g=>{ri.current||(g.forEach(f=>{f.target===xe.current?ct.current.response=f.isIntersecting:f.target===z.current?ct.current.pharmacy=f.isIntersecting:f.target===cn.current?ct.current.recurring=f.isIntersecting:f.target===O.current?ct.current.labs=f.isIntersecting:f.target===I.current?ct.current.history=f.isIntersecting:f.target===ie.current&&(ct.current.summary=f.isIntersecting)}),ct.current.response?un("response"):ct.current.pharmacy||ct.current.recurring?un("meds"):ct.current.labs?un("labs"):ct.current.history?un("history"):ct.current.summary&&un("summary"))},{root:null,threshold:0,rootMargin:"-10% 0px -50% 0px"});return xe.current&&h.observe(xe.current),z.current&&h.observe(z.current),O.current&&h.observe(O.current),I.current&&h.observe(I.current),ie.current&&h.observe(ie.current),cn.current&&h.observe(cn.current),()=>{h.disconnect(),An.current&&clearTimeout(An.current)}},[]),i.jsxs("div",{className:"edit-complaint-page",style:{height:`${Nt}px`},children:[i.jsx(Bh,{ref:Sn,recordId:r,patientId:d,patientDetails:p,caseSummary:L,caseSummaryUpdatedAt:C,clinicSettings:Ae,userMessages:m,selectedImageFile:Mr,pendingLabOrders:kr,labReports:dt,pastComplaints:P,pharmacyOrders:We,pharmacyInventory:Ee,labInventory:ot,recurringMedications:$e,currentComplaint:c,setCurrentComplaint:u,setAiResponse:De,setAiResponseText:ke,setAiResponseJsonString:Re,setShowAiJsonDetails:st,setIsLoadingAi:Yt,setAiError:()=>{},setIsSubmittingAiOrder:Wn,setAiOrderSubmissionStatus:()=>{},setIsSubmittingAiLabOrder:ol,setAiLabOrderSubmissionStatus:()=>{},setIsSubmittingAiComplaint:cl,setAiComplaintSubmissionStatus:()=>{},setIsUpdatingCaseSummary:dl,setAiCaseSummaryUpdateStatus:()=>{},setCaseSummary:W,setCaseSummaryUpdatedAt:Y,setIsUpdatingAiMemoryByAI:hl,setAiMemoryUpdateByAIStatus:()=>{},setFollowUpQuestion:Wa,setFollowUpOptions:Ja,setError:we,setIsSavingAiResponse:Dt,setSaveAiResponseError:()=>{},fetchPharmacyOrdersData:on,fetchPendingLabOrdersData:ln,fetchLabReportsData:Tn,fetchPastComplaintsData:La,fetchPatientDetails:sn,fetchRecurringMedicationsData:Pn,setClinicSettings:Vr,setEditedAiMemory:Jr,handleDeleteItem:Ot,setCanUndo:$a,onAiActionSuccess:ye,addMessage:Ur,onPrintLabBill:h=>{xl(h),pa(!0)},onPrintPharmacyBill:Sl}),i.jsx(rg,{isOpen:gl,onClose:()=>pa(!1),billData:yl}),i.jsx(ig,{isOpen:bl,onClose:()=>ha(!1),billData:wl}),vl&&p&&i.jsx(hc,{onClose:()=>Hr(!1),patientData:ec(),tokenNumber:p.patient_token_number?String(p.patient_token_number):null,onAiSummaryChange:h=>{h&&(u(h),Ht(h),Hr(!1))}}),i.jsxs("div",{className:"edit-complaint-header",children:[i.jsx("button",{onClick:()=>a(-1),disabled:Et,className:"back-button",title:"Go Back",children:i.jsx(mc,{size:20})}),i.jsx("span",{ref:te,style:{position:"absolute",visibility:"hidden",height:"auto",width:"auto",whiteSpace:"nowrap"}}),!p&&It&&i.jsx("div",{className:"patient-header-details",children:i.jsxs("div",{className:"patient-info-display skeleton",children:[i.jsx(Te,{width:"120px",height:"18px"}),i.jsx(Te,{width:"60px",height:"16px"}),i.jsx(Te,{width:"80px",height:"16px"}),i.jsx(Te,{width:"90px",height:"16px"})]})}),p&&i.jsx("div",{className:"patient-header-details",children:_l?i.jsxs("div",{className:"patient-details-edit-form",children:[i.jsx("input",{type:"text",value:Er,onChange:h=>Ar(h.target.value),placeholder:"Name",className:"edit-input",disabled:St}),i.jsx("input",{type:"number",value:Dr??"",onChange:h=>Ir(h.target.value?parseInt(h.target.value):null),placeholder:"Age",className:"edit-input age",disabled:St}),i.jsxs("select",{value:Or??"",onChange:h=>$r(h.target.value||null),className:"edit-input gender",disabled:St,children:[i.jsx("option",{value:"",children:"Gender"}),i.jsx("option",{value:"M",children:"M"}),i.jsx("option",{value:"F",children:"F"}),i.jsx("option",{value:"O",children:"O"})]}),i.jsx("input",{type:"text",value:Lr??"",onChange:h=>Rr(h.target.value||null),placeholder:"Phone",className:"edit-input phone",disabled:St}),i.jsxs("div",{className:"edit-form-actions",children:[i.jsx("button",{onClick:()=>{Kn(!1),Mt(null)},className:"cancel-btn",disabled:St,children:"Cancel"}),i.jsx("button",{onClick:Xl,className:"save-btn",disabled:St,children:St?"...":"Save"})]}),wa&&i.jsx("div",{className:"error-note",children:wa})]}):i.jsxs("div",{className:"patient-info-display",children:[i.jsx("button",{onClick:()=>{Kn(!0),Ar(p.name||""),Ir(p.age),$r(p.gender),Rr(p.phone),Mt(null)},className:"patient-edit-trigger",title:"Edit Patient Details",disabled:St,children:i.jsx(mt,{size:14})}),i.jsxs("div",{className:"patient-ident-group",children:[i.jsx("span",{className:"patient-name",children:p.name??"N/A"}),i.jsxs("span",{className:"patient-id-badge",children:["#",p.patient_token_number??"N/A"]}),i.jsxs("span",{className:"patient-demographics",children:[p.age??"N/A"," / ",p.gender??"N/A"]}),i.jsx("div",{className:`patient-color-indicator status-color-${p.color_code||"none"}`,onClick:h=>Zl(h,p.id,p.color_code),title:"Click to cycle status color"}),p.phone&&i.jsxs("span",{className:"patient-phone-display",children:["(",p.phone,")"]}),Wr!==null&&Wr>0&&i.jsxs("div",{className:"patient-debt-indicator",onClick:()=>a("/dashboard/patient-debts"),title:"Manage Debts",children:["₹",Wr.toFixed(2)]})]}),i.jsxs("div",{className:"patient-action-group",children:[i.jsxs("button",{onClick:Gr,className:"action-icon-btn indigo",title:"Dental Overview",children:[i.jsx(fc,{toothNumber:30,style:{width:"14px",height:"14px"}}),i.jsx("span",{className:"btn-label",children:"Dental"})]}),i.jsxs("button",{onClick:()=>{p&&a("/dashboard/files",{state:{patient:{id:p.id,name:p.name,token:p.patient_token_number,age:p.age,gender:p.gender,phone:p.phone}}})},className:"action-icon-btn indigo",title:"Files",children:[i.jsx(ii,{size:14}),i.jsx("span",{className:"btn-label",children:"Files"})]}),i.jsxs("button",{onClick:h=>{h.stopPropagation(),Za()},disabled:!sr,className:"action-icon-btn gray",title:"Print Summary",children:[i.jsx(Ln,{size:14}),i.jsx("span",{className:"btn-label",children:"Print"})]})]})]})}),!p&&q!==void 0&&$!==void 0&&i.jsx("div",{className:"patient-header-details",children:i.jsxs("div",{className:"patient-info-display",children:[i.jsxs("span",{className:"patient-demographics",children:[q??"N/A"," / ",$??"N/A"]}),i.jsx("button",{onClick:h=>{h.stopPropagation(),Za()},disabled:!sr,className:"action-icon-btn gray",title:"Print Summary",children:i.jsx(Ln,{size:14})})]})}),i.jsx("div",{style:{minWidth:"64px",display:"flex",justifyContent:"flex-end"},children:i.jsx("button",{onClick:e,className:"icon-button small text-gray-600 hover:text-gray-900 bg-gray-100 hover:bg-gray-200",title:"Open Command Bar (Ctrl+K)",style:{padding:"0.2rem",borderRadius:"8px"},children:i.jsx(gc,{size:24})})})]}),i.jsxs("div",{className:"edit-complaint-content-area",ref:qe,children:[ja.length>0&&i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"edit-complaint-chat-column",style:{width:"30%",minWidth:"320px",maxWidth:"40%",flexShrink:0},children:i.jsx(ag,{messages:ja})}),i.jsx("div",{className:"draggable-divider",onMouseDown:()=>{}})]}),i.jsxs("div",{ref:xe,className:"edit-complaint-main-column",style:{flex:1,minWidth:0},children:[Fe&&i.jsxs("div",{className:"general-error-message",children:["Error: ",Fe]}),tt&&i.jsxs("div",{className:"ai-response-container",style:{padding:"16px"},children:[i.jsx(Te,{width:"100%",height:"18px",style:{marginBottom:"10px"}}),i.jsx(Te,{width:"95%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"85%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"90%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"70%",height:"16px"})]}),!tt&&(He||at)&&i.jsxs("div",{ref:ve,className:`${at?"ai-function-call-block":"ai-response-container"} group`,children:[He&&i.jsx(Qt,{remarkPlugins:[bt],children:He}),at&&i.jsxs("div",{className:"ai-json-details-container",children:[i.jsxs("button",{onClick:()=>st(!et),className:"ai-json-toggle-button",children:[et?i.jsx(is,{size:14,className:"mr-1"}):i.jsx(as,{size:14,className:"mr-1"}),et?"Hide":"Show"," AI Function Call Details"]}),et&&i.jsx("pre",{className:"ai-json-pre",children:i.jsx("code",{children:JSON.stringify(JSON.parse(at),null,2)})})]}),i.jsxs("div",{className:"ai-response-actions",children:[i.jsx("button",{onClick:()=>Wl(x),disabled:!x,title:"Copy Full AI Response",children:i.jsx(yc,{size:12})}),i.jsx("button",{onClick:Vl,disabled:!x,title:"Print AI Response",children:i.jsx(Ln,{size:12})})]})]})]}),i.jsx("div",{className:"draggable-divider",onMouseDown:ql}),i.jsx("div",{ref:X,className:"edit-complaint-context-column",style:{flexBasis:`calc(${100-ae}% - 5px)`},children:i.jsxs("div",{className:"ai-context-container",children:[i.jsxs("h3",{className:"ai-context-header",children:[i.jsx("span",{children:"AI Context:"}),(p==null?void 0:p.insurance_type)&&i.jsx("div",{className:"insurance-type-container mt-2",children:i.jsxs("select",{ref:ze,value:p.insurance_type,onChange:h=>Tl(p.id,h.target.value),className:"insurance-type-select",children:[i.jsx("option",{value:"cash",children:"Cash"}),i.jsx("option",{value:"insurance",children:"Insurance"}),i.jsx("option",{value:"no_cash_insurance",children:"No Cash Insurance"})]})})]}),J.length>0&&i.jsxs("div",{className:"ai-context-section",children:[i.jsx("div",{className:"flex justify-between items-center mb-2",children:i.jsx("h4",{className:"ai-context-section-title mb-0",children:"Dental Overview"})}),i.jsx("div",{onClick:Gr,style:{cursor:"pointer",transform:"scale(0.8)",transformOrigin:"top left",width:"125%",height:"350px",overflow:"hidden",pointerEvents:"auto"},title:"Click to open full Dental Page",children:i.jsx(xc,{selectedTeeth:[],onToothClick:()=>Gr(),toothConditions:Pl,toothDetails:El,numberingSystem:localStorage.getItem("dentalNumberingSystem")||"universal"})})]}),i.jsxs("div",{ref:D,className:"ai-context-section",children:[i.jsx("h4",{className:"ai-context-section-title",children:"Admission Status"}),It?i.jsxs("div",{className:"space-y-2",children:[i.jsx(Te,{width:"60%",height:"1.2em"}),i.jsx(Te,{width:"50%",height:"1.2em"}),i.jsx(Te,{width:"40%",height:"1.2em"}),i.jsxs("div",{className:"flex space-x-2 mt-2",children:[i.jsx(Te,{width:"80px",height:"30px"}),i.jsx(Te,{width:"100px",height:"30px"})]})]}):i.jsxs(i.Fragment,{children:[(p==null?void 0:p.admission_date)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Admitted:"})," ",new Date(p.admission_date).toLocaleDateString()]}),(p==null?void 0:p.discharge_date)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Discharged:"})," ",new Date(p.discharge_date).toLocaleDateString()]}),(p==null?void 0:p.current_status)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Current Status:"})," ",i.jsx("span",{className:"font-semibold",children:p.current_status})]}),i.jsxs("div",{className:"flex space-x-2 mt-2",children:[i.jsx("button",{onClick:Gl,className:`admit-discharge-button ${Yn?"discharge":"admit"}`,title:Yn?"Discharge Patient":"Admit Patient",disabled:!d||jr||Cr,children:jr?"Admitting...":Cr?"Discharging...":Yn?"Discharge":"Admit"}),i.jsxs("button",{onClick:()=>a(`/patient/${encodeURIComponent(d??"")}/admission-billing`),className:"queue-status-button",style:{backgroundColor:"#e0f2fe",color:"#0369a1",border:"1px solid #bae6fd",display:"flex",alignItems:"center",gap:"4px"},title:"Go to Admission Billing",disabled:!d,children:[i.jsx(ns,{size:14})," Billing"]}),i.jsx("button",{onClick:()=>Yl("doctor"),className:`queue-status-button ${Gn?"in-queue":"add-to-queue"}`,title:Gn?"Patient is in Doctor Queue":"Add Patient to Doctor Queue",disabled:!d||Sr||Gn,children:Sr?"Adding...":Gn?"In Queue":"Add to Queue"}),i.jsx("button",{onClick:Kl,className:"complete-consultation-button",title:"Mark Consultation as Complete",disabled:Tr,children:Tr?"Completing...":"Complete Consultation"})]})]})]}),i.jsx("div",{ref:z,children:i.jsx(gi,{title:"Pharmacy Order History",headerAction:Fl,items:xt,isLoading:E||It,loadingText:"Loading...",noDataText:"No orders.",renderItemContent:$l})}),i.jsxs("div",{ref:cn,className:"ai-context-section mt-4",children:[i.jsxs("div",{className:"flex justify-between items-center mb-2",children:[i.jsx("h4",{className:"ai-context-section-title mb-0",children:"Recurring Medications"}),i.jsxs("button",{onClick:()=>{wn([]),Jn(!0)},className:"text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded flex items-center gap-1",children:[i.jsx(pr,{size:12})," Add"]})]}),$e.length>0?i.jsx("div",{className:"overflow-x-auto",children:i.jsxs("table",{className:"w-full text-xs text-left",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b",children:[i.jsx("th",{className:"py-1 px-2",children:"#"}),i.jsx("th",{className:"py-1 px-2",children:"Medication"}),i.jsx("th",{className:"py-1 px-2",children:"Qty"}),i.jsx("th",{className:"py-1 px-2",children:"Frequency"}),i.jsx("th",{className:"py-1 px-2",children:"Next Delivery"}),i.jsx("th",{className:"py-1 px-2",children:"Status"}),i.jsx("th",{className:"py-1 px-2"})]})}),i.jsx("tbody",{children:$e.map((h,g)=>i.jsxs("tr",{className:"border-b last:border-0 hover:bg-gray-50",children:[i.jsx("td",{className:"py-1 px-2 font-medium text-gray-500",children:g+1}),i.jsxs("td",{className:"py-1 px-2 font-medium",children:[h.medicationName,i.jsxs("div",{className:"text-[10px] text-gray-500 font-normal",children:[h.tabletsPerDay?`${h.tabletsPerDay} tabs/day`:"",h.tabletsPerDay&&h.numberOfDays?" • ":"",h.numberOfDays?`${h.numberOfDays} days`:"",h.directions?` • ${h.directions}`:""]})]}),i.jsx("td",{className:"py-1 px-2",children:h.quantity}),i.jsxs("td",{className:"py-1 px-2",children:[h.frequencyDays," days"]}),i.jsx("td",{className:"py-1 px-2",children:new Date(h.nextDeliveryDate).toLocaleDateString()}),i.jsx("td",{className:"py-1 px-2",children:i.jsx("span",{className:`px-1.5 py-0.5 rounded-full text-[10px] ${h.status==="active"?"bg-green-100 text-green-800":h.status==="paused"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:h.status})}),i.jsx("td",{className:"py-1 px-2 text-right",children:i.jsx("button",{onClick:()=>{Qn(h),Nr(!0)},className:"text-gray-400 hover:text-blue-600 p-1",title:"Edit",children:i.jsx(mt,{size:12})})})]},h.id))})]})}):E||It?i.jsx("div",{style:{marginTop:"8px"},children:[1,2,3].map(h=>i.jsxs("div",{style:{display:"flex",gap:"12px",marginBottom:"10px"},children:[i.jsx(Te,{width:"30px",height:"14px"}),i.jsx(Te,{width:"120px",height:"14px"}),i.jsx(Te,{width:"40px",height:"14px"}),i.jsx(Te,{width:"60px",height:"14px"}),i.jsx(Te,{width:"80px",height:"14px"})]},h))}):i.jsx("p",{className:"text-gray-500 text-sm italic",children:"No recurring medications."})]}),aa&&i.jsx(eg,{isOpen:aa,onClose:()=>sa(!1),patientId:d,pharmacyInventory:Ee,fetchPharmacyOrdersData:on,isLoadingInventory:lt}),i.jsxs("div",{ref:O,children:[i.jsx(gi,{title:"Lab History (Orders & Reports)",headerAction:zl,items:Lt,onDeleteItem:void 0,onEditLabOrder:void 0,onSaveLabOrder:Ol,onCancelEditLabOrder:Al,onLabOrderTestChange:Dl,onLabOrderStatusChange:Il,onBillLabOrder:void 0,onUpdateLabOrderStatus:void 0,onEnterLabReport:void 0,labInventory:ot,isSavingLabOrder:pt,isLoading:xn||Je||It,loadingText:"Loading...",noDataText:"No lab Hx.",expandedLabReports:bn,toggleLabReport:ti,renderItemContent:Ll}),i.jsx($h,{isOpen:fl,onClose:()=>ia(!1),patientId:d,labInventory:ot,fetchPendingLabOrdersData:ln,isLoadingInventory:lt}),i.jsx("div",{ref:I,children:i.jsx(gi,{title:"Complaints History",items:$t,isLoading:ee||It,loadingText:"Loading...",noDataText:"No past Hx.",renderItemContent:Rl,onDeleteItem:Ot})}),i.jsxs("div",{className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsxs("h4",{className:"ai-context-section-title",children:[i.jsx(bc,{size:16,className:"text-purple-600"})," Clinic-wide System Prompt"]}),!Qr&&i.jsx("button",{onClick:Xa,className:"edit-button",title:"Edit System Prompt",disabled:Aa||rn||an,children:i.jsx(mt,{size:14})})]}),Qr&&Ae?i.jsxs("div",{className:"mt-2",children:[i.jsx("textarea",{value:jn,onChange:h=>Cn(h.target.value),className:"context-edit-textarea",placeholder:"Enter clinic system prompt...",disabled:rn||an}),i.jsxs("div",{className:"context-edit-actions",children:[i.jsx("button",{onClick:Hl,disabled:rn||an,className:"button-secondary",children:"Cancel"}),i.jsxs("button",{onClick:Ml,disabled:rn||an||rr===Ae.aiMemory&&jn===Ae.clinicWideSystemPrompt,className:"button-primary purple",children:[i.jsx(Qs,{size:14,className:"mr-1"}),an||rn?"Saving...":"Save Settings"]})]})]}):i.jsx("div",{className:"ai-context-text whitespace-pre-wrap mt-1 prose prose-sm max-w-none cursor-pointer hover:bg-gray-50 rounded p-1 -m-1 transition-colors",onClick:Xa,title:"Click to edit system prompt",children:Aa?i.jsxs("div",{style:{marginTop:"4px"},children:[i.jsx(Te,{width:"100%",height:"14px",style:{marginBottom:"6px"}}),i.jsx(Te,{width:"90%",height:"14px",style:{marginBottom:"6px"}}),i.jsx(Te,{width:"70%",height:"14px"})]}):Ae!=null&&Ae.clinicWideSystemPrompt?i.jsx(Qt,{remarkPlugins:[bt],children:Ae.clinicWideSystemPrompt}):i.jsx("span",{className:"italic text-gray-400",children:"N/A - Click to add."})}),!Qr&&(Ae==null?void 0:Ae.clinicWideSystemPromptUpdatedAt)&&i.jsxs("p",{className:"ai-context-text text-gray-400 mt-1",style:{fontSize:"0.625rem"},children:["Prompt Last Updated: ",new Date(Ae.clinicWideSystemPromptUpdatedAt).toLocaleDateString()]})]}),i.jsxs("div",{ref:ie,className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsx("h4",{className:"ai-context-section-title",children:"Case Summary"}),!F&&i.jsx("button",{onClick:Ka,className:"edit-button",title:"Edit Case Summary",disabled:E||ne,children:i.jsx(mt,{size:14})})]}),F?i.jsxs("div",{className:"mt-2",children:[i.jsx("textarea",{value:Z,onChange:h=>ce(h.target.value),className:"context-edit-textarea",rows:4,placeholder:"Enter case summary...",disabled:ne}),V&&i.jsx("p",{className:"text-red-500 text-xs mt-1",children:V}),i.jsxs("div",{className:"context-edit-actions",children:[i.jsx("button",{onClick:Bl,disabled:ne,className:"button-secondary",children:"Cancel"}),i.jsx("button",{onClick:Ul,disabled:ne||Z===L,className:"button-primary blue",children:ne?"Saving...":"Save"})]})]}):i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"ai-context-text whitespace-pre-wrap mt-1 prose prose-sm max-w-none cursor-pointer hover:bg-gray-50 rounded p-1 -m-1 transition-colors",onClick:Ka,title:"Click to edit case summary",children:E?i.jsxs("div",{style:{marginTop:"8px"},children:[i.jsx(Te,{width:"100%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"85%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"65%",height:"16px"})]}):L?i.jsx(Qt,{remarkPlugins:[bt],components:{},children:L}):i.jsx("span",{className:"italic text-gray-400",children:"N/A - Click to add."})}),C&&i.jsxs("p",{className:"ai-context-text text-gray-400 mt-1",style:{fontSize:"0.625rem"},children:["Last Edited: ",new Date(C).toLocaleDateString()]})]})]}),$t.length===0&&Lt.length===0&&xt.length===0&&!(ee||xn||Je)&&i.jsx("p",{className:"ai-context-text italic mt-4",children:"No recent history for this patient."}),Vn&&i.jsx("p",{className:"text-yellow-600 text-xs mt-2 ai-context-text",children:"Deleting..."}),na&&i.jsx("p",{className:"text-red-600 text-xs mt-2 ai-context-text",children:na})]})]})})]}),i.jsxs("div",{className:"edit-complaint-input-area",children:[i.jsxs("div",{className:"status-messages-container",children:[Ut&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:Ut}),Le&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:Le}),ea&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:ea}),Zt&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:Zt})]}),r&&!pe&&i.jsxs(b.Fragment,{children:[Ha&&i.jsxs("div",{className:"follow-up-question-container",children:[i.jsx("p",{className:"question-text",children:Ha}),Va.length>0&&i.jsx("div",{className:"options-grid",children:Va.map((h,g)=>i.jsx("button",{onClick:()=>Jl(h),className:"option-button",children:h},g))})]}),va&&i.jsx("div",{className:"speech-error-display",children:va}),Sa&&i.jsx("div",{className:"selected-file-display",children:i.jsx("span",{children:"Uploading image..."})}),Mr&&!Sa&&i.jsxs("div",{className:"selected-file-display",children:[i.jsxs("span",{children:["Selected: ",Mr.name]}),i.jsx("button",{onClick:()=>{Ca(null),er.current&&(er.current.value="")},className:"remove-file-button",title:"Remove image",children:"×"})]}),i.jsxs("div",{className:"input-section-selector",children:[i.jsx("button",{onClick:()=>In("response"),className:`selector-button ${Dn==="response"?"active":""}`,children:"AI"}),i.jsx("button",{onClick:()=>In("meds"),className:`selector-button ${Dn==="meds"?"active":""}`,children:"Meds"}),i.jsx("button",{onClick:()=>In("labs"),className:`selector-button ${Dn==="labs"?"active":""}`,children:"Labs"}),i.jsx("button",{onClick:()=>In("history"),className:`selector-button ${Dn==="history"?"active":""}`,children:"Hx"}),i.jsx("button",{onClick:()=>In("summary"),className:`selector-button ${Dn==="summary"?"active":""}`,children:"Sum"})]}),i.jsx("div",{className:"input-wrapper",children:i.jsxs("div",{className:"main-input-container",children:[i.jsx("input",{type:"file",ref:er,onChange:rc,accept:"image/*",className:"hidden"}),i.jsx("textarea",{ref:Ve,className:"complaint-textarea",value:c,onChange:h=>u(h.target.value),onKeyDown:Ql,placeholder:"Name, Age, Sex... Chat with Patient Manager AI",disabled:Et||!r||vn}),i.jsxs("div",{className:"chat-input-actions-container",children:[i.jsx("button",{type:"button",onClick:nc,disabled:Et||!r||vn,className:"icon-button",title:"Attach Image",children:i.jsx(wc,{size:14})}),i.jsx("button",{type:"button",onClick:tc,disabled:Et||!r||!Zn.current,className:`mic-button ${vn?"listening":""}`,title:vn?"Stop":"Mic",children:i.jsx(kc,{size:14})}),i.jsx("button",{onClick:()=>Ht(),disabled:Et||!c.trim()||!r||vn,className:"send-button",title:Et?"Processing...":"Save & Ask AI",children:Et?i.jsx("div",{className:"custom-loader-circle",role:"status","aria-label":"loading"}):i.jsx(_c,{size:14})}),jl&&i.jsx("button",{type:"button",onClick:Cl,disabled:Et,className:"icon-button text-red-500",title:"Undo Last AI Actions",children:i.jsx(ft,{size:14})})]})]})})]})]}),ca&&d&&i.jsx(tg,{isOpen:ca,onClose:()=>Jn(!1),onSuccess:()=>{d&&Pn(d),Jn(!1),wn([])},patientId:d,initialItems:da}),ua&&vr&&i.jsx(ng,{isOpen:ua,onClose:()=>Nr(!1),onSuccess:()=>{d&&Pn(d),Nr(!1),Qn(void 0)},medication:vr}),oa&&i.jsx(Nc,{isOpen:oa,onClose:()=>{la(!1),Qn(void 0),wn([])},onSuccess:()=>{d&&Pn(d),la(!1),Qn(void 0),wn([])},initialItems:da,medication:vr,initialPatient:p?{id:p.id,name:p.name,phone:p.phone||"",patient_token_number:String(p.patient_token_number||"")}:void 0})]})};export{lg as default};
