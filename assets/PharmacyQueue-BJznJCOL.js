import{u as M,d as B,f as d,j as e,S as Q,M as z,o as A,q as N}from"./index-CRA8Xzko.js";import{r as i,u as L}from"./react-vendor-Cc0P4_ZX.js";import{a0 as K,Q as S,a2 as R,i as U,m as G,a4 as I,z as J,a3 as W,y as H}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const se=()=>{const[c,h]=i.useState([]),[x,T]=i.useState(""),[m,k]=i.useState(!0),[f,_]=i.useState(null),o=L(),p=i.useRef(null),{openCommandBar:$}=M(),j=B(),b=t=>{t&&(j.prefetchQuery({queryKey:N.patients.context(t),queryFn:async()=>{const s=await d(`/api/patients/${t}/context`);if(!s.ok)throw new Error("Failed to fetch patient context");return s.json()},staleTime:5*60*1e3}),j.prefetchQuery({queryKey:N.patientDebts.balance(t),queryFn:async()=>{const s=await d(`/api/patient-debts/${t}/balance`);return s.ok?s.json():{netDebt:0}},staleTime:1*60*1e3}),j.prefetchQuery({queryKey:N.queue.latest(t),queryFn:async()=>{const s=await d(`/api/queue/patient/${t}/latest`);if(!s.ok)throw new Error("Failed to fetch latest queue status");const n=await s.json();return n!=null&&n._id&&j.prefetchQuery({queryKey:N.queue.entry(n._id),queryFn:async()=>{const a=await d(`/api/queue/doctor/complaint/${n._id}`);if(!a.ok)throw new Error("Failed to fetch complaint record");return a.json()},staleTime:1*60*1e3}),n},staleTime:5e3}))},[u,g]=i.useState(1),[q,D]=i.useState(1),F=10,C=i.useCallback(async(t,s,n)=>{k(!0),_(null);try{let a=`/api/pharmacy-orders?page=${t}&limit=${s}`;n&&n.trim()!==""&&(a+=`&search=${encodeURIComponent(n.trim())}`);const r=await d(a);if(!r.ok)throw new Error(`Failed to fetch orders: ${r.statusText} (${r.status})`);const l=await r.json();l&&Array.isArray(l.orders)?(h(l.orders),D(l.totalPages||1),g(l.currentPage||t)):h([])}catch(a){console.error("Failed to fetch pharmacy orders:",a),_(a.message||"Failed to fetch orders."),h([])}finally{k(!1)}},[]);i.useEffect(()=>(p.current&&clearTimeout(p.current),p.current=setTimeout(()=>{C(x?1:u,F,x)},500),()=>{p.current&&clearTimeout(p.current)}),[x,u,C]);const E=t=>o(`/dashboard/edit-pharmacy-order/${t}`),y=t=>o(`/dashboard/edit-complaint/patient/${t.patientId}`),O=t=>{const s=c.find(n=>n.id===t);if(s){const n=s.medications.map(a=>({name:a.name,pack_quantity:a.pack_quantity,loose_quantity:a.loose_quantity,price:a.price??0,pack_price:a.pack_price,loose_price:a.loose_price,total_price:a.total_price,isLoose:a.isLoose,unit:a.unit,drug_id:a.drug_id?String(a.drug_id):null,tabletsPerDay:a.tabletsPerDay,numberOfDays:a.numberOfDays,directions_to_use:a.directions_to_use,discount_percentage:0,batch:a.batch,expiry_date:a.expiry_date}));o(`/dashboard/pharmacy-billing/${t}`,{state:{initialItems:n}})}},w=async(t,s)=>{const n=c.find(a=>a.id===t);if(n)try{const a=await d(`/api/pharmacy-orders/${t}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:s,medications:n.medications})});if(a.ok){const r=await a.json();h(l=>l.map(v=>v.id===r.id?{...v,status:r.status}:v))}}catch(a){console.error("Status update failed",a),alert("Failed to update status")}},P=t=>`pq-pill ${t}`;return e.jsxs("div",{className:"pq-container",children:[e.jsxs("div",{className:"pq-header",children:[e.jsxs("div",{className:"pq-nav-actions",children:[e.jsxs("button",{onClick:()=>o("/dashboard/add-order"),className:"pq-btn",children:[e.jsx(K,{})," Add Order"]}),e.jsxs("button",{onClick:()=>o("/dashboard/inventory"),className:"pq-btn",children:[e.jsx(S,{})," Inventory"]}),e.jsxs("button",{onClick:()=>$(),className:"pq-btn",children:[e.jsx(R,{})," Newton's AI"]}),e.jsxs("button",{onClick:()=>o("/dashboard/distributors"),className:"pq-btn",children:[e.jsx(S,{})," Distributors"]})]}),e.jsxs("div",{className:"pq-search-wrap",children:[e.jsx(U,{className:"pq-search-icon"}),e.jsx("input",{className:"pq-search-input",placeholder:"Search orders...",value:x,onChange:t=>T(t.target.value)})]})]}),e.jsxs("div",{className:"pq-card",children:[e.jsxs("div",{className:"pq-card-content",children:[m&&c.length===0&&e.jsx("div",{className:"p-4 space-y-2",children:[1,2,3].map(t=>e.jsx(Q,{height:40,className:"mb-2"},t))}),f&&e.jsxs("div",{className:"p-4 text-red-500",children:["Error: ",f]}),!m&&!f&&c.length===0&&e.jsx("div",{className:"p-8 text-center text-gray-500",children:"No orders found."}),!m&&c.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"pq-table-wrapper",children:e.jsxs("table",{className:"pq-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Patient"}),e.jsx("th",{children:"Medications"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:c.map(t=>e.jsxs("tr",{className:"pq-row",onClick:()=>y(t),onMouseEnter:()=>b(t.patientId),children:[e.jsxs("td",{children:[e.jsx("div",{className:"pq-text-bold",children:t.patientName}),e.jsxs("div",{className:"pq-text-sm",children:["#",t.patientTokenNumber]})]}),e.jsx("td",{children:e.jsxs("div",{className:"pq-nested-table-wrap",children:[e.jsx("table",{className:"pq-nested-table",children:e.jsx("tbody",{children:t.medications.map((s,n)=>e.jsxs("tr",{children:[e.jsx("td",{className:"pq-text-bold",children:s.name}),e.jsxs("td",{children:[s.pack_quantity>0&&`Pack: ${s.pack_quantity} `,s.loose_quantity>0&&`Loose: ${s.loose_quantity}`]}),e.jsx("td",{className:"pq-text-sm",children:s.directions_to_use})]},n))})}),t.prescriptionForUnavailableDrugs&&e.jsxs("div",{className:"mt-1 text-xs opacity-75 pq-markdown",children:[e.jsx("strong",{children:"Note:"})," ",e.jsx(z,{remarkPlugins:[A],children:t.prescriptionForUnavailableDrugs})]})]})}),e.jsx("td",{className:"pq-text-sm",children:new Date(t.date).toLocaleDateString()}),e.jsxs("td",{className:"pq-text-mono pq-text-bold",children:["₹",Number(t.order_total||0).toFixed(2)]}),e.jsx("td",{children:e.jsx("span",{className:P(t.status),children:t.status})}),e.jsx("td",{children:e.jsxs("div",{className:"pq-actions",children:[t.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:s=>{s.stopPropagation(),E(t.id)},className:"pq-action-btn pq-btn-edit",children:[e.jsx(G,{size:12})," Edit"]}),e.jsxs("button",{onClick:s=>{s.stopPropagation(),O(t.id)},className:"pq-action-btn pq-btn-bill",children:[e.jsx(I,{size:12})," Bill"]})]}),t.status==="billed"&&e.jsxs("button",{onClick:s=>{s.stopPropagation(),w(t.id,"dispensed")},className:"pq-action-btn pq-btn-dispense",children:[e.jsx(J,{size:12})," Dispense"]}),(t.status==="pending"||t.status==="billed")&&e.jsx("button",{onClick:s=>{s.stopPropagation(),w(t.id,"cancelled")},className:"pq-action-btn pq-btn-cancel",children:"Cancel"}),e.jsx("button",{onClick:s=>{s.stopPropagation(),y(t)},onMouseEnter:()=>b(t.patientId),className:"pq-action-btn pq-btn-details",children:"Details"})]})})]},t.id))})]})}),e.jsx("div",{className:"pq-card-list",children:c.map(t=>e.jsxs("div",{className:"pq-mobile-card",onClick:()=>y(t),onMouseEnter:()=>b(t.patientId),children:[e.jsxs("div",{className:"pq-card-header",children:[e.jsxs("div",{children:[e.jsx("div",{className:"pq-text-bold",children:t.patientName}),e.jsxs("div",{className:"pq-text-sm",children:["#",t.patientTokenNumber]})]}),e.jsx("span",{className:P(t.status),children:t.status})]}),e.jsx("div",{className:"mb-2",children:t.medications.slice(0,3).map((s,n)=>e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:[s.name," (",s.pack_quantity>0?`${s.pack_quantity}p`:""," ",s.loose_quantity>0?`${s.loose_quantity}l`:"",")"]},n))}),e.jsxs("div",{className:"flex justify-between items-center mt-2",children:[e.jsxs("div",{className:"pq-text-mono pq-text-bold",children:["₹",Number(t.order_total||0).toFixed(2)]}),e.jsx("div",{className:"pq-actions",children:e.jsx("button",{onClick:s=>{s.stopPropagation(),y(t)},onMouseEnter:()=>b(t.patientId),className:"pq-action-btn pq-btn-details",children:"Details"})})]})]},t.id))})]})]}),!m&&q>1&&e.jsxs("div",{className:"pq-footer px-4 pb-4",children:[e.jsxs("div",{className:"pq-page-info",children:["Page ",u," of ",q]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"pq-pagination-btn",disabled:u===1,onClick:()=>g(t=>Math.max(1,t-1)),children:e.jsx(W,{size:16})}),e.jsx("button",{className:"pq-pagination-btn",disabled:u===q,onClick:()=>g(t=>Math.min(q,t+1)),children:e.jsx(H,{size:16})})]})]})]})]})};export{se as default};
