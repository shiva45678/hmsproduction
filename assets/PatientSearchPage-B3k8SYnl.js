import{v as re,d as ce,t as le,f as h,j as s,S as k,L as oe,g as de,q as N}from"./index-DpOfI1um.js";import{r as n,u as he,f as me}from"./react-vendor-Cc0P4_ZX.js";import{u as ue}from"./useAutoFocusSingleInput-6a_v4dYJ.js";import{W as pe,X as A,o as xe,a as fe,d as ge}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const ye="AIzaSyBEt7v-LxBxAKwpTCtkI-3IshYxdnEqbes",je={apiKey:ye},Ae=()=>{const[r,l]=n.useState(""),[v,o]=n.useState([]),[B,m]=n.useState(!1),[P,C]=n.useState(null),[u,b]=n.useState(!1),[R,S]=n.useState(null),w=n.useRef(null),[I,q]=n.useState(!1),[U,E]=n.useState(!1),[f,M]=n.useState(null),[W,_]=n.useState(null),[L,O]=n.useState([]),[Y,T]=n.useState(!0),[$,Ne]=n.useState(!1);ue();const p=he(),g=me(),i=re({settings:{},staffList:[]}),y=ce(),F=e=>{e&&(y.prefetchQuery({queryKey:N.patients.context(e),queryFn:async()=>{const t=await h(`/api/patients/${e}/context`);if(!t.ok)throw new Error("Failed to fetch patient context");return t.json()},staleTime:5*60*1e3}),y.prefetchQuery({queryKey:N.patientDebts.balance(e),queryFn:async()=>{const t=await h(`/api/patient-debts/${e}/balance`);return t.ok?t.json():{netDebt:0}},staleTime:1*60*1e3}),y.prefetchQuery({queryKey:N.queue.latest(e),queryFn:async()=>{const t=await h(`/api/queue/patient/${e}/latest`);if(!t.ok)throw new Error("Failed to fetch latest queue status");const a=await t.json();return a!=null&&a._id&&y.prefetchQuery({queryKey:N.queue.entry(a._id),queryFn:async()=>{const c=await h(`/api/queue/doctor/complaint/${a._id}`);if(!c.ok)throw new Error("Failed to fetch complaint record");return c.json()},staleTime:1*60*1e3}),a},staleTime:5e3}))},{selectedImage:j,handleImageSelect:V,clearImage:G}=i,K=n.useRef(null),X=e=>{var a;const t=(a=e.target.files)==null?void 0:a[0];t&&V(t)};n.useEffect(()=>{i.chatHistory.length>0&&$&&i.isProcessing},[i.chatHistory.length]),n.useEffect(()=>{(async()=>{T(!0);try{const t=new URLSearchParams({page:"1",limit:"5",sortBy:"createdAt",sortOrder:"desc"}),a=await h(`/api/patients?${t.toString()}`);if(a.ok){const c=await a.json();O(c.patients||[])}}catch(t){console.error("Error fetching recent patients:",t)}finally{T(!1)}})()},[]),n.useEffect(()=>{i.setChatQuery(r)},[r]);const D=n.useCallback(async e=>{if(!(e||r).trim()){S("Please enter complaint details.");return}b(!0),S(null),e&&e!==i.chatQuery&&i.setChatQuery(e);try{i.handleSendMessage(),l("")}catch(a){console.error("AI Error:",a),S("AI failed to process. Try again."),b(!1)}},[r,i]);n.useEffect(()=>{!i.isProcessing&&u&&b(!1)},[i.isProcessing,u]),n.useEffect(()=>{const e=w.current;e&&(e.style.height="auto",e.style.height=`${e.scrollHeight}px`);const a=new URLSearchParams(g.search).get("caseDetails");if(a){const c=decodeURIComponent(a);c!==r&&(l(c),q(!0))}},[g.search,r]),n.useEffect(()=>{I&&r.trim()&&(p(g.pathname,{replace:!0}),D(r),q(!1))},[I,r,D,p,g.pathname]),n.useEffect(()=>{const e=w.current;e&&(e.style.height="auto",e.style.height=`${e.scrollHeight}px`)},[r]),n.useEffect(()=>{f&&(l(f),E(!1),i.setChatQuery(f),setTimeout(()=>i.handleSendMessage(),0),M(null))},[f,i]);const J=()=>{_({id:null,token:null,name:"New Case",age:null,gender:null}),E(!0)},Q=n.useMemo(()=>le(async e=>{const t=e.trim(),a=/^\d+$/.test(t),c=t.split(/\s+/).length;if(t.length<2||a&&t.length>10||!a&&c>2){o([]),m(!1),C(null);return}m(!0),C(null);try{const d=new URLSearchParams({search:encodeURIComponent(e),page:"1",limit:"20",sortBy:"name",sortOrder:"asc"}),x=await h(`/api/patients?${d.toString()}`);if(!x.ok){const ie=await x.text();throw new Error(`API Error (${x.status}): ${ie||x.statusText}`)}const ne=await x.json();o(ne.patients)}catch(d){console.error("Error searching patients:",d),C(d.message||"Failed to search patients."),o([])}finally{m(!1)}},300),[]),Z=e=>{const t=e.target.value;l(t);const a=t.trim(),c=/^\d+$/.test(a),d=a.split(/\s+/).length;a.length>=2&&!(c&&a.length>10||!c&&d>2)?m(!0):(m(!1),o([])),Q(t)},ee=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),r.trim()&&!B&&H())},z=async e=>{e&&e.id&&p(`/dashboard/edit-complaint/patient/${e.id}`)},se=[{icon:"ðŸ¤’",title:"Example: Fever & Cold",description:"Rajesh Kumar, 35 year old male, fever since 2 days, cold, body pain, no cough",text:"Rajesh Kumar, 35 year old male, fever since 2 days, cold, body pain, no cough"},{icon:"ðŸ¤¢",title:"Example: Stomach Ache",description:"Priya Sharma, 28 year old female, stomach pain after eating, acidity, bloating since 3 days",text:"Priya Sharma, 28 year old female, stomach pain after eating, acidity, bloating since 3 days"}],te=e=>{l(e),setTimeout(()=>{i.handleSendMessage(e),l(""),o([])},50)},ae=()=>{l(""),o([]),i.refreshChat()},H=()=>{!r.trim()&&!j||(Q.cancel(),i.handleSendMessage(r),l(""),o([]))};return s.jsxs("div",{className:"patient-search-page-container",children:[s.jsxs("div",{className:"patient-search-header",children:[s.jsx("button",{onClick:()=>p("/dashboard/queue"),className:"patient-search-button patient-search-button-primary",children:"OPD Queue"}),s.jsx("button",{onClick:()=>p(-1),className:"patient-search-button patient-search-button-back",children:s.jsx(pe,{size:16})})]}),s.jsxs("div",{className:"patient-search-content-box",children:[P&&s.jsx("p",{className:"patient-search-error",children:P}),R&&s.jsx("p",{className:"patient-search-error",children:R}),Y?s.jsxs("div",{className:"newly-registered-section",children:[s.jsx("div",{className:"recent-list",children:[1,2,3,4,5].map(e=>s.jsxs("div",{className:"recent-patient-pill",style:{cursor:"default"},children:[s.jsxs("div",{className:"recent-name-container",children:[s.jsx(k,{width:100,height:18}),s.jsx(k,{width:30,height:14})]}),s.jsx("div",{className:"recent-info",children:s.jsx(k,{width:60,height:12})})]},e))}),s.jsx("div",{className:"newly-registered-label",children:"NEWLY REGISTERED"})]}):L.length>0&&s.jsxs("div",{className:"newly-registered-section",children:[s.jsx("div",{className:"recent-list",children:L.map(e=>s.jsxs("div",{className:"recent-patient-pill",onClick:()=>z(e),onMouseEnter:()=>e.id&&F(e.id),children:[s.jsxs("div",{className:"recent-name-container",children:[s.jsx("span",{className:"recent-name",children:e.name||"New Patient"}),s.jsxs("span",{className:"recent-token",children:["#",e.token]})]}),s.jsxs("div",{className:"recent-info",children:[e.age," yrs / ",e.gender]})]},e.id))}),s.jsx("div",{className:"newly-registered-label",children:"NEWLY REGISTERED"})]}),i.chatHistory.length===0&&v.length===0&&s.jsxs("div",{className:"example-cases-section",children:[s.jsxs("div",{className:"example-cases-header",children:[s.jsx("span",{className:"sparkles-icon",children:"âœ¨"}),s.jsx("h3",{children:"Try AI with Example Cases"})]}),s.jsx("div",{className:"example-cards-container",children:se.map((e,t)=>s.jsxs("div",{className:"example-case-card",onClick:()=>te(e.text),children:[s.jsx("div",{className:"example-icon",children:e.icon}),s.jsxs("div",{className:"example-content",children:[s.jsx("div",{className:"example-title",children:e.title}),s.jsx("div",{className:"example-description",children:e.description})]})]},t))})]})]}),i.chatHistory.length>0&&!u&&s.jsxs("div",{className:`ai-chat-overlay ${$?"minimized":""}`,children:[s.jsxs("div",{className:"ai-chat-header",children:[s.jsx("span",{children:"AI Assistant"}),s.jsx("div",{className:"ai-chat-controls",children:s.jsx("button",{className:"icon-btn",onClick:()=>ae(),title:"Clear Chat",children:s.jsx(A,{size:16})})})]}),s.jsxs("div",{className:"ai-chat-messages",children:[i.chatHistory.map((e,t)=>s.jsx("div",{className:`chat-bubble ${e.role==="model"?"model":"user"}`,children:e.role==="system"?s.jsx("i",{children:e.text}):e.text},t)),i.isProcessing&&s.jsx("div",{className:"chat-bubble model",children:"Typing..."})]})]}),v.length>0&&!u&&s.jsxs("div",{className:"patient-search-results-overlay",children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",paddingBottom:"0.5rem"},children:[s.jsx("div",{style:{fontWeight:600,color:"#64748b"},children:"Found Patients"}),s.jsx("button",{onClick:()=>o([]),style:{border:"none",background:"transparent",color:"#94a3b8",cursor:"pointer"},children:s.jsx(A,{size:14})})]}),v.map(e=>s.jsxs("div",{onClick:()=>z(e),onMouseEnter:()=>e.id&&F(e.id),className:"patient-search-result-item",children:[s.jsxs("div",{className:"patient-search-result-item-name-container",children:[s.jsxs("span",{className:"patient-search-result-item-token",children:["[#",e.token,"]"]}),s.jsx("span",{className:"patient-search-result-item-name",children:e.name})]}),s.jsxs("div",{className:"patient-search-result-item-details",children:[e.age?`${e.age} yrs`:"",e.age&&e.gender?" / ":"",e.gender||"N/A"]})]},e.id))]}),s.jsxs("div",{className:"sticky-chat-input-box",children:[s.jsxs("div",{className:"cmd-input-container",children:[j&&s.jsxs("div",{className:"cmd-image-preview",children:[s.jsx("img",{src:j,alt:"Selected"}),s.jsx("button",{className:"cmd-image-delete",onClick:G,children:s.jsx(A,{size:12})})]}),s.jsx("textarea",{ref:w,placeholder:"Search (Name/Token/Phone), Ask AI, or Enter New Case...",value:r,onChange:Z,onKeyDown:ee,className:"cmd-input",disabled:u||i.isProcessing,rows:1}),s.jsxs("div",{className:"cmd-controls-group",children:[s.jsx("input",{type:"file",ref:K,onChange:X,accept:"image/*",style:{display:"none"}}),s.jsx("button",{className:"cmd-icon-btn",onClick:()=>{var e;return(e=K.current)==null?void 0:e.click()},title:"Attach Image",children:s.jsx(xe,{})}),s.jsx("button",{className:"cmd-icon-btn",onClick:J,title:"Voice Input",children:s.jsx(fe,{})}),(r.length>0||j)&&s.jsx("button",{className:"cmd-icon-btn send-btn",onClick:H,title:"Send",children:s.jsx(ge,{})})]})]}),U&&s.jsx(oe,{options:je,children:s.jsx(de,{onClose:()=>E(!1),patientData:W,tokenNumber:null,onAiSummaryChange:M})})]})]})};export{Ae as default};
