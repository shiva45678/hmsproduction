import{d as se,f as c,j as e,S as l,q as F}from"./index-D_kqlrGT.js";import{u as ne,r as s}from"./react-vendor-Cc0P4_ZX.js";import{W as le,a4 as ie,a7 as re,a8 as oe,w as de,ag as ce,a0 as he}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const ye=()=>{const C=ne(),p=se(),[y,K]=s.useState([]),[U,T]=s.useState(!0),[h,r]=s.useState(null),[m,W]=s.useState(""),[g,I]=s.useState("debtHighToLow"),[N,G]=s.useState(!0),[v,J]=s.useState(""),[Z,S]=s.useState(!1),[X,k]=s.useState(!1),[o,b]=s.useState(null),[_,A]=s.useState([]),[u,M]=s.useState(null),[O,E]=s.useState(""),[q,V]=s.useState(""),[$,R]=s.useState(""),[B,L]=s.useState("cash"),[z,Y]=s.useState(0),f=s.useMemo(()=>{let t=[...y];N&&(t=t.filter(n=>parseFloat(n.netDebt)>0));const a=parseFloat(v);switch(!isNaN(a)&&a>0&&(t=t.filter(n=>parseFloat(n.netDebt)>=a)),g){case"name":t.sort((n,i)=>n.name.localeCompare(i.name));break;case"debtHighToLow":t.sort((n,i)=>parseFloat(i.netDebt)-parseFloat(n.netDebt));break;case"debtLowToHigh":t.sort((n,i)=>parseFloat(n.netDebt)-parseFloat(i.netDebt));break}return t},[y,N,v,g]),w=s.useCallback(async()=>{T(!0),r(null);try{const t=m?`/api/patient-debts?search=${encodeURIComponent(m)}`:"/api/patient-debts",a=await c(t);if(!a.ok)throw new Error(`Failed to fetch patients with debt: ${a.statusText}`);const n=await a.json();K(n);const i=n.reduce((x,d)=>x+parseFloat(d.netDebt||"0"),0);Y(i)}catch(t){console.error("Failed to fetch patients with debt:",t),r(t.message||"Failed to load patients with debt.")}finally{T(!1)}},[m]);s.useEffect(()=>{w()},[w]);const H=s.useCallback(async t=>{r(null);try{const a=await c(`/api/patient-debts/${t}/transactions`);if(!a.ok)throw new Error(`Failed to fetch transactions: ${a.statusText}`);const i=(await a.json()).map(j=>({...j,debt_value:parseFloat(j.debt_value),amount_paid:parseFloat(j.amount_paid),balance_remaining:parseFloat(j.balance_remaining)}));A(i);const x=await c(`/api/patient-debts/${t}/balance`);if(!x.ok)throw new Error(`Failed to fetch balance: ${x.statusText}`);const d=await x.json();M({patientId:d.patientId,patientName:d.patientName,totalDebtValue:parseFloat(d.totalDebtValue),totalAmountPaid:parseFloat(d.totalAmountPaid),netDebt:parseFloat(d.netDebt)})}catch(a){console.error("Error fetching transactions/balance:",a),r(a.message||"Failed to load transactions or balance.")}},[]),ee=t=>{t&&(p.prefetchQuery({queryKey:F.patients.context(t),queryFn:async()=>{const a=await c(`/api/patients/${t}/context`);if(!a.ok)throw new Error("Failed to fetch patient context");return a.json()},staleTime:1e3*60*5}),p.prefetchQuery({queryKey:F.patientDebts.balance(t),queryFn:async()=>{const a=await c(`/api/patient-debts/${t}/balance`);if(!a.ok)throw new Error("Failed to fetch patient debt");return a.json()},staleTime:1e3*60}),p.prefetchQuery({queryKey:F.queue.latest(t),queryFn:async()=>{const a=await c(`/api/queue/patient/${t}/latest`);if(!a.ok){if(a.status===404)return null;throw new Error("Failed to fetch queue status")}return a.json()},staleTime:1e3*5}))},te=async t=>{if(t.preventDefault(),r(null),!o)return;const a=parseFloat(q||"0");if(a<=0){r("Payment amount must be greater than 0");return}try{const n=await c(`/api/patient-debts/${o.id}/payments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction_date:O,amount_paid:a,notes:$,payment_mode:B})});if(!n.ok){const i=await n.json();throw new Error(i.message||"Failed to add payment.")}P(),H(o.id),w()}catch(n){console.error("Error adding payment:",n),r(n.message||"Failed to add payment.")}},ae=t=>{b(t),H(t.id),r(null),S(!0)},D=()=>{S(!1),b(null),A([]),M(null)},Q=t=>{b(t),E(new Date().toISOString().split("T")[0]),V(""),R(""),L("cash"),r(null),k(!0)},P=()=>{k(!1),b(null)};return U?e.jsxs("div",{className:"patient-debt-management-page",children:[e.jsxs("div",{className:"patient-debt-header",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx(l,{width:80,height:36}),e.jsx(l,{width:200,height:32})]}),e.jsx(l,{width:250,height:36})]}),e.jsxs("div",{className:"filter-container",children:[e.jsx(l,{width:200,height:40}),e.jsx(l,{width:120,height:40}),e.jsx(l,{width:100,height:40}),e.jsx(l,{width:150,height:40})]}),e.jsx("div",{className:"debt-table-container",children:e.jsxs("table",{className:"debt-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Patient Name"}),e.jsx("th",{children:"Phone"}),e.jsx("th",{children:"Total Debt Value"}),e.jsx("th",{children:"Total Paid"}),e.jsx("th",{children:"Net Debt (Outstanding)"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:[1,2,3,4,5,6].map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(l,{width:150,height:20})}),e.jsx("td",{children:e.jsx(l,{width:100,height:20})}),e.jsx("td",{children:e.jsx(l,{width:100,height:20})}),e.jsx("td",{children:e.jsx(l,{width:100,height:20})}),e.jsx("td",{children:e.jsx(l,{width:100,height:20})}),e.jsx("td",{children:e.jsx(l,{width:180,height:32})})]},t))})]})})]}):e.jsxs("div",{className:"patient-debt-management-page",children:[e.jsxs("div",{className:"patient-debt-header",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx("button",{onClick:()=>C(-1),className:"back-button",title:"Go Back",children:e.jsx(le,{size:20})}),e.jsx("h2",{children:"Patient Debt Management"})]}),e.jsxs("div",{className:`total-debt-display ${z>0?"debt-positive":"debt-zero"}`,children:[e.jsx(ie,{size:20}),e.jsx("strong",{children:"Total Outstanding Debt:"})," ₹",z.toFixed(2)]})]}),h&&e.jsx("div",{className:"error-message",children:h}),e.jsxs("div",{className:"filter-container",children:[e.jsx("input",{type:"text",placeholder:"Search by name or phone...",value:m,onChange:t=>W(t.target.value),className:"filter-search-input"}),e.jsxs("select",{id:"sortBy",value:g,onChange:t=>I(t.target.value),className:"filter-select",title:"Sort by",children:[e.jsx("option",{value:"debtHighToLow",children:"Debt ↓"}),e.jsx("option",{value:"debtLowToHigh",children:"Debt ↑"}),e.jsx("option",{value:"name",children:"Name A-Z"})]}),e.jsx("input",{type:"number",id:"minDebt",value:v,onChange:t=>J(t.target.value),placeholder:"Min ₹",min:"0",className:"filter-number-input",title:"Minimum debt amount"}),e.jsxs("label",{className:"filter-checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:N,onChange:t=>G(t.target.checked)}),"Outstanding only"]}),e.jsxs("span",{className:"filter-count",children:[f.length,"/",y.length]})]}),e.jsx("div",{className:"debt-table-container",children:e.jsxs("table",{className:"debt-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsxs("th",{children:[e.jsx(re,{size:14})," Patient Name"]}),e.jsxs("th",{children:[e.jsx(oe,{size:14})," Phone"]}),e.jsxs("th",{children:[e.jsx(de,{size:14})," Total Debt Value"]}),e.jsx("th",{children:"Total Paid"}),e.jsx("th",{children:"Net Debt (Outstanding)"}),e.jsx("th",{className:"actions-cell",children:"Actions"})]})}),e.jsx("tbody",{children:f.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"no-results-message",children:m?"No patients found matching your search.":"No patients with outstanding debt."})}):f.map(t=>e.jsxs("tr",{onClick:()=>C(`/dashboard/edit-complaint/patient/${t.id}`),onMouseEnter:()=>ee(t.id),style:{cursor:"pointer"},title:"Click to view patient details",children:[e.jsx("td",{"data-label":"Patient Name",children:e.jsxs("div",{className:"patient-name-cell",children:[e.jsx("strong",{children:t.name}),t.age&&t.gender&&e.jsxs("span",{className:"patient-meta",children:[t.age,"y / ",t.gender]})]})}),e.jsx("td",{"data-label":"Phone",children:t.phone||"-"}),e.jsxs("td",{"data-label":"Total Debt Value",children:["₹",t.totalDebtValue]}),e.jsxs("td",{"data-label":"Total Paid",className:"amount-paid",children:["₹",t.totalAmountPaid]}),e.jsxs("td",{"data-label":"Net Debt",className:parseFloat(t.netDebt)>0?"debt-outstanding":"debt-clear",children:["₹",t.netDebt]}),e.jsx("td",{className:"actions-cell",onClick:a=>a.stopPropagation(),children:e.jsxs("div",{className:"actions-buttons-group",children:[e.jsxs("button",{onClick:()=>ae(t),className:"action-text-button view-button",title:"View Transactions",children:[e.jsx(ce,{size:16})," View History"]}),e.jsxs("button",{onClick:()=>Q(t),className:"action-text-button add-payment-button",title:"Record Payment",children:[e.jsx(he,{size:16})," Record Payment"]})]})})]},t.id))})]})}),Z&&o&&e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal-content large-modal",children:[e.jsx("button",{onClick:D,className:"modal-close-button",children:"×"}),e.jsxs("h3",{className:"modal-title",children:["Debt History for ",o.name]}),h&&e.jsx("div",{className:"modal-error-message",children:h}),u&&e.jsxs("div",{className:"balance-summary",children:[e.jsxs("div",{className:"balance-row",children:[e.jsx("span",{children:"Total Debt Value:"}),e.jsxs("strong",{children:["₹",u.totalDebtValue.toFixed(2)]})]}),e.jsxs("div",{className:"balance-row",children:[e.jsx("span",{children:"Total Amount Paid:"}),e.jsxs("strong",{className:"amount-paid",children:["₹",u.totalAmountPaid.toFixed(2)]})]}),e.jsxs("div",{className:"balance-row net-debt-row",children:[e.jsx("span",{children:e.jsx("strong",{children:"Net Outstanding Debt:"})}),e.jsxs("strong",{className:u.netDebt>0?"debt-outstanding":"debt-clear",children:["₹",u.netDebt.toFixed(2)]})]})]}),e.jsx("h4",{children:"Transaction History"}),_.length===0?e.jsx("p",{children:"No transactions recorded for this patient."}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"debt-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Debt Added"}),e.jsx("th",{children:"Payment Received"}),e.jsx("th",{children:"Balance After"}),e.jsx("th",{children:"Due Date"}),e.jsx("th",{children:"Payment Mode"}),e.jsx("th",{children:"Notes"})]})}),e.jsx("tbody",{children:_.map(t=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Date",children:new Date(t.transaction_date).toLocaleDateString()}),e.jsx("td",{"data-label":"Debt Added",className:t.debt_value>0?"debt-added":"",children:t.debt_value>0?`+ ₹${t.debt_value.toFixed(2)}`:"-"}),e.jsx("td",{"data-label":"Payment Received",className:t.amount_paid>0?"payment-received":"",children:t.amount_paid>0?`- ₹${t.amount_paid.toFixed(2)}`:"-"}),e.jsxs("td",{"data-label":"Balance After",children:["₹",t.balance_remaining.toFixed(2)]}),e.jsx("td",{"data-label":"Due Date",children:t.due_date?new Date(t.due_date).toLocaleDateString():"-"}),e.jsx("td",{"data-label":"Payment Mode",children:t.payment_mode?t.payment_mode.charAt(0).toUpperCase()+t.payment_mode.slice(1):"-"}),e.jsx("td",{"data-label":"Notes",children:t.notes||"-"})]},t.id))})]})}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",onClick:()=>{D(),Q(o)},className:"button-submit",children:"Record Payment"}),e.jsx("button",{type:"button",onClick:D,className:"button-cancel",children:"Close"})]})]})}),X&&o&&e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal-content",children:[e.jsx("button",{onClick:P,className:"modal-close-button",children:"×"}),e.jsxs("h3",{className:"modal-title",children:["Record Payment for ",o.name]}),e.jsxs("div",{className:"current-debt-info",children:[e.jsx("span",{children:"Current Outstanding Debt:"}),e.jsxs("strong",{className:"debt-outstanding",children:["₹",o.netDebt]})]}),h&&e.jsx("div",{className:"modal-error-message",children:h}),e.jsxs("form",{onSubmit:te,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"payment_date",children:"Payment Date:"}),e.jsx("input",{type:"date",id:"payment_date",value:O,onChange:t=>E(t.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"amount_paid",children:"Amount Paid (₹):"}),e.jsx("input",{type:"number",id:"amount_paid",value:q,onChange:t=>V(t.target.value),step:"0.01",min:"0.01",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"payment_mode",children:"Payment Mode:"}),e.jsxs("select",{id:"payment_mode",value:B,onChange:t=>L(t.target.value),children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"online",children:"Online"}),e.jsx("option",{value:"bank_transfer",children:"Bank Transfer"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"payment_notes",children:"Notes:"}),e.jsx("textarea",{id:"payment_notes",value:$,onChange:t=>R(t.target.value),placeholder:"e.g., Partial payment via cash"})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",onClick:P,className:"button-cancel",children:"Cancel"}),e.jsx("button",{type:"submit",className:"button-submit",children:"Record Payment"})]})]})]})})]})};export{ye as default};
