import{f as g,j as e,M as y,o as N}from"./index-CRA8Xzko.js";import{j as A,u as L,r as o,L as f}from"./react-vendor-Cc0P4_ZX.js";/* empty css                        *//* empty css                           */import{h as C}from"./whatsappUtils-DTYJAZi5.js";import{i as E,W as I,ad as z,ao as $,E as F,a7 as O,v as T}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const K=()=>{const{orderId:l}=A(),v=L(),[t,h]=o.useState(null),[c,m]=o.useState(!0),[d,p]=o.useState(null),[j,w]=o.useState(""),x=o.useCallback(async i=>{if(!i){p("No Order ID specified in the URL."),m(!1),h(null);return}m(!0),p(null),h(null);try{console.log(`Fetching order details for ID: ${i}`);const s=await g(`/api/lab/orders/${i}/report`);if(!s.ok){let n;try{n=await s.json()}catch{n={message:`Server returned status ${s.status}`}}throw console.error("Fetch order details error response:",n),new Error(n.message||`Failed to fetch order details: ${s.status}`)}const a=await s.json();if(console.log("Received order data:",a),!a)throw console.error("Invalid order data structure:",a),new Error("Invalid order data received from server.");h(a)}catch(s){console.error("Error fetching order details:",s),p(s instanceof Error?s.message:"An unknown error occurred while fetching the order details")}finally{m(!1)}},[g]);o.useEffect(()=>{x(l)},[l,x]),o.useEffect(()=>{(async()=>{try{const s=await g("/api/clinics/settings");if(s.ok){const a=await s.json();w(a.labLetterheadUrl||"")}}catch(s){console.error("Error fetching clinic settings:",s)}})()},[]);const P=()=>{t&&C(t)};return e.jsx("div",{className:"lab-inventory-container",children:e.jsxs("div",{className:"lab-inventory-card",children:[e.jsxs("div",{className:"lab-inventory-header no-print",style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:0,paddingBottom:0,borderBottom:"none"},children:[e.jsx("h2",{style:{margin:0,fontSize:"1.5em"},children:"Lab Report Viewer"})," ",e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[e.jsxs(f,{to:"/lab/search-report",className:"lab-inventory-button","aria-label":"Search for other reports",children:[e.jsx(E,{size:16,style:{marginRight:"5px"}}),"Search Reports"]}),e.jsx("button",{onClick:()=>v(-1),className:"lab-inventory-button lab-inventory-button-secondary","aria-label":"Go back",children:e.jsx(I,{size:16})}),e.jsxs("button",{onClick:()=>window.print(),className:"lab-inventory-button","aria-label":"Print report",children:[e.jsx(z,{size:16,style:{marginRight:"5px"}}),"Print"]}),e.jsxs("button",{onClick:P,className:"lab-inventory-button","aria-label":"Share report via WhatsApp",style:{backgroundColor:"#25D366",borderColor:"#25D366",color:"white"},children:[e.jsx($,{size:16,style:{marginRight:"5px"}}),"WhatsApp"]})]})]}),e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsxs("h3",{className:"lab-inventory-header",children:["Report Details (Order ID: ",l||"None Specified",")"]}),c&&e.jsx("div",{className:"loading-text",children:"Loading report..."}),d&&!c&&e.jsxs("div",{className:"error-message-container",style:{textAlign:"center"},children:[e.jsx(F,{size:48}),e.jsx("h3",{className:"error-title",children:"Error Loading Report"}),e.jsx("p",{children:d}),l&&e.jsx("button",{onClick:()=>x(l),className:"retry-button",children:"Retry"})]}),e.jsxs("div",{className:"printable-section",children:[j&&e.jsx("div",{className:"print-only print-letterhead-container",children:e.jsx("img",{src:j,alt:"Lab Letterhead",className:"print-letterhead-image"})}),!c&&!d&&(t==null?void 0:t.Patient)&&e.jsxs("div",{className:"lab-inventory-card",style:{marginBottom:"20px"},children:[e.jsxs("h3",{className:"lab-inventory-header",children:[e.jsx(O,{size:16,style:{marginRight:"8px",verticalAlign:"middle"}})," Patient Information"]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"10px",fontSize:"0.9em"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Name:"})," ",t.Patient.name||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Age:"})," ",t.Patient.age??"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Gender:"})," ",t.Patient.gender||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Token No:"})," ",t.Patient.patient_token_number||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Patient ID:"})," ",t.Patient.id]}),t.Patient.phone&&e.jsxs("div",{children:[e.jsx("strong",{children:"Phone:"})," ",t.Patient.phone]})]})]}),!c&&!d&&(t==null?void 0:t.report_content)&&e.jsxs("div",{className:"lab-inventory-card",children:[e.jsxs("h3",{className:"lab-inventory-header",children:[e.jsx(T,{size:16,style:{marginRight:"8px",verticalAlign:"middle"}})," Report Findings"]}),e.jsx("div",{className:"report-markdown-content",style:{fontSize:"1em",lineHeight:"1.6"},children:(()=>{try{const i=JSON.parse(t.report_content||"{}");return typeof i=="object"&&i!==null&&t.tests?t.tests.map(s=>e.jsxs("div",{style:{marginBottom:"20px"},children:[e.jsx("h4",{className:"lab-inventory-header",style:{fontSize:"1.1em"},children:s.name}),i[s.id]?e.jsxs("table",{className:"lab-inventory-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Parameter"}),e.jsx("th",{children:"Value"}),e.jsx("th",{children:"Normal Range"})]})}),e.jsx("tbody",{children:Object.entries(i[s.id]).map(([a,n])=>{var b;const r=(b=s.default_parameters)==null?void 0:b.find(k=>k.name===a),u=typeof n=="string"?parseFloat(n):typeof n=="number"?n:NaN,S=(r==null?void 0:r.type)==="number"&&!isNaN(u)&&(r.lower_limit!=null&&u<r.lower_limit||r.upper_limit!=null&&u>r.upper_limit),R=(r==null?void 0:r.type)==="boolean"?n===!0||n==="true"?"Reactive":"Non-Reactive":String(n),_=(r==null?void 0:r.type)==="boolean"&&(n===!0||n==="true");return e.jsxs("tr",{children:[e.jsx("td",{children:a}),e.jsxs("td",{className:`${S?"abnormal-result":""} ${_?"reactive-result":""}`,children:[R," ",r==null?void 0:r.unit]}),e.jsx("td",{children:r&&r.type==="number"&&(r.lower_limit!==null||r.upper_limit!==null)?e.jsxs(e.Fragment,{children:[r.lower_limit!=null&&` > ${r.lower_limit}`,r.lower_limit!=null&&r.upper_limit!=null&&" - ",r.upper_limit!=null&&` < ${r.upper_limit}`,r.unit&&` ${r.unit}`]}):((r==null?void 0:r.type)==="boolean","N/A")})]},a)})})]}):e.jsx("p",{children:"No parameters reported for this test."})]},s.id)):e.jsx(y,{remarkPlugins:[N],children:t.report_content})}catch{return e.jsx(y,{remarkPlugins:[N],children:t.report_content||"*No findings recorded.*"})}})()})]})]}),!c&&!d&&!(t!=null&&t.report_content)&&!(t!=null&&t.Patient)&&l&&e.jsxs("div",{className:"no-data-message",children:["No report content or patient details found for Order ID: ",l,". The order might be processing, does not exist, or the ID is incorrect."]}),!l&&!c&&!d&&e.jsxs("div",{className:"no-data-message",children:["No order ID specified in the URL.",e.jsx(f,{to:"/lab/search-report",className:"lab-inventory-link",style:{display:"block",marginTop:"10px"},children:"Go to Search Page"})]})]})]})})};export{K as default};
