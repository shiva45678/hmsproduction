import{c as dc,g as pc,R as Pi,r as x,j as i,S as Te,P as gt,d as Rn,T as yt,e as Xs,a as eo,F as to,X as gn,f as Y,G as hc,h as mc,i as $t,C as no,k as Nr,l as xr,m as ro,H as io,Q as ao,n as so,M as Gt,o as _t,p as oo,q as pt,s as fc,t as gc,u as yc,v as xc,w as bc,x as ci,D as ls,y as cs,E as wc,z as us,B as ds,I as kc,J as _c,L as Nc,A as vc,K as jc,N as Cc,O as Sc,V as Tc,W as Pc,Y as Ec,Z as Ac,_ as Dc,$ as Ic,a0 as $c}from"./index-G6ieET9N.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oc=[["path",{d:"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z",key:"3c2336"}],["path",{d:"M8 8h8",key:"1bis0t"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"m13 17-5-1h1a4 4 0 0 0 0-8",key:"nu2bwa"}]],lo=dc("badge-indian-rupee",Oc),Lc={};function Mi(e,n){const t=Lc,r=typeof t.includeImageAlt=="boolean"?t.includeImageAlt:!0,s=typeof t.includeHtml=="boolean"?t.includeHtml:!0;return co(e,r,s)}function co(e,n,t){if(Rc(e)){if("value"in e)return e.type==="html"&&!t?"":e.value;if(n&&"alt"in e&&e.alt)return e.alt;if("children"in e)return ps(e.children,n,t)}return Array.isArray(e)?ps(e,n,t):""}function ps(e,n,t){const r=[];let s=-1;for(;++s<e.length;)r[s]=co(e[s],n,t);return r.join("")}function Rc(e){return!!(e&&typeof e=="object")}const hs=document.createElement("i");function Hi(e){const n="&"+e+";";hs.innerHTML=n;const t=hs.textContent;return t.charCodeAt(t.length-1)===59&&e!=="semi"||t===n?!1:t}function jt(e,n,t,r){const s=e.length;let a=0,o;if(n<0?n=-n>s?0:s+n:n=n>s?s:n,t=t>0?t:0,r.length<1e4)o=Array.from(r),o.unshift(n,t),e.splice(...o);else for(t&&e.splice(n,t);a<r.length;)o=r.slice(a,a+1e4),o.unshift(n,0),e.splice(...o),a+=1e4,n+=1e4}function ht(e,n){return e.length>0?(jt(e,e.length,0,n),e):n}const ms={}.hasOwnProperty;function Fc(e){const n={};let t=-1;for(;++t<e.length;)zc(n,e[t]);return n}function zc(e,n){let t;for(t in n){const s=(ms.call(e,t)?e[t]:void 0)||(e[t]={}),a=n[t];let o;if(a)for(o in a){ms.call(s,o)||(s[o]=[]);const l=a[o];qc(s[o],Array.isArray(l)?l:l?[l]:[])}}}function qc(e,n){let t=-1;const r=[];for(;++t<n.length;)(n[t].add==="after"?e:r).push(n[t]);jt(e,0,0,r)}function uo(e,n){const t=Number.parseInt(e,n);return t<9||t===11||t>13&&t<32||t>126&&t<160||t>55295&&t<57344||t>64975&&t<65008||(t&65535)===65535||(t&65535)===65534||t>1114111?"�":String.fromCodePoint(t)}function hn(e){return e.replace(/[\t\n\r ]+/g," ").replace(/^ | $/g,"").toLowerCase().toUpperCase()}const vt=Mt(/[A-Za-z]/),at=Mt(/[\dA-Za-z]/),Bc=Mt(/[#-'*+\--9=?A-Z^-~]/);function Ei(e){return e!==null&&(e<32||e===127)}const Ai=Mt(/\d/),Uc=Mt(/[\dA-Fa-f]/),Mc=Mt(/[!-/:-@[-`{-~]/);function ge(e){return e!==null&&e<-2}function Ze(e){return e!==null&&(e<0||e===32)}function Pe(e){return e===-2||e===-1||e===32}const Hc=Mt(new RegExp("\\p{P}|\\p{S}","u")),Wc=Mt(/\s/);function Mt(e){return n;function n(t){return t!==null&&t>-1&&e.test(String.fromCharCode(t))}}function yn(e){const n=[];let t=-1,r=0,s=0;for(;++t<e.length;){const a=e.charCodeAt(t);let o="";if(a===37&&at(e.charCodeAt(t+1))&&at(e.charCodeAt(t+2)))s=2;else if(a<128)/[!#$&-;=?-Z_a-z~]/.test(String.fromCharCode(a))||(o=String.fromCharCode(a));else if(a>55295&&a<57344){const l=e.charCodeAt(t+1);a<56320&&l>56319&&l<57344?(o=String.fromCharCode(a,l),s=1):o="�"}else o=String.fromCharCode(a);o&&(n.push(e.slice(r,t),encodeURIComponent(o)),r=t+s+1,o=""),s&&(t+=s,s=0)}return n.join("")+e.slice(r)}function Oe(e,n,t,r){const s=r?r-1:Number.POSITIVE_INFINITY;let a=0;return o;function o(c){return Pe(c)?(e.enter(t),l(c)):n(c)}function l(c){return Pe(c)&&a++<s?(e.consume(c),l):(e.exit(t),n(c))}}const Vc={tokenize:Jc};function Jc(e){const n=e.attempt(this.parser.constructs.contentInitial,r,s);let t;return n;function r(l){if(l===null){e.consume(l);return}return e.enter("lineEnding"),e.consume(l),e.exit("lineEnding"),Oe(e,n,"linePrefix")}function s(l){return e.enter("paragraph"),a(l)}function a(l){const c=e.enter("chunkText",{contentType:"text",previous:t});return t&&(t.next=c),t=c,o(l)}function o(l){if(l===null){e.exit("chunkText"),e.exit("paragraph"),e.consume(l);return}return ge(l)?(e.consume(l),e.exit("chunkText"),a):(e.consume(l),o)}}const Qc={tokenize:Gc},fs={tokenize:Yc};function Gc(e){const n=this,t=[];let r=0,s,a,o;return l;function l(I){if(r<t.length){const W=t[r];return n.containerState=W[1],e.attempt(W[0].continuation,c,u)(I)}return u(I)}function c(I){if(r++,n.containerState._closeFlow){n.containerState._closeFlow=void 0,s&&B();const W=n.events.length;let F=W,j;for(;F--;)if(n.events[F][0]==="exit"&&n.events[F][1].type==="chunkFlow"){j=n.events[F][1].end;break}O(r);let X=W;for(;X<n.events.length;)n.events[X][1].end={...j},X++;return jt(n.events,F+1,0,n.events.slice(W)),n.events.length=X,u(I)}return l(I)}function u(I){if(r===t.length){if(!s)return y(I);if(s.currentConstruct&&s.currentConstruct.concrete)return E(I);n.interrupt=!!(s.currentConstruct&&!s._gfmTableDynamicInterruptHack)}return n.containerState={},e.check(fs,m,d)(I)}function m(I){return s&&B(),O(r),y(I)}function d(I){return n.parser.lazy[n.now().line]=r!==t.length,o=n.now().offset,E(I)}function y(I){return n.containerState={},e.attempt(fs,p,E)(I)}function p(I){return r++,t.push([n.currentConstruct,n.containerState]),y(I)}function E(I){if(I===null){s&&B(),O(0),e.consume(I);return}return s=s||n.parser.flow(n.now()),e.enter("chunkFlow",{_tokenizer:s,contentType:"flow",previous:a}),q(I)}function q(I){if(I===null){G(e.exit("chunkFlow"),!0),O(0),e.consume(I);return}return ge(I)?(e.consume(I),G(e.exit("chunkFlow")),r=0,n.interrupt=void 0,l):(e.consume(I),q)}function G(I,W){const F=n.sliceStream(I);if(W&&F.push(null),I.previous=a,a&&(a.next=I),a=I,s.defineSkip(I.start),s.write(F),n.parser.lazy[I.start.line]){let j=s.events.length;for(;j--;)if(s.events[j][1].start.offset<o&&(!s.events[j][1].end||s.events[j][1].end.offset>o))return;const X=n.events.length;let le=X,ne,oe;for(;le--;)if(n.events[le][0]==="exit"&&n.events[le][1].type==="chunkFlow"){if(ne){oe=n.events[le][1].end;break}ne=!0}for(O(r),j=X;j<n.events.length;)n.events[j][1].end={...oe},j++;jt(n.events,le+1,0,n.events.slice(X)),n.events.length=j}}function O(I){let W=t.length;for(;W-- >I;){const F=t[W];n.containerState=F[1],F[0].exit.call(n,e)}t.length=I}function B(){s.write([null]),a=void 0,s=void 0,n.containerState._closeFlow=void 0}}function Yc(e,n,t){return Oe(e,e.attempt(this.parser.constructs.document,n,t),"linePrefix",this.parser.constructs.disable.null.includes("codeIndented")?void 0:4)}function wr(e){if(e===null||Ze(e)||Wc(e))return 1;if(Hc(e))return 2}function Wi(e,n,t){const r=[];let s=-1;for(;++s<e.length;){const a=e[s].resolveAll;a&&!r.includes(a)&&(n=a(n,t),r.push(a))}return n}const Di={name:"attention",resolveAll:Kc,tokenize:Zc};function Kc(e,n){let t=-1,r,s,a,o,l,c,u,m;for(;++t<e.length;)if(e[t][0]==="enter"&&e[t][1].type==="attentionSequence"&&e[t][1]._close){for(r=t;r--;)if(e[r][0]==="exit"&&e[r][1].type==="attentionSequence"&&e[r][1]._open&&n.sliceSerialize(e[r][1]).charCodeAt(0)===n.sliceSerialize(e[t][1]).charCodeAt(0)){if((e[r][1]._close||e[t][1]._open)&&(e[t][1].end.offset-e[t][1].start.offset)%3&&!((e[r][1].end.offset-e[r][1].start.offset+e[t][1].end.offset-e[t][1].start.offset)%3))continue;c=e[r][1].end.offset-e[r][1].start.offset>1&&e[t][1].end.offset-e[t][1].start.offset>1?2:1;const d={...e[r][1].end},y={...e[t][1].start};gs(d,-c),gs(y,c),o={type:c>1?"strongSequence":"emphasisSequence",start:d,end:{...e[r][1].end}},l={type:c>1?"strongSequence":"emphasisSequence",start:{...e[t][1].start},end:y},a={type:c>1?"strongText":"emphasisText",start:{...e[r][1].end},end:{...e[t][1].start}},s={type:c>1?"strong":"emphasis",start:{...o.start},end:{...l.end}},e[r][1].end={...o.start},e[t][1].start={...l.end},u=[],e[r][1].end.offset-e[r][1].start.offset&&(u=ht(u,[["enter",e[r][1],n],["exit",e[r][1],n]])),u=ht(u,[["enter",s,n],["enter",o,n],["exit",o,n],["enter",a,n]]),u=ht(u,Wi(n.parser.constructs.insideSpan.null,e.slice(r+1,t),n)),u=ht(u,[["exit",a,n],["enter",l,n],["exit",l,n],["exit",s,n]]),e[t][1].end.offset-e[t][1].start.offset?(m=2,u=ht(u,[["enter",e[t][1],n],["exit",e[t][1],n]])):m=0,jt(e,r-1,t-r+3,u),t=r+u.length-m-2;break}}for(t=-1;++t<e.length;)e[t][1].type==="attentionSequence"&&(e[t][1].type="data");return e}function Zc(e,n){const t=this.parser.constructs.attentionMarkers.null,r=this.previous,s=wr(r);let a;return o;function o(c){return a=c,e.enter("attentionSequence"),l(c)}function l(c){if(c===a)return e.consume(c),l;const u=e.exit("attentionSequence"),m=wr(c),d=!m||m===2&&s||t.includes(c),y=!s||s===2&&m||t.includes(r);return u._open=!!(a===42?d:d&&(s||!y)),u._close=!!(a===42?y:y&&(m||!d)),n(c)}}function gs(e,n){e.column+=n,e.offset+=n,e._bufferIndex+=n}const Xc={name:"autolink",tokenize:eu};function eu(e,n,t){let r=0;return s;function s(p){return e.enter("autolink"),e.enter("autolinkMarker"),e.consume(p),e.exit("autolinkMarker"),e.enter("autolinkProtocol"),a}function a(p){return vt(p)?(e.consume(p),o):p===64?t(p):u(p)}function o(p){return p===43||p===45||p===46||at(p)?(r=1,l(p)):u(p)}function l(p){return p===58?(e.consume(p),r=0,c):(p===43||p===45||p===46||at(p))&&r++<32?(e.consume(p),l):(r=0,u(p))}function c(p){return p===62?(e.exit("autolinkProtocol"),e.enter("autolinkMarker"),e.consume(p),e.exit("autolinkMarker"),e.exit("autolink"),n):p===null||p===32||p===60||Ei(p)?t(p):(e.consume(p),c)}function u(p){return p===64?(e.consume(p),m):Bc(p)?(e.consume(p),u):t(p)}function m(p){return at(p)?d(p):t(p)}function d(p){return p===46?(e.consume(p),r=0,m):p===62?(e.exit("autolinkProtocol").type="autolinkEmail",e.enter("autolinkMarker"),e.consume(p),e.exit("autolinkMarker"),e.exit("autolink"),n):y(p)}function y(p){if((p===45||at(p))&&r++<63){const E=p===45?y:d;return e.consume(p),E}return t(p)}}const vr={partial:!0,tokenize:tu};function tu(e,n,t){return r;function r(a){return Pe(a)?Oe(e,s,"linePrefix")(a):s(a)}function s(a){return a===null||ge(a)?n(a):t(a)}}const po={continuation:{tokenize:ru},exit:iu,name:"blockQuote",tokenize:nu};function nu(e,n,t){const r=this;return s;function s(o){if(o===62){const l=r.containerState;return l.open||(e.enter("blockQuote",{_container:!0}),l.open=!0),e.enter("blockQuotePrefix"),e.enter("blockQuoteMarker"),e.consume(o),e.exit("blockQuoteMarker"),a}return t(o)}function a(o){return Pe(o)?(e.enter("blockQuotePrefixWhitespace"),e.consume(o),e.exit("blockQuotePrefixWhitespace"),e.exit("blockQuotePrefix"),n):(e.exit("blockQuotePrefix"),n(o))}}function ru(e,n,t){const r=this;return s;function s(o){return Pe(o)?Oe(e,a,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(o):a(o)}function a(o){return e.attempt(po,n,t)(o)}}function iu(e){e.exit("blockQuote")}const ho={name:"characterEscape",tokenize:au};function au(e,n,t){return r;function r(a){return e.enter("characterEscape"),e.enter("escapeMarker"),e.consume(a),e.exit("escapeMarker"),s}function s(a){return Mc(a)?(e.enter("characterEscapeValue"),e.consume(a),e.exit("characterEscapeValue"),e.exit("characterEscape"),n):t(a)}}const mo={name:"characterReference",tokenize:su};function su(e,n,t){const r=this;let s=0,a,o;return l;function l(d){return e.enter("characterReference"),e.enter("characterReferenceMarker"),e.consume(d),e.exit("characterReferenceMarker"),c}function c(d){return d===35?(e.enter("characterReferenceMarkerNumeric"),e.consume(d),e.exit("characterReferenceMarkerNumeric"),u):(e.enter("characterReferenceValue"),a=31,o=at,m(d))}function u(d){return d===88||d===120?(e.enter("characterReferenceMarkerHexadecimal"),e.consume(d),e.exit("characterReferenceMarkerHexadecimal"),e.enter("characterReferenceValue"),a=6,o=Uc,m):(e.enter("characterReferenceValue"),a=7,o=Ai,m(d))}function m(d){if(d===59&&s){const y=e.exit("characterReferenceValue");return o===at&&!Hi(r.sliceSerialize(y))?t(d):(e.enter("characterReferenceMarker"),e.consume(d),e.exit("characterReferenceMarker"),e.exit("characterReference"),n)}return o(d)&&s++<a?(e.consume(d),m):t(d)}}const ys={partial:!0,tokenize:lu},xs={concrete:!0,name:"codeFenced",tokenize:ou};function ou(e,n,t){const r=this,s={partial:!0,tokenize:F};let a=0,o=0,l;return c;function c(j){return u(j)}function u(j){const X=r.events[r.events.length-1];return a=X&&X[1].type==="linePrefix"?X[2].sliceSerialize(X[1],!0).length:0,l=j,e.enter("codeFenced"),e.enter("codeFencedFence"),e.enter("codeFencedFenceSequence"),m(j)}function m(j){return j===l?(o++,e.consume(j),m):o<3?t(j):(e.exit("codeFencedFenceSequence"),Pe(j)?Oe(e,d,"whitespace")(j):d(j))}function d(j){return j===null||ge(j)?(e.exit("codeFencedFence"),r.interrupt?n(j):e.check(ys,q,W)(j)):(e.enter("codeFencedFenceInfo"),e.enter("chunkString",{contentType:"string"}),y(j))}function y(j){return j===null||ge(j)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),d(j)):Pe(j)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),Oe(e,p,"whitespace")(j)):j===96&&j===l?t(j):(e.consume(j),y)}function p(j){return j===null||ge(j)?d(j):(e.enter("codeFencedFenceMeta"),e.enter("chunkString",{contentType:"string"}),E(j))}function E(j){return j===null||ge(j)?(e.exit("chunkString"),e.exit("codeFencedFenceMeta"),d(j)):j===96&&j===l?t(j):(e.consume(j),E)}function q(j){return e.attempt(s,W,G)(j)}function G(j){return e.enter("lineEnding"),e.consume(j),e.exit("lineEnding"),O}function O(j){return a>0&&Pe(j)?Oe(e,B,"linePrefix",a+1)(j):B(j)}function B(j){return j===null||ge(j)?e.check(ys,q,W)(j):(e.enter("codeFlowValue"),I(j))}function I(j){return j===null||ge(j)?(e.exit("codeFlowValue"),B(j)):(e.consume(j),I)}function W(j){return e.exit("codeFenced"),n(j)}function F(j,X,le){let ne=0;return oe;function oe(A){return j.enter("lineEnding"),j.consume(A),j.exit("lineEnding"),V}function V(A){return j.enter("codeFencedFence"),Pe(A)?Oe(j,_,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(A):_(A)}function _(A){return A===l?(j.enter("codeFencedFenceSequence"),C(A)):le(A)}function C(A){return A===l?(ne++,j.consume(A),C):ne>=o?(j.exit("codeFencedFenceSequence"),Pe(A)?Oe(j,K,"whitespace")(A):K(A)):le(A)}function K(A){return A===null||ge(A)?(j.exit("codeFencedFence"),X(A)):le(A)}}}function lu(e,n,t){const r=this;return s;function s(o){return o===null?t(o):(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),a)}function a(o){return r.parser.lazy[r.now().line]?t(o):n(o)}}const ui={name:"codeIndented",tokenize:uu},cu={partial:!0,tokenize:du};function uu(e,n,t){const r=this;return s;function s(u){return e.enter("codeIndented"),Oe(e,a,"linePrefix",5)(u)}function a(u){const m=r.events[r.events.length-1];return m&&m[1].type==="linePrefix"&&m[2].sliceSerialize(m[1],!0).length>=4?o(u):t(u)}function o(u){return u===null?c(u):ge(u)?e.attempt(cu,o,c)(u):(e.enter("codeFlowValue"),l(u))}function l(u){return u===null||ge(u)?(e.exit("codeFlowValue"),o(u)):(e.consume(u),l)}function c(u){return e.exit("codeIndented"),n(u)}}function du(e,n,t){const r=this;return s;function s(o){return r.parser.lazy[r.now().line]?t(o):ge(o)?(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),s):Oe(e,a,"linePrefix",5)(o)}function a(o){const l=r.events[r.events.length-1];return l&&l[1].type==="linePrefix"&&l[2].sliceSerialize(l[1],!0).length>=4?n(o):ge(o)?s(o):t(o)}}const pu={name:"codeText",previous:mu,resolve:hu,tokenize:fu};function hu(e){let n=e.length-4,t=3,r,s;if((e[t][1].type==="lineEnding"||e[t][1].type==="space")&&(e[n][1].type==="lineEnding"||e[n][1].type==="space")){for(r=t;++r<n;)if(e[r][1].type==="codeTextData"){e[t][1].type="codeTextPadding",e[n][1].type="codeTextPadding",t+=2,n-=2;break}}for(r=t-1,n++;++r<=n;)s===void 0?r!==n&&e[r][1].type!=="lineEnding"&&(s=r):(r===n||e[r][1].type==="lineEnding")&&(e[s][1].type="codeTextData",r!==s+2&&(e[s][1].end=e[r-1][1].end,e.splice(s+2,r-s-2),n-=r-s-2,r=s+2),s=void 0);return e}function mu(e){return e!==96||this.events[this.events.length-1][1].type==="characterEscape"}function fu(e,n,t){let r=0,s,a;return o;function o(d){return e.enter("codeText"),e.enter("codeTextSequence"),l(d)}function l(d){return d===96?(e.consume(d),r++,l):(e.exit("codeTextSequence"),c(d))}function c(d){return d===null?t(d):d===32?(e.enter("space"),e.consume(d),e.exit("space"),c):d===96?(a=e.enter("codeTextSequence"),s=0,m(d)):ge(d)?(e.enter("lineEnding"),e.consume(d),e.exit("lineEnding"),c):(e.enter("codeTextData"),u(d))}function u(d){return d===null||d===32||d===96||ge(d)?(e.exit("codeTextData"),c(d)):(e.consume(d),u)}function m(d){return d===96?(e.consume(d),s++,m):s===r?(e.exit("codeTextSequence"),e.exit("codeText"),n(d)):(a.type="codeTextData",u(d))}}class gu{constructor(n){this.left=n?[...n]:[],this.right=[]}get(n){if(n<0||n>=this.left.length+this.right.length)throw new RangeError("Cannot access index `"+n+"` in a splice buffer of size `"+(this.left.length+this.right.length)+"`");return n<this.left.length?this.left[n]:this.right[this.right.length-n+this.left.length-1]}get length(){return this.left.length+this.right.length}shift(){return this.setCursor(0),this.right.pop()}slice(n,t){const r=t??Number.POSITIVE_INFINITY;return r<this.left.length?this.left.slice(n,r):n>this.left.length?this.right.slice(this.right.length-r+this.left.length,this.right.length-n+this.left.length).reverse():this.left.slice(n).concat(this.right.slice(this.right.length-r+this.left.length).reverse())}splice(n,t,r){const s=t||0;this.setCursor(Math.trunc(n));const a=this.right.splice(this.right.length-s,Number.POSITIVE_INFINITY);return r&&On(this.left,r),a.reverse()}pop(){return this.setCursor(Number.POSITIVE_INFINITY),this.left.pop()}push(n){this.setCursor(Number.POSITIVE_INFINITY),this.left.push(n)}pushMany(n){this.setCursor(Number.POSITIVE_INFINITY),On(this.left,n)}unshift(n){this.setCursor(0),this.right.push(n)}unshiftMany(n){this.setCursor(0),On(this.right,n.reverse())}setCursor(n){if(!(n===this.left.length||n>this.left.length&&this.right.length===0||n<0&&this.left.length===0))if(n<this.left.length){const t=this.left.splice(n,Number.POSITIVE_INFINITY);On(this.right,t.reverse())}else{const t=this.right.splice(this.left.length+this.right.length-n,Number.POSITIVE_INFINITY);On(this.left,t.reverse())}}}function On(e,n){let t=0;if(n.length<1e4)e.push(...n);else for(;t<n.length;)e.push(...n.slice(t,t+1e4)),t+=1e4}function fo(e){const n={};let t=-1,r,s,a,o,l,c,u;const m=new gu(e);for(;++t<m.length;){for(;t in n;)t=n[t];if(r=m.get(t),t&&r[1].type==="chunkFlow"&&m.get(t-1)[1].type==="listItemPrefix"&&(c=r[1]._tokenizer.events,a=0,a<c.length&&c[a][1].type==="lineEndingBlank"&&(a+=2),a<c.length&&c[a][1].type==="content"))for(;++a<c.length&&c[a][1].type!=="content";)c[a][1].type==="chunkText"&&(c[a][1]._isInFirstContentOfListItem=!0,a++);if(r[0]==="enter")r[1].contentType&&(Object.assign(n,yu(m,t)),t=n[t],u=!0);else if(r[1]._container){for(a=t,s=void 0;a--;)if(o=m.get(a),o[1].type==="lineEnding"||o[1].type==="lineEndingBlank")o[0]==="enter"&&(s&&(m.get(s)[1].type="lineEndingBlank"),o[1].type="lineEnding",s=a);else if(!(o[1].type==="linePrefix"||o[1].type==="listItemIndent"))break;s&&(r[1].end={...m.get(s)[1].start},l=m.slice(s,t),l.unshift(r),m.splice(s,t-s+1,l))}}return jt(e,0,Number.POSITIVE_INFINITY,m.slice(0)),!u}function yu(e,n){const t=e.get(n)[1],r=e.get(n)[2];let s=n-1;const a=[];let o=t._tokenizer;o||(o=r.parser[t.contentType](t.start),t._contentTypeTextTrailing&&(o._contentTypeTextTrailing=!0));const l=o.events,c=[],u={};let m,d,y=-1,p=t,E=0,q=0;const G=[q];for(;p;){for(;e.get(++s)[1]!==p;);a.push(s),p._tokenizer||(m=r.sliceStream(p),p.next||m.push(null),d&&o.defineSkip(p.start),p._isInFirstContentOfListItem&&(o._gfmTasklistFirstContentOfListItem=!0),o.write(m),p._isInFirstContentOfListItem&&(o._gfmTasklistFirstContentOfListItem=void 0)),d=p,p=p.next}for(p=t;++y<l.length;)l[y][0]==="exit"&&l[y-1][0]==="enter"&&l[y][1].type===l[y-1][1].type&&l[y][1].start.line!==l[y][1].end.line&&(q=y+1,G.push(q),p._tokenizer=void 0,p.previous=void 0,p=p.next);for(o.events=[],p?(p._tokenizer=void 0,p.previous=void 0):G.pop(),y=G.length;y--;){const O=l.slice(G[y],G[y+1]),B=a.pop();c.push([B,B+O.length-1]),e.splice(B,2,O)}for(c.reverse(),y=-1;++y<c.length;)u[E+c[y][0]]=E+c[y][1],E+=c[y][1]-c[y][0]-1;return u}const xu={resolve:wu,tokenize:ku},bu={partial:!0,tokenize:_u};function wu(e){return fo(e),e}function ku(e,n){let t;return r;function r(l){return e.enter("content"),t=e.enter("chunkContent",{contentType:"content"}),s(l)}function s(l){return l===null?a(l):ge(l)?e.check(bu,o,a)(l):(e.consume(l),s)}function a(l){return e.exit("chunkContent"),e.exit("content"),n(l)}function o(l){return e.consume(l),e.exit("chunkContent"),t.next=e.enter("chunkContent",{contentType:"content",previous:t}),t=t.next,s}}function _u(e,n,t){const r=this;return s;function s(o){return e.exit("chunkContent"),e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),Oe(e,a,"linePrefix")}function a(o){if(o===null||ge(o))return t(o);const l=r.events[r.events.length-1];return!r.parser.constructs.disable.null.includes("codeIndented")&&l&&l[1].type==="linePrefix"&&l[2].sliceSerialize(l[1],!0).length>=4?n(o):e.interrupt(r.parser.constructs.flow,t,n)(o)}}function go(e,n,t,r,s,a,o,l,c){const u=c||Number.POSITIVE_INFINITY;let m=0;return d;function d(O){return O===60?(e.enter(r),e.enter(s),e.enter(a),e.consume(O),e.exit(a),y):O===null||O===32||O===41||Ei(O)?t(O):(e.enter(r),e.enter(o),e.enter(l),e.enter("chunkString",{contentType:"string"}),q(O))}function y(O){return O===62?(e.enter(a),e.consume(O),e.exit(a),e.exit(s),e.exit(r),n):(e.enter(l),e.enter("chunkString",{contentType:"string"}),p(O))}function p(O){return O===62?(e.exit("chunkString"),e.exit(l),y(O)):O===null||O===60||ge(O)?t(O):(e.consume(O),O===92?E:p)}function E(O){return O===60||O===62||O===92?(e.consume(O),p):p(O)}function q(O){return!m&&(O===null||O===41||Ze(O))?(e.exit("chunkString"),e.exit(l),e.exit(o),e.exit(r),n(O)):m<u&&O===40?(e.consume(O),m++,q):O===41?(e.consume(O),m--,q):O===null||O===32||O===40||Ei(O)?t(O):(e.consume(O),O===92?G:q)}function G(O){return O===40||O===41||O===92?(e.consume(O),q):q(O)}}function yo(e,n,t,r,s,a){const o=this;let l=0,c;return u;function u(p){return e.enter(r),e.enter(s),e.consume(p),e.exit(s),e.enter(a),m}function m(p){return l>999||p===null||p===91||p===93&&!c||p===94&&!l&&"_hiddenFootnoteSupport"in o.parser.constructs?t(p):p===93?(e.exit(a),e.enter(s),e.consume(p),e.exit(s),e.exit(r),n):ge(p)?(e.enter("lineEnding"),e.consume(p),e.exit("lineEnding"),m):(e.enter("chunkString",{contentType:"string"}),d(p))}function d(p){return p===null||p===91||p===93||ge(p)||l++>999?(e.exit("chunkString"),m(p)):(e.consume(p),c||(c=!Pe(p)),p===92?y:d)}function y(p){return p===91||p===92||p===93?(e.consume(p),l++,d):d(p)}}function xo(e,n,t,r,s,a){let o;return l;function l(y){return y===34||y===39||y===40?(e.enter(r),e.enter(s),e.consume(y),e.exit(s),o=y===40?41:y,c):t(y)}function c(y){return y===o?(e.enter(s),e.consume(y),e.exit(s),e.exit(r),n):(e.enter(a),u(y))}function u(y){return y===o?(e.exit(a),c(o)):y===null?t(y):ge(y)?(e.enter("lineEnding"),e.consume(y),e.exit("lineEnding"),Oe(e,u,"linePrefix")):(e.enter("chunkString",{contentType:"string"}),m(y))}function m(y){return y===o||y===null||ge(y)?(e.exit("chunkString"),u(y)):(e.consume(y),y===92?d:m)}function d(y){return y===o||y===92?(e.consume(y),m):m(y)}}function Fn(e,n){let t;return r;function r(s){return ge(s)?(e.enter("lineEnding"),e.consume(s),e.exit("lineEnding"),t=!0,r):Pe(s)?Oe(e,r,t?"linePrefix":"lineSuffix")(s):n(s)}}const Nu={name:"definition",tokenize:ju},vu={partial:!0,tokenize:Cu};function ju(e,n,t){const r=this;let s;return a;function a(p){return e.enter("definition"),o(p)}function o(p){return yo.call(r,e,l,t,"definitionLabel","definitionLabelMarker","definitionLabelString")(p)}function l(p){return s=hn(r.sliceSerialize(r.events[r.events.length-1][1]).slice(1,-1)),p===58?(e.enter("definitionMarker"),e.consume(p),e.exit("definitionMarker"),c):t(p)}function c(p){return Ze(p)?Fn(e,u)(p):u(p)}function u(p){return go(e,m,t,"definitionDestination","definitionDestinationLiteral","definitionDestinationLiteralMarker","definitionDestinationRaw","definitionDestinationString")(p)}function m(p){return e.attempt(vu,d,d)(p)}function d(p){return Pe(p)?Oe(e,y,"whitespace")(p):y(p)}function y(p){return p===null||ge(p)?(e.exit("definition"),r.parser.defined.push(s),n(p)):t(p)}}function Cu(e,n,t){return r;function r(l){return Ze(l)?Fn(e,s)(l):t(l)}function s(l){return xo(e,a,t,"definitionTitle","definitionTitleMarker","definitionTitleString")(l)}function a(l){return Pe(l)?Oe(e,o,"whitespace")(l):o(l)}function o(l){return l===null||ge(l)?n(l):t(l)}}const Su={name:"hardBreakEscape",tokenize:Tu};function Tu(e,n,t){return r;function r(a){return e.enter("hardBreakEscape"),e.consume(a),s}function s(a){return ge(a)?(e.exit("hardBreakEscape"),n(a)):t(a)}}const Pu={name:"headingAtx",resolve:Eu,tokenize:Au};function Eu(e,n){let t=e.length-2,r=3,s,a;return e[r][1].type==="whitespace"&&(r+=2),t-2>r&&e[t][1].type==="whitespace"&&(t-=2),e[t][1].type==="atxHeadingSequence"&&(r===t-1||t-4>r&&e[t-2][1].type==="whitespace")&&(t-=r+1===t?2:4),t>r&&(s={type:"atxHeadingText",start:e[r][1].start,end:e[t][1].end},a={type:"chunkText",start:e[r][1].start,end:e[t][1].end,contentType:"text"},jt(e,r,t-r+1,[["enter",s,n],["enter",a,n],["exit",a,n],["exit",s,n]])),e}function Au(e,n,t){let r=0;return s;function s(m){return e.enter("atxHeading"),a(m)}function a(m){return e.enter("atxHeadingSequence"),o(m)}function o(m){return m===35&&r++<6?(e.consume(m),o):m===null||Ze(m)?(e.exit("atxHeadingSequence"),l(m)):t(m)}function l(m){return m===35?(e.enter("atxHeadingSequence"),c(m)):m===null||ge(m)?(e.exit("atxHeading"),n(m)):Pe(m)?Oe(e,l,"whitespace")(m):(e.enter("atxHeadingText"),u(m))}function c(m){return m===35?(e.consume(m),c):(e.exit("atxHeadingSequence"),l(m))}function u(m){return m===null||m===35||Ze(m)?(e.exit("atxHeadingText"),l(m)):(e.consume(m),u)}}const Du=["address","article","aside","base","basefont","blockquote","body","caption","center","col","colgroup","dd","details","dialog","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hr","html","iframe","legend","li","link","main","menu","menuitem","nav","noframes","ol","optgroup","option","p","param","search","section","summary","table","tbody","td","tfoot","th","thead","title","tr","track","ul"],bs=["pre","script","style","textarea"],Iu={concrete:!0,name:"htmlFlow",resolveTo:Lu,tokenize:Ru},$u={partial:!0,tokenize:zu},Ou={partial:!0,tokenize:Fu};function Lu(e){let n=e.length;for(;n--&&!(e[n][0]==="enter"&&e[n][1].type==="htmlFlow"););return n>1&&e[n-2][1].type==="linePrefix"&&(e[n][1].start=e[n-2][1].start,e[n+1][1].start=e[n-2][1].start,e.splice(n-2,2)),e}function Ru(e,n,t){const r=this;let s,a,o,l,c;return u;function u(b){return m(b)}function m(b){return e.enter("htmlFlow"),e.enter("htmlFlowData"),e.consume(b),d}function d(b){return b===33?(e.consume(b),y):b===47?(e.consume(b),a=!0,q):b===63?(e.consume(b),s=3,r.interrupt?n:w):vt(b)?(e.consume(b),o=String.fromCharCode(b),G):t(b)}function y(b){return b===45?(e.consume(b),s=2,p):b===91?(e.consume(b),s=5,l=0,E):vt(b)?(e.consume(b),s=4,r.interrupt?n:w):t(b)}function p(b){return b===45?(e.consume(b),r.interrupt?n:w):t(b)}function E(b){const Ie="CDATA[";return b===Ie.charCodeAt(l++)?(e.consume(b),l===Ie.length?r.interrupt?n:_:E):t(b)}function q(b){return vt(b)?(e.consume(b),o=String.fromCharCode(b),G):t(b)}function G(b){if(b===null||b===47||b===62||Ze(b)){const Ie=b===47,We=o.toLowerCase();return!Ie&&!a&&bs.includes(We)?(s=1,r.interrupt?n(b):_(b)):Du.includes(o.toLowerCase())?(s=6,Ie?(e.consume(b),O):r.interrupt?n(b):_(b)):(s=7,r.interrupt&&!r.parser.lazy[r.now().line]?t(b):a?B(b):I(b))}return b===45||at(b)?(e.consume(b),o+=String.fromCharCode(b),G):t(b)}function O(b){return b===62?(e.consume(b),r.interrupt?n:_):t(b)}function B(b){return Pe(b)?(e.consume(b),B):oe(b)}function I(b){return b===47?(e.consume(b),oe):b===58||b===95||vt(b)?(e.consume(b),W):Pe(b)?(e.consume(b),I):oe(b)}function W(b){return b===45||b===46||b===58||b===95||at(b)?(e.consume(b),W):F(b)}function F(b){return b===61?(e.consume(b),j):Pe(b)?(e.consume(b),F):I(b)}function j(b){return b===null||b===60||b===61||b===62||b===96?t(b):b===34||b===39?(e.consume(b),c=b,X):Pe(b)?(e.consume(b),j):le(b)}function X(b){return b===c?(e.consume(b),c=null,ne):b===null||ge(b)?t(b):(e.consume(b),X)}function le(b){return b===null||b===34||b===39||b===47||b===60||b===61||b===62||b===96||Ze(b)?F(b):(e.consume(b),le)}function ne(b){return b===47||b===62||Pe(b)?I(b):t(b)}function oe(b){return b===62?(e.consume(b),V):t(b)}function V(b){return b===null||ge(b)?_(b):Pe(b)?(e.consume(b),V):t(b)}function _(b){return b===45&&s===2?(e.consume(b),M):b===60&&s===1?(e.consume(b),J):b===62&&s===4?(e.consume(b),ze):b===63&&s===3?(e.consume(b),w):b===93&&s===5?(e.consume(b),he):ge(b)&&(s===6||s===7)?(e.exit("htmlFlowData"),e.check($u,ke,C)(b)):b===null||ge(b)?(e.exit("htmlFlowData"),C(b)):(e.consume(b),_)}function C(b){return e.check(Ou,K,ke)(b)}function K(b){return e.enter("lineEnding"),e.consume(b),e.exit("lineEnding"),A}function A(b){return b===null||ge(b)?C(b):(e.enter("htmlFlowData"),_(b))}function M(b){return b===45?(e.consume(b),w):_(b)}function J(b){return b===47?(e.consume(b),o="",Se):_(b)}function Se(b){if(b===62){const Ie=o.toLowerCase();return bs.includes(Ie)?(e.consume(b),ze):_(b)}return vt(b)&&o.length<8?(e.consume(b),o+=String.fromCharCode(b),Se):_(b)}function he(b){return b===93?(e.consume(b),w):_(b)}function w(b){return b===62?(e.consume(b),ze):b===45&&s===2?(e.consume(b),w):_(b)}function ze(b){return b===null||ge(b)?(e.exit("htmlFlowData"),ke(b)):(e.consume(b),ze)}function ke(b){return e.exit("htmlFlow"),n(b)}}function Fu(e,n,t){const r=this;return s;function s(o){return ge(o)?(e.enter("lineEnding"),e.consume(o),e.exit("lineEnding"),a):t(o)}function a(o){return r.parser.lazy[r.now().line]?t(o):n(o)}}function zu(e,n,t){return r;function r(s){return e.enter("lineEnding"),e.consume(s),e.exit("lineEnding"),e.attempt(vr,n,t)}}const qu={name:"htmlText",tokenize:Bu};function Bu(e,n,t){const r=this;let s,a,o;return l;function l(w){return e.enter("htmlText"),e.enter("htmlTextData"),e.consume(w),c}function c(w){return w===33?(e.consume(w),u):w===47?(e.consume(w),F):w===63?(e.consume(w),I):vt(w)?(e.consume(w),le):t(w)}function u(w){return w===45?(e.consume(w),m):w===91?(e.consume(w),a=0,E):vt(w)?(e.consume(w),B):t(w)}function m(w){return w===45?(e.consume(w),p):t(w)}function d(w){return w===null?t(w):w===45?(e.consume(w),y):ge(w)?(o=d,J(w)):(e.consume(w),d)}function y(w){return w===45?(e.consume(w),p):d(w)}function p(w){return w===62?M(w):w===45?y(w):d(w)}function E(w){const ze="CDATA[";return w===ze.charCodeAt(a++)?(e.consume(w),a===ze.length?q:E):t(w)}function q(w){return w===null?t(w):w===93?(e.consume(w),G):ge(w)?(o=q,J(w)):(e.consume(w),q)}function G(w){return w===93?(e.consume(w),O):q(w)}function O(w){return w===62?M(w):w===93?(e.consume(w),O):q(w)}function B(w){return w===null||w===62?M(w):ge(w)?(o=B,J(w)):(e.consume(w),B)}function I(w){return w===null?t(w):w===63?(e.consume(w),W):ge(w)?(o=I,J(w)):(e.consume(w),I)}function W(w){return w===62?M(w):I(w)}function F(w){return vt(w)?(e.consume(w),j):t(w)}function j(w){return w===45||at(w)?(e.consume(w),j):X(w)}function X(w){return ge(w)?(o=X,J(w)):Pe(w)?(e.consume(w),X):M(w)}function le(w){return w===45||at(w)?(e.consume(w),le):w===47||w===62||Ze(w)?ne(w):t(w)}function ne(w){return w===47?(e.consume(w),M):w===58||w===95||vt(w)?(e.consume(w),oe):ge(w)?(o=ne,J(w)):Pe(w)?(e.consume(w),ne):M(w)}function oe(w){return w===45||w===46||w===58||w===95||at(w)?(e.consume(w),oe):V(w)}function V(w){return w===61?(e.consume(w),_):ge(w)?(o=V,J(w)):Pe(w)?(e.consume(w),V):ne(w)}function _(w){return w===null||w===60||w===61||w===62||w===96?t(w):w===34||w===39?(e.consume(w),s=w,C):ge(w)?(o=_,J(w)):Pe(w)?(e.consume(w),_):(e.consume(w),K)}function C(w){return w===s?(e.consume(w),s=void 0,A):w===null?t(w):ge(w)?(o=C,J(w)):(e.consume(w),C)}function K(w){return w===null||w===34||w===39||w===60||w===61||w===96?t(w):w===47||w===62||Ze(w)?ne(w):(e.consume(w),K)}function A(w){return w===47||w===62||Ze(w)?ne(w):t(w)}function M(w){return w===62?(e.consume(w),e.exit("htmlTextData"),e.exit("htmlText"),n):t(w)}function J(w){return e.exit("htmlTextData"),e.enter("lineEnding"),e.consume(w),e.exit("lineEnding"),Se}function Se(w){return Pe(w)?Oe(e,he,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(w):he(w)}function he(w){return e.enter("htmlTextData"),o(w)}}const Vi={name:"labelEnd",resolveAll:Wu,resolveTo:Vu,tokenize:Ju},Uu={tokenize:Qu},Mu={tokenize:Gu},Hu={tokenize:Yu};function Wu(e){let n=-1;const t=[];for(;++n<e.length;){const r=e[n][1];if(t.push(e[n]),r.type==="labelImage"||r.type==="labelLink"||r.type==="labelEnd"){const s=r.type==="labelImage"?4:2;r.type="data",n+=s}}return e.length!==t.length&&jt(e,0,e.length,t),e}function Vu(e,n){let t=e.length,r=0,s,a,o,l;for(;t--;)if(s=e[t][1],a){if(s.type==="link"||s.type==="labelLink"&&s._inactive)break;e[t][0]==="enter"&&s.type==="labelLink"&&(s._inactive=!0)}else if(o){if(e[t][0]==="enter"&&(s.type==="labelImage"||s.type==="labelLink")&&!s._balanced&&(a=t,s.type!=="labelLink")){r=2;break}}else s.type==="labelEnd"&&(o=t);const c={type:e[a][1].type==="labelLink"?"link":"image",start:{...e[a][1].start},end:{...e[e.length-1][1].end}},u={type:"label",start:{...e[a][1].start},end:{...e[o][1].end}},m={type:"labelText",start:{...e[a+r+2][1].end},end:{...e[o-2][1].start}};return l=[["enter",c,n],["enter",u,n]],l=ht(l,e.slice(a+1,a+r+3)),l=ht(l,[["enter",m,n]]),l=ht(l,Wi(n.parser.constructs.insideSpan.null,e.slice(a+r+4,o-3),n)),l=ht(l,[["exit",m,n],e[o-2],e[o-1],["exit",u,n]]),l=ht(l,e.slice(o+1)),l=ht(l,[["exit",c,n]]),jt(e,a,e.length,l),e}function Ju(e,n,t){const r=this;let s=r.events.length,a,o;for(;s--;)if((r.events[s][1].type==="labelImage"||r.events[s][1].type==="labelLink")&&!r.events[s][1]._balanced){a=r.events[s][1];break}return l;function l(y){return a?a._inactive?d(y):(o=r.parser.defined.includes(hn(r.sliceSerialize({start:a.end,end:r.now()}))),e.enter("labelEnd"),e.enter("labelMarker"),e.consume(y),e.exit("labelMarker"),e.exit("labelEnd"),c):t(y)}function c(y){return y===40?e.attempt(Uu,m,o?m:d)(y):y===91?e.attempt(Mu,m,o?u:d)(y):o?m(y):d(y)}function u(y){return e.attempt(Hu,m,d)(y)}function m(y){return n(y)}function d(y){return a._balanced=!0,t(y)}}function Qu(e,n,t){return r;function r(d){return e.enter("resource"),e.enter("resourceMarker"),e.consume(d),e.exit("resourceMarker"),s}function s(d){return Ze(d)?Fn(e,a)(d):a(d)}function a(d){return d===41?m(d):go(e,o,l,"resourceDestination","resourceDestinationLiteral","resourceDestinationLiteralMarker","resourceDestinationRaw","resourceDestinationString",32)(d)}function o(d){return Ze(d)?Fn(e,c)(d):m(d)}function l(d){return t(d)}function c(d){return d===34||d===39||d===40?xo(e,u,t,"resourceTitle","resourceTitleMarker","resourceTitleString")(d):m(d)}function u(d){return Ze(d)?Fn(e,m)(d):m(d)}function m(d){return d===41?(e.enter("resourceMarker"),e.consume(d),e.exit("resourceMarker"),e.exit("resource"),n):t(d)}}function Gu(e,n,t){const r=this;return s;function s(l){return yo.call(r,e,a,o,"reference","referenceMarker","referenceString")(l)}function a(l){return r.parser.defined.includes(hn(r.sliceSerialize(r.events[r.events.length-1][1]).slice(1,-1)))?n(l):t(l)}function o(l){return t(l)}}function Yu(e,n,t){return r;function r(a){return e.enter("reference"),e.enter("referenceMarker"),e.consume(a),e.exit("referenceMarker"),s}function s(a){return a===93?(e.enter("referenceMarker"),e.consume(a),e.exit("referenceMarker"),e.exit("reference"),n):t(a)}}const Ku={name:"labelStartImage",resolveAll:Vi.resolveAll,tokenize:Zu};function Zu(e,n,t){const r=this;return s;function s(l){return e.enter("labelImage"),e.enter("labelImageMarker"),e.consume(l),e.exit("labelImageMarker"),a}function a(l){return l===91?(e.enter("labelMarker"),e.consume(l),e.exit("labelMarker"),e.exit("labelImage"),o):t(l)}function o(l){return l===94&&"_hiddenFootnoteSupport"in r.parser.constructs?t(l):n(l)}}const Xu={name:"labelStartLink",resolveAll:Vi.resolveAll,tokenize:ed};function ed(e,n,t){const r=this;return s;function s(o){return e.enter("labelLink"),e.enter("labelMarker"),e.consume(o),e.exit("labelMarker"),e.exit("labelLink"),a}function a(o){return o===94&&"_hiddenFootnoteSupport"in r.parser.constructs?t(o):n(o)}}const di={name:"lineEnding",tokenize:td};function td(e,n){return t;function t(r){return e.enter("lineEnding"),e.consume(r),e.exit("lineEnding"),Oe(e,n,"linePrefix")}}const br={name:"thematicBreak",tokenize:nd};function nd(e,n,t){let r=0,s;return a;function a(u){return e.enter("thematicBreak"),o(u)}function o(u){return s=u,l(u)}function l(u){return u===s?(e.enter("thematicBreakSequence"),c(u)):r>=3&&(u===null||ge(u))?(e.exit("thematicBreak"),n(u)):t(u)}function c(u){return u===s?(e.consume(u),r++,c):(e.exit("thematicBreakSequence"),Pe(u)?Oe(e,l,"whitespace")(u):l(u))}}const Ke={continuation:{tokenize:sd},exit:ld,name:"list",tokenize:ad},rd={partial:!0,tokenize:cd},id={partial:!0,tokenize:od};function ad(e,n,t){const r=this,s=r.events[r.events.length-1];let a=s&&s[1].type==="linePrefix"?s[2].sliceSerialize(s[1],!0).length:0,o=0;return l;function l(p){const E=r.containerState.type||(p===42||p===43||p===45?"listUnordered":"listOrdered");if(E==="listUnordered"?!r.containerState.marker||p===r.containerState.marker:Ai(p)){if(r.containerState.type||(r.containerState.type=E,e.enter(E,{_container:!0})),E==="listUnordered")return e.enter("listItemPrefix"),p===42||p===45?e.check(br,t,u)(p):u(p);if(!r.interrupt||p===49)return e.enter("listItemPrefix"),e.enter("listItemValue"),c(p)}return t(p)}function c(p){return Ai(p)&&++o<10?(e.consume(p),c):(!r.interrupt||o<2)&&(r.containerState.marker?p===r.containerState.marker:p===41||p===46)?(e.exit("listItemValue"),u(p)):t(p)}function u(p){return e.enter("listItemMarker"),e.consume(p),e.exit("listItemMarker"),r.containerState.marker=r.containerState.marker||p,e.check(vr,r.interrupt?t:m,e.attempt(rd,y,d))}function m(p){return r.containerState.initialBlankLine=!0,a++,y(p)}function d(p){return Pe(p)?(e.enter("listItemPrefixWhitespace"),e.consume(p),e.exit("listItemPrefixWhitespace"),y):t(p)}function y(p){return r.containerState.size=a+r.sliceSerialize(e.exit("listItemPrefix"),!0).length,n(p)}}function sd(e,n,t){const r=this;return r.containerState._closeFlow=void 0,e.check(vr,s,a);function s(l){return r.containerState.furtherBlankLines=r.containerState.furtherBlankLines||r.containerState.initialBlankLine,Oe(e,n,"listItemIndent",r.containerState.size+1)(l)}function a(l){return r.containerState.furtherBlankLines||!Pe(l)?(r.containerState.furtherBlankLines=void 0,r.containerState.initialBlankLine=void 0,o(l)):(r.containerState.furtherBlankLines=void 0,r.containerState.initialBlankLine=void 0,e.attempt(id,n,o)(l))}function o(l){return r.containerState._closeFlow=!0,r.interrupt=void 0,Oe(e,e.attempt(Ke,n,t),"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(l)}}function od(e,n,t){const r=this;return Oe(e,s,"listItemIndent",r.containerState.size+1);function s(a){const o=r.events[r.events.length-1];return o&&o[1].type==="listItemIndent"&&o[2].sliceSerialize(o[1],!0).length===r.containerState.size?n(a):t(a)}}function ld(e){e.exit(this.containerState.type)}function cd(e,n,t){const r=this;return Oe(e,s,"listItemPrefixWhitespace",r.parser.constructs.disable.null.includes("codeIndented")?void 0:5);function s(a){const o=r.events[r.events.length-1];return!Pe(a)&&o&&o[1].type==="listItemPrefixWhitespace"?n(a):t(a)}}const ws={name:"setextUnderline",resolveTo:ud,tokenize:dd};function ud(e,n){let t=e.length,r,s,a;for(;t--;)if(e[t][0]==="enter"){if(e[t][1].type==="content"){r=t;break}e[t][1].type==="paragraph"&&(s=t)}else e[t][1].type==="content"&&e.splice(t,1),!a&&e[t][1].type==="definition"&&(a=t);const o={type:"setextHeading",start:{...e[r][1].start},end:{...e[e.length-1][1].end}};return e[s][1].type="setextHeadingText",a?(e.splice(s,0,["enter",o,n]),e.splice(a+1,0,["exit",e[r][1],n]),e[r][1].end={...e[a][1].end}):e[r][1]=o,e.push(["exit",o,n]),e}function dd(e,n,t){const r=this;let s;return a;function a(u){let m=r.events.length,d;for(;m--;)if(r.events[m][1].type!=="lineEnding"&&r.events[m][1].type!=="linePrefix"&&r.events[m][1].type!=="content"){d=r.events[m][1].type==="paragraph";break}return!r.parser.lazy[r.now().line]&&(r.interrupt||d)?(e.enter("setextHeadingLine"),s=u,o(u)):t(u)}function o(u){return e.enter("setextHeadingLineSequence"),l(u)}function l(u){return u===s?(e.consume(u),l):(e.exit("setextHeadingLineSequence"),Pe(u)?Oe(e,c,"lineSuffix")(u):c(u))}function c(u){return u===null||ge(u)?(e.exit("setextHeadingLine"),n(u)):t(u)}}const pd={tokenize:hd};function hd(e){const n=this,t=e.attempt(vr,r,e.attempt(this.parser.constructs.flowInitial,s,Oe(e,e.attempt(this.parser.constructs.flow,s,e.attempt(xu,s)),"linePrefix")));return t;function r(a){if(a===null){e.consume(a);return}return e.enter("lineEndingBlank"),e.consume(a),e.exit("lineEndingBlank"),n.currentConstruct=void 0,t}function s(a){if(a===null){e.consume(a);return}return e.enter("lineEnding"),e.consume(a),e.exit("lineEnding"),n.currentConstruct=void 0,t}}const md={resolveAll:wo()},fd=bo("string"),gd=bo("text");function bo(e){return{resolveAll:wo(e==="text"?yd:void 0),tokenize:n};function n(t){const r=this,s=this.parser.constructs[e],a=t.attempt(s,o,l);return o;function o(m){return u(m)?a(m):l(m)}function l(m){if(m===null){t.consume(m);return}return t.enter("data"),t.consume(m),c}function c(m){return u(m)?(t.exit("data"),a(m)):(t.consume(m),c)}function u(m){if(m===null)return!0;const d=s[m];let y=-1;if(d)for(;++y<d.length;){const p=d[y];if(!p.previous||p.previous.call(r,r.previous))return!0}return!1}}}function wo(e){return n;function n(t,r){let s=-1,a;for(;++s<=t.length;)a===void 0?t[s]&&t[s][1].type==="data"&&(a=s,s++):(!t[s]||t[s][1].type!=="data")&&(s!==a+2&&(t[a][1].end=t[s-1][1].end,t.splice(a+2,s-a-2),s=a+2),a=void 0);return e?e(t,r):t}}function yd(e,n){let t=0;for(;++t<=e.length;)if((t===e.length||e[t][1].type==="lineEnding")&&e[t-1][1].type==="data"){const r=e[t-1][1],s=n.sliceStream(r);let a=s.length,o=-1,l=0,c;for(;a--;){const u=s[a];if(typeof u=="string"){for(o=u.length;u.charCodeAt(o-1)===32;)l++,o--;if(o)break;o=-1}else if(u===-2)c=!0,l++;else if(u!==-1){a++;break}}if(n._contentTypeTextTrailing&&t===e.length&&(l=0),l){const u={type:t===e.length||c||l<2?"lineSuffix":"hardBreakTrailing",start:{_bufferIndex:a?o:r.start._bufferIndex+o,_index:r.start._index+a,line:r.end.line,column:r.end.column-l,offset:r.end.offset-l},end:{...r.end}};r.end={...u.start},r.start.offset===r.end.offset?Object.assign(r,u):(e.splice(t,0,["enter",u,n],["exit",u,n]),t+=2)}t++}return e}const xd={42:Ke,43:Ke,45:Ke,48:Ke,49:Ke,50:Ke,51:Ke,52:Ke,53:Ke,54:Ke,55:Ke,56:Ke,57:Ke,62:po},bd={91:Nu},wd={[-2]:ui,[-1]:ui,32:ui},kd={35:Pu,42:br,45:[ws,br],60:Iu,61:ws,95:br,96:xs,126:xs},_d={38:mo,92:ho},Nd={[-5]:di,[-4]:di,[-3]:di,33:Ku,38:mo,42:Di,60:[Xc,qu],91:Xu,92:[Su,ho],93:Vi,95:Di,96:pu},vd={null:[Di,md]},jd={null:[42,95]},Cd={null:[]},Sd=Object.freeze(Object.defineProperty({__proto__:null,attentionMarkers:jd,contentInitial:bd,disable:Cd,document:xd,flow:kd,flowInitial:wd,insideSpan:vd,string:_d,text:Nd},Symbol.toStringTag,{value:"Module"}));function Td(e,n,t){let r={_bufferIndex:-1,_index:0,line:t&&t.line||1,column:t&&t.column||1,offset:t&&t.offset||0};const s={},a=[];let o=[],l=[];const c={attempt:X(F),check:X(j),consume:B,enter:I,exit:W,interrupt:X(j,{interrupt:!0})},u={code:null,containerState:{},defineSkip:q,events:[],now:E,parser:e,previous:null,sliceSerialize:y,sliceStream:p,write:d};let m=n.tokenize.call(u,c);return n.resolveAll&&a.push(n),u;function d(V){return o=ht(o,V),G(),o[o.length-1]!==null?[]:(le(n,0),u.events=Wi(a,u.events,u),u.events)}function y(V,_){return Ed(p(V),_)}function p(V){return Pd(o,V)}function E(){const{_bufferIndex:V,_index:_,line:C,column:K,offset:A}=r;return{_bufferIndex:V,_index:_,line:C,column:K,offset:A}}function q(V){s[V.line]=V.column,oe()}function G(){let V;for(;r._index<o.length;){const _=o[r._index];if(typeof _=="string")for(V=r._index,r._bufferIndex<0&&(r._bufferIndex=0);r._index===V&&r._bufferIndex<_.length;)O(_.charCodeAt(r._bufferIndex));else O(_)}}function O(V){m=m(V)}function B(V){ge(V)?(r.line++,r.column=1,r.offset+=V===-3?2:1,oe()):V!==-1&&(r.column++,r.offset++),r._bufferIndex<0?r._index++:(r._bufferIndex++,r._bufferIndex===o[r._index].length&&(r._bufferIndex=-1,r._index++)),u.previous=V}function I(V,_){const C=_||{};return C.type=V,C.start=E(),u.events.push(["enter",C,u]),l.push(C),C}function W(V){const _=l.pop();return _.end=E(),u.events.push(["exit",_,u]),_}function F(V,_){le(V,_.from)}function j(V,_){_.restore()}function X(V,_){return C;function C(K,A,M){let J,Se,he,w;return Array.isArray(K)?ke(K):"tokenize"in K?ke([K]):ze(K);function ze(_e){return st;function st(Fe){const tt=Fe!==null&&_e[Fe],ot=Fe!==null&&_e.null,nt=[...Array.isArray(tt)?tt:tt?[tt]:[],...Array.isArray(ot)?ot:ot?[ot]:[]];return ke(nt)(Fe)}}function ke(_e){return J=_e,Se=0,_e.length===0?M:b(_e[Se])}function b(_e){return st;function st(Fe){return w=ne(),he=_e,_e.partial||(u.currentConstruct=_e),_e.name&&u.parser.constructs.disable.null.includes(_e.name)?We():_e.tokenize.call(_?Object.assign(Object.create(u),_):u,c,Ie,We)(Fe)}}function Ie(_e){return V(he,w),A}function We(_e){return w.restore(),++Se<J.length?b(J[Se]):M}}}function le(V,_){V.resolveAll&&!a.includes(V)&&a.push(V),V.resolve&&jt(u.events,_,u.events.length-_,V.resolve(u.events.slice(_),u)),V.resolveTo&&(u.events=V.resolveTo(u.events,u))}function ne(){const V=E(),_=u.previous,C=u.currentConstruct,K=u.events.length,A=Array.from(l);return{from:K,restore:M};function M(){r=V,u.previous=_,u.currentConstruct=C,u.events.length=K,l=A,oe()}}function oe(){r.line in s&&r.column<2&&(r.column=s[r.line],r.offset+=s[r.line]-1)}}function Pd(e,n){const t=n.start._index,r=n.start._bufferIndex,s=n.end._index,a=n.end._bufferIndex;let o;if(t===s)o=[e[t].slice(r,a)];else{if(o=e.slice(t,s),r>-1){const l=o[0];typeof l=="string"?o[0]=l.slice(r):o.shift()}a>0&&o.push(e[s].slice(0,a))}return o}function Ed(e,n){let t=-1;const r=[];let s;for(;++t<e.length;){const a=e[t];let o;if(typeof a=="string")o=a;else switch(a){case-5:{o="\r";break}case-4:{o=`
`;break}case-3:{o=`\r
`;break}case-2:{o=n?" ":"	";break}case-1:{if(!n&&s)continue;o=" ";break}default:o=String.fromCharCode(a)}s=a===-2,r.push(o)}return r.join("")}function Ad(e){const r={constructs:Fc([Sd,...(e||{}).extensions||[]]),content:s(Vc),defined:[],document:s(Qc),flow:s(pd),lazy:{},string:s(fd),text:s(gd)};return r;function s(a){return o;function o(l){return Td(r,a,l)}}}function Dd(e){for(;!fo(e););return e}const ks=/[\0\t\n\r]/g;function Id(){let e=1,n="",t=!0,r;return s;function s(a,o,l){const c=[];let u,m,d,y,p;for(a=n+(typeof a=="string"?a.toString():new TextDecoder(o||void 0).decode(a)),d=0,n="",t&&(a.charCodeAt(0)===65279&&d++,t=void 0);d<a.length;){if(ks.lastIndex=d,u=ks.exec(a),y=u&&u.index!==void 0?u.index:a.length,p=a.charCodeAt(y),!u){n=a.slice(d);break}if(p===10&&d===y&&r)c.push(-3),r=void 0;else switch(r&&(c.push(-5),r=void 0),d<y&&(c.push(a.slice(d,y)),e+=y-d),p){case 0:{c.push(65533),e++;break}case 9:{for(m=Math.ceil(e/4)*4,c.push(-2);e++<m;)c.push(-1);break}case 10:{c.push(-4),e=1;break}default:r=!0,e=1}d=y+1}return l&&(r&&c.push(-5),n&&c.push(n),c.push(null)),c}}const $d=/\\([!-/:-@[-`{-~])|&(#(?:\d{1,7}|x[\da-f]{1,6})|[\da-z]{1,31});/gi;function ko(e){return e.replace($d,Od)}function Od(e,n,t){if(n)return n;if(t.charCodeAt(0)===35){const s=t.charCodeAt(1),a=s===120||s===88;return uo(t.slice(a?2:1),a?16:10)}return Hi(t)||e}function zn(e){return!e||typeof e!="object"?"":"position"in e||"type"in e?_s(e.position):"start"in e||"end"in e?_s(e):"line"in e||"column"in e?Ii(e):""}function Ii(e){return Ns(e&&e.line)+":"+Ns(e&&e.column)}function _s(e){return Ii(e&&e.start)+"-"+Ii(e&&e.end)}function Ns(e){return e&&typeof e=="number"?e:1}const _o={}.hasOwnProperty;function Ld(e,n,t){return typeof n!="string"&&(t=n,n=void 0),Rd(t)(Dd(Ad(t).document().write(Id()(e,n,!0))))}function Rd(e){const n={transforms:[],canContainEols:["emphasis","fragment","heading","paragraph","strong"],enter:{autolink:a(Qe),autolinkProtocol:ne,autolinkEmail:ne,atxHeading:a(Ct),blockQuote:a(ot),characterEscape:ne,characterReference:ne,codeFenced:a(nt),codeFencedFenceInfo:o,codeFencedFenceMeta:o,codeIndented:a(nt,o),codeText:a(Kt,o),codeTextData:ne,data:ne,codeFlowValue:ne,definition:a(v),definitionDestinationString:o,definitionLabelString:o,definitionTitleString:o,emphasis:a(Ot),hardBreakEscape:a(Zt),hardBreakTrailing:a(Zt),htmlFlow:a(mt,o),htmlFlowData:ne,htmlText:a(mt,o),htmlTextData:ne,image:a(xt),label:o,link:a(Qe),listItem:a(Ht),listItemValue:y,listOrdered:a(St,d),listUnordered:a(St),paragraph:a(Xt),reference:b,referenceString:o,resourceDestinationString:o,resourceTitleString:o,setextHeading:a(Ct),strong:a(Ve),thematicBreak:a(Le)},exit:{atxHeading:c(),atxHeadingSequence:F,autolink:c(),autolinkEmail:tt,autolinkProtocol:Fe,blockQuote:c(),characterEscapeValue:oe,characterReferenceMarkerHexadecimal:We,characterReferenceMarkerNumeric:We,characterReferenceValue:_e,characterReference:st,codeFenced:c(G),codeFencedFence:q,codeFencedFenceInfo:p,codeFencedFenceMeta:E,codeFlowValue:oe,codeIndented:c(O),codeText:c(A),codeTextData:oe,data:oe,definition:c(),definitionDestinationString:W,definitionLabelString:B,definitionTitleString:I,emphasis:c(),hardBreakEscape:c(_),hardBreakTrailing:c(_),htmlFlow:c(C),htmlFlowData:oe,htmlText:c(K),htmlTextData:oe,image:c(J),label:he,labelText:Se,lineEnding:V,link:c(M),listItem:c(),listOrdered:c(),listUnordered:c(),paragraph:c(),referenceString:Ie,resourceDestinationString:w,resourceTitleString:ze,resource:ke,setextHeading:c(le),setextHeadingLineSequence:X,setextHeadingText:j,strong:c(),thematicBreak:c()}};No(n,(e||{}).mdastExtensions||[]);const t={};return r;function r(T){let P={type:"root",children:[]};const S={stack:[P],tokenStack:[],config:n,enter:l,exit:u,buffer:o,resume:m,data:t},ee=[];let ce=-1;for(;++ce<T.length;)if(T[ce][1].type==="listOrdered"||T[ce][1].type==="listUnordered")if(T[ce][0]==="enter")ee.push(ce);else{const Re=ee.pop();ce=s(T,Re,ce)}for(ce=-1;++ce<T.length;){const Re=n[T[ce][0]];_o.call(Re,T[ce][1].type)&&Re[T[ce][1].type].call(Object.assign({sliceSerialize:T[ce][2].sliceSerialize},S),T[ce][1])}if(S.tokenStack.length>0){const Re=S.tokenStack[S.tokenStack.length-1];(Re[1]||vs).call(S,void 0,Re[0])}for(P.position={start:qt(T.length>0?T[0][1].start:{line:1,column:1,offset:0}),end:qt(T.length>0?T[T.length-2][1].end:{line:1,column:1,offset:0})},ce=-1;++ce<n.transforms.length;)P=n.transforms[ce](P)||P;return P}function s(T,P,S){let ee=P-1,ce=-1,Re=!1,He,je,Je,Ge;for(;++ee<=S;){const qe=T[ee];switch(qe[1].type){case"listUnordered":case"listOrdered":case"blockQuote":{qe[0]==="enter"?ce++:ce--,Ge=void 0;break}case"lineEndingBlank":{qe[0]==="enter"&&(He&&!Ge&&!ce&&!Je&&(Je=ee),Ge=void 0);break}case"linePrefix":case"listItemValue":case"listItemMarker":case"listItemPrefix":case"listItemPrefixWhitespace":break;default:Ge=void 0}if(!ce&&qe[0]==="enter"&&qe[1].type==="listItemPrefix"||ce===-1&&qe[0]==="exit"&&(qe[1].type==="listUnordered"||qe[1].type==="listOrdered")){if(He){let te=ee;for(je=void 0;te--;){const D=T[te];if(D[1].type==="lineEnding"||D[1].type==="lineEndingBlank"){if(D[0]==="exit")continue;je&&(T[je][1].type="lineEndingBlank",Re=!0),D[1].type="lineEnding",je=te}else if(!(D[1].type==="linePrefix"||D[1].type==="blockQuotePrefix"||D[1].type==="blockQuotePrefixWhitespace"||D[1].type==="blockQuoteMarker"||D[1].type==="listItemIndent"))break}Je&&(!je||Je<je)&&(He._spread=!0),He.end=Object.assign({},je?T[je][1].start:qe[1].end),T.splice(je||ee,0,["exit",He,qe[2]]),ee++,S++}if(qe[1].type==="listItemPrefix"){const te={type:"listItem",_spread:!1,start:Object.assign({},qe[1].start),end:void 0};He=te,T.splice(ee,0,["enter",te,qe[2]]),ee++,S++,Je=void 0,Ge=!0}}}return T[P][1]._spread=Re,S}function a(T,P){return S;function S(ee){l.call(this,T(ee),ee),P&&P.call(this,ee)}}function o(){this.stack.push({type:"fragment",children:[]})}function l(T,P,S){this.stack[this.stack.length-1].children.push(T),this.stack.push(T),this.tokenStack.push([P,S||void 0]),T.position={start:qt(P.start),end:void 0}}function c(T){return P;function P(S){T&&T.call(this,S),u.call(this,S)}}function u(T,P){const S=this.stack.pop(),ee=this.tokenStack.pop();if(ee)ee[0].type!==T.type&&(P?P.call(this,T,ee[0]):(ee[1]||vs).call(this,T,ee[0]));else throw new Error("Cannot close `"+T.type+"` ("+zn({start:T.start,end:T.end})+"): it’s not open");S.position.end=qt(T.end)}function m(){return Mi(this.stack.pop())}function d(){this.data.expectingFirstListItemValue=!0}function y(T){if(this.data.expectingFirstListItemValue){const P=this.stack[this.stack.length-2];P.start=Number.parseInt(this.sliceSerialize(T),10),this.data.expectingFirstListItemValue=void 0}}function p(){const T=this.resume(),P=this.stack[this.stack.length-1];P.lang=T}function E(){const T=this.resume(),P=this.stack[this.stack.length-1];P.meta=T}function q(){this.data.flowCodeInside||(this.buffer(),this.data.flowCodeInside=!0)}function G(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T.replace(/^(\r?\n|\r)|(\r?\n|\r)$/g,""),this.data.flowCodeInside=void 0}function O(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T.replace(/(\r?\n|\r)$/g,"")}function B(T){const P=this.resume(),S=this.stack[this.stack.length-1];S.label=P,S.identifier=hn(this.sliceSerialize(T)).toLowerCase()}function I(){const T=this.resume(),P=this.stack[this.stack.length-1];P.title=T}function W(){const T=this.resume(),P=this.stack[this.stack.length-1];P.url=T}function F(T){const P=this.stack[this.stack.length-1];if(!P.depth){const S=this.sliceSerialize(T).length;P.depth=S}}function j(){this.data.setextHeadingSlurpLineEnding=!0}function X(T){const P=this.stack[this.stack.length-1];P.depth=this.sliceSerialize(T).codePointAt(0)===61?1:2}function le(){this.data.setextHeadingSlurpLineEnding=void 0}function ne(T){const S=this.stack[this.stack.length-1].children;let ee=S[S.length-1];(!ee||ee.type!=="text")&&(ee=Tt(),ee.position={start:qt(T.start),end:void 0},S.push(ee)),this.stack.push(ee)}function oe(T){const P=this.stack.pop();P.value+=this.sliceSerialize(T),P.position.end=qt(T.end)}function V(T){const P=this.stack[this.stack.length-1];if(this.data.atHardBreak){const S=P.children[P.children.length-1];S.position.end=qt(T.end),this.data.atHardBreak=void 0;return}!this.data.setextHeadingSlurpLineEnding&&n.canContainEols.includes(P.type)&&(ne.call(this,T),oe.call(this,T))}function _(){this.data.atHardBreak=!0}function C(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T}function K(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T}function A(){const T=this.resume(),P=this.stack[this.stack.length-1];P.value=T}function M(){const T=this.stack[this.stack.length-1];if(this.data.inReference){const P=this.data.referenceType||"shortcut";T.type+="Reference",T.referenceType=P,delete T.url,delete T.title}else delete T.identifier,delete T.label;this.data.referenceType=void 0}function J(){const T=this.stack[this.stack.length-1];if(this.data.inReference){const P=this.data.referenceType||"shortcut";T.type+="Reference",T.referenceType=P,delete T.url,delete T.title}else delete T.identifier,delete T.label;this.data.referenceType=void 0}function Se(T){const P=this.sliceSerialize(T),S=this.stack[this.stack.length-2];S.label=ko(P),S.identifier=hn(P).toLowerCase()}function he(){const T=this.stack[this.stack.length-1],P=this.resume(),S=this.stack[this.stack.length-1];if(this.data.inReference=!0,S.type==="link"){const ee=T.children;S.children=ee}else S.alt=P}function w(){const T=this.resume(),P=this.stack[this.stack.length-1];P.url=T}function ze(){const T=this.resume(),P=this.stack[this.stack.length-1];P.title=T}function ke(){this.data.inReference=void 0}function b(){this.data.referenceType="collapsed"}function Ie(T){const P=this.resume(),S=this.stack[this.stack.length-1];S.label=P,S.identifier=hn(this.sliceSerialize(T)).toLowerCase(),this.data.referenceType="full"}function We(T){this.data.characterReferenceType=T.type}function _e(T){const P=this.sliceSerialize(T),S=this.data.characterReferenceType;let ee;S?(ee=uo(P,S==="characterReferenceMarkerNumeric"?10:16),this.data.characterReferenceType=void 0):ee=Hi(P);const ce=this.stack[this.stack.length-1];ce.value+=ee}function st(T){const P=this.stack.pop();P.position.end=qt(T.end)}function Fe(T){oe.call(this,T);const P=this.stack[this.stack.length-1];P.url=this.sliceSerialize(T)}function tt(T){oe.call(this,T);const P=this.stack[this.stack.length-1];P.url="mailto:"+this.sliceSerialize(T)}function ot(){return{type:"blockquote",children:[]}}function nt(){return{type:"code",lang:null,meta:null,value:""}}function Kt(){return{type:"inlineCode",value:""}}function v(){return{type:"definition",identifier:"",label:null,title:null,url:""}}function Ot(){return{type:"emphasis",children:[]}}function Ct(){return{type:"heading",depth:0,children:[]}}function Zt(){return{type:"break"}}function mt(){return{type:"html",value:""}}function xt(){return{type:"image",title:null,url:"",alt:null}}function Qe(){return{type:"link",title:null,url:"",children:[]}}function St(T){return{type:"list",ordered:T.type==="listOrdered",start:null,spread:T._spread,children:[]}}function Ht(T){return{type:"listItem",spread:T._spread,checked:null,children:[]}}function Xt(){return{type:"paragraph",children:[]}}function Ve(){return{type:"strong",children:[]}}function Tt(){return{type:"text",value:""}}function Le(){return{type:"thematicBreak"}}}function qt(e){return{line:e.line,column:e.column,offset:e.offset}}function No(e,n){let t=-1;for(;++t<n.length;){const r=n[t];Array.isArray(r)?No(e,r):Fd(e,r)}}function Fd(e,n){let t;for(t in n)if(_o.call(n,t))switch(t){case"canContainEols":{const r=n[t];r&&e[t].push(...r);break}case"transforms":{const r=n[t];r&&e[t].push(...r);break}case"enter":case"exit":{const r=n[t];r&&Object.assign(e[t],r);break}}}function vs(e,n){throw e?new Error("Cannot close `"+e.type+"` ("+zn({start:e.start,end:e.end})+"): a different token (`"+n.type+"`, "+zn({start:n.start,end:n.end})+") is open"):new Error("Cannot close document, a token (`"+n.type+"`, "+zn({start:n.start,end:n.end})+") is still open")}function zd(e){const n=this;n.parser=t;function t(r){return Ld(r,{...n.data("settings"),...e,extensions:n.data("micromarkExtensions")||[],mdastExtensions:n.data("fromMarkdownExtensions")||[]})}}const js={}.hasOwnProperty;function vo(e,n){const t=n||{};function r(s,...a){let o=r.invalid;const l=r.handlers;if(s&&js.call(s,e)){const c=String(s[e]);o=js.call(l,c)?l[c]:r.unknown}if(o)return o.call(this,s,...a)}return r.handlers=t.handlers||{},r.invalid=t.invalid,r.unknown=t.unknown,r}const qd={}.hasOwnProperty;function jo(e,n){let t=-1,r;if(n.extensions)for(;++t<n.extensions.length;)jo(e,n.extensions[t]);for(r in n)if(qd.call(n,r))switch(r){case"extensions":break;case"unsafe":{Cs(e[r],n[r]);break}case"join":{Cs(e[r],n[r]);break}case"handlers":{Bd(e[r],n[r]);break}default:e.options[r]=n[r]}return e}function Cs(e,n){n&&e.push(...n)}function Bd(e,n){n&&Object.assign(e,n)}function Ud(e,n,t,r){const s=t.enter("blockquote"),a=t.createTracker(r);a.move("> "),a.shift(2);const o=t.indentLines(t.containerFlow(e,a.current()),Md);return s(),o}function Md(e,n,t){return">"+(t?"":" ")+e}function Co(e,n){return Ss(e,n.inConstruct,!0)&&!Ss(e,n.notInConstruct,!1)}function Ss(e,n,t){if(typeof n=="string"&&(n=[n]),!n||n.length===0)return t;let r=-1;for(;++r<n.length;)if(e.includes(n[r]))return!0;return!1}function Ts(e,n,t,r){let s=-1;for(;++s<t.unsafe.length;)if(t.unsafe[s].character===`
`&&Co(t.stack,t.unsafe[s]))return/[ \t]/.test(r.before)?"":" ";return`\\
`}function Hd(e,n){const t=String(e);let r=t.indexOf(n),s=r,a=0,o=0;if(typeof n!="string")throw new TypeError("Expected substring");for(;r!==-1;)r===s?++a>o&&(o=a):a=1,s=r+n.length,r=t.indexOf(n,s);return o}function $i(e,n){return!!(n.options.fences===!1&&e.value&&!e.lang&&/[^ \r\n]/.test(e.value)&&!/^[\t ]*(?:[\r\n]|$)|(?:^|[\r\n])[\t ]*$/.test(e.value))}function Wd(e){const n=e.options.fence||"`";if(n!=="`"&&n!=="~")throw new Error("Cannot serialize code with `"+n+"` for `options.fence`, expected `` ` `` or `~`");return n}function Vd(e,n,t,r){const s=Wd(t),a=e.value||"",o=s==="`"?"GraveAccent":"Tilde";if($i(e,t)){const d=t.enter("codeIndented"),y=t.indentLines(a,Jd);return d(),y}const l=t.createTracker(r),c=s.repeat(Math.max(Hd(a,s)+1,3)),u=t.enter("codeFenced");let m=l.move(c);if(e.lang){const d=t.enter(`codeFencedLang${o}`);m+=l.move(t.safe(e.lang,{before:m,after:" ",encode:["`"],...l.current()})),d()}if(e.lang&&e.meta){const d=t.enter(`codeFencedMeta${o}`);m+=l.move(" "),m+=l.move(t.safe(e.meta,{before:m,after:`
`,encode:["`"],...l.current()})),d()}return m+=l.move(`
`),a&&(m+=l.move(a+`
`)),m+=l.move(c),u(),m}function Jd(e,n,t){return(t?"":"    ")+e}function Ji(e){const n=e.options.quote||'"';if(n!=='"'&&n!=="'")throw new Error("Cannot serialize title with `"+n+"` for `options.quote`, expected `\"`, or `'`");return n}function Qd(e,n,t,r){const s=Ji(t),a=s==='"'?"Quote":"Apostrophe",o=t.enter("definition");let l=t.enter("label");const c=t.createTracker(r);let u=c.move("[");return u+=c.move(t.safe(t.associationId(e),{before:u,after:"]",...c.current()})),u+=c.move("]: "),l(),!e.url||/[\0- \u007F]/.test(e.url)?(l=t.enter("destinationLiteral"),u+=c.move("<"),u+=c.move(t.safe(e.url,{before:u,after:">",...c.current()})),u+=c.move(">")):(l=t.enter("destinationRaw"),u+=c.move(t.safe(e.url,{before:u,after:e.title?" ":`
`,...c.current()}))),l(),e.title&&(l=t.enter(`title${a}`),u+=c.move(" "+s),u+=c.move(t.safe(e.title,{before:u,after:s,...c.current()})),u+=c.move(s),l()),o(),u}function Gd(e){const n=e.options.emphasis||"*";if(n!=="*"&&n!=="_")throw new Error("Cannot serialize emphasis with `"+n+"` for `options.emphasis`, expected `*`, or `_`");return n}function Ut(e){return"&#x"+e.toString(16).toUpperCase()+";"}function kr(e,n,t){const r=wr(e),s=wr(n);return r===void 0?s===void 0?t==="_"?{inside:!0,outside:!0}:{inside:!1,outside:!1}:s===1?{inside:!0,outside:!0}:{inside:!1,outside:!0}:r===1?s===void 0?{inside:!1,outside:!1}:s===1?{inside:!0,outside:!0}:{inside:!1,outside:!1}:s===void 0?{inside:!1,outside:!1}:s===1?{inside:!0,outside:!1}:{inside:!1,outside:!1}}So.peek=Yd;function So(e,n,t,r){const s=Gd(t),a=t.enter("emphasis"),o=t.createTracker(r),l=o.move(s);let c=o.move(t.containerPhrasing(e,{after:s,before:l,...o.current()}));const u=c.charCodeAt(0),m=kr(r.before.charCodeAt(r.before.length-1),u,s);m.inside&&(c=Ut(u)+c.slice(1));const d=c.charCodeAt(c.length-1),y=kr(r.after.charCodeAt(0),d,s);y.inside&&(c=c.slice(0,-1)+Ut(d));const p=o.move(s);return a(),t.attentionEncodeSurroundingInfo={after:y.outside,before:m.outside},l+c+p}function Yd(e,n,t){return t.options.emphasis||"*"}const Qi=function(e){if(e==null)return ep;if(typeof e=="function")return jr(e);if(typeof e=="object")return Array.isArray(e)?Kd(e):Zd(e);if(typeof e=="string")return Xd(e);throw new Error("Expected function, string, or object as test")};function Kd(e){const n=[];let t=-1;for(;++t<e.length;)n[t]=Qi(e[t]);return jr(r);function r(...s){let a=-1;for(;++a<n.length;)if(n[a].apply(this,s))return!0;return!1}}function Zd(e){const n=e;return jr(t);function t(r){const s=r;let a;for(a in e)if(s[a]!==n[a])return!1;return!0}}function Xd(e){return jr(n);function n(t){return t&&t.type===e}}function jr(e){return n;function n(t,r,s){return!!(tp(t)&&e.call(this,t,typeof r=="number"?r:void 0,s||void 0))}}function ep(){return!0}function tp(e){return e!==null&&typeof e=="object"&&"type"in e}const To=[],np=!0,Oi=!1,rp="skip";function ip(e,n,t,r){let s;typeof n=="function"&&typeof t!="function"?(r=t,t=n):s=n;const a=Qi(s),o=r?-1:1;l(e,void 0,[])();function l(c,u,m){const d=c&&typeof c=="object"?c:{};if(typeof d.type=="string"){const p=typeof d.tagName=="string"?d.tagName:typeof d.name=="string"?d.name:void 0;Object.defineProperty(y,"name",{value:"node ("+(c.type+(p?"<"+p+">":""))+")"})}return y;function y(){let p=To,E,q,G;if((!n||a(c,u,m[m.length-1]||void 0))&&(p=ap(t(c,m)),p[0]===Oi))return p;if("children"in c&&c.children){const O=c;if(O.children&&p[0]!==rp)for(q=(r?O.children.length:-1)+o,G=m.concat(O);q>-1&&q<O.children.length;){const B=O.children[q];if(E=l(B,q,G)(),E[0]===Oi)return E;q=typeof E[1]=="number"?E[1]:q+o}}return p}}}function ap(e){return Array.isArray(e)?e:typeof e=="number"?[np,e]:e==null?To:[e]}function Po(e,n,t,r){let s,a,o;typeof n=="function"?(a=void 0,o=n,s=t):(a=n,o=t,s=r),ip(e,a,l,s);function l(c,u){const m=u[u.length-1],d=m?m.children.indexOf(c):void 0;return o(c,d,m)}}function Eo(e,n){let t=!1;return Po(e,function(r){if("value"in r&&/\r?\n|\r/.test(r.value)||r.type==="break")return t=!0,Oi}),!!((!e.depth||e.depth<3)&&Mi(e)&&(n.options.setext||t))}function sp(e,n,t,r){const s=Math.max(Math.min(6,e.depth||1),1),a=t.createTracker(r);if(Eo(e,t)){const m=t.enter("headingSetext"),d=t.enter("phrasing"),y=t.containerPhrasing(e,{...a.current(),before:`
`,after:`
`});return d(),m(),y+`
`+(s===1?"=":"-").repeat(y.length-(Math.max(y.lastIndexOf("\r"),y.lastIndexOf(`
`))+1))}const o="#".repeat(s),l=t.enter("headingAtx"),c=t.enter("phrasing");a.move(o+" ");let u=t.containerPhrasing(e,{before:"# ",after:`
`,...a.current()});return/^[\t ]/.test(u)&&(u=Ut(u.charCodeAt(0))+u.slice(1)),u=u?o+" "+u:o,t.options.closeAtx&&(u+=" "+o),c(),l(),u}Ao.peek=op;function Ao(e){return e.value||""}function op(){return"<"}Do.peek=lp;function Do(e,n,t,r){const s=Ji(t),a=s==='"'?"Quote":"Apostrophe",o=t.enter("image");let l=t.enter("label");const c=t.createTracker(r);let u=c.move("![");return u+=c.move(t.safe(e.alt,{before:u,after:"]",...c.current()})),u+=c.move("]("),l(),!e.url&&e.title||/[\0- \u007F]/.test(e.url)?(l=t.enter("destinationLiteral"),u+=c.move("<"),u+=c.move(t.safe(e.url,{before:u,after:">",...c.current()})),u+=c.move(">")):(l=t.enter("destinationRaw"),u+=c.move(t.safe(e.url,{before:u,after:e.title?" ":")",...c.current()}))),l(),e.title&&(l=t.enter(`title${a}`),u+=c.move(" "+s),u+=c.move(t.safe(e.title,{before:u,after:s,...c.current()})),u+=c.move(s),l()),u+=c.move(")"),o(),u}function lp(){return"!"}Io.peek=cp;function Io(e,n,t,r){const s=e.referenceType,a=t.enter("imageReference");let o=t.enter("label");const l=t.createTracker(r);let c=l.move("![");const u=t.safe(e.alt,{before:c,after:"]",...l.current()});c+=l.move(u+"]["),o();const m=t.stack;t.stack=[],o=t.enter("reference");const d=t.safe(t.associationId(e),{before:c,after:"]",...l.current()});return o(),t.stack=m,a(),s==="full"||!u||u!==d?c+=l.move(d+"]"):s==="shortcut"?c=c.slice(0,-1):c+=l.move("]"),c}function cp(){return"!"}$o.peek=up;function $o(e,n,t){let r=e.value||"",s="`",a=-1;for(;new RegExp("(^|[^`])"+s+"([^`]|$)").test(r);)s+="`";for(/[^ \r\n]/.test(r)&&(/^[ \r\n]/.test(r)&&/[ \r\n]$/.test(r)||/^`|`$/.test(r))&&(r=" "+r+" ");++a<t.unsafe.length;){const o=t.unsafe[a],l=t.compilePattern(o);let c;if(o.atBreak)for(;c=l.exec(r);){let u=c.index;r.charCodeAt(u)===10&&r.charCodeAt(u-1)===13&&u--,r=r.slice(0,u)+" "+r.slice(c.index+1)}}return s+r+s}function up(){return"`"}function Oo(e,n){const t=Mi(e);return!!(!n.options.resourceLink&&e.url&&!e.title&&e.children&&e.children.length===1&&e.children[0].type==="text"&&(t===e.url||"mailto:"+t===e.url)&&/^[a-z][a-z+.-]+:/i.test(e.url)&&!/[\0- <>\u007F]/.test(e.url))}Lo.peek=dp;function Lo(e,n,t,r){const s=Ji(t),a=s==='"'?"Quote":"Apostrophe",o=t.createTracker(r);let l,c;if(Oo(e,t)){const m=t.stack;t.stack=[],l=t.enter("autolink");let d=o.move("<");return d+=o.move(t.containerPhrasing(e,{before:d,after:">",...o.current()})),d+=o.move(">"),l(),t.stack=m,d}l=t.enter("link"),c=t.enter("label");let u=o.move("[");return u+=o.move(t.containerPhrasing(e,{before:u,after:"](",...o.current()})),u+=o.move("]("),c(),!e.url&&e.title||/[\0- \u007F]/.test(e.url)?(c=t.enter("destinationLiteral"),u+=o.move("<"),u+=o.move(t.safe(e.url,{before:u,after:">",...o.current()})),u+=o.move(">")):(c=t.enter("destinationRaw"),u+=o.move(t.safe(e.url,{before:u,after:e.title?" ":")",...o.current()}))),c(),e.title&&(c=t.enter(`title${a}`),u+=o.move(" "+s),u+=o.move(t.safe(e.title,{before:u,after:s,...o.current()})),u+=o.move(s),c()),u+=o.move(")"),l(),u}function dp(e,n,t){return Oo(e,t)?"<":"["}Ro.peek=pp;function Ro(e,n,t,r){const s=e.referenceType,a=t.enter("linkReference");let o=t.enter("label");const l=t.createTracker(r);let c=l.move("[");const u=t.containerPhrasing(e,{before:c,after:"]",...l.current()});c+=l.move(u+"]["),o();const m=t.stack;t.stack=[],o=t.enter("reference");const d=t.safe(t.associationId(e),{before:c,after:"]",...l.current()});return o(),t.stack=m,a(),s==="full"||!u||u!==d?c+=l.move(d+"]"):s==="shortcut"?c=c.slice(0,-1):c+=l.move("]"),c}function pp(){return"["}function Gi(e){const n=e.options.bullet||"*";if(n!=="*"&&n!=="+"&&n!=="-")throw new Error("Cannot serialize items with `"+n+"` for `options.bullet`, expected `*`, `+`, or `-`");return n}function hp(e){const n=Gi(e),t=e.options.bulletOther;if(!t)return n==="*"?"-":"*";if(t!=="*"&&t!=="+"&&t!=="-")throw new Error("Cannot serialize items with `"+t+"` for `options.bulletOther`, expected `*`, `+`, or `-`");if(t===n)throw new Error("Expected `bullet` (`"+n+"`) and `bulletOther` (`"+t+"`) to be different");return t}function mp(e){const n=e.options.bulletOrdered||".";if(n!=="."&&n!==")")throw new Error("Cannot serialize items with `"+n+"` for `options.bulletOrdered`, expected `.` or `)`");return n}function Fo(e){const n=e.options.rule||"*";if(n!=="*"&&n!=="-"&&n!=="_")throw new Error("Cannot serialize rules with `"+n+"` for `options.rule`, expected `*`, `-`, or `_`");return n}function fp(e,n,t,r){const s=t.enter("list"),a=t.bulletCurrent;let o=e.ordered?mp(t):Gi(t);const l=e.ordered?o==="."?")":".":hp(t);let c=n&&t.bulletLastUsed?o===t.bulletLastUsed:!1;if(!e.ordered){const m=e.children?e.children[0]:void 0;if((o==="*"||o==="-")&&m&&(!m.children||!m.children[0])&&t.stack[t.stack.length-1]==="list"&&t.stack[t.stack.length-2]==="listItem"&&t.stack[t.stack.length-3]==="list"&&t.stack[t.stack.length-4]==="listItem"&&t.indexStack[t.indexStack.length-1]===0&&t.indexStack[t.indexStack.length-2]===0&&t.indexStack[t.indexStack.length-3]===0&&(c=!0),Fo(t)===o&&m){let d=-1;for(;++d<e.children.length;){const y=e.children[d];if(y&&y.type==="listItem"&&y.children&&y.children[0]&&y.children[0].type==="thematicBreak"){c=!0;break}}}}c&&(o=l),t.bulletCurrent=o;const u=t.containerFlow(e,r);return t.bulletLastUsed=o,t.bulletCurrent=a,s(),u}function gp(e){const n=e.options.listItemIndent||"one";if(n!=="tab"&&n!=="one"&&n!=="mixed")throw new Error("Cannot serialize items with `"+n+"` for `options.listItemIndent`, expected `tab`, `one`, or `mixed`");return n}function yp(e,n,t,r){const s=gp(t);let a=t.bulletCurrent||Gi(t);n&&n.type==="list"&&n.ordered&&(a=(typeof n.start=="number"&&n.start>-1?n.start:1)+(t.options.incrementListMarker===!1?0:n.children.indexOf(e))+a);let o=a.length+1;(s==="tab"||s==="mixed"&&(n&&n.type==="list"&&n.spread||e.spread))&&(o=Math.ceil(o/4)*4);const l=t.createTracker(r);l.move(a+" ".repeat(o-a.length)),l.shift(o);const c=t.enter("listItem"),u=t.indentLines(t.containerFlow(e,l.current()),m);return c(),u;function m(d,y,p){return y?(p?"":" ".repeat(o))+d:(p?a:a+" ".repeat(o-a.length))+d}}function xp(e,n,t,r){const s=t.enter("paragraph"),a=t.enter("phrasing"),o=t.containerPhrasing(e,r);return a(),s(),o}const bp=Qi(["break","delete","emphasis","footnote","footnoteReference","image","imageReference","inlineCode","inlineMath","link","linkReference","mdxJsxTextElement","mdxTextExpression","strong","text","textDirective"]);function wp(e,n,t,r){return(e.children.some(function(o){return bp(o)})?t.containerPhrasing:t.containerFlow).call(t,e,r)}function kp(e){const n=e.options.strong||"*";if(n!=="*"&&n!=="_")throw new Error("Cannot serialize strong with `"+n+"` for `options.strong`, expected `*`, or `_`");return n}zo.peek=_p;function zo(e,n,t,r){const s=kp(t),a=t.enter("strong"),o=t.createTracker(r),l=o.move(s+s);let c=o.move(t.containerPhrasing(e,{after:s,before:l,...o.current()}));const u=c.charCodeAt(0),m=kr(r.before.charCodeAt(r.before.length-1),u,s);m.inside&&(c=Ut(u)+c.slice(1));const d=c.charCodeAt(c.length-1),y=kr(r.after.charCodeAt(0),d,s);y.inside&&(c=c.slice(0,-1)+Ut(d));const p=o.move(s+s);return a(),t.attentionEncodeSurroundingInfo={after:y.outside,before:m.outside},l+c+p}function _p(e,n,t){return t.options.strong||"*"}function Np(e,n,t,r){return t.safe(e.value,r)}function vp(e){const n=e.options.ruleRepetition||3;if(n<3)throw new Error("Cannot serialize rules with repetition `"+n+"` for `options.ruleRepetition`, expected `3` or more");return n}function jp(e,n,t){const r=(Fo(t)+(t.options.ruleSpaces?" ":"")).repeat(vp(t));return t.options.ruleSpaces?r.slice(0,-1):r}const Cp={blockquote:Ud,break:Ts,code:Vd,definition:Qd,emphasis:So,hardBreak:Ts,heading:sp,html:Ao,image:Do,imageReference:Io,inlineCode:$o,link:Lo,linkReference:Ro,list:fp,listItem:yp,paragraph:xp,root:wp,strong:zo,text:Np,thematicBreak:jp},Sp=[Tp];function Tp(e,n,t,r){if(n.type==="code"&&$i(n,r)&&(e.type==="list"||e.type===n.type&&$i(e,r)))return!1;if("spread"in t&&typeof t.spread=="boolean")return e.type==="paragraph"&&(e.type===n.type||n.type==="definition"||n.type==="heading"&&Eo(n,r))?void 0:t.spread?1:0}const Jt=["autolink","destinationLiteral","destinationRaw","reference","titleQuote","titleApostrophe"],Pp=[{character:"	",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",before:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"\r",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:`
`,inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:" ",after:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",before:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"!",after:"\\[",inConstruct:"phrasing",notInConstruct:Jt},{character:'"',inConstruct:"titleQuote"},{atBreak:!0,character:"#"},{character:"#",inConstruct:"headingAtx",after:`(?:[\r
]|$)`},{character:"&",after:"[#A-Za-z]",inConstruct:"phrasing"},{character:"'",inConstruct:"titleApostrophe"},{character:"(",inConstruct:"destinationRaw"},{before:"\\]",character:"(",inConstruct:"phrasing",notInConstruct:Jt},{atBreak:!0,before:"\\d+",character:")"},{character:")",inConstruct:"destinationRaw"},{atBreak:!0,character:"*",after:`(?:[ 	\r
*])`},{character:"*",inConstruct:"phrasing",notInConstruct:Jt},{atBreak:!0,character:"+",after:`(?:[ 	\r
])`},{atBreak:!0,character:"-",after:`(?:[ 	\r
-])`},{atBreak:!0,before:"\\d+",character:".",after:`(?:[ 	\r
]|$)`},{atBreak:!0,character:"<",after:"[!/?A-Za-z]"},{character:"<",after:"[!/?A-Za-z]",inConstruct:"phrasing",notInConstruct:Jt},{character:"<",inConstruct:"destinationLiteral"},{atBreak:!0,character:"="},{atBreak:!0,character:">"},{character:">",inConstruct:"destinationLiteral"},{atBreak:!0,character:"["},{character:"[",inConstruct:"phrasing",notInConstruct:Jt},{character:"[",inConstruct:["label","reference"]},{character:"\\",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"]",inConstruct:["label","reference"]},{atBreak:!0,character:"_"},{character:"_",inConstruct:"phrasing",notInConstruct:Jt},{atBreak:!0,character:"`"},{character:"`",inConstruct:["codeFencedLangGraveAccent","codeFencedMetaGraveAccent"]},{character:"`",inConstruct:"phrasing",notInConstruct:Jt},{atBreak:!0,character:"~"}];function Ep(e){return e.label||!e.identifier?e.label||"":ko(e.identifier)}function Ap(e){if(!e._compiled){const n=(e.atBreak?"[\\r\\n][\\t ]*":"")+(e.before?"(?:"+e.before+")":"");e._compiled=new RegExp((n?"("+n+")":"")+(/[|\\{}()[\]^$+*?.-]/.test(e.character)?"\\":"")+e.character+(e.after?"(?:"+e.after+")":""),"g")}return e._compiled}function Dp(e,n,t){const r=n.indexStack,s=e.children||[],a=[];let o=-1,l=t.before,c;r.push(-1);let u=n.createTracker(t);for(;++o<s.length;){const m=s[o];let d;if(r[r.length-1]=o,o+1<s.length){let E=n.handle.handlers[s[o+1].type];E&&E.peek&&(E=E.peek),d=E?E(s[o+1],e,n,{before:"",after:"",...u.current()}).charAt(0):""}else d=t.after;a.length>0&&(l==="\r"||l===`
`)&&m.type==="html"&&(a[a.length-1]=a[a.length-1].replace(/(\r?\n|\r)$/," "),l=" ",u=n.createTracker(t),u.move(a.join("")));let y=n.handle(m,e,n,{...u.current(),after:d,before:l});c&&c===y.slice(0,1)&&(y=Ut(c.charCodeAt(0))+y.slice(1));const p=n.attentionEncodeSurroundingInfo;n.attentionEncodeSurroundingInfo=void 0,c=void 0,p&&(a.length>0&&p.before&&l===a[a.length-1].slice(-1)&&(a[a.length-1]=a[a.length-1].slice(0,-1)+Ut(l.charCodeAt(0))),p.after&&(c=d)),u.move(y),a.push(y),l=y.slice(-1)}return r.pop(),a.join("")}function Ip(e,n,t){const r=n.indexStack,s=e.children||[],a=n.createTracker(t),o=[];let l=-1;for(r.push(-1);++l<s.length;){const c=s[l];r[r.length-1]=l,o.push(a.move(n.handle(c,e,n,{before:`
`,after:`
`,...a.current()}))),c.type!=="list"&&(n.bulletLastUsed=void 0),l<s.length-1&&o.push(a.move($p(c,s[l+1],e,n)))}return r.pop(),o.join("")}function $p(e,n,t,r){let s=r.join.length;for(;s--;){const a=r.join[s](e,n,t,r);if(a===!0||a===1)break;if(typeof a=="number")return`
`.repeat(1+a);if(a===!1)return`

<!---->

`}return`

`}const Op=/\r?\n|\r/g;function Lp(e,n){const t=[];let r=0,s=0,a;for(;a=Op.exec(e);)o(e.slice(r,a.index)),t.push(a[0]),r=a.index+a[0].length,s++;return o(e.slice(r)),t.join("");function o(l){t.push(n(l,s,!l))}}function Rp(e,n,t){const r=(t.before||"")+(n||"")+(t.after||""),s=[],a=[],o={};let l=-1;for(;++l<e.unsafe.length;){const m=e.unsafe[l];if(!Co(e.stack,m))continue;const d=e.compilePattern(m);let y;for(;y=d.exec(r);){const p="before"in m||!!m.atBreak,E="after"in m,q=y.index+(p?y[1].length:0);s.includes(q)?(o[q].before&&!p&&(o[q].before=!1),o[q].after&&!E&&(o[q].after=!1)):(s.push(q),o[q]={before:p,after:E})}}s.sort(Fp);let c=t.before?t.before.length:0;const u=r.length-(t.after?t.after.length:0);for(l=-1;++l<s.length;){const m=s[l];m<c||m>=u||m+1<u&&s[l+1]===m+1&&o[m].after&&!o[m+1].before&&!o[m+1].after||s[l-1]===m-1&&o[m].before&&!o[m-1].before&&!o[m-1].after||(c!==m&&a.push(Ps(r.slice(c,m),"\\")),c=m,/[!-/:-@[-`{-~]/.test(r.charAt(m))&&(!t.encode||!t.encode.includes(r.charAt(m)))?a.push("\\"):(a.push(Ut(r.charCodeAt(m))),c++))}return a.push(Ps(r.slice(c,u),t.after)),a.join("")}function Fp(e,n){return e-n}function Ps(e,n){const t=/\\(?=[!-/:-@[-`{-~])/g,r=[],s=[],a=e+n;let o=-1,l=0,c;for(;c=t.exec(a);)r.push(c.index);for(;++o<r.length;)l!==r[o]&&s.push(e.slice(l,r[o])),s.push("\\"),l=r[o];return s.push(e.slice(l)),s.join("")}function zp(e){const n=e||{},t=n.now||{};let r=n.lineShift||0,s=t.line||1,a=t.column||1;return{move:c,current:o,shift:l};function o(){return{now:{line:s,column:a},lineShift:r}}function l(u){r+=u}function c(u){const m=u||"",d=m.split(/\r?\n|\r/g),y=d[d.length-1];return s+=d.length-1,a=d.length===1?a+y.length:1+y.length+r,m}}function qp(e,n){const t=n||{},r={associationId:Ep,containerPhrasing:Hp,containerFlow:Wp,createTracker:zp,compilePattern:Ap,enter:a,handlers:{...Cp},handle:void 0,indentLines:Lp,indexStack:[],join:[...Sp],options:{},safe:Vp,stack:[],unsafe:[...Pp]};jo(r,t),r.options.tightDefinitions&&r.join.push(Mp),r.handle=vo("type",{invalid:Bp,unknown:Up,handlers:r.handlers});let s=r.handle(e,void 0,r,{before:`
`,after:`
`,now:{line:1,column:1},lineShift:0});return s&&s.charCodeAt(s.length-1)!==10&&s.charCodeAt(s.length-1)!==13&&(s+=`
`),s;function a(o){return r.stack.push(o),l;function l(){r.stack.pop()}}}function Bp(e){throw new Error("Cannot handle value `"+e+"`, expected node")}function Up(e){const n=e;throw new Error("Cannot handle unknown node `"+n.type+"`")}function Mp(e,n){if(e.type==="definition"&&e.type===n.type)return 0}function Hp(e,n){return Dp(e,this,n)}function Wp(e,n){return Ip(e,this,n)}function Vp(e,n){return Rp(this,e,n)}function Jp(e){const n=this;n.compiler=t;function t(r){return qp(r,{...n.data("settings"),...e,extensions:n.data("toMarkdownExtensions")||[]})}}function Es(e){if(e)throw e}var pi,As;function Qp(){if(As)return pi;As=1;var e=Object.prototype.hasOwnProperty,n=Object.prototype.toString,t=Object.defineProperty,r=Object.getOwnPropertyDescriptor,s=function(u){return typeof Array.isArray=="function"?Array.isArray(u):n.call(u)==="[object Array]"},a=function(u){if(!u||n.call(u)!=="[object Object]")return!1;var m=e.call(u,"constructor"),d=u.constructor&&u.constructor.prototype&&e.call(u.constructor.prototype,"isPrototypeOf");if(u.constructor&&!m&&!d)return!1;var y;for(y in u);return typeof y>"u"||e.call(u,y)},o=function(u,m){t&&m.name==="__proto__"?t(u,m.name,{enumerable:!0,configurable:!0,value:m.newValue,writable:!0}):u[m.name]=m.newValue},l=function(u,m){if(m==="__proto__")if(e.call(u,m)){if(r)return r(u,m).value}else return;return u[m]};return pi=function c(){var u,m,d,y,p,E,q=arguments[0],G=1,O=arguments.length,B=!1;for(typeof q=="boolean"&&(B=q,q=arguments[1]||{},G=2),(q==null||typeof q!="object"&&typeof q!="function")&&(q={});G<O;++G)if(u=arguments[G],u!=null)for(m in u)d=l(q,m),y=l(u,m),q!==y&&(B&&y&&(a(y)||(p=s(y)))?(p?(p=!1,E=d&&s(d)?d:[]):E=d&&a(d)?d:{},o(q,{name:m,newValue:c(B,E,y)})):typeof y<"u"&&o(q,{name:m,newValue:y}));return q},pi}var Gp=Qp();const hi=pc(Gp);function Li(e){if(typeof e!="object"||e===null)return!1;const n=Object.getPrototypeOf(e);return(n===null||n===Object.prototype||Object.getPrototypeOf(n)===null)&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)}function Yp(){const e=[],n={run:t,use:r};return n;function t(...s){let a=-1;const o=s.pop();if(typeof o!="function")throw new TypeError("Expected function as last argument, not "+o);l(null,...s);function l(c,...u){const m=e[++a];let d=-1;if(c){o(c);return}for(;++d<s.length;)(u[d]===null||u[d]===void 0)&&(u[d]=s[d]);s=u,m?Kp(m,l)(...u):o(null,...u)}}function r(s){if(typeof s!="function")throw new TypeError("Expected `middelware` to be a function, not "+s);return e.push(s),n}}function Kp(e,n){let t;return r;function r(...o){const l=e.length>o.length;let c;l&&o.push(s);try{c=e.apply(this,o)}catch(u){const m=u;if(l&&t)throw m;return s(m)}l||(c&&c.then&&typeof c.then=="function"?c.then(a,s):c instanceof Error?s(c):a(c))}function s(o,...l){t||(t=!0,n(o,...l))}function a(o){s(null,o)}}class Xe extends Error{constructor(n,t,r){super(),typeof t=="string"&&(r=t,t=void 0);let s="",a={},o=!1;if(t&&("line"in t&&"column"in t?a={place:t}:"start"in t&&"end"in t?a={place:t}:"type"in t?a={ancestors:[t],place:t.position}:a={...t}),typeof n=="string"?s=n:!a.cause&&n&&(o=!0,s=n.message,a.cause=n),!a.ruleId&&!a.source&&typeof r=="string"){const c=r.indexOf(":");c===-1?a.ruleId=r:(a.source=r.slice(0,c),a.ruleId=r.slice(c+1))}if(!a.place&&a.ancestors&&a.ancestors){const c=a.ancestors[a.ancestors.length-1];c&&(a.place=c.position)}const l=a.place&&"start"in a.place?a.place.start:a.place;this.ancestors=a.ancestors||void 0,this.cause=a.cause||void 0,this.column=l?l.column:void 0,this.fatal=void 0,this.file="",this.message=s,this.line=l?l.line:void 0,this.name=zn(a.place)||"1:1",this.place=a.place||void 0,this.reason=this.message,this.ruleId=a.ruleId||void 0,this.source=a.source||void 0,this.stack=o&&a.cause&&typeof a.cause.stack=="string"?a.cause.stack:"",this.actual=void 0,this.expected=void 0,this.note=void 0,this.url=void 0}}Xe.prototype.file="";Xe.prototype.name="";Xe.prototype.reason="";Xe.prototype.message="";Xe.prototype.stack="";Xe.prototype.column=void 0;Xe.prototype.line=void 0;Xe.prototype.ancestors=void 0;Xe.prototype.cause=void 0;Xe.prototype.fatal=void 0;Xe.prototype.place=void 0;Xe.prototype.ruleId=void 0;Xe.prototype.source=void 0;const Nt={basename:Zp,dirname:Xp,extname:eh,join:th,sep:"/"};function Zp(e,n){if(n!==void 0&&typeof n!="string")throw new TypeError('"ext" argument must be a string');Un(e);let t=0,r=-1,s=e.length,a;if(n===void 0||n.length===0||n.length>e.length){for(;s--;)if(e.codePointAt(s)===47){if(a){t=s+1;break}}else r<0&&(a=!0,r=s+1);return r<0?"":e.slice(t,r)}if(n===e)return"";let o=-1,l=n.length-1;for(;s--;)if(e.codePointAt(s)===47){if(a){t=s+1;break}}else o<0&&(a=!0,o=s+1),l>-1&&(e.codePointAt(s)===n.codePointAt(l--)?l<0&&(r=s):(l=-1,r=o));return t===r?r=o:r<0&&(r=e.length),e.slice(t,r)}function Xp(e){if(Un(e),e.length===0)return".";let n=-1,t=e.length,r;for(;--t;)if(e.codePointAt(t)===47){if(r){n=t;break}}else r||(r=!0);return n<0?e.codePointAt(0)===47?"/":".":n===1&&e.codePointAt(0)===47?"//":e.slice(0,n)}function eh(e){Un(e);let n=e.length,t=-1,r=0,s=-1,a=0,o;for(;n--;){const l=e.codePointAt(n);if(l===47){if(o){r=n+1;break}continue}t<0&&(o=!0,t=n+1),l===46?s<0?s=n:a!==1&&(a=1):s>-1&&(a=-1)}return s<0||t<0||a===0||a===1&&s===t-1&&s===r+1?"":e.slice(s,t)}function th(...e){let n=-1,t;for(;++n<e.length;)Un(e[n]),e[n]&&(t=t===void 0?e[n]:t+"/"+e[n]);return t===void 0?".":nh(t)}function nh(e){Un(e);const n=e.codePointAt(0)===47;let t=rh(e,!n);return t.length===0&&!n&&(t="."),t.length>0&&e.codePointAt(e.length-1)===47&&(t+="/"),n?"/"+t:t}function rh(e,n){let t="",r=0,s=-1,a=0,o=-1,l,c;for(;++o<=e.length;){if(o<e.length)l=e.codePointAt(o);else{if(l===47)break;l=47}if(l===47){if(!(s===o-1||a===1))if(s!==o-1&&a===2){if(t.length<2||r!==2||t.codePointAt(t.length-1)!==46||t.codePointAt(t.length-2)!==46){if(t.length>2){if(c=t.lastIndexOf("/"),c!==t.length-1){c<0?(t="",r=0):(t=t.slice(0,c),r=t.length-1-t.lastIndexOf("/")),s=o,a=0;continue}}else if(t.length>0){t="",r=0,s=o,a=0;continue}}n&&(t=t.length>0?t+"/..":"..",r=2)}else t.length>0?t+="/"+e.slice(s+1,o):t=e.slice(s+1,o),r=o-s-1;s=o,a=0}else l===46&&a>-1?a++:a=-1}return t}function Un(e){if(typeof e!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}const ih={cwd:ah};function ah(){return"/"}function Ri(e){return!!(e!==null&&typeof e=="object"&&"href"in e&&e.href&&"protocol"in e&&e.protocol&&e.auth===void 0)}function sh(e){if(typeof e=="string")e=new URL(e);else if(!Ri(e)){const n=new TypeError('The "path" argument must be of type string or an instance of URL. Received `'+e+"`");throw n.code="ERR_INVALID_ARG_TYPE",n}if(e.protocol!=="file:"){const n=new TypeError("The URL must be of scheme file");throw n.code="ERR_INVALID_URL_SCHEME",n}return oh(e)}function oh(e){if(e.hostname!==""){const r=new TypeError('File URL host must be "localhost" or empty on darwin');throw r.code="ERR_INVALID_FILE_URL_HOST",r}const n=e.pathname;let t=-1;for(;++t<n.length;)if(n.codePointAt(t)===37&&n.codePointAt(t+1)===50){const r=n.codePointAt(t+2);if(r===70||r===102){const s=new TypeError("File URL path must not include encoded / characters");throw s.code="ERR_INVALID_FILE_URL_PATH",s}}return decodeURIComponent(n)}const mi=["history","path","basename","stem","extname","dirname"];class lh{constructor(n){let t;n?Ri(n)?t={path:n}:typeof n=="string"||ch(n)?t={value:n}:t=n:t={},this.cwd="cwd"in t?"":ih.cwd(),this.data={},this.history=[],this.messages=[],this.value,this.map,this.result,this.stored;let r=-1;for(;++r<mi.length;){const a=mi[r];a in t&&t[a]!==void 0&&t[a]!==null&&(this[a]=a==="history"?[...t[a]]:t[a])}let s;for(s in t)mi.includes(s)||(this[s]=t[s])}get basename(){return typeof this.path=="string"?Nt.basename(this.path):void 0}set basename(n){gi(n,"basename"),fi(n,"basename"),this.path=Nt.join(this.dirname||"",n)}get dirname(){return typeof this.path=="string"?Nt.dirname(this.path):void 0}set dirname(n){Ds(this.basename,"dirname"),this.path=Nt.join(n||"",this.basename)}get extname(){return typeof this.path=="string"?Nt.extname(this.path):void 0}set extname(n){if(fi(n,"extname"),Ds(this.dirname,"extname"),n){if(n.codePointAt(0)!==46)throw new Error("`extname` must start with `.`");if(n.includes(".",1))throw new Error("`extname` cannot contain multiple dots")}this.path=Nt.join(this.dirname,this.stem+(n||""))}get path(){return this.history[this.history.length-1]}set path(n){Ri(n)&&(n=sh(n)),gi(n,"path"),this.path!==n&&this.history.push(n)}get stem(){return typeof this.path=="string"?Nt.basename(this.path,this.extname):void 0}set stem(n){gi(n,"stem"),fi(n,"stem"),this.path=Nt.join(this.dirname||"",n+(this.extname||""))}fail(n,t,r){const s=this.message(n,t,r);throw s.fatal=!0,s}info(n,t,r){const s=this.message(n,t,r);return s.fatal=void 0,s}message(n,t,r){const s=new Xe(n,t,r);return this.path&&(s.name=this.path+":"+s.name,s.file=this.path),s.fatal=!1,this.messages.push(s),s}toString(n){return this.value===void 0?"":typeof this.value=="string"?this.value:new TextDecoder(n||void 0).decode(this.value)}}function fi(e,n){if(e&&e.includes(Nt.sep))throw new Error("`"+n+"` cannot be a path: did not expect `"+Nt.sep+"`")}function gi(e,n){if(!e)throw new Error("`"+n+"` cannot be empty")}function Ds(e,n){if(!e)throw new Error("Setting `"+n+"` requires `path` to be set too")}function ch(e){return!!(e&&typeof e=="object"&&"byteLength"in e&&"byteOffset"in e)}const uh=function(e){const r=this.constructor.prototype,s=r[e],a=function(){return s.apply(a,arguments)};return Object.setPrototypeOf(a,r),a},dh={}.hasOwnProperty;class Yi extends uh{constructor(){super("copy"),this.Compiler=void 0,this.Parser=void 0,this.attachers=[],this.compiler=void 0,this.freezeIndex=-1,this.frozen=void 0,this.namespace={},this.parser=void 0,this.transformers=Yp()}copy(){const n=new Yi;let t=-1;for(;++t<this.attachers.length;){const r=this.attachers[t];n.use(...r)}return n.data(hi(!0,{},this.namespace)),n}data(n,t){return typeof n=="string"?arguments.length===2?(bi("data",this.frozen),this.namespace[n]=t,this):dh.call(this.namespace,n)&&this.namespace[n]||void 0:n?(bi("data",this.frozen),this.namespace=n,this):this.namespace}freeze(){if(this.frozen)return this;const n=this;for(;++this.freezeIndex<this.attachers.length;){const[t,...r]=this.attachers[this.freezeIndex];if(r[0]===!1)continue;r[0]===!0&&(r[0]=void 0);const s=t.call(n,...r);typeof s=="function"&&this.transformers.use(s)}return this.frozen=!0,this.freezeIndex=Number.POSITIVE_INFINITY,this}parse(n){this.freeze();const t=hr(n),r=this.parser||this.Parser;return yi("parse",r),r(String(t),t)}process(n,t){const r=this;return this.freeze(),yi("process",this.parser||this.Parser),xi("process",this.compiler||this.Compiler),t?s(void 0,t):new Promise(s);function s(a,o){const l=hr(n),c=r.parse(l);r.run(c,l,function(m,d,y){if(m||!d||!y)return u(m);const p=d,E=r.stringify(p,y);mh(E)?y.value=E:y.result=E,u(m,y)});function u(m,d){m||!d?o(m):a?a(d):t(void 0,d)}}}processSync(n){let t=!1,r;return this.freeze(),yi("processSync",this.parser||this.Parser),xi("processSync",this.compiler||this.Compiler),this.process(n,s),$s("processSync","process",t),r;function s(a,o){t=!0,Es(a),r=o}}run(n,t,r){Is(n),this.freeze();const s=this.transformers;return!r&&typeof t=="function"&&(r=t,t=void 0),r?a(void 0,r):new Promise(a);function a(o,l){const c=hr(t);s.run(n,c,u);function u(m,d,y){const p=d||n;m?l(m):o?o(p):r(void 0,p,y)}}}runSync(n,t){let r=!1,s;return this.run(n,t,a),$s("runSync","run",r),s;function a(o,l){Es(o),s=l,r=!0}}stringify(n,t){this.freeze();const r=hr(t),s=this.compiler||this.Compiler;return xi("stringify",s),Is(n),s(n,r)}use(n,...t){const r=this.attachers,s=this.namespace;if(bi("use",this.frozen),n!=null)if(typeof n=="function")c(n,t);else if(typeof n=="object")Array.isArray(n)?l(n):o(n);else throw new TypeError("Expected usable value, not `"+n+"`");return this;function a(u){if(typeof u=="function")c(u,[]);else if(typeof u=="object")if(Array.isArray(u)){const[m,...d]=u;c(m,d)}else o(u);else throw new TypeError("Expected usable value, not `"+u+"`")}function o(u){if(!("plugins"in u)&&!("settings"in u))throw new Error("Expected usable value but received an empty preset, which is probably a mistake: presets typically come with `plugins` and sometimes with `settings`, but this has neither");l(u.plugins),u.settings&&(s.settings=hi(!0,s.settings,u.settings))}function l(u){let m=-1;if(u!=null)if(Array.isArray(u))for(;++m<u.length;){const d=u[m];a(d)}else throw new TypeError("Expected a list of plugins, not `"+u+"`")}function c(u,m){let d=-1,y=-1;for(;++d<r.length;)if(r[d][0]===u){y=d;break}if(y===-1)r.push([u,...m]);else if(m.length>0){let[p,...E]=m;const q=r[y][1];Li(q)&&Li(p)&&(p=hi(!0,q,p)),r[y]=[u,p,...E]}}}}const ph=new Yi().freeze();function yi(e,n){if(typeof n!="function")throw new TypeError("Cannot `"+e+"` without `parser`")}function xi(e,n){if(typeof n!="function")throw new TypeError("Cannot `"+e+"` without `compiler`")}function bi(e,n){if(n)throw new Error("Cannot call `"+e+"` on a frozen processor.\nCreate a new processor first, by calling it: use `processor()` instead of `processor`.")}function Is(e){if(!Li(e)||typeof e.type!="string")throw new TypeError("Expected node, got `"+e+"`")}function $s(e,n,t){if(!t)throw new Error("`"+e+"` finished async. Use `"+n+"` instead")}function hr(e){return hh(e)?e:new lh(e)}function hh(e){return!!(e&&typeof e=="object"&&"message"in e&&"messages"in e)}function mh(e){return typeof e=="string"||fh(e)}function fh(e){return!!(e&&typeof e=="object"&&"byteLength"in e&&"byteOffset"in e)}const wi=ph().use(zd).use(Jp).freeze(),gh=e=>{if(!e)return"Unknown Date";try{return new Date(e).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}catch{return"Invalid Date"}},yh=e=>{switch(e){case"pending":return{text:"Billing Pending",className:"status-badge status-pending"};case"billed":return{text:"Sample Pending",className:"status-badge status-billed"};case"collected":return{text:"Sample Collected",className:"status-badge status-collected"};case"processing":return{text:"Processing",className:"status-badge status-processing"};case"report_ready":return{text:"Report Ready",className:"status-badge status-report_ready"};case"reported":return{text:"Reported",className:"status-badge status-reported"};case"completed":return{text:"Completed",className:"status-badge status-completed"};case"cancelled":return{text:"Cancelled",className:"status-badge status-cancelled"};default:return{text:e,className:"status-badge"}}},xh=({title:e,items:n,renderItemContent:t,headerAction:r,isLoading:s,loadingText:a,noDataText:o,onDeleteItem:l,onEditLabOrder:c,onSaveLabOrder:u,onCancelEditLabOrder:m,onLabOrderTestChange:d,onLabOrderStatusChange:y,onEditPharmacyOrder:p,onPrintUnavailablePrescription:E,onBillLabOrder:q,onUpdateLabOrderStatus:G,onEnterLabReport:O,labInventory:B=[],isSavingLabOrder:I=!1,expandedLabReports:W={},toggleLabReport:F=()=>{},selectionEnabled:j=!1,selectedIds:X=new Set,onSelectionChange:le})=>{const ne=x.useMemo(()=>{const V={};n.forEach(C=>{if(isNaN(C.date.getTime())){V["Unknown Date"]||(V["Unknown Date"]=[]),V["Unknown Date"].push(C);return}const K=gh(C.originalDateString);V[K]||(V[K]=[]),V[K].push(C)});const _=Object.keys(V);return _.sort((C,K)=>{if(C==="Unknown Date")return 1;if(K==="Unknown Date")return-1;try{const A=new Date(C.split(" ").reverse().join(" ")),M=new Date(K.split(" ").reverse().join(" "));if(!isNaN(A.getTime())&&!isNaN(M.getTime()))return M.getTime()-A.getTime()}catch{}return K.localeCompare(C)}),_.map(C=>({date:C,items:V[C]}))},[n]),oe=["pending","billed","collected","processing","report_ready","completed","cancelled","reported"];return i.jsxs("div",{className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsx("h4",{className:"ai-context-section-title mb-2 pb-1",children:e}),r]}),s&&i.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(V=>i.jsxs("div",{style:{padding:"10px",background:"var(--glass-light)",borderRadius:"8px",marginBottom:"8px"},children:[i.jsx(Te,{width:"80px",height:"14px",style:{marginBottom:"10px"}}),i.jsx(Te,{width:"100%",height:"16px",style:{marginBottom:"6px"}}),i.jsx(Te,{width:"70%",height:"14px"})]},V))}),!s&&n.length===0&&i.jsx("p",{className:"ai-context-text italic",children:o}),!s&&n.length>0&&i.jsx("div",{className:"space-y-3",children:ne.map(({date:V,items:_})=>i.jsxs("div",{children:[i.jsx("h5",{className:"grouped-history-date",children:V}),i.jsx("div",{className:"space-y-1 grouped-history-item-container",children:_.map((C,K)=>i.jsxs("div",{className:"grouped-history-item ai-context-item flex flex-col",children:[!(C.type==="Lab Order"&&C.data.isEditing)&&i.jsxs("div",{className:"flex justify-between items-center w-full",children:[j&&le&&C.type==="Pharmacy Order"&&i.jsx("div",{className:"mr-2",children:i.jsx("input",{type:"checkbox",checked:X.has(C.data.id),onChange:A=>le(C.data.id,A.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),i.jsx("div",{className:"flex-grow mr-2 ai-context-text",children:t(C,K,W,F)}),i.jsxs("div",{className:"flex items-center space-x-1",children:[C.type==="Lab Order"&&!C.data.isEditing&&c&&i.jsx("button",{onClick:()=>c(C.data.id),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400",title:"Edit this lab order",disabled:I,children:i.jsx(gt,{size:14})}),C.type==="Lab Order"&&C.data.isEditing&&i.jsx(i.Fragment,{}),C.type==="Lab Order"&&i.jsxs("div",{className:"lab-table-actions",children:[C.data.status==="pending"&&q&&(()=>{const A=C.data.tests.reduce((M,J)=>M+(Number(J.price)||0),0).toFixed(2);return i.jsx("button",{onClick:()=>q(C.data),className:"text-green-600 hover:text-green-800 p-1 rounded hover:bg-green-100 focus:outline-none focus:ring-1 focus:ring-green-400",title:`Pay total of ₹${A}`,disabled:I,children:i.jsx(lo,{size:14})})})(),C.data.status==="billed"&&G&&i.jsx("button",{onClick:()=>G(C.data.id,"collected"),className:"lab-action-button btn-collect",title:"Collect Sample",children:"Collect"}),C.data.status==="collected"&&G&&i.jsx("button",{onClick:()=>G(C.data.id,"processing"),className:"lab-action-button btn-process",title:"Mark Processing",children:"Process"}),["pending","billed","collected","processing","report_ready","reported","completed"].includes(C.data.status)&&O&&i.jsx("button",{onClick:()=>O(C.data),className:"lab-action-button btn-enter-report",title:"Enter Report",children:"Enter Report"}),(C.data.status==="report_ready"||C.data.status==="reported")&&G&&i.jsx("button",{onClick:()=>G(C.data.id,"completed"),className:"lab-action-button btn-complete",title:"Mark Completed",children:"Complete"})]}),C.type==="Pharmacy Order"&&C.data.status==="pending"&&p&&i.jsx("button",{onClick:()=>p(C.data.id),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400",title:"Edit this pharmacy order",disabled:I,children:i.jsx(gt,{size:14})}),C.type==="Pharmacy Order"&&C.data.prescriptionForUnavailableDrugs&&E&&i.jsx("button",{onClick:()=>E(C.data.prescriptionForUnavailableDrugs,`Prescription for Order ${C.data.id}`),className:"text-purple-600 hover:text-purple-800 p-1 rounded hover:bg-purple-100 focus:outline-none focus:ring-1 focus:ring-purple-400",title:"Print Prescription for Unavailable Drugs",disabled:I,children:i.jsx(Rn,{size:14})}),C.type==="Pharmacy Order"&&C.data.status==="pending"&&l&&i.jsx("button",{onClick:()=>l({type:C.type,data:C.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400",title:"Delete this pending pharmacy order",disabled:I,children:i.jsx(yt,{size:14})}),l&&["Complaint","Lab Order","Lab Report"].includes(C.type)&&i.jsx("button",{onClick:()=>l({type:C.type,data:C.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400",title:`Delete this ${C.type.toLowerCase()}`,disabled:I,children:i.jsx(yt,{size:14})})]})]}),C.type==="Lab Order"&&C.data.isEditing&&i.jsxs("div",{className:"lab-order-edit-form w-full bg-gray-50 border rounded-md p-3",children:[i.jsxs("div",{className:"flex justify-between items-center mb-3",children:[i.jsx("h6",{className:"text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Edit Order"}),i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Status:"}),i.jsx("select",{value:C.data.editedStatus||C.data.status,onChange:A=>y&&y(C.data.id,A.target.value),className:"form-select text-xs py-1 pl-2 pr-6 rounded border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50",disabled:I,children:oe.map(A=>i.jsx("option",{value:A,children:A.replace(/_/g," ")},A))})]})]}),i.jsx("div",{className:"overflow-hidden border rounded-md bg-white mb-3",children:i.jsxs("table",{className:"w-full text-xs text-left",children:[i.jsx("thead",{className:"bg-gray-100 border-b",children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-2 px-3 font-medium text-gray-600",children:"Test Name"}),i.jsx("th",{className:"py-2 px-3 text-right font-medium text-gray-600 w-20",children:"Price"}),i.jsx("th",{className:"py-2 px-3 w-10"})]})}),i.jsxs("tbody",{className:"divide-y divide-gray-100",children:[C.data.editedTests.map((A,M)=>i.jsxs("tr",{className:"hover:bg-gray-50",children:[i.jsx("td",{className:"py-1 px-3",children:i.jsxs("select",{value:A.id,onChange:J=>{const Se=B.find(he=>String(he.id)===J.target.value);Se&&(d&&d(C.data.id,M,"id",Se.id),d&&d(C.data.id,M,"name",Se.name),d&&d(C.data.id,M,"price",Se.price))},className:"form-select w-full text-xs border-0 bg-transparent focus:ring-0 p-0",disabled:I,children:[i.jsx("option",{value:"",children:"Select Test"}),B.map(J=>i.jsx("option",{value:J.id,children:J.name},J.id))]})}),i.jsxs("td",{className:"py-1 px-3 text-right text-gray-700",children:["₹",A.price]}),i.jsx("td",{className:"py-1 px-3 text-center",children:i.jsx("button",{onClick:()=>{const J=C.data.editedTests.filter((Se,he)=>he!==M);d&&d(C.data.id,-1,"remove",J)},className:"text-red-400 hover:text-red-600 focus:outline-none",title:"Remove test",disabled:I,children:i.jsx(yt,{size:12})})})]},M)),C.data.editedTests.length===0&&i.jsx("tr",{children:i.jsx("td",{colSpan:3,className:"py-2 px-3 text-center italic text-gray-400",children:"No tests selected"})})]}),i.jsx("tfoot",{className:"bg-gray-50 border-t",children:i.jsx("tr",{children:i.jsx("td",{colSpan:3,className:"py-1 px-3",children:i.jsx("button",{onClick:()=>{d&&d(C.data.id,-1,"add",{id:"",name:"",price:0})},className:"text-blue-600 hover:text-blue-800 text-xs font-medium flex items-center py-1",disabled:I,children:"+ Add Test"})})})})]})}),i.jsxs("div",{className:"flex justify-end space-x-2 border-t border-gray-200 pt-3 mt-1",children:[i.jsx("button",{onClick:()=>m&&m(C.data.id),className:"px-3 py-1.5 rounded text-xs text-gray-600 hover:bg-white hover:text-gray-800 border border-transparent hover:border-gray-200 transition-colors",disabled:I,children:"Cancel"}),i.jsx("button",{onClick:()=>u&&u(C.data.id,C.data.editedTests,C.data.editedStatus),className:"px-3 py-1.5 rounded text-xs bg-blue-600 text-white hover:bg-blue-700 shadow-sm flex items-center space-x-1 transition-colors",disabled:I,children:I?i.jsx("span",{children:"Saving..."}):i.jsxs(i.Fragment,{children:[i.jsx(Xs,{size:12}),i.jsx("span",{children:"Save Changes"})]})})]})]})]},`${C.type}-${C.originalDateString}-${K}`))})]},V))})]})},ki=Pi.memo(xh),bh="_modalOverlay_i1kv7_3",wh="_modalContent_i1kv7_29",kh="_modalHeader_i1kv7_63",_h="_modalTitle_i1kv7_81",Nh="_modalCloseButton_i1kv7_95",vh="_modalBody_i1kv7_123",jh="_errorText_i1kv7_141",Ch="_formGroup_i1kv7_159",Sh="_inputField_i1kv7_185",Th="_searchResultsCard_i1kv7_229",Ph="_searchResultsList_i1kv7_257",Eh="_searchResultItem_i1kv7_269",Ah="_searchResultPrice_i1kv7_305",Dh="_selectedTestsCard_i1kv7_315",Ih="_selectedTestsHeader_i1kv7_335",$h="_noTestsMessage_i1kv7_353",Oh="_selectedTestsList_i1kv7_369",Lh="_selectedTestItem_i1kv7_381",Rh="_selectedTestName_i1kv7_405",Fh="_selectedTestPrice_i1kv7_417",zh="_removeTestButton_i1kv7_429",qh="_totalAmount_i1kv7_455",Bh="_modalFooter_i1kv7_473",Uh="_button_i1kv7_499",Mh="_buttonPrimary_i1kv7_517",Hh="_buttonSecondary_i1kv7_539",De={modalOverlay:bh,modalContent:wh,modalHeader:kh,modalTitle:_h,modalCloseButton:Nh,modalBody:vh,errorText:jh,formGroup:Ch,inputField:Sh,searchResultsCard:Th,searchResultsList:Ph,searchResultItem:Eh,searchResultPrice:Ah,selectedTestsCard:Dh,selectedTestsHeader:Ih,noTestsMessage:$h,selectedTestsList:Oh,selectedTestItem:Lh,selectedTestName:Rh,selectedTestPrice:Fh,removeTestButton:zh,totalAmount:qh,modalFooter:Bh,button:Uh,buttonPrimary:Mh,buttonSecondary:Hh},Wh=({isOpen:e,onClose:n,patientId:t,labInventory:r,fetchPendingLabOrdersData:s,isLoadingInventory:a=!1})=>{const[o,l]=x.useState([]),[c,u]=x.useState(""),[m,d]=x.useState([]),[y,p]=x.useState(null),[E,q]=x.useState(!1);eo(void 0,e?200:99999);const G=x.useMemo(()=>new to(r,{keys:["name","description"],threshold:.3}),[r]);x.useEffect(()=>{if(!c){d([]);return}const W=G.search(c).map(F=>F.item);d(W.slice(0,10))},[c,G]);const O=async()=>{if(!t){p("Patient ID is missing.");return}if(o.length===0){p("Please select at least one lab test.");return}q(!0),p(null);try{const W={patient_id:t,tests:o.map(j=>({id:j.id,name:j.name,price:j.price}))},F=await Y("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(W)});if(!F.ok){const j=await F.json().catch(()=>({}));throw new Error(j.message||`Failed to create lab order: ${F.statusText}`)}await F.json(),s(t),n(),l([]),u("")}catch(W){p(`Lab Order Creation Error: ${W.message}`)}finally{q(!1)}},B=W=>{if(o.some(F=>F.id===W.id)){p(`${W.name} is already in the order.`),setTimeout(()=>p(null),3e3),u(""),d([]);return}l(F=>[...F,{...W}]),u(""),d([])},I=W=>{l(F=>F.filter(j=>j.id!==W))};return e?i.jsx("div",{className:De.modalOverlay,children:i.jsxs("div",{className:De.modalContent,children:[i.jsxs("div",{className:De.modalHeader,children:[i.jsx("h3",{className:De.modalTitle,children:"Create New Lab Order"}),i.jsx("button",{onClick:n,className:De.modalCloseButton,children:i.jsx(gn,{size:20})})]}),i.jsxs("div",{className:De.modalBody,children:[y&&i.jsx("div",{className:De.errorText,children:y}),i.jsxs("div",{className:De.formGroup,style:{position:"relative"},children:[i.jsx("label",{htmlFor:"lab-test-search",children:"Add Lab Test"}),i.jsx("input",{type:"text",id:"lab-test-search",placeholder:"Search available lab tests...",value:c,onChange:W=>u(W.target.value),className:De.inputField}),c&&i.jsx("div",{className:De.searchResultsCard,children:a?i.jsx("div",{className:"p-2 space-y-2",children:[1,2,3].map(W=>i.jsxs("div",{className:"flex justify-between items-center py-2 px-3",children:[i.jsx(Te,{width:"60%",height:20}),i.jsx(Te,{width:"20%",height:20})]},W))}):m.length>0?i.jsx("ul",{className:De.searchResultsList,children:m.map(W=>i.jsxs("li",{onClick:()=>B(W),className:De.searchResultItem,children:[i.jsx("span",{children:W.name}),i.jsxs("span",{className:De.searchResultPrice,children:["(₹",parseFloat(String(W.price)).toFixed(2),")"]})]},W.id))}):i.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No tests found."})})]}),i.jsxs("div",{className:De.selectedTestsCard,children:[i.jsx("h4",{className:De.selectedTestsHeader,children:"Selected Tests"}),o.length===0?i.jsx("p",{className:De.noTestsMessage,children:"No tests added yet."}):i.jsx("ul",{className:De.selectedTestsList,children:o.map(W=>i.jsxs("li",{className:De.selectedTestItem,children:[i.jsx("span",{className:De.selectedTestName,children:W.name}),i.jsxs("span",{className:De.selectedTestPrice,children:["₹",parseFloat(String(W.price)).toFixed(2)]}),i.jsx("button",{type:"button",onClick:()=>I(String(W.id)),className:De.removeTestButton,title:"Remove Test",children:i.jsx(yt,{size:16})})]},W.id))})]}),o.length>0&&i.jsxs("div",{className:De.totalAmount,children:["Total: ₹",o.reduce((W,F)=>W+parseFloat(String(F.price)),0).toFixed(2)]})]}),i.jsxs("div",{className:De.modalFooter,children:[i.jsx("button",{type:"button",onClick:n,className:`${De.button} ${De.buttonSecondary}`,children:" Cancel "}),i.jsxs("button",{type:"button",onClick:O,disabled:o.length===0||E,className:`${De.button} ${De.buttonPrimary} ${o.length===0||E?De.buttonDisabled:""}`,children:[" ",E?"Saving...":"Create Lab Order"," "]})]})]})}):null},Vh=`You are an expert OPD (Outpatient Department) medical assistant for a Doctor in a clinic in India. You will receive all the medical data of the patient including complaints (history), labs, pharmacy orders, etc., along with their date and time. Your primary goal is to assist the doctor and analyze patient chief complaints (Co), provide a structured clinical assessment including lab test suggestions (Lx), differential diagnoses (Dx), and a treatment plan (Tx). You have access to tools (actions) to order lab tests and pharmacy items, and update patient details.



**1. Definitions:**
   - Co: Chief complaints
   - Pt: Patient (assume living in India)
   - Lx: Laboratory tests
   - Dx: Differential Diagnosis
   - Tx: Treatment Plan

**2. Workflow:**
   - Analyze Co, generate Lx, Dx, and Tx sections as described below.
   - **Prioritization for Orders:** Always prioritize using \`edit_pharmacy_order\` or \`edit_lab_order\` if there are existing pending orders for the patient, before considering \`create_pharmacy_order\` or \`create_lab_order\`.
   - using edit_lab_order edits the lab order with the given serial numnber use to add new tests to the existing order or remove the tests from existing order, marking the status affects all tests in the order not only the test,always use this tool if there are pending lab orders instead of creating new orders.
   - using edit_pharmacy_order edits the pharmacy order with the given serial numnber to add new items to the existing order, update existing items, or remove items (either by \`items_to_remove\` or by setting \`quantity\` to 0). Always use this tool if there are pending pharmacy orders instead of creating new orders.
   - using bill_lab_order will navigate the user to the billing page for the specific lab order. Use this when the user expresses intent to bill a lab order.
   - using create_and_bill_lab_order will create a new lab order and immediately bill it (navigating to the print/bill screen). Use this when the user says "create and bill", "order and bill", or similar for NEW tests.
   - using bill_pharmacy_order will bill an existing pharmacy order (identified by serial number).
   - using create_and_bill_pharmacy_order will create a new pharmacy order and immediately bill it. Use this when the user says "prescribe and bill", "order and bill meds", etc.
   - If your Lx section suggests tests from the inventory, use the \`create_lab_order\` action, but only for tests that are both clinically required and have not already been ordered or are still pending. Skip tests that are already ordered and in pending.
   - If your Tx section prescribes medications, use the \`create_pharmacy_order\` action — but only for medications that are clinically required and have not already been prescribed or are still pending. Skip medications that are already dispensed or already ordered.
   - If your Tx section prescribes medications that are *not* available in the inventory, use the \`prescription_for_unavailable_drugs\` parameter within the \`create_pharmacy_order\` action to specify the prescription details. **IMPORTANT:** This string MUST be a **Markdown table** with columns: 'Drug Name', 'Quantity', 'Dosage', 'Directions'. Do not use plain text.
   - When ordering pharmacy items, specify both \`pack_quantity\` (number of full packs) and \`loose_quantity\` (number of individual units). The system will handle the conversion based on the drug's pack size.
   - **Patient Details Management:** Always store or update patient name, age, sex, and phone number using the \`update_patient_details\` action. If patient name, age, or sex is received as 'New Patient - Direct Entry', 'N/A', or blank, treat it as missing data; if the user input provides anything resembling a name, age, or sex (e.g., shiva 25m, robin 50m, priya 19f), update them using the \`update_patient_details\` action. If details are missing, you can ask the user for the missing details using the \`ask_followup_question\` action.
   - Always update new complaints of the patient using the \`add_complaint_history\` action.
   - If you generate a concise summary of the patient's current situation based on the interaction and history, use the \`update_case_summary\` action to save it.
   - Remember, when you use \`update_case_summary\`, the previous case summary will be replaced by the new one, so you can use it like a short-term memory to store other stuff that **keeps changing**, like the current treatment plan, plan of action, active problems, or current vitals, etc.
   - When you use \`add_complaint_history\`, it will add the complaint to the previous ones. You will be given all the previous complaints back in every query, so you can use it to store other long-term facts that do **not change**, like the history of a chronic illness, surgical history, allergies, or social history, etc.
   - while placing or editing a pharmacy order make sure to set the \`pack_quantity\` and \`loose_quantity\` right.
   - Use the \`update_clinic_ai_memory\` action to store or update **various types of clinic-wide persistent information in a concise way**. This can include 'summaries of common patient encounters'+'summeries of previous **Clinic-wide AI Memory**'(e.g., 'Patient X, 50m, chronic gastritis, last visit YYYY-MM-DD, prescribed Z, follow-up in N days'+'**Clinic-wide AI Memory** summary'), notes on local health trends, common diagnostic patterns observed in the clinic, specific operational protocols. This memory is shared across all interactions for the clinic and helps tailor responses to its specific context over time.
    -   **Recurring Medications:**
        -   Use \`create_recurring_medication_order\` to add a new recurring medication.
        -   Use \`edit_recurring_medication_order\` to edit an existing recurring medication (using its serial number).
        -   Recurring medications are long-term prescriptions (e.g., for chronic conditions) that automatically re-order or remind.
    -   **Important: Preventing Loops** If you determine that no further actions are needed (e.g., you have already performed necessary actions, or the user's input does not require any specific action), you **MUST** use the \`end_task\` action. This explicitly signals that your task is complete and prevents the system from re-prompting you unnecessarily.
**3.**Multiple Actions:** You can perform multiple actions (like ordering labs AND meds, adding complaints, updating patient information, and asking a follow-up question) in a single response by including multiple action objects within the main JSON array.


**4. Chief Complaints (Co):**
   - Analyze the provided chief complaints.
   - Present them in a table with two columns: 'Relevant Complaint (Score 8-10)' and 'Irrelevant Complaint (Score 0-7)', based on clinical relevance.

**5. Lab Tests (Lx):**
   - Suggest the most probable basic lab tests based on the clinical picture, ordered by likelihood.
   - If a basic test is positive/abnormal, suggest relevant advanced tests.
   - **Inventory Check:** Compare suggested tests against the provided inventory list.
   - **Table 1: Available Lab Tests:** Present tests *available* in the inventory in a table with columns: '**Clinical Importance (High/Medium/Low)**', 'Lab Test'. If suggesting tests from this table, prepare to use the \`create_lab_order\` tool in your response.
   - **Table 2: Unavailable Lab Tests:** Present tests *not available* in the inventory in a separate table with columns: '**Clinical Importance (High/Medium/Low)**', 'Unavailable Basic Test'. Clearly state these are not orderable via the tool (generate Table 2 only when required tests are unavailable).

**6. Differential Diagnosis (Dx):**
   - List potential differential diagnoses.
   - Provide a confidence score (0-10) for each.
   - Present in a table with columns: 'Differential Diagnosis' and 'Confidence Score (0-10)'.

**7. Treatment Plan (Tx):**
   - Create a structured treatment plan including ideal medications based on the diagnosis.
   - **Inventory Check:** Compare prescribed medications against the provided inventory list.
   - **Table 1: Available Medications:** Present medications *available* in the inventory in a table with columns: 'Time Frame' (from and to dates), 'Treatment Goal', 'Intervention', 'Medication Type', 'Drug Form', 'Drug Name', 'Regimen (Dose, Freq)', 'Duration'. Before using the \`create_pharmacy_order\` tool, check if an order for the same drug has already been placed for this patient today. If an order already exists for today, do *not* create a duplicate order. If no order exists for today, prepare to use the \`create_pharmacy_order\` tool in your response.
   - **Table 2: Unavailable Medications:** Present medications *not available* in the inventory in a separate table with columns: 'Unavailable Drug Name', 'Ideal Regimen', 'Reasoning/Indication', '**Clinical Importance (High/Medium/Low)**', 'Suggested Available Substitute (from inventory, if possible)'. Clearly state these are not orderable via the tool (generate Table 2 only when required medications are unavailable in the inventory).

**8. Tools / Actions:**
   When you need to perform actions like ordering tests/meds, updating patient info, or adding history, use the following JSON array format. The response should ONLY contain this JSON array, nothing else.

   ****STRICT JSON****>>>>>>\`\`\`json
[
  { "action": "create_pharmacy_order", "items": [ { "name": "Drug Name", "pack_quantity": number, "loose_quantity": number, "tabletsPerDay": number | null, "numberOfDays": number | null, "directions_to_use": "string | null" } ], "prescription_for_unavailable_drugs": "string | null" },
  { "action": "edit_pharmacy_order", "serialNumber": number, "items": [ { "name": "Drug Name", "pack_quantity": number, "loose_quantity": number, "tabletsPerDay": number | null, "numberOfDays": number | null, "directions_to_use": "string | null" } ], "items_to_remove": [ { "drug_id": number | null, "name": "Drug Name" } ], "status": "pending" | "billed" | "dispensed" | "cancelled", "prescription_for_unavailable_drugs": "string | null" },
  { "action": "bill_pharmacy_order", "serialNumber": number },
  { "action": "create_and_bill_pharmacy_order", "items": [ { "name": "Drug Name", "pack_quantity": number, "loose_quantity": number, "tabletsPerDay": number | null, "numberOfDays": number | null, "directions_to_use": "string | null" } ], "prescription_for_unavailable_drugs": "string | null" },
  { "action": "create_lab_order", "tests": [ { "name": "Test Name" } ] },
  { "action": "edit_lab_order", "serialNumber": number, "tests": [ { "name": "Test Name" } ], "items_to_remove": [ { "id": number | string | null, "name": "Test Name" } ], "status": "pending" | "billed" | "collected" | "processing" | "report_ready" | "completed" | "cancelled" | "reported" },
  { "action": "create_lab_report", "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "edit_lab_report", "serialNumber": number, "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "create_lab_report", "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "edit_lab_report", "serialNumber": number, "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ] },
  { "action": "edit_lab_order_and_create_report", "serialNumber": number, "tests": [ { "name": "Test Name", "parameters": [{ "name": "Parameter Name", "value": "Value" }] } ], "items_to_remove": [ { "id": number | string | null, "name": "Test Name" } ] },
  { "action": "create_and_bill_lab_order", "tests": [ { "name": "Test Name" } ] },
  { "action": "add_complaint_history", "complaint": "Specific past complaint text..." },
  { "action": "update_patient_details", "name": "New Name (optional)", "age": number (optional), "gender": "M" | "F" | "O" | null (optional), "phone_number": "string (optional)" },
  { "action": "update_case_summary", "summary": "Concise summary text..." },
  { "action": "update_clinic_ai_memory", "memory_content": "New clinic-wide AI memory content..." },
  { "action": "create_recurring_medication_order", "items": [ { "medication_name": "Drug Name", "drug_id": "string | null", "quantity": number, "frequency_days": number, "next_delivery_date": "YYYY-MM-DD", "tablets_per_day": number | null, "number_of_days": number | null, "directions": "string | null", "notes": "string | null" } ] },
  { "action": "edit_recurring_medication_order", "serialNumber": number, "updates": { "medication_name": "string (opt)", "quantity": number, "frequency_days": number, "status": "active" | "paused" | "stopped", "next_delivery_date": "YYYY-MM-DD", "number_of_days": number, "tablets_per_day": number, "directions": "string" } },
  { "action": "end_task" }
]
\`\`\`

   - **Multiple Actions in One Response:** You can include multiple action objects within this single JSON array if several actions are required based on your analysis (e.g., adding history AND ordering labs).
   - **Prioritization Within the Array:** If including multiple actions, order them within the array according to this priority:
     1. \`add_complaint_history\`
     2. \`update_patient_details\`
     3. \`update_case_summary\`
     4. \`update_clinic_ai_memory\`
     5. \`create_lab_order\`
     6. \`edit_lab_order\`
     7. \`create_pharmacy_order\`
     8. \`edit_pharmacy_order\`
     9. \`bill_lab_order\`
   - **Structure:**
     The AI response can be a flat array of actions OR a list of "function call" objects containing grouped actions.
     **Option 1: Flat Array (Simple)**
     \`\`\`json
     [
       { "action": "add_complaint_history", ... },
       { "action": "create_lab_order", ... }
     ]
     \`\`\`
     **Option 2: Grouped Function Calls (Complex)**
     You can group actions under logical "function calls" if needed.
     \`\`\`json
     [
       {
         "function_call": "assess_patient",
         "actions": [
           { "action": "ask_followup_question", "question": "..." }
         ]
       },
       {
         "function_call": "prescribe_treatment",
         "actions": [
            { "action": "create_pharmacy_order", "items": [...] },
            { "action": "create_lab_order", "tests": [...] }
         ]
       }
     ]
     \`\`\`

   - **Example (Multiple Actions):**
     \`\`\`json
     [
       { "action": "add_complaint_history", "complaint": "Patient also reports mild fever since yesterday." },
       { "action": "create_lab_order", "tests": [ { "name": "CBC" } ] }
     ]
     \`\`\`

   - **\`ask_followup_question\`**: Use this action (either standalone or inside a group) only when you need clarification.
     \`\`\`json
     {
       "action": "ask_followup_question",
       "question": "Your clear, specific question here.",
       "options": ["Optional Answer 1", "Optional Answer 2"]
     }
     \`\`\`
     *Description:* Ask the user a question to gather additional information needed to complete the task. This tool should be used when you encounter ambiguities, need clarification, or require more details to proceed effectively. It allows for interactive problem-solving by enabling direct communication with the user. Use this tool judiciously to maintain a balance between gathering necessary information and avoiding excessive back-and-forth.
     *Parameters:*
       - question: (required) The question to ask the user. This should be a clear, specific question that addresses the information you need.
       - options: (optional) An array of 2-5 options for the user to choose from. Each option should be a string describing a possible answer. You may not always need to provide options, but it may be helpful in many cases where it can save the user from having to type out a response manually.
   - **\`bill_lab_order\`**: Use this action when the intention is to proceed to billing for a specific lab order.
     \`\`\`json
     { "action": "bill_lab_order", "serialNumber": number }
     \`\`\`
     *Description:* Initiates the billing process for a specific lab order, helping the user navigate to the billing screen.
     *Parameters:*
       - serialNumber: (required) The serial number of the lab order to bill.


**Important:**
- Ensure all tables are clearly formatted using Markdown.
- Strictly adhere to the inventory constraints for labs and medications when deciding whether to use \`create_lab_order\` or \`create_pharmacy_order\`.
- When using actions, provide ONLY the JSON array (or the single JSON object for \`ask_followup_question\`) as the *very last* part of your response, after all other content including tables. Do not include any other text after the JSON.

**Plan Mode:**
When the user asks a question about a patient's condition or general medical topics (not entering new medical data), respond in PLAN MODE. In this mode, focus on answering the user's inquiry, clarifying their request, brainstorming ideas, or architecting a solution (like exploring treatment options). Ask clarifying questions if needed. Present detailed plans or explanations **using clear table formats and markdown (like bolding) for easy readability**. Engage in back-and-back discussion to finalize details. Do not use action tools (\`create_lab_order\`, \`create_pharmacy_order\`, \`add_complaint_history\`, \`update_patient_details\`) while in PLAN MODE).`,Os="AIzaSyBEt7v-LxBxAKwpTCtkI-3IshYxdnEqbes",Jh="models/gemini-3-flash-preview";async function Qh(){if(!mc())return console.warn("No auth token found, using default Gemini API key."),Os;let n=null;try{const t=await Y("/api/clinics/settings");if(t.ok){const r=await t.json();r.gemini_api_key&&r.gemini_api_key.trim()!==""&&(n=r.gemini_api_key.trim())}}catch(t){console.warn("Could not fetch clinic settings (or key missing), proceeding to global fallback.",t)}if(n)return n;try{const t=await Y("/api/global-settings/app_gemini_api_key");if(t.ok){const s=(await t.json()).value;if(s&&s.trim()!=="")return s.trim()}}catch(t){console.warn("Could not fetch global API key.",t)}return console.warn("Clinic-specific and global Gemini API keys not found, using default env var."),Os}let _i=null;async function Gh(){if(!_i){const e=await Qh();_i=new hc({apiKey:e})}return _i}async function Yh(e,n){const{query:t,currentDateTime:r,patientName:s,patientAge:a,patientGender:o,case_summary:l,case_summary_last_updated:c,clinic_ai_memory:u,clinic_ai_memory_last_updated:m,clinic_wide_system_prompt:d,labHistory:y,pharmacyOrders:p,pastComplaints:E,pharmacyInventory:q,labInventory:G,recurringMedications:O}=e;let B=`Patient Complaint: ${t}`;if(l&&(B+=`

--- Case Summary (Provided by Doctor) ---
${l}`,c))try{const _=new Date(c).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"});B+=`
(Last Updated: ${_})`}catch{console.warn(`Could not format case_summary_last_updated: ${c}`),B+=`
(Last Updated: ${c})`}if(s&&(B+=`

Patient Name: ${s}`),a!=null&&(B+=`
Patient Age: ${a}`),o&&(B+=`
Patient Gender: ${o}`),r)try{const _=new Date(r).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"});B+=`

Current Interaction Time: ${_}`}catch{console.warn(`Could not format currentDateTime: ${r}`),B+=`

Current Interaction Time: ${r}`}if(u&&(B+=`

--- Clinic-wide AI Memory/Context ---
${u}`,m))try{const _=new Date(m).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"});B+=`
(Last Updated: ${_})`}catch{console.warn(`Could not format clinic_ai_memory_last_updated: ${m}`),B+=`
(Last Updated: ${m})`}let I="";y&&Array.isArray(y)&&y.length>0&&(I=`

--- Lab History (Orders & Reports) ---
`,y.forEach(_=>{let C="Unknown Date";try{C=new Date(_.orderDate).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date for lab order: ${_.orderDate}`)}if(I+=`
Order #${_.serialNumber} Date: ${C} (Status: ${_.status})
`,I+=`Tests: ${_.tests.map(K=>K.name).join(", ")}
`,_.report){let K="Unknown Date";try{K=new Date(_.report.reportDate).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date for lab report: ${_.report.reportDate}`)}I+=`  -> Report Date: ${K}
`,_.report.tests&&Array.isArray(_.report.tests)?(I+=`     Findings:
`,_.report.tests.forEach(A=>{I+=`       - Test: ${A.testName}
`,A.parameters&&Array.isArray(A.parameters)&&A.parameters.forEach(M=>{I+=`         - ${M.name}: ${M.value} (Normal: ${M.normal_range})
`})})):(I+=`     Findings: ${_.report.reportContent||"N/A"}
`,_.report.error&&(I+=`     Note: ${_.report.error}
`))}I+=`---
`}),B+=I);let W="";p&&Array.isArray(p)&&p.length>0&&(W=`

--- Recent Pharmacy Orders ---
`,p.forEach(_=>{let C="Unknown Date/Time";try{C=new Date(_.date).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date/time for pharmacy order: ${_.date}`)}W+=`
Order #${_.serialNumber} Date/Time: ${C} (Status: ${_.status})
`,W+=`Prescribed By: ${_.prescribedBy||"N/A"}
`,_.dispensedBy&&(W+=`Dispensed By: ${_.dispensedBy}
`),W+=`Medications:
`,_.medications.forEach(K=>{W+=`  - ${K.name} (Qty: ${K.quantity}`,K.tabletsPerDay&&(W+=`, ${K.tabletsPerDay}/day`),K.numberOfDays&&(W+=` for ${K.numberOfDays} days`),W+=`)
`}),_.prescriptionForUnavailableDrugs&&(W+=`  Prescription for Unavailable Drugs: ${_.prescriptionForUnavailableDrugs}
`),W+=`---
`}),B+=W);let F="";O&&Array.isArray(O)&&O.length>0&&(F=`

--- Recurring Medications (Active) ---
`,O.forEach((_,C)=>{let K=`${C+1}. ${_.medicationName} (${_.frequencyDays} days)`;if(_.tabletsPerDay&&(K+=` - ${_.tabletsPerDay} tabs/day`),_.numberOfDays&&(K+=` for ${_.numberOfDays} days`),K+=` [Status: ${_.status}]`,_.nextDeliveryDate)try{const A=new Date(_.nextDeliveryDate).toLocaleDateString();K+=` (Next: ${A})`}catch{}F+=`${K}
`}),B+=F);let j="";E&&Array.isArray(E)&&E.length>0&&(j=`

--- Past Complaints History ---
`,E.forEach(_=>{let C="Unknown Date/Time";try{C=new Date(_.createdAt).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}catch{console.warn(`Could not format date/time for past complaint: ${_.createdAt}`)}j+=`
Date/Time: ${C}
Complaint: ${_.complaint||"N/A"}
---
`}),B+=j);let X="";q&&Array.isArray(q)&&q.length>0&&(X=`

--- Current Pharmacy Inventory (Stock Levels) ---
`,q.forEach(_=>{let C=`${_.stock??0} packs`;_.loose!==void 0&&_.loose!==null&&_.loose>0&&(C+=`, ${_.loose} loose`);let K=`- ${_.name} (Pack: ${_.pack??"N/A"}): ${C}`;const A=[];_.brand_name&&A.push(`Brand: ${_.brand_name}`),_.batch&&A.push(`Batch: ${_.batch}`),_.expiry_date&&A.push(`Exp: ${_.expiry_date}`),A.length>0&&(K+=` [${A.join(", ")}]`),X+=`${K}
`}),B+=X);let le="";G&&Array.isArray(G)&&G.length>0&&(le=`

--- Available Lab Tests (with Parameters) ---
`,G.forEach(_=>{le+=`- ${_.name} (Price: ${_.price??"N/A"})
`,_.default_parameters&&Array.isArray(_.default_parameters)&&_.default_parameters.length>0&&_.default_parameters.forEach(C=>{let K=`    * ${C.name}`;C.unit&&(K+=` (${C.unit})`),C.normal_range?K+=` [Normal: ${C.normal_range}]`:C.lower_limit!==void 0&&C.upper_limit!==void 0&&C.lower_limit!==null&&C.upper_limit!==null&&(K+=` [Normal: ${C.lower_limit} - ${C.upper_limit}]`),le+=`${K}
`})}),B+=le);const ne=[{text:Vh}];d&&d.trim()!==""&&ne.push({text:`--- Additional Clinic-Specific Instructions ---
${d}`});const oe=[{text:B}];if(n){const _=new FileReader,C=await new Promise((K,A)=>{_.onloadend=()=>{typeof _.result=="string"?K(_.result.split(",")[1]):A(new Error("Failed to read image file as base64."))},_.onerror=A,_.readAsDataURL(n)});oe.push({inlineData:{mimeType:n.type,data:C}})}const V=[];ne.length>0&&V.push({role:"user",parts:ne}),V.push({role:"user",parts:oe});try{const _={model:Jh,contents:V,generationConfig:{temperature:.7,maxOutputTokens:1024,responseMimeType:"text/plain"}},K=await(await Gh()).models.generateContentStream(_);let A="";for await(const M of K)if(M&&typeof M.text=="function"){const J=M.text;J&&(A+=J)}else M&&M.candidates&&M.candidates[0]&&M.candidates[0].content&&M.candidates[0].content.parts&&M.candidates[0].content.parts[0]&&M.candidates[0].content.parts[0].text&&(A+=M.candidates[0].content.parts[0].text);if(A&&A.trim()!=="")return A.trim();throw console.error("Empty or invalid response received from Gemini API stream."),new Error("Failed to get suggestion from AI (Gemini). Empty or invalid stream response.")}catch(_){console.error("Error calling Gemini API:",_);let C="Failed to get suggestion from Gemini.";throw _.message&&(C=`Error processing Gemini request: ${_.message}`),new Error(C)}}const Ni=e=>{if(!e)return 1;const n=e.match(/(?:\d+x)?(\d+)(?:s|tabs)?/i);return n?parseInt(n[1],10):1},Kh=x.forwardRef(({recordId:e,patientId:n,patientDetails:t,caseSummary:r,caseSummaryUpdatedAt:s,clinicSettings:a,userMessages:o,selectedImageFile:l,pendingLabOrders:c,labReports:u,pastComplaints:m,pharmacyOrders:d,pharmacyInventory:y,labInventory:p,recurringMedications:E,currentComplaint:q,setCurrentComplaint:G,setAiResponse:O,setAiResponseText:B,setAiResponseJsonString:I,setShowAiJsonDetails:W,setIsLoadingAi:F,setAiError:j,setIsSubmittingAiOrder:X,setAiOrderSubmissionStatus:le,setIsSubmittingAiLabOrder:ne,setAiLabOrderSubmissionStatus:oe,setIsSubmittingAiComplaint:V,setAiComplaintSubmissionStatus:_,setIsUpdatingCaseSummary:C,setAiCaseSummaryUpdateStatus:K,setCaseSummary:A,setIsUpdatingAiMemoryByAI:M,setAiMemoryUpdateByAIStatus:J,setFollowUpQuestion:Se,setFollowUpOptions:he,setError:w,setIsSavingAiResponse:ze,setSaveAiResponseError:ke,fetchPharmacyOrdersData:b,fetchPendingLabOrdersData:Ie,fetchLabReportsData:We,fetchRecurringMedicationsData:_e,fetchPastComplaintsData:st,fetchPatientDetails:Fe,setClinicSettings:tt,setEditedAiMemory:ot,setCanUndo:nt,onAiActionSuccess:Kt,addMessage:v,onPrintLabBill:Ot,onPrintPharmacyBill:Ct},Zt)=>{const[mt,xt]=Pi.useState(null);Pi.useEffect(()=>{nt(!!mt)},[mt,nt]);let Qe;const St=async(Le,T,P,S=0)=>{let ee;const Re=["AI response did not contain a recognized function call","AI response did not result in a recognized or performed function call"].some(He=>{var je;return(je=T.message)==null?void 0:je.includes(He)});P&&Re?ee=`AI Error: ${T.message}

${P}`:(ee=`I encountered a frontend error while trying to execute the '${Le}' function. The error message is: "${T.message}". Based on this error, please analyze what went wrong and either correct the function call and try again, or explain the problem.`,(Le==="create_pharmacy_order"||Le==="edit_pharmacy_order")&&(ee+=`

IMPORTANT: When ordering medication, please first check if the medication ordered matches the exact name given in the inventory. If the name itself is not given in the inventory, you can use 'prescription_for_unavailable_drugs' to write a prescription. **NOTE:** This field MUST be formatted as a Markdown table (columns: Drug Name, Quantity, Dosage, Directions).`),P&&(ee+=`

The original AI response that caused the error was:
\`\`\`
${P}
\`\`\``)),v==null||v({role:"system",type:"error",content:`AI Error: ${T.message}. Retrying...`}),await Qe(ee,S+1)},Ht=async Le=>{console.log("Executing Rollback for actions:",Le);for(const T of Le){const{actionType:P,undoData:S}=T;if(console.log(`Attempting to rollback ${P}`,S),!S){console.warn(`No undoData found for action ${P}, skipping.`);continue}try{if(P==="create_pharmacy_order")S!=null&&S.orderId?(console.log(`Deleting pharmacy order ${S.orderId}`),await Y(`/api/pharmacy-orders/${S.orderId}`,{method:"DELETE"}),b(n)):console.error("Missing orderId for create_pharmacy_order rollback");else if(P==="create_lab_order")S!=null&&S.orderId?(console.log(`Deleting lab order ${S.orderId}`),await Y(`/api/lab/orders/${S.orderId}`,{method:"DELETE"}),Ie(n)):console.error("Missing orderId for create_lab_order rollback");else if(P==="update_patient_details")if(S!=null&&S.patientId&&(S!=null&&S.originalDetails)){console.log(`Reverting patient details for ${S.patientId}`);const ee=S.originalDetails,ce={name:ee.name,age:ee.age,gender:ee.gender,phone:ee.phone,ai_response:ee.ai_response};await Y(`/api/patients/${S.patientId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ce)}),Fe(S.patientId)}else console.error("Missing patientId or originalDetails for update_patient_details rollback");else if(P==="add_complaint_history")S!=null&&S.recordId?(console.log(`Reverting complaint history for ${S.recordId}`),await Y(`/api/queue/doctor/complaint/${S.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:S.originalComplaint||""})}),G(S.originalComplaint||"")):console.error("Missing recordId for add_complaint_history rollback");else if(P==="update_case_summary")S!=null&&S.recordId?(console.log(`Reverting case summary for ${S.recordId}`),await Y(`/api/queue/doctor/complaint/${S.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({case_summary:S.originalSummary||""})}),A(S.originalSummary||"")):console.error("Missing recordId for update_case_summary rollback");else if(P==="update_clinic_ai_memory")(S==null?void 0:S.originalMemory)!==void 0?(console.log("Reverting AI memory"),await Y("/api/clinics/settings",{method:"PUT",body:JSON.stringify({...a,aiMemory:S.originalMemory})}),ot(S.originalMemory)):console.error("Missing originalMemory for update_clinic_ai_memory rollback");else if(P==="edit_pharmacy_order")if(S!=null&&S.orderId&&(S!=null&&S.originalState)){console.log(`Reverting pharmacy order ${S.orderId}`);const ee={items:S.originalState.medications||[],status:S.originalState.status,prescription_for_unavailable_drugs:S.originalState.prescription_for_unavailable_drugs,order_total:S.originalState.order_total};await Y(`/api/pharmacy-orders/${S.orderId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ee)}),b(n)}else console.error("Missing orderId or originalState for edit_pharmacy_order rollback");else if(P==="edit_lab_order")if(S!=null&&S.orderId&&(S!=null&&S.originalState)){console.log(`Reverting lab order ${S.orderId}`);const ee={tests:S.originalState.tests,status:S.originalState.status};await Y(`/api/lab/orders/${S.orderId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ee)}),Ie(n)}else console.error("Missing orderId or originalState for edit_lab_order rollback");else if(P==="create_recurring_medication_order")if(S!=null&&S.createdIds&&S.createdIds.length>0){console.log(`Deleting recurring medications: ${S.createdIds.join(", ")}`);for(const ee of S.createdIds)await Y(`/api/recurring-medications/${ee}`,{method:"DELETE"});n&&_e&&_e(n)}else console.error("Missing createdIds for create_recurring_medication_order rollback");else P==="edit_recurring_medication_order"?S!=null&&S.medicationId&&(S!=null&&S.originalState)?(console.log(`Reverting recurring medication ${S.medicationId}`),await Y(`/api/recurring-medications/${S.medicationId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(S.originalState)}),n&&_e&&_e(n)):console.error("Missing medicationId or originalState for edit_recurring_medication_order rollback"):console.warn(`Unknown action type for rollback: ${P}`)}catch(ee){console.error(`Failed to rollback ${P}:`,ee)}}},Xt=async()=>{!mt||!window.confirm("Are you sure you want to undo the last AI actions?")||(F(!0),await Ht([...mt].reverse()),xt(null),F(!1),j("Last actions undone successfully."))},Ve=async(Le,T)=>{xt(null),le(null),oe(null),_(null),K(null),J(null),Se(null),he([]),w(null);let P=null;const S=/```json\s*([\s\S]*?)\s*```/,ee=Le.match(S);if(ee&&ee[1])P=ee[1];else{const ce=Le.trim();if(ce.startsWith("{")&&ce.endsWith("}"))P=ce;else if(ce.startsWith("[")&&ce.endsWith("]"))P=ce;else throw new Error("AI response did not contain a recognized function call.")}if(P)try{const ce=JSON.parse(P),Re=D=>{const z=[],L=Array.isArray(D)?D:[D];for(const $ of L)$&&($.actions&&Array.isArray($.actions)?z.push(...Re($.actions)):$.sub_actions&&Array.isArray($.sub_actions)?z.push(...Re($.sub_actions)):$.function_calls&&Array.isArray($.function_calls)?z.push(...Re($.function_calls)):typeof $.action=="string"&&z.push($));return z},He=Re(ce),je=[];let Je=null,Ge=!1;for(const D of He){if(D.action==="ask_followup_question"){Je=D,Ge=!0;continue}Ge=!0;const z=D.action;if(z==="update_clinic_ai_memory"&&typeof D.memory_content=="string")je.push((async()=>{M(!0),J("Processing AI mem..."),v==null||v({role:"system",type:"loading",content:"Processing AI memory..."});const L=(a==null?void 0:a.aiMemory)||"";try{if(!a)throw new Error("Clinic settings not loaded.");const $={...a,aiMemory:D.memory_content.trim(),admissionCharge:a.admissionCharge,perDayCharge:a.perDayCharge,otherCharges:a.otherCharges,clinicWideSystemPrompt:a.clinicWideSystemPrompt},ie=await Y("/api/clinics/settings",{method:"PUT",body:JSON.stringify($)});if(!ie.ok){const R=await ie.json().catch(()=>({}));throw new Error(R.message||`AI-triggered clinic memory update failed: ${ie.statusText}`)}const re=await ie.json();return tt(R=>R?{...R,aiMemory:re.settings.aiMemory}:null),ot(re.settings.aiMemory||""),J("AI mem updated!"),v==null||v({role:"system",type:"success",content:"AI memory updated successfully."}),{success:!0,actionType:z,undoData:{originalMemory:L}}}catch($){return J("Failed"),{success:!1,actionType:z,error:$,originalActionPayload:D}}finally{M(!1)}})());else if(z==="create_pharmacy_order")je.push((async()=>{var L,$;X(!0),le("Processing order..."),v==null||v({role:"system",type:"loading",content:"Processing pharmacy order..."});try{if(!n)throw new Error("Missing patient ID.");const ie=[];let re=null;if(Array.isArray(D.items))for(const ae of D.items){let fe;if(ae.drug_id?fe=y.find(Ee=>Ee.id===ae.drug_id):ae.name&&(fe=$t(ae.name,y)),!fe){re=`Drug "${ae.name||ae.drug_id}" not found.`;break}const de=Ni(fe.pack),H=Number(fe.mrp),Z=H,xe=de>0?H/de:0,Be=Number(ae.pack_quantity)||0,se=Number(ae.loose_quantity)||0,ve=Be*Z+se*xe;ie.push({drug_id:String(fe.id),name:fe.name,pack_quantity:Be,loose_quantity:se,tabletsPerDay:ae.tabletsPerDay,numberOfDays:ae.numberOfDays,directions_to_use:ae.directions_to_use,group_id:ae.group_id,pack_price:Z,loose_price:xe,total_price:ve,price:H,isLoose:ae.isLoose,unit:fe.pack})}if(re)throw new Error(re);const R=ie.reduce((ae,fe)=>ae+fe.total_price,0),me={patient_id:n,items:ie,prescription_for_unavailable_drugs:D.prescription_for_unavailable_drugs,order_total:parseFloat(R.toFixed(2))},Ce=await Y("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(me)});if(!Ce.ok){const ae=await Ce.json().catch(()=>({}));throw new Error(ae.message||"Order creation failed.")}const ye=await Ce.json();return le("Order created!"),b(n),v==null||v({role:"system",type:"success",content:"Pharmacy order created successfully."}),{success:!0,actionType:z,data:ye,undoData:{orderId:(($=(L=ye.orders)==null?void 0:L[0])==null?void 0:$.id)||ye.id}}}catch(ie){return v==null||v({role:"system",type:"error",content:`Pharmacy order failed: ${ie.message}`}),{success:!1,actionType:z,error:ie,originalActionPayload:D}}finally{X(!1)}})());else if(z==="bill_pharmacy_order")je.push((async()=>{X(!0),le("Billing Pharmacy Order...");try{const L=D.serialNumber;if(!L)throw new Error("Missing serial number for billing.");if(!n)throw new Error("Missing patient ID.");const $=new Map;(d??[]).forEach(H=>$.set(H.id,{...H}));const ie=Array.from($.values()).sort((H,Z)=>new Date(Z.date).getTime()-new Date(H.date).getTime()),re=ie.length-L,R=ie[re];if(!R)throw new Error(`Pharmacy order #${L} not found.`);if(R.status==="billed"||R.status==="dispensed")throw new Error(`Order #${L} is already billed.`);const me=R.medications.map(H=>{let Z;H.drug_id?Z=y.find(Ye=>String(Ye.id)===String(H.drug_id)):Z=y.find(Ye=>Ye.name.toLowerCase()===H.name.toLowerCase());const xe=Number(H.pack_price)||Number(Z==null?void 0:Z.mrp)||0,Be=Ni(H.unit||(Z==null?void 0:Z.pack)),se=Number(H.loose_price)||(Be>0?xe/Be:0),ve=(H.pack_quantity||0)*Be+(H.loose_quantity||0);let Ee=Number(H.total_price);return Ee||(Ee=ve*se),{...H,price:Ee,mrp:xe,pack_quantity:H.pack_quantity,loose_quantity:H.loose_quantity,expiry_date:H.expiry_date||(Z==null?void 0:Z.expiry_date),batch:H.batch||(Z==null?void 0:Z.box_number)}}),Ce=me.reduce((H,Z)=>H+Z.price,0),ye=Ce,ae={patientId:n,queueId:R.id,items:me.map(H=>({name:H.name,pack_quantity:H.pack_quantity,loose_quantity:H.loose_quantity,price:H.mrp,pack_price:H.mrp,loose_price:H.loose_price,total:H.price,drug_id:H.drug_id,discount_percentage:0,batch:H.batch,expiry_date:H.expiry_date})),amount:ye,paymentMode:"cash",type:"pharmacy",related_id:R.id,status:"paid",discountPercentage:0},fe=await Y("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)}),de=await fe.json();if(!fe.ok)throw new Error(de.message||"Failed to create pharmacy bill");return await Y(`/api/pharmacy-orders/${R.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:de.id,medications:me})}),le("Billed Successfully!"),b(n),Ct&&Ct({billId:de.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:R.date,items:me,subtotal:Ce,totalDiscount:0,grandTotal:ye,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||""}),v==null||v({role:"system",type:"success",content:`Pharmacy order #${R.id} billed.`}),{success:!0,actionType:z,data:de}}catch(L){return v==null||v({role:"system",type:"error",content:`Billing failed: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{X(!1)}})());else if(z==="create_and_bill_pharmacy_order")je.push((async()=>{X(!0),le("Processing & Billing..."),v==null||v({role:"system",type:"loading",content:"Prescribing and billing..."});let L=null;try{if(!n)throw new Error("Missing patient ID.");const $=[];let ie=null;if(Array.isArray(D.items))for(const Z of D.items){let xe;if(Z.drug_id?xe=y.find(ct=>ct.id===Z.drug_id):Z.name&&(xe=$t(Z.name,y)),!xe){ie=`Drug "${Z.name}" not found.`;break}const Be=Ni(xe.pack),se=Number(xe.mrp),ve=se,Ee=Be>0?se/Be:0,Ye=Number(Z.pack_quantity)||0,lt=Number(Z.loose_quantity)||0,bt=Ye*ve+lt*Ee;$.push({drug_id:String(xe.id),name:xe.name,pack_quantity:Ye,loose_quantity:lt,tabletsPerDay:Z.tabletsPerDay,numberOfDays:Z.numberOfDays,directions_to_use:Z.directions_to_use,group_id:Z.group_id,pack_price:ve,loose_price:Ee,total_price:bt,price:se,mrp:se,isLoose:Z.isLoose,unit:xe.pack,batch:xe.box_number,expiry_date:xe.expiry_date})}if(ie)throw new Error(ie);const re=$.reduce((Z,xe)=>Z+xe.total_price,0),R={patient_id:n,items:$,prescription_for_unavailable_drugs:D.prescription_for_unavailable_drugs,order_total:parseFloat(re.toFixed(2))},me=await Y("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(R)});if(!me.ok)throw new Error("Order creation failed.");const Ce=await me.json(),ye=Ce.orders?Ce.orders[0]:Ce;L=ye.id;const ae=re,fe={patientId:n,queueId:ye.id,items:$.map(Z=>({name:Z.name,pack_quantity:Z.pack_quantity,loose_quantity:Z.loose_quantity,price:Z.mrp,pack_price:Z.mrp,loose_price:Z.loose_price,total:Z.total_price,drug_id:Z.drug_id,discount_percentage:0,batch:Z.batch,expiry_date:Z.expiry_date})),amount:ae,paymentMode:"cash",type:"pharmacy",related_id:ye.id,status:"paid",discountPercentage:0},de=await Y("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(fe)}),H=await de.json();if(!de.ok)throw new Error("Billing failed.");return await Y(`/api/pharmacy-orders/${ye.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:H.id,medications:$})}),le("Ordered & Billed!"),b(n),Ct&&Ct({billId:H.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:new Date().toISOString(),items:$.map(Z=>({...Z,price:Z.total_price})),subtotal:ae,totalDiscount:0,grandTotal:ae,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||""}),v==null||v({role:"system",type:"success",content:`Pharmacy order #${ye.id} created and billed.`}),{success:!0,actionType:z,data:ye,undoData:{orderId:ye.id}}}catch($){return v==null||v({role:"system",type:"error",content:`Create & Bill failed: ${$.message}`}),{success:!1,actionType:z,error:$,originalActionPayload:D,undoData:L?{orderId:L}:void 0}}finally{X(!1)}})());else if(z==="update_patient_details")je.push((async()=>{F(!0),v==null||v({role:"system",type:"loading",content:"Updating patient details..."});const L={...t};try{if(!n)throw new Error("Missing patient ID.");const $={};if(D.name&&($.name=D.name),D.age&&($.age=D.age),D.gender&&($.gender=D.gender),D.phone_number!==void 0&&($.phone_number=D.phone_number),!(await Y(`/api/patients/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify($)})).ok)throw new Error("Patient update failed.");return Fe(n),v==null||v({role:"system",type:"success",content:"Patient details updated."}),{success:!0,actionType:z,undoData:{patientId:n,originalDetails:L}}}catch($){return{success:!1,actionType:z,error:$,originalActionPayload:D}}finally{F(!1)}})());else if(z==="create_lab_order")je.push((async()=>{ne(!0),oe("Processing lab..."),v==null||v({role:"system",type:"loading",content:"Processing lab order..."});try{if(!n)throw new Error("Missing patient ID.");const L=[];for(const re of D.tests||[]){let R;if(re.id?R=p.find(me=>String(me.id)===String(re.id)):re.name&&(R=$t(re.name,p)),!R)throw new Error(`Lab test "${re.name}" not found.`);L.push({id:R.id,name:R.name,price:Number(R.price)})}const $=await Y("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,tests:L})});if(!$.ok)throw new Error("Lab order creation failed.");const ie=await $.json();return oe("Success!"),Ie(n),v==null||v({role:"system",type:"success",content:"Lab order created."}),{success:!0,actionType:z,data:ie.labOrder,undoData:{orderId:ie.labOrder.id}}}catch(L){return v==null||v({role:"system",type:"error",content:`Lab order failed: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="create_and_bill_lab_order")je.push((async()=>{ne(!0),oe("Processing & Billing..."),v==null||v({role:"system",type:"loading",content:"Creating and billing lab order..."});let L=null;try{if(!n)throw new Error("Missing patient ID.");const $=[];for(const H of D.tests||[]){let Z;if(H.id?Z=p.find(xe=>String(xe.id)===String(H.id)):H.name&&(Z=$t(H.name,p)),!Z)throw new Error(`Lab test "${H.name}" not found.`);$.push({id:Z.id,name:Z.name,price:Number(Z.price)})}const ie=await Y("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,tests:$})});if(!ie.ok)throw new Error("Lab order creation failed.");const R=(await ie.json()).labOrder;L=R.id,v==null||v({role:"system",type:"loading",content:`Order #${R.id} created. Generating bill...`});const me=$.map(H=>({name:H.name,price:typeof H.price=="string"?parseFloat(H.price):H.price||0,discount_percentage:0,quantity:1,item_id:H.id,type:"lab_test"})),Ce=me.reduce((H,Z)=>H+Z.price,0),ye=Ce,ae={patientId:n,items:me.map(H=>({...H,total:H.price})),amount:ye,paymentMode:"cash",type:"lab",related_id:R.id,status:"paid",discountPercentage:0},fe=await Y("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)}),de=await fe.json();if(!fe.ok)throw new Error(de.message||"Failed to create bill");return await Y(`/api/lab/${R.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:de.id})}),oe("Success & Billed!"),Ie(n),Ot&&Ot({billId:de.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:R.createdAt,items:me,subtotal:Ce,totalDiscount:0,grandTotal:ye,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||"",labLetterheadUrl:a==null?void 0:a.labLetterheadUrl}),v==null||v({role:"system",type:"success",content:`Lab order #${R.id} created and billed. Opening print dialog.`}),{success:!0,actionType:z,data:R,undoData:{orderId:R.id}}}catch($){return v==null||v({role:"system",type:"error",content:`Create and Bill failed: ${$.message}`}),{success:!1,actionType:z,error:$,originalActionPayload:D,undoData:L?{orderId:L}:void 0}}finally{ne(!1)}})());else if(z==="create_lab_report")je.push((async()=>{ne(!0),oe("Creating Report..."),v==null||v({role:"system",type:"loading",content:"Creating lab report..."});try{if(!n)throw new Error("Missing patient ID.");const L=[],$=D.tests||[];for(const ye of $){let ae;if(ye.id?ae=p.find(fe=>String(fe.id)===String(ye.id)):ye.name&&(ae=$t(ye.name,p)),!ae)throw new Error(`Lab test "${ye.name}" not found.`);ye._matchedTest=ae,L.push({id:ae.id,name:ae.name,price:Number(ae.price)})}const ie=await Y("/api/lab",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,tests:L,status:"reported"})});if(!ie.ok)throw new Error("Lab order creation failed during report generation.");const re=await ie.json(),R=re.labOrder.id,me={};if($.forEach(ye=>{const ae=ye._matchedTest,fe=ae.id,de=ye.parameters||[],H={},Z=ae.default_parameters||[];for(const xe of Z){const Be=de.find(se=>{if(!se.name)return!1;if(se.name.toLowerCase()===xe.name.toLowerCase())return!0;const ve=se.name.toLowerCase(),Ee=xe.name.toLowerCase();return ve.includes(Ee)||Ee.includes(ve)});Be&&Be.value!==void 0?H[xe.name]=Be.value:xe.defaultValue!==void 0&&xe.defaultValue!==null&&(H[xe.name]=xe.defaultValue)}me[fe]=H}),!(await Y(`/api/lab/${R}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(me)})})).ok)throw new Error("Report submission failed.");return oe("Report Created!"),Ie(n),We(n),v==null||v({role:"system",type:"success",content:"Lab report created successfully."}),{success:!0,actionType:z,data:re.labOrder,undoData:{orderId:R}}}catch(L){return v==null||v({role:"system",type:"error",content:`Lab report failed: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="edit_lab_report")je.push((async()=>{ne(!0),oe("Updating Report...");try{const L=D.serialNumber;if(!L)throw new Error("Missing serial number for lab report edit.");const $=new Map;(c??[]).forEach(de=>$.set(de.id,{...de})),(u??[]).forEach(de=>{if($.has(de.id)){const H=$.get(de.id);H.report=de,H.status=de.status}else $.set(de.id,{...de,createdAt:de.createdAt})});const ie=Array.from($.values());ie.sort((de,H)=>new Date(H.createdAt).getTime()-new Date(de.createdAt).getTime());const re=ie.length-L,R=ie[re];if(!R)throw new Error(`Lab report #${L} not found.`);const me=R.id;let Ce={};if(R.report&&R.report.report_content)try{Ce=typeof R.report.report_content=="string"?JSON.parse(R.report.report_content):R.report.report_content}catch{}const ye={...Ce};if((D.tests||[]).forEach(de=>{let Z=(R.tests||[]).find(Ee=>Ee.name.toLowerCase()===de.name.toLowerCase());if(!Z)return;const xe=Z.id,Be=de.parameters||[],se=p.find(Ee=>String(Ee.id)===String(xe)),ve=(se==null?void 0:se.default_parameters)||[];ye[xe]||(ye[xe]={});for(const Ee of ve){const Ye=Be.find(lt=>{if(!lt.name)return!1;if(lt.name.toLowerCase()===Ee.name.toLowerCase())return!0;const bt=lt.name.toLowerCase(),ct=Ee.name.toLowerCase();return bt.includes(ct)||ct.includes(bt)});Ye&&Ye.value!==void 0&&(ye[xe][Ee.name]=Ye.value)}}),!(await Y(`/api/lab/${me}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(ye)})})).ok)throw new Error("Report update failed.");return oe("Report Updated!"),Ie(n),We(n),v==null||v({role:"system",type:"success",content:"Lab report updated successfully."}),{success:!0,actionType:z,data:{orderId:me},undoData:{orderId:me}}}catch(L){return v==null||v({role:"system",type:"error",content:`Update report failed: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="edit_lab_order_and_create_report")je.push((async()=>{ne(!0),oe("Updating Order & Report..."),v==null||v({role:"system",type:"loading",content:"Updating lab order and report..."});try{const L=D.serialNumber;if(!L)throw new Error("Missing serial number.");const $=new Map;(c??[]).forEach(se=>$.set(se.id,{...se})),(u??[]).forEach(se=>{if($.has(se.id)){const ve=$.get(se.id);ve.report=se,ve.status=se.status}else $.set(se.id,{...se,createdAt:se.createdAt})});const ie=Array.from($.values());ie.sort((se,ve)=>new Date(ve.createdAt).getTime()-new Date(se.createdAt).getTime());const re=ie.length-L,R=ie[re];if(!R)throw new Error(`Lab order #${L} not found.`);const me=R.id,Ce=JSON.parse(JSON.stringify(R));let ye=[];for(const se of R.tests||[]){const ve=p.find(Ee=>String(Ee.id)===String(se.id));ve?ye.push({id:ve.id,name:ve.name,price:Number(ve.price)}):ye.push({id:se.id,name:se.name,price:Number(se.price)||0})}if(D.items_to_remove&&Array.isArray(D.items_to_remove)){const se=D.items_to_remove;ye=ye.filter(ve=>!se.some(Ee=>Ee.id&&String(Ee.id)===String(ve.id)||Ee.name&&ve.name.toLowerCase()===Ee.name.toLowerCase()))}const ae=D.tests||[],fe={};for(const se of ae){let ve;if(se.id?ve=p.find(rt=>String(rt.id)===String(se.id)):se.name&&(ve=$t(se.name,p)),!ve)throw new Error(`Lab test "${se.name}" not found.`);ye.findIndex(rt=>String(rt.id)===String(ve.id))===-1&&ye.push({id:ve.id,name:ve.name,price:Number(ve.price)});const Ye=ve.id,lt=se.parameters||[],bt={},ct=ve.default_parameters||[];for(const rt of ct){const en=lt.find(tn=>{if(!tn.name)return!1;if(tn.name.toLowerCase()===rt.name.toLowerCase())return!0;const Wn=tn.name.toLowerCase(),Vn=rt.name.toLowerCase();return Wn.includes(Vn)||Vn.includes(Wn)});en&&en.value!==void 0?bt[rt.name]=en.value:rt.defaultValue!==void 0&&(bt[rt.name]=rt.defaultValue)}fe[Ye]=bt}const de={tests:ye};console.log("[DEBUG] edit_lab_order_and_create_report - Order Update Payload:",JSON.stringify(de,null,2)),console.log("[DEBUG] Items to remove:",D.items_to_remove),console.log("[DEBUG] Original tests:",R.tests);const H=await Y(`/api/lab/orders/${me}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(de)});if(console.log("[DEBUG] Order update response status:",H.status),!H.ok){const se=await H.json().catch(()=>({}));throw console.error("[DEBUG] Order update failed:",se),new Error(`Failed to update lab order tests: ${se.message||H.statusText}`)}let Z={};if(R.report&&R.report.report_content)try{Z=typeof R.report.report_content=="string"?JSON.parse(R.report.report_content):R.report.report_content}catch{}const xe={...Z,...fe};if(!(await Y(`/api/lab/${me}/report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report_content:JSON.stringify(xe)})})).ok)throw new Error("Failed to create/update lab report.");return oe("Order & Report Updated!"),Ie(n),We(n),v==null||v({role:"system",type:"success",content:"Lab order and report updated successfully."}),{success:!0,actionType:z,undoData:{orderId:me,originalState:Ce}}}catch(L){return v==null||v({role:"system",type:"error",content:`Failed to edit order and report: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="edit_pharmacy_order")je.push((async()=>{X(!0);try{const L=D.serialNumber;let $;if(L?$=[...d].sort((fe,de)=>new Date(fe.date).getTime()-new Date(de.date).getTime())[L-1]:$=d.find(ae=>ae.status==="pending"),!$)throw new Error("Order to edit not found.");const ie=JSON.parse(JSON.stringify($));let re=[...$.medications];const R=D.items_to_remove,me=D.items;if(Array.isArray(R)&&(re=re.filter(ae=>!R.some(fe=>fe.drug_id&&String(ae.drug_id)===String(fe.drug_id)||fe.name&&ae.name.toLowerCase()===fe.name.toLowerCase()))),Array.isArray(me))for(const ae of me){let fe;if(ae.drug_id?fe=y.find(Z=>String(Z.id)===String(ae.drug_id)):ae.name&&(fe=$t(ae.name,y)),!fe)throw new Error(`Drug ${ae.name} not found.`);const de=re.findIndex(Z=>Z.drug_id===String(fe==null?void 0:fe.id)),H={drug_id:String(fe.id),name:fe.name,pack_quantity:ae.pack_quantity||0,loose_quantity:ae.loose_quantity||0,pack_price:Number(fe.mrp),loose_price:0,total_price:0,price:Number(fe.mrp)};de>=0?re[de]={...re[de],...H}:re.push(H)}const Ce={items:re,status:D.status,prescription_for_unavailable_drugs:D.prescription_for_unavailable_drugs,order_total:0};if(!(await Y(`/api/pharmacy-orders/${$.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(Ce)})).ok)throw new Error("Order edit failed.");return b(n),{success:!0,actionType:z,undoData:{orderId:$.id,originalState:ie}}}catch(L){return{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{X(!1)}})());else if(z==="edit_lab_order")je.push((async()=>{ne(!0);try{const L=c.sort((R,me)=>new Date(me.createdAt).getTime()-new Date(R.createdAt).getTime()).find(R=>R.status==="pending");if(!L)throw new Error("No pending lab order to edit.");const $=JSON.parse(JSON.stringify(L)),ie={tests:[],status:D.status};if(!(await Y(`/api/lab/orders/${L.id}`,{method:"PUT",body:JSON.stringify(ie),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Lab edit failed.");return Ie(n),{success:!0,actionType:z,undoData:{orderId:L.id,originalState:$}}}catch(L){return{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{ne(!1)}})());else if(z==="add_complaint_history")je.push((async()=>{V(!0),v==null||v({role:"system",type:"loading",content:"Updating complaint history..."});const L=q;try{if(!e)throw new Error("No record ID.");if(!(await Y(`/api/queue/doctor/complaint/${e}`,{method:"PUT",body:JSON.stringify({complaint:D.complaint}),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Complaint update failed.");return G(D.complaint),n&&st(n),v==null||v({role:"system",type:"success",content:"Complaint history updated."}),{success:!0,actionType:z,undoData:{recordId:e,originalComplaint:L}}}catch($){return v==null||v({role:"system",type:"error",content:`Complaint history update failed: ${$.message}`}),{success:!1,actionType:z,error:$,originalActionPayload:D}}finally{V(!1)}})());else if(z==="update_case_summary")je.push((async()=>{C(!0),v==null||v({role:"system",type:"loading",content:"Updating case summary..."});const L=r;try{if(!e)throw new Error("No record ID.");const $=await Y(`/api/queue/doctor/complaint/${e}`,{method:"PUT",body:JSON.stringify({case_summary:D.summary}),headers:{"Content-Type":"application/json"}});if(!$.ok)throw new Error("Summary update failed.");const ie=await $.json();return A(ie.case_summary),v==null||v({role:"system",type:"success",content:"Case summary updated."}),{success:!0,actionType:z,undoData:{recordId:e,originalSummary:L}}}catch($){return v==null||v({role:"system",type:"error",content:`Case summary update failed: ${$.message}`}),{success:!1,actionType:z,error:$,originalActionPayload:D}}finally{C(!1)}})());else if(z==="create_recurring_medication_order")je.push((async()=>{X(!0),le("Creating recurring medication(s)..."),v==null||v({role:"system",type:"loading",content:"Creating recurring medication(s)..."});try{if(!n)throw new Error("Missing patient ID.");if(!D.items||!Array.isArray(D.items))throw new Error("No items provided for recurring medication order.");const L=await Promise.all(D.items.map(async R=>{let me=R.drug_id;if(!me){const Ce=$t(R.medication_name,y);me=Ce?Ce.id:null}if(!me)throw new Error(`Drug "${R.medication_name}" not found in inventory for recurring medication.`);return{...R,drug_id:me}})),$=await Y("/api/recurring-medications",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:n,items:L})});if(!$.ok){const R=await $.json().catch(()=>({}));throw new Error(R.message||"Failed to create recurring medication order")}const ie=await $.json(),re=ie.map(R=>R.id);return n&&_e&&_e(n),le("Recurring medication(s) created."),v==null||v({role:"system",type:"success",content:`Successfully created ${re.length} recurring medication(s).`}),{success:!0,actionType:z,data:ie,undoData:{createdIds:re}}}catch(L){return v==null||v({role:"system",type:"error",content:`Error creating recurring medication: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{X(!1)}})());else if(z==="edit_recurring_medication_order")je.push((async()=>{X(!0),le("Updating recurring medication..."),v==null||v({role:"system",type:"loading",content:"Updating recurring medication..."});try{if(!n)throw new Error("Missing patient ID.");if(!D.serialNumber||!D.updates)throw new Error("Missing serialNumber or updates for recurring medication edit.");if(!E||E.length===0)throw new Error("No recurring medications found to edit.");const L=D.serialNumber-1;if(L<0||L>=E.length)throw new Error(`Recurring medication with serial number ${D.serialNumber} not found.`);const $=E[L],ie=JSON.parse(JSON.stringify($));if(D.updates.drug_id===null||D.updates.medication_name){let R=D.updates.drug_id;if(!R&&D.updates.medication_name){const me=$t(D.updates.medication_name,y);R=me?me.id:null}if(!R&&D.updates.medication_name)throw new Error(`Drug "${D.updates.medication_name}" not found in inventory for update.`);D.updates.drug_id=R}const re=await Y(`/api/recurring-medications/${$.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(D.updates)});if(!re.ok){const R=await re.json().catch(()=>({}));throw new Error(R.message||"Failed to update recurring medication")}return n&&_e&&_e(n),le("Recurring medication updated."),v==null||v({role:"system",type:"success",content:`Successfully updated recurring medication #${D.serialNumber}.`}),{success:!0,actionType:z,data:{id:$.id,...D.updates},undoData:{medicationId:$.id,originalState:ie}}}catch(L){return v==null||v({role:"system",type:"error",content:`Error updating recurring medication: ${L.message}`}),{success:!1,actionType:z,error:L,originalActionPayload:D}}finally{X(!1)}})());else if(z==="end_task")je.push((async()=>(v==null||v({role:"system",type:"success",content:"Task completed."}),{success:!0,actionType:z}))());else{if(z==="bill_lab_order")continue;console.warn(`Unknown action ${z}`),je.push(Promise.resolve({success:!1,actionType:z,error:new Error(`Unknown action: ${z}`),originalActionPayload:D}))}}const qe=await Promise.all(je),te=qe.filter(D=>!D.success);if(te.length>0){console.log("AI Actions Failed. Initiating Rollback...",te);const D=qe.filter(re=>re.success),z=[...D].reverse();await Ht(z);const L=te.map(re=>{var R;return`${re.actionType}: ${(R=re.error)==null?void 0:R.message}`}).join("; "),$=D.length>0?` I successfully rolled back ${D.length} other actions that succeeded.`:"",ie=`One or more actions failed: [${L}].${$} Please analyze the failure and try again.`;await St("multiple_actions",{message:ie},Le,T)}else{const D=qe.filter(L=>L.success);D.length>0&&(xt(D),Kt&&D.forEach(L=>Kt(L.actionType)));const z=He.find(L=>L.action==="bill_lab_order");if(z&&z.serialNumber){const L=new Map;(c??[]).forEach(R=>L.set(R.id,{...R}));const $=Array.from(L.values());$.sort((R,me)=>new Date(me.createdAt).getTime()-new Date(R.createdAt).getTime());const ie=$.length-z.serialNumber,re=$[ie];if(re&&re.id){v==null||v({role:"system",type:"success",content:`Processing billing for Lab Order #${z.serialNumber}...`});try{const R=re.tests.map(H=>({name:H.test_name||H.name,price:typeof H.price=="string"?parseFloat(H.price):H.price||0,discount_percentage:0,quantity:1,item_id:H.test_id||H.id,type:"lab_test"})),me=R.reduce((H,Z)=>H+Z.price,0),Ce=0,ye=me,ae={patientId:re.patient_id,items:R.map(H=>({...H,total:H.price})),amount:ye,paymentMode:"cash",type:"lab",related_id:re.id,status:"paid",discountPercentage:0},fe=await Y("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)}),de=await fe.json();if(!fe.ok)throw new Error(de.message||"Failed to create bill");await Y(`/api/lab/${re.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:de.id})}),n&&Ie(n),Ot&&(Ot({billId:de.id,patientName:(t==null?void 0:t.name)||"Patient",patientToken:(t==null?void 0:t.patient_token_number)||"",orderDate:re.createdAt,items:R,subtotal:me,totalDiscount:Ce,grandTotal:ye,clinicName:(a==null?void 0:a.name)||"",clinicAddress:(a==null?void 0:a.address)||"",clinicNotes:(a==null?void 0:a.notes)||"",clinicUpiId:(a==null?void 0:a.upi_id)||"",labLetterheadUrl:a==null?void 0:a.labLetterheadUrl}),v==null||v({role:"system",type:"success",content:`Bill #${de.id} created. Opening print dialog.`}))}catch(R){console.error("Auto-billing failed:",R),v==null||v({role:"system",type:"error",content:`Billing failed: ${R.message}`})}}else console.warn(`Could not find lab order with serialNumber ${z.serialNumber} to bill.`),v==null||v({role:"system",type:"error",content:`Could not find lab order #${z.serialNumber} to bill.`})}if(Je&&typeof Je.question=="string")Se(Je.question),he(Array.isArray(Je.options)?Je.options:[]);else if(D.length===0&&!z&&!Ge)throw new Error("AI response did not result in a recognized or performed function call.")}}catch(ce){await St("parse_json_actions",ce,Le,T)}else throw new Error("AI response did not contain a recognized function call.")};Qe=async(Le,T=0)=>{if(T>1){j("AI call failed after multiple retries. Please try a different prompt."),F(!1);return}F(!0),j(null);let P;const ee=[...o,Le].join(`

`);try{const ce=new Map;(c??[]).forEach(te=>{ce.set(te.id,{...te})}),(u??[]).forEach(te=>{if(!ce.has(te.id))ce.set(te.id,{id:te.id,patient_id:te.patient_id,tests:te.tests,status:te.status,createdAt:te.createdAt,report:te});else{const D=ce.get(te.id);D&&(D.report=te,D.status=te.status)}});const Re=Array.from(ce.values());Re.sort((te,D)=>new Date(D.createdAt).getTime()-new Date(te.createdAt).getTime());const He=Re.map((te,D)=>{let z=null;if(te.report)try{const L=typeof te.report.report_content=="string"?te.report.report_content:JSON.stringify(te.report.report_content||{}),$=JSON.parse(L||"{}"),ie=re=>{const R=$[re.id]||{},me=Ce=>({name:Ce.name,value:R[Ce.name]!==void 0?String(R[Ce.name]):String(Ce.defaultValue),normal_range:Ce.normal_range||"N/A"});return{testId:re.id,testName:re.name,parameters:(re.default_parameters||[]).map(me)}};z={reportId:te.report.reportId,reportDate:te.report.report_date,tests:(te.tests||[]).map(ie)}}catch{z={reportId:te.report.reportId,reportDate:te.report.report_date,reportContent:typeof te.report.report_content=="string"?te.report.report_content:JSON.stringify(te.report.report_content),error:"Failed to parse report content JSON."}}return{serialNumber:Re.length-D,orderId:te.id,orderDate:isNaN(new Date(te.createdAt).getTime())?te.createdAt:new Date(te.createdAt).toISOString(),tests:te.tests.map(L=>({id:L.id,name:L.name,price:L.price})),status:te.status,report:z}}),je=m.map(te=>{try{return{...te,createdAt:isNaN(new Date(te.createdAt).getTime())?te.createdAt:new Date(te.createdAt).toISOString()}}catch{return te}}),Ge=[...d].sort((te,D)=>{const z=new Date(te.date).getTime(),L=new Date(D.date).getTime();return z-L}).map((te,D)=>{try{return{serialNumber:D+1,...te,date:te.date&&!isNaN(new Date(te.date).getTime())?new Date(te.date).toISOString():te.date}}catch{return{serialNumber:D+1,...te}}}),qe={query:ee,currentDateTime:new Date().toISOString(),patientName:(t==null?void 0:t.name)||"",patientAge:(t==null?void 0:t.age)||void 0,patientGender:(t==null?void 0:t.gender)||void 0,case_summary:r||"",case_summary_last_updated:s?new Date(s).toISOString():void 0,clinic_ai_memory:(a==null?void 0:a.aiMemory)||"",clinic_ai_memory_last_updated:a!=null&&a.aiMemoryUpdatedAt?new Date(a.aiMemoryUpdatedAt).toISOString():void 0,clinic_wide_system_prompt:(a==null?void 0:a.clinicWideSystemPrompt)||"",labHistory:He,pharmacyOrders:Ge,pastComplaints:je,pharmacyInventory:y,labInventory:p,recurringMedications:E};if(console.log("DEBUG: Payload before sending to Gemini API:",JSON.stringify(qe,null,2)),P=await Yh(qe,l),P){O(P),v==null||v({role:"ai",content:P});const te=/```json\s*([\s\S]*?)\s*```/,D=P.match(te);if(D&&D[1])B(P.replace(te,"").trim()),I(D[1].trim());else{const z=P.trim();if(z.startsWith("{")&&z.endsWith("}"))try{JSON.parse(z),B(""),I(z)}catch{B(z),I(null)}else if(z.startsWith("[")&&z.endsWith("]"))try{JSON.parse(z),B(""),I(z)}catch{B(z),I(null)}else B(z),I(null)}W(!1),n&&P&&await Tt(n,P),await Ve(P,T),G("")}else throw new Error("Invalid AI response format.")}catch(ce){await St("call_generative_api",ce,P,T)}finally{F(!1)}};const Tt=async(Le,T)=>{ze(!0),ke(null);try{const P={ai_response:T},S=await Y(`/api/patients/${Le}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(P)});if(!S.ok){const ee=await S.json().catch(()=>({}));throw new Error(ee.message||`Failed to save AI response to patient: ${S.statusText}`)}}catch(P){ke(`AI Response Save Error: ${P.message}`),v==null||v({role:"system",type:"error",content:`AI Response Save Error: ${P.message}`})}finally{ze(!1)}};return x.useImperativeHandle(Zt,()=>({callGenerativeApi:Qe,undoLastAction:Xt})),null}),qo=-1,Cr=0,qn=1,_r=2,Ki=3,Zi=4,Xi=5,ea=6,Bo=7,Uo=8,Ls=typeof self=="object"?self:globalThis,Zh=(e,n)=>{const t=(s,a)=>(e.set(a,s),s),r=s=>{if(e.has(s))return e.get(s);const[a,o]=n[s];switch(a){case Cr:case qo:return t(o,s);case qn:{const l=t([],s);for(const c of o)l.push(r(c));return l}case _r:{const l=t({},s);for(const[c,u]of o)l[r(c)]=r(u);return l}case Ki:return t(new Date(o),s);case Zi:{const{source:l,flags:c}=o;return t(new RegExp(l,c),s)}case Xi:{const l=t(new Map,s);for(const[c,u]of o)l.set(r(c),r(u));return l}case ea:{const l=t(new Set,s);for(const c of o)l.add(r(c));return l}case Bo:{const{name:l,message:c}=o;return t(new Ls[l](c),s)}case Uo:return t(BigInt(o),s);case"BigInt":return t(Object(BigInt(o)),s);case"ArrayBuffer":return t(new Uint8Array(o).buffer,o);case"DataView":{const{buffer:l}=new Uint8Array(o);return t(new DataView(l),o)}}return t(new Ls[a](o),s)};return r},Rs=e=>Zh(new Map,e)(0),pn="",{toString:Xh}={},{keys:em}=Object,Ln=e=>{const n=typeof e;if(n!=="object"||!e)return[Cr,n];const t=Xh.call(e).slice(8,-1);switch(t){case"Array":return[qn,pn];case"Object":return[_r,pn];case"Date":return[Ki,pn];case"RegExp":return[Zi,pn];case"Map":return[Xi,pn];case"Set":return[ea,pn];case"DataView":return[qn,t]}return t.includes("Array")?[qn,t]:t.includes("Error")?[Bo,t]:[_r,t]},mr=([e,n])=>e===Cr&&(n==="function"||n==="symbol"),tm=(e,n,t,r)=>{const s=(o,l)=>{const c=r.push(o)-1;return t.set(l,c),c},a=o=>{if(t.has(o))return t.get(o);let[l,c]=Ln(o);switch(l){case Cr:{let m=o;switch(c){case"bigint":l=Uo,m=o.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+c);m=null;break;case"undefined":return s([qo],o)}return s([l,m],o)}case qn:{if(c){let y=o;return c==="DataView"?y=new Uint8Array(o.buffer):c==="ArrayBuffer"&&(y=new Uint8Array(o)),s([c,[...y]],o)}const m=[],d=s([l,m],o);for(const y of o)m.push(a(y));return d}case _r:{if(c)switch(c){case"BigInt":return s([c,o.toString()],o);case"Boolean":case"Number":case"String":return s([c,o.valueOf()],o)}if(n&&"toJSON"in o)return a(o.toJSON());const m=[],d=s([l,m],o);for(const y of em(o))(e||!mr(Ln(o[y])))&&m.push([a(y),a(o[y])]);return d}case Ki:return s([l,o.toISOString()],o);case Zi:{const{source:m,flags:d}=o;return s([l,{source:m,flags:d}],o)}case Xi:{const m=[],d=s([l,m],o);for(const[y,p]of o)(e||!(mr(Ln(y))||mr(Ln(p))))&&m.push([a(y),a(p)]);return d}case ea:{const m=[],d=s([l,m],o);for(const y of o)(e||!mr(Ln(y)))&&m.push(a(y));return d}}const{message:u}=o;return s([l,{name:c,message:u}],o)};return a},Fs=(e,{json:n,lossy:t}={})=>{const r=[];return tm(!(n||t),!!n,new Map,r)(e),r},Bn=typeof structuredClone=="function"?(e,n)=>n&&("json"in n||"lossy"in n)?Rs(Fs(e,n)):structuredClone(e):(e,n)=>Rs(Fs(e,n)),Mo=Wo("end"),Ho=Wo("start");function Wo(e){return n;function n(t){const r=t&&t.position&&t.position[e]||{};if(typeof r.line=="number"&&r.line>0&&typeof r.column=="number"&&r.column>0)return{line:r.line,column:r.column,offset:typeof r.offset=="number"&&r.offset>-1?r.offset:void 0}}}function Vo(e){const n=Ho(e),t=Mo(e);if(n&&t)return{start:n,end:t}}const Qt=["ariaDescribedBy","ariaLabel","ariaLabelledBy"],zs={ancestors:{tbody:["table"],td:["table"],th:["table"],thead:["table"],tfoot:["table"],tr:["table"]},attributes:{a:[...Qt,"dataFootnoteBackref","dataFootnoteRef",["className","data-footnote-backref"],"href"],blockquote:["cite"],code:[["className",/^language-./]],del:["cite"],div:["itemScope","itemType"],dl:[...Qt],h2:[["className","sr-only"]],img:[...Qt,"longDesc","src"],input:[["disabled",!0],["type","checkbox"]],ins:["cite"],li:[["className","task-list-item"]],ol:[...Qt,["className","contains-task-list"]],q:["cite"],section:["dataFootnotes",["className","footnotes"]],source:["srcSet"],summary:[...Qt],table:[...Qt],ul:[...Qt,["className","contains-task-list"]],"*":["abbr","accept","acceptCharset","accessKey","action","align","alt","axis","border","cellPadding","cellSpacing","char","charOff","charSet","checked","clear","colSpan","color","cols","compact","coords","dateTime","dir","encType","frame","hSpace","headers","height","hrefLang","htmlFor","id","isMap","itemProp","label","lang","maxLength","media","method","multiple","name","noHref","noShade","noWrap","open","prompt","readOnly","rev","rowSpan","rows","rules","scope","selected","shape","size","span","start","summary","tabIndex","title","useMap","vAlign","value","width"]},clobber:["ariaDescribedBy","ariaLabelledBy","id","name"],clobberPrefix:"user-content-",protocols:{cite:["http","https"],href:["http","https","irc","ircs","mailto","xmpp"],longDesc:["http","https"],src:["http","https"]},required:{input:{disabled:!0,type:"checkbox"}},strip:["script"],tagNames:["a","b","blockquote","br","code","dd","del","details","div","dl","dt","em","h1","h2","h3","h4","h5","h6","hr","i","img","input","ins","kbd","li","ol","p","picture","pre","q","rp","rt","ruby","s","samp","section","source","span","strike","strong","sub","summary","sup","table","tbody","td","tfoot","th","thead","tr","tt","ul","var"]},Bt={}.hasOwnProperty;function nm(e,n){let t={type:"root",children:[]};const r={schema:n?{...zs,...n}:zs,stack:[]},s=Jo(r,e);return s&&(Array.isArray(s)?s.length===1?t=s[0]:t.children=s:t=s),t}function Jo(e,n){if(n&&typeof n=="object"){const t=n;switch(typeof t.type=="string"?t.type:""){case"comment":return rm(e,t);case"doctype":return im(e,t);case"element":return am(e,t);case"root":return sm(e,t);case"text":return om(e,t)}}}function rm(e,n){if(e.schema.allowComments){const t=typeof n.value=="string"?n.value:"",r=t.indexOf("-->"),a={type:"comment",value:r<0?t:t.slice(0,r)};return Mn(a,n),a}}function im(e,n){if(e.schema.allowDoctypes){const t={type:"doctype"};return Mn(t,n),t}}function am(e,n){const t=typeof n.tagName=="string"?n.tagName:"";e.stack.push(t);const r=Qo(e,n.children),s=lm(e,n.properties);e.stack.pop();let a=!1;if(t&&t!=="*"&&(!e.schema.tagNames||e.schema.tagNames.includes(t))&&(a=!0,e.schema.ancestors&&Bt.call(e.schema.ancestors,t))){const l=e.schema.ancestors[t];let c=-1;for(a=!1;++c<l.length;)e.stack.includes(l[c])&&(a=!0)}if(!a)return e.schema.strip&&!e.schema.strip.includes(t)?r:void 0;const o={type:"element",tagName:t,properties:s,children:r};return Mn(o,n),o}function sm(e,n){const r={type:"root",children:Qo(e,n.children)};return Mn(r,n),r}function om(e,n){const r={type:"text",value:typeof n.value=="string"?n.value:""};return Mn(r,n),r}function Qo(e,n){const t=[];if(Array.isArray(n)){const r=n;let s=-1;for(;++s<r.length;){const a=Jo(e,r[s]);a&&(Array.isArray(a)?t.push(...a):t.push(a))}}return t}function lm(e,n){const t=e.stack[e.stack.length-1],r=e.schema.attributes,s=e.schema.required,a=r&&Bt.call(r,t)?r[t]:void 0,o=r&&Bt.call(r,"*")?r["*"]:void 0,l=n&&typeof n=="object"?n:{},c={};let u;for(u in l)if(Bt.call(l,u)){const m=l[u];let d=qs(e,Bs(a,u),u,m);d==null&&(d=qs(e,Bs(o,u),u,m)),d!=null&&(c[u]=d)}if(s&&Bt.call(s,t)){const m=s[t];for(u in m)Bt.call(m,u)&&!Bt.call(c,u)&&(c[u]=m[u])}return c}function qs(e,n,t,r){return n?Array.isArray(r)?cm(e,n,t,r):Go(e,n,t,r):void 0}function cm(e,n,t,r){let s=-1;const a=[];for(;++s<r.length;){const o=Go(e,n,t,r[s]);(typeof o=="number"||typeof o=="string")&&a.push(o)}return a}function Go(e,n,t,r){if(!(typeof r!="boolean"&&typeof r!="number"&&typeof r!="string")&&um(e,t,r)){if(typeof n=="object"&&n.length>1){let s=!1,a=0;for(;++a<n.length;){const o=n[a];if(o&&typeof o=="object"&&"flags"in o){if(o.test(String(r))){s=!0;break}}else if(o===r){s=!0;break}}if(!s)return}return e.schema.clobber&&e.schema.clobberPrefix&&e.schema.clobber.includes(t)?e.schema.clobberPrefix+r:r}}function um(e,n,t){const r=e.schema.protocols&&Bt.call(e.schema.protocols,n)?e.schema.protocols[n]:void 0;if(!r||r.length===0)return!0;const s=String(t),a=s.indexOf(":"),o=s.indexOf("?"),l=s.indexOf("#"),c=s.indexOf("/");if(a<0||c>-1&&a>c||o>-1&&a>o||l>-1&&a>l)return!0;let u=-1;for(;++u<r.length;){const m=r[u];if(a===m.length&&s.slice(0,m.length)===m)return!0}return!1}function Mn(e,n){const t=Vo(n);n.data&&(e.data=Bn(n.data)),t&&(e.position=t)}function Bs(e,n){let t,r=-1;if(e)for(;++r<e.length;){const s=e[r],a=typeof s=="string"?s:s[0];if(a===n)return s;a==="data*"&&(t=s)}if(n.length>4&&n.slice(0,4).toLowerCase()==="data")return t}function dm(e,n){const t={type:"element",tagName:"blockquote",properties:{},children:e.wrap(e.all(n),!0)};return e.patch(n,t),e.applyData(n,t)}function pm(e,n){const t={type:"element",tagName:"br",properties:{},children:[]};return e.patch(n,t),[e.applyData(n,t),{type:"text",value:`
`}]}function hm(e,n){const t=n.value?n.value+`
`:"",r={};n.lang&&(r.className=["language-"+n.lang]);let s={type:"element",tagName:"code",properties:r,children:[{type:"text",value:t}]};return n.meta&&(s.data={meta:n.meta}),e.patch(n,s),s=e.applyData(n,s),s={type:"element",tagName:"pre",properties:{},children:[s]},e.patch(n,s),s}function mm(e,n){const t={type:"element",tagName:"del",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function fm(e,n){const t={type:"element",tagName:"em",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function gm(e,n){const t=typeof e.options.clobberPrefix=="string"?e.options.clobberPrefix:"user-content-",r=String(n.identifier).toUpperCase(),s=yn(r.toLowerCase()),a=e.footnoteOrder.indexOf(r);let o,l=e.footnoteCounts.get(r);l===void 0?(l=0,e.footnoteOrder.push(r),o=e.footnoteOrder.length):o=a+1,l+=1,e.footnoteCounts.set(r,l);const c={type:"element",tagName:"a",properties:{href:"#"+t+"fn-"+s,id:t+"fnref-"+s+(l>1?"-"+l:""),dataFootnoteRef:!0,ariaDescribedBy:["footnote-label"]},children:[{type:"text",value:String(o)}]};e.patch(n,c);const u={type:"element",tagName:"sup",properties:{},children:[c]};return e.patch(n,u),e.applyData(n,u)}function ym(e,n){const t={type:"element",tagName:"h"+n.depth,properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function xm(e,n){if(e.options.allowDangerousHtml){const t={type:"raw",value:n.value};return e.patch(n,t),e.applyData(n,t)}}function Yo(e,n){const t=n.referenceType;let r="]";if(t==="collapsed"?r+="[]":t==="full"&&(r+="["+(n.label||n.identifier)+"]"),n.type==="imageReference")return[{type:"text",value:"!["+n.alt+r}];const s=e.all(n),a=s[0];a&&a.type==="text"?a.value="["+a.value:s.unshift({type:"text",value:"["});const o=s[s.length-1];return o&&o.type==="text"?o.value+=r:s.push({type:"text",value:r}),s}function bm(e,n){const t=String(n.identifier).toUpperCase(),r=e.definitionById.get(t);if(!r)return Yo(e,n);const s={src:yn(r.url||""),alt:n.alt};r.title!==null&&r.title!==void 0&&(s.title=r.title);const a={type:"element",tagName:"img",properties:s,children:[]};return e.patch(n,a),e.applyData(n,a)}function wm(e,n){const t={src:yn(n.url)};n.alt!==null&&n.alt!==void 0&&(t.alt=n.alt),n.title!==null&&n.title!==void 0&&(t.title=n.title);const r={type:"element",tagName:"img",properties:t,children:[]};return e.patch(n,r),e.applyData(n,r)}function km(e,n){const t={type:"text",value:n.value.replace(/\r?\n|\r/g," ")};e.patch(n,t);const r={type:"element",tagName:"code",properties:{},children:[t]};return e.patch(n,r),e.applyData(n,r)}function _m(e,n){const t=String(n.identifier).toUpperCase(),r=e.definitionById.get(t);if(!r)return Yo(e,n);const s={href:yn(r.url||"")};r.title!==null&&r.title!==void 0&&(s.title=r.title);const a={type:"element",tagName:"a",properties:s,children:e.all(n)};return e.patch(n,a),e.applyData(n,a)}function Nm(e,n){const t={href:yn(n.url)};n.title!==null&&n.title!==void 0&&(t.title=n.title);const r={type:"element",tagName:"a",properties:t,children:e.all(n)};return e.patch(n,r),e.applyData(n,r)}function vm(e,n,t){const r=e.all(n),s=t?jm(t):Ko(n),a={},o=[];if(typeof n.checked=="boolean"){const m=r[0];let d;m&&m.type==="element"&&m.tagName==="p"?d=m:(d={type:"element",tagName:"p",properties:{},children:[]},r.unshift(d)),d.children.length>0&&d.children.unshift({type:"text",value:" "}),d.children.unshift({type:"element",tagName:"input",properties:{type:"checkbox",checked:n.checked,disabled:!0},children:[]}),a.className=["task-list-item"]}let l=-1;for(;++l<r.length;){const m=r[l];(s||l!==0||m.type!=="element"||m.tagName!=="p")&&o.push({type:"text",value:`
`}),m.type==="element"&&m.tagName==="p"&&!s?o.push(...m.children):o.push(m)}const c=r[r.length-1];c&&(s||c.type!=="element"||c.tagName!=="p")&&o.push({type:"text",value:`
`});const u={type:"element",tagName:"li",properties:a,children:o};return e.patch(n,u),e.applyData(n,u)}function jm(e){let n=!1;if(e.type==="list"){n=e.spread||!1;const t=e.children;let r=-1;for(;!n&&++r<t.length;)n=Ko(t[r])}return n}function Ko(e){const n=e.spread;return n??e.children.length>1}function Cm(e,n){const t={},r=e.all(n);let s=-1;for(typeof n.start=="number"&&n.start!==1&&(t.start=n.start);++s<r.length;){const o=r[s];if(o.type==="element"&&o.tagName==="li"&&o.properties&&Array.isArray(o.properties.className)&&o.properties.className.includes("task-list-item")){t.className=["contains-task-list"];break}}const a={type:"element",tagName:n.ordered?"ol":"ul",properties:t,children:e.wrap(r,!0)};return e.patch(n,a),e.applyData(n,a)}function Sm(e,n){const t={type:"element",tagName:"p",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function Tm(e,n){const t={type:"root",children:e.wrap(e.all(n))};return e.patch(n,t),e.applyData(n,t)}function Pm(e,n){const t={type:"element",tagName:"strong",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}function Em(e,n){const t=e.all(n),r=t.shift(),s=[];if(r){const o={type:"element",tagName:"thead",properties:{},children:e.wrap([r],!0)};e.patch(n.children[0],o),s.push(o)}if(t.length>0){const o={type:"element",tagName:"tbody",properties:{},children:e.wrap(t,!0)},l=Ho(n.children[1]),c=Mo(n.children[n.children.length-1]);l&&c&&(o.position={start:l,end:c}),s.push(o)}const a={type:"element",tagName:"table",properties:{},children:e.wrap(s,!0)};return e.patch(n,a),e.applyData(n,a)}function Am(e,n,t){const r=t?t.children:void 0,a=(r?r.indexOf(n):1)===0?"th":"td",o=t&&t.type==="table"?t.align:void 0,l=o?o.length:n.children.length;let c=-1;const u=[];for(;++c<l;){const d=n.children[c],y={},p=o?o[c]:void 0;p&&(y.align=p);let E={type:"element",tagName:a,properties:y,children:[]};d&&(E.children=e.all(d),e.patch(d,E),E=e.applyData(d,E)),u.push(E)}const m={type:"element",tagName:"tr",properties:{},children:e.wrap(u,!0)};return e.patch(n,m),e.applyData(n,m)}function Dm(e,n){const t={type:"element",tagName:"td",properties:{},children:e.all(n)};return e.patch(n,t),e.applyData(n,t)}const Us=9,Ms=32;function Im(e){const n=String(e),t=/\r?\n|\r/g;let r=t.exec(n),s=0;const a=[];for(;r;)a.push(Hs(n.slice(s,r.index),s>0,!0),r[0]),s=r.index+r[0].length,r=t.exec(n);return a.push(Hs(n.slice(s),s>0,!1)),a.join("")}function Hs(e,n,t){let r=0,s=e.length;if(n){let a=e.codePointAt(r);for(;a===Us||a===Ms;)r++,a=e.codePointAt(r)}if(t){let a=e.codePointAt(s-1);for(;a===Us||a===Ms;)s--,a=e.codePointAt(s-1)}return s>r?e.slice(r,s):""}function $m(e,n){const t={type:"text",value:Im(String(n.value))};return e.patch(n,t),e.applyData(n,t)}function Om(e,n){const t={type:"element",tagName:"hr",properties:{},children:[]};return e.patch(n,t),e.applyData(n,t)}const Lm={blockquote:dm,break:pm,code:hm,delete:mm,emphasis:fm,footnoteReference:gm,heading:ym,html:xm,imageReference:bm,image:wm,inlineCode:km,linkReference:_m,link:Nm,listItem:vm,list:Cm,paragraph:Sm,root:Tm,strong:Pm,table:Em,tableCell:Dm,tableRow:Am,text:$m,thematicBreak:Om,toml:fr,yaml:fr,definition:fr,footnoteDefinition:fr};function fr(){}function Rm(e,n){const t=[{type:"text",value:"↩"}];return n>1&&t.push({type:"element",tagName:"sup",properties:{},children:[{type:"text",value:String(n)}]}),t}function Fm(e,n){return"Back to reference "+(e+1)+(n>1?"-"+n:"")}function zm(e){const n=typeof e.options.clobberPrefix=="string"?e.options.clobberPrefix:"user-content-",t=e.options.footnoteBackContent||Rm,r=e.options.footnoteBackLabel||Fm,s=e.options.footnoteLabel||"Footnotes",a=e.options.footnoteLabelTagName||"h2",o=e.options.footnoteLabelProperties||{className:["sr-only"]},l=[];let c=-1;for(;++c<e.footnoteOrder.length;){const u=e.footnoteById.get(e.footnoteOrder[c]);if(!u)continue;const m=e.all(u),d=String(u.identifier).toUpperCase(),y=yn(d.toLowerCase());let p=0;const E=[],q=e.footnoteCounts.get(d);for(;q!==void 0&&++p<=q;){E.length>0&&E.push({type:"text",value:" "});let B=typeof t=="string"?t:t(c,p);typeof B=="string"&&(B={type:"text",value:B}),E.push({type:"element",tagName:"a",properties:{href:"#"+n+"fnref-"+y+(p>1?"-"+p:""),dataFootnoteBackref:"",ariaLabel:typeof r=="string"?r:r(c,p),className:["data-footnote-backref"]},children:Array.isArray(B)?B:[B]})}const G=m[m.length-1];if(G&&G.type==="element"&&G.tagName==="p"){const B=G.children[G.children.length-1];B&&B.type==="text"?B.value+=" ":G.children.push({type:"text",value:" "}),G.children.push(...E)}else m.push(...E);const O={type:"element",tagName:"li",properties:{id:n+"fn-"+y},children:e.wrap(m,!0)};e.patch(u,O),l.push(O)}if(l.length!==0)return{type:"element",tagName:"section",properties:{dataFootnotes:!0,className:["footnotes"]},children:[{type:"element",tagName:a,properties:{...Bn(o),id:"footnote-label"},children:[{type:"text",value:s}]},{type:"text",value:`
`},{type:"element",tagName:"ol",properties:{},children:e.wrap(l,!0)},{type:"text",value:`
`}]}}const Fi={}.hasOwnProperty,qm={};function Bm(e,n){const t=n||qm,r=new Map,s=new Map,a=new Map,o={...Lm,...t.handlers},l={all:u,applyData:Mm,definitionById:r,footnoteById:s,footnoteCounts:a,footnoteOrder:[],handlers:o,one:c,options:t,patch:Um,wrap:Wm};return Po(e,function(m){if(m.type==="definition"||m.type==="footnoteDefinition"){const d=m.type==="definition"?r:s,y=String(m.identifier).toUpperCase();d.has(y)||d.set(y,m)}}),l;function c(m,d){const y=m.type,p=l.handlers[y];if(Fi.call(l.handlers,y)&&p)return p(l,m,d);if(l.options.passThrough&&l.options.passThrough.includes(y)){if("children"in m){const{children:q,...G}=m,O=Bn(G);return O.children=l.all(m),O}return Bn(m)}return(l.options.unknownHandler||Hm)(l,m,d)}function u(m){const d=[];if("children"in m){const y=m.children;let p=-1;for(;++p<y.length;){const E=l.one(y[p],m);if(E){if(p&&y[p-1].type==="break"&&(!Array.isArray(E)&&E.type==="text"&&(E.value=Ws(E.value)),!Array.isArray(E)&&E.type==="element")){const q=E.children[0];q&&q.type==="text"&&(q.value=Ws(q.value))}Array.isArray(E)?d.push(...E):d.push(E)}}}return d}}function Um(e,n){e.position&&(n.position=Vo(e))}function Mm(e,n){let t=n;if(e&&e.data){const r=e.data.hName,s=e.data.hChildren,a=e.data.hProperties;if(typeof r=="string")if(t.type==="element")t.tagName=r;else{const o="children"in t?t.children:[t];t={type:"element",tagName:r,properties:{},children:o}}t.type==="element"&&a&&Object.assign(t.properties,Bn(a)),"children"in t&&t.children&&s!==null&&s!==void 0&&(t.children=s)}return t}function Hm(e,n){const t=n.data||{},r="value"in n&&!(Fi.call(t,"hProperties")||Fi.call(t,"hChildren"))?{type:"text",value:n.value}:{type:"element",tagName:"div",properties:{},children:e.all(n)};return e.patch(n,r),e.applyData(n,r)}function Wm(e,n){const t=[];let r=-1;for(n&&t.push({type:"text",value:`
`});++r<e.length;)r&&t.push({type:"text",value:`
`}),t.push(e[r]);return n&&e.length>0&&t.push({type:"text",value:`
`}),t}function Ws(e){let n=0,t=e.charCodeAt(n);for(;t===9||t===32;)n++,t=e.charCodeAt(n);return e.slice(n)}function Vm(e,n){const t=Bm(e,n),r=t.one(e,void 0),s=zm(t),a=Array.isArray(r)?{type:"root",children:r}:r||{type:"root",children:[]};return s&&a.children.push({type:"text",value:`
`},s),a}const Jm=["area","base","basefont","bgsound","br","col","command","embed","frame","hr","image","img","input","keygen","link","meta","param","source","track","wbr"];class Hn{constructor(n,t,r){this.normal=t,this.property=n,r&&(this.space=r)}}Hn.prototype.normal={};Hn.prototype.property={};Hn.prototype.space=void 0;function Zo(e,n){const t={},r={};for(const s of e)Object.assign(t,s.property),Object.assign(r,s.normal);return new Hn(t,r,n)}function zi(e){return e.toLowerCase()}class et{constructor(n,t){this.attribute=t,this.property=n}}et.prototype.attribute="";et.prototype.booleanish=!1;et.prototype.boolean=!1;et.prototype.commaOrSpaceSeparated=!1;et.prototype.commaSeparated=!1;et.prototype.defined=!1;et.prototype.mustUseProperty=!1;et.prototype.number=!1;et.prototype.overloadedBoolean=!1;et.prototype.property="";et.prototype.spaceSeparated=!1;et.prototype.space=void 0;let Qm=0;const we=Yt(),Ue=Yt(),qi=Yt(),U=Yt(),$e=Yt(),mn=Yt(),it=Yt();function Yt(){return 2**++Qm}const Bi=Object.freeze(Object.defineProperty({__proto__:null,boolean:we,booleanish:Ue,commaOrSpaceSeparated:it,commaSeparated:mn,number:U,overloadedBoolean:qi,spaceSeparated:$e},Symbol.toStringTag,{value:"Module"})),vi=Object.keys(Bi);class ta extends et{constructor(n,t,r,s){let a=-1;if(super(n,t),Vs(this,"space",s),typeof r=="number")for(;++a<vi.length;){const o=vi[a];Vs(this,vi[a],(r&Bi[o])===Bi[o])}}}ta.prototype.defined=!0;function Vs(e,n,t){t&&(e[n]=t)}function xn(e){const n={},t={};for(const[r,s]of Object.entries(e.properties)){const a=new ta(r,e.transform(e.attributes||{},r),s,e.space);e.mustUseProperty&&e.mustUseProperty.includes(r)&&(a.mustUseProperty=!0),n[r]=a,t[zi(r)]=r,t[zi(a.attribute)]=r}return new Hn(n,t,e.space)}const Xo=xn({properties:{ariaActiveDescendant:null,ariaAtomic:Ue,ariaAutoComplete:null,ariaBusy:Ue,ariaChecked:Ue,ariaColCount:U,ariaColIndex:U,ariaColSpan:U,ariaControls:$e,ariaCurrent:null,ariaDescribedBy:$e,ariaDetails:null,ariaDisabled:Ue,ariaDropEffect:$e,ariaErrorMessage:null,ariaExpanded:Ue,ariaFlowTo:$e,ariaGrabbed:Ue,ariaHasPopup:null,ariaHidden:Ue,ariaInvalid:null,ariaKeyShortcuts:null,ariaLabel:null,ariaLabelledBy:$e,ariaLevel:U,ariaLive:null,ariaModal:Ue,ariaMultiLine:Ue,ariaMultiSelectable:Ue,ariaOrientation:null,ariaOwns:$e,ariaPlaceholder:null,ariaPosInSet:U,ariaPressed:Ue,ariaReadOnly:Ue,ariaRelevant:null,ariaRequired:Ue,ariaRoleDescription:$e,ariaRowCount:U,ariaRowIndex:U,ariaRowSpan:U,ariaSelected:Ue,ariaSetSize:U,ariaSort:null,ariaValueMax:U,ariaValueMin:U,ariaValueNow:U,ariaValueText:null,role:null},transform(e,n){return n==="role"?n:"aria-"+n.slice(4).toLowerCase()}});function el(e,n){return n in e?e[n]:n}function tl(e,n){return el(e,n.toLowerCase())}const Gm=xn({attributes:{acceptcharset:"accept-charset",classname:"class",htmlfor:"for",httpequiv:"http-equiv"},mustUseProperty:["checked","multiple","muted","selected"],properties:{abbr:null,accept:mn,acceptCharset:$e,accessKey:$e,action:null,allow:null,allowFullScreen:we,allowPaymentRequest:we,allowUserMedia:we,alt:null,as:null,async:we,autoCapitalize:null,autoComplete:$e,autoFocus:we,autoPlay:we,blocking:$e,capture:null,charSet:null,checked:we,cite:null,className:$e,cols:U,colSpan:null,content:null,contentEditable:Ue,controls:we,controlsList:$e,coords:U|mn,crossOrigin:null,data:null,dateTime:null,decoding:null,default:we,defer:we,dir:null,dirName:null,disabled:we,download:qi,draggable:Ue,encType:null,enterKeyHint:null,fetchPriority:null,form:null,formAction:null,formEncType:null,formMethod:null,formNoValidate:we,formTarget:null,headers:$e,height:U,hidden:qi,high:U,href:null,hrefLang:null,htmlFor:$e,httpEquiv:$e,id:null,imageSizes:null,imageSrcSet:null,inert:we,inputMode:null,integrity:null,is:null,isMap:we,itemId:null,itemProp:$e,itemRef:$e,itemScope:we,itemType:$e,kind:null,label:null,lang:null,language:null,list:null,loading:null,loop:we,low:U,manifest:null,max:null,maxLength:U,media:null,method:null,min:null,minLength:U,multiple:we,muted:we,name:null,nonce:null,noModule:we,noValidate:we,onAbort:null,onAfterPrint:null,onAuxClick:null,onBeforeMatch:null,onBeforePrint:null,onBeforeToggle:null,onBeforeUnload:null,onBlur:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onContextLost:null,onContextMenu:null,onContextRestored:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnded:null,onError:null,onFocus:null,onFormData:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLanguageChange:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadEnd:null,onLoadStart:null,onMessage:null,onMessageError:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRejectionHandled:null,onReset:null,onResize:null,onScroll:null,onScrollEnd:null,onSecurityPolicyViolation:null,onSeeked:null,onSeeking:null,onSelect:null,onSlotChange:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnhandledRejection:null,onUnload:null,onVolumeChange:null,onWaiting:null,onWheel:null,open:we,optimum:U,pattern:null,ping:$e,placeholder:null,playsInline:we,popover:null,popoverTarget:null,popoverTargetAction:null,poster:null,preload:null,readOnly:we,referrerPolicy:null,rel:$e,required:we,reversed:we,rows:U,rowSpan:U,sandbox:$e,scope:null,scoped:we,seamless:we,selected:we,shadowRootClonable:we,shadowRootDelegatesFocus:we,shadowRootMode:null,shape:null,size:U,sizes:null,slot:null,span:U,spellCheck:Ue,src:null,srcDoc:null,srcLang:null,srcSet:null,start:U,step:null,style:null,tabIndex:U,target:null,title:null,translate:null,type:null,typeMustMatch:we,useMap:null,value:Ue,width:U,wrap:null,writingSuggestions:null,align:null,aLink:null,archive:$e,axis:null,background:null,bgColor:null,border:U,borderColor:null,bottomMargin:U,cellPadding:null,cellSpacing:null,char:null,charOff:null,classId:null,clear:null,code:null,codeBase:null,codeType:null,color:null,compact:we,declare:we,event:null,face:null,frame:null,frameBorder:null,hSpace:U,leftMargin:U,link:null,longDesc:null,lowSrc:null,marginHeight:U,marginWidth:U,noResize:we,noHref:we,noShade:we,noWrap:we,object:null,profile:null,prompt:null,rev:null,rightMargin:U,rules:null,scheme:null,scrolling:Ue,standby:null,summary:null,text:null,topMargin:U,valueType:null,version:null,vAlign:null,vLink:null,vSpace:U,allowTransparency:null,autoCorrect:null,autoSave:null,disablePictureInPicture:we,disableRemotePlayback:we,prefix:null,property:null,results:U,security:null,unselectable:null},space:"html",transform:tl}),Ym=xn({attributes:{accentHeight:"accent-height",alignmentBaseline:"alignment-baseline",arabicForm:"arabic-form",baselineShift:"baseline-shift",capHeight:"cap-height",className:"class",clipPath:"clip-path",clipRule:"clip-rule",colorInterpolation:"color-interpolation",colorInterpolationFilters:"color-interpolation-filters",colorProfile:"color-profile",colorRendering:"color-rendering",crossOrigin:"crossorigin",dataType:"datatype",dominantBaseline:"dominant-baseline",enableBackground:"enable-background",fillOpacity:"fill-opacity",fillRule:"fill-rule",floodColor:"flood-color",floodOpacity:"flood-opacity",fontFamily:"font-family",fontSize:"font-size",fontSizeAdjust:"font-size-adjust",fontStretch:"font-stretch",fontStyle:"font-style",fontVariant:"font-variant",fontWeight:"font-weight",glyphName:"glyph-name",glyphOrientationHorizontal:"glyph-orientation-horizontal",glyphOrientationVertical:"glyph-orientation-vertical",hrefLang:"hreflang",horizAdvX:"horiz-adv-x",horizOriginX:"horiz-origin-x",horizOriginY:"horiz-origin-y",imageRendering:"image-rendering",letterSpacing:"letter-spacing",lightingColor:"lighting-color",markerEnd:"marker-end",markerMid:"marker-mid",markerStart:"marker-start",navDown:"nav-down",navDownLeft:"nav-down-left",navDownRight:"nav-down-right",navLeft:"nav-left",navNext:"nav-next",navPrev:"nav-prev",navRight:"nav-right",navUp:"nav-up",navUpLeft:"nav-up-left",navUpRight:"nav-up-right",onAbort:"onabort",onActivate:"onactivate",onAfterPrint:"onafterprint",onBeforePrint:"onbeforeprint",onBegin:"onbegin",onCancel:"oncancel",onCanPlay:"oncanplay",onCanPlayThrough:"oncanplaythrough",onChange:"onchange",onClick:"onclick",onClose:"onclose",onCopy:"oncopy",onCueChange:"oncuechange",onCut:"oncut",onDblClick:"ondblclick",onDrag:"ondrag",onDragEnd:"ondragend",onDragEnter:"ondragenter",onDragExit:"ondragexit",onDragLeave:"ondragleave",onDragOver:"ondragover",onDragStart:"ondragstart",onDrop:"ondrop",onDurationChange:"ondurationchange",onEmptied:"onemptied",onEnd:"onend",onEnded:"onended",onError:"onerror",onFocus:"onfocus",onFocusIn:"onfocusin",onFocusOut:"onfocusout",onHashChange:"onhashchange",onInput:"oninput",onInvalid:"oninvalid",onKeyDown:"onkeydown",onKeyPress:"onkeypress",onKeyUp:"onkeyup",onLoad:"onload",onLoadedData:"onloadeddata",onLoadedMetadata:"onloadedmetadata",onLoadStart:"onloadstart",onMessage:"onmessage",onMouseDown:"onmousedown",onMouseEnter:"onmouseenter",onMouseLeave:"onmouseleave",onMouseMove:"onmousemove",onMouseOut:"onmouseout",onMouseOver:"onmouseover",onMouseUp:"onmouseup",onMouseWheel:"onmousewheel",onOffline:"onoffline",onOnline:"ononline",onPageHide:"onpagehide",onPageShow:"onpageshow",onPaste:"onpaste",onPause:"onpause",onPlay:"onplay",onPlaying:"onplaying",onPopState:"onpopstate",onProgress:"onprogress",onRateChange:"onratechange",onRepeat:"onrepeat",onReset:"onreset",onResize:"onresize",onScroll:"onscroll",onSeeked:"onseeked",onSeeking:"onseeking",onSelect:"onselect",onShow:"onshow",onStalled:"onstalled",onStorage:"onstorage",onSubmit:"onsubmit",onSuspend:"onsuspend",onTimeUpdate:"ontimeupdate",onToggle:"ontoggle",onUnload:"onunload",onVolumeChange:"onvolumechange",onWaiting:"onwaiting",onZoom:"onzoom",overlinePosition:"overline-position",overlineThickness:"overline-thickness",paintOrder:"paint-order",panose1:"panose-1",pointerEvents:"pointer-events",referrerPolicy:"referrerpolicy",renderingIntent:"rendering-intent",shapeRendering:"shape-rendering",stopColor:"stop-color",stopOpacity:"stop-opacity",strikethroughPosition:"strikethrough-position",strikethroughThickness:"strikethrough-thickness",strokeDashArray:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",strokeLineCap:"stroke-linecap",strokeLineJoin:"stroke-linejoin",strokeMiterLimit:"stroke-miterlimit",strokeOpacity:"stroke-opacity",strokeWidth:"stroke-width",tabIndex:"tabindex",textAnchor:"text-anchor",textDecoration:"text-decoration",textRendering:"text-rendering",transformOrigin:"transform-origin",typeOf:"typeof",underlinePosition:"underline-position",underlineThickness:"underline-thickness",unicodeBidi:"unicode-bidi",unicodeRange:"unicode-range",unitsPerEm:"units-per-em",vAlphabetic:"v-alphabetic",vHanging:"v-hanging",vIdeographic:"v-ideographic",vMathematical:"v-mathematical",vectorEffect:"vector-effect",vertAdvY:"vert-adv-y",vertOriginX:"vert-origin-x",vertOriginY:"vert-origin-y",wordSpacing:"word-spacing",writingMode:"writing-mode",xHeight:"x-height",playbackOrder:"playbackorder",timelineBegin:"timelinebegin"},properties:{about:it,accentHeight:U,accumulate:null,additive:null,alignmentBaseline:null,alphabetic:U,amplitude:U,arabicForm:null,ascent:U,attributeName:null,attributeType:null,azimuth:U,bandwidth:null,baselineShift:null,baseFrequency:null,baseProfile:null,bbox:null,begin:null,bias:U,by:null,calcMode:null,capHeight:U,className:$e,clip:null,clipPath:null,clipPathUnits:null,clipRule:null,color:null,colorInterpolation:null,colorInterpolationFilters:null,colorProfile:null,colorRendering:null,content:null,contentScriptType:null,contentStyleType:null,crossOrigin:null,cursor:null,cx:null,cy:null,d:null,dataType:null,defaultAction:null,descent:U,diffuseConstant:U,direction:null,display:null,dur:null,divisor:U,dominantBaseline:null,download:we,dx:null,dy:null,edgeMode:null,editable:null,elevation:U,enableBackground:null,end:null,event:null,exponent:U,externalResourcesRequired:null,fill:null,fillOpacity:U,fillRule:null,filter:null,filterRes:null,filterUnits:null,floodColor:null,floodOpacity:null,focusable:null,focusHighlight:null,fontFamily:null,fontSize:null,fontSizeAdjust:null,fontStretch:null,fontStyle:null,fontVariant:null,fontWeight:null,format:null,fr:null,from:null,fx:null,fy:null,g1:mn,g2:mn,glyphName:mn,glyphOrientationHorizontal:null,glyphOrientationVertical:null,glyphRef:null,gradientTransform:null,gradientUnits:null,handler:null,hanging:U,hatchContentUnits:null,hatchUnits:null,height:null,href:null,hrefLang:null,horizAdvX:U,horizOriginX:U,horizOriginY:U,id:null,ideographic:U,imageRendering:null,initialVisibility:null,in:null,in2:null,intercept:U,k:U,k1:U,k2:U,k3:U,k4:U,kernelMatrix:it,kernelUnitLength:null,keyPoints:null,keySplines:null,keyTimes:null,kerning:null,lang:null,lengthAdjust:null,letterSpacing:null,lightingColor:null,limitingConeAngle:U,local:null,markerEnd:null,markerMid:null,markerStart:null,markerHeight:null,markerUnits:null,markerWidth:null,mask:null,maskContentUnits:null,maskUnits:null,mathematical:null,max:null,media:null,mediaCharacterEncoding:null,mediaContentEncodings:null,mediaSize:U,mediaTime:null,method:null,min:null,mode:null,name:null,navDown:null,navDownLeft:null,navDownRight:null,navLeft:null,navNext:null,navPrev:null,navRight:null,navUp:null,navUpLeft:null,navUpRight:null,numOctaves:null,observer:null,offset:null,onAbort:null,onActivate:null,onAfterPrint:null,onBeforePrint:null,onBegin:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnd:null,onEnded:null,onError:null,onFocus:null,onFocusIn:null,onFocusOut:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadStart:null,onMessage:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onMouseWheel:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRepeat:null,onReset:null,onResize:null,onScroll:null,onSeeked:null,onSeeking:null,onSelect:null,onShow:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnload:null,onVolumeChange:null,onWaiting:null,onZoom:null,opacity:null,operator:null,order:null,orient:null,orientation:null,origin:null,overflow:null,overlay:null,overlinePosition:U,overlineThickness:U,paintOrder:null,panose1:null,path:null,pathLength:U,patternContentUnits:null,patternTransform:null,patternUnits:null,phase:null,ping:$e,pitch:null,playbackOrder:null,pointerEvents:null,points:null,pointsAtX:U,pointsAtY:U,pointsAtZ:U,preserveAlpha:null,preserveAspectRatio:null,primitiveUnits:null,propagate:null,property:it,r:null,radius:null,referrerPolicy:null,refX:null,refY:null,rel:it,rev:it,renderingIntent:null,repeatCount:null,repeatDur:null,requiredExtensions:it,requiredFeatures:it,requiredFonts:it,requiredFormats:it,resource:null,restart:null,result:null,rotate:null,rx:null,ry:null,scale:null,seed:null,shapeRendering:null,side:null,slope:null,snapshotTime:null,specularConstant:U,specularExponent:U,spreadMethod:null,spacing:null,startOffset:null,stdDeviation:null,stemh:null,stemv:null,stitchTiles:null,stopColor:null,stopOpacity:null,strikethroughPosition:U,strikethroughThickness:U,string:null,stroke:null,strokeDashArray:it,strokeDashOffset:null,strokeLineCap:null,strokeLineJoin:null,strokeMiterLimit:U,strokeOpacity:U,strokeWidth:null,style:null,surfaceScale:U,syncBehavior:null,syncBehaviorDefault:null,syncMaster:null,syncTolerance:null,syncToleranceDefault:null,systemLanguage:it,tabIndex:U,tableValues:null,target:null,targetX:U,targetY:U,textAnchor:null,textDecoration:null,textRendering:null,textLength:null,timelineBegin:null,title:null,transformBehavior:null,type:null,typeOf:it,to:null,transform:null,transformOrigin:null,u1:null,u2:null,underlinePosition:U,underlineThickness:U,unicode:null,unicodeBidi:null,unicodeRange:null,unitsPerEm:U,values:null,vAlphabetic:U,vMathematical:U,vectorEffect:null,vHanging:U,vIdeographic:U,version:null,vertAdvY:U,vertOriginX:U,vertOriginY:U,viewBox:null,viewTarget:null,visibility:null,width:null,widths:null,wordSpacing:null,writingMode:null,x:null,x1:null,x2:null,xChannelSelector:null,xHeight:U,y:null,y1:null,y2:null,yChannelSelector:null,z:null,zoomAndPan:null},space:"svg",transform:el}),nl=xn({properties:{xLinkActuate:null,xLinkArcRole:null,xLinkHref:null,xLinkRole:null,xLinkShow:null,xLinkTitle:null,xLinkType:null},space:"xlink",transform(e,n){return"xlink:"+n.slice(5).toLowerCase()}}),rl=xn({attributes:{xmlnsxlink:"xmlns:xlink"},properties:{xmlnsXLink:null,xmlns:null},space:"xmlns",transform:tl}),il=xn({properties:{xmlBase:null,xmlLang:null,xmlSpace:null},space:"xml",transform(e,n){return"xml:"+n.slice(3).toLowerCase()}}),Km=/[A-Z]/g,Js=/-[a-z]/g,Zm=/^data[-\w.:]+$/i;function Xm(e,n){const t=zi(n);let r=n,s=et;if(t in e.normal)return e.property[e.normal[t]];if(t.length>4&&t.slice(0,4)==="data"&&Zm.test(n)){if(n.charAt(4)==="-"){const a=n.slice(5).replace(Js,tf);r="data"+a.charAt(0).toUpperCase()+a.slice(1)}else{const a=n.slice(4);if(!Js.test(a)){let o=a.replace(Km,ef);o.charAt(0)!=="-"&&(o="-"+o),n="data"+o}}s=ta}return new s(r,n)}function ef(e){return"-"+e.toLowerCase()}function tf(e){return e.charAt(1).toUpperCase()}const nf=Zo([Xo,Gm,nl,rl,il],"html"),al=Zo([Xo,Ym,nl,rl,il],"svg"),rf=/["&'<>`]/g,af=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,sf=/[\x01-\t\v\f\x0E-\x1F\x7F\x81\x8D\x8F\x90\x9D\xA0-\uFFFF]/g,of=/[|\\{}()[\]^$+*?.]/g,Qs=new WeakMap;function lf(e,n){if(e=e.replace(n.subset?cf(n.subset):rf,r),n.subset||n.escapeOnly)return e;return e.replace(af,t).replace(sf,r);function t(s,a,o){return n.format((s.charCodeAt(0)-55296)*1024+s.charCodeAt(1)-56320+65536,o.charCodeAt(a+2),n)}function r(s,a,o){return n.format(s.charCodeAt(0),o.charCodeAt(a+1),n)}}function cf(e){let n=Qs.get(e);return n||(n=uf(e),Qs.set(e,n)),n}function uf(e){const n=[];let t=-1;for(;++t<e.length;)n.push(e[t].replace(of,"\\$&"));return new RegExp("(?:"+n.join("|")+")","g")}const df=/[\dA-Fa-f]/;function pf(e,n,t){const r="&#x"+e.toString(16).toUpperCase();return t&&n&&!df.test(String.fromCharCode(n))?r:r+";"}const hf=/\d/;function mf(e,n,t){const r="&#"+String(e);return t&&n&&!hf.test(String.fromCharCode(n))?r:r+";"}const ff=["AElig","AMP","Aacute","Acirc","Agrave","Aring","Atilde","Auml","COPY","Ccedil","ETH","Eacute","Ecirc","Egrave","Euml","GT","Iacute","Icirc","Igrave","Iuml","LT","Ntilde","Oacute","Ocirc","Ograve","Oslash","Otilde","Ouml","QUOT","REG","THORN","Uacute","Ucirc","Ugrave","Uuml","Yacute","aacute","acirc","acute","aelig","agrave","amp","aring","atilde","auml","brvbar","ccedil","cedil","cent","copy","curren","deg","divide","eacute","ecirc","egrave","eth","euml","frac12","frac14","frac34","gt","iacute","icirc","iexcl","igrave","iquest","iuml","laquo","lt","macr","micro","middot","nbsp","not","ntilde","oacute","ocirc","ograve","ordf","ordm","oslash","otilde","ouml","para","plusmn","pound","quot","raquo","reg","sect","shy","sup1","sup2","sup3","szlig","thorn","times","uacute","ucirc","ugrave","uml","uuml","yacute","yen","yuml"],ji={nbsp:" ",iexcl:"¡",cent:"¢",pound:"£",curren:"¤",yen:"¥",brvbar:"¦",sect:"§",uml:"¨",copy:"©",ordf:"ª",laquo:"«",not:"¬",shy:"­",reg:"®",macr:"¯",deg:"°",plusmn:"±",sup2:"²",sup3:"³",acute:"´",micro:"µ",para:"¶",middot:"·",cedil:"¸",sup1:"¹",ordm:"º",raquo:"»",frac14:"¼",frac12:"½",frac34:"¾",iquest:"¿",Agrave:"À",Aacute:"Á",Acirc:"Â",Atilde:"Ã",Auml:"Ä",Aring:"Å",AElig:"Æ",Ccedil:"Ç",Egrave:"È",Eacute:"É",Ecirc:"Ê",Euml:"Ë",Igrave:"Ì",Iacute:"Í",Icirc:"Î",Iuml:"Ï",ETH:"Ð",Ntilde:"Ñ",Ograve:"Ò",Oacute:"Ó",Ocirc:"Ô",Otilde:"Õ",Ouml:"Ö",times:"×",Oslash:"Ø",Ugrave:"Ù",Uacute:"Ú",Ucirc:"Û",Uuml:"Ü",Yacute:"Ý",THORN:"Þ",szlig:"ß",agrave:"à",aacute:"á",acirc:"â",atilde:"ã",auml:"ä",aring:"å",aelig:"æ",ccedil:"ç",egrave:"è",eacute:"é",ecirc:"ê",euml:"ë",igrave:"ì",iacute:"í",icirc:"î",iuml:"ï",eth:"ð",ntilde:"ñ",ograve:"ò",oacute:"ó",ocirc:"ô",otilde:"õ",ouml:"ö",divide:"÷",oslash:"ø",ugrave:"ù",uacute:"ú",ucirc:"û",uuml:"ü",yacute:"ý",thorn:"þ",yuml:"ÿ",fnof:"ƒ",Alpha:"Α",Beta:"Β",Gamma:"Γ",Delta:"Δ",Epsilon:"Ε",Zeta:"Ζ",Eta:"Η",Theta:"Θ",Iota:"Ι",Kappa:"Κ",Lambda:"Λ",Mu:"Μ",Nu:"Ν",Xi:"Ξ",Omicron:"Ο",Pi:"Π",Rho:"Ρ",Sigma:"Σ",Tau:"Τ",Upsilon:"Υ",Phi:"Φ",Chi:"Χ",Psi:"Ψ",Omega:"Ω",alpha:"α",beta:"β",gamma:"γ",delta:"δ",epsilon:"ε",zeta:"ζ",eta:"η",theta:"θ",iota:"ι",kappa:"κ",lambda:"λ",mu:"μ",nu:"ν",xi:"ξ",omicron:"ο",pi:"π",rho:"ρ",sigmaf:"ς",sigma:"σ",tau:"τ",upsilon:"υ",phi:"φ",chi:"χ",psi:"ψ",omega:"ω",thetasym:"ϑ",upsih:"ϒ",piv:"ϖ",bull:"•",hellip:"…",prime:"′",Prime:"″",oline:"‾",frasl:"⁄",weierp:"℘",image:"ℑ",real:"ℜ",trade:"™",alefsym:"ℵ",larr:"←",uarr:"↑",rarr:"→",darr:"↓",harr:"↔",crarr:"↵",lArr:"⇐",uArr:"⇑",rArr:"⇒",dArr:"⇓",hArr:"⇔",forall:"∀",part:"∂",exist:"∃",empty:"∅",nabla:"∇",isin:"∈",notin:"∉",ni:"∋",prod:"∏",sum:"∑",minus:"−",lowast:"∗",radic:"√",prop:"∝",infin:"∞",ang:"∠",and:"∧",or:"∨",cap:"∩",cup:"∪",int:"∫",there4:"∴",sim:"∼",cong:"≅",asymp:"≈",ne:"≠",equiv:"≡",le:"≤",ge:"≥",sub:"⊂",sup:"⊃",nsub:"⊄",sube:"⊆",supe:"⊇",oplus:"⊕",otimes:"⊗",perp:"⊥",sdot:"⋅",lceil:"⌈",rceil:"⌉",lfloor:"⌊",rfloor:"⌋",lang:"〈",rang:"〉",loz:"◊",spades:"♠",clubs:"♣",hearts:"♥",diams:"♦",quot:'"',amp:"&",lt:"<",gt:">",OElig:"Œ",oelig:"œ",Scaron:"Š",scaron:"š",Yuml:"Ÿ",circ:"ˆ",tilde:"˜",ensp:" ",emsp:" ",thinsp:" ",zwnj:"‌",zwj:"‍",lrm:"‎",rlm:"‏",ndash:"–",mdash:"—",lsquo:"‘",rsquo:"’",sbquo:"‚",ldquo:"“",rdquo:"”",bdquo:"„",dagger:"†",Dagger:"‡",permil:"‰",lsaquo:"‹",rsaquo:"›",euro:"€"},gf=["cent","copy","divide","gt","lt","not","para","times"],sl={}.hasOwnProperty,Ui={};let gr;for(gr in ji)sl.call(ji,gr)&&(Ui[ji[gr]]=gr);const yf=/[^\dA-Za-z]/;function xf(e,n,t,r){const s=String.fromCharCode(e);if(sl.call(Ui,s)){const a=Ui[s],o="&"+a;return t&&ff.includes(a)&&!gf.includes(a)&&(!r||n&&n!==61&&yf.test(String.fromCharCode(n)))?o:o+";"}return""}function bf(e,n,t){let r=pf(e,n,t.omitOptionalSemicolons),s;if((t.useNamedReferences||t.useShortestReferences)&&(s=xf(e,n,t.omitOptionalSemicolons,t.attribute)),(t.useShortestReferences||!s)&&t.useShortestReferences){const a=mf(e,n,t.omitOptionalSemicolons);a.length<r.length&&(r=a)}return s&&(!t.useShortestReferences||s.length<r.length)?s:r}function fn(e,n){return lf(e,Object.assign({format:bf},n))}const wf=/^>|^->|<!--|-->|--!>|<!-$/g,kf=[">"],_f=["<",">"];function Nf(e,n,t,r){return r.settings.bogusComments?"<?"+fn(e.value,Object.assign({},r.settings.characterReferences,{subset:kf}))+">":"<!--"+e.value.replace(wf,s)+"-->";function s(a){return fn(a,Object.assign({},r.settings.characterReferences,{subset:_f}))}}function vf(e,n,t,r){return"<!"+(r.settings.upperDoctype?"DOCTYPE":"doctype")+(r.settings.tightDoctype?"":" ")+"html>"}function Gs(e,n){const t=String(e);if(typeof n!="string")throw new TypeError("Expected character");let r=0,s=t.indexOf(n);for(;s!==-1;)r++,s=t.indexOf(n,s+n.length);return r}function jf(e,n){const t=n||{};return(e[e.length-1]===""?[...e,""]:e).join((t.padRight?" ":"")+","+(t.padLeft===!1?"":" ")).trim()}function Cf(e){return e.join(" ").trim()}const Sf=/[ \t\n\f\r]/g;function na(e){return typeof e=="object"?e.type==="text"?Ys(e.value):!1:Ys(e)}function Ys(e){return e.replace(Sf,"")===""}const Me=ll(1),ol=ll(-1),Tf=[];function ll(e){return n;function n(t,r,s){const a=t?t.children:Tf;let o=(r||0)+e,l=a[o];if(!s)for(;l&&na(l);)o+=e,l=a[o];return l}}const Pf={}.hasOwnProperty;function cl(e){return n;function n(t,r,s){return Pf.call(e,t.tagName)&&e[t.tagName](t,r,s)}}const ra=cl({body:Af,caption:Ci,colgroup:Ci,dd:Of,dt:$f,head:Ci,html:Ef,li:If,optgroup:Lf,option:Rf,p:Df,rp:Ks,rt:Ks,tbody:zf,td:Zs,tfoot:qf,th:Zs,thead:Ff,tr:Bf});function Ci(e,n,t){const r=Me(t,n,!0);return!r||r.type!=="comment"&&!(r.type==="text"&&na(r.value.charAt(0)))}function Ef(e,n,t){const r=Me(t,n);return!r||r.type!=="comment"}function Af(e,n,t){const r=Me(t,n);return!r||r.type!=="comment"}function Df(e,n,t){const r=Me(t,n);return r?r.type==="element"&&(r.tagName==="address"||r.tagName==="article"||r.tagName==="aside"||r.tagName==="blockquote"||r.tagName==="details"||r.tagName==="div"||r.tagName==="dl"||r.tagName==="fieldset"||r.tagName==="figcaption"||r.tagName==="figure"||r.tagName==="footer"||r.tagName==="form"||r.tagName==="h1"||r.tagName==="h2"||r.tagName==="h3"||r.tagName==="h4"||r.tagName==="h5"||r.tagName==="h6"||r.tagName==="header"||r.tagName==="hgroup"||r.tagName==="hr"||r.tagName==="main"||r.tagName==="menu"||r.tagName==="nav"||r.tagName==="ol"||r.tagName==="p"||r.tagName==="pre"||r.tagName==="section"||r.tagName==="table"||r.tagName==="ul"):!t||!(t.type==="element"&&(t.tagName==="a"||t.tagName==="audio"||t.tagName==="del"||t.tagName==="ins"||t.tagName==="map"||t.tagName==="noscript"||t.tagName==="video"))}function If(e,n,t){const r=Me(t,n);return!r||r.type==="element"&&r.tagName==="li"}function $f(e,n,t){const r=Me(t,n);return!!(r&&r.type==="element"&&(r.tagName==="dt"||r.tagName==="dd"))}function Of(e,n,t){const r=Me(t,n);return!r||r.type==="element"&&(r.tagName==="dt"||r.tagName==="dd")}function Ks(e,n,t){const r=Me(t,n);return!r||r.type==="element"&&(r.tagName==="rp"||r.tagName==="rt")}function Lf(e,n,t){const r=Me(t,n);return!r||r.type==="element"&&r.tagName==="optgroup"}function Rf(e,n,t){const r=Me(t,n);return!r||r.type==="element"&&(r.tagName==="option"||r.tagName==="optgroup")}function Ff(e,n,t){const r=Me(t,n);return!!(r&&r.type==="element"&&(r.tagName==="tbody"||r.tagName==="tfoot"))}function zf(e,n,t){const r=Me(t,n);return!r||r.type==="element"&&(r.tagName==="tbody"||r.tagName==="tfoot")}function qf(e,n,t){return!Me(t,n)}function Bf(e,n,t){const r=Me(t,n);return!r||r.type==="element"&&r.tagName==="tr"}function Zs(e,n,t){const r=Me(t,n);return!r||r.type==="element"&&(r.tagName==="td"||r.tagName==="th")}const Uf=cl({body:Wf,colgroup:Vf,head:Hf,html:Mf,tbody:Jf});function Mf(e){const n=Me(e,-1);return!n||n.type!=="comment"}function Hf(e){const n=new Set;for(const r of e.children)if(r.type==="element"&&(r.tagName==="base"||r.tagName==="title")){if(n.has(r.tagName))return!1;n.add(r.tagName)}const t=e.children[0];return!t||t.type==="element"}function Wf(e){const n=Me(e,-1,!0);return!n||n.type!=="comment"&&!(n.type==="text"&&na(n.value.charAt(0)))&&!(n.type==="element"&&(n.tagName==="meta"||n.tagName==="link"||n.tagName==="script"||n.tagName==="style"||n.tagName==="template"))}function Vf(e,n,t){const r=ol(t,n),s=Me(e,-1,!0);return t&&r&&r.type==="element"&&r.tagName==="colgroup"&&ra(r,t.children.indexOf(r),t)?!1:!!(s&&s.type==="element"&&s.tagName==="col")}function Jf(e,n,t){const r=ol(t,n),s=Me(e,-1);return t&&r&&r.type==="element"&&(r.tagName==="thead"||r.tagName==="tbody")&&ra(r,t.children.indexOf(r),t)?!1:!!(s&&s.type==="element"&&s.tagName==="tr")}const yr={name:[[`	
\f\r &/=>`.split(""),`	
\f\r "&'/=>\``.split("")],[`\0	
\f\r "&'/<=>`.split(""),`\0	
\f\r "&'/<=>\``.split("")]],unquoted:[[`	
\f\r &>`.split(""),`\0	
\f\r "&'<=>\``.split("")],[`\0	
\f\r "&'<=>\``.split(""),`\0	
\f\r "&'<=>\``.split("")]],single:[["&'".split(""),"\"&'`".split("")],["\0&'".split(""),"\0\"&'`".split("")]],double:[['"&'.split(""),"\"&'`".split("")],['\0"&'.split(""),"\0\"&'`".split("")]]};function Qf(e,n,t,r){const s=r.schema,a=s.space==="svg"?!1:r.settings.omitOptionalTags;let o=s.space==="svg"?r.settings.closeEmptyElements:r.settings.voids.includes(e.tagName.toLowerCase());const l=[];let c;s.space==="html"&&e.tagName==="svg"&&(r.schema=al);const u=Gf(r,e.properties),m=r.all(s.space==="html"&&e.tagName==="template"?e.content:e);return r.schema=s,m&&(o=!1),(u||!a||!Uf(e,n,t))&&(l.push("<",e.tagName,u?" "+u:""),o&&(s.space==="svg"||r.settings.closeSelfClosing)&&(c=u.charAt(u.length-1),(!r.settings.tightSelfClosing||c==="/"||c&&c!=='"'&&c!=="'")&&l.push(" "),l.push("/")),l.push(">")),l.push(m),!o&&(!a||!ra(e,n,t))&&l.push("</"+e.tagName+">"),l.join("")}function Gf(e,n){const t=[];let r=-1,s;if(n){for(s in n)if(n[s]!==null&&n[s]!==void 0){const a=Yf(e,s,n[s]);a&&t.push(a)}}for(;++r<t.length;){const a=e.settings.tightAttributes?t[r].charAt(t[r].length-1):void 0;r!==t.length-1&&a!=='"'&&a!=="'"&&(t[r]+=" ")}return t.join("")}function Yf(e,n,t){const r=Xm(e.schema,n),s=e.settings.allowParseErrors&&e.schema.space==="html"?0:1,a=e.settings.allowDangerousCharacters?0:1;let o=e.quote,l;if(r.overloadedBoolean&&(t===r.attribute||t==="")?t=!0:(r.boolean||r.overloadedBoolean)&&(typeof t!="string"||t===r.attribute||t==="")&&(t=!!t),t==null||t===!1||typeof t=="number"&&Number.isNaN(t))return"";const c=fn(r.attribute,Object.assign({},e.settings.characterReferences,{subset:yr.name[s][a]}));return t===!0||(t=Array.isArray(t)?(r.commaSeparated?jf:Cf)(t,{padLeft:!e.settings.tightCommaSeparatedLists}):String(t),e.settings.collapseEmptyAttributes&&!t)?c:(e.settings.preferUnquoted&&(l=fn(t,Object.assign({},e.settings.characterReferences,{attribute:!0,subset:yr.unquoted[s][a]}))),l!==t&&(e.settings.quoteSmart&&Gs(t,o)>Gs(t,e.alternative)&&(o=e.alternative),l=o+fn(t,Object.assign({},e.settings.characterReferences,{subset:(o==="'"?yr.single:yr.double)[s][a],attribute:!0}))+o),c+(l&&"="+l))}const Kf=["<","&"];function ul(e,n,t,r){return t&&t.type==="element"&&(t.tagName==="script"||t.tagName==="style")?e.value:fn(e.value,Object.assign({},r.settings.characterReferences,{subset:Kf}))}function Zf(e,n,t,r){return r.settings.allowDangerousHtml?e.value:ul(e,n,t,r)}function Xf(e,n,t,r){return r.all(e)}const eg=vo("type",{invalid:tg,unknown:ng,handlers:{comment:Nf,doctype:vf,element:Qf,raw:Zf,root:Xf,text:ul}});function tg(e){throw new Error("Expected node, not `"+e+"`")}function ng(e){const n=e;throw new Error("Cannot compile unknown node `"+n.type+"`")}const rg={},ig={},ag=[];function sg(e,n){const t=n||rg,r=t.quote||'"',s=r==='"'?"'":'"';if(r!=='"'&&r!=="'")throw new Error("Invalid quote `"+r+"`, expected `'` or `\"`");return{one:og,all:lg,settings:{omitOptionalTags:t.omitOptionalTags||!1,allowParseErrors:t.allowParseErrors||!1,allowDangerousCharacters:t.allowDangerousCharacters||!1,quoteSmart:t.quoteSmart||!1,preferUnquoted:t.preferUnquoted||!1,tightAttributes:t.tightAttributes||!1,upperDoctype:t.upperDoctype||!1,tightDoctype:t.tightDoctype||!1,bogusComments:t.bogusComments||!1,tightCommaSeparatedLists:t.tightCommaSeparatedLists||!1,tightSelfClosing:t.tightSelfClosing||!1,collapseEmptyAttributes:t.collapseEmptyAttributes||!1,allowDangerousHtml:t.allowDangerousHtml||!1,voids:t.voids||Jm,characterReferences:t.characterReferences||ig,closeSelfClosing:t.closeSelfClosing||!1,closeEmptyElements:t.closeEmptyElements||!1},schema:t.space==="svg"?al:nf,quote:r,alternative:s}.one(Array.isArray(e)?{type:"root",children:e}:e,void 0,void 0)}function og(e,n,t){return eg(e,n,t,this)}function lg(e){const n=[],t=e&&e.children||ag;let r=-1;for(;++r<t.length;)n[r]=this.one(t[r],r,e);return n.join("")}const cg={};function Si(e){const n=this,{handlers:t,sanitize:r,...s}=e||cg;let a=!1,o;typeof r=="boolean"?a=!r:r&&(o=r),n.compiler=l;function l(c,u){const m=Vm(c,{handlers:t,allowDangerousHtml:a}),d=a?m:nm(m,o),y=sg(d,{...s,allowDangerousHtml:a});return u.extname&&(u.extname=".html"),c&&c.type==="root"&&y&&/[^\r\n]/.test(y.charAt(y.length-1))?y+`
`:y}}const ug="_modalOverlay_8xawn_1",dg="_modalContent_8xawn_31",pg="_modalHeader_8xawn_59",hg="_modalTitle_8xawn_77",mg="_modalCloseButton_8xawn_91",fg="_modalBody_8xawn_123",gg="_formGroup_8xawn_135",yg="_inputField_8xawn_159",xg="_searchResultsCard_8xawn_193",bg="_searchResultsList_8xawn_221",wg="_searchResultItem_8xawn_233",kg="_searchResultPrice_8xawn_265",_g="_selectedTestsCard_8xawn_277",Ng="_selectedTestsHeader_8xawn_293",vg="_noTestsMessage_8xawn_313",jg="_selectedTestsList_8xawn_329",Cg="_selectedTestItem_8xawn_341",Sg="_selectedTestName_8xawn_365",Tg="_removeTestButton_8xawn_377",Pg="_quantityRow_8xawn_407",Eg="_quantityGroup_8xawn_421",Ag="_quantityLabel_8xawn_429",Dg="_compactInput_8xawn_445",Ig="_modalFooter_8xawn_453",$g="_button_8xawn_471",Og="_buttonPrimary_8xawn_491",Lg="_buttonSecondary_8xawn_511",Rg="_buttonDisabled_8xawn_533",Fg="_errorText_8xawn_543",zg="_noResults_8xawn_563",qg="_skeletonContainer_8xawn_577",Bg="_skeletonItem_8xawn_585",Ne={modalOverlay:ug,modalContent:dg,modalHeader:pg,modalTitle:hg,modalCloseButton:mg,modalBody:fg,formGroup:gg,inputField:yg,searchResultsCard:xg,searchResultsList:bg,searchResultItem:wg,searchResultPrice:kg,selectedTestsCard:_g,selectedTestsHeader:Ng,noTestsMessage:vg,selectedTestsList:jg,selectedTestItem:Cg,selectedTestName:Sg,removeTestButton:Tg,quantityRow:Pg,quantityGroup:Eg,quantityLabel:Ag,compactInput:Dg,modalFooter:Ig,button:$g,buttonPrimary:Og,buttonSecondary:Lg,buttonDisabled:Rg,errorText:Fg,noResults:zg,skeletonContainer:qg,skeletonItem:Bg},Ug=({isOpen:e,onClose:n,patientId:t,pharmacyInventory:r,fetchPharmacyOrdersData:s,isLoadingInventory:a=!1})=>{const[o,l]=x.useState([]),[c,u]=x.useState(""),[m,d]=x.useState([]),[y,p]=x.useState(null),[E,q]=x.useState(!1);eo(void 0,e?200:99999);const G=x.useMemo(()=>new to(r,{keys:["name"],threshold:.3}),[r]);x.useEffect(()=>{if(!c){d([]);return}const F=G.search(c).map(j=>j.item);d(F.slice(0,10))},[c,G]);const O=async()=>{if(!t){p("Patient ID is missing.");return}if(o.length===0){p("Please select at least one drug.");return}for(const F of o)if(F.selected_pack_quantity===0&&F.selected_loose_quantity===0){p(`Please specify a quantity for ${F.name}.`);return}q(!0),p(null);try{const F={patient_id:t,items:o.map(X=>({drug_id:X.id,name:X.name,pack_quantity:X.selected_pack_quantity,loose_quantity:X.selected_loose_quantity,pack_price:0,loose_price:0,total_price:0,tabletsPerDay:1,numberOfDays:1,directions_to_use:"As directed"})),order_total:0,prescription_for_unavailable_drugs:""},j=await Y("/api/pharmacy-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(F)});if(!j.ok){const X=await j.json().catch(()=>({}));throw new Error(X.message||`Failed to create pharmacy order: ${j.statusText} `)}await j.json(),s(t),n(),l([]),u("")}catch(F){p(`Order Creation Error: ${F.message} `)}finally{q(!1)}},B=F=>{if(o.some(j=>j.id===F.id)){p(`${F.name} is already in the order.`),setTimeout(()=>p(null),3e3),u(""),d([]);return}l(j=>[...j,{...F,selected_pack_quantity:0,selected_loose_quantity:0}]),u(""),d([])},I=F=>{l(j=>j.filter(X=>X.id!==F))},W=(F,j,X)=>{const le=parseInt(X)||0;l(ne=>ne.map(oe=>oe.id===F?{...oe,[j==="pack"?"selected_pack_quantity":"selected_loose_quantity"]:le}:oe))};return e?i.jsx("div",{className:Ne.modalOverlay,children:i.jsxs("div",{className:Ne.modalContent,children:[i.jsxs("div",{className:Ne.modalHeader,children:[i.jsx("h3",{className:Ne.modalTitle,children:"Create Pharmacy Order"}),i.jsx("button",{onClick:n,className:Ne.modalCloseButton,children:i.jsx(gn,{size:20})})]}),i.jsxs("div",{className:Ne.modalBody,children:[y&&i.jsx("div",{className:Ne.errorText,children:y}),i.jsxs("div",{className:Ne.formGroup,style:{position:"relative"},children:[i.jsx("label",{htmlFor:"drug-search",children:"Add Drug"}),i.jsx("input",{type:"text",id:"drug-search",placeholder:"Search available drugs...",value:c,onChange:F=>u(F.target.value),className:Ne.inputField,autoComplete:"off"}),c&&i.jsx("div",{className:Ne.searchResultsCard,children:a?i.jsx("div",{className:Ne.skeletonContainer,children:[1,2,3].map(F=>i.jsxs("div",{className:Ne.skeletonItem,children:[i.jsx(Te,{width:"60%",height:20}),i.jsx(Te,{width:"30%",height:20})]},F))}):m.length>0?i.jsx("ul",{className:Ne.searchResultsList,children:m.map(F=>i.jsx("li",{onClick:()=>B(F),className:Ne.searchResultItem,children:i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"},children:[i.jsx("span",{children:F.name}),i.jsxs("span",{className:Ne.searchResultPrice,children:["Stock: ",F.stock," (Box) / ",F.loose||0," (Loose)"]})]})},F.id))}):i.jsx("div",{className:Ne.noResults,children:"No drugs found."})})]}),i.jsxs("div",{className:Ne.selectedTestsCard,children:[i.jsx("h4",{className:Ne.selectedTestsHeader,children:"Selected Drugs"}),o.length===0?i.jsx("p",{className:Ne.noTestsMessage,children:"No drugs added yet."}):i.jsx("ul",{className:Ne.selectedTestsList,children:o.map(F=>i.jsxs("li",{className:Ne.selectedTestItem,children:[i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",width:"100%",alignItems:"center"},children:[i.jsx("span",{className:Ne.selectedTestName,children:F.name}),i.jsx("button",{type:"button",onClick:()=>I(String(F.id)),className:Ne.removeTestButton,title:"Remove Drug",children:i.jsx(yt,{size:16})})]}),i.jsxs("div",{className:Ne.quantityRow,children:[i.jsxs("div",{className:Ne.quantityGroup,children:[i.jsx("label",{className:Ne.quantityLabel,children:"Packs"}),i.jsx("input",{type:"number",min:"0",className:`${Ne.inputField} ${Ne.compactInput}`,value:F.selected_pack_quantity||"",onChange:j=>W(F.id,"pack",j.target.value),placeholder:"0"})]}),i.jsxs("div",{className:Ne.quantityGroup,children:[i.jsx("label",{className:Ne.quantityLabel,children:"Loose"}),i.jsx("input",{type:"number",min:"0",className:`${Ne.inputField} ${Ne.compactInput}`,value:F.selected_loose_quantity||"",onChange:j=>W(F.id,"loose",j.target.value),placeholder:"0"})]})]})]},F.id))})]})]}),i.jsxs("div",{className:Ne.modalFooter,children:[i.jsx("button",{type:"button",onClick:n,className:`${Ne.button} ${Ne.buttonSecondary}`,children:" Cancel "}),i.jsxs("button",{type:"button",onClick:O,disabled:o.length===0||E,className:`${Ne.button} ${Ne.buttonPrimary} ${o.length===0||E?Ne.buttonDisabled:""}`,children:[" ",E?"Creating...":"Create Order"," "]})]})]})}):null},Mg=({isOpen:e,onClose:n,onSuccess:t,patientId:r,initialItems:s})=>{const[a,o]=x.useState([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:"",packs:0,loose:0,pack_size:1}]),[l,c]=x.useState(30),[u,m]=x.useState(""),[d,y]=x.useState(null),[p,E]=x.useState(""),[q,G]=x.useState([]),[O,B]=x.useState(!1),[I,W]=x.useState(!1),[F,j]=x.useState(null),X=x.useRef(null);x.useEffect(()=>{if(e){s&&s.length>0?o(s):o([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:"",packs:0,loose:0,pack_size:1}]);const A=new Date;A.setDate(A.getDate()+30),m(A.toISOString().split("T")[0]),c(30)}},[e,s]);const le=x.useCallback(async A=>{if(!A.trim()){G([]);return}B(!0);try{const M=await Y(`/api/drugs?search=${encodeURIComponent(A)}&limit=10`);if(M.ok){const J=await M.json();G(J.drugs||[])}}catch(M){console.error("Error searching drugs:",M)}finally{B(!1)}},[]);x.useEffect(()=>{X.current&&clearTimeout(X.current),p&&d!==null?X.current=setTimeout(()=>le(p),300):G([])},[p,d,le]);const ne=A=>{if(!A)return 1;const M=A.match(/(?:\d+x)?(\d+)(?:s|tabs)?/i);return M?parseInt(M[1],10):1},oe=(A,M)=>{const J=[...a];J[M]={...J[M],medication_name:A.name,drug_id:A.id,pack_size:ne(A.pack),packs:0,loose:0,quantity:0},o(J),y(null),E(""),G([])},V=(A,M,J)=>{const Se=[...a],he={...Se[A]},w=he.pack_size||1;if(M==="packs"||M==="loose"){const ze=parseInt(J)||0;M==="packs"&&(he.packs=ze),M==="loose"&&(he.loose=ze);const ke=he.packs||0,b=he.loose||0;he.quantity=ke*w+b}else if(M==="tablets_per_day"||M==="number_of_days"){M==="tablets_per_day"&&(he.tablets_per_day=J),M==="number_of_days"&&(he.number_of_days=J);const ze=parseFloat(he.tablets_per_day.toString())||0,ke=parseInt(he.number_of_days.toString())||0,b=Math.ceil(ze*ke);he.quantity=b,he.packs=Math.floor(b/w),he.loose=b%w}else he[M]=J;Se[A]=he,o(Se)},_=()=>{o([...a,{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:l,directions:"",notes:"",packs:0,loose:0,pack_size:1}])},C=A=>{a.length>1&&o(a.filter((M,J)=>J!==A))},K=async A=>{if(A.preventDefault(),j(null),!r){j("Patient ID is missing.");return}if(a.some(J=>!J.medication_name||J.quantity<=0)){j("Please ensure all items have a medication name and valid quantity.");return}W(!0);try{const J={patient_id:r,items:a.map(he=>({medication_name:he.medication_name,drug_id:he.drug_id,quantity:he.quantity,tablets_per_day:he.tablets_per_day,number_of_days:he.number_of_days,directions:he.directions,notes:he.notes,frequency_days:l,next_delivery_date:u}))},Se=await Y("/api/recurring-medications",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(J)});if(!Se.ok){const he=await Se.json();throw new Error(he.message+(he.error?": "+he.error:"")||"Failed to create recurring medication.")}t(),n()}catch(J){j(J.message)}finally{W(!1)}};return e?i.jsx("div",{className:"modal-overlay",children:i.jsxs("div",{className:"add-recurring-modal wide-modal",children:[i.jsxs("div",{className:"modal-header",children:[i.jsx("h3",{children:"Add Recurring Medications"}),i.jsx("button",{className:"close-btn",onClick:n,children:i.jsx(gn,{size:20})})]}),i.jsxs("div",{className:"modal-body",children:[F&&i.jsx("div",{className:"error-message",children:F}),i.jsxs("form",{onSubmit:K,className:"recurring-form",children:[i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group flex-1",children:[i.jsxs("label",{children:[i.jsx(no,{size:16})," Frequency"]}),i.jsxs("select",{value:l,onChange:A=>{const M=parseInt(A.target.value);c(M);const J=new Date;J.setDate(J.getDate()+M),m(J.toISOString().split("T")[0]);const Se=a.map(he=>({...he,number_of_days:M}));o(Se)},children:[i.jsx("option",{value:15,children:"Every 15 Days"}),i.jsx("option",{value:30,children:"Every 30 Days"}),i.jsx("option",{value:60,children:"Every 60 Days"}),i.jsx("option",{value:90,children:"Every 90 Days"})]})]}),i.jsxs("div",{className:"form-group flex-1",children:[i.jsxs("label",{children:[i.jsx(Nr,{size:16})," Next Delivery"]}),i.jsx("input",{type:"date",value:u,onChange:A=>m(A.target.value)})]})]}),i.jsx("hr",{className:"divider"}),i.jsxs("div",{className:"items-header",children:[i.jsx("h4",{children:"Medications"}),i.jsxs("button",{type:"button",className:"add-item-btn",onClick:_,children:[i.jsx(xr,{size:14})," Add Drug"]})]}),i.jsx("div",{className:"items-list",children:a.map((A,M)=>i.jsxs("div",{className:"medication-item-row",children:[i.jsxs("div",{className:"row-top",children:[i.jsxs("div",{className:"form-group med-search-group",children:[i.jsx("label",{children:"Drug Name"}),i.jsxs("div",{className:"search-wrapper",children:[i.jsx("input",{type:"text",placeholder:"Search drug...",value:d===M?p:A.medication_name,onFocus:()=>{y(M),E(A.medication_name)},onChange:J=>{E(J.target.value),V(M,"medication_name",J.target.value)}}),d===M&&O&&i.jsx("span",{className:"spinner",children:"..."}),d===M&&p&&q.length>0&&i.jsx("ul",{className:"suggestions-list",children:q.map(J=>i.jsxs("li",{onClick:()=>oe(J,M),children:[i.jsx("div",{className:"suggestion-name",children:J.name}),i.jsxs("div",{className:"suggestion-details",children:["Stock: ",J.stock]})]},J.id))})]})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Tabs/Day"}),i.jsx("input",{type:"number",min:"0.5",step:"0.5",value:A.tablets_per_day,onChange:J=>V(M,"tablets_per_day",J.target.value)})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Days"}),i.jsx("input",{type:"number",min:"1",value:A.number_of_days,onChange:J=>V(M,"number_of_days",J.target.value)})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Packs"}),i.jsx("input",{type:"number",min:"0",value:A.packs||"",onChange:J=>V(M,"packs",J.target.value),placeholder:"0"})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Loose"}),i.jsx("input",{type:"number",min:"0",value:A.loose||"",onChange:J=>V(M,"loose",J.target.value),placeholder:"0"})]}),i.jsxs("div",{className:"form-group small-input",children:[i.jsx("label",{children:"Total"}),i.jsx("input",{type:"number",value:A.quantity,disabled:!0,className:"input-disabled"})]}),i.jsx("button",{type:"button",className:"remove-btn",onClick:()=>C(M),disabled:a.length===1,children:i.jsx(yt,{size:16})})]}),i.jsxs("div",{className:"row-bottom",children:[i.jsx("div",{className:"form-group flex-1",children:i.jsx("input",{type:"text",placeholder:"Directions (e.g. 1-0-1 after food)",value:A.directions,onChange:J=>V(M,"directions",J.target.value)})}),i.jsx("div",{className:"form-group flex-1",children:i.jsx("input",{type:"text",placeholder:"Notes",value:A.notes,onChange:J=>V(M,"notes",J.target.value)})})]})]},A.id))}),i.jsxs("div",{className:"modal-actions",children:[i.jsx("button",{type:"button",className:"btn-cancel",onClick:n,children:"Cancel"}),i.jsx("button",{type:"submit",className:"btn-submit",disabled:I,children:I?"Creating...":"Create Recurring Order"})]})]})]})]})}):null},Hg=({isOpen:e,onClose:n,onSuccess:t,medication:r})=>{const[s,a]=x.useState(""),[o,l]=x.useState(0),[c,u]=x.useState(1),[m,d]=x.useState(30),[y,p]=x.useState(""),[E,q]=x.useState(""),[G,O]=x.useState(30),[B,I]=x.useState(""),[W,F]=x.useState("active"),[j,X]=x.useState(!1),[le,ne]=x.useState(null);x.useEffect(()=>{if(e&&r){a(r.medicationName),l(r.quantity),u(r.tabletsPerDay||1),d(r.numberOfDays||30),p(r.directions||""),q(r.notes||""),O(r.frequencyDays),F(r.status);try{const _=new Date(r.nextDeliveryDate);isNaN(_.getTime())||I(_.toISOString().split("T")[0])}catch(_){console.error("Error parsing date",_)}}},[e,r]);const oe=async _=>{if(_.preventDefault(),ne(null),!s||o<=0){ne("Please provide a valid medication name and quantity.");return}X(!0);try{const C={medication_name:s,quantity:o,tablets_per_day:c,number_of_days:m,directions:y,notes:E,frequency_days:G,next_delivery_date:B,status:W},K=await Y(`/api/recurring-medications/${r.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(C)});if(!K.ok){const A=await K.json();throw new Error(A.message||"Failed to update recurring medication.")}t(),n()}catch(C){ne(C.message)}finally{X(!1)}},V=async()=>{if(window.confirm("Are you sure you want to delete this recurring medication?")){X(!0);try{if(!(await Y(`/api/recurring-medications/${r.id}`,{method:"DELETE"})).ok)throw new Error("Failed to delete recurring medication.");t(),n()}catch(_){ne(_.message)}finally{X(!1)}}};return e?i.jsx("div",{className:"modal-overlay",children:i.jsxs("div",{className:"add-recurring-modal medium-modal",children:[i.jsxs("div",{className:"modal-header",children:[i.jsx("h3",{children:"Edit Recurring Medication"}),i.jsx("button",{className:"close-btn",onClick:n,children:i.jsx(gn,{size:20})})]}),i.jsxs("div",{className:"modal-body",children:[le&&i.jsx("div",{className:"error-message",children:le}),i.jsxs("form",{onSubmit:oe,className:"recurring-form",children:[i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Medication Name"}),i.jsx("input",{type:"text",value:s,onChange:_=>a(_.target.value)})]}),i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group flex-1",children:[i.jsxs("label",{children:[i.jsx(no,{size:16})," Frequency"]}),i.jsxs("select",{value:G,onChange:_=>O(parseInt(_.target.value)),children:[i.jsx("option",{value:15,children:"Every 15 Days"}),i.jsx("option",{value:30,children:"Every 30 Days"}),i.jsx("option",{value:60,children:"Every 60 Days"}),i.jsx("option",{value:90,children:"Every 90 Days"})]})]}),i.jsxs("div",{className:"form-group flex-1",children:[i.jsxs("label",{children:[i.jsx(Nr,{size:16})," Next Delivery"]}),i.jsx("input",{type:"date",value:B,onChange:_=>I(_.target.value)})]})]}),i.jsxs("div",{className:"order-settings-row",children:[i.jsxs("div",{className:"form-group flex-1",children:[i.jsx("label",{children:"Tabs/Day"}),i.jsx("input",{type:"number",min:"0.5",step:"0.5",value:c,onChange:_=>u(parseFloat(_.target.value))})]}),i.jsxs("div",{className:"form-group flex-1",children:[i.jsx("label",{children:"Days"}),i.jsx("input",{type:"number",min:"1",value:m,onChange:_=>d(parseInt(_.target.value))})]}),i.jsxs("div",{className:"form-group flex-1",children:[i.jsx("label",{children:"Total Qty"}),i.jsx("input",{type:"number",min:"1",value:o,onChange:_=>l(parseInt(_.target.value))})]})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Directions"}),i.jsx("input",{type:"text",value:y,onChange:_=>p(_.target.value)})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Notes"}),i.jsx("input",{type:"text",value:E,onChange:_=>q(_.target.value)})]}),i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"Status"}),i.jsxs("select",{value:W,onChange:_=>F(_.target.value),children:[i.jsx("option",{value:"active",children:"Active"}),i.jsx("option",{value:"paused",children:"Paused"}),i.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),i.jsxs("div",{className:"modal-actions space-between",children:[i.jsxs("button",{type:"button",className:"btn-delete-text",onClick:V,children:[i.jsx(yt,{size:16})," Delete"]}),i.jsxs("div",{className:"flex-row gap-10",children:[i.jsx("button",{type:"button",className:"btn-cancel",onClick:n,children:"Cancel"}),i.jsx("button",{type:"submit",className:"btn-submit",disabled:j,children:j?"Saving...":"Save Changes"})]})]})]})]})]})}):null},Wg=({isOpen:e,onClose:n,billData:t})=>{if(x.useEffect(()=>{if(e&&t){const a=setTimeout(()=>{window.print()},500);return()=>clearTimeout(a)}},[e,t]),!e||!t)return null;const r=t.clinicUpiId&&t.grandTotal>0?`upi://pay?pa=${t.clinicUpiId}&pn=${encodeURIComponent(t.clinicName)}&am=${t.grandTotal.toFixed(2)}&cu=INR`:"",s=i.jsxs("div",{id:"print-modal-root",className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 print:bg-white print:static print:block",children:[i.jsxs("div",{className:"bg-white w-full max-w-4xl h-[90vh] overflow-y-auto rounded-lg shadow-xl print:shadow-none print:w-full print:max-w-none print:h-auto print:overflow-visible relative",children:[i.jsx("button",{onClick:n,className:"absolute top-4 right-4 z-50 p-2 bg-gray-100 hover:bg-gray-200 rounded-full no-print",children:i.jsx(gn,{size:24})}),i.jsx("div",{className:"pharmacy-billing-page",style:{padding:0,minHeight:"auto",background:"white"},children:i.jsx("div",{className:"billing-container printable-section",style:{border:"none",boxShadow:"none",maxWidth:"100%",margin:0},children:i.jsxs("div",{className:"p-8 print:p-0",children:[t.labLetterheadUrl&&i.jsx("div",{className:"print-letterhead-container mb-4",children:i.jsx("img",{src:t.labLetterheadUrl,alt:"Lab Letterhead",className:"print-letterhead-image w-full object-contain max-h-[150px]"})}),i.jsxs("div",{className:"billing-header print-only",children:[i.jsx("div",{className:"clinic-header-left",children:i.jsx("div",{className:"clinic-info-print",children:i.jsxs("div",{className:"clinic-name-and-details-print",children:[i.jsx("h1",{className:"bill-title",children:"INVOICE"}),i.jsx("h2",{className:"clinic-name-print",children:t.clinicName?`${t.clinicName} Lab`:"Lab Bill"}),(t.clinicAddress||t.clinicNotes)&&i.jsxs("div",{className:"clinic-details-print",children:[t.clinicAddress&&i.jsx("span",{className:"small-text clinic-address",children:t.clinicAddress}),t.clinicNotes&&i.jsx("span",{className:"small-text clinic-notes",children:t.clinicNotes})]})]})})}),i.jsxs("div",{className:"patient-info-grid print-only-patient-details mt-4 text-sm",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem"},children:[i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(ro,{size:16})," Patient Name"]}),t.patientName]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(io,{size:16})," Token"]}),t.patientToken||"N/A"]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Nr,{size:16})," Order Date"]}),new Date(t.orderDate).toLocaleDateString()]})]})]}),i.jsx("div",{className:"medications-card mb-6",style:{border:"none",boxShadow:"none"},children:i.jsxs("table",{className:"medications-table w-full text-left collapse",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b-2 border-gray-300",children:[i.jsx("th",{className:"py-2",children:"S.No."}),i.jsx("th",{className:"py-2",children:"TEST DESCRIPTION"}),i.jsx("th",{className:"py-2 text-right",children:"PRICE"}),i.jsx("th",{className:"py-2 text-right",children:"DIS %"}),i.jsx("th",{className:"py-2 text-right",children:"AMT"})]})}),i.jsx("tbody",{children:t.items.map((a,o)=>{const l=a.price??0,c=l*(a.discount_percentage??0)/100,u=l-c;return i.jsxs("tr",{className:"border-b border-gray-100",children:[i.jsx("td",{className:"py-2",children:o+1}),i.jsx("td",{className:"py-2 font-medium",children:a.name}),i.jsx("td",{className:"py-2 text-right",children:a.price.toFixed(2)}),i.jsxs("td",{className:"py-2 text-right",children:[a.discount_percentage??0,"%"]}),i.jsx("td",{className:"py-2 text-right font-bold",children:u.toFixed(2)})]},o)})})]})}),i.jsx("div",{className:"bill-summary-print flex justify-end",children:i.jsxs("div",{className:"bill-summary-details w-1/3 bg-gray-50 p-4 rounded print:w-1/2 print:bg-transparent print:p-0",children:[i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Subtotal"}),i.jsxs("span",{children:["₹",t.subtotal.toFixed(2)]})]}),i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Total Discount"}),i.jsxs("span",{children:["- ₹",t.totalDiscount.toFixed(2)]})]}),i.jsxs("div",{className:"print-only-total flex justify-between font-bold text-lg border-t pt-2 mt-2",children:[i.jsx("span",{children:"Grand Total:"}),i.jsxs("span",{children:["₹",t.grandTotal.toFixed(2)]})]}),r&&i.jsxs("div",{className:"qr-code-container mt-4 flex flex-col items-center",style:{boxShadow:"none",background:"transparent"},children:[i.jsx(ao,{value:r,size:80}),i.jsx("p",{className:"text-xs mt-1 text-center text-gray-500",children:"Scan to pay"})]})]})}),i.jsxs("footer",{className:"billing-footer mt-8 text-center text-xs text-gray-500 print:absolute print:bottom-0 print:w-full",children:[i.jsx("p",{children:"Thank you for your business!"}),i.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})})})]}),i.jsx("style",{children:`
                @media print {
                    /* Hide EVERYTHING in body */
                    body > * {
                        display: none !important;
                    }
                    
                    /* Explicitly hide #root to override any other styles */
                    #root {
                        display: none !important;
                    }

                    /* Show ONLY our portal root */
                    #print-modal-root {
                        display: block !important;
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        background: white !important;
                        z-index: 99999 !important;
                    }

                     /* Reset visibility for children of the portal */
                    #print-modal-root * {
                        visibility: visible !important;
                    }
                    
                    /* IMPORTANT: Prevent style tags from being displayed by the wildcard above */
                    #print-modal-root style {
                        display: none !important;
                    }
                    
                     /* Specifically restore display for key layout containers that rely on Flex */
                    .flex { display: flex !important; }
                    .grid { display: grid !important; }
                    .table { display: table !important; }
                    tr { display: table-row !important; }
                    td, th { display: table-cell !important; }

                    /* Ensure no scrollbars in print */
                    .overflow-y-auto {
                        overflow: visible !important;
                        height: auto !important;
                    }

                    /* 
                       CRITICAL: Hide elements explicitly marked with no-print class 
                       Must be at the END to override any restoration rules above.
                    */
                    #print-modal-root .no-print, .no-print {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                    }
                }
            `})]});return so.createPortal(s,document.body)},Vg=({isOpen:e,onClose:n,billData:t})=>{if(x.useEffect(()=>{if(e&&t){const a=setTimeout(()=>{window.print()},500);return()=>clearTimeout(a)}},[e,t]),!e||!t)return null;const r=t.clinicUpiId&&t.grandTotal>0?`upi://pay?pa=${t.clinicUpiId}&pn=${encodeURIComponent(t.clinicName)}&am=${t.grandTotal.toFixed(2)}&cu=INR`:"",s=i.jsxs("div",{id:"print-pharmacy-modal-root",className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 print:bg-white print:static print:block",children:[i.jsxs("div",{className:"bg-white w-full max-w-4xl h-[90vh] overflow-y-auto rounded-lg shadow-xl print:shadow-none print:w-full print:max-w-none print:h-auto print:overflow-visible relative",children:[i.jsx("button",{onClick:n,className:"absolute top-4 right-4 z-50 p-2 bg-gray-100 hover:bg-gray-200 rounded-full no-print",children:i.jsx(gn,{size:24})}),i.jsx("div",{className:"pharmacy-billing-page",style:{padding:0,minHeight:"auto",background:"white"},children:i.jsx("div",{className:"billing-container printable-section",style:{border:"none",boxShadow:"none",maxWidth:"100%",margin:0},children:i.jsxs("div",{className:"p-8 print:p-0",children:[i.jsxs("div",{className:"billing-header print-only",children:[i.jsx("div",{className:"clinic-header-left",children:i.jsx("div",{className:"clinic-info-print",children:i.jsxs("div",{className:"clinic-name-and-details-print",children:[i.jsx("h1",{className:"bill-title",children:"INVOICE"}),i.jsx("h2",{className:"clinic-name-print",children:t.clinicName?`${t.clinicName} Pharmacy`:"Pharmacy Bill"}),(t.clinicAddress||t.clinicNotes)&&i.jsxs("div",{className:"clinic-details-print",children:[t.clinicAddress&&i.jsx("span",{className:"small-text clinic-address",children:t.clinicAddress}),t.clinicNotes&&i.jsx("span",{className:"small-text clinic-notes",children:t.clinicNotes})]})]})})}),i.jsxs("div",{className:"patient-info-grid print-only-patient-details mt-4 text-sm",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem"},children:[i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(ro,{size:16})," Patient Name"]}),t.patientName]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(io,{size:16})," Token"]}),t.patientToken||"N/A"]}),i.jsxs("div",{className:"info-item",children:[i.jsxs("strong",{className:"flex items-center gap-2",children:[i.jsx(Nr,{size:16})," Order Date"]}),new Date(t.orderDate).toLocaleDateString()]})]})]}),i.jsx("div",{className:"medications-card mb-6",style:{border:"none",boxShadow:"none"},children:i.jsxs("table",{className:"medications-table w-full text-left collapse",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b-2 border-gray-300",children:[i.jsx("th",{className:"py-2",children:"S.No."}),i.jsx("th",{className:"py-2",children:"DESCRIPTION"}),i.jsx("th",{className:"py-2",children:"BATCH"}),i.jsx("th",{className:"py-2",children:"EXPIRY"}),i.jsx("th",{className:"py-2",children:"QTY"}),i.jsx("th",{className:"py-2 text-right",children:"MRP"}),i.jsx("th",{className:"py-2 text-right",children:"DIS %"}),i.jsx("th",{className:"py-2 text-right",children:"AMT"})]})}),i.jsx("tbody",{children:t.items.map((a,o)=>i.jsxs("tr",{className:"border-b border-gray-100",children:[i.jsx("td",{className:"py-2",children:o+1}),i.jsx("td",{className:"py-2 font-medium",children:a.name}),i.jsx("td",{className:"py-2",children:a.batch||"-"}),i.jsx("td",{className:"py-2",children:a.expiry_date?new Date(a.expiry_date).toLocaleDateString():"-"}),i.jsxs("td",{className:"py-2",children:[a.pack_quantity?`${a.pack_quantity} Pkts `:"",a.loose_quantity?`${a.loose_quantity} Loose`:""]}),i.jsx("td",{className:"py-2 text-right",children:a.mrp.toFixed(2)}),i.jsxs("td",{className:"py-2 text-right",children:[a.discount_percentage??0,"%"]}),i.jsx("td",{className:"py-2 text-right font-bold",children:a.price.toFixed(2)})]},o))})]})}),i.jsx("div",{className:"bill-summary-print flex justify-end",children:i.jsxs("div",{className:"bill-summary-details w-1/3 bg-gray-50 p-4 rounded print:w-1/2 print:bg-transparent print:p-0",children:[i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Subtotal"}),i.jsxs("span",{children:["₹",t.subtotal.toFixed(2)]})]}),i.jsxs("div",{className:"summary-row-print flex justify-between mb-1",children:[i.jsx("span",{children:"Total Discount"}),i.jsxs("span",{children:["- ₹",t.totalDiscount.toFixed(2)]})]}),i.jsxs("div",{className:"print-only-total flex justify-between font-bold text-lg border-t pt-2 mt-2",children:[i.jsx("span",{children:"Grand Total:"}),i.jsxs("span",{children:["₹",t.grandTotal.toFixed(2)]})]}),r&&i.jsxs("div",{className:"qr-code-container mt-4 flex flex-col items-center",style:{boxShadow:"none",background:"transparent"},children:[i.jsx(ao,{value:r,size:80}),i.jsx("p",{className:"text-xs mt-1 text-center text-gray-500",children:"Scan to pay"})]})]})}),i.jsxs("footer",{className:"billing-footer mt-8 text-center text-xs text-gray-500 print:absolute print:bottom-0 print:w-full",children:[i.jsx("p",{children:"Thank you for your business!"}),i.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})})})]}),i.jsx("style",{children:`
                @media print {
                    body > * { display: none !important; }
                    #root { display: none !important; }
                    #print-pharmacy-modal-root {
                        display: block !important;
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        background: white !important;
                        z-index: 99999 !important;
                    }
                    #print-pharmacy-modal-root * { visibility: visible !important; }
                    #print-pharmacy-modal-root style { display: none !important; }
                    
                    .flex { display: flex !important; }
                    .grid { display: grid !important; }
                    .table { display: table !important; }
                    tr { display: table-row !important; }
                    td, th { display: table-cell !important; }

                    .overflow-y-auto { overflow: visible !important; height: auto !important; }
                    #print-pharmacy-modal-root .no-print, .no-print {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                    }
                }
            `})]});return so.createPortal(s,document.body)},Jg=({messages:e})=>{const n=x.useRef(null);return x.useEffect(()=>{n.current&&(n.current.scrollTop=n.current.scrollHeight)},[e]),i.jsxs("div",{className:"conversation-panel",children:[i.jsxs("div",{className:"conversation-header",children:[i.jsx("div",{className:"conversation-title",children:i.jsx("h3",{children:"Conversation"})}),i.jsxs("span",{className:"conversation-count",children:[e.length," messages"]})]}),i.jsxs("div",{ref:n,className:"message-list custom-scrollbar",children:[e.length===0&&i.jsx("div",{className:"empty-state",children:"Start talking to the AI..."}),e.map(t=>i.jsxs("div",{className:`message-wrapper ${t.role}`,children:[i.jsx("div",{className:`message-bubble ${t.role} ${t.role==="system"?t.type||"info":""}`,children:t.role==="ai"||t.role==="system"&&t.type==="loading"?i.jsx("div",{className:"prose prose-sm max-w-none",children:t.role==="system"&&t.type==="loading"?i.jsxs("div",{className:"typing-indicator",children:[i.jsx("span",{className:"dot"}),i.jsx("span",{className:"dot"}),i.jsx("span",{className:"dot"})]}):i.jsx(Gt,{remarkPlugins:[_t],children:t.content})}):i.jsx("div",{className:"whitespace-pre-wrap",children:t.content})}),t.role!=="system"&&i.jsx("span",{className:"message-timestamp",children:t.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]},t.id))]})]})},Qg=e=>oo({queryKey:pt.patients.context(e||""),queryFn:async()=>{if(!e)throw new Error("Patient ID is required");const n=await Y(`/api/patients/${e}/context`);if(!n.ok)throw new Error("Failed to fetch patient context");return n.json()},enabled:!!e,staleTime:5*60*1e3}),Ti=e=>{if(!e)return"";const n=new Date(e);if(isNaN(n.getTime()))return"";const t=n.getTimezoneOffset()*6e4;return new Date(n.getTime()-t).toISOString().slice(0,16)},Gg=(e,n=[])=>{const r=(I=>[1,2,3,14,15,16,17,18,19,30,31,32].includes(I)?"molar":[4,5,12,13,20,21,28,29].includes(I)?"premolar":[6,11,22,27].includes(I)?"canine":"incisor")(e),s=e<=16,a={molar:{crown:"M5,20 Q5,5 18,5 Q31,5 31,20 L29,25 Q18,28 7,25 Z",roots:["M7,25 Q5,40 10,44 Q14,40 14,26","M29,25 Q31,40 26,44 Q22,40 22,26"]},premolar:{crown:"M8,20 Q8,8 18,8 Q28,8 28,20 L26,24 Q18,27 10,24 Z",roots:["M10,24 Q16,44 18,45 Q20,44 26,24"]},canine:{crown:"M8,22 Q18,2 28,22 L26,25 Q18,28 10,25 Z",roots:["M10,25 Q18,48 26,25"]},incisor:{crown:"M10,22 L10,12 Q18,12 26,12 L26,22 L24,25 Q18,27 12,25 Z",roots:["M12,25 Q18,46 24,25"]}},{crown:o,roots:l}=a[r],c=n.includes("condition-rct"),u=n.includes("condition-filling"),m=n.includes("condition-crown"),d=n.includes("condition-bridge"),y=n.includes("condition-extraction"),p=n.includes("condition-implant"),E=c?"#e9d5ff":"#f3f4f6",q=y?"#fee2e2":m?"#fde047":d?"#67e8f9":"#ffffff",G=y?"#ef4444":d?"#0891b2":p?"#475569":m?"#b45309":"#6b7280",O=d||m||p?2:1.5;let B=`<svg viewBox="0 0 36 50" width="24" height="34" style="display:inline-block;${s?"transform:rotate(180deg);":""}">`;return l.forEach(I=>{B+=`<path d="${I}" fill="${E}" stroke="${G}" stroke-width="${O}" stroke-linejoin="round"/>`}),c&&(r==="molar"?(B+='<path d="M12,28 L11,42" fill="none" stroke="#9333ea" stroke-width="2.5" stroke-linecap="round"/>',B+='<path d="M24,28 L25,42" fill="none" stroke="#9333ea" stroke-width="2.5" stroke-linecap="round"/>'):B+='<path d="M18,25 L18,44" fill="none" stroke="#9333ea" stroke-width="2.5" stroke-linecap="round"/>'),B+=`<path d="${o}" fill="${q}" stroke="${G}" stroke-width="${O}" stroke-linejoin="round"/>`,u&&!m&&!d&&(B+='<circle cx="18" cy="16" r="4" fill="#3b82f6" stroke="#1d4ed8" stroke-width="1"/>'),y&&(B+='<line x1="8" y1="8" x2="28" y2="42" stroke="#ef4444" stroke-width="3" stroke-linecap="round"/>',B+='<line x1="28" y1="8" x2="8" y2="42" stroke="#ef4444" stroke-width="3" stroke-linecap="round"/>'),B+="</svg>",B},Kg=()=>{var ss,os;const{openCommandBar:e}=fc(),{recordId:n,patientId:t}=gc(),[r,s]=x.useState(n||void 0),a=yc(),o=xc(),l=bc(),[c,u]=x.useState(""),[m]=x.useState([]),[d,y]=x.useState(null),[p,E]=x.useState(null),[q,G]=x.useState(void 0),[O,B]=x.useState(void 0),[I,W]=x.useState(null),[F,j]=x.useState(!1),[X,le]=x.useState(""),[ne,oe]=x.useState(!1),[V,_]=x.useState(null),[C,K]=x.useState(null),[A,M]=x.useState(!1),[J,Se]=x.useState([]),[he,w]=x.useState(!1),[ze,ke]=x.useState(null),[b,Ie]=x.useState(""),[We,_e]=x.useState(""),[st,Fe]=x.useState(null),[tt,ot]=x.useState(!1),[nt,Kt]=x.useState(!1),[v,Ot]=x.useState(!1),[Ct,Zt]=x.useState(window.innerHeight),[mt,xt]=x.useState([]),[Qe,St]=x.useState(!1),[Ht,Xt]=x.useState(null),[Ve,Tt]=x.useState([]),[Le,T]=x.useState([]),[P,S]=x.useState([]),[ee,ce]=x.useState(!1),[Re,He]=x.useState(null),je=x.useRef(null),Je=x.useRef(null),Ge=x.useRef(!1),qe=x.useRef(null),te=x.useRef(null),D=x.useRef(null),z=x.useRef(null),L=x.useRef(null),$=x.useRef(null),ie=x.useRef(null),[re,R]=x.useState([]),[me,Ce]=x.useState(!1);x.useEffect(()=>{(async()=>{if(re.length>0&&!me){Ce(!0);const g=re[0];g.current&&(g.current.scrollIntoView({behavior:"smooth",block:"center"}),g.current.classList.add("ai-glow"),await new Promise(f=>setTimeout(f,2e3)),g.current&&g.current.classList.remove("ai-glow")),R(f=>f.slice(1)),Ce(!1)}})()},[re,me]);const ye=h=>{let g=null;switch(h){case"update_patient_details":g=D;break;case"create_pharmacy_order":case"edit_pharmacy_order":g=z;break;case"create_lab_order":case"edit_lab_order":g=L;break;case"add_complaint_history":g=$;break;case"update_case_summary":g=ie;break}g&&R(f=>[...f,g])},[ae,fe]=x.useState(55),[de,H]=x.useState(!1),Z=x.useRef(null),xe=x.useRef(null),Be=x.useRef(null),se=x.useRef(null),ve=150,[Ee,Ye]=x.useState([]),[lt,bt]=x.useState([]),[ct,rt]=x.useState(!0),[en,tn]=x.useState(null),[Wn,Vn]=x.useState(!1),[dl,pl]=x.useState(!1),[hl,ml]=x.useState(!1),[fl,gl]=x.useState(!1),[yl,xl]=x.useState(!1),[Sr,Pt]=x.useState([]),[bn,ia]=x.useState(!1),[aa,sa]=x.useState(null),[Jn,Tr]=x.useState(!1),[oa,la]=x.useState(null),[wn,bl]=x.useState({}),[wl,ca]=x.useState(!1),[ua,da]=x.useState(!1),[pa,ha]=x.useState(!1),[ma,Qn]=x.useState(!1),[fa,Pr]=x.useState(!1),[ga,kn]=x.useState([]),[Er,Gn]=x.useState(void 0),[kl,ya]=x.useState(!1),[_l,Nl]=x.useState(null),[vl,xa]=x.useState(!1),[jl,Cl]=x.useState(null),[ft,ba]=x.useState(!1),[Ar,wa]=x.useState(!1),[Dr,ka]=x.useState(!1),[Ir,_a]=x.useState(!1),[$r,Na]=x.useState(!1),[Yn,_n]=x.useState(!1),Kn=x.useMemo(()=>(p==null?void 0:p.admission_date)&&!(p!=null&&p.discharge_date),[p]),[Sl,Zn]=x.useState(!1),[va,Or]=x.useState(null),[Lr,Rr]=x.useState(""),[Fr,zr]=x.useState(void 0),[qr,Br]=x.useState(void 0),[Ur,Mr]=x.useState(void 0),[Et,Hr]=x.useState(!1),[ja,Wt]=x.useState(null),[Ca,Wr]=x.useState(null),[Sa,Vr]=x.useState(null),[Ta,Nn]=x.useState(null),[At,nn]=x.useState(""),[vn,Xn]=x.useState(!1),[jn,Tl]=x.useState(!1),er=x.useRef(null),[Pa,Jr]=x.useState(null),[Ea,rn]=x.useState([]),Qr=x.useCallback(h=>{rn(g=>[...g,{id:Math.random().toString(36).substr(2,9),timestamp:new Date,role:"system",content:"",...h}])},[]),[Gr,Aa]=x.useState(null),[Da,Ia]=x.useState(!1),tr=x.useRef(null),nr=x.useRef(null),[Pl,Yr]=x.useState(!1),[rr,$a]=x.useState(!1),[ir,Oa]=x.useState(null),[El,ar]=x.useState(!1),[Al,La]=x.useState(!1),[Ae,Kr]=x.useState(null),[sr,Zr]=x.useState(""),[Cn,Sn]=x.useState(""),[Ra,Fa]=x.useState(!0),[an,za]=x.useState(!1),[Xr,or]=x.useState(!1),[sn,qa]=x.useState(!1),[Dl,Ba]=x.useState(!1),Tn=x.useRef(null),Il=async()=>{Tn.current&&(await Tn.current.undoLastAction(),Ba(!1))},$l=h=>{Cl(h),xa(!0)},on=async h=>{try{const g=await Y(`/api/patients/${h}`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`Failed to fetch patient details: ${g.status}`)}const f=await g.json();if(E(f),G(f.age),B(f.gender),Ie(f.ai_response||""),E(k=>k?{...k,current_status:f.current_status,admission_date:f.admission_date,discharge_date:f.discharge_date}:{...f,current_status:f.current_status,admission_date:f.admission_date,discharge_date:f.discharge_date}),f.insurance_type&&E(k=>k?{...k,insurance_type:f.insurance_type}:{...f}),ni(h),f.ai_response){const k=/```json\s*([\s\S]*?)\s*```/,N=f.ai_response.match(k);if(N&&N[1])_e(f.ai_response.replace(k,"").trim()),Fe(N[1].trim());else{const Q=f.ai_response.trim();if(Q.startsWith("{")&&Q.endsWith("}"))try{JSON.parse(Q),_e(""),Fe(Q)}catch{_e(Q),Fe(null)}else if(Q.startsWith("[")&&Q.endsWith("]"))try{JSON.parse(Q),_e(""),Fe(Q)}catch{_e(Q),Fe(null)}else _e(Q),Fe(null)}}else _e(""),Fe(null)}catch{E(null),Ie(""),_e(""),Fe(null)}},Ol=async(h,g)=>{E(f=>f?{...f,insurance_type:g}:null);try{const f=await Y(`/api/patients/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({insurance_type:g})});if(!f.ok){const k=await f.json();throw new Error(k.message||"Failed to update insurance type")}}catch(f){console.error("Error updating insurance type:",f),h&&on(h)}},Ua=async h=>{ce(!0),He(null),S([]);try{const g=await Y(`/api/queue/patient/${h}/complaints`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`HTTP error! status: ${g.status}`)}const f=await g.json();S(f||[])}catch(g){He(`Past complaints error: ${g.message}`)}finally{ce(!1)}},ln=async h=>{Tt([]);try{const g=await Y(`/api/pharmacy-orders/patient/${h}`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`HTTP error! status: ${g.status}`)}const f=await g.json();Tt(f||[])}catch{}},cn=async h=>{ia(!0),sa(null),Pt([]);try{const g=await Y(`/api/lab/orders/patient/${h}`);if(!g.ok){const k=await g.json().catch(()=>({}));throw new Error(k.message||`HTTP error! status: ${g.status}`)}const f=await g.json();Pt(f||[])}catch(g){sa(`Pending labs error: ${g.message}`)}finally{ia(!1)}},Pn=async h=>{St(!0),Xt(null),xt([]);try{const g=await Y(`/api/lab/patient/${h}`);if(!g.ok){const N=await g.json().catch(()=>({}));throw new Error(N.message||`HTTP error! status: ${g.status}`)}const k=(await g.json()||[]).map(N=>({...N.report,id:N.id,patient_id:N.patient_id,createdAt:N.createdAt,tests:N.tests,status:N.status}));xt(k)}catch(g){Xt(`Lab reports error: ${g.message}`)}finally{St(!1)}},{data:Dt,isLoading:Lt}=Qg(d),En=x.useCallback(async h=>{h===d?await o.invalidateQueries({queryKey:pt.patients.context(h)}):y(h)},[d,o]);x.useEffect(()=>{if(Dt){console.log("EditComplaintPage: Syncing data from useQuery cache");const h=Dt.patient;if(h){if(E(h),G(h.age),B(h.gender),Ie(h.ai_response||""),h.ai_response){const g=/```json\s*([\s\S]*?)\s*```/,f=h.ai_response.match(g);if(f&&f[1])_e(h.ai_response.replace(g,"").trim()),Fe(f[1].trim());else{const k=h.ai_response.trim();k.startsWith("{")||k.startsWith("[")?(_e(""),Fe(k)):(_e(k),Fe(null))}}_n(h.current_status==="In Doctor Queue"||h.current_status==="In Consultation")}if(S(Dt.history||[]),Tt(Dt.pharmacyOrders||[]),Dt.labOrders){Pt(Dt.labOrders.filter(f=>!f.report));const g=Dt.labOrders.filter(f=>f.report).map(f=>({...f.report,id:f.id,patient_id:f.patient_id,createdAt:f.createdAt,tests:f.tests}));xt(g)}T(Dt.recurringMedications||[])}},[Dt]),x.useEffect(()=>{(async()=>{if(d)try{const g=await o.fetchQuery({queryKey:pt.patientDebts.balance(d),queryFn:async()=>{const f=await Y(`/api/patient-debts/${d}/balance`);return f.ok?f.json():{netDebt:0}},staleTime:6e4});Oa(g.netDebt||0)}catch(g){console.error("Error fetching patient debt:",g),Oa(0)}})()},[d,o]);const ei=x.useCallback(()=>{if(!p)return;const h={id:p.id,token:p.patient_token_number??null,name:p.name,age:p.age??null,gender:p.gender==="M"||p.gender==="F"||p.gender==="O"?p.gender:null,phone:p.phone};a("/dashboard/dental",{state:{patient:h}})},[p,a]),Ll=x.useCallback(()=>{if(!p)return;const h={id:p.id,token:p.patient_token_number??null,name:p.name,age:p.age??null,gender:p.gender==="M"||p.gender==="F"||p.gender==="O"?p.gender:null,phone:p.phone};a("/dashboard/medical",{state:{patient:h}})},[p,a]),{data:ti}=oo({queryKey:pt.dental.records(d),queryFn:async()=>{const h=await Y(`/api/dental/patient/${d}`);if(!h.ok)throw new Error("Failed to fetch dental records");return h.json()},enabled:!!d,staleTime:5*60*1e3});x.useEffect(()=>{Se(ti||[])},[ti]);const{conditions:lr,details:cr}=x.useMemo(()=>{const h={},g={},f=(N,Q)=>{h[N]||(h[N]=[]);const pe=`condition-${Q}`;h[N].includes(pe)||h[N].push(pe)},k=(N,Q)=>{g[N]||(g[N]=[]),g[N].push(Q)};return J.forEach(N=>{N.teeth&&Array.isArray(N.teeth)&&N.teeth.forEach(Q=>{Q.procedures.forEach(pe=>{var be;let ue=(be=N.selected_procedures)==null?void 0:be.find(kt=>kt.id===pe);ue&&ue.type!=="general"&&(f(Q.toothNumber,ue.type),k(Q.toothNumber,{name:ue.name,date:new Date(N.date||N.createdAt||0).toLocaleDateString(),recordId:N.id,isPast:!0}))})})}),{conditions:h,details:g}},[J]),ni=async h=>{try{const g=await o.fetchQuery({queryKey:pt.queue.latest(h),queryFn:async()=>{const f=await Y(`/api/queue/patient/${h}/latest`);if(!f.ok)throw new Error("Failed");return f.json()},staleTime:5e3});if(g){const f=new Date(g.createdAt),k=new Date,N=f.getDate()===k.getDate()&&f.getMonth()===k.getMonth()&&f.getFullYear()===k.getFullYear(),Q=["waiting","consulting"].includes(g.status);_n(N&&Q)}else _n(!1)}catch(g){console.error("Error checking patient queue status:",g),_n(!1)}},ri=x.useCallback(async(h,g)=>{try{if(!(await Y(`/api/pharmacy-orders/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:g})})).ok)throw new Error("Failed to update pharmacy order date");d&&ln(d)}catch(f){console.error("Error updating pharmacy order date:",f),ke("Failed to update pharmacy order date")}},[d]),An=x.useCallback(async(h,g,f)=>{try{const k={};if(g==="order"?k.date=f:g==="report"&&(k.reportDate=f),!(await Y(`/api/lab/orders/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)})).ok)throw new Error("Failed to update lab date");d&&(cn(d),Pn(d))}catch(k){console.error("Error updating lab order date:",k),ke("Failed to update lab order date")}},[d]),ii=x.useCallback(h=>{a(`/dashboard/edit-pharmacy-order/${h}`)},[a]),Ma=x.useCallback(h=>{const g=h.medications.map((f,k)=>({id:Date.now()+k,medication_name:f.name,drug_id:f.drug_id?String(f.drug_id):null,quantity:(f.pack_quantity||0)*(f.pack_size||1)+(f.loose_quantity||0),tablets_per_day:f.tabletsPerDay||1,number_of_days:f.numberOfDays||30,directions:f.directions_to_use||"",notes:"",packs:f.pack_quantity,loose:f.loose_quantity,pack_size:f.pack_size}));kn(g),Qn(!0)},[]),Ha=x.useCallback(h=>{ke(null),console.log(`Preparing billing navigation for order: ${h}`);const g=Ve.find(f=>f.id===h);if(g){const f=g.medications.map(k=>{const N=k.price??0;return(k.price===void 0||k.price===null)&&console.warn(`Medication "${k.name}" in order ${h} is missing a price. Defaulting to 0.`),{name:k.name,pack_quantity:k.pack_quantity,loose_quantity:k.loose_quantity,price:N,pack_price:k.pack_price,loose_price:k.loose_price,total_price:Number(k.total_price)||0,isLoose:k.isLoose,unit:k.unit,drug_id:k.drug_id?String(k.drug_id):null,tabletsPerDay:k.tabletsPerDay,numberOfDays:k.numberOfDays,directions_to_use:k.directions_to_use,discount_percentage:k.discount_percentage??0,batch:k.batch,expiry_date:k.expiry_date}});console.log("Navigating to /dashboard/pharmacy-billing with state:",{initialItems:f}),a(`/dashboard/pharmacy-billing/${h}`,{state:{initialItems:f}})}else console.error(`Order with ID ${h} not found.`),ke(`Order with ID ${h} not found.`),alert(`Error: Could not find order ${h} to bill.`)},[Ve,a]),Wa=x.useCallback(async(h,g)=>{ke(null);const f=Ve.find(N=>N.id===h);if(!f){ke(`Order with ID ${h} not found.`);return}const k={status:g,medications:f.medications};try{const N=await Y(`/api/pharmacy-orders/${h}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)});if(!N.ok){const pe=await N.text();throw new Error(`Failed to update status: ${N.statusText} (${N.status}) - ${pe}`)}const Q=await N.json();Tt(pe=>pe.map(ue=>ue.id===Q.id?{...ue,status:Q.status}:ue)),d&&ln(d)}catch(N){console.error("Failed to update order status:",N),ke(N.message||`Failed to update status for order ${h}.`),alert(`Error updating status for order ${h}: ${N.message||"Please try again."}`)}},[Ve,d]),ai=x.useCallback(h=>{Pt(g=>g.map(f=>f.id===h?{...f,isEditing:!0,editedTests:[...f.tests],editedStatus:f.status}:{...f,isEditing:!1}))},[]),Rl=x.useCallback(h=>{Pt(g=>g.map(f=>f.id===h?{...f,isEditing:!1,editedTests:void 0,editedStatus:void 0}:f))},[]),Fl=x.useCallback((h,g,f,k)=>{Pt(N=>N.map(Q=>{if(Q.id===h){const pe=Q.editedTests?[...Q.editedTests]:[...Q.tests];if(f==="add")return{...Q,editedTests:[...pe,{id:"",name:"",price:0}]};if(f==="remove")return{...Q,editedTests:k};if(g!==-1){const ue={...pe[g],[f]:k};return pe[g]=ue,{...Q,editedTests:pe}}}return Q}))},[]),zl=x.useCallback((h,g)=>{Pt(f=>f.map(k=>k.id===h?{...k,editedStatus:g}:k))},[]),Va=x.useCallback(async h=>{if(!h){console.error("Cannot navigate to billing: Lab Order data is missing."),alert("Could not open billing page: Lab Order information is missing.");return}a(`/dashboard/lab-billing/${h.id}`)},[a]),Ja=x.useCallback(async(h,g)=>{console.log(`Updating lab order ${h} to status ${g}`);try{const f=await Y(`/api/lab/${h}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:g})});if(!f.ok){const k=await f.json();throw new Error(k.message||`Failed to update lab order status: ${f.status}`)}d&&(cn(d),Pn(d)),console.log(`Lab Order ${h} status updated to ${g}, refetching data.`)}catch(f){console.error("Error updating lab order status:",f),alert(`Failed to update lab order status: ${f instanceof Error?f.message:"Unknown error"}`)}},[d]),ur=x.useCallback(h=>{h&&h.id?a(`/lab/report/${h.id}`):(console.error("Cannot navigate: Lab Order or Lab Order ID is missing."),alert("Could not open the report entry page: Lab Order information is missing."))},[a]),ql=x.useCallback(async(h,g,f)=>{ba(!0),ke(null);try{if(!g||g.length===0)throw new Error("Lab order must have at least one test.");for(const Q of g)if(!Q.id||!Q.name||isNaN(Q.price)||Q.price<0)throw new Error(`Invalid test data: ${JSON.stringify(Q)}. Each test must have id, name, and a valid price.`);const k={tests:g,status:f},N=await Y(`/api/lab/orders/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)});if(!N.ok){const Q=await N.json().catch(()=>({}));throw new Error(Q.message||`Failed to update lab order: ${N.statusText}`)}d&&cn(d),Pt(Q=>Q.map(pe=>pe.id===h?{...pe,isEditing:!1,editedTests:void 0,editedStatus:void 0}:pe))}catch(k){ke(`Lab Order Save Error: ${k.message}`)}finally{ba(!1)}},[d]),Rt=x.useCallback(async h=>{if(!window.confirm(`Are you sure you want to delete this ${h.type.toLowerCase()} record? This action cannot be undone.`))return;Tr(!0),la(null);let f=null,k;const N=h.type;try{switch(N){case"Complaint":if(k=h.data.id,!k)throw new Error("Complaint ID is missing.");f=`/api/patients/complaints/${k}`;break;case"Lab Order":if(k=h.data.id,!k)throw new Error("Lab Order ID is missing.");f=`/api/lab/orders/${k}`;break;case"Lab Report":if(k=h.data.reportId,!k)throw new Error("Lab Report ID is missing.");f=`/api/lab/reports/${k}`;break;case"Pharmacy Order":if(k=h.data.id,!k)throw new Error("Pharmacy Order ID is missing.");f=`/api/pharmacy-orders/${k}`;break;default:throw new Error(`Deletion not supported for item type: ${N}`)}if(!f)throw new Error(`Could not determine delete URL for type: ${N}`);const Q=await Y(f,{method:"DELETE"});if(!Q.ok){const pe=await Q.json().catch(()=>({}));throw new Error(pe.message||`Failed to delete ${N}: ${Q.statusText}`)}d&&(N==="Complaint"?Ua(d):N==="Lab Order"?(cn(d),Pn(d)):N==="Lab Report"?Pn(d):N==="Pharmacy Order"&&ln(d))}catch(Q){la(`Delete Error (${N}): ${Q.message}`),Jn&&Tr(!1)}finally{Tr(!1)}},[d,Jn]),Qa=x.useCallback(async()=>{if(!d)return;if(Ve.filter(g=>g.status==="pending").length<2){alert("You need at least two pending orders to merge.");return}$a(!0);try{const g=await Y(`/api/pharmacy-orders/patient/${d}/merge-pending`,{method:"POST"});if(!g.ok){const f=await g.json().catch(()=>({}));throw new Error(f.message||"Failed to merge orders")}ln(d)}catch(g){ke(`Merge Error: ${g.message}`)}finally{$a(!1)}},[d,Ve]),Ft=x.useMemo(()=>{if(!d||!P)return[];const h=P.map(g=>({date:new Date(g.createdAt),type:"Complaint",data:g,originalDateString:g.createdAt})).filter(g=>!isNaN(g.date.getTime()));return h.sort((g,f)=>f.date.getTime()-g.date.getTime()),h},[d,P]),zt=x.useMemo(()=>{if(!d)return[];const h=new Map;(Sr??[]).forEach(f=>{h.set(f.id,{...f})}),(mt??[]).forEach(f=>{if(!h.has(f.id))h.set(f.id,{id:f.id,patient_id:f.patient_id,tests:f.tests,status:f.status,createdAt:f.createdAt,report:f});else{const k=h.get(f.id);k&&(k.report=f,k.status=f.status)}});let g=Array.from(h.values());return g.sort((f,k)=>new Date(f.createdAt).getTime()-new Date(k.createdAt).getTime()),g=g.map((f,k)=>({...f,serialNumber:k+1})),g.map(f=>({date:new Date(f.createdAt),type:"Lab Order",data:f,originalDateString:f.createdAt}))},[d,Sr,mt]),Vt=x.useCallback(async h=>{const g=h??c;if(!g.trim())return;nr.current&&(clearTimeout(nr.current),nr.current=null),Qr({role:"user",content:g});const f=Math.random().toString(36).substr(2,9);rn(k=>[...k,{id:f,role:"system",type:"loading",content:"",timestamp:new Date}]),Tn.current?(await Tn.current.callGenerativeApi(g),rn(k=>k.filter(N=>N.id!==f)),nr.current=setTimeout(()=>{rn([])},1e4)):rn(k=>k.filter(N=>N.id!==f))},[c,Qr,rn]),Ga=x.useCallback(()=>{const h="reports came,please anaylse";u(h),setTimeout(()=>{Vt(h)},0)},[Vt,u]),si=x.useCallback(h=>{bl(g=>({...g,[h]:!g[h]}))},[]),wt=x.useMemo(()=>{if(!d||!Ve)return[];const h=Ve.map(g=>({date:new Date(g.date),type:"Pharmacy Order",data:g,originalDateString:g.date})).filter(g=>!isNaN(g.date.getTime()));return h.sort((g,f)=>f.date.getTime()-g.date.getTime()),h},[d,Ve]),Bl=x.useCallback((h,g)=>i.jsxs("div",{className:"flex flex-col w-full",children:[i.jsxs("span",{className:"ai-context-text flex items-center",children:[wt.length-g,". Order Status: (",h.data.status,")",i.jsx("span",{className:"text-gray-400 ml-1 flex items-center",children:va===h.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",children:i.jsx("input",{type:"datetime-local",defaultValue:Ti(h.originalDateString),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:f=>{f.target.value&&ri(h.data.id,f.target.value),Or(null)},onKeyDown:f=>{if(f.key==="Enter"){const k=f.target;k.value&&ri(h.data.id,k.value),Or(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/date ml-1",onClick:()=>Or(h.data.id),title:"Click to edit date",children:["(",new Date(h.originalDateString).toLocaleDateString(),")",i.jsx(gt,{size:14,className:"ml-1 text-gray-500 hover:text-gray-700"})]})}),i.jsxs("div",{className:"inline-flex space-x-2 ml-2",children:[i.jsx("button",{onClick:()=>ii(h.data.id),className:"icon-button small",title:"Edit Pharmacy Order",children:i.jsx(gt,{size:12})}),h.data.prescriptionForUnavailableDrugs&&i.jsx("button",{onClick:()=>{const f=wi().use(_t).use(Si).processSync(h.data.prescriptionForUnavailableDrugs).toString();oi(f,"Unavailable Drugs Prescription")},className:"icon-button small",title:"Print Unavailable Drugs Prescription",children:i.jsx(Rn,{size:12})}),h.data.status==="dispensed"||h.data.status==="billed"?i.jsx("button",{onClick:()=>a(`/dashboard/pharmacy-billing/${h.data.id}`),className:"icon-button small text-blue-600",title:"View Pharmacy Bill",children:i.jsx(ci,{size:12})}):i.jsx("button",{onClick:()=>Rt({type:"Pharmacy Order",data:h.data}),className:"icon-button small text-red-500",title:"Delete Pharmacy Order",children:i.jsx(yt,{size:12})}),h.data.status==="pending"&&i.jsx("button",{onClick:()=>Ha(h.data.id),className:"icon-button small",title:"Bill this pharmacy order",disabled:ft,children:i.jsx(ls,{size:12})}),h.data.status==="billed"&&i.jsx("button",{onClick:()=>Wa(h.data.id,"dispensed"),className:"icon-button small",title:"Dispense this pharmacy order",disabled:ft,children:i.jsx(cs,{size:12})}),i.jsx("button",{onClick:()=>Ma(h.data),className:"icon-button small group-hover:block",title:"Add to Recurring Medications",children:i.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-repeat",children:[i.jsx("path",{d:"m17 2 4 4-4 4"}),i.jsx("path",{d:"M3 11v-1a4 4 0 0 1 4-4h14"}),i.jsx("path",{d:"m7 22-4-4 4-4"}),i.jsx("path",{d:"M21 13v1a4 4 0 0 1-4 4H3"})]})})]})]}),i.jsx("div",{className:"pharmacy-order-drugs-table-container mobile-edge-to-edge-table-container mt-2 cursor-pointer hover:bg-gray-50 transition-colors rounded p-1",onClick:()=>ii(h.data.id),title:"Click to edit order",children:i.jsxs("table",{className:"pharmacy-order-drugs-table mobile-edge-to-edge-table w-full text-xs",children:[i.jsx("thead",{children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-1 px-2 text-left",children:"Drug Name"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Quantity"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Dosage"}),i.jsx("th",{className:"py-1 px-2 text-left",children:"Directions"})]})}),i.jsx("tbody",{children:h.data.medications.map((f,k)=>i.jsxs("tr",{children:[i.jsx("td",{className:"py-1 px-2",children:i.jsx("strong",{children:f.name})}),i.jsxs("td",{className:"py-1 px-2",children:[f.pack_quantity!==void 0&&f.pack_quantity>0&&`Packs: ${f.pack_quantity}`,f.pack_quantity!==void 0&&f.pack_quantity>0&&f.loose_quantity!==void 0&&f.loose_quantity>0&&", ",f.loose_quantity!==void 0&&f.loose_quantity>0&&`Loose: ${f.loose_quantity}`]}),i.jsx("td",{className:"py-1 px-2",children:f.tabletsPerDay&&f.numberOfDays?`${f.tabletsPerDay} tab/day for ${f.numberOfDays} days`:"N/A"}),i.jsx("td",{className:"py-1 px-2",children:f.directions_to_use||"N/A"})]},f.drug_id||f.name||k))})]})}),h.data.prescriptionForUnavailableDrugs&&i.jsxs("div",{className:"unavailable-drugs-markdown mt-2",children:[i.jsx("span",{className:"font-semibold text-xs text-gray-600 block mb-1",children:"Prescription for Unavailable Drugs:"}),i.jsx(Gt,{remarkPlugins:[_t],children:h.data.prescriptionForUnavailableDrugs})]})]}),[wt,va,ri,ii,Ha,Wa,Ma,Rt,ft,a]),Ul=x.useCallback((h,g)=>{const f=yh(h.data.report?h.data.report.status:h.data.status),k=(h.data.tests||[]).reduce((N,Q)=>N+(Number(Q.price)||0),0).toFixed(2);return i.jsxs("div",{className:"flex flex-col w-full",children:[i.jsxs("div",{className:"flex justify-between items-start mb-2",children:[i.jsxs("div",{className:"ai-context-text flex items-center flex-wrap",children:[i.jsxs("span",{className:"font-medium cursor-pointer hover:text-blue-600 transition-colors mr-2",onClick:()=>ur(h.data),title:"Click to enter report",children:["#",h.data.serialNumber," [Order]"]}),i.jsx("span",{className:`mr-2 ${f.className}`,children:f.text}),i.jsx("span",{className:"text-gray-400 inline-flex items-center",children:Ca===h.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",onClick:N=>N.stopPropagation(),children:i.jsx("input",{type:"datetime-local",defaultValue:Ti(h.originalDateString),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:N=>{N.target.value&&An(h.data.id,"order",N.target.value),Wr(null)},onKeyDown:N=>{if(N.key==="Enter"){const Q=N.target;Q.value&&An(h.data.id,"order",Q.value),Wr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/date ml-1",onClick:N=>{N.stopPropagation(),Wr(h.data.id)},title:"Click to edit order date",children:["(",new Date(h.originalDateString).toLocaleDateString(),")",i.jsx(gt,{size:14,className:"ml-1 text-gray-500 hover:text-gray-700"})]})})]}),!h.data.isEditing&&i.jsxs("div",{className:"flex space-x-1 items-center",children:[i.jsx("button",{onClick:()=>ai(h.data.id),className:"icon-button small",title:"Edit",disabled:ft,children:i.jsx(gt,{size:12})}),h.data.status==="pending"?i.jsx("button",{onClick:()=>Va(h.data),className:"icon-button small font-medium text-green-600 w-auto px-1",title:`Pay total of ₹${k}`,disabled:ft,children:i.jsx(lo,{size:12})}):i.jsx("button",{onClick:()=>a(`/dashboard/lab-billing/${h.data.id}`),className:"icon-button small text-blue-600",title:"View Lab Bill",children:i.jsx(wc,{size:12})}),["pending","billed","collected","processing","report_ready","reported","completed"].includes(h.data.status)&&i.jsx("button",{onClick:()=>ur(h.data),className:"icon-button small text-indigo-600",title:"Enter Report",disabled:ft,children:i.jsx(ci,{size:12})}),(h.data.status==="report_ready"||h.data.status==="reported")&&i.jsx("button",{onClick:()=>Ja(h.data.id,"completed"),className:"icon-button small text-green-600",title:"Mark Completed",disabled:ft,children:i.jsx(cs,{size:12})}),i.jsx("button",{onClick:()=>Rt({type:"Lab Order",data:h.data}),className:"icon-button small text-red-500",title:"Delete",disabled:ft,children:i.jsx(yt,{size:12})})]})]}),i.jsx("div",{className:"lab-order-tests-table-container mobile-edge-to-edge-table-container mt-1 mb-2 cursor-pointer hover:bg-gray-50 transition-colors rounded p-1 border border-gray-100",onClick:()=>{h.data.status==="pending"?ai(h.data.id):ur(h.data)},title:h.data.status==="pending"?"Click to edit order":"Click to enter report",children:i.jsxs("table",{className:"lab-order-tests-table mobile-edge-to-edge-table w-full text-xs text-left",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b bg-gray-50",children:[i.jsx("th",{className:"py-1 px-2 font-medium text-gray-600",children:"Test Name"}),i.jsx("th",{className:"py-1 px-2 text-right font-medium text-gray-600",children:"Price"})]})}),i.jsxs("tbody",{children:[h.data.tests&&h.data.tests.length>0?h.data.tests.map(N=>i.jsxs("tr",{className:"border-b last:border-0 hover:bg-gray-100",children:[i.jsx("td",{className:"py-1 px-2",children:N.name}),i.jsxs("td",{className:"py-1 px-2 text-right",children:["₹",N.price]})]},N.id||N.name)):i.jsx("tr",{children:i.jsx("td",{colSpan:2,className:"py-1 px-2 italic text-gray-500",children:"No tests specified"})}),i.jsxs("tr",{className:"bg-gray-50 font-semibold",children:[i.jsx("td",{className:"py-1 px-2 text-right text-gray-700",children:"Total:"}),i.jsxs("td",{className:"py-1 px-2 text-right text-gray-900",children:["₹",k]})]})]})]})}),h.data.report&&i.jsxs("div",{className:"ml-4 mt-1 p-2 border-l-2 border-gray-200",children:[i.jsxs("div",{className:"flex justify-between items-center mb-2",children:[i.jsx("span",{className:"font-medium text-sm text-gray-700",children:"[Report]"}),i.jsxs("div",{className:"flex items-center",children:[i.jsx("span",{className:"text-gray-400 ml-1 flex items-center text-xs",children:Sa===h.data.id?i.jsx("div",{className:"flex items-center space-x-1 ml-1",onClick:N=>N.stopPropagation(),children:i.jsx("input",{type:"datetime-local",defaultValue:Ti(h.data.report.report_date),className:"border rounded px-1 py-0.5 text-xs text-black",onBlur:N=>{N.target.value&&An(h.data.id,"report",N.target.value),Vr(null)},onKeyDown:N=>{if(N.key==="Enter"){const Q=N.target;Q.value&&An(h.data.id,"report",Q.value),Vr(null)}},autoFocus:!0})}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 px-1 rounded flex items-center group/reportDate ml-1",onClick:N=>{N.stopPropagation(),Vr(h.data.id)},title:"Click to edit report date",children:["(",new Date(h.data.report.report_date).toLocaleDateString(),")",i.jsx(gt,{size:12,className:"ml-1 text-gray-500 hover:text-gray-700"})]})}),i.jsx("button",{onClick:()=>si(h.data.report.reportId),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-1 focus:ring-blue-400 ml-2",title:wn[h.data.report.reportId]?"Collapse Report":"Expand Report",children:wn[h.data.report.reportId]?i.jsx(us,{size:14}):i.jsx(ds,{size:14})}),i.jsx("button",{onClick:()=>Rt({type:"Lab Report",data:h.data}),className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-1 focus:ring-red-400 ml-1",title:"Delete Report",children:i.jsx(yt,{size:12})})]})]}),wn[h.data.report.reportId]&&(()=>{try{const N=JSON.parse(h.data.report.report_content||"{}");return typeof N=="object"&&N!==null&&h.data.report.tests?h.data.report.tests.map(Q=>i.jsxs("div",{style:{marginBottom:"10px"},children:[i.jsx("h5",{className:"font-semibold text-xs mt-2 mb-1 text-gray-700",children:Q.name}),N[Q.id]?i.jsx("div",{className:"mobile-edge-to-edge-table-container",children:i.jsxs("table",{className:"lab-inventory-table mobile-edge-to-edge-table w-full text-xs",children:[i.jsx("thead",{children:i.jsxs("tr",{children:[i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Parameter"}),i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Value"}),i.jsx("th",{className:"py-1 px-2 bg-gray-50",children:"Normal Range"})]})}),i.jsx("tbody",{children:Object.entries(N[Q.id]).map(([pe,ue])=>{var kt;const be=(kt=Q.default_parameters)==null?void 0:kt.find(dt=>dt.name===pe);return i.jsxs("tr",{className:"border-b last:border-0",children:[i.jsx("td",{className:"py-1 px-2",children:pe}),i.jsxs("td",{className:"py-1 px-2",children:[String(ue)," ",(be==null?void 0:be.unit)||""]}),i.jsx("td",{className:"py-1 px-2 text-gray-500",children:(()=>{if(be&&be.type==="number"&&(be.lower_limit!=null||be.upper_limit!=null)){let dt="";return be.lower_limit!=null&&(dt+=` > ${be.lower_limit}`),be.lower_limit!=null&&be.upper_limit!=null&&(dt+=" - "),be.upper_limit!=null&&(dt+=` < ${be.upper_limit}`),dt.trim()||"N/A"}else if((be==null?void 0:be.type)==="boolean")return"N/A";return(be==null?void 0:be.normal_range)||"N/A"})()})]},pe)})})]})}):i.jsx("p",{className:"italic text-gray-500 text-xs",children:"No parameters reported for this test."})]},Q.id)):i.jsx("div",{className:"text-xs prose",children:i.jsx(Gt,{remarkPlugins:[_t],children:h.data.report.report_content})})}catch{return i.jsx("div",{className:"text-xs prose",children:i.jsx(Gt,{remarkPlugins:[_t],children:h.data.report.report_content||"*No findings recorded.*"})})}})()]})]})},[Ca,ur,An,ai,ft,Va,a,Rt,Sa,wn,si,Ja]),Ml=x.useCallback((h,g)=>i.jsx("div",{className:"ai-context-text w-full",children:Ta===h.data.id?i.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[i.jsx("input",{type:"text",value:At,onChange:f=>nn(f.target.value),className:"border rounded px-2 py-1 text-sm w-full",autoFocus:!0,onKeyDown:async f=>{if(f.key==="Enter"&&At.trim()){Xn(!0);try{await Y(`/api/patients/complaints/${h.data.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:At.trim()})}),h.data.complaint=At.trim(),Nn(null),nn("")}catch(k){console.error("Error updating complaint:",k)}Xn(!1)}f.key==="Escape"&&(Nn(null),nn(""))},disabled:vn}),i.jsxs("div",{className:"flex gap-1",children:[i.jsx("button",{onClick:async()=>{if(At.trim()){Xn(!0);try{await Y(`/api/patients/complaints/${h.data.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({complaint:At.trim()})}),h.data.complaint=At.trim(),Nn(null),nn("")}catch(f){console.error("Error updating complaint:",f)}Xn(!1)}},className:"text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600",disabled:vn||!At.trim(),children:vn?"Saving...":"Save"}),i.jsx("button",{onClick:()=>{Nn(null),nn("")},className:"text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300",disabled:vn,children:"Cancel"})]})]}):i.jsxs("span",{className:"cursor-pointer hover:bg-gray-100 rounded px-1 -mx-1 transition-colors inline-block",onClick:()=>{Nn(h.data.id),nn(h.data.complaint)},title:"Click to edit",children:[h.data.complaint,i.jsxs("span",{className:"text-gray-400 ml-1",children:["(",new Date(h.originalDateString).toLocaleDateString(),")"]})]})}),[Ta,At,vn,Rt]),Hl=x.useMemo(()=>i.jsxs("div",{className:"flex space-x-2",children:[i.jsx("button",{onClick:Qa,className:"button-primary blue text-xs px-2 py-1",disabled:rr||Ve.filter(h=>h.status==="pending").length<2,title:"Merge all pending orders into one",children:rr?"Merging...":"Merge Orders"}),i.jsxs("button",{onClick:()=>da(!0),className:"button-primary green text-xs px-2 py-1",title:"Manually create a new pharmacy order",disabled:!d,children:[i.jsx(xr,{size:12,className:"mr-1"})," Create Order"]})]}),[Qa,rr,Ve,d]),Wl=x.useMemo(()=>i.jsxs("div",{className:"flex space-x-2",children:[i.jsx("button",{onClick:Ga,className:"button-primary blue text-xs px-2 py-1",title:"Tell AI to analyse the reports",disabled:A||nt||Lt||Qe,children:"Analyse Reports"}),i.jsxs("button",{onClick:()=>ca(!0),className:"button-primary green text-xs px-2 py-1",title:"Manually create a new lab order",disabled:!d,children:[i.jsx(xr,{size:12,className:"mr-1"})," Create Lab Order"]})]}),[Ga,A,nt,Lt,Qe,d]),[Ya,Ka]=x.useState(null),[Za,Xa]=x.useState([]),[dr,es]=x.useState(""),ts=(h,g)=>{if(!h||!h.report_content||!g)return"";try{const f=JSON.parse(h.report_content||"{}");if(typeof f!="object"||f===null)return`<p class="italic text-gray-500 text-xs">Report content is not structured data.</p><pre>${h.report_content}</pre>`;let k="";return g.forEach(N=>{f[N.id]?(k+=`<h5 class="font-semibold text-sm mt-2 mb-1">${N.name}</h5>`,k+='<table class="lab-report-print-table"><thead><tr><th>Parameter</th><th>Value</th><th>Normal Range</th></tr></thead><tbody>',Object.entries(f[N.id]).map(([Q,pe])=>{var kt;const ue=(kt=N.default_parameters)==null?void 0:kt.find(dt=>dt.name===Q);let be="N/A";ue&&ue.type==="number"&&(ue.lower_limit!=null||ue.upper_limit!=null)?(be="",ue.lower_limit!=null&&(be+=` > ${ue.lower_limit}`),ue.lower_limit!=null&&ue.upper_limit!=null&&(be+=" - "),ue.upper_limit!=null&&(be+=` < ${ue.upper_limit}`),be=be.trim()||"N/A"):(ue==null?void 0:ue.type)==="boolean"?be="N/A":ue!=null&&ue.normal_range&&(be=ue.normal_range),k+=`<tr><td>${Q}</td><td>${String(pe)} ${(ue==null?void 0:ue.unit)||""}</td><td>${be}</td></tr>`}),k+="</tbody></table>"):k+=`<p class="italic text-gray-500 text-xs">No parameters reported for ${N.name}.</p>`}),k}catch{return`<p class="italic text-gray-500 text-xs">Error parsing report content.</p><pre>${h.report_content}</pre>`}};x.useEffect(()=>{const h=()=>{Zt(window.innerHeight)};return window.addEventListener("resize",h),h(),()=>window.removeEventListener("resize",h)},[]),x.useEffect(()=>{const h=f=>{if(!de||!se.current||!Be.current)return;const k=Be.current.getBoundingClientRect(),Q=f.clientX-se.current.x;let pe=se.current.initialWidth+Q;const ue=k.width-ve-10;pe=Math.max(ve,pe),pe=Math.min(pe,ue);const be=pe/k.width*100;fe(be)},g=()=>{H(!1),se.current=null,document.body.style.cursor="",document.body.style.userSelect=""};return de&&(window.addEventListener("mousemove",h),window.addEventListener("mouseup",g),document.body.style.cursor="col-resize",document.body.style.userSelect="none"),()=>{window.removeEventListener("mousemove",h),window.removeEventListener("mouseup",g),document.body.style.cursor="",document.body.style.userSelect=""}},[de]);const Vl=h=>{if(!Be.current)return;h.preventDefault();const g=Be.current.querySelector(".edit-complaint-context-column");g&&(se.current={x:h.clientX,initialWidth:g.offsetWidth},H(!0))},ns=x.useCallback(async()=>{w(!0),ke(null);try{const h=await Y("/api/queue/doctor/new",{method:"POST"});if(!h.ok){const f=await h.json().catch(()=>({}));throw new Error(f.message||`Failed to create record: ${h.statusText}`)}const g=await h.json();if(!g.recordId)throw new Error("New record ID not received from server.");a(`/edit-complaint/${g.recordId}`,{replace:!0})}catch(h){ke(`Failed to create new complaint record: ${h.message}`)}finally{w(!1)}},[a]);x.useEffect(()=>{(async()=>{Fa(!0);try{const g=await o.fetchQuery({queryKey:pt.clinicSettings,queryFn:async()=>{const f=await Y("/api/clinics/settings");if(!f.ok)throw new Error("Failed to fetch clinic settings.");return f.json()},staleTime:18e5});Kr({admissionCharge:parseFloat(g.admissionCharge||0).toFixed(2),perDayCharge:parseFloat(g.perDayCharge||0).toFixed(2),otherCharges:parseFloat(g.otherCharges||0).toFixed(2),aiMemory:g.aiMemory||"",aiMemoryUpdatedAt:g.aiMemoryUpdatedAt||null,clinicWideSystemPrompt:g.clinicWideSystemPrompt||"",clinicWideSystemPromptUpdatedAt:g.clinicWideSystemPromptUpdatedAt||null,gemini_api_key:g.gemini_api_key||""}),Zr(g.aiMemory||""),Sn(g.clinicWideSystemPrompt||"")}catch{}finally{Fa(!1)}})()},[]),x.useEffect(()=>{var g;(g=l.state)!=null&&g.initialComplaint&&u(l.state.initialComplaint);const h=async f=>{M(!0),ke(null);try{const k=await o.fetchQuery({queryKey:pt.queue.entry(f),queryFn:async()=>{const N=await Y(`/api/queue/doctor/complaint/${f}`);if(!N.ok){const Q=await N.json().catch(()=>({}));throw new Error(Q.message||`HTTP error! status: ${N.status}`)}return N.json()},staleTime:6e4});y(k.patientId),G(k.age),B(k.gender),W(k.case_summary||null),K(k.updatedAt||null)}catch{ke("Failed to load current complaint details."),y(null),G(void 0),B(void 0),W(null),K(null)}finally{M(!1)}};if(r)h(r);else if(t){const f=t;f&&(y(f),(async()=>{try{let N;try{N=await o.fetchQuery({queryKey:pt.queue.latest(f),queryFn:async()=>{const pe=await Y(`/api/queue/patient/${f}/latest`);if(!pe.ok)throw new Error("Failed");return pe.json()},staleTime:5e3})}catch{}if(N!=null&&N._id){s(N._id),h(N._id);return}const Q=await Y("/api/queue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:f,complaint:"Visit Initiated"})});if(Q.ok){const pe=await Q.json();if(pe!=null&&pe.id){s(pe.id),h(pe.id);return}}}catch(N){console.error("Background queue resolution failed",N),ke("Failed to initialize visit record.")}})())}else ns()},[r,ns,(ss=l.state)==null?void 0:ss.initialComplaint,t]),x.useEffect(()=>{d?En(d):(E(null),S([]),Tt([]),Pt([]),xt([]),K(null),_n(!1))},[d]),x.useEffect(()=>{var f;const h=(f=l.state)==null?void 0:f.initialComplaint;h&&r&&(!A&&!ee&&!bn&&!Qe&&!ct)&&!Ge.current&&c===h&&(Ge.current=!0,Vt(),a(l.pathname,{replace:!0,state:{}}))},[(os=l.state)==null?void 0:os.initialComplaint,r,c,A,ee,bn,Qe,ct,a]);const rs=()=>{le(I||""),j(!0),_(null)},Jl=()=>{j(!1),le(""),_(null)},Ql=async()=>{if(!r){_("Missing Record ID.");return}oe(!0),_(null);try{const h=await Y(`/api/queue/doctor/complaint/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({case_summary:X.trim()})});if(!h.ok){const f=await h.json().catch(()=>({}));throw new Error(f.message||`Failed to save case summary: ${h.statusText}`)}const g=await h.json();W(g.case_summary||X.trim()),K(g.updatedAt||null),j(!1)}catch(h){_(`Save Error: ${h.message}`)}finally{oe(!1)}};x.useEffect(()=>{(async()=>{rt(!0),tn(null);try{const[g,f]=await Promise.all([o.fetchQuery({queryKey:pt.drugs.all,queryFn:async()=>{const k=await Y("/api/drugs");if(!k.ok)throw new Error(`Pharmacy inventory error! status: ${k.status}`);const N=await k.json();return N.drugs||N},staleTime:6e5}),o.fetchQuery({queryKey:pt.labTests.all,queryFn:async()=>{const k=await Y("/api/lab-tests");if(!k.ok)throw new Error(`Lab inventory error! status: ${k.status}`);return k.json()},staleTime:6e5})]);Ye(g),bt(f||[])}catch(g){tn(g.message)}finally{rt(!1)}})()},[]);const Gl=async()=>{if(!Ae)return;if(sr===Ae.aiMemory&&Cn===Ae.clinicWideSystemPrompt){or(!1);return}const h=sr!==Ae.aiMemory,g=Cn!==Ae.clinicWideSystemPrompt;h&&za(!0),g&&qa(!0);try{const f={...Ae};h&&(f.aiMemory=sr),g&&(f.clinicWideSystemPrompt=Cn);const k=await Y("/api/clinics/settings",{method:"PUT",body:JSON.stringify(f)});if(!k.ok){const Q=await k.json().catch(()=>({}));throw new Error(Q.message||"Failed to update clinic settings.")}const N=await k.json();Kr({admissionCharge:parseFloat(N.settings.admissionCharge).toFixed(2),perDayCharge:parseFloat(N.settings.perDayCharge).toFixed(2),otherCharges:parseFloat(N.settings.otherCharges).toFixed(2),aiMemory:N.settings.aiMemory||"",aiMemoryUpdatedAt:N.settings.aiMemoryUpdatedAt||(Ae==null?void 0:Ae.aiMemoryUpdatedAt)||null,clinicWideSystemPrompt:N.settings.clinicWideSystemPrompt||"",clinicWideSystemPromptUpdatedAt:N.settings.clinicWideSystemPromptUpdatedAt||(Ae==null?void 0:Ae.clinicWideSystemPromptUpdatedAt)||null}),h&&Zr(N.settings.aiMemory||""),g&&(Sn(N.settings.clinicWideSystemPrompt||""),or(!1))}catch{}finally{h&&za(!1),g&&qa(!1)}},is=()=>{Ae&&(Sn(Ae.clinicWideSystemPrompt||""),or(!0))},Yl=()=>{or(!1),Ae&&Sn(Ae.clinicWideSystemPrompt||"")},Kl=h=>{navigator.clipboard.writeText(h).then(()=>{}).catch(g=>{console.error("Failed to copy text: ",g)})},oi=(h,g)=>{const f=window.open("","_blank");f&&(f.document.write(`
        <html>
          <head>
            <title>${g}</title>
            <style>
              body { font-family: sans-serif; margin: 20px; }
              h2 { text-align: center; margin-bottom: 20px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              pre { white-space: pre-wrap; word-wrap: break-word; }
              .ai-context-section { margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 5px; }
              .ai-context-section-title { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; color: #333; }
              .ai-context-text { margin-bottom: 5px; }
              .text-gray-400 { color: #999; }
              .font-semibold { font-weight: 600; }
              .italic { font-style: italic; }
              .mt-2 { margin-top: 8px; }
              .ml-1 { margin-left: 4px; }
              .ml-2 { margin-left: 8px; }
              .flex { display: flex; }
              .flex-col { flex-direction: column; }
              .w-full { width: 100%; }
              .text-xs { font-size: 0.75rem; }
              .text-sm { font-size: 0.875rem; }
              .prose { max-width: 65ch; }
              .prose table { display: table; } /* Ensure tables in markdown render correctly */
            </style>
          </head>
          <body>
            <h2>${g}</h2>
            <div id="print-content">${h}</div>
          </body>
        </html>
      `),f.document.close(),f.print())},Zl=()=>{if(b){const h=wi().use(_t).use(Si).processSync(We).toString();oi(`<div class="prose">${h}</div>`,"Summary")}};x.useEffect(()=>{if(p){let h=`
        <div class="print-section">
          <h3>Patient Details</h3>
          <p><strong>Name:</strong> ${p.name||"N/A"}</p>
          <p><strong>Token:</strong> ${p.patient_token_number||"N/A"}</p>
          <p><strong>Age:</strong> ${p.age||"N/A"}</p>
          <p><strong>Gender:</strong> ${p.gender||"N/A"}</p>
          <p><strong>Phone:</strong> ${p.phone||"N/A"}</p>
          <p><strong>Insurance:</strong> ${p.insurance_type||"N/A"}</p>
          <p><strong>Status:</strong> ${p.current_status||"N/A"}</p>
          <p><strong>Admitted:</strong> ${p.admission_date?new Date(p.admission_date).toLocaleDateString():"N/A"}</p>
          <p><strong>Discharged:</strong> ${p.discharge_date?new Date(p.discharge_date).toLocaleDateString():"N/A"}</p>
        </div>
        <div class="print-section">
          <h3>Case Summary</h3>
          <p>${I||"No summary available."}</p>
        </div>
        <div class="print-section">
          <h3>Complaints History</h3>
          ${Ft.length>0?`
            <ul>
              ${Ft.map(g=>`<li>${new Date(g.originalDateString).toLocaleDateString()}: ${g.data.complaint}</li>`).join("")}
            </ul>
          `:"<p>No past complaints.</p>"}
        </div>
        <div class="print-section">
          <h3>Pharmacy Orders</h3>
          ${wt.length>0?`
            <table class="print-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Drug Name</th>
                  <th>Quantity</th>
                  <th>Dosage</th>
                  <th>Directions</th>
                </tr>
              </thead>
              <tbody>
                ${wt.map(g=>{const f=g.data.medications.map((N,Q)=>`
                    <tr>
                      ${Q===0?`<td rowspan="${g.data.medications.length+(g.data.prescriptionForUnavailableDrugs?1:0)}">${new Date(g.originalDateString).toLocaleDateString()}</td>`:""}
                      ${Q===0?`<td rowspan="${g.data.medications.length+(g.data.prescriptionForUnavailableDrugs?1:0)}">${g.data.status}</td>`:""}
                      <td><strong>${N.name}</strong></td>
                      <td>
                        ${N.pack_quantity!==void 0&&N.pack_quantity>0?`Packs: ${N.pack_quantity}`:""}
                        ${N.pack_quantity!==void 0&&N.pack_quantity>0&&N.loose_quantity!==void 0&&N.loose_quantity>0?", ":""}
                        ${N.loose_quantity!==void 0&&N.loose_quantity>0?`Loose: ${N.loose_quantity}`:""}
                      </td>
                      <td>${N.tabletsPerDay&&N.numberOfDays?`${N.tabletsPerDay} tab/day for ${N.numberOfDays} days`:"N/A"}</td>
                      <td>${N.directions_to_use||"N/A"}</td>
                    </tr>
                  `).join("");let k="";return g.data.prescriptionForUnavailableDrugs&&(k=`
                      <tr>
                        <td colspan="4" style="background-color: #f9f9f9; padding: 10px;">
                          <div style="font-style: italic; margin-bottom: 5px; font-weight: 600;">Prescription for Unavailable Drugs:</div>
                          <div class="prose" style="font-size: 0.9em;">${wi().use(_t).use(Si).processSync(g.data.prescriptionForUnavailableDrugs).toString()}</div>
                        </td>
                      </tr>
                    `),f+k}).join("")}
              </tbody>
            </table>
          `:"<p>No pharmacy orders.</p>"}
        </div>
        <div class="print-section">
          <h3>Lab History (Orders & Reports)</h3>
          ${zt.length>0?`
            ${zt.map(g=>{const f=g.data.tests.map(N=>N.name).join(", ");let k="";return g.data.report&&(k=`
                  <div class="lab-report-print-container">
                    <h4>Lab Report (${new Date(g.data.report.report_date).toLocaleDateString()})</h4>
                    ${ts(g.data.report,g.data.report.tests)}
                  </div>
                `),`
                <div class="lab-history-item">
                  <p><strong>Order Date:</strong> ${new Date(g.originalDateString).toLocaleDateString()}</p>
                  <p><strong>Status:</strong> ${g.data.status}</p>
                  <p><strong>Tests:</strong> ${f}</p>
                  ${k}
                </div>
              `}).join("")}
          `:"<p>No lab history.</p>"}
        </div>
      `;if(Object.keys(cr).length>0){const g=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],f=[32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17],k=(ue,be)=>{const kt=lr[ue]||[],dt=Gg(ue,kt);return`
            <div style="display:inline-flex;flex-direction:column;align-items:center;margin:2px;">
              ${be?`<span style="font-size:8px;color:#666;margin-bottom:2px;">${ue}</span>`:""}
              ${dt}
              ${be?"":`<span style="font-size:8px;color:#666;margin-top:2px;">${ue}</span>`}
            </div>
          `},N=g.map(ue=>k(ue,!0)).join(""),Q=f.map(ue=>k(ue,!1)).join(""),pe=Object.entries(cr).sort(([ue],[be])=>Number(ue)-Number(be)).map(([ue,be])=>{const dt=(lr[Number(ue)]||[]).map(pr=>pr.replace("condition-","")).join(", "),uc=be.map(pr=>`${pr.name} (${pr.date})`).join("; ");return`
              <tr>
                <td><strong>Tooth ${ue}</strong></td>
                <td>${dt||"N/A"}</td>
                <td>${uc||"N/A"}</td>
              </tr>
            `}).join("");h+=`
          <div class="print-section">
            <h3>Dental Chart</h3>
            <div style="text-align:center;margin-bottom:15px;padding:10px;background:#f9f9f9;border-radius:8px;">
              <div style="margin-bottom:8px;">
                <div style="font-size:10px;color:#666;margin-bottom:4px;">Upper Arch</div>
                <div style="display:flex;justify-content:center;flex-wrap:nowrap;">${N}</div>
              </div>
              <div style="border-top:1px solid #ddd;padding-top:8px;">
                <div style="display:flex;justify-content:center;flex-wrap:nowrap;">${Q}</div>
                <div style="font-size:10px;color:#666;margin-top:4px;">Lower Arch</div>
              </div>
            </div>
            <h4 style="margin-top:15px;margin-bottom:8px;">Procedure Details</h4>
            <table class="print-table">
              <thead>
                <tr>
                  <th>Tooth</th>
                  <th>Conditions</th>
                  <th>Procedures</th>
                </tr>
              </thead>
              <tbody>
                ${pe}
              </tbody>
            </table>
          </div>
        `}es(h)}else es("")},[p,I,Ft,wt,zt,ts,cr,lr]);const as=()=>{dr&&oi(dr,`Patient Details - ${p==null?void 0:p.name}`)},Xl=h=>{u(h),Ka(null),Xa([]),setTimeout(()=>{Vt(h)},0)},It=A||nt||v||Qe||ee||ct||bn||he||Wn||dl||hl||fl||yl||ft||Et||an||sn||rr||Jn||Ar||Dr||Ir||$r||ne,ec=h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),!It&&c.trim()&&r&&Vt())};x.useEffect(()=>{const h=window.SpeechRecognition||window.webkitSpeechRecognition;if(!h){Jr("Speech recognition not supported in this browser.");return}const g=new h;return g.continuous=!0,g.interimResults=!0,g.lang="en-US",g.onresult=f=>{let k="";for(let N=f.resultIndex;N<f.results.length;++N)f.results[N].isFinal&&(k+=f.results[N][0].transcript);k&&u(N=>N+(N.endsWith(" ")||N===""?"":" ")+k)},g.onerror=f=>{Jr(`Speech error: ${f.error}`),Tl(!1)},g.onend=()=>{},er.current=g,()=>{er.current&&er.current.stop()}},[]);const tc=async()=>{if(d)if(Kn){ka(!0);try{const h=await Y(`/api/patients/${d}/discharge`,{method:"POST"});if(!h.ok){const g=await h.json().catch(()=>({}));throw new Error(g.message||`Failed to discharge patient: ${h.status}`)}on(d)}catch(h){ke(`Discharge Error: ${h.message}`)}finally{ka(!1)}}else{wa(!0);try{const h=await Y(`/api/patients/${d}/admit`,{method:"POST"});if(!h.ok){const g=await h.json().catch(()=>({}));throw new Error(g.message||`Failed to admit patient: ${h.status}`)}on(d)}catch(h){ke(`Admit Error: ${h.message}`)}finally{wa(!1)}}},nc=async h=>{if(d){_a(!0);try{const f=await Y("/api/queue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patientId:d})});if(!f.ok){const k=await f.json().catch(()=>({}));throw new Error(k.message||`Failed to add patient to ${h} queue: ${f.status}`)}d&&(on(d),ni(d))}catch(g){ke(`Add to Queue Error: ${g.message}`)}finally{_a(!1)}}},rc=async()=>{if(r){Na(!0),ke(null);try{const h=await Y(`/api/queue/${r}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"seen"})});if(!h.ok){const f=await h.json().catch(()=>({}));throw new Error(f.message||"Failed to complete consultation")}d&&(on(d),ni(d));const g=localStorage.getItem("currentUser");if(o.removeQueries({queryKey:pt.queue.all}),g){const f=JSON.parse(g);f.role==="receptionist"?a("/dashboard"):f.role==="doctor"||f.role==="admin"?a("/dashboard/queue"):a("/dashboard")}else a("/dashboard")}catch(h){ke(`Error completing consultation: ${h.message}`)}finally{Na(!1)}}},ic=async()=>{if(!d){Wt("Missing Patient ID.");return}if(!p){Wt("Patient details not loaded.");return}Hr(!0),Wt(null);try{const h={};let g=!1;if(Lr!==p.name&&(h.name=Lr,g=!0),Fr!==p.age&&(h.age=Fr,g=!0),qr!==p.gender&&(h.gender=qr,g=!0),Ur!==p.phone&&(h.phone=Ur,g=!0),!g){Wt("No changes detected."),Hr(!1),Zn(!1);return}const f=await Y(`/api/patients/${d}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)});if(!f.ok){const N=await f.json().catch(()=>({}));throw new Error(N.message||`Failed to update patient details: ${f.statusText}`)}const k=await f.json();E(k),G(k.age),B(k.gender),Rr(k.name),zr(k.age),Br(k.gender),Mr(k.phone),Zn(!1)}catch(h){Wt(`Save Error: ${h.message}`)}finally{Hr(!1)}},ac=async(h,g,f)=>{h.stopPropagation();const k=[null,"red","green","blue"],N=k.indexOf(f||null),Q=k[(N+1)%k.length];E(pe=>pe?{...pe,color_code:Q}:null);try{await Y(`/api/patients/${g}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({color_code:Q})})}catch(pe){console.error("Error updating color code:",pe),E(ue=>ue?{...ue,color_code:f||null}:null)}},sc=x.useCallback(()=>{if(!p)return null;const h={token_number:p.patient_token_number||"N/A",name:p.name||"N/A",age:p.age||"N/A",gender:p.gender||"N/A",phone:p.phone||"N/A"};return Ft.length>0?h.complaints_history=Ft.map(g=>`${g.data.complaint} (${new Date(g.originalDateString).toLocaleDateString()})`).join("; "):h.complaints_history="No past complaints.",wt.length>0?h.pharmacy_orders_history=wt.map(g=>`Order: ${g.data.medications.map(k=>{let N=`${k.name}`;return k.pack_quantity!==void 0&&k.pack_quantity>0&&(N+=` Packs: ${k.pack_quantity}`),k.loose_quantity!==void 0&&k.loose_quantity>0&&(N+=` Loose: ${k.loose_quantity}`),N}).join(", ")} (${g.data.status}, ${new Date(g.originalDateString).toLocaleDateString()})`).join("; "):h.pharmacy_orders_history="No pharmacy orders.",zt.length>0?h.lab_orders_history=zt.map(g=>{let k=`Lab Order: ${g.data.tests.map(N=>N.name).join(", ")} (${g.data.status}, ${new Date(g.originalDateString).toLocaleDateString()})`;return g.data.report&&(k+=` - Report: ${g.data.report.report_content} (${new Date(g.data.report.report_date).toLocaleDateString()})`),k}).join("; "):h.lab_orders_history="No lab history.",Le.length>0?h.recurring_medications=Le.map((g,f)=>{let k=`${f+1}. ${g.medicationName} (${g.frequencyDays} days, ${g.status})`;return g.tabletsPerDay&&(k+=` - ${g.tabletsPerDay} tabs/day`),g.numberOfDays&&(k+=` for ${g.numberOfDays} days`),k}).join("; "):h.recurring_medications="No recurring medications.",h},[p,Ft,wt,zt,Le]),oc=()=>{if(!p){Jr("Patient details are required to use the Live API.");return}Yr(!0)},lc=()=>{var h;(h=tr.current)==null||h.click()},cc=async h=>{var f;const g=(f=h.target.files)==null?void 0:f[0];if(g&&d){Aa(g),Ia(!0);try{const k=new FormData;k.append("files",g),(await Y(`/api/patient-files/${d}`,{method:"POST",body:k})).ok||ke("Image upload failed. Please try again.")}catch(k){console.error("Image upload error:",k),ke("Image upload failed. Please try again.")}finally{Ia(!1)}}},li=x.useRef(!1),Dn=x.useRef(null),un=x.useRef(null),ut=x.useRef({response:!0,pharmacy:!1,recurring:!1,labs:!1,history:!1,summary:!1}),[In,dn]=x.useState("response"),$n=h=>{li.current=!0,dn(h),Dn.current&&clearTimeout(Dn.current),Dn.current=setTimeout(()=>{li.current=!1},1e3);const g={behavior:"smooth",block:"start"};h==="response"&&xe.current?xe.current.scrollIntoView(g):h==="meds"?z.current?z.current.scrollIntoView(g):un.current&&un.current.scrollIntoView(g):h==="labs"&&L.current?L.current.scrollIntoView(g):h==="history"&&$.current?$.current.scrollIntoView(g):h==="summary"&&ie.current&&ie.current.scrollIntoView(g)};return x.useEffect(()=>{const h=new IntersectionObserver(g=>{li.current||(g.forEach(f=>{f.target===xe.current?ut.current.response=f.isIntersecting:f.target===z.current?ut.current.pharmacy=f.isIntersecting:f.target===un.current?ut.current.recurring=f.isIntersecting:f.target===L.current?ut.current.labs=f.isIntersecting:f.target===$.current?ut.current.history=f.isIntersecting:f.target===ie.current&&(ut.current.summary=f.isIntersecting)}),ut.current.response?dn("response"):ut.current.pharmacy||ut.current.recurring?dn("meds"):ut.current.labs?dn("labs"):ut.current.history?dn("history"):ut.current.summary&&dn("summary"))},{root:null,threshold:0,rootMargin:"-10% 0px -50% 0px"});return xe.current&&h.observe(xe.current),z.current&&h.observe(z.current),L.current&&h.observe(L.current),$.current&&h.observe($.current),ie.current&&h.observe(ie.current),un.current&&h.observe(un.current),()=>{h.disconnect(),Dn.current&&clearTimeout(Dn.current)}},[]),i.jsxs("div",{className:"edit-complaint-page",style:{height:`${Ct}px`},children:[i.jsx(Kh,{ref:Tn,recordId:r,patientId:d,patientDetails:p,caseSummary:I,caseSummaryUpdatedAt:C,clinicSettings:Ae,userMessages:m,selectedImageFile:Gr,pendingLabOrders:Sr,labReports:mt,pastComplaints:P,pharmacyOrders:Ve,pharmacyInventory:Ee,labInventory:lt,recurringMedications:Le,currentComplaint:c,setCurrentComplaint:u,setAiResponse:Ie,setAiResponseText:_e,setAiResponseJsonString:Fe,setShowAiJsonDetails:ot,setIsLoadingAi:Kt,setAiError:()=>{},setIsSubmittingAiOrder:Vn,setAiOrderSubmissionStatus:()=>{},setIsSubmittingAiLabOrder:pl,setAiLabOrderSubmissionStatus:()=>{},setIsSubmittingAiComplaint:ml,setAiComplaintSubmissionStatus:()=>{},setIsUpdatingCaseSummary:gl,setAiCaseSummaryUpdateStatus:()=>{},setCaseSummary:W,setCaseSummaryUpdatedAt:K,setIsUpdatingAiMemoryByAI:xl,setAiMemoryUpdateByAIStatus:()=>{},setFollowUpQuestion:Ka,setFollowUpOptions:Xa,setError:ke,setIsSavingAiResponse:Ot,setSaveAiResponseError:()=>{},fetchPharmacyOrdersData:ln,fetchPendingLabOrdersData:cn,fetchLabReportsData:Pn,fetchPastComplaintsData:Ua,fetchPatientDetails:on,fetchRecurringMedicationsData:En,setClinicSettings:Kr,setEditedAiMemory:Zr,handleDeleteItem:Rt,setCanUndo:Ba,onAiActionSuccess:ye,addMessage:Qr,onPrintLabBill:h=>{Nl(h),ya(!0)},onPrintPharmacyBill:$l}),i.jsx(Wg,{isOpen:kl,onClose:()=>ya(!1),billData:_l}),i.jsx(Vg,{isOpen:vl,onClose:()=>xa(!1),billData:jl}),d&&p&&i.jsxs(i.Fragment,{children:[i.jsx(kc,{isOpen:El,onClose:()=>ar(!1),patientId:d,patientName:p.name,onRecordPayment:()=>{ar(!1),La(!0)}}),i.jsx(_c,{isOpen:Al,onClose:()=>La(!1),patientId:d,patientName:p.name,currentDebt:ir||0,onPaymentSuccess:()=>{o.invalidateQueries({queryKey:pt.patientDebts.balance(d)}),ar(!0)}})]}),Pl&&p&&i.jsx(Nc,{onClose:()=>Yr(!1),patientData:sc(),tokenNumber:p.patient_token_number?String(p.patient_token_number):null,onAiSummaryChange:h=>{h&&(u(h),Vt(h),Yr(!1))}}),i.jsxs("div",{className:"edit-complaint-header",children:[i.jsx("button",{onClick:()=>a(-1),disabled:It,className:"back-button",title:"Go Back",children:i.jsx(vc,{size:20})}),i.jsx("span",{ref:te,style:{position:"absolute",visibility:"hidden",height:"auto",width:"auto",whiteSpace:"nowrap"}}),!p&&Lt&&i.jsx("div",{className:"patient-header-details",children:i.jsxs("div",{className:"patient-info-display skeleton",children:[i.jsx(Te,{width:"120px",height:"18px"}),i.jsx(Te,{width:"60px",height:"16px"}),i.jsx(Te,{width:"80px",height:"16px"}),i.jsx(Te,{width:"90px",height:"16px"})]})}),p&&i.jsx("div",{className:"patient-header-details",children:Sl?i.jsxs("div",{className:"patient-details-edit-form",children:[i.jsx("input",{type:"text",value:Lr,onChange:h=>Rr(h.target.value),placeholder:"Name",className:"edit-input",disabled:Et}),i.jsx("input",{type:"number",value:Fr??"",onChange:h=>zr(h.target.value?parseInt(h.target.value):null),placeholder:"Age",className:"edit-input age",disabled:Et}),i.jsxs("select",{value:qr??"",onChange:h=>Br(h.target.value||null),className:"edit-input gender",disabled:Et,children:[i.jsx("option",{value:"",children:"Gender"}),i.jsx("option",{value:"M",children:"M"}),i.jsx("option",{value:"F",children:"F"}),i.jsx("option",{value:"O",children:"O"})]}),i.jsx("input",{type:"text",value:Ur??"",onChange:h=>Mr(h.target.value||null),placeholder:"Phone",className:"edit-input phone",disabled:Et}),i.jsxs("div",{className:"edit-form-actions",children:[i.jsx("button",{onClick:()=>{Zn(!1),Wt(null)},className:"cancel-btn",disabled:Et,children:"Cancel"}),i.jsx("button",{onClick:ic,className:"save-btn",disabled:Et,children:Et?"...":"Save"})]}),ja&&i.jsx("div",{className:"error-note",children:ja})]}):i.jsxs("div",{className:"patient-info-display",children:[i.jsx("button",{onClick:()=>{Zn(!0),Rr(p.name||""),zr(p.age),Br(p.gender),Mr(p.phone),Wt(null)},className:"patient-edit-trigger",title:"Edit Patient Details",disabled:Et,children:i.jsx(gt,{size:14})}),i.jsxs("div",{className:"patient-ident-group",children:[i.jsx("span",{className:"patient-name",children:p.name??"N/A"}),i.jsxs("span",{className:"patient-id-badge",children:["#",p.patient_token_number??"N/A"]}),i.jsxs("span",{className:"patient-demographics",children:[p.age??"N/A"," / ",p.gender??"N/A"]}),i.jsx("div",{className:`patient-color-indicator status-color-${p.color_code||"none"}`,onClick:h=>ac(h,p.id,p.color_code),title:"Click to cycle status color"}),p.phone&&i.jsxs("span",{className:"patient-phone-display",children:["(",p.phone,")"]}),ir!==null&&ir>0&&i.jsxs("div",{className:"patient-debt-indicator",onClick:()=>ar(!0),title:"Manage Debts",style:{cursor:"pointer"},children:["₹",ir.toFixed(2)]})]}),i.jsxs("div",{className:"patient-action-group",children:[i.jsxs("button",{onClick:ei,className:"action-icon-btn indigo",title:"Dental Overview",children:[i.jsx(jc,{toothNumber:30,style:{width:"14px",height:"14px"}}),i.jsx("span",{className:"btn-label",children:"Dental"})]}),i.jsxs("button",{onClick:Ll,className:"action-icon-btn indigo",title:"Medical Procedures",children:[i.jsx(Cc,{size:14}),i.jsx("span",{className:"btn-label",children:"Medical"})]}),i.jsxs("button",{onClick:()=>{p&&a("/dashboard/files",{state:{patient:{id:p.id,name:p.name,token:p.patient_token_number,age:p.age,gender:p.gender,phone:p.phone}}})},className:"action-icon-btn indigo",title:"Files",children:[i.jsx(ci,{size:14}),i.jsx("span",{className:"btn-label",children:"Files"})]}),i.jsxs("button",{onClick:h=>{h.stopPropagation(),as()},disabled:!dr,className:"action-icon-btn gray",title:"Print Summary",children:[i.jsx(Rn,{size:14}),i.jsx("span",{className:"btn-label",children:"Print"})]})]})]})}),!p&&q!==void 0&&O!==void 0&&i.jsx("div",{className:"patient-header-details",children:i.jsxs("div",{className:"patient-info-display",children:[i.jsxs("span",{className:"patient-demographics",children:[q??"N/A"," / ",O??"N/A"]}),i.jsx("button",{onClick:h=>{h.stopPropagation(),as()},disabled:!dr,className:"action-icon-btn gray",title:"Print Summary",children:i.jsx(Rn,{size:14})})]})}),i.jsx("div",{style:{minWidth:"64px",display:"flex",justifyContent:"flex-end"},children:i.jsx("button",{onClick:e,className:"icon-button small text-gray-600 hover:text-gray-900 bg-gray-100 hover:bg-gray-200",title:"Open Command Bar (Ctrl+K)",style:{padding:"0.2rem",borderRadius:"8px"},children:i.jsx(Sc,{size:24})})})]}),i.jsxs("div",{className:"edit-complaint-content-area",ref:Be,children:[Ea.length>0&&i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"edit-complaint-chat-column",style:{width:"30%",minWidth:"320px",maxWidth:"40%",flexShrink:0},children:i.jsx(Jg,{messages:Ea})}),i.jsx("div",{className:"draggable-divider",onMouseDown:()=>{}})]}),i.jsxs("div",{ref:xe,className:"edit-complaint-main-column",style:{flex:1,minWidth:0},children:[ze&&i.jsxs("div",{className:"general-error-message",children:["Error: ",ze]}),nt&&i.jsxs("div",{className:"ai-response-container",style:{padding:"16px"},children:[i.jsx(Te,{width:"100%",height:"18px",style:{marginBottom:"10px"}}),i.jsx(Te,{width:"95%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"85%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"90%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"70%",height:"16px"})]}),!nt&&(We||st)&&i.jsxs("div",{ref:je,className:`${st?"ai-function-call-block":"ai-response-container"} group`,children:[We&&i.jsx(Gt,{remarkPlugins:[_t],children:We}),st&&i.jsxs("div",{className:"ai-json-details-container",children:[i.jsxs("button",{onClick:()=>ot(!tt),className:"ai-json-toggle-button",children:[tt?i.jsx(us,{size:14,className:"mr-1"}):i.jsx(ds,{size:14,className:"mr-1"}),tt?"Hide":"Show"," AI Function Call Details"]}),tt&&i.jsx("pre",{className:"ai-json-pre",children:i.jsx("code",{children:JSON.stringify(JSON.parse(st),null,2)})})]}),i.jsxs("div",{className:"ai-response-actions",children:[i.jsx("button",{onClick:()=>Kl(b),disabled:!b,title:"Copy Full AI Response",children:i.jsx(Tc,{size:12})}),i.jsx("button",{onClick:Zl,disabled:!b,title:"Print AI Response",children:i.jsx(Rn,{size:12})})]})]})]}),i.jsx("div",{className:"draggable-divider",onMouseDown:Vl}),i.jsx("div",{ref:Z,className:"edit-complaint-context-column",style:{flexBasis:`calc(${100-ae}% - 5px)`},children:i.jsxs("div",{className:"ai-context-container",children:[i.jsxs("h3",{className:"ai-context-header",children:[i.jsx("span",{children:"AI Context:"}),(p==null?void 0:p.insurance_type)&&i.jsx("div",{className:"insurance-type-container mt-2",children:i.jsxs("select",{ref:qe,value:p.insurance_type,onChange:h=>Ol(p.id,h.target.value),className:"insurance-type-select",children:[i.jsx("option",{value:"cash",children:"Cash"}),i.jsx("option",{value:"insurance",children:"Insurance"}),i.jsx("option",{value:"no_cash_insurance",children:"No Cash Insurance"})]})})]}),J.length>0&&i.jsxs("div",{className:"ai-context-section",children:[i.jsx("div",{className:"flex justify-between items-center mb-2",children:i.jsx("h4",{className:"ai-context-section-title mb-0",children:"Dental Overview"})}),i.jsx("div",{onClick:ei,style:{cursor:"pointer",transform:"scale(0.8)",transformOrigin:"top left",width:"125%",height:"350px",overflow:"hidden",pointerEvents:"auto"},title:"Click to open full Dental Page",children:i.jsx(Pc,{selectedTeeth:[],onToothClick:()=>ei(),toothConditions:lr,toothDetails:cr,numberingSystem:localStorage.getItem("dentalNumberingSystem")||"universal"})})]}),i.jsxs("div",{ref:D,className:"ai-context-section",children:[i.jsx("h4",{className:"ai-context-section-title",children:"Admission Status"}),Lt?i.jsxs("div",{className:"space-y-2",children:[i.jsx(Te,{width:"60%",height:"1.2em"}),i.jsx(Te,{width:"50%",height:"1.2em"}),i.jsx(Te,{width:"40%",height:"1.2em"}),i.jsxs("div",{className:"flex space-x-2 mt-2",children:[i.jsx(Te,{width:"80px",height:"30px"}),i.jsx(Te,{width:"100px",height:"30px"})]})]}):i.jsxs(i.Fragment,{children:[(p==null?void 0:p.admission_date)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Admitted:"})," ",new Date(p.admission_date).toLocaleDateString()]}),(p==null?void 0:p.discharge_date)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Discharged:"})," ",new Date(p.discharge_date).toLocaleDateString()]}),(p==null?void 0:p.current_status)&&i.jsxs("p",{className:"ai-context-text",children:[i.jsx("strong",{children:"Current Status:"})," ",i.jsx("span",{className:"font-semibold",children:p.current_status})]}),i.jsxs("div",{className:"flex space-x-2 mt-2",children:[i.jsx("button",{onClick:tc,className:`admit-discharge-button ${Kn?"discharge":"admit"}`,title:Kn?"Discharge Patient":"Admit Patient",disabled:!d||Ar||Dr,children:Ar?"Admitting...":Dr?"Discharging...":Kn?"Discharge":"Admit"}),i.jsxs("button",{onClick:()=>a(`/patient/${encodeURIComponent(d??"")}/admission-billing`),className:"queue-status-button",style:{backgroundColor:"#e0f2fe",color:"#0369a1",border:"1px solid #bae6fd",display:"flex",alignItems:"center",gap:"4px"},title:"Go to Admission Billing",disabled:!d,children:[i.jsx(ls,{size:14})," Billing"]}),i.jsx("button",{onClick:()=>nc("doctor"),className:`queue-status-button ${Yn?"in-queue":"add-to-queue"}`,title:Yn?"Patient is in Doctor Queue":"Add Patient to Doctor Queue",disabled:!d||Ir||Yn,children:Ir?"Adding...":Yn?"In Queue":"Add to Queue"}),i.jsx("button",{onClick:rc,className:"complete-consultation-button",title:"Mark Consultation as Complete",disabled:$r,children:$r?"Completing...":"Complete Consultation"})]})]})]}),i.jsx("div",{ref:z,children:i.jsx(ki,{title:"Pharmacy Order History",headerAction:Hl,items:wt,isLoading:A||Lt,loadingText:"Loading...",noDataText:"No orders.",renderItemContent:Bl})}),i.jsxs("div",{ref:un,className:"ai-context-section mt-4",children:[i.jsxs("div",{className:"flex justify-between items-center mb-2",children:[i.jsx("h4",{className:"ai-context-section-title mb-0",children:"Recurring Medications"}),i.jsxs("button",{onClick:()=>{kn([]),Qn(!0)},className:"text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded flex items-center gap-1",children:[i.jsx(xr,{size:12})," Add"]})]}),Le.length>0?i.jsx("div",{className:"overflow-x-auto",children:i.jsxs("table",{className:"w-full text-xs text-left",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b",children:[i.jsx("th",{className:"py-1 px-2",children:"#"}),i.jsx("th",{className:"py-1 px-2",children:"Medication"}),i.jsx("th",{className:"py-1 px-2",children:"Qty"}),i.jsx("th",{className:"py-1 px-2",children:"Frequency"}),i.jsx("th",{className:"py-1 px-2",children:"Next Delivery"}),i.jsx("th",{className:"py-1 px-2",children:"Status"}),i.jsx("th",{className:"py-1 px-2"})]})}),i.jsx("tbody",{children:Le.map((h,g)=>i.jsxs("tr",{className:"border-b last:border-0 hover:bg-gray-50",children:[i.jsx("td",{className:"py-1 px-2 font-medium text-gray-500",children:g+1}),i.jsxs("td",{className:"py-1 px-2 font-medium",children:[h.medicationName,i.jsxs("div",{className:"text-[10px] text-gray-500 font-normal",children:[h.tabletsPerDay?`${h.tabletsPerDay} tabs/day`:"",h.tabletsPerDay&&h.numberOfDays?" • ":"",h.numberOfDays?`${h.numberOfDays} days`:"",h.directions?` • ${h.directions}`:""]})]}),i.jsx("td",{className:"py-1 px-2",children:h.quantity}),i.jsxs("td",{className:"py-1 px-2",children:[h.frequencyDays," days"]}),i.jsx("td",{className:"py-1 px-2",children:new Date(h.nextDeliveryDate).toLocaleDateString()}),i.jsx("td",{className:"py-1 px-2",children:i.jsx("span",{className:`px-1.5 py-0.5 rounded-full text-[10px] ${h.status==="active"?"bg-green-100 text-green-800":h.status==="paused"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:h.status})}),i.jsx("td",{className:"py-1 px-2 text-right",children:i.jsx("button",{onClick:()=>{Gn(h),Pr(!0)},className:"text-gray-400 hover:text-blue-600 p-1",title:"Edit",children:i.jsx(gt,{size:12})})})]},h.id))})]})}):A||Lt?i.jsx("div",{style:{marginTop:"8px"},children:[1,2,3].map(h=>i.jsxs("div",{style:{display:"flex",gap:"12px",marginBottom:"10px"},children:[i.jsx(Te,{width:"30px",height:"14px"}),i.jsx(Te,{width:"120px",height:"14px"}),i.jsx(Te,{width:"40px",height:"14px"}),i.jsx(Te,{width:"60px",height:"14px"}),i.jsx(Te,{width:"80px",height:"14px"})]},h))}):i.jsx("p",{className:"text-gray-500 text-sm italic",children:"No recurring medications."})]}),ua&&i.jsx(Ug,{isOpen:ua,onClose:()=>da(!1),patientId:d,pharmacyInventory:Ee,fetchPharmacyOrdersData:ln,isLoadingInventory:ct}),i.jsxs("div",{ref:L,children:[i.jsx(ki,{title:"Lab History (Orders & Reports)",headerAction:Wl,items:zt,onDeleteItem:void 0,onEditLabOrder:void 0,onSaveLabOrder:ql,onCancelEditLabOrder:Rl,onLabOrderTestChange:Fl,onLabOrderStatusChange:zl,onBillLabOrder:void 0,onUpdateLabOrderStatus:void 0,onEnterLabReport:void 0,labInventory:lt,isSavingLabOrder:ft,isLoading:bn||Qe||Lt,loadingText:"Loading...",noDataText:"No lab Hx.",expandedLabReports:wn,toggleLabReport:si,renderItemContent:Ul}),i.jsx(Wh,{isOpen:wl,onClose:()=>ca(!1),patientId:d,labInventory:lt,fetchPendingLabOrdersData:cn,isLoadingInventory:ct}),i.jsx("div",{ref:$,children:i.jsx(ki,{title:"Complaints History",items:Ft,isLoading:ee||Lt,loadingText:"Loading...",noDataText:"No past Hx.",renderItemContent:Ml,onDeleteItem:Rt})}),i.jsxs("div",{className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsxs("h4",{className:"ai-context-section-title",children:[i.jsx(Ec,{size:16,className:"text-purple-600"})," Clinic-wide System Prompt"]}),!Xr&&i.jsx("button",{onClick:is,className:"edit-button",title:"Edit System Prompt",disabled:Ra||an||sn,children:i.jsx(gt,{size:14})})]}),Xr&&Ae?i.jsxs("div",{className:"mt-2",children:[i.jsx("textarea",{value:Cn,onChange:h=>Sn(h.target.value),className:"context-edit-textarea",placeholder:"Enter clinic system prompt...",disabled:an||sn}),i.jsxs("div",{className:"context-edit-actions",children:[i.jsx("button",{onClick:Yl,disabled:an||sn,className:"button-secondary",children:"Cancel"}),i.jsxs("button",{onClick:Gl,disabled:an||sn||sr===Ae.aiMemory&&Cn===Ae.clinicWideSystemPrompt,className:"button-primary purple",children:[i.jsx(Xs,{size:14,className:"mr-1"}),sn||an?"Saving...":"Save Settings"]})]})]}):i.jsx("div",{className:"ai-context-text whitespace-pre-wrap mt-1 prose prose-sm max-w-none cursor-pointer hover:bg-gray-50 rounded p-1 -m-1 transition-colors",onClick:is,title:"Click to edit system prompt",children:Ra?i.jsxs("div",{style:{marginTop:"4px"},children:[i.jsx(Te,{width:"100%",height:"14px",style:{marginBottom:"6px"}}),i.jsx(Te,{width:"90%",height:"14px",style:{marginBottom:"6px"}}),i.jsx(Te,{width:"70%",height:"14px"})]}):Ae!=null&&Ae.clinicWideSystemPrompt?i.jsx(Gt,{remarkPlugins:[_t],children:Ae.clinicWideSystemPrompt}):i.jsx("span",{className:"italic text-gray-400",children:"N/A - Click to add."})}),!Xr&&(Ae==null?void 0:Ae.clinicWideSystemPromptUpdatedAt)&&i.jsxs("p",{className:"ai-context-text text-gray-400 mt-1",style:{fontSize:"0.625rem"},children:["Prompt Last Updated: ",new Date(Ae.clinicWideSystemPromptUpdatedAt).toLocaleDateString()]})]}),i.jsxs("div",{ref:ie,className:"ai-context-section",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsx("h4",{className:"ai-context-section-title",children:"Case Summary"}),!F&&i.jsx("button",{onClick:rs,className:"edit-button",title:"Edit Case Summary",disabled:A||ne,children:i.jsx(gt,{size:14})})]}),F?i.jsxs("div",{className:"mt-2",children:[i.jsx("textarea",{value:X,onChange:h=>le(h.target.value),className:"context-edit-textarea",rows:4,placeholder:"Enter case summary...",disabled:ne}),V&&i.jsx("p",{className:"text-red-500 text-xs mt-1",children:V}),i.jsxs("div",{className:"context-edit-actions",children:[i.jsx("button",{onClick:Jl,disabled:ne,className:"button-secondary",children:"Cancel"}),i.jsx("button",{onClick:Ql,disabled:ne||X===I,className:"button-primary blue",children:ne?"Saving...":"Save"})]})]}):i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"ai-context-text whitespace-pre-wrap mt-1 prose prose-sm max-w-none cursor-pointer hover:bg-gray-50 rounded p-1 -m-1 transition-colors",onClick:rs,title:"Click to edit case summary",children:A?i.jsxs("div",{style:{marginTop:"8px"},children:[i.jsx(Te,{width:"100%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"85%",height:"16px",style:{marginBottom:"8px"}}),i.jsx(Te,{width:"65%",height:"16px"})]}):I?i.jsx(Gt,{remarkPlugins:[_t],components:{},children:I}):i.jsx("span",{className:"italic text-gray-400",children:"N/A - Click to add."})}),C&&i.jsxs("p",{className:"ai-context-text text-gray-400 mt-1",style:{fontSize:"0.625rem"},children:["Last Edited: ",new Date(C).toLocaleDateString()]})]})]}),Ft.length===0&&zt.length===0&&wt.length===0&&!(ee||bn||Qe)&&i.jsx("p",{className:"ai-context-text italic mt-4",children:"No recent history for this patient."}),Jn&&i.jsx("p",{className:"text-yellow-600 text-xs mt-2 ai-context-text",children:"Deleting..."}),oa&&i.jsx("p",{className:"text-red-600 text-xs mt-2 ai-context-text",children:oa})]})]})})]}),i.jsxs("div",{className:"edit-complaint-input-area",children:[i.jsxs("div",{className:"status-messages-container",children:[Ht&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:Ht}),Re&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:Re}),aa&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:aa}),en&&i.jsx("p",{className:"text-center text-red-500 text-xs mb-1",children:en})]}),r&&!he&&i.jsxs(x.Fragment,{children:[Ya&&i.jsxs("div",{className:"follow-up-question-container",children:[i.jsx("p",{className:"question-text",children:Ya}),Za.length>0&&i.jsx("div",{className:"options-grid",children:Za.map((h,g)=>i.jsx("button",{onClick:()=>Xl(h),className:"option-button",children:h},g))})]}),Pa&&i.jsx("div",{className:"speech-error-display",children:Pa}),Da&&i.jsx("div",{className:"selected-file-display",children:i.jsx("span",{children:"Uploading image..."})}),Gr&&!Da&&i.jsxs("div",{className:"selected-file-display",children:[i.jsxs("span",{children:["Selected: ",Gr.name]}),i.jsx("button",{onClick:()=>{Aa(null),tr.current&&(tr.current.value="")},className:"remove-file-button",title:"Remove image",children:"×"})]}),i.jsxs("div",{className:"input-section-selector",children:[i.jsx("button",{onClick:()=>$n("response"),className:`selector-button ${In==="response"?"active":""}`,children:"AI"}),i.jsx("button",{onClick:()=>$n("meds"),className:`selector-button ${In==="meds"?"active":""}`,children:"Meds"}),i.jsx("button",{onClick:()=>$n("labs"),className:`selector-button ${In==="labs"?"active":""}`,children:"Labs"}),i.jsx("button",{onClick:()=>$n("history"),className:`selector-button ${In==="history"?"active":""}`,children:"Hx"}),i.jsx("button",{onClick:()=>$n("summary"),className:`selector-button ${In==="summary"?"active":""}`,children:"Sum"})]}),i.jsx("div",{className:"input-wrapper",children:i.jsxs("div",{className:"main-input-container",children:[i.jsx("input",{type:"file",ref:tr,onChange:cc,accept:"image/*",className:"hidden"}),i.jsx("textarea",{ref:Je,className:"complaint-textarea",value:c,onChange:h=>u(h.target.value),onKeyDown:ec,placeholder:"Name, Age, Sex... Chat with Patient Manager AI",disabled:It||!r||jn}),i.jsxs("div",{className:"chat-input-actions-container",children:[i.jsx("button",{type:"button",onClick:lc,disabled:It||!r||jn,className:"icon-button",title:"Attach Image",children:i.jsx(Ac,{size:14})}),i.jsx("button",{type:"button",onClick:oc,disabled:It||!r||!er.current,className:`mic-button ${jn?"listening":""}`,title:jn?"Stop":"Mic",children:i.jsx(Dc,{size:14})}),i.jsx("button",{onClick:()=>Vt(),disabled:It||!c.trim()||!r||jn,className:"send-button",title:It?"Processing...":"Save & Ask AI",children:It?i.jsx("div",{className:"custom-loader-circle",role:"status","aria-label":"loading"}):i.jsx(Ic,{size:14})}),Dl&&i.jsx("button",{type:"button",onClick:Il,disabled:It,className:"icon-button text-red-500",title:"Undo Last AI Actions",children:i.jsx(yt,{size:14})})]})]})})]})]}),ma&&d&&i.jsx(Mg,{isOpen:ma,onClose:()=>Qn(!1),onSuccess:()=>{d&&En(d),Qn(!1),kn([])},patientId:d,initialItems:ga}),fa&&Er&&i.jsx(Hg,{isOpen:fa,onClose:()=>Pr(!1),onSuccess:()=>{d&&En(d),Pr(!1),Gn(void 0)},medication:Er}),pa&&i.jsx($c,{isOpen:pa,onClose:()=>{ha(!1),Gn(void 0),kn([])},onSuccess:()=>{d&&En(d),ha(!1),Gn(void 0),kn([])},initialItems:ga,medication:Er,initialPatient:p?{id:p.id,name:p.name,phone:p.phone||"",patient_token_number:String(p.patient_token_number||"")}:void 0})]})};export{Kg as default};
