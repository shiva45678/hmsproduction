import{y as de,f as b,p as ce,j as e,S as f,E as ue}from"./index-DCOSVs-d.js";import{r as i,b as me}from"./react-vendor-Cc0P4_ZX.js";/* empty css                           */import{M as pe}from"./ManageCustomColumnsModal-C5F-05W9.js";import{ai as he,$ as be,az as xe}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const Te=({isEmbedded:_=!1})=>{const{customColumnsConfig:A,refetch:Z}=de(),V=A.lab_tests||[],[ee,$]=i.useState(!1),[k,M]=i.useState(!1),[v,te]=i.useState([]),[x,ae]=i.useState(""),[D,y]=i.useState(!1),[I,m]=i.useState(null),[C,R]=i.useState(!1),[F,j]=i.useState(null),z=i.useRef(null),[L,B]=i.useState(!1),[P,T]=i.useState(null),[O,U]=i.useState(!1),[q,S]=i.useState(!1),[E,N]=i.useState(null),[c,p]=i.useState({name:"",description:"",price:"",default_parameters:[]}),h=i.useCallback(async()=>{y(!0),m(null),j(null),T(null);try{const t=await b("/api/lab-tests");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=await t.json();te(n)}catch(t){console.error("Error fetching lab tests:",t),m(t.message||"Failed to fetch lab tests.")}finally{y(!1)}},[]);i.useEffect(()=>{h()},[h]);const g=t=>{const{name:n,value:l}=t.target;p(r=>({...r,[n]:l}))},d=(t,n,l)=>{const r=[...c.default_parameters],a=r[t];if(n==="type")switch(a.type=l,l){case"number":a.defaultValue=0,a.lower_limit=null,a.upper_limit=null,a.unit="";break;case"boolean":a.defaultValue=!1,a.lower_limit=void 0,a.upper_limit=void 0,a.unit=void 0;break;case"string":default:a.defaultValue="",a.lower_limit=void 0,a.upper_limit=void 0,a.unit=void 0;break}else n==="defaultValue"?a.type==="number"?a.defaultValue=parseFloat(l)||0:(a.type,a.defaultValue=l):n==="lower_limit"||n==="upper_limit"?a[n]=l===""?null:parseFloat(l):a[n]=l;p(o=>({...o,default_parameters:r}))},H=()=>{p(t=>({...t,default_parameters:[...t.default_parameters,{name:"",type:"string",defaultValue:"",unit:"",lower_limit:null,upper_limit:null}]}))},W=t=>{p(n=>({...n,default_parameters:n.default_parameters.filter((l,r)=>r!==t)}))},G=async t=>{t.preventDefault(),y(!0),m(null);const n=E!==null,l=n?`/api/lab-tests/${E}`:"/api/lab-tests",r=n?"PUT":"POST";try{const a=await b(l,{method:r,headers:{"Content-Type":"application/json"},body:JSON.stringify({name:c.name,description:c.description,price:parseFloat(c.price),default_parameters:c.default_parameters})});if(!a.ok){const o=await a.json();throw new Error(o.message||`HTTP error! status: ${a.status}`)}S(!1),N(null),p({name:"",description:"",price:"",default_parameters:[]}),h()}catch(a){console.error(`Error ${n?"updating":"adding"} lab test:`,a),m(a.message||`Failed to ${n?"update":"add"} lab test.`)}finally{y(!1)}},ne=()=>{N(null),p({name:"",description:"",price:"",default_parameters:[]}),S(!0)},J=t=>{if(E===t.id)N(null);else{N(t.id);const n=(t.default_parameters||[]).map(l=>({...l,unit:l.unit||"",lower_limit:l.lower_limit===void 0?null:l.lower_limit,upper_limit:l.upper_limit===void 0?null:l.upper_limit}));p({name:t.name,description:t.description||"",price:t.price,default_parameters:n}),S(!1)}},le=async t=>{if(window.confirm("Are you sure you want to delete this lab test?")){y(!0),m(null);try{const n=await b(`/api/lab-tests/${t}`,{method:"DELETE"});if(!n.ok){const l=await n.json();throw new Error(l.message||`HTTP error! status: ${n.status}`)}h()}catch(n){console.error("Error deleting lab test:",n),m(n.message||"Failed to delete lab test.")}finally{y(!1)}}},Y=()=>{S(!1),N(null),m(null),p({name:"",description:"",price:"",default_parameters:[]})},se=async t=>{if(!t){j("No file selected.");return}R(!0),j(null),m(null);const n=new FormData;n.append("file",t);try{const l=await b("/api/lab-tests/import",{method:"POST",body:n});if(!l.ok){const r=await l.json();throw new Error(r.message||`Import failed: ${l.statusText}`)}h()}catch(l){console.error("Error importing lab tests from Excel:",l),j(l.message||"Failed to import lab tests from Excel.")}finally{R(!1)}},re=async t=>{if(t.target.files&&t.target.files[0]){const n=t.target.files[0];await se(n),t.target&&(t.target.value="")}},ie=async()=>{if(window.confirm("Are you sure you want to import default biochemistry and pathology tests? This will add new tests and may duplicate existing ones if names match.")){B(!0),T(null),m(null);try{const t=await b("/api/lab-tests/import-defaults",{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok){const n=await t.json();throw new Error(n.message||`Default import failed: ${t.statusText}`)}h()}catch(t){console.error("Error importing default lab tests:",t),T(t.message||"Failed to import default lab tests.")}finally{B(!1)}}},oe=async()=>{if(window.confirm("Are you sure you want to delete ALL lab tests? This action cannot be undone.")){U(!0),m(null),j(null),T(null);try{const t=await b("/api/lab-tests/all",{method:"DELETE"});if(!t.ok){const n=await t.json();throw new Error(n.message||`Delete all failed: ${t.statusText}`)}h()}catch(t){console.error("Error deleting all lab tests:",t),m(t.message||"Failed to delete all lab tests.")}finally{U(!1)}}},s=D||C||L||O,K=i.useMemo(()=>new ce(v,{keys:["name","description","default_parameters.name"],threshold:.3,ignoreLocation:!0}),[v]),w=i.useMemo(()=>x?K.search(x).map(t=>t.item):v,[v,x,K]);return e.jsxs("div",{className:`lab-inventory-card ${_?"embedded":""}`,style:_?{border:"none",boxShadow:"none",padding:0}:{},children:[!_&&e.jsx("h2",{className:"lab-inventory-header",children:"Available Lab Tests"}),e.jsx("div",{className:"mb-4",style:{display:"flex",alignItems:"center",marginBottom:"15px"},children:e.jsx("input",{type:"text",placeholder:"Search by test name...",value:x,onChange:t=>ae(t.target.value),className:"lab-inventory-input",style:{maxWidth:"300px",marginRight:"10px"}})}),e.jsxs("div",{className:"mb-4",style:{display:"flex",gap:"10px"},children:[e.jsx("button",{onClick:ne,className:"lab-inventory-button",disabled:s,children:"Add New Test"}),e.jsx("button",{onClick:()=>{var t;return(t=z.current)==null?void 0:t.click()},className:"lab-inventory-button lab-inventory-button-secondary",disabled:s,children:C?"Importing...":"Import from Excel"}),e.jsx("input",{type:"file",ref:z,onChange:re,accept:".xlsx, .xls",style:{display:"none"},disabled:C}),e.jsx("button",{onClick:ie,className:"lab-inventory-button lab-inventory-button-secondary",disabled:s,children:L?"Importing Defaults...":"Import Default Tests"}),e.jsx("button",{onClick:oe,className:"lab-inventory-button lab-inventory-button-danger",disabled:s,style:{backgroundColor:"#dc3545",borderColor:"#dc3545",color:"white"},children:O?"Deleting All...":"Delete All Tests"}),e.jsxs("button",{onClick:()=>$(!0),className:"lab-inventory-button lab-inventory-button-secondary",disabled:s,title:"Manage Custom Columns",children:[e.jsx(he,{size:16,style:{marginRight:"4px"}})," Columns"]}),e.jsxs("div",{className:"view-mode-toggle",style:{marginLeft:"auto"},children:[e.jsxs("button",{onClick:()=>M(!1),className:`view-mode-btn ${k?"":"active"}`,title:"List View",children:[e.jsx(be,{size:18})," List"]}),e.jsxs("button",{onClick:()=>M(!0),className:`view-mode-btn ${k?"active":""}`,title:"Excel Mode (Edit)",children:[e.jsx(xe,{size:18})," Excel"]})]})]}),I&&e.jsx("div",{className:"error-text mb-4",children:I}),F&&e.jsxs("div",{className:"error-text mb-4",children:["Import Excel Error: ",F]}),P&&e.jsxs("div",{className:"error-text mb-4",children:["Import Default Error: ",P]}),q&&e.jsxs("div",{className:"lab-inventory-card",style:{marginTop:"20px",marginBottom:"20px"},children:[" ",e.jsx("h3",{className:"lab-inventory-header",style:{fontSize:"1.5em",borderBottom:"1px solid #eee",marginBottom:"15px"},children:"Add New Lab Test"}),e.jsxs("form",{onSubmit:G,children:[e.jsxs("div",{className:"lab-inventory-form-group",children:[e.jsxs("label",{htmlFor:"name",children:["Test Name ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx("input",{type:"text",id:"name",name:"name",value:c.name,onChange:g,className:"lab-inventory-input",required:!0,disabled:s})]}),e.jsxs("div",{className:"lab-inventory-form-group",children:[e.jsx("label",{htmlFor:"description",children:"Description"}),e.jsx("textarea",{id:"description",name:"description",value:c.description,onChange:g,rows:3,className:"lab-inventory-input",disabled:s})]}),e.jsxs("div",{className:"lab-inventory-form-group",children:[e.jsxs("label",{htmlFor:"price",children:["Price ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx("input",{type:"number",id:"price",name:"price",value:c.price,onChange:g,min:"0",step:"0.01",className:"lab-inventory-input",required:!0,disabled:s})]}),e.jsxs("div",{className:"lab-inventory-form-group",children:[e.jsx("h4",{className:"lab-inventory-header",style:{fontSize:"1.2em",marginTop:"20px",marginBottom:"10px"},children:"Default Parameters"}),c.default_parameters.map((t,n)=>{var l,r;return e.jsxs("div",{className:"parameter-item",style:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr 1fr 1fr auto",gap:"10px",alignItems:"center",marginBottom:"10px"},children:[e.jsx("input",{type:"text",placeholder:"Parameter Name",value:t.name,onChange:a=>d(n,"name",a.target.value),className:"lab-inventory-input"}),e.jsxs("select",{value:t.type,onChange:a=>d(n,"type",a.target.value),className:"lab-inventory-input",children:[e.jsx("option",{value:"string",children:"Text"}),e.jsx("option",{value:"number",children:"Number"}),e.jsx("option",{value:"boolean",children:"Yes/No"})]}),t.type==="boolean"?e.jsxs("select",{value:t.defaultValue.toString(),onChange:a=>d(n,"defaultValue",a.target.value==="true"),className:"lab-inventory-input",children:[e.jsx("option",{value:"true",children:"Reactive"}),e.jsx("option",{value:"false",children:"Non-reactive"})]}):e.jsx("input",{type:t.type==="number"?"number":"text",placeholder:"Default Value",value:t.defaultValue.toString(),onChange:a=>d(n,"defaultValue",a.target.value),className:"lab-inventory-input"}),t.type==="number"&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"number",placeholder:"Lower Limit",value:t.lower_limit===null?"":((l=t.lower_limit)==null?void 0:l.toString())??"",onChange:a=>d(n,"lower_limit",a.target.value),className:"lab-inventory-input"}),e.jsx("input",{type:"number",placeholder:"Upper Limit",value:t.upper_limit===null?"":((r=t.upper_limit)==null?void 0:r.toString())??"",onChange:a=>d(n,"upper_limit",a.target.value),className:"lab-inventory-input"}),e.jsx("input",{type:"text",placeholder:"Unit (e.g., mg/dL)",value:t.unit||"",onChange:a=>d(n,"unit",a.target.value),className:"lab-inventory-input"})]}),e.jsx("button",{type:"button",onClick:()=>W(n),className:"lab-inventory-button lab-inventory-button-danger",children:"Remove"})]},n)}),e.jsx("button",{type:"button",onClick:H,className:"lab-inventory-button lab-inventory-button-secondary",style:{marginTop:"10px"},children:"Add Parameter"})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"10px",marginTop:"20px"},children:[e.jsx("button",{type:"button",onClick:Y,className:"lab-inventory-button lab-inventory-button-secondary",disabled:s,children:"Cancel"}),e.jsx("button",{type:"submit",className:"lab-inventory-button",disabled:s,children:D?"Saving...":"Add Test"})]})]})]}),s&&!q?e.jsxs("div",{className:"overflow-x-auto",children:[e.jsx("div",{className:"mb-4 flex gap-2",children:[1,2,3,4,5].map(t=>e.jsx(f,{width:100,height:36},t))}),e.jsxs("table",{className:"lab-inventory-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{className:"hidden md:table-cell",children:"Description"}),e.jsx("th",{children:"Price"}),e.jsx("th",{style:{textAlign:"right"},children:"Actions"})]})}),e.jsx("tbody",{children:[1,2,3,4,5].map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(f,{width:"60%",height:20})}),e.jsx("td",{className:"hidden md:table-cell",children:e.jsx(f,{width:"90%",height:20})}),e.jsx("td",{children:e.jsx(f,{width:80,height:20})}),e.jsx("td",{style:{textAlign:"right"},children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(f,{width:40,height:20}),e.jsx(f,{width:50,height:20})]})})]},t))})]}),e.jsx("p",{className:"loading-text mt-2 text-sm italic text-gray-500",children:C?"Importing Excel data...":L?"Importing default data...":"Loading tests..."})]}):null,!s&&w.length===0&&!I&&!F&&!P&&e.jsx("p",{className:"no-data-message",children:x?`No lab tests found matching "${x}".`:"No lab tests found. Add one or import from Excel to get started."}),k&&w.length>0?e.jsx(ue,{columns:[{key:"name",label:"Test Name",editable:!0,type:"text"},{key:"description",label:"Description",editable:!0,type:"text"},{key:"price",label:"Price",editable:!0,type:"number"}],data:w,editable:!0,showRowNumbers:!0,title:"Lab Test Inventory",onSave:async t=>{const n=t.map(async l=>{const r=v.find(a=>a.id===l.id);if(r&&(r.name!==l.name||r.price!==l.price||r.description!==l.description))return b(`/api/lab-tests/${l.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})});try{await Promise.all(n),alert("Changes saved successfully"),h()}catch(l){alert("Error saving changes"),console.error(l)}}}):!s&&w.length>0&&e.jsxs("div",{className:"overflow-x-auto",children:[" ",e.jsxs("table",{className:"lab-inventory-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{className:"hidden md:table-cell",children:"Description"})," ",e.jsx("th",{children:"Price"}),e.jsx("th",{style:{textAlign:"right"},children:"Actions"})]})}),e.jsx("tbody",{children:w.map(t=>{const n=E===t.id,l=t.price&&typeof t.price=="string"?parseFloat(t.price):NaN,r=isNaN(l)?"0.00":l.toFixed(2);return e.jsxs(me.Fragment,{children:[e.jsxs("tr",{onClick:()=>J(t),style:{cursor:"pointer"},children:[e.jsx("td",{children:t.name}),e.jsx("td",{className:"hidden md:table-cell",style:{whiteSpace:"pre-wrap"},children:t.description||"-"}),e.jsxs("td",{children:["â‚¹",r]}),e.jsx("td",{style:{textAlign:"right"},children:e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"10px"},children:[e.jsx("button",{onClick:a=>{a.stopPropagation(),J(t)},className:"lab-inventory-link",disabled:s,style:{background:"none",border:"none",padding:"0",cursor:"pointer"},children:"Edit"}),e.jsx("button",{onClick:a=>{a.stopPropagation(),le(t.id)},className:"lab-inventory-link",disabled:s,style:{background:"none",border:"none",padding:"0",cursor:"pointer",color:"#dc3545"},children:"Delete"})]})})]}),V.length>0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,style:{padding:"0 15px 15px 15px",borderTop:"none"},children:e.jsx("div",{style:{padding:"10px",backgroundColor:"#f9f9f9",borderRadius:"4px",display:"flex",flexWrap:"wrap",gap:"15px"},children:V.map(a=>{var o;return e.jsxs("div",{style:{fontSize:"0.9em"},children:[e.jsxs("strong",{style:{color:"#555"},children:[a.label,":"]})," ",(o=t.custom_fields)!=null&&o[a.key]?String(t.custom_fields[a.key]):"-"]},a.key)})})})}),n&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,children:e.jsxs("div",{className:"lab-inventory-card",style:{marginTop:"10px",marginBottom:"10px",border:"1px solid #ddd",padding:"15px"},children:[e.jsx("h3",{className:"lab-inventory-header",style:{fontSize:"1.2em"},children:"Edit Lab Test"}),e.jsxs("form",{onSubmit:G,children:[e.jsxs("div",{className:"lab-inventory-form-group",children:[e.jsxs("label",{htmlFor:"name",children:["Test Name ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx("input",{type:"text",id:"name",name:"name",value:c.name,onChange:g,className:"lab-inventory-input",required:!0,disabled:s})]}),e.jsxs("div",{className:"lab-inventory-form-group",children:[e.jsx("label",{htmlFor:"description",children:"Description"}),e.jsx("textarea",{id:"description",name:"description",value:c.description,onChange:g,rows:3,className:"lab-inventory-input",disabled:s})]}),e.jsxs("div",{className:"lab-inventory-form-group",children:[e.jsxs("label",{htmlFor:"price",children:["Price ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx("input",{type:"number",id:"price",name:"price",value:c.price,onChange:g,min:"0",step:"0.01",className:"lab-inventory-input",required:!0,disabled:s})]}),e.jsxs("div",{className:"lab-inventory-form-group",children:[e.jsx("h4",{className:"lab-inventory-header",style:{fontSize:"1.1em",marginTop:"15px"},children:"Default Parameters"}),c.default_parameters.map((a,o)=>{var Q,X;return e.jsxs("div",{className:"parameter-item",style:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr 1fr 1fr auto",gap:"10px",alignItems:"center",marginBottom:"10px"},children:[e.jsx("input",{type:"text",placeholder:"Parameter Name",value:a.name,onChange:u=>d(o,"name",u.target.value),className:"lab-inventory-input"}),e.jsxs("select",{value:a.type,onChange:u=>d(o,"type",u.target.value),className:"lab-inventory-input",children:[e.jsx("option",{value:"string",children:"Text"}),e.jsx("option",{value:"number",children:"Number"}),e.jsx("option",{value:"boolean",children:"Yes/No"})]}),a.type==="boolean"?e.jsxs("select",{value:a.defaultValue.toString(),onChange:u=>d(o,"defaultValue",u.target.value==="true"),className:"lab-inventory-input",children:[e.jsx("option",{value:"true",children:"Reactive"}),e.jsx("option",{value:"false",children:"Non-reactive"})]}):e.jsx("input",{type:a.type==="number"?"number":"text",placeholder:"Default Value",value:a.defaultValue.toString(),onChange:u=>d(o,"defaultValue",u.target.value),className:"lab-inventory-input"}),a.type==="number"&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"number",placeholder:"Lower Limit",value:a.lower_limit===null?"":((Q=a.lower_limit)==null?void 0:Q.toString())??"",onChange:u=>d(o,"lower_limit",u.target.value),className:"lab-inventory-input"}),e.jsx("input",{type:"number",placeholder:"Upper Limit",value:a.upper_limit===null?"":((X=a.upper_limit)==null?void 0:X.toString())??"",onChange:u=>d(o,"upper_limit",u.target.value),className:"lab-inventory-input"}),e.jsx("input",{type:"text",placeholder:"Unit (e.g., mg/dL)",value:a.unit||"",onChange:u=>d(o,"unit",u.target.value),className:"lab-inventory-input"})]}),e.jsx("button",{type:"button",onClick:()=>W(o),className:"lab-inventory-button lab-inventory-button-danger",children:"Remove"})]},o)}),e.jsx("button",{type:"button",onClick:H,className:"lab-inventory-button lab-inventory-button-secondary",style:{marginTop:"10px"},children:"Add Parameter"})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"10px",marginTop:"20px"},children:[e.jsx("button",{type:"button",onClick:Y,className:"lab-inventory-button lab-inventory-button-secondary",disabled:s,children:"Cancel"}),e.jsx("button",{type:"submit",className:"lab-inventory-button",disabled:s,children:D?"Saving...":"Update Test"})]})]})]})})})]},t.id)})})]})]}),e.jsx(pe,{isOpen:ee,onClose:()=>$(!1),entityType:"lab_tests",entityLabel:"Lab Tests",currentConfig:A,onConfigUpdated:()=>{Z()}})]})};export{Te as default};
