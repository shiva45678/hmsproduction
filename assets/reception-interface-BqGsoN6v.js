var I=a=>{throw TypeError(a)};var M=(a,s,i)=>s.has(a)||I("Cannot "+i);var o=(a,s,i)=>(M(a,s,"read from private field"),i?i.call(a):s.get(a)),T=(a,s,i)=>s.has(a)?I("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(a):s.set(a,i),Q=(a,s,i,r)=>(M(a,s,"write to private field"),r?r.call(a,i):s.set(a,i),i),D=(a,s,i)=>(M(a,s,"access private method"),i);import{h as oe,s as ce,i as ee,k as le,n as se,d as B,l as de,m as ue,e as ie,q as k,f as S,j as e,u as he,S as d}from"./index-jGjkutd2.js";import{r as g,u as me,f as pe}from"./react-vendor-Cc0P4_ZX.js";/* empty css                   *//* empty css                   */import xe from"./PatientSearchPage-DCEf-oPF.js";import je from"./ManageAdmissionPage-BMyPg3gn.js";import ge from"./AllPatientsPage-Bwu2RTgB.js";import be from"./CreateCustomBillPage-DGssMJiI.js";import fe from"./CreateLabOrderPage-PffHiOWs.js";import{U as ve,i as R,W as ye,Y as Ne,J as we,Z as Pe}from"./ui-vendor-B5keALZQ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";import"./useAutoFocusSingleInput-6a_v4dYJ.js";import"./ManageCustomColumnsModal-DwhioBvT.js";var w,$,u,P,C,U,z,te,Ce=(te=class extends oe{constructor(s,i){super();T(this,C);T(this,w);T(this,$);T(this,u);T(this,P);Q(this,w,s),this.setOptions(i),this.bindMethods(),D(this,C,U).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(s){var r;const i=this.options;this.options=o(this,w).defaultMutationOptions(s),ce(this.options,i)||o(this,w).getMutationCache().notify({type:"observerOptionsUpdated",mutation:o(this,u),observer:this}),i!=null&&i.mutationKey&&this.options.mutationKey&&ee(i.mutationKey)!==ee(this.options.mutationKey)?this.reset():((r=o(this,u))==null?void 0:r.state.status)==="pending"&&o(this,u).setOptions(this.options)}onUnsubscribe(){var s;this.hasListeners()||(s=o(this,u))==null||s.removeObserver(this)}onMutationUpdate(s){D(this,C,U).call(this),D(this,C,z).call(this,s)}getCurrentResult(){return o(this,$)}reset(){var s;(s=o(this,u))==null||s.removeObserver(this),Q(this,u,void 0),D(this,C,U).call(this),D(this,C,z).call(this)}mutate(s,i){var r;return Q(this,P,i),(r=o(this,u))==null||r.removeObserver(this),Q(this,u,o(this,w).getMutationCache().build(o(this,w),this.options)),o(this,u).addObserver(this),o(this,u).execute(s)}},w=new WeakMap,$=new WeakMap,u=new WeakMap,P=new WeakMap,C=new WeakSet,U=function(){var i;const s=((i=o(this,u))==null?void 0:i.state)??le();Q(this,$,{...s,isPending:s.status==="pending",isSuccess:s.status==="success",isError:s.status==="error",isIdle:s.status==="idle",mutate:this.mutate,reset:this.reset})},z=function(s){se.batch(()=>{var i,r,h,x,q,m,_,K;if(o(this,P)&&this.hasListeners()){const b=o(this,$).variables,A=o(this,$).context,N={client:o(this,w),meta:this.options.meta,mutationKey:this.options.mutationKey};if((s==null?void 0:s.type)==="success"){try{(r=(i=o(this,P)).onSuccess)==null||r.call(i,s.data,b,A,N)}catch(y){Promise.reject(y)}try{(x=(h=o(this,P)).onSettled)==null||x.call(h,s.data,null,b,A,N)}catch(y){Promise.reject(y)}}else if((s==null?void 0:s.type)==="error"){try{(m=(q=o(this,P)).onError)==null||m.call(q,s.error,b,A,N)}catch(y){Promise.reject(y)}try{(K=(_=o(this,P)).onSettled)==null||K.call(_,void 0,s.error,b,A,N)}catch(y){Promise.reject(y)}}}this.listeners.forEach(b=>{b(o(this,$))})})},te);function qe(a,s){const i=B(),[r]=g.useState(()=>new Ce(i,a));g.useEffect(()=>{r.setOptions(a)},[r,a]);const h=g.useSyncExternalStore(g.useCallback(q=>r.subscribe(se.batchCalls(q)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),x=g.useCallback((q,m)=>{r.mutate(q,m).catch(de)},[r]);if(h.error&&ue(r.options.throwOnError,[h.error]))throw h.error;return{...h,mutate:x,mutateAsync:h.mutate}}const Se=async()=>{const a=await S("/api/queue");if(!a.ok)throw new Error("Failed to fetch queue");return a.json()};function $e(){return ie({queryKey:k.queue.today,queryFn:Se,staleTime:30*1e3,refetchInterval:60*1e3})}function ke(){const a=B();return qe({mutationFn:async({queueId:s,status:i,doctorId:r})=>{const h=await S(`/api/queue/${s}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:i,doctorId:r})});if(!h.ok)throw new Error("Failed to update queue status");return h.json()},onSuccess:(s,{queueId:i})=>{a.invalidateQueries({queryKey:k.queue.today}),a.invalidateQueries({queryKey:k.queue.entry(i)})}})}const Ee=async()=>{const a=await S("/api/staff");if(!a.ok)throw new Error("Failed to fetch staff");const s=await a.json();return s.staff||s||[]};function Fe(){return ie({queryKey:[...k.staff.list,"doctors"],queryFn:Ee,staleTime:5*60*1e3,select:a=>a.filter(s=>s.role==="doctor")})}const Ye=({currentUser:a})=>{const[s,i]=g.useState("newtons-ai"),[r,h]=g.useState(""),{data:x=[],isLoading:q}=$e(),{data:m=[],isLoading:_}=Fe(),K=ke(),b=B(),[A,N]=g.useState(null),[y,E]=g.useState(null),L=me(),W=pe(),ae=t=>{t&&(b.prefetchQuery({queryKey:k.patients.context(t),queryFn:async()=>{const n=await S(`/api/patients/${t}/context`);if(!n.ok)throw new Error("Failed to fetch patient context");return n.json()},staleTime:5*60*1e3}),b.prefetchQuery({queryKey:k.patientDebts.balance(t),queryFn:async()=>{const n=await S(`/api/patient-debts/${t}/balance`);return n.ok?n.json():{netDebt:0}},staleTime:1*60*1e3}),b.prefetchQuery({queryKey:k.queue.latest(t),queryFn:async()=>{const n=await S(`/api/queue/patient/${t}/latest`);if(!n.ok)throw new Error("Failed to fetch latest queue status");const c=await n.json();return c!=null&&c._id&&b.prefetchQuery({queryKey:k.queue.entry(c._id),queryFn:async()=>{const p=await S(`/api/queue/doctor/complaint/${c._id}`);if(!p.ok)throw new Error("Failed to fetch complaint record");return p.json()},staleTime:1*60*1e3}),c},staleTime:5e3}))};g.useEffect(()=>{const n=new URLSearchParams(W.search).get("tab");n&&Y.find(p=>p.id===n)&&i(n)},[W.search]),g.useEffect(()=>{N(null)},[s]);const H=g.useCallback(async(t,n)=>{if(console.log(`Attempting to assign doctor ${n} to queue ${t}`),E(null),N(null),!n){console.log("No doctor ID provided, skipping assignment.");return}const c=x.find(l=>l.id===t);if(!c){console.error(`Queue entry ${t} not found in local state.`),E("Queue entry not found.");return}if(c.doctor_id===n){console.log(`Queue ${t} already assigned to doctor ${n}. Skipping.`);return}const p=async l=>{if(!l||!l.id||!l.name){E("Cannot proceed: Patient ID or Name is missing."),console.error("assignAndNavigate called with invalid patientInfo",l);return}const F=async()=>{try{await K.mutateAsync({queueId:t,status:"waiting",doctorId:n});const f=m.find(O=>O.id===n);return console.log(`Successfully assigned doctor ${f==null?void 0:f.name} to queue ${t}.`),!0}catch(f){return console.error(`Error assigning doctor for queue ${t}:`,f),E(`Failed to assign doctor: ${f.message}`),!1}};l.subscription_status==="active"?(console.log(`Patient ${l.name} (ID: ${l.id}) has active subscription. Assigning doctor directly.`),await F()):(console.log(`Patient ${l.name} (ID: ${l.id}) does not have active subscription. Navigating to billing WITHOUT assigning doctor yet.`),L(`/dashboard/doctor-billing/${t}?doctorId=${n}`))},j=c.Patient;if(j&&j.id&&j.name)console.log("Patient details found in state. Proceeding with assignment."),await p(j);else{console.warn(`Patient details missing for queue entry ${t}. Fetching patient ${c.patient_id}...`);try{const l=await S(`/api/patients/${c.patient_id}`);if(!l.ok){const f=await l.json().catch(()=>({}));throw new Error(f.message||`Failed to fetch patient details (status ${l.status})`)}const F=await l.json();console.log("Successfully fetched patient details:",F),await p(F)}catch(l){console.error(`Failed to fetch patient details for patient ID ${c.patient_id}:`,l),E(`Failed to fetch required patient details: ${l.message}`)}}},[m,x,L]),J=async(t,n)=>{var p;E(null);const c=n==="consulting"?"start consultation":"complete visit";try{await K.mutateAsync({queueId:t,status:n,doctorId:n==="consulting"&&((p=x.find(j=>j.id===t))==null?void 0:p.doctor_id)||void 0})}catch(j){console.error(`Error trying to ${c}:`,j),E(`Failed to ${c}: ${j.message}`)}},Y=[{id:"queue",label:"Queue",icon:e.jsx(ve,{size:20})},{id:"newtons-ai",label:"Newtons AI",icon:e.jsx(R,{size:20})},{id:"manage-admission",label:"Manage Admission",icon:e.jsx(ye,{size:20})},{id:"all-patients",label:"All Patients",icon:e.jsx(Ne,{size:20})},{id:"lab",label:"Lab Tests",icon:e.jsx(we,{size:20})},{id:"custom-bill",label:"Custom Bill",icon:e.jsx(Pe,{size:20})}],ne=t=>{try{return new Date(t).toLocaleTimeString("en-IN",{hour:"numeric",minute:"2-digit",hour12:!0})}catch{return"Invalid Date"}},Z=x.filter(t=>{var n,c;return(c=(n=t.Patient)==null?void 0:n.name)==null?void 0:c.toLowerCase().includes(r.toLowerCase())}),{openCommandBar:re}=he();return e.jsxs("div",{className:"admin-panel-container",children:[y&&e.jsxs("div",{className:"error-message-reception",role:"alert",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:y})]}),e.jsx("div",{className:"admin-nav-bar",children:Y.map(t=>e.jsxs("button",{className:`admin-nav-button ${s===t.id?"active":""}`,onClick:()=>{t.id==="newtons-ai"?re():i(t.id)},children:[e.jsx("span",{children:t.icon}),t.label]},t.id))}),e.jsx("div",{className:"admin-content-section",children:e.jsxs("main",{className:"flex-1 overflow-y-auto",style:{padding:"15px"},children:[s==="queue"&&e.jsxs("div",{className:"space-y-6",children:[" ",e.jsxs("div",{className:"queue-header",children:[" ",e.jsxs("div",{className:"queue-actions",children:[" ",e.jsxs("div",{className:"search-bar-container",children:[" ",e.jsx("input",{type:"text",placeholder:"Search patients in queue...",className:"search-input",value:r,onChange:t=>h(t.target.value)}),e.jsx(R,{className:"search-icon",size:18})]})]}),e.jsxs("div",{className:"summary-cards-grid",children:[" ",e.jsxs("div",{className:"summary-card card-waiting",children:[" ",e.jsx("div",{className:"summary-card-title",children:"Waiting"})," ",e.jsx("div",{className:"summary-card-value",children:x.filter(t=>t.status==="waiting").length})," "]}),e.jsxs("div",{className:"summary-card card-consulting",children:[" ",e.jsx("div",{className:"summary-card-title",children:"Consulting"})," ",e.jsx("div",{className:"summary-card-value",children:x.filter(t=>t.status==="consulting").length})," "]}),e.jsxs("div",{className:"summary-card card-completed",children:[" ",e.jsx("div",{className:"summary-card-title",children:"Completed"})," ",e.jsx("div",{className:"summary-card-value",children:x.filter(t=>t.status==="seen").length})," "]})]})]}),q?e.jsx("div",{className:"queue-table-wrapper",children:e.jsxs("table",{className:"queue-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx(d,{width:50,height:20})}),e.jsx("th",{children:e.jsx(d,{width:100,height:20})}),e.jsx("th",{children:e.jsx(d,{width:100,height:20})}),e.jsx("th",{children:e.jsx(d,{width:150,height:20})}),e.jsx("th",{children:e.jsx(d,{width:100,height:20})}),e.jsx("th",{className:"hidden md:table-cell",children:e.jsx(d,{width:80,height:20})}),e.jsx("th",{children:e.jsx(d,{width:120,height:20})})]})}),e.jsx("tbody",{children:[1,2,3,4,5].map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(d,{width:40,height:20})}),e.jsx("td",{children:e.jsx(d,{width:120,height:20})}),e.jsx("td",{children:e.jsx(d,{width:100,height:20})}),e.jsx("td",{children:e.jsx(d,{width:150,height:20})}),e.jsx("td",{children:e.jsx(d,{width:100,height:24,style:{borderRadius:"12px"}})}),e.jsx("td",{className:"hidden md:table-cell",children:e.jsx(d,{width:60,height:20})}),e.jsx("td",{children:e.jsx(d,{width:120,height:32})})]},t))})]})}):Z.length===0?e.jsx("div",{className:"empty-queue-message",children:r?"No patients found matching your search.":"Queue is empty."}):e.jsxs("div",{className:"queue-table-wrapper",children:[" ",e.jsxs("table",{className:"queue-table",children:[" ",e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Queue"}),e.jsx("th",{children:"Patient"}),e.jsx("th",{children:"Phone Number"}),e.jsx("th",{children:"Complaint"}),e.jsx("th",{children:"Subscription Status"}),e.jsx("th",{className:"hidden md:table-cell",children:"Time Added"})," ",e.jsx("th",{className:"text-center",children:"Action / Doctor"})," "]})}),e.jsx("tbody",{children:Z.map(t=>{var n,c,p,j,l,F,f,O,G,V,X;return e.jsxs("tr",{onClick:()=>L(`/dashboard/edit-complaint/${t.id}`),onMouseEnter:()=>t.patient_id&&ae(t.patient_id),className:"queue-row-clickable",children:[e.jsxs("td",{children:[" ",e.jsxs("span",{className:"queue-token",children:["#",t.token_no]})," "]}),e.jsxs("td",{children:[" ",e.jsx("div",{className:"patient-name",children:((n=t.Patient)==null?void 0:n.name)||"N/A"})," ",e.jsxs("div",{className:"patient-details",children:[(c=t.Patient)!=null&&c.age?`${t.Patient.age} yrs, `:"",((p=t.Patient)==null?void 0:p.gender)||""]})," "]}),e.jsxs("td",{children:[" ",e.jsx("div",{className:"patient-phone",children:((j=t.Patient)==null?void 0:j.phone)||"N/A"})," "]}),e.jsx("td",{className:"complaint-text",children:t.complaint||"-"}),e.jsxs("td",{children:[e.jsx("span",{className:`subscription-status-badge ${((l=t.Patient)==null?void 0:l.subscription_status)==="active"?"status-active":((F=t.Patient)==null?void 0:F.subscription_status)==="cancelled"||((f=t.Patient)==null?void 0:f.subscription_status)==="expired"?"status-inactive":"status-none"}`,children:((O=t.Patient)==null?void 0:O.subscription_status)??"None"}),t.Patient&&t.Patient.id&&t.Patient.subscription_status!=="active"&&e.jsx("button",{onClick:v=>{v.stopPropagation(),t.Patient&&L(`/start-subscription/${t.Patient.id}`)},className:"action-button btn-start-sub-queue mt-2",children:"Start Sub"})]}),e.jsx("td",{className:"hidden md:table-cell time-added",children:ne(t.created_at)}),e.jsx("td",{className:"action-doctor-cell",children:A===t.id?e.jsx("div",{className:"relative inline-block text-left w-full",onClick:v=>v.stopPropagation(),children:e.jsxs("select",{value:"",onChange:v=>H(t.id,v.target.value),onBlur:()=>N(null),className:"doctor-select-dropdown",autoFocus:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select Doctor..."}),_?e.jsx("option",{disabled:!0,children:"Loading..."}):m.length>0?m.map(v=>e.jsx("option",{value:v.id,children:v.name},v.id)):e.jsx("option",{disabled:!0,children:"No doctors available"})]})}):e.jsxs("div",{className:"action-doctor-content",onClick:v=>v.stopPropagation(),children:[" ",t.status==="waiting"&&e.jsx(e.Fragment,{children:(G=t.User)!=null&&G.name?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"doctor-name-display",children:t.User.name}),e.jsx("button",{onClick:()=>J(t.id,"consulting"),className:"action-button btn-start",children:"Start"})]}):_?e.jsx(d,{width:80,height:20}):m.length===0?e.jsx("span",{className:"status-text-red",children:"No doctors"}):m.length===1?e.jsxs("button",{onClick:()=>H(t.id,m[0].id),className:"action-button btn-assign",children:["Assign ",m[0].name]}):e.jsx("button",{onClick:()=>N(t.id),className:"action-button btn-assign",children:"Assign"})}),t.status==="consulting"&&e.jsxs(e.Fragment,{children:[((V=t.User)==null?void 0:V.name)&&e.jsx("span",{className:"doctor-name-display",children:t.User.name}),e.jsx("button",{onClick:()=>J(t.id,"seen"),className:"action-button btn-complete",children:"Complete"})]}),t.status==="seen"&&e.jsxs(e.Fragment,{children:[((X=t.User)==null?void 0:X.name)&&e.jsx("span",{className:"doctor-name-display",children:t.User.name}),e.jsx("span",{className:"status-text-italic",children:"Completed"})]}),t.status==="cancelled"&&e.jsx("span",{className:"status-text-red",children:"Cancelled"})]})})]},t.id)})})]})]})]}),s==="lab"&&e.jsxs("div",{className:"lab-tab-content",children:[" ",e.jsx(fe,{currentUser:a}),e.jsxs("button",{onClick:()=>L("/lab/search-report"),className:"lab-action-button btn-search-lab-reports",children:[e.jsx(R,{size:16}),"Search Lab Reports"]})]}),s==="newtons-ai"&&e.jsx("div",{className:"newtons-ai-tab-content",children:e.jsx(xe,{})}),s==="manage-admission"&&e.jsx("div",{className:"manage-admission-tab-content",children:e.jsx(je,{})}),s==="all-patients"&&e.jsx("div",{className:"all-patients-tab-content",children:e.jsx(ge,{})}),s==="custom-bill"&&e.jsx("div",{className:"custom-bill-tab-content",children:e.jsx(be,{})})]})})," "]})};export{Ye as default};
