import{j as e,S as t,f as j}from"./index-DE8wu5Ou.js";import{u as pe,f as ue,r as c}from"./react-vendor-Cc0P4_ZX.js";import{Q as W}from"./index-CZ6CIOFr.js";/* empty css                            */import{a7 as H,af as Y,u as X,W as je,s as me}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const ge=m=>{if(!m)return 1;const b=m.match(/(?:\d+x)?(\d+)/);return b&&b[1]?parseInt(b[1],10):1},De=()=>{const m=pe(),b=ue(),[i,L]=c.useState(null),[d,C]=c.useState([]),[K,k]=c.useState(!0),[O,N]=c.useState(null),[v,$]=c.useState(!1),[g,Z]=c.useState("cash"),[w,q]=c.useState(""),[F,ee]=c.useState(""),[z,se]=c.useState(""),[I,ie]=c.useState(""),[B,te]=c.useState(""),[P,U]=c.useState(0),M=c.useRef(!1),[_,A]=c.useState(null),[ae,Q]=c.useState(!1),ne=s=>{const r=Math.max(0,Math.min(100,isNaN(s)?0:s));M.current=!0,U(r);const o=d.map(a=>({...a,discount_percentage:r}));C(o)},re=(s,r)=>{const o=[...d];o[s].discount_percentage=isNaN(r)?0:r,C(o)};c.useEffect(()=>{if(M.current){M.current=!1;return}const s=d.reduce((a,x)=>a+(x.total_price??0),0);if(s===0){U(0);return}const o=d.reduce((a,x)=>{const u=(x.total_price??0)*((x.discount_percentage??0)/100);return a+u},0)/s*100;U(a=>Math.abs(a-o)>.01?o:a)},[d]);const le=async()=>{if(!i)return N("No order data available to bill."),null;if(d.length===0)return N("Cannot bill an empty order."),null;$(!0),N(null);try{const s=d.map(n=>{const u=(n.pricePerLooseUnit??0)*(n.looseQuantity??0),y=u*((n.discount_percentage??0)/100),R=u-y;return{name:n.name,pack_quantity:n.loosePacks??0,loose_quantity:n.looseUnits??0,price:n.originalPrice??0,pack_price:n.originalPrice??0,loose_price:n.pricePerLooseUnit??0,total:R,drug_id:n.drug_id,discount_percentage:n.discount_percentage??0,batch:n.batch,expiry_date:n.expiry_date}}),r={patientId:i.patientId,queueId:i.id,items:s,amount:p,paymentMode:g,type:"pharmacy",related_id:i.id,status:"paid",discountPercentage:P},o=await j("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),a=await o.json();if(!o.ok||!a.id)throw new Error(a.message||"Failed to create bill.");const x=await j(`/api/pharmacy-orders/${i.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:a.id,medications:d})});if(!x.ok){const n=await x.text();throw new Error(`Failed to update pharmacy order status: ${x.statusText} - ${n}`)}if(L(n=>n?{...n,status:"billed",bill_id:a.id}:null),g==="credit")try{await j(`/api/patient-debts/${i.patientId}/debts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction_date:new Date().toISOString().split("T")[0],debt_value:p,related_bill_id:a.id,notes:`Pharmacy Bill #${a.id}`})})}catch(n){console.error("Failed to create debt entry:",n)}return alert(`Order ${i.patientName}'s bill created (ID: ${a.id}) and marked as billed.`),m(`/dashboard/pharmacy-billing/${i.id}`,{replace:!0,state:{order:{...i,status:"billed",bill_id:a.id},initialItems:d}}),a.id}catch(s){return console.error("Billing process failed:",s),N(s.message||"Failed to mark order as billed. Please try again."),null}finally{$(!1)}},ce=async()=>{if(i)try{const s=await j(`/api/pharmacy-orders/${i.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"dispensed",medications:d})});if(!s.ok){const r=await s.text();console.error("Failed to dispense order:",r)}}catch(s){console.error("Error dispensing order:",s)}},de=()=>{window.print()},oe=async()=>{await le()&&(window.print(),await ce(),m(-1))};c.useEffect(()=>{const s=b.pathname.split("/"),r=s[s.length-1];r?(async()=>{try{k(!0);const[a,x,n]=await Promise.all([j(`/api/pharmacy-orders/${r}`),j("/api/drugs").then(l=>l.ok?l.json():null).catch(()=>null),j("/api/clinics/settings").then(l=>l.ok?l.json():null).catch(()=>null)]);if(!a.ok)throw new Error("Failed to fetch pharmacy order details");const u=await a.json();L(u);let y=[];x&&(y=x.drugs||x||[]),n&&(ee(n.upi_id||""),se(n.name||""),ie(n.address||""),te(n.notes||""));const R=u.medications.map(l=>{const E=ge(l.unit),V=(l.pack_quantity??0)*E+(l.loose_quantity??0),h=y.find(J=>l.drug_id&&String(J.id)===String(l.drug_id)||J.name.toLowerCase()===l.name.toLowerCase()),he=l.batch||(h==null?void 0:h.batch)||(h==null?void 0:h.batch_number),xe=l.expiry_date||(h==null?void 0:h.expiry_date),T=Number(l.pack_price)||Number(h==null?void 0:h.mrp)||0,G=Number(h==null?void 0:h.rate)||0;let f=Number(l.loose_price)||0;return f===0&&(T>0&&E>0?f=T/E:G>0&&(f=G)),{...l,isLoose:!0,loosePacks:l.pack_quantity??0,looseUnits:l.loose_quantity??0,looseQuantity:V,pack_price:T,loose_price:f,total_price:Number(l.total_price)||f*V,pricePerLooseUnit:f,originalPrice:T,discount_percentage:Number(l.discount_percentage)??0,directions_to_use:l.directions_to_use,tabletsPerDay:l.tabletsPerDay,numberOfDays:l.numberOfDays,batch:he,expiry_date:xe}});C(R)}catch(a){console.error("Failed to fetch data:",a),N(a.message||"Failed to load order details.")}finally{k(!1)}})():(N("No pharmacy order ID provided."),k(!1))},[b.pathname]);const D=c.useMemo(()=>d.reduce((s,r)=>s+(r.total_price??0),0),[d]),S=c.useMemo(()=>d.reduce((s,r)=>{const a=(r.total_price??0)*(r.discount_percentage??0)/100;return s+a},0),[d]),p=c.useMemo(()=>D-S,[D,S]);return c.useEffect(()=>{if(p>0&&F){const s=`upi://pay?pa=${F}&pn=ClinicName&am=${p.toFixed(2)}&cu=INR`;q(s)}else q("")},[p,F]),c.useEffect(()=>{(async()=>{if(g==="credit"&&(i!=null&&i.patientId)){Q(!0);try{const r=await j(`/api/patient-debts/${i.patientId}/balance`);if(r.ok){const o=await r.json();A(o.netDebt||0)}else A(0)}catch(r){console.error("Error fetching patient debt:",r),A(0)}finally{Q(!1)}}})()},[g,i==null?void 0:i.patientId]),K?e.jsx("div",{className:"pharmacy-billing-page",children:e.jsxs("div",{className:"billing-container",children:[e.jsxs("div",{className:"billing-header no-print",children:[e.jsx("div",{className:"back-button",children:e.jsx(t,{width:100,height:40,style:{borderRadius:"8px"}})}),e.jsx(t,{width:300,height:40})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("div",{className:"order-details-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(t,{width:150,height:24})})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsx("div",{className:"info-item",children:e.jsx(t,{width:200,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(t,{width:150,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(t,{width:180,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(t,{width:150,height:20})})]})]}),e.jsxs("div",{className:"medications-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(t,{width:120,height:24})})}),e.jsx("div",{className:"p-4",children:e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx(t,{width:30,height:20})}),e.jsx("th",{children:e.jsx(t,{width:150,height:20})}),e.jsx("th",{children:e.jsx(t,{width:80,height:20})}),e.jsx("th",{children:e.jsx(t,{width:80,height:20})}),e.jsx("th",{children:e.jsx(t,{width:100,height:20})}),e.jsx("th",{children:e.jsx(t,{width:60,height:20})})]})}),e.jsx("tbody",{children:[1,2,3,4].map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(t,{width:20,height:20})}),e.jsx("td",{children:e.jsx(t,{width:180,height:20})}),e.jsx("td",{children:e.jsx(t,{width:70,height:20})}),e.jsx("td",{children:e.jsx(t,{width:70,height:20})}),e.jsx("td",{children:e.jsx(t,{width:90,height:20})}),e.jsx("td",{children:e.jsx(t,{width:60,height:20})})]},s))})]})})]})]}),e.jsx("aside",{className:"billing-sidebar",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(t,{width:160,height:24})})}),e.jsxs("div",{className:"space-y-4 p-5",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(t,{width:100,height:20}),e.jsx(t,{width:80,height:20})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(t,{width:100,height:20}),e.jsx(t,{width:80,height:20})]}),e.jsx("hr",{}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(t,{width:120,height:28}),e.jsx(t,{width:100,height:28})]}),e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:"20px 0"},children:e.jsx(t,{width:150,height:150})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(t,{width:"100%",height:45,style:{borderRadius:"8px"}}),e.jsx(t,{width:"100%",height:45,style:{borderRadius:"8px"}}),e.jsx(t,{width:"100%",height:45,style:{borderRadius:"8px"}})]})]})]})})]})]})}):O?e.jsxs("div",{className:"error-message-box",children:["Error: ",O]}):i?e.jsx("div",{className:"pharmacy-billing-page",children:e.jsxs("div",{className:"billing-container printable-section",children:[e.jsxs("div",{className:"billing-header print-only",children:[e.jsx("div",{className:"clinic-header-left",children:e.jsx("div",{className:"clinic-info-print",children:e.jsxs("div",{className:"clinic-name-and-details-print",children:[e.jsx("h1",{className:"bill-title",children:"INVOICE"}),e.jsx("h2",{className:"clinic-name-print",children:z?`${z} Pharmacy`:"Pharmacy Bill"}),(I||B)&&e.jsxs("div",{className:"clinic-details-print",children:[I&&e.jsx("span",{className:"small-text clinic-address",children:I}),B&&e.jsx("span",{className:"small-text clinic-notes",children:B})]})]})})}),e.jsxs("div",{className:"patient-info-grid print-only-patient-details",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(H,{size:16})," Patient Name"]})," ",i.patientName]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Y,{size:16})," Token"]})," ",i.patientTokenNumber??"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(X,{size:16})," Order Date"]})," ",new Date(i.date).toLocaleDateString()]})]})]}),e.jsxs("header",{className:"billing-header no-print",children:[e.jsx("button",{onClick:()=>m(-1),className:"back-button",children:e.jsx(je,{className:"w-4 h-4"})}),e.jsx("h1",{children:"Pharmacy Bill"})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("section",{className:"order-details-card no-print",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Patient Information"})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(H,{size:16})," Patient Name"]})," ",i.patientName]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Y,{size:16})," Token"]})," ",i.patientTokenNumber??"N/A"]}),e.jsxs("div",{className:"info-item no-print",children:[e.jsxs("strong",{children:[e.jsx(me,{size:16})," Order ID"]})," ",i.id]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(X,{size:16})," Order Date"]})," ",new Date(i.date).toLocaleDateString()]})]})]}),e.jsxs("section",{className:"medications-card",children:[e.jsx("div",{className:"card-header no-print",children:e.jsx("h2",{children:"Medications"})}),d.length>0?e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"S.No."}),e.jsx("th",{children:"DESCRIPTION"}),e.jsx("th",{children:"BATCH"}),e.jsx("th",{children:"EXPIRY"}),e.jsx("th",{children:"QUANTITY"}),e.jsx("th",{children:"MRP"}),e.jsx("th",{children:"RATE"}),e.jsx("th",{children:"DIS %"}),e.jsx("th",{children:"GST%"}),e.jsx("th",{children:"AMT"})]})}),e.jsx("tbody",{children:d.map((s,r)=>{var u;const o=s.total_price??0,a=o*(s.discount_percentage??0)/100,x=o-a;return e.jsxs("tr",{children:[e.jsx("td",{children:r+1}),e.jsx("td",{children:s.name}),e.jsx("td",{children:s.batch||"N/A"}),e.jsx("td",{children:s.expiry_date?new Date(s.expiry_date).toLocaleDateString():"N/A"}),e.jsxs("td",{children:[e.jsxs("div",{children:["Packs: ",s.loosePacks??0]}),e.jsxs("div",{children:["Loose: ",s.looseUnits??0]})]}),e.jsx("td",{children:((u=s.originalPrice)==null?void 0:u.toFixed(2))??"N/A"}),e.jsx("td",{children:((s.pricePerLooseUnit??0)*(1-(s.discount_percentage??0)/100)).toFixed(2)}),e.jsxs("td",{children:[e.jsx("input",{type:"number",value:s.discount_percentage===0?"":s.discount_percentage,onChange:y=>re(r,parseFloat(y.target.value)),min:"0",max:"100",className:"discount-input-table"}),"%"]}),e.jsxs("td",{children:[5 .toFixed(1),"%"]}),e.jsx("td",{children:x.toFixed(2)})]},r)})})]}):e.jsx("p",{children:"No medications in this order."})]}),e.jsxs("div",{className:"bill-summary-print print-only",children:[e.jsxs("div",{className:"bill-summary-details",children:[e.jsxs("div",{className:"summary-row-print",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",D.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row-print",children:[e.jsxs("span",{children:["Total Discount (",P.toFixed(2),"%)"]}),e.jsxs("span",{children:["- ₹",S.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row-print",children:[e.jsx("span",{children:"GST (Included)"}),e.jsxs("span",{children:["₹",(p*.05).toFixed(2)]})]}),e.jsx("div",{className:"print-only-total",children:e.jsxs("strong",{children:["Grand Total: ₹",p.toFixed(2)]})})]}),w&&e.jsxs("div",{className:`qr-code-container qr-code-printable-section ${g!=="upi"?"hide-on-screen":""}`,children:[e.jsx(W,{value:w,size:100}),e.jsx("p",{className:"print-only-upi-text",children:"Scan to pay using UPI"})]})]})]}),e.jsx("aside",{className:"billing-sidebar no-print",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Billing Summary"})}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",D.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Total Discount"}),e.jsxs("span",{children:["- ₹",S.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Discount Percentage"}),e.jsxs("div",{className:"discount-input-wrapper",children:[e.jsx("input",{type:"number",value:P===0?"":P,onChange:s=>ne(parseFloat(s.target.value)),min:"0",max:"100",className:"discount-input-total",disabled:v||i.status==="billed"}),"%"]})]}),e.jsxs("div",{className:"summary-row grand-total-row",children:[e.jsx("strong",{children:"Grand Total"}),e.jsxs("strong",{children:["₹",p.toFixed(2)]})]}),e.jsx("div",{className:"qr-code-container",children:w?e.jsxs(e.Fragment,{children:[e.jsx(W,{value:w,size:128}),e.jsx("p",{children:"Scan to pay using UPI"})]}):e.jsx("p",{children:"UPI QR code not available. Please ensure UPI ID is configured."})}),e.jsxs("div",{className:"payment-mode-section",children:[e.jsx("label",{htmlFor:"paymentMode",className:"info-item",children:e.jsx("strong",{children:"Payment Mode"})}),e.jsxs("select",{id:"paymentMode",value:g,onChange:s=>Z(s.target.value),className:"payment-mode-select",disabled:v||i.status==="billed",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"no_cash_insurance",children:"No Cash Insurance"}),e.jsx("option",{value:"credit",children:"Credit (Debt to Patient)"})]})]}),g==="credit"&&e.jsxs("div",{className:"debt-info-section",style:{marginTop:"10px",padding:"12px",backgroundColor:"rgba(220, 53, 69, 0.1)",borderRadius:"8px",border:"1px solid rgba(220, 53, 69, 0.3)"},children:[e.jsx("div",{style:{fontWeight:"bold",color:"#dc3545",marginBottom:"8px"},children:"⚠️ Debt to Patient"}),ae?e.jsx("div",{style:{fontSize:"0.9em",color:"#666"},children:"Loading debt info..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"Current Debt:"}),e.jsxs("strong",{style:{color:_&&_>0?"#dc3545":"#28a745"},children:["₹",(_||0).toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"This Bill:"}),e.jsxs("strong",{children:["+ ₹",p.toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",borderTop:"1px solid rgba(220, 53, 69, 0.3)",paddingTop:"8px",marginTop:"8px"},children:[e.jsx("span",{children:e.jsx("strong",{children:"New Total Debt:"})}),e.jsxs("strong",{style:{color:"#dc3545"},children:["₹",((_||0)+p).toFixed(2)]})]})]})]}),e.jsxs("div",{className:"bill-actions",children:[i.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:de,className:"secondary-button print-preview-button no-print",disabled:v||d.length===0,children:"Print Preview"}),e.jsx("button",{onClick:oe,className:"primary-button",disabled:v||d.length===0,children:v?"Processing...":"Finalise and Bill"})]}),i.status==="billed"&&e.jsx("button",{onClick:()=>m(`/dashboard/bills/${i.bill_id}`),className:"secondary-button",children:"View Bill"})]})]})})]}),e.jsxs("footer",{className:"billing-footer print-only",children:[e.jsx("p",{children:"Thank you for your business!"}),e.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})}):e.jsx("div",{className:"error-message-box",children:"No order data available."})};export{De as default};
