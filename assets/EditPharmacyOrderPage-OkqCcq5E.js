import{f,p as B,j as e,S as i}from"./index-jGjkutd2.js";import{j as $,u as W,r as n}from"./react-vendor-Cc0P4_ZX.js";import{u as G}from"./useAutoFocusSingleInput-6a_v4dYJ.js";import{Q as J,a7 as K}from"./ui-vendor-B5keALZQ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const ae=()=>{const{orderId:y}=$(),k=W(),[x,L]=n.useState(null),[N,A]=n.useState(null),[_,T]=n.useState([]),[o,u]=n.useState([]),[p,v]=n.useState(""),[w,j]=n.useState([]),[S,d]=n.useState(null),[D,g]=n.useState(!1),[m,P]=n.useState(null),[q,I]=n.useState(!0);G();const O=n.useCallback(async()=>{I(!0);try{const s=await f(`/api/pharmacy-orders/${y}`);if(!s.ok)throw new Error("Failed to fetch order details");const t=await s.json();L(t),A({id:t.patientId,name:t.patientName||"N/A",token:t.patientTokenNumber}),P(t.prescriptionForUnavailableDrugs);const r=t.medications.map(a=>{const l=h(a.pack),c=a.pack_quantity*(l??1)+a.loose_quantity;return{...a,isLoose:!0,loosePacks:a.pack_quantity,looseUnits:a.loose_quantity,looseQuantity:c,pack_price:a.pack_price,loose_price:a.loose_price,total_price:a.total_price,pricePerLooseUnit:a.loose_price,originalPrice:a.pack_price,box_number:a.box_number,pack:a.pack,batch:a.batch,expiry_date:a.expiry_date,discount_percentage:a.discount_percentage}});u(r)}catch(s){d("Could not load order details. "+s.message)}finally{I(!1)}},[y]),U=n.useCallback(async()=>{try{const s=await f("/api/drugs");if(!s.ok)throw new Error("Failed to fetch drugs");const t=await s.json(),r=t.drugs||t||[];T(r)}catch(s){d("Could not load drug list. "+s.message)}},[]);n.useEffect(()=>{O(),U()},[O,U]);const C=n.useMemo(()=>new B(_,{keys:["name","brand_name"],threshold:.3}),[_]);n.useEffect(()=>{if(!p){j([]);return}const s=C.search(p).map(t=>t.item);j(s.slice(0,10))},[p,C]);const h=s=>{if(!s)return null;const t=s.match(/(?:\d+x)?(\d+)/);return t?parseInt(t[1],10):null},E=s=>{if(o.some(t=>t.drug_id===s.id)){d(`${s.name||s.brand_name} is already in the order.`),setTimeout(()=>d(null),3e3),v(""),j([]);return}u(t=>[...t,{drug_id:s.id,name:s.name||s.brand_name||"Unnamed Drug",pack_quantity:0,loose_quantity:1,pack_price:Number(s.mrp)||0,loose_price:(Number(s.mrp)||0)/(h(s.pack)||1),total_price:(Number(s.mrp)||0)/(h(s.pack)||1),discount_percentage:0,directions_to_use:"",tabletsPerDay:1,numberOfDays:1,stock:s.stock,isLoose:!0,looseQuantity:1,loosePacks:0,looseUnits:1,pricePerLooseUnit:(Number(s.mrp)||0)/(h(s.pack)||1),originalPrice:Number(s.mrp)||0,pack:s.pack}]),v(""),j([])},Q=s=>{u(t=>t.filter(r=>(r.drug_id??r.name)!==s))},F=(s,t)=>{u(r=>r.map(a=>{if((a.drug_id??a.name)===s&&a.isLoose){const l=h(a.pack),c=Math.max(0,t),b=c*(l??1)+(a.looseUnits??0);return{...a,loosePacks:c,looseQuantity:b,pack_quantity:c}}return a}))},z=(s,t)=>{u(r=>r.map(a=>{if((a.drug_id??a.name)===s&&a.isLoose){const l=h(a.pack),c=Math.max(0,t),b=(a.loosePacks??0)*(l??1)+c;return{...a,looseUnits:c,looseQuantity:b,loose_quantity:c}}return a}))},M=async s=>{if(s.preventDefault(),d(null),g(!0),o.length===0&&!(m!=null&&m.trim())){d("Please add at least one medication or provide a prescription."),g(!1);return}const t=o.filter(a=>{const l=a.looseQuantity??0;return l<=0||a.stock!==void 0&&l>a.stock});if(t.length>0){d(`Invalid quantity or insufficient stock for: ${t.map(a=>a.name).join(", ")}`),g(!1);return}const r={items:o.map(a=>({drug_id:a.drug_id??null,name:a.name,pack_quantity:a.loosePacks??0,loose_quantity:a.looseUnits??0,pack_price:a.pack_price??0,loose_price:a.loose_price??0,total_price:(a.loose_price??0)*(a.looseQuantity??0),discount_percentage:a.discount_percentage??0,directions_to_use:a.directions_to_use??null,tabletsPerDay:a.tabletsPerDay??1,numberOfDays:a.numberOfDays??1})),prescription_for_unavailable_drugs:m,order_total:R};try{const a=await f(`/api/pharmacy-orders/${y}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok){const l=await a.json();throw new Error(l.message||"Failed to update order")}alert("Pharmacy order updated successfully!"),k(-1)}catch(a){d(a.message||"Failed to update order. Please try again.")}finally{g(!1)}},R=n.useMemo(()=>o.reduce((s,t)=>{const r=t.loose_price??0,a=t.looseQuantity??0;return s+r*a},0),[o]);return q?e.jsxs("div",{className:"edit-pharmacy-order-container",children:[e.jsxs("div",{className:"page-header",children:[e.jsxs("div",{className:"header-left",style:{display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx(i,{variant:"circular",width:40,height:40}),e.jsx(i,{width:300,height:32})]}),e.jsx("div",{className:"header-right",children:e.jsx(i,{width:100,height:32,style:{borderRadius:"16px"}})})]}),e.jsx("div",{className:"order-meta",style:{display:"flex",gap:"1rem",margin:"1rem 0"},children:e.jsx(i,{width:200,height:24})}),e.jsxs("div",{className:"main-layout",children:[e.jsxs("div",{className:"left-column",children:[e.jsxs("div",{className:"card search-section",children:[e.jsx("div",{className:"card-header",children:e.jsx(i,{width:200,height:24})}),e.jsx("div",{style:{padding:"1.5rem"},children:e.jsx(i,{height:42})})]}),e.jsxs("div",{className:"card medications-list-section",children:[e.jsx("div",{className:"card-header",children:e.jsx(i,{width:250,height:24})}),e.jsxs("div",{className:"table-container",style:{padding:"0 1rem 1rem"},children:[e.jsxs("div",{className:"table-header-row",style:{display:"flex",gap:"1rem",padding:"1rem"},children:[e.jsx(i,{width:"30%",height:20}),e.jsx(i,{width:"20%",height:20}),e.jsx(i,{width:"20%",height:20}),e.jsx(i,{width:"15%",height:20}),e.jsx(i,{width:"5%",height:20})]}),e.jsx("div",{className:"table-body",children:[1,2,3].map(s=>e.jsxs("div",{className:"table-row",style:{display:"flex",gap:"1rem",padding:"1rem",borderBottom:"1px solid #eee"},children:[e.jsxs("div",{style:{width:"30%"},children:[e.jsx(i,{width:"80%",height:20,className:"mb-2"}),e.jsx(i,{width:"40%",height:14})]}),e.jsx(i,{width:"20%",height:36}),e.jsx(i,{width:"20%",height:36}),e.jsx(i,{width:"15%",height:20,style:{alignSelf:"center"}}),e.jsx(i,{width:"5%",height:24,style:{alignSelf:"center"}})]},s))})]})]})]}),e.jsxs("div",{className:"right-column",children:[e.jsxs("div",{className:"card notes-card",children:[e.jsx("div",{className:"card-header border-b-0 pb-2",children:e.jsx(i,{width:180,height:24})}),e.jsx("div",{style:{padding:"1rem"},children:e.jsx(i,{height:80})})]}),e.jsx("div",{style:{marginTop:"20px"},children:e.jsx(i,{height:48,width:"100%"})})]})]})]}):x?e.jsxs("div",{className:"edit-pharmacy-order-container",children:[e.jsxs("div",{className:"page-header",children:[e.jsxs("div",{className:"header-left",children:[e.jsx("button",{onClick:()=>k(-1),className:"back-button",title:"Go Back",children:e.jsx(J,{size:20})}),e.jsxs("h2",{className:"page-title",children:["EDIT ORDER ",e.jsxs("span",{className:"text-gray-500 text-lg font-normal ml-2",children:[N==null?void 0:N.name," #",x.id.substring(0,4)]})]})]}),e.jsx("div",{className:"header-right",children:e.jsx("span",{className:"status-badge",children:x.status.toUpperCase()})})]}),e.jsx("div",{className:"order-meta",children:e.jsxs("span",{className:"order-date",children:["ðŸ“„ Order Date: ",new Date(x.date).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})]})}),e.jsxs("form",{onSubmit:M,className:"main-layout",children:[e.jsxs("div",{className:"left-column",children:[e.jsxs("div",{className:"card search-section",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{children:"ðŸ” Find & Add Medication"})}),e.jsxs("div",{className:"search-wrapper",children:[e.jsx("input",{type:"text",placeholder:"Search by name or brand...",value:p,onChange:s=>v(s.target.value),className:"search-input"}),p&&e.jsx("div",{className:"dropdown-results",children:w.length>0?e.jsx("ul",{children:w.map(s=>e.jsxs("li",{onClick:()=>E(s),className:"dropdown-item",children:[e.jsx("span",{className:"drug-name",children:s.name||s.brand_name}),e.jsxs("span",{className:"drug-meta",children:["(Stock: ",s.stock??"N/A",", MRP: â‚¹",Number(s.mrp||0).toFixed(2),")"]})]},s.id))}):e.jsxs("div",{className:"p-3 text-gray-500 text-sm",children:['No drugs found matching "',p,'"']})})]})]}),e.jsxs("div",{className:"card medications-list-section",children:[e.jsx("div",{className:"card-header",children:e.jsxs("h3",{children:["ðŸ’Š Medications in Order ",e.jsxs("span",{className:"item-count",children:[o.length," items"]})]})}),o.length>0?e.jsxs("div",{className:"table-container",children:[e.jsxs("div",{className:"table-header-row",children:[e.jsx("div",{className:"col-medication",children:"MEDICATION"}),e.jsx("div",{className:"col-directions",children:"DIRECTIONS"}),e.jsx("div",{className:"col-quantity",children:"QUANTITY"}),e.jsx("div",{className:"col-subtotal",children:"SUBTOTAL"}),e.jsx("div",{className:"col-action"})]}),e.jsx("div",{className:"table-body",children:o.map(s=>{const t=s.drug_id??s.name;return e.jsxs("div",{className:"table-row",children:[e.jsxs("div",{className:"col-medication",children:[e.jsx("span",{className:"med-name",children:s.name}),s.pack&&e.jsx("span",{className:"med-unit text-xs text-gray-500 block",children:s.pack}),e.jsxs("div",{className:"stock-info",children:["ðŸ“¦ Stock: ",e.jsxs("span",{className:"stock-value",children:["â€¢ ",s.stock!==void 0?s.pack?`BOX OF ${h(s.pack)}`:s.stock:"N/A"]})]})]}),e.jsx("div",{className:"col-directions",children:e.jsx("input",{type:"text",placeholder:"1 tablet twice daily...",value:s.directions_to_use??"",onChange:r=>{const a=r.target.value;u(l=>l.map(c=>(c.drug_id??c.name)===t?{...c,directions_to_use:a}:c))},className:"directions-input"})}),e.jsx("div",{className:"col-quantity",children:e.jsxs("div",{style:{display:"flex",gap:"8px"},children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("label",{style:{fontSize:"10px",fontWeight:"bold",color:"#9ca3af",display:"block",marginBottom:"2px"},children:"PACKS"}),e.jsx("input",{type:"number",min:"0",value:s.loosePacks||"",onChange:r=>F(t,r.target.value===""?0:parseInt(r.target.value)),className:"qty-input",style:{width:"100%",textAlign:"center"}})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx("label",{style:{fontSize:"10px",fontWeight:"bold",color:"#9ca3af",display:"block",marginBottom:"2px"},children:"LOOSE"}),e.jsx("input",{type:"number",min:"0",value:s.looseUnits||"",onChange:r=>z(t,r.target.value===""?0:parseInt(r.target.value)),className:"qty-input",style:{width:"100%",textAlign:"center"}})]})]})}),e.jsxs("div",{className:"col-subtotal",children:["â‚¹",(Number((s.pricePerLooseUnit??0)*(s.looseQuantity??0))||0).toFixed(2)]}),e.jsx("div",{className:"col-action",children:e.jsx("button",{type:"button",onClick:()=>Q(t),className:"delete-btn",title:"Remove Item",children:e.jsx(K,{size:18,strokeWidth:2.5})})})]},t)})})]}):e.jsx("div",{className:"empty-state",children:"No medications added. Search above to add."})]})]}),e.jsxs("div",{className:"right-column",children:[e.jsxs("div",{className:"card notes-card",children:[e.jsx("div",{className:"card-header border-b-0 pb-2",children:e.jsx("h3",{children:"â“˜ Prescription Notes"})}),e.jsx("textarea",{rows:3,value:m??"",onChange:s=>P(s.target.value||null),placeholder:"Add notes about unavailable drugs...",className:"notes-input"})]}),e.jsxs("button",{type:"submit",disabled:D,className:"confirm-btn",style:{width:"100%",margin:"20px 0 0 0"},children:[e.jsx("span",{className:"check-icon",children:"âœ“"})," ",D?"Updating...":"Confirm Changes"]}),S&&e.jsx("div",{className:"error-alert mt-4",children:S})]})]})]}):e.jsx("div",{className:"p-6 text-red-500 flex justify-center items-center h-screen",children:"Order not found or failed to load."})};export{ae as default};
