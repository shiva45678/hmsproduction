import{f as k,j as e}from"./index-jGjkutd2.js";import{j as K,u as W,r as d}from"./react-vendor-Cc0P4_ZX.js";import{Q as Y}from"./index-CZ6CIOFr.js";import{Q as v,aa as G,ah as A}from"./ui-vendor-B5keALZQ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const H=h=>{switch(h){case"pending":return{text:"text-orange-700",bg:"bg-orange-100"};case"billed":return{text:"text-blue-700",bg:"bg-blue-100"};case"dispensed":return{text:"text-green-700",bg:"bg-green-100"};case"cancelled":return{text:"text-red-700",bg:"bg-red-100"};default:return{text:"text-gray-600",bg:"bg-gray-100"}}},ne=()=>{const{orderId:h}=K(),j=W(),[s,_]=d.useState(null),[I,f]=d.useState(!0),[w,m]=d.useState(null),[C,R]=d.useState(!1),[x,N]=d.useState({}),[y,M]=d.useState(""),[T,S]=d.useState(""),[$,D]=d.useState("cash"),E=d.useMemo(()=>(s==null?void 0:s.medications.reduce((t,n)=>{const i=n.total_price??0,a=i*(n.discount_percentage??0)/100;return t+i-a},0))??0,[s==null?void 0:s.medications]),q=5,F=d.useMemo(()=>!s||!s.medications?0:s.medications.reduce((t,n,i)=>{var u,p;const a=n.drug_id??`index-${i}`,o=((u=x[a])==null?void 0:u.pack)||0,r=((p=x[a])==null?void 0:p.loose)||0,c=n.pack_price??0,l=n.loose_price??0;return t+o*c+r*l},0),[s,x]),b=d.useCallback(async()=>{if(!h){m("Order ID is missing."),f(!1);return}f(!0),m(null);try{const t=await k(`/api/pharmacy-orders/${h}`);if(!t.ok)throw t.status===404?new Error(`Order with ID ${h} not found.`):new Error(`Failed to fetch order details: ${t.statusText} (${t.status})`);const n=await t.json();console.log("Fetched order data after return:",n);const a=n.medications.map(r=>r.pack_price&&r.loose_price&&r.loose_price>0?{...r,unitsPerPack:Math.round(r.pack_price/r.loose_price)}:{...r,unitsPerPack:0}).map(r=>({...r,discount_percentage:r.discount_percentage??0}));_({...n,medications:a});const o={};a.forEach((r,c)=>{const l=r.drug_id??`index-${c}`;o[l]={pack:0,loose:0}}),N(o)}catch(t){console.error("Failed to fetch order details:",t),m(t.message||"Failed to load order details.")}finally{f(!1)}},[h]);d.useEffect(()=>{b()},[b]),d.useEffect(()=>{(async()=>{try{const n=await k("/api/clinics/settings");if(!n.ok)throw new Error("Failed to fetch clinic settings");const i=await n.json();console.log("Fetched clinic settings:",i),M(i.upi_id||"")}catch(n){console.error("Error fetching clinic settings:",n)}})()},[]),d.useEffect(()=>{if((s==null?void 0:s.order_total)!==void 0&&s.order_total>0&&y){const t=`upi://pay?pa=${y}&pn=ClinicName&am=${s.order_total.toFixed(2)}&cu=INR`;S(t)}else S("")},[s==null?void 0:s.order_total,y]);const U=(t,n)=>{_(i=>{if(!i)return null;const a=i.medications.map((r,c)=>(r.drug_id??`index-${c}`)===t?{...r,discount_percentage:isNaN(n)?0:n}:r),o=a.reduce((r,c)=>{const l=c.total_price??0,u=l*(c.discount_percentage??0)/100;return r+l-u},0);return{...i,medications:a,order_total:o}})},O=(t,n,i)=>{N(a=>{const o=i.unitsPerPack||0,c=i.pack_quantity*o+i.loose_quantity,l=Math.max(0,Math.min(n,c));let u=0,p=l;return o>0&&(u=Math.floor(l/o),p=l%o),{...a,[t]:{pack:u,loose:p}}})},z=async()=>{const t=s==null?void 0:s.medications.map((n,i)=>{var c,l;const a=n.drug_id??`index-${i}`,o=((c=x[a])==null?void 0:c.pack)||0,r=((l=x[a])==null?void 0:l.loose)||0;return o>0||r>0?{drug_id:n.drug_id,name:n.name,pack_quantity:n.pack_quantity,loose_quantity:n.loose_quantity,returnPackQuantity:o,returnLooseQuantity:r}:null}).filter(n=>n!==null);if(!t||t.length===0){alert("Please select a quantity greater than 0 for at least one item to return.");return}if(!h){alert("Order ID is missing. Cannot process return.");return}if(!t){alert("Could not prepare items for return.");return}R(!0),m(null);try{const n=await k(`/api/pharmacy-orders/${h}/return`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({itemsToReturn:t})}),i=await n.json();if(!n.ok)throw new Error(i.message||`Failed to process return: ${n.statusText}`);alert("Return processed successfully! Stock has been updated.");const a={};s==null||s.medications.forEach((o,r)=>{const c=o.drug_id??`index-${r}`;a[c]={pack:0,loose:0}}),N(a),b()}catch(n){console.error("Failed to process return:",n),m(n.message||"An error occurred while processing the return."),alert(`Error processing return: ${n.message||"Unknown error"}`)}finally{R(!1)}};if(I)return e.jsx("div",{className:"text-center p-6 text-gray-500 animate-pulse",children:"Loading Order Details..."});if(w)return e.jsxs("div",{className:"p-6 max-w-2xl mx-auto",children:[e.jsxs("button",{onClick:()=>j(-1),className:"mb-4 inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",children:[e.jsx(v,{size:14,className:"mr-1.5"})," Back"]}),e.jsxs("div",{className:"bg-red-50 border border-red-300 text-red-700 rounded p-4",children:["Error: ",w]})]});if(!s)return e.jsxs("div",{className:"p-6 max-w-2xl mx-auto",children:[e.jsxs("button",{onClick:()=>j(-1),className:"mb-4 inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",children:[e.jsx(v,{size:14,className:"mr-1.5"})," Back"]}),e.jsx("div",{className:"text-center py-10 px-4 text-gray-500 bg-white rounded-lg shadow",children:"Order details could not be loaded."})]});const B=()=>{window.print()},L=H(s.status);return e.jsx("div",{className:"pharmacy-order-details-page",children:e.jsxs("div",{className:"order-details-container printable-section",children:[e.jsxs("div",{className:"order-details-header no-print",children:[e.jsx("h1",{children:"Pharmacy Order Details"}),e.jsxs("div",{className:"actions",children:[e.jsx("button",{onClick:()=>j(-1),className:"back-button",children:e.jsx(v,{size:20})}),e.jsxs("button",{onClick:B,className:"print-button",children:[e.jsx(G,{size:18})," Print Bill"]})]})]}),e.jsxs("div",{className:"billing-header print-only",children:[e.jsx("div",{className:"clinic-header-left",children:e.jsx("div",{className:"clinic-info-print",children:e.jsxs("div",{className:"clinic-name-and-details-print",children:[e.jsx("h1",{children:"Mahajan Pharmacy"}),e.jsxs("div",{className:"clinic-details-print",children:[e.jsx("span",{className:"small-text clinic-address",children:"D.No: 3-1-289, Plot No. 101, Kabela Center, RR Nagar, Vijayawada – 520012."}),e.jsx("span",{className:"small-text clinic-notes",children:"Phone: 93919 44733"}),e.jsx("span",{className:"small-text clinic-license",children:"Licence No:RLF20AP2025003328"})]})]})})}),e.jsxs("div",{className:"patient-info-grid print-only-patient-details",children:[e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Patient Name:"})," RESHMA"]}),e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Token:"})," 12"]}),e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Order Date:"})," 31/10/2025"]})]})]}),e.jsxs("div",{className:"order-info-section no-print",children:[e.jsxs("div",{className:"order-info-item",children:[e.jsx("strong",{children:"Order ID:"})," ",s.id]}),e.jsxs("div",{className:"order-info-item",children:[e.jsx("strong",{children:"Patient:"})," ",s.patientName||"N/A"," (",s.patientTokenNumber||"N/A",")"]}),e.jsxs("div",{className:"order-info-item",children:[e.jsx("strong",{children:"Date:"})," ",new Date(s.date).toLocaleString()]}),e.jsxs("div",{className:"order-info-item",children:[e.jsx("strong",{children:"Prescribed By:"})," ",s.prescribedBy||"N/A"]}),e.jsxs("div",{className:"order-info-item",children:[e.jsx("strong",{children:"Status:"})," ",e.jsx("span",{className:`status-pill ${L.text} ${L.bg}`,children:s.status})]})]}),e.jsxs("div",{className:"medications-section",children:[e.jsx("h2",{children:"Medications Ordered"}),s.medications.length>0?e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"DESCRIPTION"}),e.jsx("th",{children:"PACK QTY"}),e.jsx("th",{children:"PACK PRICE"}),e.jsx("th",{children:"LOOSE QTY"}),e.jsx("th",{children:"LOOSE PRICE"}),e.jsx("th",{children:"MRP"}),e.jsx("th",{children:"RATE"}),e.jsx("th",{children:"DIS %"}),e.jsx("th",{children:"GST%"}),e.jsx("th",{children:"AMT"}),(s.status==="dispensed"||s.status==="billed")&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"no-print",children:"RETURN PACK QTY"}),e.jsx("th",{className:"no-print",children:"RETURN LOOSE QTY"})]})]})}),e.jsx("tbody",{children:s.medications.map((t,n)=>{var u,p;const i=t.drug_id??`index-${n}`,a=t.total_price??0,o=a*(t.discount_percentage??0)/100,r=a-o,c=((u=x[i])==null?void 0:u.pack)||0,l=((p=x[i])==null?void 0:p.loose)||0;return e.jsxs("tr",{children:[e.jsx("td",{children:t.name}),e.jsx("td",{children:t.pack_quantity??0}),e.jsx("td",{children:t.pack_price!=null?Number(t.pack_price).toFixed(2):"N/A"}),e.jsx("td",{children:t.loose_quantity??0}),e.jsx("td",{children:t.loose_price!=null?Number(t.loose_price).toFixed(2):"N/A"}),e.jsx("td",{children:t.price!=null?Number(t.price).toFixed(2):"N/A"})," ",e.jsx("td",{children:t.price!=null?Number(t.price).toFixed(2):"N/A"})," ",e.jsxs("td",{children:[e.jsx("input",{type:"number",value:t.discount_percentage??0,onChange:g=>U(i,parseFloat(g.target.value)),min:"0",max:"100",className:"discount-input-table no-print"}),e.jsxs("span",{className:"print-only",children:[t.discount_percentage??0,"%"]})]}),e.jsxs("td",{children:[q.toFixed(1),"%"]}),e.jsx("td",{children:r.toFixed(2)}),(s.status==="dispensed"||s.status==="billed")&&e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"no-print",children:e.jsx("input",{type:"number",min:"0",max:t.pack_quantity,value:c,onChange:g=>{const P=(parseInt(g.target.value,10)||0)*(t.unitsPerPack||0)+l;O(i,P,t)},className:"return-quantity-input"})}),e.jsx("td",{className:"no-print",children:e.jsx("input",{type:"number",min:"0",max:t.loose_quantity+t.pack_quantity*(t.unitsPerPack||0)-c*(t.unitsPerPack||0),value:l,onChange:g=>{const Q=parseInt(g.target.value,10)||0,P=c*(t.unitsPerPack||0)+Q;O(i,P,t)},className:"return-quantity-input"})})]})]},i)})})]}):e.jsx("p",{className:"text-sm text-gray-500 italic",children:"No medications listed for this order."})]}),e.jsx("div",{className:"print-only-total",children:e.jsxs("strong",{children:["Grand Total: ₹",E.toFixed(2)]})}),e.jsxs("div",{className:"order-total-section no-print",children:[e.jsx("span",{className:"total-label",children:"Order Total:"}),e.jsxs("span",{className:"total-amount",children:["₹",E.toFixed(2)]})]}),e.jsxs("div",{className:"payment-section no-print",children:[e.jsxs("div",{className:"payment-mode-group",children:[e.jsx("label",{htmlFor:"paymentMode",children:"Payment Mode:"}),e.jsxs("select",{id:"paymentMode",value:$,onChange:t=>D(t.target.value),className:"payment-mode-select",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"no_cash_insurance",children:"No Cash Insurance"}),e.jsx("option",{value:"credit",children:"Credit"})]})]}),T&&e.jsxs("div",{className:"qr-code-container",children:[e.jsx(Y,{value:T,size:128}),e.jsx("p",{children:"Scan to pay using UPI"})]})]}),(s.status==="dispensed"||s.status==="billed")&&s.medications.length>0&&e.jsxs("div",{className:"return-action-section no-print",children:[F>0&&e.jsxs("div",{className:"total-refund-display",children:["Total Refund: ₹",F.toFixed(2)]}),e.jsx("button",{onClick:z,disabled:Object.values(x).every(t=>t.pack===0&&t.loose===0)||C,className:"process-return-button",children:C?e.jsxs(e.Fragment,{children:[e.jsx(A,{size:16,className:"mr-2 animate-spin"})," Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(A,{size:16,className:"mr-2"})," Process Return"]})})]})]})})};export{ne as default};
