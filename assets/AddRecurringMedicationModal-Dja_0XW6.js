import{f as z,j as e}from"./index-DpOfI1um.js";import{r}from"./react-vendor-Cc0P4_ZX.js";import{u as se}from"./useAutoFocusSingleInput-6a_v4dYJ.js";import{X as te,a7 as ae,ae as ne,u as re,e as le,aa as oe}from"./ui-vendor-SmiJk_kJ.js";const me=({isOpen:i,onClose:w,onSuccess:X,medication:l,initialPatient:j,initialItems:m})=>{const[y,b]=r.useState(""),[R,v]=r.useState([]),[p,h]=r.useState(null),[B,A]=r.useState(!1);se(void 0,i?200:99999),r.useEffect(()=>{if(i&&l){c([{id:Date.now(),medication_name:l.medicationName,drug_id:null,quantity:l.quantity,tablets_per_day:l.tabletsPerDay||1,number_of_days:l.numberOfDays||30,directions:l.directions||"",notes:l.notes||""}]),N(l.frequencyDays);try{const s=new Date(l.nextDeliveryDate);isNaN(s.getTime())||g(s.toISOString().split("T")[0])}catch(s){console.error("Error parsing date",s)}h({id:l.patientId,name:l.patientName,phone:l.patientPhone,patient_token_number:l.patientToken})}else i&&(j||m)?(m&&m.length>0&&c(m),j&&h(j)):i&&!l&&!m&&(c([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:""}]),N(30),g(""),h(null),b(""))},[i,l,j,m]);const[o,c]=r.useState([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:""}]),[C,N]=r.useState(30),[F,g]=r.useState(""),[f,M]=r.useState(null),[_,T]=r.useState(""),[$,D]=r.useState([]),[G,U]=r.useState(!1),[W,J]=r.useState(!1),[L,S]=r.useState(null),q=r.useRef(null),I=r.useRef(null);r.useEffect(()=>{if(i){const s=new Date;s.setDate(s.getDate()+30),g(s.toISOString().split("T")[0])}},[i]);const O=r.useCallback(async s=>{if(!s.trim()){v([]);return}A(!0);try{const t=await z(`/api/patients?search=${encodeURIComponent(s)}&limit=10`);if(t.ok){const a=await t.json();v(a.patients||[])}}catch(t){console.error("Error searching patients:",t)}finally{A(!1)}},[]);r.useEffect(()=>{q.current&&clearTimeout(q.current),y&&!p?q.current=setTimeout(()=>O(y),300):v([])},[y,p,O]);const Q=r.useCallback(async s=>{if(!s.trim()){D([]);return}U(!0);try{const t=await z(`/api/drugs?search=${encodeURIComponent(s)}&limit=10`);if(t.ok){const a=await t.json();D(a.drugs||[])}}catch(t){console.error("Error searching drugs:",t)}finally{U(!1)}},[]);r.useEffect(()=>{I.current&&clearTimeout(I.current),_&&f!==null?I.current=setTimeout(()=>Q(_),300):D([])},[_,f,Q]);const H=s=>{if(!s)return 1;const t=s.match(/(?:\d+x)?(\d+)(?:s|tabs)?/i);return t?parseInt(t[1],10):1},K=s=>{h(s),b(`${s.name} (${s.patient_token_number})`),v([])},V=(s,t)=>{const a=[...o];a[t]={...a[t],medication_name:s.name,drug_id:s.id,pack_size:H(s.pack),packs:0,loose:0,quantity:0},c(a),M(null),T(""),D([])},u=(s,t,a)=>{const d=[...o],n={...d[s]},E=n.pack_size||1;if(t==="packs"||t==="loose"){const k=parseInt(a)||0;t==="packs"&&(n.packs=k),t==="loose"&&(n.loose=k);const P=n.packs||0,x=n.loose||0;n.quantity=P*E+x}else if(t==="tablets_per_day"||t==="number_of_days"){t==="tablets_per_day"&&(n.tablets_per_day=a),t==="number_of_days"&&(n.number_of_days=a);const k=parseFloat(n.tablets_per_day.toString())||0,P=parseInt(n.number_of_days.toString())||0,x=Math.ceil(k*P);n.quantity=x,n.packs=Math.floor(x/E),n.loose=x%E}else n[t]=a;d[s]=n,c(d)},Y=()=>{c([...o,{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:C,directions:"",notes:"",packs:0,loose:0,pack_size:1}])},Z=s=>{o.length>1&&c(o.filter((t,a)=>a!==s))},ee=async s=>{if(s.preventDefault(),S(null),!p){S("Please select a patient.");return}if(o.some(a=>!a.medication_name||a.quantity<=0)){S("Please ensure all items have a medication name and valid quantity.");return}J(!0);try{const a={patient_id:p.id,items:o.map(n=>({medication_name:n.medication_name,drug_id:n.drug_id,quantity:n.quantity,tablets_per_day:n.tablets_per_day,number_of_days:n.number_of_days,directions:n.directions,notes:n.notes,frequency_days:C,next_delivery_date:F}))},d=await z("/api/recurring-medications",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!d.ok){const n=await d.json();throw new Error(n.message+(n.error?": "+n.error:"")||"Failed to create recurring medication.")}X(),w(),h(null),b(""),c([{id:Date.now(),medication_name:"",drug_id:null,quantity:1,tablets_per_day:1,number_of_days:30,directions:"",notes:""}]),N(30)}catch(a){S(a.message)}finally{J(!1)}};return i?e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"add-recurring-modal",style:{maxWidth:"800px",width:"95%"},children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Add Recurring Medication Order"}),e.jsx("button",{className:"close-btn",onClick:w,children:e.jsx(te,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[L&&e.jsx("div",{className:"error-message",children:L}),e.jsxs("form",{onSubmit:ee,className:"recurring-form",children:[e.jsxs("div",{className:"order-settings-row",children:[e.jsxs("div",{className:"form-group",style:{flex:2},children:[e.jsxs("label",{children:[e.jsx(ae,{size:16})," Patient"]}),e.jsxs("div",{className:"search-wrapper",children:[e.jsx("input",{type:"text",placeholder:"Search patient...",value:y,onChange:s=>{b(s.target.value),h(null)},className:p?"selected":"unselected"}),B&&e.jsx("span",{className:"spinner",children:"..."}),y&&!p&&R.length>0&&e.jsx("ul",{className:"suggestions-list",children:R.map(s=>e.jsxs("li",{onClick:()=>K(s),children:[e.jsx("div",{className:"suggestion-name",children:s.name}),e.jsxs("div",{className:"suggestion-details",children:[s.phone," â€¢ ",s.patient_token_number]})]},s.id))})]})]}),e.jsxs("div",{className:"form-group",style:{flex:1},children:[e.jsxs("label",{children:[e.jsx(ne,{size:16})," Frequency"]}),e.jsxs("select",{value:C,onChange:s=>{const t=parseInt(s.target.value);N(t);const a=new Date;a.setDate(a.getDate()+t),g(a.toISOString().split("T")[0]);const d=o.map(n=>({...n,number_of_days:t}));c(d)},children:[e.jsx("option",{value:15,children:"Every 15 Days"}),e.jsx("option",{value:30,children:"Every 30 Days"}),e.jsx("option",{value:60,children:"Every 60 Days"}),e.jsx("option",{value:90,children:"Every 90 Days"})]})]}),e.jsxs("div",{className:"form-group",style:{flex:1},children:[e.jsxs("label",{children:[e.jsx(re,{size:16})," Next Delivery"]}),e.jsx("input",{type:"date",value:F,onChange:s=>g(s.target.value)})]})]}),e.jsx("hr",{className:"divider"}),e.jsxs("div",{className:"items-header",children:[e.jsx("h4",{children:"Medications"}),e.jsxs("button",{type:"button",className:"add-item-btn",onClick:Y,children:[e.jsx(le,{size:14})," Add Drug"]})]}),e.jsx("div",{className:"items-list",children:o.map((s,t)=>e.jsxs("div",{className:"medication-item-row",children:[e.jsxs("div",{className:"row-top",children:[e.jsxs("div",{className:"form-group med-search-group",children:[e.jsx("label",{children:"Drug Name"}),e.jsxs("div",{className:"search-wrapper",children:[e.jsx("input",{type:"text",placeholder:"Search drug...",value:f===t?_:s.medication_name,onFocus:()=>{M(t),T(s.medication_name)},onChange:a=>{T(a.target.value),u(t,"medication_name",a.target.value)}}),f===t&&G&&e.jsx("span",{className:"spinner",children:"..."}),f===t&&_&&$.length>0&&e.jsx("ul",{className:"suggestions-list",children:$.map(a=>e.jsxs("li",{onClick:()=>V(a,t),children:[e.jsx("div",{className:"suggestion-name",children:a.name}),e.jsxs("div",{className:"suggestion-details",children:["Stock: ",a.stock]})]},a.id))})]})]}),e.jsxs("div",{className:"form-group small-input",children:[e.jsx("label",{children:"Tabs/Day"}),e.jsx("input",{type:"number",min:"0.5",step:"0.5",value:s.tablets_per_day,onChange:a=>u(t,"tablets_per_day",a.target.value)})]}),e.jsxs("div",{className:"form-group small-input",children:[e.jsx("label",{children:"Days"}),e.jsx("input",{type:"number",min:"1",value:s.number_of_days,onChange:a=>u(t,"number_of_days",a.target.value)})]}),e.jsxs("div",{className:"form-group small-input",children:[e.jsx("label",{children:"Packs"}),e.jsx("input",{type:"number",min:"0",value:s.packs||"",onChange:a=>u(t,"packs",a.target.value),placeholder:"0"})]}),e.jsxs("div",{className:"form-group small-input",children:[e.jsx("label",{children:"Loose"}),e.jsx("input",{type:"number",min:"0",value:s.loose||"",onChange:a=>u(t,"loose",a.target.value),placeholder:"0"})]}),e.jsxs("div",{className:"form-group small-input",children:[e.jsx("label",{children:"Total"}),e.jsx("input",{type:"number",value:s.quantity,disabled:!0,style:{backgroundColor:"#f5f5f5",cursor:"not-allowed"}})]}),e.jsx("button",{type:"button",className:"remove-btn",onClick:()=>Z(t),disabled:o.length===1,children:e.jsx(oe,{size:16})})]}),e.jsxs("div",{className:"row-bottom",children:[e.jsx("div",{className:"form-group",style:{flex:1},children:e.jsx("input",{type:"text",placeholder:"Directions (e.g. 1-0-1 after food)",value:s.directions,onChange:a=>u(t,"directions",a.target.value)})}),e.jsx("div",{className:"form-group",style:{flex:1},children:e.jsx("input",{type:"text",placeholder:"Notes",value:s.notes,onChange:a=>u(t,"notes",a.target.value)})})]})]},s.id))}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"btn-cancel",onClick:w,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn-submit",disabled:W,children:W?"Creating...":"Create Recurring Order"})]})]})]})]})}):null};export{me as A};
