import{j as e,S as i,f as j}from"./index-D_kqlrGT.js";import{u as pe,f as ue,r as c}from"./react-vendor-Cc0P4_ZX.js";import{Q as W}from"./index-CZ6CIOFr.js";/* empty css                            */import{a7 as H,af as Y,u as X,W as je,s as me}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const ge=m=>{if(!m)return 1;const b=m.match(/(?:\d+x)?(\d+)/);return b&&b[1]?parseInt(b[1],10):1},De=()=>{const m=pe(),b=ue(),[t,L]=c.useState(null),[d,C]=c.useState([]),[K,k]=c.useState(!0),[O,N]=c.useState(null),[v,$]=c.useState(!1),[g,Z]=c.useState("cash"),[w,q]=c.useState(""),[F,ee]=c.useState(""),[z,se]=c.useState(""),[I,ie]=c.useState(""),[B,te]=c.useState(""),[P,U]=c.useState(0),M=c.useRef(!1),[_,A]=c.useState(null),[ae,Q]=c.useState(!1),ne=s=>{const n=Math.max(0,Math.min(100,isNaN(s)?0:s));M.current=!0,U(n);const o=d.map(r=>({...r,discount_percentage:n}));C(o)},re=(s,n)=>{const o=[...d];o[s].discount_percentage=isNaN(n)?0:n,C(o)};c.useEffect(()=>{if(M.current){M.current=!1;return}const s=d.reduce((r,x)=>r+(x.total_price??0),0);if(s===0){U(0);return}const o=d.reduce((r,x)=>{const u=(x.total_price??0)*((x.discount_percentage??0)/100);return r+u},0)/s*100;U(r=>Math.abs(r-o)>.01?o:r)},[d]);const le=async()=>{if(!t)return N("No order data available to bill."),null;if(d.length===0)return N("Cannot bill an empty order."),null;$(!0),N(null);try{const s=d.map(a=>{const u=(a.pricePerLooseUnit??0)*(a.looseQuantity??0),y=u*((a.discount_percentage??0)/100),R=u-y;return{name:a.name,pack_quantity:a.loosePacks??0,loose_quantity:a.looseUnits??0,price:a.originalPrice??0,pack_price:a.originalPrice??0,loose_price:a.pricePerLooseUnit??0,total:R,drug_id:a.drug_id,discount_percentage:a.discount_percentage??0,batch:a.batch,expiry_date:a.expiry_date}}),n={patientId:t.patientId,queueId:t.id,items:s,amount:p,paymentMode:g,type:"pharmacy",related_id:t.id,status:"paid",discountPercentage:P},o=await j("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),r=await o.json();if(!o.ok||!r.id)throw new Error(r.message||"Failed to create bill.");const x=await j(`/api/pharmacy-orders/${t.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:r.id,medications:d})});if(!x.ok){const a=await x.text();throw new Error(`Failed to update pharmacy order status: ${x.statusText} - ${a}`)}if(L(a=>a?{...a,status:"billed",bill_id:r.id}:null),g==="credit")try{await j(`/api/patient-debts/${t.patientId}/debts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction_date:new Date().toISOString().split("T")[0],debt_value:p,related_bill_id:r.id,notes:`Pharmacy Bill #${r.id}`})})}catch(a){console.error("Failed to create debt entry:",a)}return m(`/dashboard/pharmacy-billing/${t.id}`,{replace:!0,state:{order:{...t,status:"billed",bill_id:r.id},initialItems:d}}),r.id}catch(s){return console.error("Billing process failed:",s),N(s.message||"Failed to mark order as billed. Please try again."),null}finally{$(!1)}},ce=async()=>{if(t)try{const s=await j(`/api/pharmacy-orders/${t.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"dispensed",medications:d})});if(!s.ok){const n=await s.text();console.error("Failed to dispense order:",n)}}catch(s){console.error("Error dispensing order:",s)}},de=()=>{window.print()},oe=async()=>{await le()&&(window.print(),await ce(),m(-1))};c.useEffect(()=>{const s=b.pathname.split("/"),n=s[s.length-1];n?(async()=>{try{k(!0);const[r,x,a]=await Promise.all([j(`/api/pharmacy-orders/${n}`),j("/api/drugs").then(l=>l.ok?l.json():null).catch(()=>null),j("/api/clinics/settings").then(l=>l.ok?l.json():null).catch(()=>null)]);if(!r.ok)throw new Error("Failed to fetch pharmacy order details");const u=await r.json();L(u);let y=[];x&&(y=x.drugs||x||[]),a&&(ee(a.upi_id||""),se(a.name||""),ie(a.address||""),te(a.notes||""));const R=u.medications.map(l=>{const E=ge(l.unit),V=(l.pack_quantity??0)*E+(l.loose_quantity??0),h=y.find(J=>l.drug_id&&String(J.id)===String(l.drug_id)||J.name.toLowerCase()===l.name.toLowerCase()),he=l.batch||(h==null?void 0:h.batch)||(h==null?void 0:h.batch_number),xe=l.expiry_date||(h==null?void 0:h.expiry_date),T=Number(l.pack_price)||Number(h==null?void 0:h.mrp)||0,G=Number(h==null?void 0:h.rate)||0;let f=Number(l.loose_price)||0;return f===0&&(T>0&&E>0?f=T/E:G>0&&(f=G)),{...l,isLoose:!0,loosePacks:l.pack_quantity??0,looseUnits:l.loose_quantity??0,looseQuantity:V,pack_price:T,loose_price:f,total_price:Number(l.total_price)||f*V,pricePerLooseUnit:f,originalPrice:T,discount_percentage:Number(l.discount_percentage)??0,directions_to_use:l.directions_to_use,tabletsPerDay:l.tabletsPerDay,numberOfDays:l.numberOfDays,batch:he,expiry_date:xe}});C(R)}catch(r){console.error("Failed to fetch data:",r),N(r.message||"Failed to load order details.")}finally{k(!1)}})():(N("No pharmacy order ID provided."),k(!1))},[b.pathname]);const D=c.useMemo(()=>d.reduce((s,n)=>s+(n.total_price??0),0),[d]),S=c.useMemo(()=>d.reduce((s,n)=>{const r=(n.total_price??0)*(n.discount_percentage??0)/100;return s+r},0),[d]),p=c.useMemo(()=>D-S,[D,S]);return c.useEffect(()=>{if(p>0&&F){const s=`upi://pay?pa=${F}&pn=ClinicName&am=${p.toFixed(2)}&cu=INR`;q(s)}else q("")},[p,F]),c.useEffect(()=>{(async()=>{if(g==="credit"&&(t!=null&&t.patientId)){Q(!0);try{const n=await j(`/api/patient-debts/${t.patientId}/balance`);if(n.ok){const o=await n.json();A(o.netDebt||0)}else A(0)}catch(n){console.error("Error fetching patient debt:",n),A(0)}finally{Q(!1)}}})()},[g,t==null?void 0:t.patientId]),K?e.jsx("div",{className:"pharmacy-billing-page",children:e.jsxs("div",{className:"billing-container",children:[e.jsxs("div",{className:"billing-header no-print",children:[e.jsx("div",{className:"back-button",children:e.jsx(i,{width:100,height:40,style:{borderRadius:"8px"}})}),e.jsx(i,{width:300,height:40})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("div",{className:"order-details-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(i,{width:150,height:24})})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsx("div",{className:"info-item",children:e.jsx(i,{width:200,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(i,{width:150,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(i,{width:180,height:20})}),e.jsx("div",{className:"info-item",children:e.jsx(i,{width:150,height:20})})]})]}),e.jsxs("div",{className:"medications-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(i,{width:120,height:24})})}),e.jsx("div",{className:"p-4",children:e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx(i,{width:30,height:20})}),e.jsx("th",{children:e.jsx(i,{width:150,height:20})}),e.jsx("th",{children:e.jsx(i,{width:80,height:20})}),e.jsx("th",{children:e.jsx(i,{width:80,height:20})}),e.jsx("th",{children:e.jsx(i,{width:100,height:20})}),e.jsx("th",{children:e.jsx(i,{width:60,height:20})})]})}),e.jsx("tbody",{children:[1,2,3,4].map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(i,{width:20,height:20})}),e.jsx("td",{children:e.jsx(i,{width:180,height:20})}),e.jsx("td",{children:e.jsx(i,{width:70,height:20})}),e.jsx("td",{children:e.jsx(i,{width:70,height:20})}),e.jsx("td",{children:e.jsx(i,{width:90,height:20})}),e.jsx("td",{children:e.jsx(i,{width:60,height:20})})]},s))})]})})]})]}),e.jsx("aside",{className:"billing-sidebar",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(i,{width:160,height:24})})}),e.jsxs("div",{className:"space-y-4 p-5",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(i,{width:100,height:20}),e.jsx(i,{width:80,height:20})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(i,{width:100,height:20}),e.jsx(i,{width:80,height:20})]}),e.jsx("hr",{}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(i,{width:120,height:28}),e.jsx(i,{width:100,height:28})]}),e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:"20px 0"},children:e.jsx(i,{width:150,height:150})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(i,{width:"100%",height:45,style:{borderRadius:"8px"}}),e.jsx(i,{width:"100%",height:45,style:{borderRadius:"8px"}}),e.jsx(i,{width:"100%",height:45,style:{borderRadius:"8px"}})]})]})]})})]})]})}):O?e.jsxs("div",{className:"error-message-box",children:["Error: ",O]}):t?e.jsx("div",{className:"pharmacy-billing-page",children:e.jsxs("div",{className:"billing-container printable-section",children:[e.jsxs("div",{className:"billing-header print-only",children:[e.jsx("div",{className:"clinic-header-left",children:e.jsx("div",{className:"clinic-info-print",children:e.jsxs("div",{className:"clinic-name-and-details-print",children:[e.jsx("h1",{className:"bill-title",children:"INVOICE"}),e.jsx("h2",{className:"clinic-name-print",children:z?`${z} Pharmacy`:"Pharmacy Bill"}),(I||B)&&e.jsxs("div",{className:"clinic-details-print",children:[I&&e.jsx("span",{className:"small-text clinic-address",children:I}),B&&e.jsx("span",{className:"small-text clinic-notes",children:B})]})]})})}),e.jsxs("div",{className:"patient-info-grid print-only-patient-details",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(H,{size:16})," Patient Name"]})," ",t.patientName]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Y,{size:16})," Token"]})," ",t.patientTokenNumber??"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(X,{size:16})," Order Date"]})," ",new Date(t.date).toLocaleDateString()]})]})]}),e.jsxs("header",{className:"billing-header no-print",children:[e.jsx("button",{onClick:()=>m(-1),className:"back-button",children:e.jsx(je,{className:"w-4 h-4"})}),e.jsx("h1",{children:"Pharmacy Bill"})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("section",{className:"order-details-card no-print",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Patient Information"})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(H,{size:16})," Patient Name"]})," ",t.patientName]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Y,{size:16})," Token"]})," ",t.patientTokenNumber??"N/A"]}),e.jsxs("div",{className:"info-item no-print",children:[e.jsxs("strong",{children:[e.jsx(me,{size:16})," Order ID"]})," ",t.id]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(X,{size:16})," Order Date"]})," ",new Date(t.date).toLocaleDateString()]})]})]}),e.jsxs("section",{className:"medications-card",children:[e.jsx("div",{className:"card-header no-print",children:e.jsx("h2",{children:"Medications"})}),d.length>0?e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"S.No."}),e.jsx("th",{children:"DESCRIPTION"}),e.jsx("th",{children:"BATCH"}),e.jsx("th",{children:"EXPIRY"}),e.jsx("th",{children:"QUANTITY"}),e.jsx("th",{children:"MRP"}),e.jsx("th",{children:"RATE"}),e.jsx("th",{children:"DIS %"}),e.jsx("th",{children:"GST%"}),e.jsx("th",{children:"AMT"})]})}),e.jsx("tbody",{children:d.map((s,n)=>{var u;const o=s.total_price??0,r=o*(s.discount_percentage??0)/100,x=o-r;return e.jsxs("tr",{children:[e.jsx("td",{children:n+1}),e.jsx("td",{children:s.name}),e.jsx("td",{children:s.batch||"N/A"}),e.jsx("td",{children:s.expiry_date?new Date(s.expiry_date).toLocaleDateString():"N/A"}),e.jsxs("td",{children:[e.jsxs("div",{children:["Packs: ",s.loosePacks??0]}),e.jsxs("div",{children:["Loose: ",s.looseUnits??0]})]}),e.jsx("td",{children:((u=s.originalPrice)==null?void 0:u.toFixed(2))??"N/A"}),e.jsx("td",{children:((s.pricePerLooseUnit??0)*(1-(s.discount_percentage??0)/100)).toFixed(2)}),e.jsxs("td",{children:[e.jsx("input",{type:"number",value:s.discount_percentage===0?"":s.discount_percentage,onChange:y=>re(n,parseFloat(y.target.value)),min:"0",max:"100",className:"discount-input-table"}),"%"]}),e.jsxs("td",{children:[5 .toFixed(1),"%"]}),e.jsx("td",{children:x.toFixed(2)})]},n)})})]}):e.jsx("p",{children:"No medications in this order."})]}),e.jsxs("div",{className:"bill-summary-print print-only",children:[e.jsxs("div",{className:"bill-summary-details",children:[e.jsxs("div",{className:"summary-row-print",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",D.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row-print",children:[e.jsxs("span",{children:["Total Discount (",P.toFixed(2),"%)"]}),e.jsxs("span",{children:["- ₹",S.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row-print",children:[e.jsx("span",{children:"GST (Included)"}),e.jsxs("span",{children:["₹",(p*.05).toFixed(2)]})]}),e.jsx("div",{className:"print-only-total",children:e.jsxs("strong",{children:["Grand Total: ₹",p.toFixed(2)]})})]}),w&&e.jsxs("div",{className:`qr-code-container qr-code-printable-section ${g!=="upi"?"hide-on-screen":""}`,children:[e.jsx(W,{value:w,size:100}),e.jsx("p",{className:"print-only-upi-text",children:"Scan to pay using UPI"})]})]})]}),e.jsx("aside",{className:"billing-sidebar no-print",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Billing Summary"})}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",D.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Total Discount"}),e.jsxs("span",{children:["- ₹",S.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Discount Percentage"}),e.jsxs("div",{className:"discount-input-wrapper",children:[e.jsx("input",{type:"number",value:P===0?"":P,onChange:s=>ne(parseFloat(s.target.value)),min:"0",max:"100",className:"discount-input-total",disabled:v||t.status==="billed"}),"%"]})]}),e.jsxs("div",{className:"summary-row grand-total-row",children:[e.jsx("strong",{children:"Grand Total"}),e.jsxs("strong",{children:["₹",p.toFixed(2)]})]}),e.jsx("div",{className:"qr-code-container",children:w?e.jsxs(e.Fragment,{children:[e.jsx(W,{value:w,size:128}),e.jsx("p",{children:"Scan to pay using UPI"})]}):e.jsx("p",{children:"UPI QR code not available. Please ensure UPI ID is configured."})}),e.jsxs("div",{className:"payment-mode-section",children:[e.jsx("label",{htmlFor:"paymentMode",className:"info-item",children:e.jsx("strong",{children:"Payment Mode"})}),e.jsxs("select",{id:"paymentMode",value:g,onChange:s=>Z(s.target.value),className:"payment-mode-select",disabled:v||t.status==="billed",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"no_cash_insurance",children:"No Cash Insurance"}),e.jsx("option",{value:"credit",children:"Credit (Debt to Patient)"})]})]}),g==="credit"&&e.jsxs("div",{className:"debt-info-section",style:{marginTop:"10px",padding:"12px",backgroundColor:"rgba(220, 53, 69, 0.1)",borderRadius:"8px",border:"1px solid rgba(220, 53, 69, 0.3)"},children:[e.jsx("div",{style:{fontWeight:"bold",color:"#dc3545",marginBottom:"8px"},children:"⚠️ Debt to Patient"}),ae?e.jsx("div",{style:{fontSize:"0.9em",color:"#666"},children:"Loading debt info..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"Current Debt:"}),e.jsxs("strong",{style:{color:_&&_>0?"#dc3545":"#28a745"},children:["₹",(_||0).toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"This Bill:"}),e.jsxs("strong",{children:["+ ₹",p.toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",borderTop:"1px solid rgba(220, 53, 69, 0.3)",paddingTop:"8px",marginTop:"8px"},children:[e.jsx("span",{children:e.jsx("strong",{children:"New Total Debt:"})}),e.jsxs("strong",{style:{color:"#dc3545"},children:["₹",((_||0)+p).toFixed(2)]})]})]})]}),e.jsxs("div",{className:"bill-actions",children:[t.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:de,className:"secondary-button print-preview-button no-print",disabled:v||d.length===0,children:"Print Preview"}),e.jsx("button",{onClick:oe,className:"primary-button",disabled:v||d.length===0,children:v?"Processing...":"Finalise and Bill"})]}),t.status==="billed"&&e.jsx("button",{onClick:()=>m(`/dashboard/bills/${t.bill_id}`),className:"secondary-button",children:"View Bill"})]})]})})]}),e.jsxs("footer",{className:"billing-footer print-only",children:[e.jsx("p",{children:"Thank you for your business!"}),e.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})}):e.jsx("div",{className:"error-message-box",children:"No order data available."})};export{De as default};
