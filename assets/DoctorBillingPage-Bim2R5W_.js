import{j as e,S as t,f as j}from"./index-DE8wu5Ou.js";import{u as xe,j as me,k as je,r as s}from"./react-vendor-Cc0P4_ZX.js";import{Q as L}from"./index-CZ6CIOFr.js";import{a7 as Q,af as _,u as J,W as ue,aC as pe}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const ge=500,De=()=>{const D=xe(),{queueId:C}=me(),[W]=je(),A=W.get("doctorId"),[c,G]=s.useState(null),[n,H]=s.useState(null),[$,V]=s.useState(null),[P,X]=s.useState(null),[m,Y]=s.useState([]),[K,I]=s.useState(!0),[M,u]=s.useState(null),[N,R]=s.useState(!1),[y,Z]=s.useState(!1),[U,ee]=s.useState(null),[p,se]=s.useState("cash"),[v,z]=s.useState(""),[F,ie]=s.useState(""),[B,te]=s.useState(""),[T,ne]=s.useState(""),[k,ae]=s.useState(""),[h,le]=s.useState(0),[w,q]=s.useState(null),[re,O]=s.useState(!1);s.useEffect(()=>{(async()=>{if(!C){u("No queue ID provided."),I(!1);return}try{I(!0),u(null);const[a,o]=await Promise.all([j(`/api/queue/${C}`),j("/api/clinics/settings").catch(()=>({ok:!1}))]);if(!a.ok)throw new Error("Failed to fetch queue entry");const r=await a.json();if(G(r),o.ok&&"json"in o){const d=await o.json();ie(d.upi_id||""),te(d.name||""),ne(d.address||""),ae(d.notes||"")}const l=A||r.doctor_id,[f,b]=await Promise.all([r.patient_id?j(`/api/patients/${r.patient_id}`).catch(()=>({ok:!1})):Promise.resolve({ok:!1}),l?j(`/api/staff/${l}`).catch(()=>({ok:!1})):Promise.resolve({ok:!1})]);if(f.ok&&"json"in f){const d=await f.json();H(d)}let E=ge;if(l&&(X(l),b.ok&&"json"in b)){const d=await b.json();V(d),d.opd_fee!=null&&!isNaN(parseFloat(String(d.opd_fee)))&&(E=parseFloat(String(d.opd_fee)))}Y([{name:"Consultation Fee",quantity:1,price:E,total:E,discount_percentage:0}])}catch(a){console.error("Failed to fetch data:",a),u(a.message||"Failed to load billing details.")}finally{I(!1)}})()},[C,A]);const g=s.useMemo(()=>m.reduce((i,a)=>i+a.total,0),[m]),S=s.useMemo(()=>g*(h/100),[g,h]),x=s.useMemo(()=>g-S,[g,S]);s.useEffect(()=>{if(x>0&&F){const i=`upi://pay?pa=${F}&pn=${encodeURIComponent(B)}&am=${x.toFixed(2)}&cu=INR`;z(i)}else z("")},[x,F,B]),s.useEffect(()=>{(async()=>{if(p==="credit"&&(n!=null&&n.id)){O(!0);try{const a=await j(`/api/patient-debts/${n.id}/balance`);if(a.ok){const o=await a.json();q(o.netDebt||0)}else q(0)}catch(a){console.error("Error fetching patient debt:",a),q(0)}finally{O(!1)}}})()},[p,n==null?void 0:n.id]);const ce=i=>{const a=Math.max(0,Math.min(100,isNaN(i)?0:i));le(a)},de=async()=>{if(!c||!n)return u("Missing queue or patient data."),null;if(m.length===0)return u("Cannot create an empty bill."),null;R(!0),u(null);try{const i=m.map(l=>({name:l.name,quantity:l.quantity,price:l.price,total:l.total*(1-h/100)})),a={patientId:n.id,queueId:c.id,items:i,amount:x,paymentMode:p,type:"consultation",related_id:c.id,status:"paid",discountPercentage:h},o=await j("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),r=await o.json();if(!o.ok||!r.id)throw new Error(r.message||"Failed to create bill.");if(p==="credit")try{await j(`/api/patient-debts/${n.id}/debts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction_date:new Date().toISOString().split("T")[0],debt_value:x,related_bill_id:r.id,notes:`Consultation Bill #${r.id}`})})}catch(l){console.error("Failed to create debt entry:",l)}if(P&&c.id)try{const l={status:"waiting",doctorId:P},f=await j(`/api/queue/${c.id}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(f.ok)console.log(`Doctor ${P} assigned to queue ${c.id} after billing.`);else{const b=await f.json();console.error("Failed to assign doctor to queue:",b.message)}}catch(l){console.error("Error assigning doctor to queue:",l)}return Z(!0),ee(r.id),alert(`Bill created successfully (ID: ${r.id})`),r.id}catch(i){return console.error("Billing process failed:",i),u(i.message||"Failed to create bill. Please try again."),null}finally{R(!1)}},oe=()=>{window.print()},he=async()=>{await de()&&(window.print(),D(-1))};return K?e.jsx("div",{className:"pharmacy-billing-page",children:e.jsxs("div",{className:"billing-container",children:[e.jsxs("div",{className:"billing-header no-print",children:[e.jsx("div",{className:"back-button",children:e.jsx(t,{width:80,height:32})}),e.jsx("h1",{children:e.jsx(t,{width:200,height:32})})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("div",{className:"order-details-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(t,{width:150,height:24})})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsx(t,{width:200,height:20}),e.jsx(t,{width:150,height:20}),e.jsx(t,{width:180,height:20}),e.jsx(t,{width:150,height:20})]})]}),e.jsxs("div",{className:"medications-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(t,{width:100,height:24})})}),e.jsxs("div",{className:"p-4 space-y-2",children:[e.jsx(t,{width:"100%",height:40}),e.jsx(t,{width:"100%",height:40}),e.jsx(t,{width:"100%",height:40})]})]})]}),e.jsx("aside",{className:"billing-sidebar",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(t,{width:150,height:24})})}),e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(t,{width:100,height:20}),e.jsx(t,{width:80,height:20})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(t,{width:100,height:20}),e.jsx(t,{width:80,height:20})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(t,{width:120,height:24}),e.jsx(t,{width:100,height:24})]}),e.jsx(t,{width:"100%",height:150})," ",e.jsx(t,{width:"100%",height:40}),e.jsx(t,{width:"100%",height:40})]})]})})]})]})}):M?e.jsxs("div",{className:"error-message-box",children:["Error: ",M]}):c?e.jsx("div",{className:"pharmacy-billing-page",children:e.jsxs("div",{className:"billing-container printable-section",children:[e.jsxs("div",{className:"billing-header print-only",children:[e.jsx("div",{className:"clinic-header-left",children:e.jsx("div",{className:"clinic-info-print",children:e.jsxs("div",{className:"clinic-name-and-details-print",children:[e.jsx("h1",{className:"bill-title",children:"TAX INVOICE"}),e.jsx("h2",{className:"clinic-name-print",children:B||"Clinic Bill"}),(T||k)&&e.jsxs("div",{className:"clinic-details-print",children:[T&&e.jsx("span",{className:"small-text clinic-address",children:T}),k&&e.jsx("span",{className:"small-text clinic-notes",children:k})]})]})})}),e.jsxs("div",{className:"patient-info-grid print-only-patient-details",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Q,{size:16})," Patient Name"]})," ",(n==null?void 0:n.name)||"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(_,{size:16})," Token"]})," ",c.token_no]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(J,{size:16})," Date"]})," ",new Date().toLocaleDateString()]})]})]}),e.jsxs("header",{className:"billing-header no-print",children:[e.jsx("button",{onClick:()=>D(-1),className:"back-button",children:e.jsx(ue,{size:20})}),e.jsx("h1",{children:"Consultation Bill"})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("section",{className:"order-details-card no-print",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Patient Information"})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Q,{size:16})," Patient Name"]})," ",(n==null?void 0:n.name)||"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(_,{size:16})," Token"]})," ",c.token_no]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(_,{size:16})," Patient ID"]})," ",(n==null?void 0:n.id)||"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(J,{size:16})," Date"]})," ",new Date().toLocaleDateString()]}),$&&e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(pe,{size:16})," Doctor"]})," ",$.name]}),c.complaint&&e.jsxs("div",{className:"info-item",children:[e.jsx("strong",{children:"Complaint"})," ",c.complaint]})]})]}),e.jsxs("section",{className:"medications-card",children:[e.jsx("div",{className:"card-header no-print",children:e.jsx("h2",{children:"Bill Items"})}),m.length>0?e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"S.No."}),e.jsx("th",{children:"DESCRIPTION"}),e.jsx("th",{children:"QTY"}),e.jsx("th",{children:"RATE"}),e.jsx("th",{children:"AMT"})]})}),e.jsx("tbody",{children:m.map((i,a)=>{const o=i.total*(h/100),r=i.total-o;return e.jsxs("tr",{children:[e.jsx("td",{children:a+1}),e.jsx("td",{children:i.name}),e.jsx("td",{children:i.quantity}),e.jsxs("td",{children:["₹",i.price.toFixed(2)]}),e.jsxs("td",{children:["₹",r.toFixed(2)]})]},a)})})]}):e.jsx("p",{children:"No items in this bill."})]}),e.jsxs("div",{className:"bill-summary-print print-only",children:[e.jsxs("div",{className:"bill-summary-details",children:[e.jsxs("div",{className:"summary-row-print",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",g.toFixed(2)]})]}),h>0&&e.jsxs("div",{className:"summary-row-print",children:[e.jsxs("span",{children:["Discount (",h.toFixed(2),"%)"]}),e.jsxs("span",{children:["- ₹",S.toFixed(2)]})]}),e.jsx("div",{className:"print-only-total",children:e.jsxs("strong",{children:["Grand Total: ₹",x.toFixed(2)]})})]}),v&&e.jsxs("div",{className:`qr-code-container qr-code-printable-section ${p!=="upi"?"hide-on-screen":""}`,children:[e.jsx(L,{value:v,size:100}),e.jsx("p",{className:"print-only-upi-text",children:"Scan to pay using UPI"})]})]})]}),e.jsx("aside",{className:"billing-sidebar no-print",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Billing Summary"})}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",g.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Discount"}),e.jsxs("span",{children:["- ₹",S.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Discount Percentage"}),e.jsxs("div",{className:"discount-input-wrapper",children:[e.jsx("input",{type:"number",value:h===0?"":h,onChange:i=>ce(parseFloat(i.target.value)),min:"0",max:"100",className:"discount-input-total",disabled:N||y}),"%"]})]}),e.jsxs("div",{className:"summary-row grand-total-row",children:[e.jsx("strong",{children:"Grand Total"}),e.jsxs("strong",{children:["₹",x.toFixed(2)]})]}),e.jsx("div",{className:"qr-code-container",children:v?e.jsxs(e.Fragment,{children:[e.jsx(L,{value:v,size:128}),e.jsx("p",{children:"Scan to pay using UPI"})]}):e.jsx("p",{children:"UPI QR code not available. Please ensure UPI ID is configured."})}),e.jsxs("div",{className:"payment-mode-section",children:[e.jsx("label",{htmlFor:"paymentMode",className:"info-item",children:e.jsx("strong",{children:"Payment Mode"})}),e.jsxs("select",{id:"paymentMode",value:p,onChange:i=>se(i.target.value),className:"payment-mode-select",disabled:N||y,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"no_cash_insurance",children:"No Cash Insurance"}),e.jsx("option",{value:"credit",children:"Credit (Debt to Patient)"})]})]}),p==="credit"&&e.jsxs("div",{className:"debt-info-section",style:{marginTop:"10px",padding:"12px",backgroundColor:"rgba(220, 53, 69, 0.1)",borderRadius:"8px",border:"1px solid rgba(220, 53, 69, 0.3)"},children:[e.jsx("div",{style:{fontWeight:"bold",color:"#dc3545",marginBottom:"8px"},children:"⚠️ Debt to Patient"}),re?e.jsx("div",{style:{fontSize:"0.9em",color:"#666"},children:"Loading debt info..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"Current Debt:"}),e.jsxs("strong",{style:{color:w&&w>0?"#dc3545":"#28a745"},children:["₹",(w||0).toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"This Bill:"}),e.jsxs("strong",{children:["+ ₹",x.toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",borderTop:"1px solid rgba(220, 53, 69, 0.3)",paddingTop:"8px",marginTop:"8px"},children:[e.jsx("span",{children:e.jsx("strong",{children:"New Total Debt:"})}),e.jsxs("strong",{style:{color:"#dc3545"},children:["₹",((w||0)+x).toFixed(2)]})]})]})]}),e.jsxs("div",{className:"bill-actions",children:[!y&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:oe,className:"secondary-button print-preview-button no-print",disabled:N||m.length===0,children:"Print Preview"}),e.jsx("button",{onClick:he,className:"primary-button",disabled:N||m.length===0,children:N?"Processing...":"Finalise and Bill"})]}),y&&U&&e.jsx("button",{onClick:()=>D(`/dashboard/bills/${U}`),className:"secondary-button",children:"View Bill"})]})]})})]}),e.jsxs("footer",{className:"billing-footer print-only",children:[e.jsx("p",{children:"Thank you for your visit!"}),e.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})}):e.jsx("div",{className:"error-message-box",children:"No queue data available."})};export{De as default};
