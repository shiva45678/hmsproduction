import{f as w,u as F,j as t,S as s}from"./index-CRA8Xzko.js";import{r,u as U}from"./react-vendor-Cc0P4_ZX.js";import z from"./lab-test-inventory-BsVt4dIR.js";/* empty css                           *//* empty css                   */import{h as H}from"./whatsappUtils-DTYJAZi5.js";import{f as W}from"./utils-vendor-azd6ta8e.js";import{E as G,W as q,H as J,a1 as K,a2 as Q,i as X,a3 as Y,y as Z}from"./ui-vendor-SmiJk_kJ.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";import"./ManageCustomColumnsModal-u3J9Zz5Q.js";const ht=()=>{const[b,C]=r.useState([]),[n,E]=r.useState(""),[d,y]=r.useState(!0),[L,B]=r.useState(!0),[h,k]=r.useState(null),[g,P]=r.useState("orders"),[i,x]=r.useState(1),[p]=r.useState(20),[j,S]=r.useState(0),f=r.useMemo(()=>Math.ceil(j/p),[j,p]),N=r.useCallback(async(e=1,l="")=>{y(!0),k(null);try{const a=new URLSearchParams({page:String(e),limit:String(p)});l&&a.append("search",l);const c=await w(`/api/lab?${a.toString()}`);if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const v=await c.json(),M=v.orders.map(o=>{var O,R;return{id:o.id,labTokenNumber:String(o.lab_token_number??"N/A"),patientName:((O=o.Patient)==null?void 0:O.name)||"N/A",patientId:o.patient_id,patientTokenNumber:String(((R=o.Patient)==null?void 0:R.patient_token_number)??"N/A"),tests:(o.tests||[]).map(V=>V.name||"Unknown Test"),date:W(new Date(o.createdAt),"yyyy-MM-dd"),status:o.status,reportId:o.reportId,billId:o.billId}});C(M),S(v.totalCount),x(e)}catch(a){console.error("Failed to fetch lab orders:",a),k(a instanceof Error?a.message:"An unknown error occurred"),C([]),S(0)}finally{y(!1),B(!1)}},[p]);r.useEffect(()=>{console.log(`Fetch effect triggered. Current page: ${i}, Search term: "${n}"`),n.length===0||n.length>=2?(console.log(`Condition met (length ${n.length}). Fetching orders...`),N(i,n)):console.log(`Condition not met (length ${n.length}). Not fetching.`)},[N,i,n]),r.useEffect(()=>{const e=setTimeout(()=>{n.length>=2?i!==1&&x(1):n.length<2&&i!==1&&x(1)},1e3);return()=>{clearTimeout(e)}},[n]);const u=async(e,l)=>{console.log(`Updating order ${e} to status ${l}`);try{const a=await w(`/api/lab/${e}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:l})});if(!a.ok){const c=await a.json();throw new Error(c.message||`Failed to update status: ${a.status}`)}if(l==="completed"){const c=await w(`/api/lab/orders/${e}/report`);if(c.ok){const v=await c.json();H(v)}}await N(i,n),console.log(`Order ${e} status updated to ${l}, refetching page ${i}`)}catch(a){console.error("Error updating status:",a),alert(`Failed to update status: ${a instanceof Error?a.message:"Unknown error"}`)}},{openCommandBar:A}=F(),m=U(),$=e=>{if(!e){console.error("Cannot navigate to billing: Order data is missing."),alert("Could not open billing page: Order information is missing.");return}e.billId?(console.log(`Navigating to existing bill for Bill ID: ${e.billId}, Patient: ${e.patientName}`),m("/billing",{state:{billId:e.billId,patientId:e.patientId,patientName:e.patientName,billType:"lab"}})):(console.log(`Navigating to LabBillingPage for Order ID: ${e.id}`),m(`/dashboard/lab-billing/${e.id}`))},I=e=>{e&&e.id?m(`/lab/report/${e.id}`):(console.error("Cannot navigate: Order or Order ID is missing."),alert("Could not open the report entry page: Order information is missing."))},T=e=>{switch(e){case"pending":return{text:"Billing Pending",className:"status-badge status-pending"};case"billed":return{text:"Sample Pending",className:"status-badge status-billed"};case"collected":return{text:"Sample Collected",className:"status-badge status-collected"};case"processing":return{text:"Processing",className:"status-badge status-processing"};case"report_ready":return{text:"Report Ready",className:"status-badge status-report_ready"};case"reported":return{text:"Reported",className:"status-badge status-reported"};case"completed":return{text:"Completed",className:"status-badge status-completed"};case"cancelled":return{text:"Cancelled",className:"status-badge status-cancelled"};default:return{text:e,className:"status-badge"}}};if(d&&L)return t.jsxs("div",{className:"admin-panel-container",children:[t.jsx("div",{className:"admin-nav-bar",children:[1,2,3,4].map(e=>t.jsx(s,{width:100,height:40,style:{borderRadius:"8px",margin:"0 8px"}},e))}),t.jsxs("div",{className:"admin-content-section",style:{padding:"20px"},children:[t.jsxs("div",{className:"flex justify-between items-center mb-6",children:[t.jsx(s,{width:200,height:32}),t.jsx(s,{width:300,height:40})]}),t.jsx("div",{className:"lab-orders-table-container",children:t.jsxs("table",{className:"lab-inventory-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:t.jsx(s,{width:100,height:20})}),t.jsx("th",{children:t.jsx(s,{width:150,height:20})}),t.jsx("th",{children:t.jsx(s,{width:100,height:20})}),t.jsx("th",{children:t.jsx(s,{width:100,height:20})}),t.jsx("th",{children:t.jsx(s,{width:150,height:20})})]})}),t.jsx("tbody",{children:[1,2,3,4,5].map(e=>t.jsxs("tr",{children:[t.jsx("td",{children:t.jsx(s,{width:120,height:20})}),t.jsx("td",{children:t.jsx(s,{width:180,height:20})}),t.jsx("td",{children:t.jsx(s,{width:100,height:20})}),t.jsx("td",{children:t.jsx(s,{width:80,height:24,style:{borderRadius:"12px"}})}),t.jsx("td",{children:t.jsx(s,{width:150,height:32})})]},e))})]})})]})]});if(h)return t.jsxs("div",{className:"flex flex-col items-center justify-center h-screen bg-red-50 text-red-700",children:[t.jsx(G,{size:48,className:"mb-4"}),t.jsx("h2",{className:"text-2xl font-semibold mb-2",children:"Error Loading Lab Data"}),t.jsx("p",{className:"mb-4",children:h}),t.jsx("button",{onClick:()=>N(1,""),className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Retry Fetch"})]});const D=()=>{i>1&&x(e=>e-1)},_=()=>{i<f&&x(e=>e+1)};return t.jsxs("div",{className:"admin-panel-container",children:[t.jsxs("div",{className:"admin-nav-bar",children:[t.jsxs("button",{onClick:()=>m(-1),className:"admin-nav-button",title:"Back",children:[t.jsx(q,{})," Back"]}),t.jsxs("button",{onClick:()=>P("orders"),className:`admin-nav-button ${g==="orders"?"active":""}`,children:[t.jsx(J,{})," Orders"]}),t.jsx("button",{onClick:()=>m("/create-lab-order"),className:"admin-nav-button",children:"Create New Lab Order"}),t.jsxs("button",{onClick:()=>P("inventory"),className:`admin-nav-button ${g==="inventory"?"active":""}`,children:[t.jsx(K,{})," Inventory"]}),t.jsxs("button",{onClick:()=>A(),className:"admin-nav-button",children:[t.jsx(Q,{})," Newton's AI"]})]}),t.jsx("div",{className:"admin-content-section",children:t.jsxs("main",{className:"flex-1 overflow-y-auto",style:{padding:"15px"},children:[g==="orders"&&t.jsxs("div",{className:"lab-orders-view",children:[" ",t.jsxs("div",{className:"lab-orders-header-controls",children:[t.jsx("h3",{className:"lab-orders-title",children:"Current Lab Orders"}),t.jsxs("div",{className:"lab-orders-search-container",children:[t.jsx("input",{type:"text",placeholder:"Search name, token, tests...",value:n,onChange:e=>E(e.target.value),className:"lab-inventory-input lab-orders-search-input"}),t.jsx(X,{size:18,className:"lab-orders-search-icon"})]})]}),t.jsx("div",{className:"lab-orders-table-container",children:t.jsxs("table",{className:"lab-inventory-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Patient (Token)"}),t.jsx("th",{children:"Tests"}),t.jsx("th",{className:"hidden md:table-cell",children:"Date"}),t.jsx("th",{children:"Status"}),t.jsx("th",{className:"lab-table-actions-header",children:"Actions"})]})}),t.jsxs("tbody",{children:[d&&!h&&b.length===0&&[1,2,3,4,5].map(e=>t.jsxs("tr",{children:[t.jsx("td",{children:t.jsx(s,{width:120,height:20})}),t.jsx("td",{children:t.jsx(s,{width:180,height:20})}),t.jsx("td",{children:t.jsx(s,{width:100,height:20})}),t.jsx("td",{children:t.jsx(s,{width:80,height:24,style:{borderRadius:"12px"}})}),t.jsx("td",{children:t.jsx(s,{width:150,height:32})})]},e)),!d&&!h&&b.length===0&&t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:"text-center py-10",children:n?`No lab orders found matching "${n}".`:"No lab orders available."})}),!d&&!h&&b.map(e=>{const l=T(e.status);return t.jsxs("tr",{children:[t.jsxs("td",{children:[t.jsx("div",{children:e.patientName}),t.jsxs("div",{className:"lab-table-patient-token",children:["Token: ",e.patientTokenNumber]})]}),t.jsx("td",{children:e.tests.map((a,c)=>t.jsx("div",{children:a},c))}),t.jsx("td",{className:"hidden md:table-cell",children:e.date}),t.jsx("td",{children:t.jsx("span",{className:l.className,children:l.text})}),t.jsx("td",{children:t.jsxs("div",{className:"lab-table-actions",children:[e.status==="pending"&&t.jsx("button",{onClick:()=>$(e),className:"lab-action-button btn-bill",title:"Generate Bill",children:"Bill"}),e.status==="billed"&&t.jsx("button",{onClick:()=>u(e.id,"collected"),className:"lab-action-button btn-collect",title:"Collect Sample",children:"Collect"}),e.status==="collected"&&t.jsx("button",{onClick:()=>u(e.id,"processing"),className:"lab-action-button btn-process",title:"Mark Processing",children:"Process"}),(e.status==="processing"||e.status==="report_ready"||e.status==="reported")&&t.jsx("button",{onClick:()=>I(e),className:"lab-action-button btn-enter-report",title:"Enter Report",children:"Enter Report"}),(e.status==="report_ready"||e.status==="reported")&&t.jsx("button",{onClick:()=>u(e.id,"completed"),className:"lab-action-button btn-complete",title:"Mark Completed",children:"Complete"}),(e.status==="completed"||e.status==="report_ready"||e.status==="reported")&&t.jsx("button",{onClick:()=>{e.id?m(`/lab/view-report/${e.id}`):(console.error("Attempted to view report for an order with no ID:",e),alert("Cannot view report: Order ID is missing."))},className:"lab-action-button btn-view-report",title:"View Report",children:"View"})]})})]},e.id)})]})]})}),t.jsxs("div",{className:"lab-orders-card-container",children:[d&&!h&&b.length===0&&t.jsx("div",{className:"space-y-4",children:[1,2,3].map(e=>t.jsx("div",{className:"lab-order-card",children:t.jsx(s,{width:"100%",height:150})},e))}),!d&&!h&&b.length===0&&t.jsx("div",{className:"text-center py-10",children:n?`No lab orders found matching "${n}".`:"No lab orders available."}),!d&&!h&&b.map(e=>{const l=T(e.status);return t.jsxs("div",{className:"lab-order-card",children:[t.jsxs("div",{className:"lab-card-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"lab-card-patient-name",children:e.patientName}),t.jsxs("div",{className:"lab-card-patient-token",children:["Token: ",e.patientTokenNumber]}),t.jsx("div",{className:"lab-card-date",children:e.date})]}),t.jsx("span",{className:`${l.className} lab-card-status-pill`,children:l.text})]}),t.jsxs("div",{className:"lab-card-section",children:[t.jsx("p",{className:"lab-card-section-title",children:"Tests:"}),e.tests.map((a,c)=>t.jsx("div",{className:"lab-card-test-item",children:a},c)),e.tests.length===0&&t.jsx("div",{className:"lab-card-no-tests",children:"No tests listed."})]}),t.jsxs("div",{className:"lab-card-actions",children:[e.status==="pending"&&t.jsx("button",{onClick:()=>$(e),className:"lab-action-button btn-bill",title:"Generate Bill",children:"Bill"}),e.status==="billed"&&t.jsx("button",{onClick:()=>u(e.id,"collected"),className:"lab-action-button btn-collect",title:"Collect Sample",children:"Collect"}),e.status==="collected"&&t.jsx("button",{onClick:()=>u(e.id,"processing"),className:"lab-action-button btn-process",title:"Mark Processing",children:"Process"}),(e.status==="processing"||e.status==="report_ready"||e.status==="reported")&&t.jsx("button",{onClick:()=>I(e),className:"lab-action-button btn-enter-report",title:"Enter Report",children:"Enter Report"}),(e.status==="report_ready"||e.status==="reported")&&t.jsx("button",{onClick:()=>u(e.id,"completed"),className:"lab-action-button btn-complete",title:"Mark Completed",children:"Complete"}),(e.status==="completed"||e.status==="report_ready"||e.status==="reported")&&t.jsx("button",{onClick:()=>{e.id?m(`/lab/view-report/${e.id}`):(console.error("Attempted to view report for an order with no ID:",e),alert("Cannot view report: Order ID is missing."))},className:"lab-action-button btn-view-report",title:"View Report",children:"View"})]})]},e.id)})]}),!d&&j>0&&t.jsxs("div",{className:"lab-pagination-controls",children:[t.jsxs("div",{className:"lab-pagination-info",children:["Showing"," ",t.jsx("strong",{children:(i-1)*p+1})," ","to"," ",t.jsx("strong",{children:Math.min(i*p,j)})," ","of"," ",t.jsx("strong",{children:j})," ","results"]}),t.jsxs("div",{className:"lab-pagination-buttons",children:[t.jsx("button",{onClick:D,disabled:i===1,className:"lab-pagination-button","aria-label":"Previous page",children:t.jsx(Y,{size:18})}),t.jsxs("span",{children:["Page ",i," of ",f]}),t.jsx("button",{onClick:_,disabled:i===f,className:"lab-pagination-button","aria-label":"Next page",children:t.jsx(Z,{size:18})})]})]})]}),g==="inventory"&&t.jsxs("div",{className:"lab-inventory-content-wrapper",children:[" ",t.jsx(z,{})]})]})})," "]})};export{ht as default};
