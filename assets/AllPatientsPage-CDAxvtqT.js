import{y as je,d as ge,f as c,j as e,S as r,q as _}from"./index-DCOSVs-d.js";import{u as be,r as n,b as fe}from"./react-vendor-Cc0P4_ZX.js";import{u as ye}from"./useAutoFocusSingleInput-6a_v4dYJ.js";import{M as Ne}from"./ManageCustomColumnsModal-C5F-05W9.js";import{W as we,a7 as Se,i as ve,ax as Ce,ai as Pe,aj as V,ay as Z,a3 as ke,y as Ee,X as _e}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const A=15,ze=()=>{const F=be(),{customColumnsConfig:y,refetch:ee}=je(),[se,$]=n.useState(!1),[z,M]=n.useState([]),[T,L]=n.useState(!0),[R,I]=n.useState(null),[N,te]=n.useState(""),[l,x]=n.useState(1),[w,U]=n.useState(1),[G,K]=n.useState(0),[d,ae]=n.useState("created_at"),S=ge(),ne=s=>{s&&(S.prefetchQuery({queryKey:_.patients.context(s),queryFn:async()=>{const t=await c(`/api/patients/${s}/context`);if(!t.ok)throw new Error("Failed to fetch patient context");return t.json()},staleTime:5*60*1e3}),S.prefetchQuery({queryKey:_.patientDebts.balance(s),queryFn:async()=>{const t=await c(`/api/patient-debts/${s}/balance`);return t.ok?t.json():{netDebt:0}},staleTime:1*60*1e3}),S.prefetchQuery({queryKey:_.queue.latest(s),queryFn:async()=>{const t=await c(`/api/queue/patient/${s}/latest`);if(!t.ok)throw new Error("Failed to fetch latest queue status");const a=await t.json();return a!=null&&a._id&&S.prefetchQuery({queryKey:_.queue.entry(a._id),queryFn:async()=>{const i=await c(`/api/queue/doctor/complaint/${a._id}`);if(!i.ok)throw new Error("Failed to fetch complaint record");return i.json()},staleTime:1*60*1e3}),a},staleTime:5e3}))},[h,re]=n.useState("desc"),[m,ie]=n.useState(""),[le,oe]=n.useState(!1),[v,ce]=n.useState(null),[u,Q]=n.useState([]),[j,W]=n.useState(""),[C,D]=n.useState(!1),[J,g]=n.useState(null),[P,Y]=n.useState(!0),[p,X]=n.useState(null),[b,de]=n.useState(N);ye(),n.useEffect(()=>{const s=setTimeout(()=>{de(N),x(1)},500);return()=>{clearTimeout(s)}},[N]);const B=n.useCallback(async()=>{Y(!0),X(null);try{const s=await c("/api/subscriptions");if(!s.ok){let a=`Failed to fetch subscription plans (${s.status})`;try{a=(await s.json()).message||a}catch{}throw new Error(a)}const t=await s.json();Q(t)}catch(s){console.error("Error fetching subscription plans:",s),X(s.message||"An unknown error occurred while fetching plans."),Q([])}finally{Y(!1)}},[]),k=n.useCallback(async(s,t,a,i,f)=>{L(!0),I(null);try{const o=new URLSearchParams({page:s.toString(),limit:A.toString(),sortBy:a,sortOrder:i});t&&o.append("search",t),f&&o.append("gender",f);const q=await c(`/api/patients?${o.toString()}`);if(!q.ok){const me=await q.json();throw new Error(me.message||"Failed to fetch patients")}const E=await q.json();M(E.patients),K(E.totalCount),x(E.currentPage),U(E.totalPages)}catch(o){console.error("Error fetching patients:",o),I(`Failed to load patients: ${o.message}`),M([]),K(0),x(1),U(1)}finally{L(!1)}},[]);n.useEffect(()=>{k(l,b,d,h,m),B()},[l,b,d,h,m,k,B]);const H=s=>{const t=d===s&&h==="asc"?"desc":"asc";ae(s),re(t),x(1)},he=s=>{try{return new Date(s).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"})}catch{return"Invalid Date"}},O=()=>{oe(!1),ce(null),W(""),g(null),D(!1)},ue=async(s,t)=>{M(a=>a.map(i=>i.id===s?{...i,insurance_type:t}:i));try{const a=await c(`/api/patients/${s}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({insurance_type:t})});if(!a.ok){const i=await a.json();throw new Error(i.message||"Failed to update insurance type")}}catch(a){console.error("Error updating insurance type:",a),k(l,b,d,h,m)}},pe=(s,t)=>{const a=new Date(s),i=t.interval||1;switch(t.period){case"daily":a.setDate(s.getDate()+i);break;case"weekly":a.setDate(s.getDate()+i*7);break;case"monthly":a.setMonth(s.getMonth()+i);break;case"yearly":a.setFullYear(s.getFullYear()+i);break;default:console.warn(`Unknown subscription period: ${t.period}. Defaulting to 1 month.`),a.setMonth(s.getMonth()+1)}return a},xe=async()=>{if(!v||!j){g("Please select a subscription plan.");return}const s=u.find(t=>t.id===j);if(!s){g("Selected plan details not found.");return}D(!0),g(null);try{const t=new Date,a=pe(t,s),i={subscription_plan_id:j,subscription_status:"active",subscription_start_date:t.toISOString(),subscription_end_date:a.toISOString(),subscription_payment_method:"manual"},f=await c(`/api/patients/${v.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!f.ok){const o=await f.json();throw new Error(o.message||"Failed to update patient subscription")}O(),k(l,b,d,h,m)}catch(t){console.error("Error starting subscription:",t),g(`Failed to start subscription: ${t.message}`)}finally{D(!1)}};return e.jsxs("div",{className:"all-patients-container",children:[e.jsx("button",{onClick:()=>F(-1),className:"back-button",children:e.jsx(we,{size:16})}),e.jsxs("h1",{className:"all-patients-title",children:[e.jsx(Se,{size:28}),"All Registered Patients"]}),R&&e.jsxs("div",{className:"error-alert",role:"alert",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:R})]}),e.jsxs("div",{className:"subscription-plans-card",children:[e.jsx("h2",{className:"subscription-plans-title",children:"Available Subscription Plans"}),e.jsx("div",{children:P?e.jsx("p",{className:"loading-state",children:"Loading plans..."}):p?e.jsxs("p",{className:"error-message",children:["Error loading plans: ",p]}):u.length===0?e.jsx("p",{className:"empty-state",children:"No active subscription plans found."}):e.jsx("ul",{className:"subscription-plans-list",children:u.map(s=>e.jsxs("li",{children:[e.jsx("strong",{children:s.name}),": ₹",s.price," / ",s.interval," ",s.period,s.interval>1?"s":"",s.description&&e.jsx("span",{className:"plan-description",children:s.description})]},s.id))})})]}),e.jsxs("div",{className:"controls-container",children:[e.jsxs("div",{className:"search-input-wrapper",children:[e.jsx("input",{type:"text",placeholder:"Search by name or phone...",className:"search-input",value:N,onChange:s=>te(s.target.value)}),e.jsx(ve,{className:"search-input-icon",size:20})]}),e.jsxs("div",{className:"filter-dropdown-wrapper",children:[e.jsx("label",{htmlFor:"genderFilter",className:"sr-only",children:"Filter by Gender"}),e.jsxs("div",{className:"filter-select-container",children:[e.jsx(Ce,{size:16,className:"filter-select-icon"}),e.jsxs("select",{id:"genderFilter",value:m,onChange:s=>ie(s.target.value),className:"filter-select",children:[e.jsx("option",{value:"",children:"All Genders"}),e.jsx("option",{value:"M",children:"Male"}),e.jsx("option",{value:"F",children:"Female"}),e.jsx("option",{value:"O",children:"Other"})]})]})]}),e.jsxs("button",{onClick:()=>$(!0),className:"action-button",title:"Manage Custom Columns",children:[e.jsx(Pe,{size:16})," Columns"]})]}),T?e.jsx("div",{className:"patients-table-wrapper",children:e.jsxs("table",{className:"patients-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx(r,{width:50,height:20})}),e.jsx("th",{children:e.jsx(r,{width:100,height:20})}),e.jsx("th",{children:e.jsx(r,{width:40,height:20})}),e.jsx("th",{children:e.jsx(r,{width:60,height:20})}),e.jsx("th",{children:e.jsx(r,{width:100,height:20})}),e.jsx("th",{children:e.jsx(r,{width:150,height:20})}),e.jsx("th",{children:e.jsx(r,{width:100,height:20})}),e.jsx("th",{children:e.jsx(r,{width:120,height:20})}),e.jsx("th",{children:e.jsx(r,{width:100,height:20})}),e.jsx("th",{children:e.jsx(r,{width:80,height:20})})]})}),e.jsx("tbody",{children:[1,2,3,4,5,6,7,8].map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(r,{width:40,height:20})}),e.jsx("td",{className:"patient-name",children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx(r,{variant:"circular",width:24,height:24}),e.jsx(r,{width:120,height:20})]})}),e.jsx("td",{children:e.jsx(r,{width:30,height:20})}),e.jsx("td",{children:e.jsx(r,{width:30,height:20})}),e.jsx("td",{children:e.jsx(r,{width:100,height:20})}),e.jsx("td",{children:e.jsx(r,{width:150,height:20})}),e.jsx("td",{children:e.jsx(r,{width:100,height:20})}),e.jsx("td",{children:e.jsx(r,{width:80,height:24,style:{borderRadius:"12px"}})}),e.jsx("td",{children:e.jsx(r,{width:100,height:32})}),e.jsx("td",{children:e.jsx(r,{width:80,height:32,style:{borderRadius:"4px"}})})]},s))})]})}):z.length===0?e.jsx("div",{className:"empty-state",children:b?"No patients found matching your search.":"No patients registered yet."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"patients-table-wrapper",children:e.jsxs("table",{className:"patients-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Token"}),e.jsxs("th",{className:"sortable-header",onClick:()=>H("name"),children:["Name",d==="name"&&(h==="asc"?e.jsx(V,{size:14,className:"sort-icon"}):e.jsx(Z,{size:14,className:"sort-icon"}))]}),e.jsx("th",{children:"Age"}),e.jsx("th",{children:"Gender"}),e.jsx("th",{children:"Phone"}),e.jsx("th",{children:"Address"}),e.jsxs("th",{className:"sortable-header",onClick:()=>H("created_at"),children:["Registered On",d==="created_at"&&(h==="asc"?e.jsx(V,{size:14,className:"sort-icon"}):e.jsx(Z,{size:14,className:"sort-icon"}))]}),e.jsx("th",{children:"Subscription Status"}),e.jsx("th",{children:"Insurance Type"})," ",e.jsx("th",{children:"Action"})," "]})}),e.jsx("tbody",{children:z.map(s=>e.jsxs(fe.Fragment,{children:[e.jsxs("tr",{children:[e.jsx("td",{children:s.token??"-"}),e.jsx("td",{className:"patient-name",children:s.name}),e.jsx("td",{children:s.age??"-"}),e.jsx("td",{children:s.gender??"-"}),e.jsx("td",{children:s.phone??"-"}),e.jsx("td",{children:s.address??"-"}),e.jsx("td",{children:he(s.created_at)}),e.jsx("td",{children:e.jsx("span",{className:`status-badge ${s.subscription_status==="active"?"active":s.subscription_status==="cancelled"||s.subscription_status==="expired"?"inactive":"none"}`,children:s.subscription_status??"None"})}),e.jsx("td",{children:e.jsxs("select",{value:s.insurance_type,onChange:t=>ue(s.id,t.target.value),className:"form-select insurance-select",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"insurance",children:"Insurance"}),e.jsx("option",{value:"no_cash_insurance",children:"No Cash Insurance"})]})}),e.jsxs("td",{children:[e.jsx("button",{onClick:()=>F(`/start-subscription/${s.id}`),className:"action-button",children:"Start Sub"}),e.jsx("button",{onClick:()=>F(`/dashboard/edit-complaint/patient/${s.id}`),onMouseEnter:()=>ne(s.id),className:"action-button",style:{marginLeft:"8px",backgroundColor:"#e0f2fe",color:"#0369a1",border:"1px solid #bae6fd"},children:"OPD"})]})]}),y.patients&&y.patients.length>0&&e.jsx("tr",{children:e.jsx("td",{colSpan:10,style:{padding:"0 15px 15px 15px",borderTop:"none"},children:e.jsx("div",{style:{padding:"10px",backgroundColor:"#f9f9f9",borderRadius:"4px",display:"flex",flexWrap:"wrap",gap:"15px"},children:y.patients.map(t=>{var a;return e.jsxs("div",{style:{fontSize:"0.9em"},children:[e.jsxs("strong",{style:{color:"#555"},children:[t.label,":"]})," ",(a=s.custom_fields)!=null&&a[t.key]?String(s.custom_fields[t.key]):"-"]},t.key)})})})})]},s.id))})]})}),w>1&&e.jsxs("div",{className:"pagination-controls",children:[e.jsxs("div",{className:"pagination-info",children:["Showing"," ",e.jsx("span",{className:"font-medium",children:(l-1)*A+1})," ","to"," ",e.jsx("span",{className:"font-medium",children:Math.min(l*A,G)})," ","of"," ",e.jsx("span",{className:"font-medium",children:G})," results"]}),e.jsxs("div",{className:"pagination-buttons",children:[e.jsxs("button",{onClick:()=>x(s=>Math.max(s-1,1)),disabled:l===1||T,className:"pagination-button",children:[e.jsx(ke,{size:16,className:"prev-icon"}),"Previous"]}),e.jsxs("span",{className:"pagination-current-page",children:["Page ",e.jsx("span",{className:"font-medium",children:l})," of ",e.jsx("span",{className:"font-medium",children:w})]}),e.jsxs("button",{onClick:()=>x(s=>Math.min(s+1,w)),disabled:l===w||T,className:"pagination-button",children:["Next",e.jsx(Ee,{size:16,className:"next-icon"})]})]})]})]}),le&&v&&e.jsx("div",{className:"subscription-modal-overlay",children:e.jsxs("div",{className:"subscription-modal-content",children:[e.jsxs("div",{className:"subscription-modal-header",children:[e.jsxs("h2",{className:"subscription-modal-title",children:["Start Subscription for ",v.name]}),e.jsx("button",{onClick:O,className:"subscription-modal-close-button",children:e.jsx(_e,{size:24})})]}),J&&e.jsx("div",{className:"error-alert",role:"alert",children:e.jsx("span",{children:J})}),e.jsxs("div",{className:"subscription-modal-body",children:[e.jsx("label",{htmlFor:"subscriptionPlan",className:"form-label",children:"Select Plan:"}),e.jsxs("select",{id:"subscriptionPlan",value:j,onChange:s=>W(s.target.value),className:"form-select",disabled:C||P||p!==null||u.length===0,children:[e.jsx("option",{value:"",disabled:!0,children:"-- Select a Plan --"}),P?e.jsx("option",{value:"",disabled:!0,children:"Loading plans..."}):p?e.jsx("option",{value:"",disabled:!0,children:"Error loading plans"}):u.length>0?u.map(s=>e.jsxs("option",{value:s.id,children:[s.name," - ₹",s.price," (",s.interval," ",s.period,s.interval>1?"s":"",")"]},s.id)):e.jsx("option",{value:"",disabled:!0,children:"No active plans found"})]}),p&&e.jsx("p",{className:"error-message",children:p}),u.length===0&&!P&&!p&&e.jsx("p",{className:"empty-state",children:"No active subscription plans available."})]}),e.jsxs("div",{className:"subscription-modal-footer",children:[e.jsx("button",{onClick:O,disabled:C,className:"subscription-modal-button cancel",children:"Cancel"}),e.jsx("button",{onClick:xe,disabled:!j||C,className:"subscription-modal-button submit",children:C?"Starting...":"Start Subscription"})]})]})}),e.jsx(Ne,{isOpen:se,onClose:()=>$(!1),entityType:"patients",entityLabel:"Patients",currentConfig:y,onConfigUpdated:()=>{ee()}})]})};export{ze as default};
