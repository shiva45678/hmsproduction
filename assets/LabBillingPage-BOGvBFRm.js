import{j as e,S as r,f as m}from"./index-DE8wu5Ou.js";import{u as de,f as oe,r as a}from"./react-vendor-Cc0P4_ZX.js";import{Q as V}from"./index-CZ6CIOFr.js";/* empty css                            */import{a7 as J,af as Q,u as W,W as he,F as pe}from"./ui-vendor-SmiJk_kJ.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";import"./chart-vendor-BcjzKorn.js";const ye=()=>{const N=de(),S=oe(),[n,L]=a.useState(null),[E,G]=a.useState(""),[A,H]=a.useState(""),[o,P]=a.useState([]),[K,U]=a.useState(!0),[M,u]=a.useState(null),[b,$]=a.useState(!1),[x,X]=a.useState("cash"),[f,O]=a.useState(""),[D,Y]=a.useState(""),[R,Z]=a.useState(""),[_,ee]=a.useState(""),[C,se]=a.useState(""),[z,te]=a.useState(""),[y,F]=a.useState(0),I=a.useRef(!1),[v,k]=a.useState(null),[ie,q]=a.useState(!1),ae=s=>{const i=Math.max(0,Math.min(100,isNaN(s)?0:s));I.current=!0,F(i);const c=o.map(t=>({...t,discount_percentage:i}));P(c)},ne=(s,i)=>{const c=[...o];c[s].discount_percentage=isNaN(i)?0:i,P(c)};a.useEffect(()=>{if(I.current){I.current=!1;return}const s=o.reduce((t,h)=>t+(h.price??0),0);if(s===0){F(0);return}const c=o.reduce((t,h)=>{const j=(h.price??0)*((h.discount_percentage??0)/100);return t+j},0)/s*100;F(t=>Math.abs(t-c)>.01?c:t)},[o]);const le=async()=>{if(!n)return u("No order data available to bill."),null;if(o.length===0)return u("Cannot bill an empty order."),null;$(!0),u(null);try{const s=o.map(l=>{const j=l.price,g=j*((l.discount_percentage??0)/100),B=j-g;return{name:l.name,price:l.price,quantity:1,total:B,item_id:l.id,type:"lab_test",discount_percentage:l.discount_percentage??0}}),i={patientId:n.patient_id,items:s,amount:p,paymentMode:x,type:"lab",related_id:n.id,status:"paid",discountPercentage:y},c=await m("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),t=await c.json();if(!c.ok||!t.id)throw new Error(t.message||"Failed to create bill.");const h=await m(`/api/lab/${n.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"billed",bill_id:t.id})});if(!h.ok){const l=await h.text();throw new Error(`Failed to update lab order status: ${h.statusText} - ${l}`)}if(L(l=>l?{...l,status:"billed",bill_id:t.id}:null),x==="credit")try{await m(`/api/patient-debts/${n.patient_id}/debts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction_date:new Date().toISOString().split("T")[0],debt_value:p,related_bill_id:t.id,notes:`Lab Bill #${t.id}`})})}catch(l){console.error("Failed to create debt entry:",l)}return alert(`Lab Order bill created (ID: ${t.id}) and marked as billed.`),N(`/dashboard/lab-billing/${n.id}`,{replace:!0,state:{...S.state,order:{...n,status:"billed",bill_id:t.id}}}),t.id}catch(s){return console.error("Billing process failed:",s),u(s.message||"Failed to mark order as billed. Please try again."),null}finally{$(!1)}},re=()=>{window.print()},ce=async()=>{await le()&&(window.print(),N(-1))};a.useEffect(()=>{const s=S.pathname.split("/"),i=s[s.length-1];i?(async()=>{try{const[t,h]=await Promise.all([m(`/api/lab/${i}`),m("/api/clinics/settings").catch(()=>({ok:!1}))]);if(!t.ok)throw new Error("Failed to fetch lab order details");const l=await t.json();L(l);const j=l.patient_id?m(`/api/patients/${l.patient_id}`).catch(()=>({ok:!1})):Promise.resolve({ok:!1});if(h.ok&&"json"in h){const d=await h.json();Y(d.upi_id||""),Z(d.name||""),ee(d.address||""),se(d.notes||""),te(d.labLetterheadUrl||"")}const g=await j;if(g.ok&&"json"in g){const d=await g.json();G(d.name),H(d.patient_token_number)}const B=l.tests.map(d=>({...d,price:typeof d.price=="string"?parseFloat(d.price):Number(d.price)||0,discount_percentage:0,total_price:typeof d.price=="string"?parseFloat(d.price):Number(d.price)||0}));P(B)}catch(t){console.error("Failed to fetch data:",t),u(t.message||"Failed to load order details.")}finally{U(!1)}})():(u("No lab order ID provided."),U(!1))},[S.pathname]);const w=a.useMemo(()=>o.reduce((s,i)=>s+(i.price??0),0),[o]),T=a.useMemo(()=>o.reduce((s,i)=>{const t=(i.price??0)*(i.discount_percentage??0)/100;return s+t},0),[o]),p=a.useMemo(()=>w-T,[w,T]);return a.useEffect(()=>{if(p>0&&D){const s=`upi://pay?pa=${D}&pn=ClinicName&am=${p.toFixed(2)}&cu=INR`;O(s)}else O("")},[p,D]),a.useEffect(()=>{(async()=>{if(x==="credit"&&(n!=null&&n.patient_id)){q(!0);try{const i=await m(`/api/patient-debts/${n.patient_id}/balance`);if(i.ok){const c=await i.json();k(c.netDebt||0)}else k(0)}catch(i){console.error("Error fetching patient debt:",i),k(0)}finally{q(!1)}}})()},[x,n==null?void 0:n.patient_id]),K?e.jsx("div",{className:"pharmacy-billing-page",children:e.jsxs("div",{className:"billing-container",children:[e.jsxs("div",{className:"billing-header no-print",children:[e.jsx("div",{className:"back-button",children:e.jsx(r,{width:80,height:32})}),e.jsx("h1",{children:e.jsx(r,{width:200,height:32})})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("div",{className:"order-details-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(r,{width:150,height:24})})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsx(r,{width:200,height:20}),e.jsx(r,{width:150,height:20}),e.jsx(r,{width:180,height:20}),e.jsx(r,{width:150,height:20})]})]}),e.jsxs("div",{className:"medications-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(r,{width:100,height:24})})}),e.jsxs("div",{className:"p-4 space-y-2",children:[e.jsx(r,{width:"100%",height:40}),e.jsx(r,{width:"100%",height:40}),e.jsx(r,{width:"100%",height:40})]})]})]}),e.jsx("aside",{className:"billing-sidebar",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:e.jsx(r,{width:150,height:24})})}),e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(r,{width:100,height:20}),e.jsx(r,{width:80,height:20})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(r,{width:100,height:20}),e.jsx(r,{width:80,height:20})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(r,{width:120,height:24}),e.jsx(r,{width:100,height:24})]}),e.jsx(r,{width:"100%",height:150})," ",e.jsx(r,{width:"100%",height:40}),e.jsx(r,{width:"100%",height:40})]})]})})]})]})}):M?e.jsxs("div",{className:"error-message-box",children:["Error: ",M]}):n?e.jsxs("div",{className:"pharmacy-billing-page",children:[" ",e.jsxs("div",{className:"billing-container printable-section",children:[z&&e.jsx("div",{className:"print-only print-letterhead-container",children:e.jsx("img",{src:z,alt:"Lab Letterhead",className:"print-letterhead-image"})}),e.jsxs("div",{className:"billing-header print-only",children:[e.jsx("div",{className:"clinic-header-left",children:e.jsx("div",{className:"clinic-info-print",children:e.jsxs("div",{className:"clinic-name-and-details-print",children:[e.jsx("h1",{className:"bill-title",children:"INVOICE"}),e.jsx("h2",{className:"clinic-name-print",children:R?`${R} Lab`:"Lab Bill"}),(_||C)&&e.jsxs("div",{className:"clinic-details-print",children:[_&&e.jsx("span",{className:"small-text clinic-address",children:_}),C&&e.jsx("span",{className:"small-text clinic-notes",children:C})]})]})})}),e.jsxs("div",{className:"patient-info-grid print-only-patient-details",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(J,{size:16})," Patient Name"]})," ",E]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Q,{size:16})," Token"]})," ",A??"N/A"]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(W,{size:16})," Order Date"]})," ",new Date(n.createdAt).toLocaleDateString()]})]})]}),e.jsxs("header",{className:"billing-header no-print",children:[e.jsx("button",{onClick:()=>N(-1),className:"back-button",children:e.jsx(he,{size:20})}),e.jsx("h1",{children:"Lab Bill"})]}),e.jsxs("div",{className:"billing-layout",children:[e.jsxs("main",{className:"order-content",children:[e.jsxs("section",{className:"order-details-card no-print",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Patient Information"})}),e.jsxs("div",{className:"patient-info-grid",children:[e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(J,{size:16})," Patient Name"]})," ",E]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(Q,{size:16})," Token"]})," ",A??"N/A"]}),e.jsxs("div",{className:"info-item no-print",children:[e.jsxs("strong",{children:[e.jsx(pe,{size:16})," Order ID"]})," ",n.id]}),e.jsxs("div",{className:"info-item",children:[e.jsxs("strong",{children:[e.jsx(W,{size:16})," Order Date"]})," ",new Date(n.createdAt).toLocaleDateString()]})]})]}),e.jsxs("section",{className:"medications-card",children:[e.jsx("div",{className:"card-header no-print",children:e.jsx("h2",{children:"Lab Tests"})}),o.length>0?e.jsxs("table",{className:"medications-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"S.No."}),e.jsx("th",{children:"TEST DESCRIPTION"}),e.jsx("th",{children:"PRICE"}),e.jsx("th",{children:"DIS %"}),e.jsx("th",{children:"AMT"})]})}),e.jsx("tbody",{children:o.map((s,i)=>{const c=s.price??0,t=c*(s.discount_percentage??0)/100,h=c-t;return e.jsxs("tr",{children:[e.jsx("td",{children:i+1}),e.jsx("td",{children:s.name}),e.jsx("td",{children:typeof s.price=="number"?s.price.toFixed(2):Number(s.price||0).toFixed(2)}),e.jsxs("td",{children:[e.jsx("input",{type:"number",value:s.discount_percentage||"",onChange:l=>ne(i,parseFloat(l.target.value)),min:"0",max:"100",className:"discount-input-table"}),"%"]}),e.jsx("td",{children:h.toFixed(2)})]},i)})})]}):e.jsx("p",{children:"No tests in this order."})]}),e.jsxs("div",{className:"bill-summary-print print-only",children:[e.jsxs("div",{className:"bill-summary-details",children:[e.jsxs("div",{className:"summary-row-print",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",w.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row-print",children:[e.jsxs("span",{children:["Total Discount (",y.toFixed(2),"%)"]}),e.jsxs("span",{children:["- ₹",T.toFixed(2)]})]}),e.jsx("div",{className:"print-only-total",children:e.jsxs("strong",{children:["Grand Total: ₹",p.toFixed(2)]})})]}),f&&e.jsxs("div",{className:`qr-code-container qr-code-printable-section ${x!=="upi"?"hide-on-screen":""}`,children:[e.jsx(V,{value:f,size:100}),e.jsx("p",{className:"print-only-upi-text",children:"Scan to pay using UPI"})]})]})]}),e.jsx("aside",{className:"billing-sidebar no-print",children:e.jsxs("div",{className:"billing-summary-card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Billing Summary"})}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",w.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Total Discount"}),e.jsxs("span",{children:["- ₹",T.toFixed(2)]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Discount Percentage"}),e.jsxs("div",{className:"discount-input-wrapper",children:[e.jsx("input",{type:"number",value:y===0?"":y,onChange:s=>ae(parseFloat(s.target.value)),min:"0",max:"100",className:"discount-input-total",disabled:b||n.status==="billed"}),"%"]})]}),e.jsxs("div",{className:"summary-row grand-total-row",children:[e.jsx("strong",{children:"Grand Total"}),e.jsxs("strong",{children:["₹",p.toFixed(2)]})]}),e.jsx("div",{className:"qr-code-container",children:f?e.jsxs(e.Fragment,{children:[e.jsx(V,{value:f,size:128}),e.jsx("p",{children:"Scan to pay using UPI"})]}):e.jsx("p",{children:"UPI QR code not available. Please ensure UPI ID is configured."})}),e.jsxs("div",{className:"payment-mode-section",children:[e.jsx("label",{htmlFor:"paymentMode",className:"info-item",children:e.jsx("strong",{children:"Payment Mode"})}),e.jsxs("select",{id:"paymentMode",value:x,onChange:s=>X(s.target.value),className:"payment-mode-select",disabled:b||n.status==="billed",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"no_cash_insurance",children:"No Cash Insurance"}),e.jsx("option",{value:"credit",children:"Credit (Debt to Patient)"})]})]}),x==="credit"&&e.jsxs("div",{className:"debt-info-section",style:{marginTop:"10px",padding:"12px",backgroundColor:"rgba(220, 53, 69, 0.1)",borderRadius:"8px",border:"1px solid rgba(220, 53, 69, 0.3)"},children:[e.jsx("div",{style:{fontWeight:"bold",color:"#dc3545",marginBottom:"8px"},children:"⚠️ Debt to Patient"}),ie?e.jsx("div",{style:{fontSize:"0.9em",color:"#666"},children:"Loading debt info..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"Current Debt:"}),e.jsxs("strong",{style:{color:v&&v>0?"#dc3545":"#28a745"},children:["₹",(v||0).toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"This Bill:"}),e.jsxs("strong",{children:["+ ₹",p.toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",borderTop:"1px solid rgba(220, 53, 69, 0.3)",paddingTop:"8px",marginTop:"8px"},children:[e.jsx("span",{children:e.jsx("strong",{children:"New Total Debt:"})}),e.jsxs("strong",{style:{color:"#dc3545"},children:["₹",((v||0)+p).toFixed(2)]})]})]})]}),e.jsxs("div",{className:"bill-actions",children:[e.jsx("button",{onClick:re,className:"secondary-button print-preview-button no-print",disabled:b||o.length===0,children:"Print Preview"}),n.status!=="billed"&&e.jsx("button",{onClick:ce,className:"primary-button",disabled:b||o.length===0,children:b?"Processing...":"Finalise and Bill"}),n.status==="billed"&&n.bill_id&&e.jsx("button",{onClick:()=>N("/billing",{state:{billId:n.bill_id}}),className:"secondary-button",children:"View Bill"})]})]})})]}),e.jsxs("footer",{className:"billing-footer print-only",children:[e.jsx("p",{children:"Thank you for your business!"}),e.jsx("p",{children:"This is a computer generated bill and does not require a signature."})]})]})]}):e.jsx("div",{className:"error-message-box",children:"No order data available."})};export{ye as default};
