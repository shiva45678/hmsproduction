import{O as ke,P as Te,f as D,j as e,S as o}from"./index-jGjkutd2.js";import{u as Le,f as Ae,r as c}from"./react-vendor-Cc0P4_ZX.js";import{Q as qe,E as Ge,aH as Pe,a1 as Ee,aK as Oe,O as Be}from"./ui-vendor-B5keALZQ.js";import{R as K,A as $e,C as je,X as pe,Y as ye,T as X,f as Me,P as ze,c as Fe,d as Ve,a as We,B as Ue,e as Ke}from"./chart-vendor-BcjzKorn.js";import"./utils-vendor-azd6ta8e.js";import"./ai-vendor-CB5T-uN5.js";const Xe="_container_13uqm_121",Ye="_header_13uqm_141",He="_title_13uqm_187",Qe="_controls_13uqm_203",Je="_dateInputGroup_13uqm_231",Ze="_dateInputLabel_13uqm_255",et="_dateInput_13uqm_231",tt="_section_13uqm_297",st="_sectionTitle_13uqm_325",at="_statsGrid_13uqm_351",nt="_statCard_13uqm_365",rt="_statTitle_13uqm_397",it="_statValue_13uqm_415",lt="_statSubtitle_13uqm_431",ct="_revenueGrid_13uqm_443",dt="_revenueCard_13uqm_469",ot="_revenueCardTitle_13uqm_485",ht="_revenueCardList_13uqm_505",ut="_revenueCardListItem_13uqm_517",mt="_tableContainer_13uqm_557",xt="_table_13uqm_557",vt="_textRight_13uqm_639",jt="_textGreen_13uqm_647",pt="_textRed_13uqm_655",yt="_loadingContainer_13uqm_673",ft="_errorAlert_13uqm_693",gt="_backButton_13uqm_759",_t="_chartsGrid_13uqm_797",bt="_chartCard_13uqm_823",Nt="_chartWrapper_13uqm_873",t={container:Xe,header:Ye,title:He,controls:Qe,dateInputGroup:Je,dateInputLabel:Ze,dateInput:et,section:tt,sectionTitle:st,statsGrid:at,statCard:nt,statTitle:rt,statValue:it,statSubtitle:lt,revenueGrid:ct,revenueCard:dt,revenueCardTitle:ot,revenueCardList:ht,revenueCardListItem:ut,tableContainer:mt,table:xt,textRight:vt,textGreen:jt,textRed:pt,loadingContainer:yt,errorAlert:ft,backButton:gt,chartsGrid:_t,chartCard:bt,chartWrapper:Nt},fe=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#ec4899"],Y=({active:q,payload:g,label:k})=>q&&g&&g.length?e.jsxs("div",{className:"bg-white p-3 border border-gray-200 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-gray-800",children:k}),g.map((R,G)=>e.jsxs("p",{style:{color:R.color},className:"text-sm",children:[R.name,": ",new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR"}).format(R.value)]},G))]}):null,kt=()=>{const q=Le(),g=Ae(),k=new URLSearchParams(g.search),R=k.get("startDate"),G=k.get("endDate"),H=new Date().toISOString().split("T")[0],[m,P]=c.useState(R||H),[x,E]=c.useState(G||H),[T,O]=c.useState(!1),[Q,B]=c.useState(null),{setAnalysisDateRange:$,analysisDateRange:v,setAnalysisData:J,registerAnalysisNavigator:Z,registerAnalysisRefresher:ee}=ke(),[M,te]=c.useState(0),[_,se]=c.useState(0),[ae,ne]=c.useState(0),[w,re]=c.useState(null),[S,ie]=c.useState(null),[n,le]=c.useState(null),[I,ce]=c.useState({reception:{},pharmacy:{},lab:{}}),[N,de]=c.useState(0),[z,oe]=c.useState(null),[ge,he]=c.useState([]),[p,F]=c.useState(null),L=c.useCallback(async(s,i)=>{O(!0),B(null);const u=s||m,C=i||x;if(te(0),se(0),ne(0),re(null),ie(null),le(null),ce({reception:{},pharmacy:{},lab:{}}),F(null),F(null),de(0),oe(null),he([]),!u||!C){B("Please select both start and end dates."),O(!1);return}try{const y=Te(),[j,me,xe,ve,V,W]=await Promise.all([D(`/api/bills?startDate=${m}&endDate=${x}`),D(`/api/payment/admission?startDate=${m}&endDate=${x}`),D(`/api/subscriptions/transactions/manual?startDate=${m}&endDate=${x}`),D(`/api/patient-debts/collections/analysis?startDate=${m}&endDate=${x}`),y?D(`/api/inventory/comprehensive-analysis?startDate=${m}&endDate=${x}&clinicId=${y}`):Promise.resolve(null),D(`/api/distributors/payments/analysis?startDate=${m}&endDate=${x}`)]);if(j.ok&&me.ok&&xe.ok){const U=await j.json(),be=await me.json(),Ne=await xe.json(),Ce=U.bills||[],De=be.admissionPayments||[],Re=Ne||[];let r={totalRevenue:0,totalCashCollected:0,revenueByType:{consultation:0,pharmacy:0,lab:0,other:0},cashByMode:{},revenueByMode:{},detailedRevenue:{reception:{},pharmacy:{},lab:{}},dailyRevenue:new Map,pharmacyReturns:0};const we=(a,l)=>{const d=a.split("T")[0];r.dailyRevenue.set(d,(r.dailyRevenue.get(d)||0)+l)},A=(a,l,d,f,b=!0)=>{const Ie=l.toLowerCase()==="credit";b&&(r.totalRevenue+=a,r.revenueByType.hasOwnProperty(d)?r.revenueByType[d]+=a:r.revenueByType.other=(r.revenueByType.other||0)+a,we(f,a),r.revenueByMode[l]=(r.revenueByMode[l]||0)+a),Ie||(r.totalCashCollected+=a,r.cashByMode[l]=(r.cashByMode[l]||0)+a),b&&(d==="pharmacy"?r.detailedRevenue.pharmacy[l]=(r.detailedRevenue.pharmacy[l]||0)+a:d==="lab"?r.detailedRevenue.lab[l]=(r.detailedRevenue.lab[l]||0)+a:d!=="debt"&&(r.detailedRevenue.reception[l]=(r.detailedRevenue.reception[l]||0)+a)),d==="debt"&&(r.detailedRevenue.debt=r.detailedRevenue.debt||{},r.detailedRevenue.debt[l]=(r.detailedRevenue.debt[l]||0)+a)};if(Ce.forEach(a=>{if(a.status==="paid"||a.type==="pharmacy_return"){let l=parseFloat(a.amount.toString()),d=a.type||"other";const f=a.payment_mode||"Unknown";d==="pharmacy_return"&&(r.pharmacyReturns+=l,d="pharmacy"),A(l,f,d,a.createdAt,!0)}}),De.forEach(a=>{A(parseFloat(a.amount_paid.toString()),a.payment_mode||"Unknown","consultation",a.payment_date,!0)}),Re.forEach(a=>{var f,b;const l=parseFloat(((b=(f=a.subscriptionPlan)==null?void 0:f.price)==null?void 0:b.toString())??"0"),d=a.subscription_payment_method||"manual";A(l,d,"consultation",a.subscription_start_date,!0)}),ve.ok){const l=(await ve.json()).paymentModeBreakdown||{};Object.entries(l).forEach(([d,f])=>{const b=Number(f);A(b,d,"debt","",!1)})}if(se(r.totalCashCollected),te(r.totalRevenue),ne(r.pharmacyReturns),re(r.cashByMode),ie(r.revenueByMode),le(r.revenueByType),ce(r.detailedRevenue),W&&W.ok){const a=await W.json();de(a.totalPaid||0),oe(a.paymentModeBreakdown||{})}const Se=Array.from(r.dailyRevenue.entries()).sort((a,l)=>new Date(a[0]).getTime()-new Date(l[0]).getTime()).map(([a,l])=>({date:a,amount:l}));he(Se)}if(V&&V.ok){const U=await V.json();F(U)}}catch(y){console.error("Analysis Fetch Error:",y),B("Failed to fetch analysis data. Please try again.")}finally{O(!1)}},[m,x]);c.useEffect(()=>{Z(s=>{const i=`analysis-${s}`,u=document.getElementById(i);u&&(u.scrollIntoView({behavior:"smooth",block:"center"}),u.classList.add("ai-highlight-glow"),setTimeout(()=>u.classList.remove("ai-highlight-glow"),2e3))})},[Z]),c.useEffect(()=>{ee(async()=>(await L(),null))},[ee,L]),c.useEffect(()=>{if(v.startDate&&v.endDate){const s=v.startDate.toISOString().split("T")[0],i=v.endDate.toISOString().split("T")[0];(s!==m||i!==x)&&(P(s),E(i))}},[v]),c.useEffect(()=>{const s=new URLSearchParams(g.search),i=s.get("section"),u=s.get("startDate"),C=s.get("endDate");if(u&&C){P(u),E(C);const y=v.startDate?v.startDate.toISOString().split("T")[0]:null,j=v.endDate?v.endDate.toISOString().split("T")[0]:null;(y!==u||j!==C)&&$({startDate:new Date(u),endDate:new Date(C)})}if(i){const y=`analysis-${i}`;setTimeout(()=>{const j=document.getElementById(y);j&&(j.scrollIntoView({behavior:"smooth",block:"center"}),j.classList.add("ai-highlight-glow"),setTimeout(()=>j.classList.remove("ai-highlight-glow"),2e3))},500)}},[g.search]),c.useEffect(()=>{L()},[m,x,L]),c.useEffect(()=>{!T&&(_>0||p)&&J({totalRevenue:M,totalCashFlow:_,totalExpenses:N,netCashFlow:_-N,collectionsBreakdown:w,revenueBreakdown:S,inventoryValue:0,pharmacyRevenue:(n==null?void 0:n.pharmacy)||0,labRevenue:(n==null?void 0:n.lab)||0,receptionRevenue:((n==null?void 0:n.consultation)||0)+((n==null?void 0:n.other)||0),inventorySummary:p?{totalItemsAnalyzed:p.pharmacyAnalysis.length,netPositiveItems:p.pharmacyAnalysis.filter(s=>s.net_change>0).length}:null})},[M,_,N,w,S,p,n,T,J]);const h=s=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR"}).format(s),ue=c.useMemo(()=>S?Object.entries(S).map(([s,i])=>({name:s,value:i})):[],[S]),_e=c.useMemo(()=>n?[{name:"Consultation",value:n.consultation},{name:"Pharmacy",value:n.pharmacy},{name:"Lab",value:n.lab},{name:"Debt Collections",value:n.debt||0},{name:"Other",value:n.other||0}].filter(s=>s.value>0):[],[n]);return e.jsxs("div",{className:t.container,children:[e.jsxs("div",{className:t.header,children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>q(-1),className:t.backButton,title:"Go Back",children:[e.jsx(qe,{size:20})," Back"]}),e.jsx("h1",{className:t.title,children:"Analysis Dashboard"})]}),e.jsxs("div",{className:t.controls,children:[e.jsxs("div",{className:t.dateInputGroup,children:[e.jsx("label",{className:t.dateInputLabel,children:"From:"}),e.jsx("input",{type:"date",className:t.dateInput,value:m,onChange:s=>{P(s.target.value),x&&$({startDate:new Date(s.target.value),endDate:new Date(x)})}})]}),e.jsxs("div",{className:t.dateInputGroup,children:[e.jsx("label",{className:t.dateInputLabel,children:"To:"}),e.jsx("input",{type:"date",className:t.dateInput,value:x,onChange:s=>{E(s.target.value),m&&$({startDate:new Date(m),endDate:new Date(s.target.value)})}})]})]})]}),Q&&e.jsxs("div",{className:t.errorAlert,children:[e.jsx(Ge,{size:20}),e.jsx("span",{children:Q})]}),!T&&e.jsxs("div",{children:[e.jsxs("section",{className:t.section,id:"analysis-expenses",children:[e.jsxs("div",{className:t.sectionTitle,children:[e.jsx(Pe,{style:{color:"var(--accent-primary)"},size:24}),e.jsx("h2",{children:"Cash Flow Analysis"})]}),e.jsxs("div",{className:t.statsGrid,children:[e.jsxs("div",{className:t.statCard,children:[e.jsx("div",{className:t.statTitle,children:"Total Cash Inflow"}),e.jsx("div",{className:t.statValue,style:{color:"var(--accent-success)"},children:h(_)}),e.jsx("div",{className:t.statSubtitle,children:"Collections (Cash, UPI, etc.)"})]}),e.jsxs("div",{className:t.statCard,children:[e.jsx("div",{className:t.statTitle,children:"Total Expenses"}),e.jsx("div",{className:t.statValue,style:{color:"var(--accent-danger)"},children:h(N)}),e.jsx("div",{className:t.statSubtitle,children:"Distributor Payments"})]}),e.jsxs("div",{className:t.statCard,children:[e.jsx("div",{className:t.statTitle,children:"Net Cash Flow"}),e.jsx("div",{className:t.statValue,style:{color:_-N>=0?"var(--accent-success)":"var(--accent-danger)"},children:h(_-N)}),e.jsx("div",{className:t.statSubtitle,children:"Inflow - Outflow"})]})]}),e.jsxs("div",{className:t.revenueGrid,style:{marginTop:"1rem"},children:[w&&Object.keys(w).length>0&&e.jsxs("div",{className:t.revenueCard,children:[e.jsx("h3",{className:t.revenueCardTitle,children:"Collections Breakdown"}),e.jsx("ul",{className:t.revenueCardList,children:Object.entries(w).map(([s,i])=>e.jsxs("li",{className:t.revenueCardListItem,children:[e.jsx("span",{children:s}),e.jsx("span",{children:h(i)})]},s))})]}),z&&Object.keys(z).length>0&&e.jsxs("div",{className:t.revenueCard,children:[e.jsx("h3",{className:t.revenueCardTitle,children:"Expense Breakdown"}),e.jsx("ul",{className:t.revenueCardList,children:Object.entries(z).map(([s,i])=>e.jsxs("li",{className:t.revenueCardListItem,children:[e.jsx("span",{children:s}),e.jsx("span",{children:h(i)})]},s))})]})]})]}),e.jsxs("section",{className:t.section,id:"analysis-financial",children:[e.jsxs("div",{className:t.sectionTitle,children:[e.jsx(Ee,{style:{color:"var(--accent-primary)"},size:24}),e.jsx("h2",{children:"Financial Performance"})]}),e.jsx("div",{className:t.statsGrid,children:e.jsxs("div",{className:t.statCard,children:[e.jsx("div",{className:t.statTitle,children:"Total Revenue Generated"}),e.jsx("div",{className:t.statValue,style:{color:"var(--accent-primary)"},children:h(M)}),e.jsx("div",{className:t.statSubtitle,children:"Billings & Services (Accrual)"})]})}),e.jsxs("div",{className:t.chartsGrid,children:[e.jsxs("div",{className:t.chartCard,style:{gridColumn:"1 / -1"},children:[e.jsx("h3",{children:"Revenue Trend (Daily)"}),e.jsx("div",{className:t.chartWrapper,children:e.jsx(K,{width:"100%",height:300,children:e.jsxs($e,{data:ge,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"colorRevenue",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"var(--accent-primary)",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"var(--accent-primary)",stopOpacity:.05})]})}),e.jsx(je,{strokeDasharray:"3 3",vertical:!1,stroke:"var(--border-subtle)"}),e.jsx(pe,{dataKey:"date",tick:{fill:"var(--text-secondary)",fontSize:12},axisLine:!1,tickLine:!1}),e.jsx(ye,{tick:{fill:"var(--text-secondary)",fontSize:12},axisLine:!1,tickLine:!1,tickFormatter:s=>`₹${s/1e3}k`}),e.jsx(X,{content:e.jsx(Y,{})}),e.jsx(Me,{type:"monotone",dataKey:"amount",stroke:"var(--accent-primary)",fillOpacity:1,fill:"url(#colorRevenue)"})]})})})]}),e.jsxs("div",{className:t.chartCard,children:[e.jsx("h3",{children:"Payment Method Distribution"}),e.jsx("div",{className:t.chartWrapper,children:e.jsx(K,{width:"100%",height:300,children:e.jsxs(ze,{children:[e.jsx(Fe,{data:ue,cx:"50%",cy:"50%",innerRadius:60,outerRadius:100,paddingAngle:5,dataKey:"value",children:ue.map((s,i)=>e.jsx(Ve,{fill:fe[i%fe.length]},`cell-${i}`))}),e.jsx(X,{content:e.jsx(Y,{})}),e.jsx(We,{verticalAlign:"bottom",height:36,formatter:s=>e.jsx("span",{style:{color:"var(--text-primary)"},children:s})})]})})})]}),e.jsxs("div",{className:t.chartCard,children:[e.jsx("h3",{children:"Revenue by Source"}),e.jsx("div",{className:t.chartWrapper,children:e.jsx(K,{width:"100%",height:300,children:e.jsxs(Ue,{data:_e,children:[e.jsx(je,{strokeDasharray:"3 3",vertical:!1,stroke:"var(--border-subtle)"}),e.jsx(pe,{dataKey:"name",tick:{fill:"var(--text-secondary)",fontSize:12},axisLine:!1,tickLine:!1}),e.jsx(ye,{tick:{fill:"var(--text-secondary)",fontSize:12},axisLine:!1,tickLine:!1,tickFormatter:s=>`₹${s/1e3}k`}),e.jsx(X,{content:e.jsx(Y,{}),cursor:{fill:"var(--bg-primary)"}}),e.jsx(Ke,{dataKey:"value",fill:"var(--accent-success)",radius:[4,4,0,0]})]})})})]})]}),I&&e.jsxs("div",{className:t.sectionTitle,style:{marginTop:"2rem"},children:[e.jsx(Oe,{style:{color:"var(--text-secondary)"},size:20}),e.jsx("h3",{children:"Detailed Breakdown"})]}),I&&e.jsxs("div",{className:t.revenueGrid,children:[e.jsxs("div",{className:t.revenueCard,children:[e.jsx("h3",{className:t.revenueCardTitle,children:"Reception / Clinic"}),e.jsx("div",{className:t.statValue,style:{fontSize:"1.5rem",marginBottom:"1rem"},children:h(((n==null?void 0:n.consultation)||0)+((n==null?void 0:n.other)||0))}),e.jsx("ul",{className:t.revenueCardList,children:Object.entries(I.reception).map(([s,i])=>e.jsxs("li",{className:t.revenueCardListItem,children:[e.jsx("span",{children:s}),e.jsx("span",{children:h(i)})]},s))})]}),e.jsxs("div",{className:t.revenueCard,children:[e.jsx("h3",{className:t.revenueCardTitle,children:"Pharmacy"}),e.jsx("div",{className:t.statValue,style:{fontSize:"1.5rem",marginBottom:"1rem"},children:h((n==null?void 0:n.pharmacy)||0)}),ae<0&&e.jsxs("div",{className:`${t.textRed} text-sm mb-2`,children:["Returns: ",h(ae)]}),e.jsx("ul",{className:t.revenueCardList,children:Object.entries(I.pharmacy).map(([s,i])=>e.jsxs("li",{className:t.revenueCardListItem,children:[e.jsx("span",{children:s}),e.jsx("span",{children:h(i)})]},s))})]}),e.jsxs("div",{className:t.revenueCard,children:[e.jsx("h3",{className:t.revenueCardTitle,children:"Laboratory"}),e.jsx("div",{className:t.statValue,style:{fontSize:"1.5rem",marginBottom:"1rem"},children:h((n==null?void 0:n.lab)||0)}),e.jsx("ul",{className:t.revenueCardList,children:Object.entries(I.lab).map(([s,i])=>e.jsxs("li",{className:t.revenueCardListItem,children:[e.jsx("span",{children:s}),e.jsx("span",{children:h(i)})]},s))})]})]})]}),e.jsxs("section",{className:t.section,id:"analysis-inventory",children:[e.jsxs("div",{className:t.sectionTitle,children:[e.jsx(Be,{style:{color:"var(--accent-success)"},size:24}),e.jsx("h2",{children:"Inventory Movement"})]}),p&&p.pharmacyAnalysis.length>0?e.jsx("div",{className:t.tableContainer,children:e.jsxs("table",{className:t.table,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item Name"}),e.jsx("th",{children:"Stock In"}),e.jsx("th",{children:"Stock Out"}),e.jsx("th",{children:"Net Change"}),e.jsx("th",{className:t.textRight,children:"Est. Revenue"}),e.jsx("th",{className:t.textRight,children:"Est. Profit"})]})}),e.jsx("tbody",{children:p.pharmacyAnalysis.map(s=>e.jsxs("tr",{children:[e.jsxs("td",{children:[e.jsx("div",{style:{fontWeight:600},children:s.name}),e.jsx("div",{style:{fontSize:"0.75rem",opacity:.7},children:s.supplier})]}),e.jsxs("td",{className:t.textGreen,children:["+",s.quantity_in,Object.entries(s.quantity_in_by_reason).map(([i,u])=>e.jsxs("div",{style:{fontSize:"0.75rem",opacity:.8},children:[i,": ",u]},i))]}),e.jsxs("td",{className:t.textRed,children:["-",s.quantity_out,Object.entries(s.quantity_out_by_reason).map(([i,u])=>e.jsxs("div",{style:{fontSize:"0.75rem",opacity:.8},children:[i,": ",u]},i))]}),e.jsx("td",{children:e.jsxs("span",{style:{fontWeight:600},className:s.net_change>=0?t.textGreen:t.textRed,children:[s.net_change>0?"+":"",s.net_change]})}),e.jsx("td",{className:t.textRight,children:h(s.revenue)}),e.jsx("td",{className:`${t.textRight} ${s.profit>=0?t.textGreen:t.textRed}`,children:h(s.profit)})]},s.drug_id))})]})}):e.jsx("div",{className:"text-center py-8 opacity-50 mb-4 bg-transparent rounded-lg border border-dashed border-gray-300",children:"No inventory movement recorded for this period."})]})]}),T&&e.jsxs("div",{className:t.loadingContainer,style:{display:"block"},children:[e.jsxs("div",{className:t.sectionTitle,children:[e.jsx(o,{variant:"circular",width:24,height:24}),e.jsx(o,{width:200,height:24})]}),e.jsxs("div",{className:t.statsGrid,children:[e.jsxs("div",{className:t.statCard,children:[e.jsx(o,{width:"60%",height:20}),e.jsx(o,{width:"80%",height:32}),e.jsx(o,{width:"40%",height:16})]}),e.jsxs("div",{className:t.statCard,children:[e.jsx(o,{width:"60%",height:20}),e.jsx(o,{width:"80%",height:32}),e.jsx(o,{width:"40%",height:16})]}),e.jsxs("div",{className:t.statCard,children:[e.jsx(o,{width:"60%",height:20}),e.jsx(o,{width:"80%",height:32}),e.jsx(o,{width:"40%",height:16})]})]}),e.jsx("div",{style:{marginTop:"2rem"},children:e.jsxs("div",{className:t.chartsGrid,children:[e.jsxs("div",{className:t.chartCard,style:{gridColumn:"1 / -1"},children:[e.jsx(o,{width:180,height:24,className:"mb-4"}),e.jsx(o,{width:"100%",height:250})]}),e.jsxs("div",{className:t.chartCard,children:[e.jsx(o,{width:180,height:24,className:"mb-4"}),e.jsx(o,{width:"100%",height:200,variant:"circular",style:{margin:"0 auto"}})]}),e.jsxs("div",{className:t.chartCard,children:[e.jsx(o,{width:180,height:24,className:"mb-4"}),e.jsx(o,{width:"100%",height:250})]})]})})]})]})};export{kt as default};
