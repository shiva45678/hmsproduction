import{u as $,r,a as q,j as e,A as C,U as O,S as R,b as k,f as N}from"./index-G6ieET9N.js";const M=()=>{const u=$(),[a,f]=r.useState({name:"",age:"",gender:"",phone:"",complaint:"",doctorId:""}),[n,b]=r.useState(!1),[v,m]=r.useState(null),[w,x]=r.useState(null),[g,S]=r.useState([]),[h,y]=r.useState(!0);q(),r.useEffect(()=>{(async()=>{y(!0);try{const t=await N("/api/staff?role=doctor");if(!t.ok)throw new Error("Failed to fetch doctors");const s=await t.json();S(s),s.length>0&&f(i=>({...i,doctorId:""}))}catch(t){console.error("Error fetching doctors:",t),m(`Failed to load doctors: ${t.message}`)}finally{y(!1)}})()},[]);const d=o=>{const{name:t,value:s}=o.target;f(i=>({...i,[t]:s}))},A=async o=>{var t;o.preventDefault(),m(null),x(null),b(!0);try{let s,i;console.log("Registering new patient...");const p=await N("/api/patients",{method:"POST",body:JSON.stringify({name:a.name,age:a.age?parseInt(a.age,10):null,gender:a.gender||null,phone:a.phone||null})});if(!p.ok){const l=await p.json();if(p.status===403&&l.message.includes("Patient limit")){u("/start-clinic-subscription",{state:{errorMessage:l.message}});return}throw new Error(l.message||"Failed to register patient")}const P=await p.json();s=P.id,i=P.name,console.log(`New patient ${s} registered.`);const c=a.doctorId||null;console.log(`Adding patient ${s} to queue for doctor ${c||"Unassigned"}`);const j=await N("/api/queue",{method:"POST",body:JSON.stringify({patientId:s,complaint:a.complaint||null,doctorId:c})});if(!j.ok){const l=await j.json();throw new Error(l.message||"Failed to add patient to queue")}const D=await j.json();if(console.log(`Patient added to queue, entry ID: ${D.id}`),f({name:"",age:"",gender:"",phone:"",complaint:"",doctorId:""}),c){const l=((t=g.find(E=>E.id===c))==null?void 0:t.name)||"Selected Doctor",I=`Patient "${i}" registered and added to queue for Dr. ${l}. Redirecting to billing...`;x(I),u("/billing",{state:{patientId:s,queueId:D.id,patientName:i,doctorId:c,billType:"consultation"}})}else{const l=`Patient "${i}" registered and added to the general queue.`;x(l)}}catch(s){console.error("Error in add/queue process:",s),s.message.includes("Patient limit")?(m(`Operation failed: ${s.message}. Please upgrade your plan.`),u("/start-clinic-subscription")):m(`Operation failed: ${s.message}`)}finally{b(!1)}};return e.jsxs("div",{className:"add-patient-page-container flex flex-col items-center justify-start",children:[e.jsxs("div",{className:"w-full max-w-3xl mb-2 flex justify-start",children:[" ",e.jsx("button",{onClick:()=>u(-1),className:"back-button",title:"Back to Previous Page",children:e.jsx(C,{size:20,className:"btn-icon"})})]}),e.jsxs("div",{className:"add-patient-card",children:[e.jsxs("h3",{className:"add-patient-title",children:[e.jsx(O,{size:28})," ","Register New Patient & Add to Queue"]}),v&&e.jsxs("div",{className:"alert alert-danger",role:"alert",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:v})]}),w&&e.jsxs("div",{className:"alert alert-success",role:"alert",children:[e.jsx("strong",{children:"Success: "}),e.jsx("span",{children:w})]}),e.jsxs("form",{onSubmit:A,className:"space-y-5",children:[" ",e.jsxs("fieldset",{className:"form-fieldset",children:[e.jsx("legend",{children:"New Patient Details"}),e.jsxs("div",{className:"form-grid form-grid-cols-2",children:[" ",e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Full Name *"}),e.jsx("input",{type:"text",name:"name",value:a.name,onChange:d,className:"form-input",required:!0,disabled:n})]}),e.jsxs("div",{className:"form-grid form-grid-cols-2",children:[" ",e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Age"}),e.jsx("input",{type:"number",name:"age",value:a.age,onChange:d,className:"form-input",min:"0",disabled:n})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Gender"}),e.jsxs("select",{name:"gender",value:a.gender,onChange:d,className:"form-select",disabled:n,children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"M",children:"Male"}),e.jsx("option",{value:"F",children:"Female"}),e.jsx("option",{value:"O",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Phone"}),e.jsx("input",{type:"tel",name:"phone",value:a.phone,onChange:d,className:"form-input",disabled:n})]})]})]}),e.jsxs("fieldset",{className:"form-fieldset",children:[e.jsx("legend",{children:"Visit Details"}),e.jsxs("div",{className:"form-grid form-grid-cols-2",children:[" ",e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Assign Doctor (Optional)"}),h?e.jsx(R,{width:"100%",height:40,style:{borderRadius:"8px"}}):e.jsxs("select",{name:"doctorId",value:a.doctorId,onChange:d,className:"form-select",disabled:n,children:[e.jsx("option",{value:"",children:g.length===0?"No doctors available":"-- No Doctor (Add to General Queue) --"}),g.map(o=>e.jsx("option",{value:o.id,children:o.name},o.id))]}),g.length===0&&!h&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Please add doctors via the Admin Panel."})]}),e.jsxs("div",{className:"form-grid-col-span-2",children:[" ",e.jsx("label",{className:"form-label",children:"Patient Data / Reason"}),e.jsx("textarea",{name:"complaint",value:a.complaint,onChange:d,rows:2,className:"form-textarea",disabled:n})]})]})]}),e.jsxs("div",{className:"flex justify-end pt-2",children:[" ",e.jsxs("button",{type:"submit",className:`btn btn-primary ${n||h?"disabled":""}`,disabled:n||h,children:[e.jsx(k,{size:18,className:"btn-icon"}),n?"Processing...":"Register & Add to Queue"]})]})]})]})]})};export{M as default};
